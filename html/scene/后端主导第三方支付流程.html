<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x19fcb5=_0x181c;function _0x181c(r,n){var l=_0x50d9();return(_0x181c=function(n,s){var t=l[n-=129];void 0===_0x181c.WVHBZy&&(_0x181c.dhpFBd=function(n,s){var t,a=[],r=0,l="";for(n=(n=>{for(var s,t,a="",r="",l=0,o=0;t=n.charAt(o++);~t&&(s=l%4?64*s+t:t,l++%4)&&(a+=String.fromCharCode(255&s>>(-2*l&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var c=0,e=a.length;c<e;c++)r+="%"+("00"+a.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(r)})(n),o=0;o<256;o++)a[o]=o;for(o=0;o<256;o++)r=(r+a[o]+s.charCodeAt(o%s.length))%256,t=a[o],a[o]=a[r],a[r]=t;for(var o=0,r=0,c=0;c<n.length;c++)t=a[o=(o+1)%256],a[o]=a[r=(r+a[o])%256],a[r]=t,l+=String.fromCharCode(n.charCodeAt(c)^a[(a[o]+a[r])%256]);return l},r=arguments,_0x181c.WVHBZy=!0);var n=n+l[0],a=r[n];return a?t=a:(void 0===_0x181c.NPwamg&&(_0x181c.NPwamg=!0),t=_0x181c.dhpFBd(t,s),r[n]=t),t})(r,n)}function _0x50d9(){var n=["p8o4pmoeWRWMW44chW","DY7dUSk2vdNdTmosWP3cNW","kmo2WQxdTSoVufy","WR1Suce4uclcVKrMjSkfwCor","aWjgW6OYWO/dNmkaW7LbWQDjW6ix","WQiltCk6ga","W6fjdmo8b0f2ahddOW","WQTPuSk8W5jWbIldLfNcLai","WRTUuYPne2ddReLF","rSklqmk7z3m0l8kdW7yOySoJ","BSo4W7pcICk+AXzbnmog","vWrffCoJWQmsWOldGWZcQ1RdNq","E8o6tmondLNdJq","ag/cGN3dTL7cL8of","WRWVdCk6aSkiWPS","hc1/WQuDW6atW6ZcOe43WRNcHq","W6DUWQRdGYVcV8oWWRtdLCkMWPVcNa","Amo4WPBdO8kCxdbL","W4tdJSoSWQ0OiX7dS3WoELTQ","cJShWOTynmkGxW","WQrVumk4WRe9lJNdUu4","W5pdSKbVe3GhfstdIW","nMXtW47dTSkdxq","WPHDWRvTWRWabcefuG","asJcN0pcU2lcP8o/vmki","fmkOFaiaWPLbFSo5WR/cMWvC","lmkvWOZdRhDjW47cQs8hWR4/ja","W4O2zdblqry/WPPHWPtcUa54W6FdMmkssffAWRBcRSopW6njAa"];return(_0x50d9=function(){return n})()}if((()=>{for(var n=_0x181c,s=_0x50d9();;)try{if(848358==+parseInt(n(136,"VCUG"))+parseInt(n(145,"GSDl"))/2*(parseInt(n(140,"o9aW"))/3)+-parseInt(n(153,"Mt&a"))/4+-parseInt(n(134,"d7#@"))/5*(parseInt(n(146,"KRSD"))/6)+-parseInt(n(149,"]cbH"))/7+parseInt(n(133,"Ulii"))/8*(-parseInt(n(130,"GSDl"))/9)+-parseInt(n(151,"KDzO"))/10*(-parseInt(n(141,"KRSD"))/11))break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x19fcb5(132,"pbrx")](_0x19fcb5(138,"F$rm"))!=_0x19fcb5(143,"7r^R"))throw window[_0x19fcb5(129,"N&hl")][_0x19fcb5(150,"jO!D")](_0x19fcb5(137,"gwBr")),Error();document.title="后端主导第三方支付流程",document.getElementById("article").innerHTML='<div><p>后端主导第三方支付时，前端的工作被压缩到“拿到一个 URL（或一段表单 HTML）→ 让浏览器跳过去→ 再回来”，但 C 端仍要把 4 件小事做到极致，否则照样掉单、客诉、审核被打回。</p>\n<hr>\n<ol>\n<li>后端主导的完整时序<br>\n① 前端：携带订单号调自家后台<br>\nGET /createPay?orderId=123<br>\n② 后台：\n<ul>\n<li>去第三方统一下单</li>\n<li>拿到 payUrl（或一段自动提交的 form）</li>\n<li>把 payUrl 302 给前端<br>\n③ 浏览器：直接跳到 payUrl，用户在第三方页面完成支付<br>\n④ 第三方：</li>\n<li>同步 redirect 回 <code>return_url</code>（仅作展示）</li>\n<li>异步 POST 到 <code>notify_url</code>（真正改订单状态）<br>\n⑤ 前端：在 return_url 页面轮询订单状态，展示结果</li>\n</ul>\n</li>\n</ol>\n<hr>\n<ol start="2">\n<li>前端必须做的 4 件小事\n<table>\n<thead>\n<tr>\n<th>小事</th>\n<th>触发场景</th>\n<th>前端动作</th>\n<th>兜底</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>防止多次跳转</td>\n<td>用户狂点支付按钮</td>\n<td>按钮置灰 + loading</td>\n<td>用 sessionStorage 标记 <code>pay_lock</code></td>\n</tr>\n<tr>\n<td>302 被拦截</td>\n<td>企业微信、QQ 内置浏览器会拦截外链</td>\n<td>先弹“即将跳转到微信/支付宝”确认框，用户点「继续」再 <code>location.href = payUrl</code></td>\n<td>提供“手动复制链接”按钮</td>\n</tr>\n<tr>\n<td>弱网空白</td>\n<td>跳转 3 秒没反应</td>\n<td>3 秒后 toast + 倒计时 5 秒后自动重试</td>\n<td>给出二维码备用</td>\n</tr>\n<tr>\n<td>回跳丢单</td>\n<td>用户支付完把浏览器杀掉，没回到 return_url</td>\n<td>return_url 页一加载就轮询订单接口 3 次，失败后提示“如已支付请稍等”</td>\n<td>短信 / push 补通知</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ol>\n<hr>\n<ol start="3">\n<li>代码最小可运行片段</li>\n</ol>\n<pre><code class="language-js"><span class="hljs-comment">// 1. 防重复</span>\n<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&quot;pay_lock&quot;</span>)) <span class="hljs-keyword">return</span>;\n<span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&quot;pay_lock&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);\n\n<span class="hljs-comment">// 2. 拿跳转地址</span>\n<span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;/createPay?orderId=123&quot;</span>)\n  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">json</span>())\n  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{ payUrl }</span>) =&gt;</span> {\n    <span class="hljs-comment">// 3. 用户确认再跳</span>\n    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">confirm</span>(<span class="hljs-string">&quot;即将前往支付页面，是否继续？&quot;</span>)) {\n      location.<span class="hljs-property">href</span> = payUrl;\n    } <span class="hljs-keyword">else</span> {\n      <span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">&quot;pay_lock&quot;</span>);\n    }\n  });\n</code></pre>\n<hr>\n<ol start="4">\n<li>一句话总结<br>\n后端主导时，前端看似只剩一行 <code>location.href = payUrl</code>，但真正决定成败的是：<br>\n<strong>跳转前防重、跳转中兼容、回跳后兜底，缺一环都会掉单。</strong></li>\n</ol>\n</div>'</script></body></html>