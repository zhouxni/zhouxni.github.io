<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5a37(){var s=["W4ldJmovDruMomoTW5e","W6m/WR99kmodjSkdEGmYW64","mCobW6pcPCoPW7JcNb/dN8kp","W4NdGJhdUmoHWQFdJG","W75eW6ztbwBcRCkS","eCosmmkUyCo/WQ/dSa","zITvBbjSxCkk","ACoIf0tdVdu3W5m","W5/dT8oLeYuwW7WBsfqP","FmorW7ZdOCoeW4eOWPZdScbJ","WP7dOCoeW6lcHuVdHsxdU8kZWQ7dOW","xtubDmkCW5VdMmkyFGy/W4FcUa","rCkEDXBcQ1/cRW","tSkZWPXOhmkBvYBdL3VdJ2O","WRLYW7K7BSoaqmoUyrOnW6hdS8kOW5P4rSkSW7qYWOFdUcfTWQddNa","W5fFlLCXsSk5m8kwnCozpSkL","WP3dNHPAW60ncN/dVhldSSkj","WOxcGZ14ksJcQSk4WPawuCoI","bmolqs3cV33cOCoF","uvZdVgxcTh1AFGFcOG7dJNm","hItdOKldIN/dVJRdHCo+","s8k6W6nSW6JcJqldT8kZdtz+","mCk5qHxcV2WYW4vzWQb2pG","DCoBkxK8W4BdK8kiW5pcNYtdH2e","bs5/WQJdON1bmmo9WQ/dICk7","WPZdK3ShWP9Ef3K","WPJcLSkqWPJdObRdVa","nmk3WRRdMmojW6pcMG","ghjamSor","W5qRnCocW5/cKrpcJG"];return(_0x5a37=function(){return s})()}var _0x46d315=_0x3f2c;function _0x3f2c(p,s){var e=_0x5a37();return(_0x3f2c=function(s,n){var a=e[s-=169];void 0===_0x3f2c.BEqPKa&&(_0x3f2c.VpTNvg=function(s,n){var a,l=[],p=0,e="";for(s=(s=>{for(var n,a,l="",p="",e=0,t=0;a=s.charAt(t++);~a&&(n=e%4?64*n+a:a,e++%4)&&(l+=String.fromCharCode(255&n>>(-2*e&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,c=l.length;o<c;o++)p+="%"+("00"+l.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(p)})(s),t=0;t<256;t++)l[t]=t;for(t=0;t<256;t++)p=(p+l[t]+n.charCodeAt(t%n.length))%256,a=l[t],l[t]=l[p],l[p]=a;for(var t=0,p=0,o=0;o<s.length;o++)a=l[t=(t+1)%256],l[t]=l[p=(p+l[t])%256],l[p]=a,e+=String.fromCharCode(s.charCodeAt(o)^l[(l[t]+l[p])%256]);return e},p=arguments,_0x3f2c.BEqPKa=!0);var s=s+e[0],l=p[s];return l?a=l:(void 0===_0x3f2c.hCRIgv&&(_0x3f2c.hCRIgv=!0),a=_0x3f2c.VpTNvg(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x3f2c,n=_0x5a37();;)try{if(382115==-parseInt(s(183,"J1YN"))*(parseInt(s(169,"80yS"))/2)+parseInt(s(175,"mCPh"))/3*(parseInt(s(170,"4Lp4"))/4)+parseInt(s(196,"Uj)H"))/5*(-parseInt(s(192,"cgOk"))/6)+-parseInt(s(193,"zF%p"))/7+parseInt(s(197,"c]Vn"))/8+parseInt(s(195,"2ig@"))/9*(parseInt(s(180,"2J#X"))/10)+parseInt(s(198,"Y]XO"))/11*(parseInt(s(176,"C]Ud"))/12))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x46d315(177,"D@oc")](_0x46d315(174,"1w$%"))!=_0x46d315(172,"e6PV"))throw window[_0x46d315(181,"Uj)H")][_0x46d315(186,"cgOk")](_0x46d315(188,"mCPh")),Error();document.title="后端生成 session、cookie、token 的底层原理",document.getElementById("article").innerHTML='<div><p>下面给出一份「Node 视角」的完整路线图，把后端生成 session、cookie、token 的底层原理、代码范例、常见库选型一次性串起来。你可以直接 copy 到本地跑通，也可以拆成片段放到自己的项目里。</p>\n<hr>\n<ol>\n<li>总览：三者区别与 Node 中的角色</li>\n</ol>\n<hr>\n<ul>\n<li>\n<p>cookie：只是一段浏览器存储的键值串。<br>\nNode 通过 <code>Set-Cookie</code> 响应头把它“种”到浏览器。</p>\n</li>\n<li>\n<p>session：本质是一份“服务端内存/数据库里的用户字典”。<br>\nNode 用一个全局唯一的 sessionId（通常就是随机字符串）做 key，把这份字典存进 Redis/Memory/文件里；同时把这个 sessionId 通过 cookie 回写给浏览器。<br>\n浏览器以后每次请求自动带 cookie，Node 取出 sessionId 再反查字典，就知道“这是谁”。</p>\n</li>\n<li>\n<p>token（这里特指 JWT）：服务端不再存字典，而是把“我是谁、有效期”等声明直接塞进 token 本身，再用密钥签名。<br>\nNode 用 jsonwebtoken 库一行代码就能签发，浏览器以后在 Authorization 头里带回即可。</p>\n</li>\n</ul>\n<hr>\n<ol start="2">\n<li>cookie 的生成（最原始）</li>\n</ol>\n<hr>\n<pre><code class="language-js"><span class="hljs-comment">// server.js  最简原生 http 版</span>\n<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>);\n\nhttp\n  .<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n    <span class="hljs-comment">// 种一个 7 天有效的 cookie</span>\n    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {\n      <span class="hljs-string">&quot;Set-Cookie&quot;</span>:\n        <span class="hljs-string">&quot;theme=dark; Max-Age=&quot;</span> + <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">7</span> + <span class="hljs-string">&quot;; HttpOnly; Path=/&quot;</span>,\n    });\n    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;cookie sent&quot;</span>);\n  })\n  .<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<p>浏览器收到的响应头：</p>\n<pre><code>Set-Cookie: theme=dark; Max-Age=604800; HttpOnly; Path=/\n</code></pre>\n<hr>\n<ol start="3">\n<li>session 的生成（express-session）</li>\n</ol>\n<hr>\n<p>安装：</p>\n<pre><code class="language-bash">npm i express express-session connect-redis redis\n</code></pre>\n<p>代码：</p>\n<pre><code class="language-js"><span class="hljs-comment">// session.js</span>\n<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);\n<span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express-session&quot;</span>);\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">RedisStore</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;connect-redis&quot;</span>)(session);\n<span class="hljs-keyword">const</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;redis&quot;</span>).<span class="hljs-title function_">createClient</span>();\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();\n\napp.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">session</span>({\n    <span class="hljs-attr">store</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisStore</span>({ <span class="hljs-attr">client</span>: redis }), <span class="hljs-comment">// 存 Redis</span>\n    <span class="hljs-attr">secret</span>: <span class="hljs-string">&quot;keyboard cat&quot;</span>, <span class="hljs-comment">// 用来签 sessionId</span>\n    <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,\n    <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,\n    <span class="hljs-attr">cookie</span>: { <span class="hljs-attr">maxAge</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">30</span> }, <span class="hljs-comment">// 30 min 有效</span>\n  }),\n);\n\napp.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/login&quot;</span>, express.<span class="hljs-title function_">json</span>(), <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> { username, pwd } = req.<span class="hljs-property">body</span>;\n  <span class="hljs-keyword">if</span> (username === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; pwd === <span class="hljs-string">&quot;123456&quot;</span>) {\n    req.<span class="hljs-property">session</span>.<span class="hljs-property">uid</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 往字典写数据</span>\n    res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;login ok&quot;</span> });\n  } <span class="hljs-keyword">else</span> {\n    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;fail&quot;</span> });\n  }\n});\n\napp.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/profile&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">session</span>.<span class="hljs-property">uid</span>) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;no login&quot;</span>);\n  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">uid</span>: req.<span class="hljs-property">session</span>.<span class="hljs-property">uid</span> });\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">4000</span>);\n</code></pre>\n<p>流程小结：</p>\n<ol>\n<li><code>/login</code> 成功 → express-session 生成随机 <code>sessionId=abc123</code> → 把 <code>{uid:1}</code> 存入 Redis key=<code>sess:abc123</code> → 把 <code>Set-Cookie: connect.sid=abc123; …</code> 种给浏览器。</li>\n<li>浏览器以后带着 cookie 访问 <code>/profile</code> → 中间件自动把 cookie 里的 <code>abc123</code> 拿出来 → 去 Redis 取字典 → <code>req.session.uid</code> 就有了。</li>\n</ol>\n<hr>\n<ol start="4">\n<li>token（JWT）的生成</li>\n</ol>\n<hr>\n<p>安装：</p>\n<pre><code class="language-bash">npm i express jsonwebtoken\n</code></pre>\n<p>代码：</p>\n<pre><code class="language-js"><span class="hljs-comment">// jwt.js</span>\n<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);\n<span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;jsonwebtoken&quot;</span>);\n<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();\napp.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());\n\n<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SECRET</span> = <span class="hljs-string">&quot;super_secret_key&quot;</span>;\n\napp.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/login&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> { username, pwd } = req.<span class="hljs-property">body</span>;\n  <span class="hljs-keyword">if</span> (username === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; pwd === <span class="hljs-string">&quot;123456&quot;</span>) {\n    <span class="hljs-comment">// 签发 token，1 小时有效期</span>\n    <span class="hljs-keyword">const</span> token = jwt.<span class="hljs-title function_">sign</span>({ <span class="hljs-attr">uid</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">&quot;admin&quot;</span> }, <span class="hljs-variable constant_">SECRET</span>, {\n      <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&quot;1h&quot;</span>,\n    });\n    res.<span class="hljs-title function_">json</span>({ token });\n  } <span class="hljs-keyword">else</span> {\n    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;fail&quot;</span> });\n  }\n});\n\n<span class="hljs-comment">// 受保护路由</span>\napp.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/profile&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> auth = req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span>;\n  <span class="hljs-keyword">if</span> (!auth || !auth.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;Bearer &quot;</span>))\n    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;no token&quot;</span>);\n\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">const</span> payload = jwt.<span class="hljs-title function_">verify</span>(auth.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>)[<span class="hljs-number">1</span>], <span class="hljs-variable constant_">SECRET</span>);\n    res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">user</span>: payload });\n  } <span class="hljs-keyword">catch</span> (e) {\n    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;invalid token&quot;</span>);\n  }\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">5000</span>);\n</code></pre>\n<p>流程小结：</p>\n<ol>\n<li><code>/login</code> 成功 → 服务端把 <code>{uid:1,username:\'admin\'}</code> 塞进 JWT 并用密钥签名 → 返回给前端。</li>\n<li>前端把 token 存在 localStorage/ cookie/ Vuex 里，之后请求在 <code>Authorization: Bearer &lt;token&gt;</code> 里带回来。</li>\n<li>服务端用同一密钥 <code>jwt.verify</code>，验证签名、过期时间，通过即信任，不再查库。</li>\n</ol>\n<hr>\n<ol start="5">\n<li>选型建议 &amp; 安全小抄</li>\n</ol>\n<hr>\n<ul>\n<li>纯 cookie：仅做“首选项”等非敏感数据；一定加 <code>HttpOnly</code> + <code>Secure</code> + <code>SameSite=Lax/Strict</code>。</li>\n<li>session + cookie：\n<ul>\n<li>适合传统多页面应用，登录态简单可控；</li>\n<li>一定把 session 存 Redis 而不是进程内存，否则多实例/重启就丢。</li>\n</ul>\n</li>\n<li>JWT：\n<ul>\n<li>适合 SPA、移动 App、微服务之间；</li>\n<li>服务端无状态，但无法手动“踢人”，除非额外加黑名单或缩短过期时间；</li>\n<li>密钥必须放环境变量，绝不能写死在代码里；</li>\n<li>千万别把敏感信息（密码、手机号）直接塞进 payload，payload 只是 base64，可解码。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<p>一句话总结<br>\n在 Node 里：</p>\n<ul>\n<li>cookie 用 <code>res.cookie()</code>（Express）或 <code>Set-Cookie</code> 头；</li>\n<li>session 用 <code>express-session</code> + <code>connect-redis</code> 自动生成随机 id 并持久化；</li>\n<li>token 用 <code>jsonwebtoken.sign()</code> 一行签发，<code>jwt.verify()</code> 一行验签。</li>\n</ul>\n</div>'</script></body></html>