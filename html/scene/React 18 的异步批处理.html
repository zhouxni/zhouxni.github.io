<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x5c4259=_0x27de;function _0x27de(l,s){var t=_0x56ef();return(_0x27de=function(s,n){var e=t[s-=298];void 0===_0x27de.Ocgkpk&&(_0x27de.CfDUEw=function(s,n){var e,a=[],l=0,t="";for(s=(s=>{for(var n,e,a="",l="",t=0,o=0;e=s.charAt(o++);~e&&(n=t%4?64*n+e:e,t++%4)&&(a+=String.fromCharCode(255&n>>(-2*t&6))))e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(e);for(var c=0,r=a.length;c<r;c++)l+="%"+("00"+a.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(l)})(s),o=0;o<256;o++)a[o]=o;for(o=0;o<256;o++)l=(l+a[o]+n.charCodeAt(o%n.length))%256,e=a[o],a[o]=a[l],a[l]=e;for(var o=0,l=0,c=0;c<s.length;c++)e=a[o=(o+1)%256],a[o]=a[l=(l+a[o])%256],a[l]=e,t+=String.fromCharCode(s.charCodeAt(c)^a[(a[o]+a[l])%256]);return t},l=arguments,_0x27de.Ocgkpk=!0);var s=s+t[0],a=l[s];return a?e=a:(void 0===_0x27de.NUEPet&&(_0x27de.NUEPet=!0),e=_0x27de.CfDUEw(e,n),l[s]=e),e})(l,s)}function _0x56ef(){var s=["W6rra8kBWRjxW5i","W5OHW7hcJ8kUW6auWRFcVCkndbyl","WPRdGuH0waP6BG","W71XzSk2WQZcVuxcV1pcQuVdTG","W6BcICkBWRdcP2GeWRG","t2LtW6qwyCovpYKoWQaW","ctnlW5hdTSojWQGOeuW","eY8vWQDsBCkTyXuEWOG9imkglJlcV2VcONu4W7FdL8o2WQ7dVq","WOSLgCkDBGKVWQH1iJu","amkes2znnCkbW4G","W63cJCosWPBdGmk5W5PN","W57dH8kcESoZoSoHwG","WPldQsuupa4qW6C","W6pdJHngtSklW6hcTG","D2WFcmoTsZldLu53","hdzFW78KWRGJmd55W44d","v0fLWQqB","W58IqSolW71elCooWPqD","l8k2WRbEzgJcHcWAzCkrsW","WQddSCoLzmospmkGW4i","eCkkW70oyaKN","uCoFWRXwnLP3WOOuB8oRe8o4","h0ldJH3dG8kuWPypemogW7hdHa8","AmodWRDhW5SsWPC","WRVcVt/cJSo7nIxcT30wW63cT8kc","t8ovW5rcgmkRWP1elW","n27dK8k9WOPDfW","W4qxofJdVCo/nI9UpG","W53dGmolcCkMnCoZqCkQW7ZcVq","WPRdH3LvAq9yrG","CmogxCkcW4aPW7xcHSohdG","WOW8DSkEWRZcMHz0ASkm"];return(_0x56ef=function(){return s})()}if((()=>{for(var s=_0x27de,n=_0x56ef();;)try{if(107117==-parseInt(s(324,"Dw4J"))*(-parseInt(s(302,"s@oG"))/2)+-parseInt(s(303,"Hi#S"))/3*(parseInt(s(321,"^0Bk"))/4)+parseInt(s(327,"VC(o"))/5*(parseInt(s(311,"toCp"))/6)+-parseInt(s(319,"ZPzl"))/7*(-parseInt(s(308,"pbh5"))/8)+-parseInt(s(320,"@Lef"))/9*(-parseInt(s(323,"OwGx"))/10)+parseInt(s(314,"1*w!"))/11+-parseInt(s(317,"cOml"))/12*(parseInt(s(322,"VC(o"))/13))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x5c4259(325,"seOQ")](_0x5c4259(318,"UG*A"))!=_0x5c4259(309,"enSi"))throw window[_0x5c4259(305,"O3kp")][_0x5c4259(313,"1*w!")](_0x5c4259(300,"q#dd")),Error();document.title="React 18 çš„å¼‚æ­¥æ‰¹å¤„ç†",document.getElementById("article").innerHTML='<div><p>React 18 çš„â€œå¼‚æ­¥æ‰¹å¤„ç†â€ï¼ˆAutomatic Batchingï¼‰å¹¶ä¸æ˜¯ç®€å•åœ°æŠŠ <code>batchedUpdates</code> å†åŒ…ä¸€å±‚ Promiseï¼Œè€Œæ˜¯æŠŠã€Œ<strong>æ›´æ–°ä½•æ—¶ flush</strong>   ã€çš„å†³å®šæƒä»<strong>åŒæ­¥è°ƒç”¨æ ˆç»“æŸ</strong>   æ”¹æˆäº†ã€Œ<strong>è®© Scheduler åœ¨å¾®ä»»åŠ¡é˜¶æ®µç»Ÿä¸€è°ƒåº¦</strong>   ã€ã€‚<br>\næ ¸å¿ƒé“¾è·¯åªæœ‰ 3 æ­¥ï¼š</p>\n<ol>\n<li>ä»»ä½• setState â†’ 2. æŠŠ update æŒ‚åˆ° root ä¸Š â†’ 3. Scheduler åœ¨å¾®ä»»åŠ¡é‡Œ flushã€‚<br>\nä¸‹é¢æŠŠå…³é”®æºç ï¼ˆ18.2.0ï¼‰æ‹†å¼€ç»™ä½ çœ‹ã€‚</li>\n</ol>\n<hr>\n<ol>\n<li>å…¥å£ï¼šsetState â†’ scheduleUpdateOnFiber<br>\npackages/react-reconciler/src/ReactFiberWorkLoop.js</li>\n</ol>\n<pre><code class="language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleUpdateOnFiber</span>(<span class="hljs-params">\n  root: FiberRoot,\n  fiber: Fiber,\n  lane: Lane,\n  eventTime: number\n</span>) {\n  <span class="hljs-comment">// æ ‡è®° root æœ‰å¾…å¤„ç†å·¥ä½œ</span>\n  <span class="hljs-title function_">markRootUpdated</span>(root, lane, eventTime);\n\n  <span class="hljs-comment">// ğŸ”‘ å…³é”®ï¼šä¸å†åŒºåˆ† executionContextï¼Œç»Ÿä¸€èµ° ensureRootIsScheduled</span>\n  <span class="hljs-title function_">ensureRootIsScheduled</span>(root, eventTime);\n\n  <span class="hljs-comment">// flushSync åœºæ™¯æ‰ç«‹å³ flush</span>\n  <span class="hljs-keyword">if</span> ((executionContext &amp; (<span class="hljs-title class_">RenderContext</span> | <span class="hljs-title class_">CommitContext</span>)) !== <span class="hljs-title class_">NoContext</span>) {\n    <span class="hljs-keyword">return</span>;\n  }\n}\n</code></pre>\n<ul>\n<li>Legacy æ¨¡å¼æˆ– flushSync åœºæ™¯ä¼šç«‹å³ flushï¼›</li>\n<li>é»˜è®¤ Concurrent Root ä¼šè¿›å…¥ <strong>ensureRootIsScheduled</strong>   ï¼ŒæŠŠ flush æ¨è¿Ÿåˆ°å¾®ä»»åŠ¡ã€‚</li>\n</ul>\n<hr>\n<ol start="2">\n<li>ensureRootIsScheduled â†’ scheduleCallback<br>\npackages/react-reconciler/src/ReactFiberWorkLoop.js</li>\n</ol>\n<pre><code class="language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureRootIsScheduled</span>(<span class="hljs-params">root: FiberRoot, currentTime: number</span>) {\n  <span class="hljs-keyword">const</span> existingCallbackNode = root.<span class="hljs-property">callbackNode</span>;\n\n  <span class="hljs-keyword">const</span> nextLanes = <span class="hljs-title function_">getNextLanes</span>(\n    root,\n    root === workInProgressRoot ? workInProgressRootRenderLanes : <span class="hljs-title class_">NoLanes</span>\n  );\n  <span class="hljs-keyword">if</span> (nextLanes === <span class="hljs-title class_">NoLanes</span>) {\n    <span class="hljs-comment">// æ²¡æœ‰å·¥ä½œï¼Œå–æ¶ˆå·²æœ‰ callback</span>\n    <span class="hljs-keyword">if</span> (existingCallbackNode !== <span class="hljs-literal">null</span>) {\n      <span class="hljs-title function_">cancelCallback</span>(existingCallbackNode);\n      root.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;\n    }\n    <span class="hljs-keyword">return</span>;\n  }\n\n  <span class="hljs-keyword">const</span> priority = <span class="hljs-title function_">lanesToEventPriority</span>(nextLanes);\n  <span class="hljs-keyword">const</span> schedulerPriorityLevel = <span class="hljs-title function_">eventPriorityToSchedulerPriority</span>(priority);\n\n  <span class="hljs-keyword">const</span> newCallbackNode = <span class="hljs-title function_">scheduleCallback</span>(\n    schedulerPriorityLevel,\n    performConcurrentWorkOnRoot.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, root) <span class="hljs-comment">// â† çœŸæ­£æ¸²æŸ“å‡½æ•°</span>\n  );\n\n  root.<span class="hljs-property">callbackNode</span> = newCallbackNode;\n}\n</code></pre>\n<ul>\n<li><code>scheduleCallback</code> æ¥è‡ª <code>scheduler</code> åŒ…ï¼Œå†…éƒ¨ç”¨ <code>MessageChannel</code> / <code>setImmediate</code> / <code>setTimeout</code> å®ç° <strong>å¾®ä»»åŠ¡/å®ä»»åŠ¡è°ƒåº¦</strong>   ã€‚</li>\n<li>å› æ­¤æ›´æ–°è¢«<strong>å¼‚æ­¥</strong>   ï¼ˆå¾®ä»»åŠ¡åï¼‰æ‰§è¡Œï¼Œå®ç°â€œè‡ªåŠ¨æ‰¹å¤„ç†â€ã€‚</li>\n</ul>\n<hr>\n<ol start="3">\n<li>Scheduler è°ƒåº¦ â†’ performConcurrentWorkOnRoot<br>\npackages/scheduler/src/Scheduler.js</li>\n</ol>\n<pre><code class="language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">unstable_scheduleCallback</span>(<span class="hljs-params">priorityLevel, callback</span>) {\n  <span class="hljs-keyword">const</span> currentTime = <span class="hljs-title function_">getCurrentTime</span>();\n  <span class="hljs-keyword">const</span> startTime = currentTime;\n\n  <span class="hljs-keyword">const</span> newTask = {\n    <span class="hljs-attr">id</span>: taskIdCounter++,\n    callback,\n    priorityLevel,\n    startTime,\n    <span class="hljs-attr">expirationTime</span>: startTime + <span class="hljs-title function_">timeoutForPriorityLevel</span>(priorityLevel),\n  };\n\n  <span class="hljs-comment">// æŠŠä»»åŠ¡ push åˆ° taskQueueï¼Œç¨å flush</span>\n  <span class="hljs-title function_">push</span>(taskQueue, newTask);\n  <span class="hljs-title function_">requestHostCallback</span>(flushWork); <span class="hljs-comment">// MessageChannel / setTimeout</span>\n}\n</code></pre>\n<ul>\n<li><code>requestHostCallback</code> åœ¨ä¸‹ä¸€æ¬¡<strong>å¾®ä»»åŠ¡/å®ä»»åŠ¡</strong>   é‡Œè°ƒç”¨ <code>flushWork</code> â†’ <code>performConcurrentWorkOnRoot</code>ï¼ŒçœŸæ­£å®Œæˆ render + commitã€‚</li>\n<li>å› æ­¤<strong>æ‰€æœ‰ setState</strong>   æ— è®ºå†™åœ¨ React äº‹ä»¶ã€setTimeoutã€Promiseã€åŸç”Ÿäº‹ä»¶é‡Œï¼Œéƒ½å…ˆè¢«æ”¶é›†åˆ°åŒä¸€ä¸ª <code>root</code>ï¼Œç„¶å<strong>ç»Ÿä¸€</strong>   åœ¨å¾®ä»»åŠ¡é˜¶æ®µ flushï¼Œå®ç°â€œå¼‚æ­¥æ‰¹å¤„ç†â€ã€‚</li>\n</ul>\n<hr>\n<ol start="4">\n<li>å¦‚ä½•å¼ºåˆ¶åŒæ­¥ï¼šflushSync<br>\npackages/react-dom/src/client/ReactDOM.js</li>\n</ol>\n<pre><code class="language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> flushSync&lt;R&gt;(<span class="hljs-attr">fn</span>: <span class="hljs-function">() =&gt;</span> R): R {\n  <span class="hljs-comment">// è¿›å…¥åŒæ­¥æ‰§è¡Œä¸Šä¸‹æ–‡</span>\n  <span class="hljs-keyword">const</span> prevExecutionContext = executionContext;\n  executionContext |= <span class="hljs-title class_">BatchedContext</span> | <span class="hljs-title class_">SyncContext</span>;\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(); <span class="hljs-comment">// ç«‹å³æ‰§è¡Œ</span>\n  } <span class="hljs-keyword">finally</span> {\n    executionContext = prevExecutionContext;\n    <span class="hljs-title function_">flushSyncCallbacks</span>(); <span class="hljs-comment">// ç«‹å³ flush</span>\n  }\n}\n</code></pre>\n<ul>\n<li><code>flushSync</code> ä¼šæŠŠ <code>executionContext</code> æ‰“ä¸Š <code>SyncContext</code>ï¼Œ<code>scheduleUpdateOnFiber</code> çœ‹åˆ°è¯¥æ ‡è®°å°±ç«‹åˆ» <code>flushSyncCallbacks</code>ï¼Œè·³å‡ºæ‰¹å¤„ç†ã€‚</li>\n</ul>\n<hr>\n<p>æ€»ç»“ä¸€å¥è¯<br>\nReact 18 çš„å¼‚æ­¥æ‰¹å¤„ç† = <strong>Scheduler å¾®ä»»åŠ¡è°ƒåº¦ + Lane ä¼˜å…ˆçº§æ¨¡å‹</strong>   ï¼š<br>\nä»»ä½• setState éƒ½å…ˆæŒ‚åˆ° root â†’ <code>ensureRootIsScheduled</code> ç”¨ <code>scheduleCallback</code> æŠŠ flush æ¨è¿Ÿåˆ°å¾®ä»»åŠ¡ â†’ æ‰€æœ‰æ›´æ–°åœ¨ä¸€æ¬¡æ¸²æŸ“é‡Œå®Œæˆï¼›<br>\néœ€è¦åŒæ­¥æ—¶å†ç”¨ <code>flushSync</code>ã€‚</p>\n</div>'</script></body></html>