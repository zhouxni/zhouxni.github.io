<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x4e8b(t,s){var p=_0x404e();return(_0x4e8b=function(s,n){var a=p[s-=122];void 0===_0x4e8b.xnHuYs&&(_0x4e8b.BrsLcf=function(s,n){var a,l=[],t=0,p="";for(s=(s=>{for(var n,a,l="",t="",p=0,e=0;a=s.charAt(e++);~a&&(n=p%4?64*n+a:a,p++%4)&&(l+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=l.length;c<o;c++)t+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(t)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)t=(t+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[t],l[t]=a;for(var e=0,t=0,c=0;c<s.length;c++)a=l[e=(e+1)%256],l[e]=l[t=(t+l[e])%256],l[t]=a,p+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[t])%256]);return p},t=arguments,_0x4e8b.xnHuYs=!0);var s=s+p[0],l=t[s];return l?a=l:(void 0===_0x4e8b.RZkvFJ&&(_0x4e8b.RZkvFJ=!0),a=_0x4e8b.BrsLcf(a,n),t[s]=a),a})(t,s)}var _0x5eb5c9=_0x4e8b;function _0x404e(){var s=["nvKga1ZdOJ8EraZdVtC","c8oovLaV","nfqgavRdRGigFqldRcO","wmknW6q3WQuicbfuWOFdJ0G","WO/dNYVcI8kumMVcUa","WPfxc8kCe8kFymoaW44e","sSklerCSpmk5W5lcMmoz","W6VdS0yUW6/dNZFcGSo5WRldOq","Ae7dONFdOtXdAa","imkqmmozWRLoE3W1cmoMW4G","BuZdJ8kgrmoYW7rvW47dVMhdOv0EvSk7W47cQgzoW7yLvCophCkH","W7VdILO8CmkPsuldHgLPjW","W4HZgmoFpCkeWPKjaM00wr8","W7pdQCkzl8k5WO1FW6y9","urH4bSk9W4S3WQBdTCkzW7C","nWVcI8ohamo4W64cW5hdRMZdGwm","W5ZcVftcPfhcSeNdGq","aCk+hCkHWQKvwW","W7hcJmopW6tcUbXFCq","WPDswmoQhmkfz8oG","xXL9amk8WRnZWONdHSkhW7tdHmos","W7BcM07cPw9WWRTJE0GM","W4VcTftdMCkhWPtdHhzlWObeWQu","W4Ccs8oHhCkXra","imksmSozWR5kgeuDeSoLW44O","WPjxbSkrw8koFSoiW5CYWQq"];return(_0x404e=function(){return s})()}if((()=>{for(var s=_0x4e8b,n=_0x404e();;)try{if(245846==+parseInt(s(132,"5Bvz"))+-parseInt(s(134,"5Bvz"))/2+-parseInt(s(124,"f&%["))/3*(parseInt(s(135,"qA3c"))/4)+parseInt(s(140,"kSUY"))/5*(parseInt(s(127,"cO]H"))/6)+-parseInt(s(147,"JMS0"))/7+parseInt(s(139,"IsJD"))/8*(-parseInt(s(137,"FYKW"))/9)+parseInt(s(126,"N2J4"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x5eb5c9(129,"FYKW")](_0x5eb5c9(145,"wFc@"))!=_0x5eb5c9(133,"Sbft"))throw window[_0x5eb5c9(122,"AZfI")][_0x5eb5c9(123,"SG9I")](_0x5eb5c9(142,"JMS0")),Error();document.title="react åœ¨ SSR é˜¶æ®µå¾€ç»„ä»¶å†…éƒ¨æ³¨å…¥ useEffect",document.getElementById("article").innerHTML='<div><p>åœ¨ SSR (Server-Side Rendering) é˜¶æ®µï¼Œè™½ç„¶ <code>useEffect</code> ä»£ç ä¸ä¼šåœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å°† <code>useEffect</code> é€»è¾‘æ³¨å…¥åˆ° <code>App</code> ç»„ä»¶ä¸­ï¼Œå¹¶ç¡®ä¿è¿™äº›ä»£ç <strong>ä»…åœ¨å®¢æˆ·ç«¯è¿è¡Œ</strong>   ï¼š</p>\n<hr>\n<h3><strong>1. æ ¸å¿ƒåŸç†</strong></h3>\n<ul>\n<li><strong>æœåŠ¡ç«¯</strong>   ï¼šå°†éœ€è¦æ‰§è¡Œçš„ <code>useEffect</code> ä»£ç æ ‡è®°æˆ–åºåˆ—åŒ–ï¼ŒåµŒå…¥åˆ° HTML ä¸­ã€‚</li>\n<li><strong>å®¢æˆ·ç«¯</strong>   ï¼šä» HTML ä¸­æå–è¿™äº›ä»£ç ï¼Œåœ¨ <code>useEffect</code> ä¸­åŠ¨æ€æ‰§è¡Œã€‚</li>\n</ul>\n<hr>\n<h3><strong>2. å®ç°æ–¹æ¡ˆ</strong></h3>\n<h4><strong>æ–¹æ¡ˆ 1ï¼šå…¨å±€å˜é‡ + åŠ¨æ€æ‰§è¡Œï¼ˆæ¨èï¼‰</strong></h4>\n<h5><strong>æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰</strong></h5>\n<pre><code class="language-jsx"><span class="hljs-comment">// server.js</span>\napp.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n  <span class="hljs-comment">// å®šä¹‰éœ€è¦åœ¨å®¢æˆ·ç«¯æ‰§è¡Œçš„ useEffect é€»è¾‘</span>\n  <span class="hljs-keyword">const</span> clientEffects = [\n    {\n      <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;console.log(&quot;è¿™æ®µä»£ç åªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ&quot;)&#x27;</span>,\n      <span class="hljs-attr">deps</span>: [],\n    },\n    {\n      <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;fetch(&quot;/api/data&quot;).then(res =&gt; res.json())&#x27;</span>,\n      <span class="hljs-attr">deps</span>: [],\n    },\n  ];\n\n  <span class="hljs-keyword">const</span> html = <span class="hljs-title function_">renderToString</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);\n\n  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`\n    &lt;html&gt;\n      &lt;body&gt;\n        &lt;div id=&quot;root&quot;&gt;<span class="hljs-subst">${html}</span>&lt;/div&gt;\n        &lt;script&gt;\n          // å°† useEffect é€»è¾‘ä¿å­˜åˆ°å…¨å±€å˜é‡\n          window.__CLIENT_EFFECTS__ = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(clientEffects)}</span>;\n        &lt;/script&gt;\n        &lt;script src=&quot;/client.js&quot;&gt;&lt;/script&gt;\n      &lt;/body&gt;\n    &lt;/html&gt;\n  `</span>);\n});\n</code></pre>\n<h5><strong>å®¢æˆ·ç«¯ï¼ˆReact ç»„ä»¶ï¼‰</strong></h5>\n<pre><code class="language-jsx"><span class="hljs-comment">// App.js</span>\n<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-comment">// å®¢æˆ·ç«¯è¿è¡Œæ—¶æ‰§è¡Œæ³¨å…¥çš„ä»£ç </span>\n  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">&quot;undefined&quot;</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">__CLIENT_EFFECTS__</span>) {\n      <span class="hljs-variable language_">window</span>.<span class="hljs-property">__CLIENT_EFFECTS__</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ code }</span>) =&gt;</span> {\n        <span class="hljs-keyword">try</span> {\n          <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(code)(); <span class="hljs-comment">// åŠ¨æ€æ‰§è¡Œä»£ç </span>\n        } <span class="hljs-keyword">catch</span> (err) {\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;æ‰§è¡Œå®¢æˆ·ç«¯æ•ˆæœå¤±è´¥:&quot;</span>, err);\n        }\n      });\n    }\n  }, []);\n\n  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>My App<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;\n}\n</code></pre>\n<hr>\n<h4><strong>æ–¹æ¡ˆ 2ï¼šè‡ªå®šä¹‰ Hook å°è£…</strong></h4>\n<h5><strong>å®šä¹‰ Hook</strong></h5>\n<pre><code class="language-jsx"><span class="hljs-comment">// hooks/useClientEffect.js</span>\n<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useClientEffect</span>(<span class="hljs-params">effect, deps = []</span>) {\n  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">&quot;undefined&quot;</span>) {\n      <span class="hljs-keyword">return</span> <span class="hljs-title function_">effect</span>();\n    }\n  }, deps);\n}\n</code></pre>\n<h5><strong>æœåŠ¡ç«¯æ³¨å…¥</strong></h5>\n<pre><code class="language-jsx"><span class="hljs-comment">// server.js</span>\n<span class="hljs-keyword">const</span> clientEffects = [\n  { <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;() =&gt; console.log(&quot;Hello from client!&quot;)&#x27;</span>, <span class="hljs-attr">deps</span>: [] },\n];\n\nres.<span class="hljs-title function_">send</span>(<span class="hljs-string">`\n  &lt;script&gt;\n    window.__CLIENT_EFFECTS__ = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(clientEffects)}</span>;\n  &lt;/script&gt;\n`</span>);\n</code></pre>\n<h5><strong>ç»„ä»¶ä¸­ä½¿ç”¨</strong></h5>\n<pre><code class="language-jsx"><span class="hljs-comment">// App.js</span>\n<span class="hljs-keyword">import</span> { useClientEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./hooks/useClientEffect&quot;</span>;\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">&quot;undefined&quot;</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">__CLIENT_EFFECTS__</span>) {\n    <span class="hljs-variable language_">window</span>.<span class="hljs-property">__CLIENT_EFFECTS__</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ code }</span>) =&gt;</span> {\n      <span class="hljs-title function_">useClientEffect</span>(<span class="hljs-function">() =&gt;</span> {\n        <span class="hljs-keyword">const</span> effect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">`return <span class="hljs-subst">${code}</span>`</span>)();\n        <span class="hljs-title function_">effect</span>();\n      });\n    });\n  }\n\n  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>My App<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;\n}\n</code></pre>\n<hr>\n<h3><strong>3. é«˜çº§ç”¨æ³•ï¼šæ”¯æŒä¾èµ–é¡¹</strong></h3>\n<p>å¦‚æœéœ€è¦ä¾èµ– React çŠ¶æ€æˆ– propsï¼Œå¯ä»¥æ”¹è¿›æ³¨å…¥é€»è¾‘ï¼š</p>\n<h5><strong>æœåŠ¡ç«¯</strong></h5>\n<pre><code class="language-jsx"><span class="hljs-keyword">const</span> clientEffects = [\n  {\n    <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;(count) =&gt; console.log(&quot;Count is:&quot;, count)&#x27;</span>,\n    <span class="hljs-attr">deps</span>: [<span class="hljs-string">&quot;count&quot;</span>], <span class="hljs-comment">// å£°æ˜ä¾èµ–çš„å˜é‡å</span>\n  },\n];\n</code></pre>\n<h5><strong>å®¢æˆ·ç«¯</strong></h5>\n<pre><code class="language-jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ initialCount }</span>) {\n  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(initialCount);\n\n  <span class="hljs-title function_">useClientEffect</span>(<span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">const</span> effect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">&quot;count&quot;</span>, <span class="hljs-string">`return <span class="hljs-subst">${code}</span>`</span>)(count);\n    <span class="hljs-title function_">effect</span>();\n  }, [count]); <span class="hljs-comment">// ä¾èµ–é¡¹å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ</span>\n}\n</code></pre>\n<hr>\n<h3><strong>4. å®‰å…¨æ³¨æ„äº‹é¡¹</strong></h3>\n<ol>\n<li><strong>é¿å… XSS æ”»å‡»</strong>   ï¼šå¦‚æœä»£ç æ¥è‡ªç”¨æˆ·è¾“å…¥ï¼Œéœ€ sanitizeï¼š<pre><code class="language-jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">DOMPurify</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;dompurify&quot;</span>;\n<span class="hljs-keyword">const</span> safeCode = <span class="hljs-title class_">DOMPurify</span>.<span class="hljs-title function_">sanitize</span>(rawCode);\n</code></pre>\n</li>\n<li><strong>ç”Ÿäº§ç¯å¢ƒæ¸…ç†</strong>   ï¼š<pre><code class="language-jsx"><span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&quot;production&quot;</span>) {\n  <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">__CLIENT_EFFECTS__</span>;\n}\n</code></pre>\n</li>\n</ol>\n<hr>\n<h3><strong>5. å®Œæ•´æµç¨‹æ€»ç»“</strong></h3>\n<ol>\n<li><strong>æœåŠ¡ç«¯</strong>   ï¼š\n<ul>\n<li>å°† <code>useEffect</code> é€»è¾‘åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚</li>\n<li>é€šè¿‡ <code>window.__CLIENT_EFFECTS__</code> æ³¨å…¥åˆ° HTMLã€‚</li>\n</ul>\n</li>\n<li><strong>å®¢æˆ·ç«¯</strong>   ï¼š\n<ul>\n<li>åœ¨ç»„ä»¶ <code>useEffect</code> ä¸­è¯»å–å…¨å±€å˜é‡ã€‚</li>\n<li>ç”¨ <code>new Function()</code> æˆ– <code>eval()</code>ï¼ˆè°¨æ…ï¼‰åŠ¨æ€æ‰§è¡Œä»£ç ã€‚</li>\n</ul>\n</li>\n<li><strong>ä¼˜åŒ–</strong>   ï¼š\n<ul>\n<li>å°è£…ä¸ºè‡ªå®šä¹‰ Hookï¼ˆå¦‚ <code>useClientEffect</code>ï¼‰ã€‚</li>\n<li>æ”¯æŒä¾èµ–é¡¹è·Ÿè¸ªã€‚</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3><strong>6. æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”</strong></h3>\n<table>\n<thead>\n<tr>\n<th>æ–¹æ³•</th>\n<th>ä¼˜ç‚¹</th>\n<th>ç¼ºç‚¹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>å…¨å±€å˜é‡æ³¨å…¥</strong></td>\n<td>ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–ä¾èµ–</td>\n<td>éœ€æ‰‹åŠ¨ç®¡ç†ä¾èµ–é¡¹</td>\n</tr>\n<tr>\n<td><strong>è‡ªå®šä¹‰ Hook</strong></td>\n<td>ä»£ç æ›´å¥å£®ï¼Œæ˜“äºå¤ç”¨</td>\n<td>éœ€è¦åˆå§‹å°è£…æˆæœ¬</td>\n</tr>\n<tr>\n<td><strong>Next.js æ’ä»¶</strong></td>\n<td>å¼€ç®±å³ç”¨ï¼ˆå¦‚ <code>next/dynamic</code>ï¼‰</td>\n<td>éœ€ä¾èµ–æ¡†æ¶</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3><strong>æœ€ç»ˆæ¨èæ–¹æ¡ˆ</strong></h3>\n<pre><code class="language-jsx"><span class="hljs-comment">// æœåŠ¡ç«¯</span>\n<span class="hljs-keyword">const</span> clientEffects = [\n  {\n    <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;() =&gt; console.log(&quot;Client-only code!&quot;)&#x27;</span>,\n  },\n];\n\n<span class="hljs-comment">// å®¢æˆ·ç«¯</span>\n<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">&quot;undefined&quot;</span>) {\n    <span class="hljs-variable language_">window</span>.<span class="hljs-property">__CLIENT_EFFECTS__</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ code }</span>) =&gt;</span> {\n      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(code)();\n    });\n  }\n}, []);\n</code></pre>\n<p>è¿™ç§æ–¹å¼æ—¢ä¿æŒäº† SSR çš„ SEO ä¼˜åŠ¿ï¼Œåˆèƒ½ç²¾å‡†æ§åˆ¶å®¢æˆ·ç«¯å‰¯ä½œç”¨ï¼ ğŸš€ ï¼ˆVue SSR åŸç†ä¸ React ç±»ä¼¼ï¼‰</p>\n</div>'</script></body></html>