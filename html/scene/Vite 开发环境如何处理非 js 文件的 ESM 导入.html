<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x1fe4(l,n){var e=_0x1d5c();return(_0x1fe4=function(n,s){var t=e[n-=325];void 0===_0x1fe4.VutXQt&&(_0x1fe4.PNDYlq=function(n,s){var t,o=[],l=0,e="";for(n=(n=>{for(var s,t,o="",l="",e=0,a=0;t=n.charAt(a++);~t&&(s=e%4?64*s+t:t,e++%4)&&(o+=String.fromCharCode(255&s>>(-2*e&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var r=0,c=o.length;r<c;r++)l+="%"+("00"+o.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(l)})(n),a=0;a<256;a++)o[a]=a;for(a=0;a<256;a++)l=(l+o[a]+s.charCodeAt(a%s.length))%256,t=o[a],o[a]=o[l],o[l]=t;for(var a=0,l=0,r=0;r<n.length;r++)t=o[a=(a+1)%256],o[a]=o[l=(l+o[a])%256],o[l]=t,e+=String.fromCharCode(n.charCodeAt(r)^o[(o[a]+o[l])%256]);return e},l=arguments,_0x1fe4.VutXQt=!0);var n=n+e[0],o=l[n];return o?t=o:(void 0===_0x1fe4.DSbtyI&&(_0x1fe4.DSbtyI=!0),t=_0x1fe4.PNDYlq(t,s),l[n]=t),t})(l,n)}var _0x4bf761=_0x1fe4;if((()=>{for(var n=_0x1fe4,s=_0x1d5c();;)try{if(165046==+parseInt(n(328,"zrku"))+-parseInt(n(335,"#Fc)"))/2*(-parseInt(n(339,"OXgp"))/3)+parseInt(n(330,"OXgp"))/4+-parseInt(n(325,"rih["))/5+parseInt(n(333,"yX9!"))/6+-parseInt(n(327,"DnVD"))/7*(-parseInt(n(337,"^)Gm"))/8)+-parseInt(n(332,"lq&Y"))/9*(parseInt(n(329,"AH]A"))/10))break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x4bf761(348,"si2W")](_0x4bf761(336,"coX8"))!=_0x4bf761(334,"yX9!"))throw window[_0x4bf761(331,"$APN")][_0x4bf761(347,"vulY")](_0x4bf761(344,"1Z76")),Error();function _0x1d5c(){var n=["dComWOhcKu4jW6S","l8oVWQmiWPZdM8oa","n8k2WRrgWPC/WPGZnIddTG","o11pxmk1W7L+tuPbWP4l","aYv6W4BcJmojWP48sSofEgS","fCoaW79mWRpcPHe9W5KSW5ZcOq","W4tcIwX4W43dQI7dTG","ASoAyM/cUCoQw1xdPMqvwW","WPnNW4hdVcJdKCo3WQPZ","eKaUWQ5vWODPWOldQXBcHue","W5BcN8oWWRzYF0e0","h3ldPexdGSknASkxW61DDa","hIdcMSoVWQ9nW4NcMCktsNJdM8oX","x2ldNCkUW6a","BSoqWRyjWO/cQLrhASk8eSoA","W6GIWQ7dMSoWWR7dGCkskq","WRFdVCoRCeZdR0mEdt57mW","ESk7WQeBWO7dK8oAW4u","hb5SW64PW4Hs","E8ktEXxdR8oBtZNcNxv7WOlcUq","W4ezWO1LW5P7nGddRmo9qCkL","w34kFdtdO8kkW4hcNG","W4CzWO1IW5H5jdtdL8oRw8kg","iSoqo1FcQSovvKZcLvr4WRBcHY4DqbFdUJldS8kKggDaW5pdOG","vs5jsrFdUmkx","taS6W5xdNIVcO0RcKSk9bmoy"];return(_0x1d5c=function(){return n})()}document.title="Vite 开发环境如何处理非 js 文件的 ESM 导入",document.getElementById("article").innerHTML='<div><p>在 Vite 的开发环境中，非 JavaScript 文件（如 CSS、图片、JSON 等）的 ESM 导入是通过 <strong>浏览器原生 ESM 机制 + Vite 的即时转换</strong>   来实现的。以下是详细处理流程：</p>\n<hr>\n<h3><strong>1. 核心机制</strong></h3>\n<ol>\n<li><strong>浏览器发起请求</strong>\n<ul>\n<li>当代码中出现 <code>import \'./style.css\'</code> 或 <code>import img from \'./image.png\'</code> 时，浏览器会直接发起对这些文件的 HTTP 请求（因为 ESM 支持静态导入）。</li>\n<li>但浏览器默认只能执行 JS 模块，无法直接解析 CSS/图片等文件。</li>\n</ul>\n</li>\n<li><strong>Vite 拦截并转换</strong>\n<ul>\n<li>Vite 的开发服务器（<code>vite dev</code>）会拦截这些请求，通过 <strong>插件系统</strong>   将非 JS 文件转换为浏览器可执行的 ESM 格式：\n<ul>\n<li><strong>CSS</strong>   → 转换为 JS 代码，动态注入 <code>&lt;style&gt;</code> 标签。</li>\n<li><strong>图片/字体</strong>   → 返回解析后的 URL（如 <code>export default \'/src/image.png\'</code>）。</li>\n<li><strong>JSON</strong>   → 自动转换为 JS 对象（<code>export default { ... }</code>）。</li>\n<li><strong>其他文件</strong>  （如 <code>.svg</code>, <code>.yaml</code>）→ 通过插件转换为有效 JS 模块。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><strong>HMR（热更新）支持</strong>\n<ul>\n<li>修改非 JS 文件时，Vite 会重新转换并通知浏览器更新，无需刷新页面。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3><strong>2. 不同文件类型的处理细节</strong></h3>\n<h4><strong>（1）CSS 文件</strong></h4>\n<ul>\n<li><strong>导入方式</strong>  ：<code>import \'./style.css\'</code></li>\n<li><strong>转换结果</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// Vite 将 CSS 转换为 JS 代码，动态插入 &lt;style&gt; 标签</span>\n<span class="hljs-keyword">const</span> style = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;style&#x27;</span>);\nstyle.<span class="hljs-property">textContent</span> = <span class="hljs-string">`/* CSS 文件内容 */`</span>;\n<span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(style);\n</code></pre>\n</li>\n<li><strong>CSS Modules</strong>  ：<br>\n使用 <code>import styles from \'./module.module.css\'</code>，Vite 会生成哈希类名并返回映射对象。</li>\n</ul>\n<h4><strong>（2）静态资源（图片、字体等）</strong></h4>\n<ul>\n<li><strong>导入方式</strong>  ：<code>import imgUrl from \'./image.png\'</code></li>\n<li><strong>转换结果</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// 返回解析后的公共路径</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;/src/assets/image.png&#x27;</span>;\n</code></pre>\n</li>\n<li><strong>内联小文件</strong>  ：<br>\n若文件小于 <code>assetsInlineLimit</code>（默认 4KB），直接转为 Base64 URL（如 <code>export default \'data:image/png;base64,...\'</code>）。</li>\n</ul>\n<h4><strong>（3）JSON 文件</strong></h4>\n<ul>\n<li><strong>导入方式</strong>  ：<code>import data from \'./data.json\'</code></li>\n<li><strong>转换结果</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// 自动解析为 JS 对象</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { <span class="hljs-string">&quot;key&quot;</span>: <span class="hljs-string">&quot;value&quot;</span> };\n</code></pre>\n</li>\n</ul>\n<h4><strong>（4）WebAssembly</strong></h4>\n<ul>\n<li><strong>导入方式</strong>  ：<code>import init from \'./module.wasm\'</code></li>\n<li><strong>转换结果</strong>  ：<br>\nVite 返回 WASM 实例化的 Promise：<pre><code class="language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/module.wasm&#x27;</span>)\n  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title function_">instantiate</span>(response));\n</code></pre>\n</li>\n</ul>\n<h4><strong>（5）自定义文件（如 SVG、YAML）</strong></h4>\n<ul>\n<li><strong>通过插件转换</strong>  ：\n<ul>\n<li>SVG 可作为 React/Vue 组件（需 <code>vite-plugin-svgr</code>）。</li>\n<li>YAML 可通过 <code>vite-plugin-yaml</code> 转换为 JS 对象。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3><strong>3. 关键配置（<code>vite.config.js</code>）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-comment">// 扩展静态资源类型</span>\n  <span class="hljs-attr">assetsInclude</span>: [<span class="hljs-string">&#x27;**/*.gltf&#x27;</span>],\n\n  <span class="hljs-comment">// 调整内联文件大小阈值</span>\n  <span class="hljs-attr">build</span>: {\n    <span class="hljs-attr">assetsInlineLimit</span>: <span class="hljs-number">4096</span>, <span class="hljs-comment">// 4KB</span>\n  },\n\n  <span class="hljs-comment">// 使用插件处理特定文件</span>\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;vite-plugin-md&#x27;</span>), <span class="hljs-comment">// 处理 Markdown</span>\n  ],\n};\n</code></pre>\n<hr>\n<h3><strong>4. 底层实现原理</strong></h3>\n<ol>\n<li><strong>请求拦截</strong><br>\nVite 使用 <code>connect</code> 中间件拦截浏览器请求，匹配非 JS 文件后交给插件处理。</li>\n<li><strong>转换流程</strong><pre><code class="language-mermaid">graph LR\n  A[浏览器请求 CSS/图片] --&gt; B(Vite 拦截)\n  B --&gt; C{文件类型}\n  C --&gt;|CSS| D[转换为 JS 插入 &lt;style&gt;]\n  C --&gt;|图片| E[返回 URL/Base64]\n  C --&gt;|JSON| F[转换为 JS 对象]\n</code></pre>\n</li>\n<li><strong>ESM 兼容性</strong>\n<ul>\n<li>所有转换后的模块均符合 ESM 规范（使用 <code>export default</code> 或命名导出）。</li>\n<li>依赖浏览器原生 <code>import</code> 语法，无需打包。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3><strong>5. 与生产环境的区别</strong></h3>\n<table>\n<thead>\n<tr>\n<th><strong>特性</strong></th>\n<th><strong>开发环境</strong></th>\n<th><strong>生产环境</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>处理方式</strong></td>\n<td>按需转换（浏览器请求时）</td>\n<td>Rollup 提前打包所有资源</td>\n</tr>\n<tr>\n<td><strong>输出格式</strong></td>\n<td>保留原始文件结构</td>\n<td>哈希文件名 + 优化合并</td>\n</tr>\n<tr>\n<td><strong>HMR</strong></td>\n<td>支持</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td><strong>性能优化</strong></td>\n<td>快速启动（无打包）</td>\n<td>代码压缩/Tree-shaking</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3><strong>总结</strong></h3>\n<p>Vite 在开发环境下通过 <strong>拦截浏览器请求 + 实时转换</strong>   实现非 JS 文件的 ESM 导入，核心依赖：</p>\n<ol>\n<li>浏览器原生 ESM 的 <code>import</code> 语法。</li>\n<li>Vite 插件系统对文件类型的按需转换。</li>\n<li>开发服务器的中间件机制和 HMR 支持。</li>\n</ol>\n<p>这种设计使得开发体验极其快速，同时保持与生产环境行为的一致性。</p>\n</div>'</script></body></html>