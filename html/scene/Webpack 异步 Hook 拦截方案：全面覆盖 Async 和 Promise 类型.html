<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5190(){var s=["BcFcGNvkW6yDW6ZdI8kmW7BcNSoK","jq51W7rNBCkBW5BcHe8BWP1m","W4u/WQZcHSkaW7tdT8oHW4afWOf1","FMaAW7ufwCkA","r2DUW7TqW6BcV8kZDhvjW53cSW","WP7cUGiOWPZcKbddUIFdNxFcR8k4","W4L9WOVcKv3dLJGX","iSocc1/cH8o7WQ7cOSk1pY1NW6a","luauW4FdH8kRBvdcThbIW6lcIW","WPldSmkTeGhcISk5WOldIG","at1sWQ/cNMmM","p8o2naRdIrSrBqy","WQ0QWQqfW5e","sCkufemVWOyJW6bMnCkcWOf0","WRjedg3cMCoEuG","WP/dK27dI0pdRCokgx/cJGvy","W546WP7dLCo+qNqrqq","W7HMoMZcQSonwG","pSkzk8k4W7ThW7S","t2PGtalcLXtcPW/dSmo/dha","eCoWueVcH8kTW75AWPL4","lrqnmLxdTCk4vG","e8kReGFcGSkgW6q","W5vTFCo+cSkHW7/dHvJcLHveFG","WPhdSCo1oYxcS8kHWPO","WRG3CJhdUSkCcCo2W4GjW57dPGy","lCocj8k+WQRcTGnAzCoD","gCkTeH/cMSkyWRmxC8oRWOProSk+sIZcHaboW7tcTw8/W7OxW5O"];return(_0x5190=function(){return s})()}var _0x2f213e=_0x11fd;function _0x11fd(p,s){var t=_0x5190();return(_0x11fd=function(s,a){var n=t[s-=209];void 0===_0x11fd.gBGACQ&&(_0x11fd.kBDiXe=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,c=0;n=s.charAt(c++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var o=0,e=l.length;o<e;o++)p+="%"+("00"+l.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+a.charCodeAt(c%a.length))%256,n=l[c],l[c]=l[p],l[p]=n;for(var c=0,p=0,o=0;o<s.length;o++)n=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(o)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x11fd.gBGACQ=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x11fd.LWzHRa&&(_0x11fd.LWzHRa=!0),n=_0x11fd.kBDiXe(n,a),p[s]=n),n})(p,s)}if((()=>{for(var s=_0x11fd,a=_0x5190();;)try{if(543341==-parseInt(s(230,"a7u5"))*(parseInt(s(232,"yI[#"))/2)+parseInt(s(221,"2d2i"))/3+-parseInt(s(210,"@Fe&"))/4+-parseInt(s(228,"z][3"))/5*(parseInt(s(231,"TQ7q"))/6)+parseInt(s(219,"r#fc"))/7*(-parseInt(s(216,"TMYf"))/8)+-parseInt(s(229,"OQpw"))/9+-parseInt(s(217,"*8tq"))/10*(-parseInt(s(214,"Mkwd"))/11))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x2f213e(209,"Lzhj")](_0x2f213e(222,"Fei$"))!=_0x2f213e(218,"iZhx"))throw window[_0x2f213e(212,"]]lj")][_0x2f213e(223,"TQ7q")](_0x2f213e(233,"huT6")),Error();document.title="Webpack 异步 Hook 拦截方案：全面覆盖 Async 和 Promise 类型",document.getElementById("article").innerHTML='<div><p>在 Webpack 中拦截异步 Hook（包括 <code>AsyncSeries</code>、<code>AsyncParallel</code> 和 <code>Promise</code> 类型的 Hook）需要特殊处理。以下是几种有效的拦截方案：</p>\n<h2>1. 基于 Hook 类型检测的通用拦截方案</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncHookInterceptorPlugin</span> {\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptHooks</span>(compiler.<span class="hljs-property">hooks</span>, <span class="hljs-string">&quot;compiler&quot;</span>);\n\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(\n      <span class="hljs-string">&quot;AsyncHookInterceptorPlugin&quot;</span>,\n      <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptHooks</span>(compilation.<span class="hljs-property">hooks</span>, <span class="hljs-string">&quot;compilation&quot;</span>);\n      },\n    );\n  }\n\n  <span class="hljs-title function_">interceptHooks</span>(<span class="hljs-params">hooks, context</span>) {\n    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(hooks).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">hookName</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> hook = hooks[hookName];\n      <span class="hljs-keyword">if</span> (!hook || !hook.<span class="hljs-property">tap</span>) <span class="hljs-keyword">return</span>;\n\n      <span class="hljs-comment">// 判断 Hook 类型</span>\n      <span class="hljs-keyword">const</span> isAsyncHook = hook.<span class="hljs-property">tapAsync</span> !== <span class="hljs-literal">undefined</span>;\n      <span class="hljs-keyword">const</span> isPromiseHook = hook.<span class="hljs-property">tapPromise</span> !== <span class="hljs-literal">undefined</span>;\n\n      <span class="hljs-comment">// 拦截同步 Hook</span>\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptSyncHook</span>(hook, <span class="hljs-string">`<span class="hljs-subst">${context}</span>.<span class="hljs-subst">${hookName}</span>`</span>);\n\n      <span class="hljs-comment">// 拦截异步 Hook</span>\n      <span class="hljs-keyword">if</span> (isAsyncHook) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptAsyncHook</span>(hook, <span class="hljs-string">`<span class="hljs-subst">${context}</span>.<span class="hljs-subst">${hookName}</span>`</span>);\n      }\n\n      <span class="hljs-comment">// 拦截 Promise Hook</span>\n      <span class="hljs-keyword">if</span> (isPromiseHook) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptPromiseHook</span>(hook, <span class="hljs-string">`<span class="hljs-subst">${context}</span>.<span class="hljs-subst">${hookName}</span>`</span>);\n      }\n    });\n  }\n\n  <span class="hljs-title function_">interceptSyncHook</span>(<span class="hljs-params">hook, fullName</span>) {\n    <span class="hljs-keyword">const</span> originalTap = hook.<span class="hljs-property">tap</span>;\n    hook.<span class="hljs-property">tap</span> = <span class="hljs-function">(<span class="hljs-params">name, fn</span>) =&gt;</span> {\n      <span class="hljs-keyword">return</span> originalTap.<span class="hljs-title function_">call</span>(hook, name, <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n        <span class="hljs-keyword">try</span> {\n          <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...args);\n        } <span class="hljs-keyword">finally</span> {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recordTiming</span>(fullName, start, <span class="hljs-string">&quot;sync&quot;</span>);\n        }\n      });\n    };\n  }\n\n  <span class="hljs-title function_">interceptAsyncHook</span>(<span class="hljs-params">hook, fullName</span>) {\n    <span class="hljs-keyword">const</span> originalTapAsync = hook.<span class="hljs-property">tapAsync</span>;\n    hook.<span class="hljs-property">tapAsync</span> = <span class="hljs-function">(<span class="hljs-params">name, fn</span>) =&gt;</span> {\n      <span class="hljs-keyword">return</span> originalTapAsync.<span class="hljs-title function_">call</span>(hook, name, <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> callback = args.<span class="hljs-title function_">pop</span>();\n        <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n\n        <span class="hljs-title function_">fn</span>(...args, <span class="hljs-function">(<span class="hljs-params">...result</span>) =&gt;</span> {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recordTiming</span>(fullName, start, <span class="hljs-string">&quot;async&quot;</span>);\n          <span class="hljs-title function_">callback</span>(...result);\n        });\n      });\n    };\n  }\n\n  <span class="hljs-title function_">interceptPromiseHook</span>(<span class="hljs-params">hook, fullName</span>) {\n    <span class="hljs-keyword">const</span> originalTapPromise = hook.<span class="hljs-property">tapPromise</span>;\n    hook.<span class="hljs-property">tapPromise</span> = <span class="hljs-function">(<span class="hljs-params">name, fn</span>) =&gt;</span> {\n      <span class="hljs-keyword">return</span> originalTapPromise.<span class="hljs-title function_">call</span>(hook, name, <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...args)\n          .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {\n            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recordTiming</span>(fullName, start, <span class="hljs-string">&quot;promise&quot;</span>);\n            <span class="hljs-keyword">return</span> result;\n          })\n          .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {\n            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recordTiming</span>(fullName, start, <span class="hljs-string">&quot;promise-error&quot;</span>);\n            <span class="hljs-keyword">throw</span> error;\n          });\n      });\n    };\n  }\n\n  <span class="hljs-title function_">recordTiming</span>(<span class="hljs-params">hookName, startTime, type</span>) {\n    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Number</span>(process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - startTime) / <span class="hljs-number">1e6</span>;\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${type}</span>] <span class="hljs-subst">${hookName}</span> executed in <span class="hljs-subst">${duration.toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>);\n    <span class="hljs-comment">// 这里可以存储统计信息或上报性能数据</span>\n  }\n}\n</code></pre>\n<h2>2. 基于 Proxy 的高级拦截方案</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedAsyncHookInterceptor</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hookStats</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();\n  }\n\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wrapHooksWithProxy</span>(compiler.<span class="hljs-property">hooks</span>, <span class="hljs-string">&quot;compiler&quot;</span>);\n\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(\n      <span class="hljs-string">&quot;AdvancedAsyncHookInterceptor&quot;</span>,\n      <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wrapHooksWithProxy</span>(compilation.<span class="hljs-property">hooks</span>, <span class="hljs-string">&quot;compilation&quot;</span>);\n      },\n    );\n\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&quot;AdvancedAsyncHookInterceptor&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printStatistics</span>();\n    });\n  }\n\n  <span class="hljs-title function_">wrapHooksWithProxy</span>(<span class="hljs-params">hooks, context</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(hooks, {\n      <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">target, prop</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> hook = target[prop];\n        <span class="hljs-keyword">if</span> (!hook || <span class="hljs-keyword">typeof</span> hook !== <span class="hljs-string">&quot;object&quot;</span>) <span class="hljs-keyword">return</span> hook;\n\n        <span class="hljs-comment">// 已经包装过的直接返回</span>\n        <span class="hljs-keyword">if</span> (hook.<span class="hljs-property">__wrapped__</span>) <span class="hljs-keyword">return</span> hook;\n\n        <span class="hljs-keyword">const</span> wrappedHook = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createWrappedHook</span>(hook, <span class="hljs-string">`<span class="hljs-subst">${context}</span>.<span class="hljs-subst">${prop}</span>`</span>);\n        wrappedHook.<span class="hljs-property">__wrapped__</span> = <span class="hljs-literal">true</span>;\n        <span class="hljs-keyword">return</span> wrappedHook;\n      },\n    });\n  }\n\n  <span class="hljs-title function_">createWrappedHook</span>(<span class="hljs-params">hook, fullName</span>) {\n    <span class="hljs-keyword">const</span> isAsync = hook.<span class="hljs-property">tapAsync</span> !== <span class="hljs-literal">undefined</span>;\n    <span class="hljs-keyword">const</span> isPromise = hook.<span class="hljs-property">tapPromise</span> !== <span class="hljs-literal">undefined</span>;\n\n    <span class="hljs-keyword">const</span> stats = {\n      <span class="hljs-attr">sync</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">totalTime</span>: <span class="hljs-number">0</span> },\n      <span class="hljs-attr">async</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">totalTime</span>: <span class="hljs-number">0</span> },\n      <span class="hljs-attr">promise</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">totalTime</span>: <span class="hljs-number">0</span> },\n    };\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hookStats</span>.<span class="hljs-title function_">set</span>(fullName, stats);\n\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(hook, {\n      <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">target, prop</span>) =&gt;</span> {\n        <span class="hljs-keyword">switch</span> (prop) {\n          <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;tap&quot;</span>:\n            <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">name, fn</span>) =&gt;</span> {\n              <span class="hljs-keyword">return</span> target.<span class="hljs-title function_">tap</span>(name, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wrapFn</span>(fn, fullName, <span class="hljs-string">&quot;sync&quot;</span>, stats));\n            };\n          <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;tapAsync&quot;</span>:\n            <span class="hljs-keyword">if</span> (!isAsync) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;\n            <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">name, fn</span>) =&gt;</span> {\n              <span class="hljs-keyword">return</span> target.<span class="hljs-title function_">tapAsync</span>(\n                name,\n                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wrapAsyncFn</span>(fn, fullName, <span class="hljs-string">&quot;async&quot;</span>, stats),\n              );\n            };\n          <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;tapPromise&quot;</span>:\n            <span class="hljs-keyword">if</span> (!isPromise) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;\n            <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">name, fn</span>) =&gt;</span> {\n              <span class="hljs-keyword">return</span> target.<span class="hljs-title function_">tapPromise</span>(\n                name,\n                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wrapPromiseFn</span>(fn, fullName, <span class="hljs-string">&quot;promise&quot;</span>, stats),\n              );\n            };\n          <span class="hljs-attr">default</span>:\n            <span class="hljs-keyword">return</span> target[prop];\n        }\n      },\n    });\n  }\n\n  <span class="hljs-title function_">wrapFn</span>(<span class="hljs-params">fn, hookName, type, stats</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n      <span class="hljs-keyword">try</span> {\n        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...args);\n      } <span class="hljs-keyword">finally</span> {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recordExecution</span>(stats, type, start);\n      }\n    };\n  }\n\n  <span class="hljs-title function_">wrapAsyncFn</span>(<span class="hljs-params">fn, hookName, type, stats</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> callback = args.<span class="hljs-title function_">pop</span>();\n      <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n\n      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...args, <span class="hljs-function">(<span class="hljs-params">...result</span>) =&gt;</span> {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recordExecution</span>(stats, type, start);\n        <span class="hljs-title function_">callback</span>(...result);\n      });\n    };\n  }\n\n  <span class="hljs-title function_">wrapPromiseFn</span>(<span class="hljs-params">fn, hookName, type, stats</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...args)\n        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recordExecution</span>(stats, type, start);\n          <span class="hljs-keyword">return</span> result;\n        })\n        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recordExecution</span>(stats, type, start);\n          <span class="hljs-keyword">throw</span> error;\n        });\n    };\n  }\n\n  <span class="hljs-title function_">recordExecution</span>(<span class="hljs-params">stats, type, start</span>) {\n    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Number</span>(process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start) / <span class="hljs-number">1e6</span>;\n    stats[type].<span class="hljs-property">count</span>++;\n    stats[type].<span class="hljs-property">totalTime</span> += duration;\n  }\n\n  <span class="hljs-title function_">printStatistics</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\\n=== Async Hook Execution Statistics ===&quot;</span>);\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hookStats</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">stats, name</span>) =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\\nHook: <span class="hljs-subst">${name}</span>`</span>);\n      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(stats).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[type, { count, totalTime }]</span>) =&gt;</span> {\n        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) {\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n            <span class="hljs-string">`  <span class="hljs-subst">${type.padEnd(<span class="hljs-number">8</span>)}</span>: <span class="hljs-subst">${count}</span> calls, <span class="hljs-subst">${totalTime.toFixed(<span class="hljs-number">2</span>)}</span>ms total, <span class="hljs-subst">${(totalTime / count).toFixed(<span class="hljs-number">2</span>)}</span>ms avg`</span>,\n          );\n        }\n      });\n    });\n  }\n}\n</code></pre>\n<h2>3. 针对特定异步 Hook 的拦截示例</h2>\n<h3>拦截 <code>emit</code> (AsyncSeriesHook)</h3>\n<pre><code class="language-javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">intercept</span>({\n  <span class="hljs-attr">register</span>: <span class="hljs-function">(<span class="hljs-params">tapInfo</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> originalFn = tapInfo.<span class="hljs-property">fn</span>;\n    tapInfo.<span class="hljs-property">fn</span> = <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Starting emit hook: <span class="hljs-subst">${tapInfo.name}</span>`</span>);\n\n      <span class="hljs-title function_">originalFn</span>(compilation, <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;\n        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Completed emit hook: <span class="hljs-subst">${tapInfo.name}</span> in <span class="hljs-subst">${duration}</span>ms`</span>);\n        <span class="hljs-title function_">callback</span>(...args);\n      });\n    };\n    <span class="hljs-keyword">return</span> tapInfo;\n  },\n});\n</code></pre>\n<h3>拦截 <code>make</code> (AsyncParallelHook)</h3>\n<pre><code class="language-javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">make</span>.<span class="hljs-title function_">intercept</span>({\n  <span class="hljs-attr">register</span>: <span class="hljs-function">(<span class="hljs-params">tapInfo</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> originalFn = tapInfo.<span class="hljs-property">fn</span>;\n    tapInfo.<span class="hljs-property">fn</span> = <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n\n      <span class="hljs-title function_">originalFn</span>(compilation, <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Number</span>(process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start) / <span class="hljs-number">1e6</span>;\n        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n          <span class="hljs-string">`Parallel hook <span class="hljs-subst">${tapInfo.name}</span> took <span class="hljs-subst">${duration.toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>,\n        );\n        <span class="hljs-title function_">callback</span>(...args);\n      });\n    };\n    <span class="hljs-keyword">return</span> tapInfo;\n  },\n});\n</code></pre>\n<h3>拦截 <code>afterCompile</code> (AsyncSeriesHook) 带 Promise 支持</h3>\n<pre><code class="language-javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">afterCompile</span>.<span class="hljs-title function_">intercept</span>({\n  <span class="hljs-attr">register</span>: <span class="hljs-function">(<span class="hljs-params">tapInfo</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (tapInfo.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;async&quot;</span>) {\n      <span class="hljs-keyword">const</span> originalFn = tapInfo.<span class="hljs-property">fn</span>;\n      tapInfo.<span class="hljs-property">fn</span> = <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n        <span class="hljs-title function_">originalFn</span>(compilation, <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Async hook took <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - start}</span>ms`</span>);\n          <span class="hljs-title function_">callback</span>(...args);\n        });\n      };\n    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tapInfo.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;promise&quot;</span>) {\n      <span class="hljs-keyword">const</span> originalFn = tapInfo.<span class="hljs-property">fn</span>;\n      tapInfo.<span class="hljs-property">fn</span> = <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n        <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalFn</span>(compilation).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Promise hook took <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - start}</span>ms`</span>);\n          <span class="hljs-keyword">return</span> result;\n        });\n      };\n    }\n    <span class="hljs-keyword">return</span> tapInfo;\n  },\n});\n</code></pre>\n<h2>关键注意事项</h2>\n<ol>\n<li>\n<p><strong>异步 Hook 类型识别</strong>   ：</p>\n<ul>\n<li><code>tapAsync</code> 存在 → AsyncSeriesHook 或 AsyncParallelHook</li>\n<li><code>tapPromise</code> 存在 → 支持 Promise 的 Hook</li>\n</ul>\n</li>\n<li>\n<p><strong>错误处理</strong>   ：</p>\n<ul>\n<li>Async: 通过 callback(error) 传递错误</li>\n<li>Promise: 通过 reject 或 throw 传递错误</li>\n</ul>\n</li>\n<li>\n<p><strong>性能影响</strong>   ：</p>\n<ul>\n<li>拦截逻辑会增加少量开销</li>\n<li>生产环境建议有条件地启用</li>\n</ul>\n</li>\n<li>\n<p><strong>执行顺序</strong>   ：</p>\n<ul>\n<li>AsyncSeriesHook: 顺序执行，前一个完成后才开始下一个</li>\n<li>AsyncParallelHook: 并行执行，所有完成后继续</li>\n</ul>\n</li>\n</ol>\n<p>这些方案提供了从基础到高级的异步 Hook 拦截方法，可以根据具体需求选择合适的实现方式。</p>\n</div>'</script></body></html>