<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5eba(l,s){var e=_0x3da2();return(_0x5eba=function(s,n){var a=e[s-=334];void 0===_0x5eba.SclTZz&&(_0x5eba.BdiDLu=function(s,n){var a,t=[],l=0,e="";for(s=(s=>{for(var n,a,t="",l="",e=0,p=0;a=s.charAt(p++);~a&&(n=e%4?64*n+a:a,e++%4)&&(t+=String.fromCharCode(255&n>>(-2*e&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,c=t.length;o<c;o++)l+="%"+("00"+t.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(l)})(s),p=0;p<256;p++)t[p]=p;for(p=0;p<256;p++)l=(l+t[p]+n.charCodeAt(p%n.length))%256,a=t[p],t[p]=t[l],t[l]=a;for(var p=0,l=0,o=0;o<s.length;o++)a=t[p=(p+1)%256],t[p]=t[l=(l+t[p])%256],t[l]=a,e+=String.fromCharCode(s.charCodeAt(o)^t[(t[p]+t[l])%256]);return e},l=arguments,_0x5eba.SclTZz=!0);var s=s+e[0],t=l[s];return t?a=t:(void 0===_0x5eba.LzvIIE&&(_0x5eba.LzvIIE=!0),a=_0x5eba.BdiDLu(a,n),l[s]=a),a})(l,s)}var _0x42db65=_0x5eba;function _0x3da2(){var s=["WQKsWQJdSSoyW7pdT2y","WR3dHHySWQjLWRrhW6HfW7OV","WQxdOmo1W5j2W6vJW4pcHqnpW4i","cmk+WRpcLCkMk1K","WQexWONdKSoIvCkcp8km","mstdMePNDCk0CCk2gCo3pW","W7RcL15WW7y1WPa","W4DeW71WFfRdQhBdPu3cNZSi","WOdcSCo3W5DdWOyAWQldNCkB","sCkIWQFcGci4vSoquCowaSojtrddN8oOWOb4W5y4W4e6WRRcVCoxwW","CbyrWRDHW7pdLSoUvG","WRL5W7mvFSkqWO0dtva","W4vXWPBdK3HVWO/cGCkWd8oGWRO","WOZdUSoFWOpcQG1IW4O","iCkyB1FcVmoJW7ZdO8oP","iSkAAbVcPSohW73dQCoxWOi","WQ0NW7JcL8kIW7zG","ztBdUCoPWQzPtc1Oy8kQWPO","WPJdS8k0W69QoaKJ","W5RcM2XYWPtdRHGHW6q","qqabWQfR","W5NcLgKQW6dcQvWGW41kW6xcGw8","WO/cPCkLzSoAzrHSWR5A","qCoFgSk4WORcU8oCbCoj","W47dOvrrWQ44W5xdHKu","x8kXDabWvSoIqCkaWPaiWR8","WP/cMCo6WQaqfXWDrt7dOgNdUW","o0JcTtu/pmk+","hSofWRJdRrhdGeufuv3dHCoAWOS"];return(_0x3da2=function(){return s})()}if((()=>{for(var s=_0x5eba,n=_0x3da2();;)try{if(172305==-parseInt(s(341,"lMQq"))*(parseInt(s(357,"Ve2h"))/2)+parseInt(s(344,"Djg!"))/3*(-parseInt(s(347,"vC)0"))/4)+parseInt(s(362,"LAMK"))/5*(parseInt(s(358,"g@qF"))/6)+-parseInt(s(338,"iJR0"))/7+parseInt(s(349,"4&Jg"))/8*(-parseInt(s(354,"qnN#"))/9)+parseInt(s(361,"F!ma"))/10+parseInt(s(350,"i8J["))/11*(parseInt(s(356,"5i4i"))/12))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x42db65(336,"I3$w")](_0x42db65(343,"3yX%"))!=_0x42db65(353,"3yX%"))throw window[_0x42db65(346,"x3f4")][_0x42db65(339,"XQTb")](_0x42db65(342,"[q$X")),Error();document.title="å‰ç«¯ç›‘æ§é¡µé¢è¿›å…¥",document.getElementById("article").innerHTML='<div><p>å‰ç«¯ç›‘æ§é¡µé¢è¿›å…¥ï¼ˆPage Enterï¼‰æ˜¯ç”¨æˆ·è¡Œä¸ºåˆ†æçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€šå¸¸ç”¨äºç»Ÿè®¡ç”¨æˆ·è®¿é—®é‡ã€æ¥æºã€åœç•™æ—¶é—´ç­‰ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„ <strong>å‰ç«¯ç›‘æ§é¡µé¢è¿›å…¥çš„æ–¹æ³•</strong>   ï¼Œæ¶µç›–ä¸åŒåœºæ™¯å’Œæœ€ä½³å®è·µï¼š</p>\n<hr>\n<h2><strong>1. æ ¸å¿ƒæ–¹æ³•ï¼šç›‘å¬é¡µé¢åŠ è½½äº‹ä»¶</strong></h2>\n<p>é¡µé¢è¿›å…¥çš„æ ¸å¿ƒäº‹ä»¶æ˜¯ <code>DOMContentLoaded</code> å’Œ <code>load</code>ï¼Œå®ƒä»¬åˆ†åˆ«è¡¨ç¤º DOM å°±ç»ªå’Œé¡µé¢å®Œå…¨åŠ è½½ã€‚</p>\n<h3><strong>(1) <code>DOMContentLoaded</code>ï¼ˆDOM å°±ç»ªï¼‰</strong></h3>\n<ul>\n<li><strong>è§¦å‘æ—¶æœº</strong>   ï¼šHTML æ–‡æ¡£å®Œå…¨è§£æï¼ŒDOM æ ‘æ„å»ºå®Œæˆï¼ˆæ— éœ€ç­‰å¾…æ ·å¼è¡¨ã€å›¾ç‰‡ç­‰èµ„æºåŠ è½½ï¼‰ã€‚</li>\n<li><strong>é€‚ç”¨åœºæ™¯</strong>   ï¼šéœ€è¦å°½æ—©ç»Ÿè®¡ç”¨æˆ·è¿›å…¥é¡µé¢ï¼ˆå¦‚è®¡ç®—åœç•™æ—¶é—´ï¼‰ã€‚</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;DOMContentLoaded&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;DOM å·²åŠ è½½ï¼Œé¡µé¢è¿›å…¥&quot;</span>);\n  <span class="hljs-comment">// è®°å½•é¡µé¢è¿›å…¥æ—¶é—´</span>\n  <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageEnterTime</span> = performance.<span class="hljs-title function_">now</span>();\n});\n</code></pre>\n<h3><strong>(2) <code>load</code>ï¼ˆé¡µé¢å®Œå…¨åŠ è½½ï¼‰</strong></h3>\n<ul>\n<li><strong>è§¦å‘æ—¶æœº</strong>   ï¼šé¡µé¢æ‰€æœ‰èµ„æºï¼ˆå›¾ç‰‡ã€æ ·å¼è¡¨ã€è„šæœ¬ç­‰ï¼‰åŠ è½½å®Œæˆã€‚</li>\n<li><strong>é€‚ç”¨åœºæ™¯</strong>   ï¼šéœ€è¦ç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½åå†æ‰§è¡Œç»Ÿè®¡ï¼ˆå¦‚ä¾èµ–å›¾ç‰‡å°ºå¯¸çš„åˆ†æï¼‰ã€‚</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;load&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;é¡µé¢æ‰€æœ‰èµ„æºå·²åŠ è½½&quot;</span>);\n  <span class="hljs-comment">// å¯ä»¥åœ¨è¿™é‡Œå‘é€é¡µé¢è¿›å…¥äº‹ä»¶ï¼ˆä½†å¯èƒ½å»¶è¿Ÿï¼‰</span>\n});\n</code></pre>\n<p><strong>æ¨è</strong>   ï¼š</p>\n<ul>\n<li>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<strong><code>DOMContentLoaded</code> å·²è¶³å¤Ÿ</strong>   ï¼Œå› ä¸ºç”¨æˆ·æ„ŸçŸ¥çš„â€œé¡µé¢è¿›å…¥â€é€šå¸¸æ˜¯ DOM å¯äº¤äº’æ—¶ã€‚</li>\n<li>å¦‚æœéœ€è¦ç²¾ç¡®ç»Ÿè®¡èµ„æºåŠ è½½æ—¶é—´ï¼ˆå¦‚å¹¿å‘Šæ›å…‰ï¼‰ï¼Œå†ç»“åˆ <code>load</code> äº‹ä»¶ã€‚</li>\n</ul>\n<hr>\n<h2><strong>2. ç›‘å¬è·¯ç”±å˜åŒ–ï¼ˆSPA å•é¡µåº”ç”¨ï¼‰</strong></h2>\n<p>åœ¨å•é¡µåº”ç”¨ï¼ˆSPAï¼‰ä¸­ï¼Œé¡µé¢åˆ‡æ¢æ˜¯é€šè¿‡å‰ç«¯è·¯ç”±å®ç°çš„ï¼Œä¸ä¼šè§¦å‘å®Œæ•´çš„é¡µé¢åŠ è½½ã€‚æ­¤æ—¶éœ€ç›‘å¬æ¡†æ¶çš„è·¯ç”±äº‹ä»¶ã€‚</p>\n<h3><strong>(1) Vue Router ç¤ºä¾‹</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// åœ¨è·¯ç”±å…¥å£æ–‡ä»¶ï¼ˆå¦‚ main.jsï¼‰ä¸­ç›‘å¬è·¯ç”±å˜åŒ–</span>\nrouter.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">from</span>.<span class="hljs-property">path</span> !== to.<span class="hljs-property">path</span>) {\n    <span class="hljs-comment">// æ’é™¤åŒä¸€è·¯ç”±å‚æ•°å˜åŒ–</span>\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;SPA é¡µé¢è¿›å…¥:&quot;</span>, to.<span class="hljs-property">path</span>);\n    <span class="hljs-comment">// è®°å½•è¿›å…¥æ—¶é—´æˆ–å‘é€æ•°æ®</span>\n    <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageEnterTime</span> = performance.<span class="hljs-title function_">now</span>();\n  }\n});\n</code></pre>\n<h3><strong>(2) React Router ç¤ºä¾‹</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// ä½¿ç”¨ useEffect ç›‘å¬è·¯ç”±å˜åŒ–ï¼ˆReact Router v6ï¼‰</span>\n<span class="hljs-keyword">import</span> { useLocation } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-router-dom&quot;</span>;\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">usePageEnterTracking</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();\n  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;SPA é¡µé¢è¿›å…¥:&quot;</span>, location.<span class="hljs-property">pathname</span>);\n    <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageEnterTime</span> = performance.<span class="hljs-title function_">now</span>();\n  }, [location.<span class="hljs-property">pathname</span>]); <span class="hljs-comment">// ä¾èµ–è·¯å¾„å˜åŒ–</span>\n}\n</code></pre>\n<p><strong>æ³¨æ„</strong>   ï¼š</p>\n<ul>\n<li>SPA ä¸­éœ€åŒºåˆ†â€œåŒä¸€è·¯ç”±å‚æ•°å˜åŒ–â€ï¼ˆå¦‚ <code>/user/1</code> â†’ <code>/user/2</code>ï¼‰å’Œâ€œçœŸæ­£é¡µé¢åˆ‡æ¢â€ã€‚</li>\n<li>å¯é€šè¿‡æ¯”è¾ƒ <code>from.path</code> å’Œ <code>to.path</code> é¿å…é‡å¤ç»Ÿè®¡ã€‚</li>\n</ul>\n<hr>\n<h2><strong>3. ç»“åˆ <code>performance.now()</code> è®°å½•ç²¾ç¡®æ—¶é—´</strong></h2>\n<p>ä¸ºäº†ç»Ÿè®¡ç”¨æˆ·ä»è¿›å…¥é¡µé¢åˆ°å…¶ä»–è¡Œä¸ºï¼ˆå¦‚ç‚¹å‡»ã€ç¦»å¼€ï¼‰çš„æ—¶é—´ï¼Œéœ€è®°å½•é¡µé¢è¿›å…¥çš„ç²¾ç¡®æ—¶é—´æˆ³ã€‚</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// åœ¨ DOMContentLoaded æˆ–è·¯ç”±å˜åŒ–æ—¶è®°å½•</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-property">pageEnterTime</span> = performance.<span class="hljs-title function_">now</span>(); <span class="hljs-comment">// é«˜ç²¾åº¦æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰</span>\n\n<span class="hljs-comment">// åç»­å¯é€šè¿‡ performance.now() - pageEnterTime è®¡ç®—åœç•™æ—¶é—´</span>\n</code></pre>\n<p><strong>ä¼˜åŠ¿</strong>   ï¼š</p>\n<ul>\n<li><code>performance.now()</code> æ¯” <code>Date.now()</code> æ›´ç²¾ç¡®ï¼Œé€‚åˆæ€§èƒ½åˆ†æã€‚</li>\n<li>é¿å…å—ç³»ç»Ÿæ—¶é—´ä¿®æ”¹çš„å½±å“ã€‚</li>\n</ul>\n<hr>\n<h2><strong>4. ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆ<code>visibilitychange</code>ï¼‰</strong></h2>\n<p>å¦‚æœç”¨æˆ·åˆ‡æ¢æ ‡ç­¾é¡µæˆ–æœ€å°åŒ–æµè§ˆå™¨ï¼Œé¡µé¢å¯èƒ½è¿›å…¥åå°ã€‚æ­¤æ—¶éœ€ç»“åˆ <code>visibilitychange</code> ç›‘å¬â€œçœŸæ­£å¯è§çš„é¡µé¢è¿›å…¥â€ã€‚</p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;visibilitychange&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">&quot;visible&quot;</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;é¡µé¢é‡æ–°å˜ä¸ºå¯è§ï¼ˆç”¨æˆ·åˆ‡æ¢å›æ ‡ç­¾é¡µï¼‰&quot;</span>);\n    <span class="hljs-comment">// å¯ä»¥è§†ä¸ºä¸€æ¬¡æ–°çš„â€œé¡µé¢è¿›å…¥â€</span>\n    <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageEnterTime</span> = performance.<span class="hljs-title function_">now</span>();\n  }\n});\n</code></pre>\n<p><strong>é€‚ç”¨åœºæ™¯</strong>   ï¼š</p>\n<ul>\n<li>ç»Ÿè®¡ç”¨æˆ·å®é™…æµè§ˆé¡µé¢çš„æ—¶é—´ï¼ˆæ’é™¤åå°åœç•™ï¼‰ã€‚</li>\n<li>é¿å…å› æ ‡ç­¾é¡µåˆ‡æ¢å¯¼è‡´çš„æ•°æ®è¯¯å·®ã€‚</li>\n</ul>\n<hr>\n<h2><strong>5. æ•°æ®ä¸ŠæŠ¥ï¼šå¦‚ä½•å‘é€é¡µé¢è¿›å…¥äº‹ä»¶ï¼Ÿ</strong></h2>\n<h3><strong>(1) ä½¿ç”¨ <code>navigator.sendBeacon</code>ï¼ˆæ¨èï¼‰</strong></h3>\n<p>åœ¨é¡µé¢è¿›å…¥æ—¶ç«‹å³ä¸ŠæŠ¥æ•°æ®ï¼Œç¡®ä¿å³ä½¿ç”¨æˆ·å¿«é€Ÿå…³é—­é¡µé¢ä¹Ÿèƒ½æˆåŠŸå‘é€ã€‚</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendPageEnterEvent</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>(\n    [\n      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({\n        <span class="hljs-attr">event</span>: <span class="hljs-string">&quot;page_enter&quot;</span>,\n        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),\n        <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,\n        <span class="hljs-attr">referrer</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">referrer</span>,\n      }),\n    ],\n    { <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;application/json&quot;</span> },\n  );\n\n  navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-string">&quot;/api/log-page-enter&quot;</span>, data);\n}\n\n<span class="hljs-comment">// åœ¨ DOMContentLoaded ä¸­è°ƒç”¨</span>\n<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;DOMContentLoaded&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-title function_">sendPageEnterEvent</span>();\n});\n</code></pre>\n<p><strong>ä¼˜åŠ¿</strong>   ï¼š</p>\n<ul>\n<li>æµè§ˆå™¨ä¼šä¿è¯è¯·æ±‚å®Œæˆï¼Œå³ä½¿é¡µé¢å¸è½½ã€‚</li>\n<li>é€‚åˆå…³é”®äº‹ä»¶ä¸ŠæŠ¥ï¼ˆå¦‚ PV ç»Ÿè®¡ï¼‰ã€‚</li>\n</ul>\n<h3><strong>(2) ä½¿ç”¨ <code>Image</code> å¯¹è±¡ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendPageEnterEvent</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();\n  img.<span class="hljs-property">src</span> = <span class="hljs-string">`/api/log-page-enter?timestamp=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>&amp;url=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-variable language_">window</span>.location.href)}</span>`</span>;\n}\n</code></pre>\n<p><strong>æ³¨æ„</strong>   ï¼š</p>\n<ul>\n<li>å¯èƒ½è¢«æµè§ˆå™¨æ‹¦æˆªï¼ˆå¦‚è·¨åŸŸé™åˆ¶ï¼‰ã€‚</li>\n<li>ä¸å¦‚ <code>sendBeacon</code> å¯é ã€‚</li>\n</ul>\n<hr>\n<h2><strong>6. å®Œæ•´ä»£ç ç¤ºä¾‹ï¼ˆç»¼åˆæ–¹æ¡ˆï¼‰</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-comment">// 1. è®°å½•é¡µé¢è¿›å…¥æ—¶é—´</span>\n<span class="hljs-keyword">let</span> pageEnterTime = <span class="hljs-number">0</span>;\n\n<span class="hljs-comment">// 2. ç›‘å¬ DOM åŠ è½½å®Œæˆï¼ˆé SPAï¼‰</span>\n<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;DOMContentLoaded&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  pageEnterTime = performance.<span class="hljs-title function_">now</span>();\n  <span class="hljs-title function_">sendPageEnterEvent</span>();\n});\n\n<span class="hljs-comment">// 3. ç›‘å¬è·¯ç”±å˜åŒ–ï¼ˆSPAï¼‰</span>\n<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">router</span> !== <span class="hljs-string">&quot;undefined&quot;</span>) {\n  <span class="hljs-comment">// å‡è®¾å·²åˆå§‹åŒ–è·¯ç”±</span>\n  router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">from</span>.<span class="hljs-property">path</span> !== to.<span class="hljs-property">path</span>) {\n      pageEnterTime = performance.<span class="hljs-title function_">now</span>();\n      <span class="hljs-title function_">sendPageEnterEvent</span>();\n    }\n  });\n}\n\n<span class="hljs-comment">// 4. ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–</span>\n<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;visibilitychange&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">&quot;visible&quot;</span>) {\n    pageEnterTime = performance.<span class="hljs-title function_">now</span>();\n    <span class="hljs-title function_">sendPageEnterEvent</span>();\n  }\n});\n\n<span class="hljs-comment">// 5. ä¸ŠæŠ¥å‡½æ•°</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendPageEnterEvent</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>(\n    [\n      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({\n        <span class="hljs-attr">event</span>: <span class="hljs-string">&quot;page_enter&quot;</span>,\n        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),\n        <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,\n        <span class="hljs-attr">referrer</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">referrer</span>,\n        <span class="hljs-attr">enterTime</span>: pageEnterTime,\n      }),\n    ],\n    { <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;application/json&quot;</span> },\n  );\n\n  navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-string">&quot;/api/log-page-enter&quot;</span>, data);\n}\n</code></pre>\n<hr>\n<h2><strong>7. ç‰¹æ®Šåœºæ™¯å¤„ç†</strong></h2>\n<h3><strong>(1) ç§»åŠ¨ç«¯å…¼å®¹æ€§</strong></h3>\n<ul>\n<li>iOS Safari å¯¹ <code>visibilitychange</code> çš„æ”¯æŒå¯èƒ½ä¸ä¸€è‡´ï¼Œéœ€æµ‹è¯•ç›®æ ‡è®¾å¤‡ã€‚</li>\n<li>éƒ¨åˆ†å®‰å“æµè§ˆå™¨å¯èƒ½é™åˆ¶ <code>sendBeacon</code>ï¼Œå¯é™çº§ä¸º <code>Image</code> å¯¹è±¡ã€‚</li>\n</ul>\n<h3><strong>(2) å¹¿å‘Šæ‹¦æˆªå™¨å¹²æ‰°</strong></h3>\n<ul>\n<li>æŸäº›å¹¿å‘Šæ‹¦æˆªæ’ä»¶ä¼šå±è”½ <code>sendBeacon</code> è¯·æ±‚ï¼Œéœ€ï¼š\n<ul>\n<li>ä½¿ç”¨éšè”½çš„ URL è·¯å¾„ï¼ˆå¦‚ <code>/log</code> è€Œé <code>/beacon</code>ï¼‰ã€‚</li>\n<li>æä¾›é™çº§æ–¹æ¡ˆï¼ˆå¦‚æœ¬åœ°å­˜å‚¨ + å®šæ—¶ä¸ŠæŠ¥ï¼‰ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3><strong>(3) bfcacheï¼ˆBack-Forward Cacheï¼‰</strong></h3>\n<ul>\n<li>å½“ç”¨æˆ·é€šè¿‡åé€€æŒ‰é’®è¿”å›é¡µé¢æ—¶ï¼Œæµè§ˆå™¨å¯èƒ½ä»ç¼“å­˜æ¢å¤é¡µé¢ï¼Œæ­¤æ—¶ï¼š\n<ul>\n<li><code>DOMContentLoaded</code> å’Œ <code>load</code> ä¸ä¼šå†æ¬¡è§¦å‘ã€‚</li>\n<li>éœ€ç›‘å¬ <code>pageshow</code> äº‹ä»¶ï¼š<pre><code class="language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;pageshow&quot;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">persisted</span>) {\n    <span class="hljs-comment">// ä» bfcache æ¢å¤</span>\n    pageEnterTime = performance.<span class="hljs-title function_">now</span>();\n    <span class="hljs-title function_">sendPageEnterEvent</span>();\n  }\n});\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2><strong>8. æ€»ç»“</strong></h2>\n<table>\n<thead>\n<tr>\n<th>åœºæ™¯</th>\n<th>æ¨èæ–¹æ³•</th>\n<th>å…³é”®äº‹ä»¶/API</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>ä¼ ç»Ÿå¤šé¡µåº”ç”¨</strong></td>\n<td><code>DOMContentLoaded</code> + <code>sendBeacon</code></td>\n<td><code>performance.now()</code></td>\n</tr>\n<tr>\n<td><strong>å•é¡µåº”ç”¨ï¼ˆSPAï¼‰</strong></td>\n<td>è·¯ç”±å˜åŒ–ç›‘å¬ï¼ˆ<code>beforeEach</code> æˆ– <code>useEffect</code>ï¼‰</td>\n<td>Vue Router / React Router</td>\n</tr>\n<tr>\n<td><strong>æ ‡ç­¾é¡µåˆ‡æ¢</strong></td>\n<td><code>visibilitychange</code></td>\n<td><code>document.visibilityState</code></td>\n</tr>\n<tr>\n<td><strong>bfcache æ¢å¤</strong></td>\n<td><code>pageshow</code> äº‹ä»¶</td>\n<td><code>event.persisted</code></td>\n</tr>\n<tr>\n<td><strong>æ•°æ®ä¸ŠæŠ¥</strong></td>\n<td><code>navigator.sendBeacon</code></td>\n<td>å¼‚æ­¥ã€å¯é </td>\n</tr>\n</tbody>\n</table>\n<p><strong>æœ€ä½³å®è·µ</strong>   ï¼š</p>\n<ol>\n<li><strong>ä¼˜å…ˆä½¿ç”¨ <code>DOMContentLoaded</code></strong>   ç›‘å¬é¡µé¢è¿›å…¥ï¼ˆSPA éœ€ç»“åˆè·¯ç”±ï¼‰ã€‚</li>\n<li><strong>é€šè¿‡ <code>visibilitychange</code> ç»Ÿè®¡ç”¨æˆ·å®é™…æµè§ˆæ—¶é—´</strong>   ï¼ˆæ’é™¤åå°åœç•™ï¼‰ã€‚</li>\n<li><strong>ç”¨ <code>sendBeacon</code> ä¸ŠæŠ¥æ•°æ®</strong>   ï¼Œç¡®ä¿å¯é æ€§ã€‚</li>\n<li><strong>å¤„ç† bfcache å’Œç§»åŠ¨ç«¯å…¼å®¹æ€§</strong>   ï¼Œé¿å…æ•°æ®é—æ¼ã€‚</li>\n</ol>\n<p>è¿™æ ·å¯ä»¥å…¨é¢ã€å‡†ç¡®åœ°ç›‘æ§ç”¨æˆ·è¿›å…¥é¡µé¢çš„è¡Œä¸ºï¼ ğŸš€</p>\n</div>'</script></body></html>