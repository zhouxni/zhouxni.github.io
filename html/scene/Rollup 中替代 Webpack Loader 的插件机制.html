<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x3890(p,s){var t=_0x2b96();return(_0x3890=function(s,n){var a=t[s-=437];void 0===_0x3890.YsLgyF&&(_0x3890.VmNcUp=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var r=0,c=l.length;r<c;r++)p+="%"+("00"+l.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,r=0;r<s.length;r++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(r)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x3890.YsLgyF=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x3890.rFOTqq&&(_0x3890.rFOTqq=!0),a=_0x3890.VmNcUp(a,n),p[s]=a),a})(p,s)}var _0x232f3d=_0x3890;function _0x2b96(){var s=["uKxcISo/hJmEWRZcUmkLWP5ioW","W5eZWO/cPCkcWP3cLreL","uSoRWQVdVmo0u8kAzCoSjHJcU8kL","WQjEE0/cPsldUG","WPCDkmklW7lcHSkk","cWtdH8k+xdabW4dcG8kjWOjilsWQc3GrDSkjW6/dOeZcHa/cRa","WPtcQ8kqW5hdTW","BmoCaaVdU8o1pG","smkzW5RdOWHgW51fraHEjg8","ECkXWPBdQmoxl8kYW4ZcL8opoa","z1tdT8oEW7ldVmkZb8obFCkrt20","WQjPW5RcRmkAWR/cNtiq","W7RcHSkBBxKRnW","WPjuESkuW5xcU8kMW6DD","CwddQmo8W5OdFcy","oWekhKhcGmkIq1GUB8ozlq","WONcLSopwCo9x8kUE8o+W6e5WOK","E8k6WPhdQmkbi8kpW6NcICoq","W6/dNcNdNZ/cJ8oaf8kAW5K","l8kjfJddRmoWoCk7","i8oTW4tcSmkxh8k5W6q","CwxcT8kAWP1ClHD4qCkXWOVcVa","c8kWWPbWaCkeW48","bbxdH8khw29d","WPrBEmomWOFdMSkiW6XOC8kOWRq","WPvCE8ooWOFdMCktW49byCkSWQa","WQeykWJdKh7dUfLvWRzTcW","W63dLY7dN2NcG8o9mSkeW4BcKq"];return(_0x2b96=function(){return s})()}if((()=>{for(var s=_0x3890,n=_0x2b96();;)try{if(190962==+parseInt(s(450,"8qHr"))*(-parseInt(s(455,"xo3x"))/2)+parseInt(s(458,"8qHr"))/3*(-parseInt(s(454,"nKiA"))/4)+-parseInt(s(439,"0uHf"))/5+parseInt(s(451,"R)e*"))/6+parseInt(s(445,"nKiA"))/7*(parseInt(s(449,"YGht"))/8)+-parseInt(s(453,"Ir2$"))/9*(-parseInt(s(462,"xo3x"))/10)+-parseInt(s(457,"9Sc0"))/11)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x232f3d(464,"$qeW")](_0x232f3d(452,"mlYw"))!=_0x232f3d(447,"@u%$"))throw window[_0x232f3d(461,"8qHr")][_0x232f3d(448,"pioA")](_0x232f3d(446,"$qeW")),Error();document.title="Rollup 中替代 Webpack Loader 的插件机制",document.getElementById("article").innerHTML='<div><p>Rollup 使用插件系统来处理资源文件，这与 Webpack 的 loader 系统有显著不同。以下是 Rollup 中如何用插件实现类似 Webpack loader 功能的详细解析：</p>\n<h2>一、核心差异对比</h2>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>Webpack Loader</th>\n<th>Rollup Plugin</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>执行时机</strong></td>\n<td>模块加载阶段</td>\n<td>构建过程的不同钩子</td>\n</tr>\n<tr>\n<td><strong>处理方式</strong></td>\n<td>链式管道处理</td>\n<td>基于钩子的离散处理</td>\n</tr>\n<tr>\n<td><strong>输入输出</strong></td>\n<td>显式转换文件内容</td>\n<td>通过插件钩子操作虚拟模块</td>\n</tr>\n<tr>\n<td><strong>典型用途</strong></td>\n<td>文件内容转换</td>\n<td>资源加载、代码转换、打包优化</td>\n</tr>\n</tbody>\n</table>\n<h2>二、Rollup 插件核心钩子实现资源处理</h2>\n<h3>1. <code>resolveId</code> + <code>load</code> 组合（替代基础 loader）</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// rollup.config.js</span>\n<span class="hljs-keyword">import</span> { createFilter } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@rollup/pluginutils&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [\n    {\n      <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;custom-file-loader&quot;</span>,\n      <span class="hljs-title function_">resolveId</span>(<span class="hljs-params">source, importer</span>) {\n        <span class="hljs-keyword">if</span> (source.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;.custom&quot;</span>)) {\n          <span class="hljs-keyword">return</span> {\n            <span class="hljs-attr">id</span>: path.<span class="hljs-title function_">resolve</span>(path.<span class="hljs-title function_">dirname</span>(importer), source),\n            <span class="hljs-attr">external</span>: <span class="hljs-literal">false</span>,\n          };\n        }\n        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 其他情况继续正常解析</span>\n      },\n      <span class="hljs-title function_">load</span>(<span class="hljs-params">id</span>) {\n        <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;.custom&quot;</span>)) {\n          <span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(id, <span class="hljs-string">&quot;utf-8&quot;</span>);\n          <span class="hljs-keyword">return</span> <span class="hljs-string">`export default <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(transformContent(content))}</span>`</span>;\n        }\n        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n      },\n    },\n  ],\n};\n</code></pre>\n<h3>2. <code>transform</code> 钩子（替代内容转换 loader）</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [\n    {\n      <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;typescript-transformer&quot;</span>,\n      <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {\n        <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;.ts&quot;</span>)) {\n          <span class="hljs-keyword">return</span> {\n            <span class="hljs-attr">code</span>: <span class="hljs-title function_">transpileTypeScript</span>(code),\n            <span class="hljs-attr">map</span>: <span class="hljs-title function_">generateSourceMap</span>(),\n          };\n        }\n      },\n    },\n  ],\n};\n</code></pre>\n<h2>三、常用 Rollup 插件与 Webpack Loader 对比</h2>\n<h3>1. 文件资源处理</h3>\n<p><strong>Webpack</strong>   :</p>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\\.(png|jpg)$/</span>,\n  <span class="hljs-attr">use</span>: [<span class="hljs-string">&#x27;file-loader&#x27;</span>]\n}\n</code></pre>\n<p><strong>Rollup</strong>   :</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> image <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@rollup/plugin-image&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-title function_">image</span>(), <span class="hljs-comment">// 将图片转换为base64或发射文件</span>\n  ],\n};\n</code></pre>\n<h3>2. CSS 处理</h3>\n<p><strong>Webpack</strong>   :</p>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\\.css$/</span>,\n  <span class="hljs-attr">use</span>: [<span class="hljs-string">&#x27;style-loader&#x27;</span>, <span class="hljs-string">&#x27;css-loader&#x27;</span>]\n}\n</code></pre>\n<p><strong>Rollup</strong>   :</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> postcss <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;rollup-plugin-postcss&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-title function_">postcss</span>({\n      <span class="hljs-attr">extract</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 提取为单独文件</span>\n      <span class="hljs-attr">inject</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 不注入到JS中</span>\n    }),\n  ],\n};\n</code></pre>\n<h3>3. Babel 转换</h3>\n<p><strong>Webpack</strong>   :</p>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\\.js$/</span>,\n  <span class="hljs-attr">use</span>: [<span class="hljs-string">&#x27;babel-loader&#x27;</span>]\n}\n</code></pre>\n<p><strong>Rollup</strong>   :</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> babel <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@rollup/plugin-babel&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">babel</span>({ <span class="hljs-attr">babelHelpers</span>: <span class="hljs-string">&quot;bundled&quot;</span> })],\n};\n</code></pre>\n<h2>四、实现自定义资源处理器（高级示例）</h2>\n<h3>1. Markdown 文件处理器</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> marked <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;marked&quot;</span>;\n<span class="hljs-keyword">import</span> { createFilter } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@rollup/pluginutils&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">markdownPlugin</span>(<span class="hljs-params">options = {}</span>) {\n  <span class="hljs-keyword">const</span> filter = <span class="hljs-title function_">createFilter</span>(options.<span class="hljs-property">include</span>, options.<span class="hljs-property">exclude</span>);\n\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;markdown-loader&quot;</span>,\n    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {\n      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">filter</span>(id) || !id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;.md&quot;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n\n      <span class="hljs-keyword">const</span> html = <span class="hljs-title function_">marked</span>(code);\n      <span class="hljs-keyword">return</span> {\n        <span class="hljs-attr">code</span>: <span class="hljs-string">`export default <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(html)}</span>`</span>,\n        <span class="hljs-attr">map</span>: { <span class="hljs-attr">mappings</span>: <span class="hljs-string">&quot;&quot;</span> },\n      };\n    },\n  };\n}\n</code></pre>\n<h3>2. 二进制文件处理器</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { createFilter } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@rollup/pluginutils&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">binaryPlugin</span>(<span class="hljs-params">options = {}</span>) {\n  <span class="hljs-keyword">const</span> filter = <span class="hljs-title function_">createFilter</span>(options.<span class="hljs-property">include</span>, options.<span class="hljs-property">exclude</span>);\n\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;binary-loader&quot;</span>,\n    <span class="hljs-title function_">load</span>(<span class="hljs-params">id</span>) {\n      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">filter</span>(id)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n\n      <span class="hljs-keyword">const</span> buffer = fs.<span class="hljs-title function_">readFileSync</span>(id);\n      <span class="hljs-keyword">return</span> {\n        <span class="hljs-attr">code</span>: <span class="hljs-string">`export default new Uint8Array(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(buffer))}</span>)`</span>,\n        <span class="hljs-attr">map</span>: <span class="hljs-literal">null</span>,\n      };\n    },\n  };\n}\n</code></pre>\n<h2>五、组合多个处理阶段（模拟 loader 链）</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [\n    {\n      <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;multi-stage-processor&quot;</span>,\n      <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {\n        <span class="hljs-keyword">if</span> (!id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;.custom&quot;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n\n        <span class="hljs-comment">// 第一阶段：预处理</span>\n        <span class="hljs-keyword">let</span> result = <span class="hljs-title function_">preprocess</span>(code);\n\n        <span class="hljs-comment">// 第二阶段：主转换</span>\n        result = <span class="hljs-title function_">mainTransform</span>(result);\n\n        <span class="hljs-comment">// 第三阶段：后处理</span>\n        result = <span class="hljs-title function_">postprocess</span>(result);\n\n        <span class="hljs-keyword">return</span> {\n          <span class="hljs-attr">code</span>: <span class="hljs-string">`export default <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>,\n          <span class="hljs-attr">map</span>: <span class="hljs-literal">null</span>,\n        };\n      },\n    },\n  ],\n};\n</code></pre>\n<h2>六、处理资源依赖关系</h2>\n<h3>1. 声明依赖文件变化</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [\n    {\n      <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;dependency-tracker&quot;</span>,\n      <span class="hljs-title function_">load</span>(<span class="hljs-params">id</span>) {\n        <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;.css&quot;</span>)) {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addWatchFile</span>(id); <span class="hljs-comment">// 监听文件变化</span>\n          <span class="hljs-keyword">const</span> deps = <span class="hljs-title function_">findDependencies</span>(id); <span class="hljs-comment">// 自定义依赖查找逻辑</span>\n          deps.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">dep</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addWatchFile</span>(dep));\n        }\n      },\n    },\n  ],\n};\n</code></pre>\n<h3>2. 虚拟模块处理</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [\n    {\n      <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;virtual-module&quot;</span>,\n      <span class="hljs-title function_">resolveId</span>(<span class="hljs-params">source</span>) {\n        <span class="hljs-keyword">if</span> (source === <span class="hljs-string">&quot;virtual-module&quot;</span>) {\n          <span class="hljs-keyword">return</span> source; <span class="hljs-comment">// 表示由本插件处理</span>\n        }\n        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n      },\n      <span class="hljs-title function_">load</span>(<span class="hljs-params">id</span>) {\n        <span class="hljs-keyword">if</span> (id === <span class="hljs-string">&quot;virtual-module&quot;</span>) {\n          <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;export const message = &quot;来自虚拟模块&quot;&#x27;</span>;\n        }\n      },\n    },\n  ],\n};\n</code></pre>\n<h2>七、Rollup 插件生态推荐</h2>\n<ol>\n<li>\n<p><strong>官方插件</strong>   ：</p>\n<ul>\n<li><code>@rollup/plugin-node-resolve</code>：解析 node_modules 中的模块</li>\n<li><code>@rollup/plugin-commonjs</code>：将 CommonJS 转换为 ES6</li>\n<li><code>@rollup/plugin-json</code>：处理 JSON 文件</li>\n</ul>\n</li>\n<li>\n<p><strong>社区插件</strong>   ：</p>\n<ul>\n<li><code>rollup-plugin-postcss</code>：处理 CSS/Sass/Less</li>\n<li><code>rollup-plugin-terser</code>：代码压缩</li>\n<li><code>rollup-plugin-visualizer</code>：打包分析</li>\n<li><code>rollup-plugin-typescript2</code>：TypeScript 支持</li>\n</ul>\n</li>\n<li>\n<p><strong>高级工具</strong>   ：</p>\n<ul>\n<li><code>rollup-plugin-hook</code>：更细粒度的钩子控制</li>\n<li><code>rollup-plugin-virtual</code>：虚拟模块生成</li>\n<li><code>rollup-plugin-replace</code>：内容替换</li>\n</ul>\n</li>\n</ol>\n<p>Rollup 的插件系统通过精细的钩子设计，提供了比 Webpack loader 更灵活的构建流程控制能力，虽然概念上有所不同，但能实现同等甚至更强大的资源处理功能。</p>\n</div>'</script></body></html>