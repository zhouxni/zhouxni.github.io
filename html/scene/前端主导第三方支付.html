<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x4e8e4e=_0x5898;function _0x5898(e,n){var l=_0x5009();return(_0x5898=function(n,s){var t=l[n-=261];void 0===_0x5898.JtWKKm&&(_0x5898.vBcbmW=function(n,s){var t,a=[],e=0,l="";for(n=(n=>{for(var s,t,a="",e="",l=0,o=0;t=n.charAt(o++);~t&&(s=l%4?64*s+t:t,l++%4)&&(a+=String.fromCharCode(255&s>>(-2*l&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var r=0,d=a.length;r<d;r++)e+="%"+("00"+a.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(e)})(n),o=0;o<256;o++)a[o]=o;for(o=0;o<256;o++)e=(e+a[o]+s.charCodeAt(o%s.length))%256,t=a[o],a[o]=a[e],a[e]=t;for(var o=0,e=0,r=0;r<n.length;r++)t=a[o=(o+1)%256],a[o]=a[e=(e+a[o])%256],a[e]=t,l+=String.fromCharCode(n.charCodeAt(r)^a[(a[o]+a[e])%256]);return l},e=arguments,_0x5898.JtWKKm=!0);var n=n+l[0],a=e[n];return a?t=a:(void 0===_0x5898.fdNbwJ&&(_0x5898.fdNbwJ=!0),t=_0x5898.vBcbmW(t,s),e[n]=t),t})(e,n)}if((()=>{for(var n=_0x5898,s=_0x5009();;)try{if(531281==-parseInt(n(270,"040#"))+-parseInt(n(271,"pFJ*"))/2+parseInt(n(263,"#erC"))/3+-parseInt(n(262,"P]O@"))/4+-parseInt(n(267,"a(D4"))/5+parseInt(n(281,"7vay"))/6*(-parseInt(n(278,"mACo"))/7)+parseInt(n(266,"OsV5"))/8)break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x4e8e4e(268,"yljt")](_0x4e8e4e(282,"040#"))!=_0x4e8e4e(274,"OsV5"))throw window[_0x4e8e4e(277,"36K[")][_0x4e8e4e(275,"yljt")](_0x4e8e4e(276,"DmNu")),Error();function _0x5009(){var n=["WRDMfb/dV8kjjSoeW5XAWQ0xwW","WRrRgrZdUCkpimkbW7zmWRK6tqq","WQlcN8oGuCoJWPNcV2BcGCkgkYdcVW","WQtcMSkpW7D3W5ZdOG","rMq3rb7cQ0pdKSo5v8oDW4pdTG","ySoiBCkxDLJdKCokcsKwBmka","EZldGmoBWQJcIL7dVgPskKpcMW","W7hdI8odWOS0WOZcV8oiW54qcmojWOxcNW","yM8CW47cSSorWPvWW57dN3ZcQmkM","W7yQuLRcTW","WRhcMSklW5jIW5RdQG","hYb3dvtcQfJcJCoHB8oXW5tdTbf/W5ZdT8kjw13cHmoXWPhcRcNdGq","W6LjWQZcQ8kSW7JdN8kg","q2dcTJlcHSojW4bTjZmzWQu","WRDTrwpcVmoiwSoL","W7ddISojWOS2WO7cV8kPW58AmCoAWQG","WPlcMhddIdRdMmonta","eSkBoSolpblcRSoFeG","WOpcNhzaW5NcRqhcUSojoSklBsu","DSo6W6e4uSk0W5nHWOvxqqhcIG","WOJcQKFcU13dNWdcLCkOW4pdOx5L","W6pdKaXMkxtdLeS5WPyOW58"];return(_0x5009=function(){return n})()}document.title="前端主导第三方支付",document.getElementById("article").innerHTML='<div><p>前端主导第三方支付（JS-SDK / 小程序 / 手机浏览器）的完整落地手册<br>\n—— 从「拿到支付参数」到「用户支付成功」每一步都要加保险丝，否则亿级 UV 下必炸。</p>\n<hr>\n<ol>\n<li>时序总览（7 步闭环）\n① 用户点击【立即支付】<br>\n② 前端调用 <strong>自家后台</strong>   → 生成预支付订单<br>\n③ 后台携带商户号 / 订单号 / 金额 / 回调地址 → <strong>第三方后台</strong><br>\n④ 第三方返回 <strong>前端支付参数</strong>   （paySign、package、nonceStr…）<br>\n⑤ 前端 <strong>本地二次校验</strong>   → 调 <strong>第三方 JS-SDK</strong>   拉起收银台<br>\n⑥ 用户输入密码 → 第三方 <strong>同步回调</strong>   （仅用于展示）<br>\n⑦ 第三方 <strong>异步回调</strong>   → 后台改订单状态；前端轮询 / WebSocket 确认结果</li>\n</ol>\n<hr>\n<ol start="2">\n<li>前端必须处理的 6 个“隐藏关卡”\n<table>\n<thead>\n<tr>\n<th>关卡</th>\n<th>触发场景</th>\n<th>前端动作</th>\n<th>兜底方案</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>参数过期</td>\n<td>用户停留 &gt;5 min 才点支付</td>\n<td>本地倒计时 4 min 自动刷新</td>\n<td>弹“已超时，重新下单”</td>\n</tr>\n<tr>\n<td>签名篡改</td>\n<td>代理/外挂改 paySign</td>\n<td>本地用后台给的公钥二次验签</td>\n<td>toast“环境异常”并阻断</td>\n</tr>\n<tr>\n<td>环境白名单</td>\n<td>iOS WKWebView 禁弹窗、企业微信拦截</td>\n<td>UA 识别 + 弹“请用 Safari/微信打开”</td>\n<td>提供二维码支付</td>\n</tr>\n<tr>\n<td>弱网超时</td>\n<td>调起 SDK 10 秒无响应</td>\n<td>8 秒自动降级到二维码</td>\n<td>显示“扫码继续支付”</td>\n</tr>\n<tr>\n<td>用户取消</td>\n<td>收银台点“×”</td>\n<td>监听 fail 回调 → 回订单页</td>\n<td>轮询 3 次状态，防掉单</td>\n</tr>\n<tr>\n<td>重复点击</td>\n<td>用户狂点按钮</td>\n<td>loading + sessionStorage 锁</td>\n<td>按钮置灰 3 秒</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ol>\n<hr>\n<ol start="3">\n<li>按渠道的差异化细节</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>渠道</th>\n<th>SDK 引入</th>\n<th>调用示例</th>\n<th>特殊注意</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>微信 H5</td>\n<td>无需引入，直接 <code>WeixinJSBridge</code></td>\n<td><code>WeixinJSBridge.invoke(\'getBrandWCPayRequest\', …)</code></td>\n<td>必须在微信内；需配置 JS 安全域名</td>\n</tr>\n<tr>\n<td>微信小程序</td>\n<td><code>wx.requestPayment</code></td>\n<td><code>wx.requestPayment({ timeStamp, nonceStr, package, paySign, success, fail })</code></td>\n<td>需开通微信支付插件；<code>package</code> 必须是 <code>prepay_id=xxx</code></td>\n</tr>\n<tr>\n<td>支付宝 H5</td>\n<td>CDN 引入 <code>https://gw.alipayobjects.com/as/g/h5-lib/alipayjsapi/3.1.1/alipayjsapi.min.js</code></td>\n<td><code>AlipayJSBridge.call(\'tradePay\', { tradeNO })</code></td>\n<td>部分安卓 WebView 需先 <code>ready</code></td>\n</tr>\n<tr>\n<td>云闪付 H5</td>\n<td>CDN 引入 <code>https://qra.95516.com/pay/gateway/js/qcloud.js</code></td>\n<td><code>jspay.requestPayment({ tn })</code></td>\n<td>需申请商户号；iOS 13 以下需降级二维码</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<ol start="4">\n<li>最小可运行代码（微信 H5 场景）</li>\n</ol>\n<pre><code class="language-js"><span class="hljs-comment">// 1. 防重复</span>\n<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&quot;_pay_lock&quot;</span>)) <span class="hljs-keyword">return</span>;\n<span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&quot;_pay_lock&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);\n\n<span class="hljs-comment">// 2. 拿参数</span>\n<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;/api/unifiedOrder&quot;</span>, {\n  <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,\n  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ orderId }),\n});\n<span class="hljs-keyword">const</span> { code, data } = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();\n<span class="hljs-keyword">if</span> (code !== <span class="hljs-number">0</span>) {\n  <span class="hljs-title function_">toast</span>(<span class="hljs-string">&quot;下单失败&quot;</span>);\n  <span class="hljs-keyword">return</span>;\n}\n\n<span class="hljs-comment">// 3. 二次验签（可选但强烈建议）</span>\n<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">verifySign</span>(data, data.<span class="hljs-property">paySign</span>)) {\n  <span class="hljs-title function_">toast</span>(<span class="hljs-string">&quot;环境异常&quot;</span>);\n  <span class="hljs-keyword">return</span>;\n}\n\n<span class="hljs-comment">// 4. 调起支付</span>\n<span class="hljs-title class_">WeixinJSBridge</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">&quot;getBrandWCPayRequest&quot;</span>, data, <span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (cb.<span class="hljs-property">err_msg</span> === <span class="hljs-string">&quot;get_brand_wcpay_request:ok&quot;</span>) {\n    location.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;/pay/success&quot;</span>;\n  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cb.<span class="hljs-property">err_msg</span> === <span class="hljs-string">&quot;get_brand_wcpay_request:cancel&quot;</span>) {\n    location.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;/order/detail?refresh=1&quot;</span>; <span class="hljs-comment">// 轮询兜底</span>\n  } <span class="hljs-keyword">else</span> {\n    <span class="hljs-title function_">toast</span>(<span class="hljs-string">&quot;支付失败，请重试&quot;</span>);\n  }\n  <span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">&quot;_pay_lock&quot;</span>);\n});\n</code></pre>\n<hr>\n<ol start="5">\n<li>上线前 checklist（3 分钟过一遍）</li>\n</ol>\n<ul>\n<li>[ ] 灰度 5% → 20% → 100%，每级观察崩溃率 &lt; 0.1%</li>\n<li>[ ] iOS 12 / Android 6 真机跑通，首屏 JS ≤ 150 KB（gzip）</li>\n<li>[ ] 网络模拟 3G Slow，支付唤起时间 ≤ 2 s</li>\n<li>[ ] 已埋点：click → 下单接口 → 调起 SDK → 成功/失败/取消</li>\n<li>[ ] 已配置 sourcemap，Sentry 报警 1 分钟内可回滚</li>\n</ul>\n<hr>\n<ol start="6">\n<li>一句话总结<br>\n前端主导的支付链路，<strong>参数安全 + 环境兼容 + 异常兜底 + 灰度监控</strong>   缺一步都会在亿级流量下被放大成事故；把 6 个隐藏关卡全部做成“开关可降级”，才算真正落地。</li>\n</ol>\n</div>'</script></body></html>