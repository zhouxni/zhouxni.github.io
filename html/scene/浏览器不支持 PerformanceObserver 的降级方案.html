<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x3a05(){var s=["WRJdQSk2dNmUWQSqaa","drGeW7lcRuucECoeWRVcUCoLWQ5lwhuHpSkPW6mCrSkZC8oJWQe","W7K7gmkYWQbSrqy","rhFcK8oiWRddR1bV","kmkVEIxcSa","Cmo7WOBcSmkyqKtcR2xdOhVdVq","W7bSW6xcKMlcO8okpqi","hM5pW4uuaG7dJ8od","W5TBWQFdISkdWO99cq","WQpdKNPYD8kpqW","WOK+WRddHINdPSoWaa3dUKqR","W5jRWOTsWPLSWR5gW5XxW5S","WQJdRHnSW7aHwCohW77cJCotBa","WPKzd8keyCoRWQddOctdKN0CFa","g2zbWRf4iq3dQSo0W4BdRq","t0zXgSo/C8kXW6tdPCoP","ECo8WOlcS8kwqWxcUv7dK2BdUmoB","ECo/WOldHCoSfNRcMfu","W4VdO8oSWPBcOCkGW7RdPSo6","W7FcJ8o7n3tdHCkBWOXoW4JdUG","WO/dMbbnCSkLhq","BmoQpw/dVCoqW70rxulcP8oyWOa","W47dKCkHWPddHGZdLSkLW7ysW7a","grz6lmoDWQqSW7/dSSkXW41mWRW","pSkfjG7dP8oclCoHW6ZcJ8oitW","W6SFFSoXmCodW6WjetC"];return(_0x3a05=function(){return s})()}var _0x5c989c=_0x1215;function _0x1215(p,s){var t=_0x3a05();return(_0x1215=function(s,a){var n=t[s-=167];void 0===_0x1215.QLMexm&&(_0x1215.VruKJi=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,c=0;n=s.charAt(c++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,r=l.length;e<r;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+a.charCodeAt(c%a.length))%256,n=l[c],l[c]=l[p],l[p]=n;for(var c=0,p=0,e=0;e<s.length;e++)n=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(e)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x1215.QLMexm=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x1215.mSmAdJ&&(_0x1215.mSmAdJ=!0),n=_0x1215.VruKJi(n,a),p[s]=n),n})(p,s)}if((()=>{for(var s=_0x1215,a=_0x3a05();;)try{if(188383==-parseInt(s(176,"2D6t"))*(parseInt(s(177,"qibQ"))/2)+-parseInt(s(181,"$zWK"))/3*(-parseInt(s(187,"Tr#("))/4)+parseInt(s(175,"2D6t"))/5+-parseInt(s(190,"2D6t"))/6+-parseInt(s(183,"pt]#"))/7+-parseInt(s(178,"GH3A"))/8*(parseInt(s(184,"pbyT"))/9)+parseInt(s(180,"h5G0"))/10)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x5c989c(168,"fuot")](_0x5c989c(191,"N3[w"))!=_0x5c989c(189,"h5G0"))throw window[_0x5c989c(188,"4CVB")][_0x5c989c(179,"bjC2")](_0x5c989c(186,"Wi%G")),Error();document.title="浏览器不支持 PerformanceObserver 的降级方案",document.getElementById("article").innerHTML='<div><p>当浏览器不支持 PerformanceObserver API 时，我们需要采用降级方案来获取关键性能指标。以下是针对不同性能指标的降级实现方法：</p>\n<h2>一、基础降级方案</h2>\n<h3>1. 使用传统的 performance.timing</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getLegacyTiming</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span> || !performance.<span class="hljs-property">timing</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n\n  <span class="hljs-keyword">const</span> t = performance.<span class="hljs-property">timing</span>;\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">fcp</span>: t.<span class="hljs-property">domLoading</span> - t.<span class="hljs-property">navigationStart</span>, <span class="hljs-comment">// 估算FCP</span>\n    <span class="hljs-attr">lcp</span>: t.<span class="hljs-property">loadEventEnd</span> - t.<span class="hljs-property">navigationStart</span>, <span class="hljs-comment">// 估算LCP</span>\n    <span class="hljs-attr">dcl</span>: t.<span class="hljs-property">domContentLoadedEventStart</span> - t.<span class="hljs-property">navigationStart</span>,\n    <span class="hljs-attr">load</span>: t.<span class="hljs-property">loadEventEnd</span> - t.<span class="hljs-property">navigationStart</span>,\n  };\n}\n\n<span class="hljs-keyword">const</span> legacyMetrics = <span class="hljs-title function_">getLegacyTiming</span>();\n<span class="hljs-keyword">if</span> (legacyMetrics) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;传统性能指标:&quot;</span>, legacyMetrics);\n}\n</code></pre>\n<h3>2. 关键指标降级计算</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getFallbackMetrics</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-comment">// 首次内容绘制估算 (DOMContentLoaded)</span>\n    <span class="hljs-attr">fcp</span>: performance.<span class="hljs-title function_">now</span>(),\n\n    <span class="hljs-comment">// 最大内容绘制估算 (Load事件)</span>\n    <span class="hljs-attr">lcp</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(\n      <span class="hljs-string">&quot;load&quot;</span>,\n      <span class="hljs-function">() =&gt;</span> {\n        <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">now</span>();\n      },\n      { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span> },\n    ),\n\n    <span class="hljs-comment">// 首次输入延迟估算</span>\n    <span class="hljs-attr">fid</span>: (<span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();\n      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(\n        <span class="hljs-string">&quot;click&quot;</span>,\n        <span class="hljs-function">() =&gt;</span> {\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;FID估算:&quot;</span>, performance.<span class="hljs-title function_">now</span>() - start);\n        },\n        { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> },\n      );\n    })(),\n  };\n}\n</code></pre>\n<h2>二、针对特定指标的降级实现</h2>\n<h3>1. First Contentful Paint (FCP) 降级</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">trackFallbackFCP</span>(<span class="hljs-params">callback</span>) {\n  <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;PerformanceObserver&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;\n\n  <span class="hljs-keyword">let</span> fcpDetected = <span class="hljs-literal">false</span>;\n  <span class="hljs-keyword">const</span> startTime = performance.<span class="hljs-title function_">now</span>();\n\n  <span class="hljs-comment">// 方法1: DOM变化观察</span>\n  <span class="hljs-keyword">const</span> mo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span> &amp;&amp; <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {\n      <span class="hljs-keyword">const</span> fcp = performance.<span class="hljs-title function_">now</span>() - startTime;\n      <span class="hljs-title function_">callback</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;fcp&quot;</span>, <span class="hljs-attr">value</span>: fcp });\n      mo.<span class="hljs-title function_">disconnect</span>();\n      fcpDetected = <span class="hljs-literal">true</span>;\n    }\n  });\n\n  mo.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>, { <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span> });\n\n  <span class="hljs-comment">// 方法2: 轮询检查</span>\n  <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkContent</span> = (<span class="hljs-params"></span>) =&gt; {\n    <span class="hljs-keyword">if</span> (fcpDetected) <span class="hljs-keyword">return</span>;\n\n    <span class="hljs-keyword">const</span> contentElements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;h1, h2, p, img&quot;</span>);\n    <span class="hljs-keyword">if</span> (contentElements.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {\n      <span class="hljs-keyword">const</span> fcp = performance.<span class="hljs-title function_">now</span>() - startTime;\n      <span class="hljs-title function_">callback</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;fcp&quot;</span>, <span class="hljs-attr">value</span>: fcp });\n      fcpDetected = <span class="hljs-literal">true</span>;\n    } <span class="hljs-keyword">else</span> {\n      <span class="hljs-title function_">requestAnimationFrame</span>(checkContent);\n    }\n  };\n\n  <span class="hljs-title function_">requestAnimationFrame</span>(checkContent);\n\n  <span class="hljs-comment">// 超时处理</span>\n  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">if</span> (!fcpDetected) {\n      <span class="hljs-title function_">callback</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;fcp&quot;</span>, <span class="hljs-attr">value</span>: performance.<span class="hljs-title function_">now</span>() - startTime });\n    }\n  }, <span class="hljs-number">10000</span>);\n}\n\n<span class="hljs-comment">// 使用示例</span>\n<span class="hljs-title function_">trackFallbackFCP</span>(<span class="hljs-function">(<span class="hljs-params">metric</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;FCP降级测量:&quot;</span>, metric.<span class="hljs-property">value</span>);\n});\n</code></pre>\n<h3>2. Largest Contentful Paint (LCP) 降级</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">trackFallbackLCP</span>(<span class="hljs-params">callback</span>) {\n  <span class="hljs-keyword">let</span> lcpValue = <span class="hljs-number">0</span>;\n\n  <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkLCP</span> = (<span class="hljs-params"></span>) =&gt; {\n    <span class="hljs-keyword">const</span> viewportHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;\n    <span class="hljs-keyword">const</span> viewportWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;\n    <span class="hljs-keyword">let</span> maxSize = <span class="hljs-number">0</span>;\n\n    <span class="hljs-comment">// 检查所有可见元素</span>\n    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;*&quot;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> rect = el.<span class="hljs-title function_">getBoundingClientRect</span>();\n      <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">width</span> &gt; <span class="hljs-number">0</span> &amp;&amp; rect.<span class="hljs-property">height</span> &gt; <span class="hljs-number">0</span>) {\n        <span class="hljs-keyword">const</span> area = rect.<span class="hljs-property">width</span> * rect.<span class="hljs-property">height</span>;\n        <span class="hljs-keyword">const</span> viewportArea = viewportWidth * viewportHeight;\n        <span class="hljs-keyword">const</span> ratio = area / viewportArea;\n\n        <span class="hljs-keyword">if</span> (ratio &gt; maxSize) {\n          maxSize = ratio;\n          lcpValue = performance.<span class="hljs-title function_">now</span>();\n        }\n      }\n    });\n\n    <span class="hljs-comment">// 持续监测直到页面稳定</span>\n    <span class="hljs-keyword">if</span> (maxSize &lt; <span class="hljs-number">0.5</span> &amp;&amp; performance.<span class="hljs-title function_">now</span>() &lt; <span class="hljs-number">10000</span>) {\n      <span class="hljs-title function_">requestAnimationFrame</span>(checkLCP);\n    } <span class="hljs-keyword">else</span> {\n      <span class="hljs-title function_">callback</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;lcp&quot;</span>, <span class="hljs-attr">value</span>: lcpValue });\n    }\n  };\n\n  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;load&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-comment">// 页面加载完成后开始监测</span>\n    <span class="hljs-built_in">setTimeout</span>(checkLCP, <span class="hljs-number">500</span>);\n  });\n}\n</code></pre>\n<h3>3. First Input Delay (FID) 降级</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">trackFallbackFID</span>(<span class="hljs-params">callback</span>) {\n  <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();\n\n  <span class="hljs-keyword">const</span> eventTypes = [<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-string">&quot;mousedown&quot;</span>, <span class="hljs-string">&quot;keydown&quot;</span>, <span class="hljs-string">&quot;touchstart&quot;</span>];\n\n  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; {\n    <span class="hljs-keyword">const</span> delay = performance.<span class="hljs-title function_">now</span>() - start;\n    <span class="hljs-title function_">callback</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;fid&quot;</span>, <span class="hljs-attr">value</span>: delay });\n\n    <span class="hljs-comment">// 只记录第一次交互</span>\n    eventTypes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">type</span>) =&gt;</span> {\n      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(type, handler);\n    });\n  };\n\n  eventTypes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">type</span>) =&gt;</span> {\n    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(type, handler, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });\n  });\n}\n</code></pre>\n<h2>三、综合降级方案</h2>\n<h3>1. 完整的降级监测类</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyPerformanceMonitor</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span> = {};\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = performance.<span class="hljs-title function_">now</span>();\n  }\n\n  <span class="hljs-title function_">trackFCP</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 使用MutationObserver和RAF组合方案</span>\n    <span class="hljs-keyword">const</span> mo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>?.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> = performance.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>;\n        mo.<span class="hljs-title function_">disconnect</span>();\n      }\n    });\n\n    mo.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>, { <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span> });\n\n    <span class="hljs-comment">// 超时回退</span>\n    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span>) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> = performance.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>;\n      }\n    }, <span class="hljs-number">5000</span>);\n  }\n\n  <span class="hljs-title function_">trackLCP</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;load&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-keyword">let</span> maxSize = <span class="hljs-number">0</span>;\n      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;img, video, div&quot;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> rect = el.<span class="hljs-title function_">getBoundingClientRect</span>();\n        <span class="hljs-keyword">const</span> area = rect.<span class="hljs-property">width</span> * rect.<span class="hljs-property">height</span>;\n        <span class="hljs-keyword">if</span> (area &gt; maxSize) {\n          maxSize = area;\n          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">lcp</span> = performance.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>;\n        }\n      });\n    });\n  }\n\n  <span class="hljs-title function_">trackFID</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">const</span> events = [<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-string">&quot;mousedown&quot;</span>, <span class="hljs-string">&quot;keydown&quot;</span>];\n    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fid</span> = performance.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>;\n      events.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(e, handler));\n    };\n    events.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(e, handler));\n  }\n\n  <span class="hljs-title function_">start</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">trackFCP</span>();\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">trackLCP</span>();\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">trackFID</span>();\n\n    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;beforeunload&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>();\n    });\n  }\n\n  <span class="hljs-title function_">report</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 补全未捕获的指标</span>\n    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span>) {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> =\n        performance.<span class="hljs-property">timing</span>?.<span class="hljs-property">domContentLoadedEventStart</span> -\n          performance.<span class="hljs-property">timing</span>?.<span class="hljs-property">navigationStart</span> ||\n        performance.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>;\n    }\n\n    <span class="hljs-comment">// 上报数据</span>\n    navigator.<span class="hljs-property">sendBeacon</span>?.(\n      <span class="hljs-string">&quot;/analytics&quot;</span>,\n      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({\n        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>,\n        <span class="hljs-attr">userAgent</span>: navigator.<span class="hljs-property">userAgent</span>,\n      }),\n    );\n  }\n}\n\n<span class="hljs-comment">// 使用示例</span>\n<span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">PerformanceObserver</span>) {\n  <span class="hljs-keyword">const</span> monitor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LegacyPerformanceMonitor</span>();\n  monitor.<span class="hljs-title function_">start</span>();\n}\n</code></pre>\n<h3>2. 特征检测与自动降级</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">monitorPerformance</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-comment">// 现代浏览器方案</span>\n  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">PerformanceObserver</span>) {\n    <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {\n      <span class="hljs-comment">// 标准实现...</span>\n    });\n    observer.<span class="hljs-title function_">observe</span>({\n      <span class="hljs-attr">type</span>: [<span class="hljs-string">&quot;paint&quot;</span>, <span class="hljs-string">&quot;largest-contentful-paint&quot;</span>],\n      <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span>,\n    });\n    <span class="hljs-keyword">return</span>;\n  }\n\n  <span class="hljs-comment">// 降级方案</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&quot;使用性能监测降级方案&quot;</span>);\n\n  <span class="hljs-keyword">const</span> fallbackMetrics = {\n    <span class="hljs-attr">fcp</span>: <span class="hljs-literal">null</span>,\n    <span class="hljs-attr">lcp</span>: <span class="hljs-literal">null</span>,\n    <span class="hljs-attr">fid</span>: <span class="hljs-literal">null</span>,\n  };\n\n  <span class="hljs-comment">// FCP降级监测</span>\n  <span class="hljs-keyword">const</span> mo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>?.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {\n      fallbackMetrics.<span class="hljs-property">fcp</span> = performance.<span class="hljs-title function_">now</span>();\n      mo.<span class="hljs-title function_">disconnect</span>();\n    }\n  });\n  mo.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>, { <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span> });\n\n  <span class="hljs-comment">// LCP降级监测</span>\n  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;load&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n    fallbackMetrics.<span class="hljs-property">lcp</span> = performance.<span class="hljs-title function_">now</span>();\n  });\n\n  <span class="hljs-comment">// FID降级监测</span>\n  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(\n    <span class="hljs-string">&quot;click&quot;</span>,\n    <span class="hljs-function">() =&gt;</span> {\n      fallbackMetrics.<span class="hljs-property">fid</span> = performance.<span class="hljs-title function_">now</span>();\n    },\n    { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span> },\n  );\n\n  <span class="hljs-comment">// 最终上报</span>\n  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;beforeunload&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n    navigator.<span class="hljs-property">sendBeacon</span>?.(<span class="hljs-string">&quot;/analytics&quot;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(fallbackMetrics));\n  });\n}\n\n<span class="hljs-comment">// 初始化</span>\n<span class="hljs-title function_">monitorPerformance</span>();\n</code></pre>\n<h2>四、注意事项</h2>\n<ol>\n<li><strong>精度差异</strong>   ：降级方案的测量精度通常低于 PerformanceObserver</li>\n<li><strong>性能影响</strong>   ：DOM 全量扫描可能影响性能，需合理控制频率</li>\n<li><strong>指标对应</strong>   ：降级指标与标准指标含义可能不完全相同</li>\n<li><strong>兼容性处理</strong>   ：<pre><code class="language-javascript"><span class="hljs-comment">// 确保 performance.now() 可用</span>\n<span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>) {\n  <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span> = { <span class="hljs-attr">now</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-property">now</span> };\n}\n</code></pre>\n</li>\n</ol>\n<h2>五、最佳实践建议</h2>\n<ol>\n<li><strong>优先尝试 PerformanceObserver</strong></li>\n<li><strong>降级方案作为备选</strong></li>\n<li><strong>明确标注数据来源</strong><pre><code class="language-javascript">navigator.<span class="hljs-title function_">sendBeacon</span>(\n  <span class="hljs-string">&quot;/analytics&quot;</span>,\n  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({\n    <span class="hljs-attr">fcp</span>: <span class="hljs-number">1200</span>,\n    <span class="hljs-attr">_source</span>: <span class="hljs-string">&quot;legacy&quot;</span>, <span class="hljs-comment">// 标明是降级方案数据</span>\n  }),\n);\n</code></pre>\n</li>\n<li><strong>控制降级监测频率</strong>   ：避免频繁的 DOM 查询</li>\n</ol>\n<p>通过这些降级方案，即使在老旧浏览器中也能获取基本的性能数据，为性能优化提供参考依据。</p>\n</div>'</script></body></html>