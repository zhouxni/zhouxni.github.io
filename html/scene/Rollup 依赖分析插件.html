<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0xffed75=_0x2137;function _0x2137(l,s){var p=_0x340c();return(_0x2137=function(s,n){var a=p[s-=414];void 0===_0x2137.caxHiD&&(_0x2137.KebOEK=function(s,n){var a,t=[],l=0,p="";for(s=(s=>{for(var n,a,t="",l="",p=0,e=0;a=s.charAt(e++);~a&&(n=p%4?64*n+a:a,p++%4)&&(t+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,c=t.length;o<c;o++)l+="%"+("00"+t.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(l)})(s),e=0;e<256;e++)t[e]=e;for(e=0;e<256;e++)l=(l+t[e]+n.charCodeAt(e%n.length))%256,a=t[e],t[e]=t[l],t[l]=a;for(var e=0,l=0,o=0;o<s.length;o++)a=t[e=(e+1)%256],t[e]=t[l=(l+t[e])%256],t[l]=a,p+=String.fromCharCode(s.charCodeAt(o)^t[(t[e]+t[l])%256]);return p},l=arguments,_0x2137.caxHiD=!0);var s=s+p[0],t=l[s];return t?a=t:(void 0===_0x2137.tJWGdO&&(_0x2137.tJWGdO=!0),a=_0x2137.KebOEK(a,n),l[s]=a),a})(l,s)}function _0x340c(){var s=["qKreWOieWP9Rhh5v","zvJcGcClmgVcHYNcMeFdTmo0","W5nTWPtdOM5dWQxdP0uBvmoTW7i","B8oMeLbXg8oK","DrNcGmoeWOVdMt1AWRC","WQhcQsT8g3pdNby","zLVcIYDwyINcSalcJG","W4CFW552weSh","WR/cI8oxDmo4WPhcUSkC","CrZcJCkxW7FcONjxWQJcHuVcKfa","W6hdSIL1egbjbmouxG","W7VdRX5zeHVcPLhdV8ompIP9WOaFAadcQ8obWRhdK1tcG8kSrb8","fIyCW4tcPSkEAxmu","Bf/cGc95rbtcPbtcNq","W4fiW7DXvvS9WRu","W6NcT8owfuX0W4m","yCkgWP0jEshcVX/cPCkdxW","WQ4+W4pdRu/cKCkoEx8sW4K","lMxdSCk8awTwW7OBpHedWP8","W74wCbzKWRzOW4DMW4q","pZj+m8k7jSoyW6jtp8kOW6JcNW","AhTZdmkGWOi5","yxm8mwVdKxJdPmoZW7i","WQS9WOtcIYVcUCkxxG","WQHYW6DkAqZdKSkP","jZamW5lcRa","phBcVmk8W4xdRh80cGNdPtjg","iCokW5frW43cLYFcLXPIyG","WPuHraGXF8ovW6OtW5q","phFcVmk/WPtcJdOqpcK","oNBcV8oOWR7cLZWpga","W6JdGmkRAar5WPtdPMJcRx0"];return(_0x340c=function(){return s})()}if((()=>{for(var s=_0x2137,n=_0x340c();;)try{if(267943==+parseInt(s(424,"v)Y*"))*(-parseInt(s(443,"nffe"))/2)+-parseInt(s(430,"2AVE"))/3*(-parseInt(s(436,"nffe"))/4)+parseInt(s(433,"wIFL"))/5*(-parseInt(s(445,"G3Qp"))/6)+parseInt(s(439,"qt3k"))/7*(-parseInt(s(425,"OuDo"))/8)+parseInt(s(417,"ssEk"))/9+parseInt(s(419,"EYQ]"))/10*(parseInt(s(429,"QAz["))/11)+parseInt(s(438,"wIFL"))/12*(parseInt(s(420,"bH10"))/13))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0xffed75(432,"T5*p")](_0xffed75(441,"m(Rf"))!=_0xffed75(422,"m(Rf"))throw window[_0xffed75(421,"KqA#")][_0xffed75(418,"qtUc")](_0xffed75(440,"A!8z")),Error();document.title="Rollup 依赖分析插件",document.getElementById("article").innerHTML='<div><p>下面是一个 Rollup 插件实现，用于分析项目依赖关系并生成可视化的依赖图谱。</p>\n<h2>插件代码</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { writeFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;fs&quot;</span>;\n<span class="hljs-keyword">import</span> { dirname, relative } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;path&quot;</span>;\n<span class="hljs-keyword">import</span> { createHash } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;crypto&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Graphviz</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;graphviz&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rollupDependencyAnalyzer</span>(<span class="hljs-params">options = {}</span>) {\n  <span class="hljs-keyword">const</span> {\n    outputFile = <span class="hljs-string">&quot;dependency-graph.html&quot;</span>,\n    outputJson = <span class="hljs-string">&quot;dependency-graph.json&quot;</span>,\n    includeExternal = <span class="hljs-literal">false</span>,\n    showCircular = <span class="hljs-literal">true</span>,\n    showRedundant = <span class="hljs-literal">true</span>,\n    depthLimit = <span class="hljs-number">5</span>,\n    sizeMetrics = <span class="hljs-literal">true</span>,\n    showVersion = <span class="hljs-literal">true</span>,\n  } = options;\n\n  <span class="hljs-keyword">const</span> dependencyGraph = {\n    <span class="hljs-attr">nodes</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),\n    <span class="hljs-attr">links</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),\n    <span class="hljs-attr">circularDependencies</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),\n    <span class="hljs-attr">redundantDependencies</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),\n  };\n\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;rollup-dependency-analyzer&quot;</span>,\n\n    <span class="hljs-title function_">resolveId</span>(<span class="hljs-params">source, importer</span>) {\n      <span class="hljs-keyword">if</span> (!importer) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n\n      <span class="hljs-keyword">const</span> importerId = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getModuleInfo</span>(importer)?.<span class="hljs-property">id</span> || importer;\n      <span class="hljs-keyword">const</span> sourceId = source.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;\\0&quot;</span>) ? <span class="hljs-literal">null</span> : source;\n\n      <span class="hljs-keyword">if</span> (sourceId &amp;&amp; importerId) {\n        <span class="hljs-keyword">const</span> linkKey = <span class="hljs-string">`<span class="hljs-subst">${importerId}</span> -&gt; <span class="hljs-subst">${sourceId}</span>`</span>;\n        <span class="hljs-keyword">if</span> (!dependencyGraph.<span class="hljs-property">links</span>.<span class="hljs-title function_">has</span>(linkKey)) {\n          dependencyGraph.<span class="hljs-property">links</span>.<span class="hljs-title function_">add</span>(linkKey);\n\n          <span class="hljs-comment">// 记录依赖关系</span>\n          <span class="hljs-keyword">if</span> (!dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">has</span>(importerId)) {\n            dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">set</span>(importerId, {\n              <span class="hljs-attr">id</span>: importerId,\n              <span class="hljs-attr">dependents</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),\n              <span class="hljs-attr">dependencies</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),\n            });\n          }\n\n          <span class="hljs-keyword">if</span> (!dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">has</span>(sourceId)) {\n            dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">set</span>(sourceId, {\n              <span class="hljs-attr">id</span>: sourceId,\n              <span class="hljs-attr">dependents</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),\n              <span class="hljs-attr">dependencies</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),\n            });\n          }\n\n          <span class="hljs-keyword">const</span> importerNode = dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">get</span>(importerId);\n          <span class="hljs-keyword">const</span> sourceNode = dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">get</span>(sourceId);\n\n          importerNode.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">add</span>(sourceId);\n          sourceNode.<span class="hljs-property">dependents</span>.<span class="hljs-title function_">add</span>(importerId);\n        }\n      }\n      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n    },\n\n    <span class="hljs-title function_">buildEnd</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-comment">// 分析循环依赖</span>\n      <span class="hljs-keyword">if</span> (showCircular) {\n        <span class="hljs-keyword">const</span> visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();\n\n        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [id] <span class="hljs-keyword">of</span> dependencyGraph.<span class="hljs-property">nodes</span>) {\n          <span class="hljs-keyword">if</span> (!visited.<span class="hljs-title function_">has</span>(id)) {\n            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_detectCircularDeps</span>(id, [], visited);\n          }\n        }\n      }\n\n      <span class="hljs-comment">// 分析冗余依赖</span>\n      <span class="hljs-keyword">if</span> (showRedundant) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_detectRedundantDeps</span>();\n      }\n\n      <span class="hljs-comment">// 生成报告</span>\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_generateReports</span>();\n    },\n\n    <span class="hljs-title function_">_detectCircularDeps</span>(<span class="hljs-params">moduleId, path, visited</span>) {\n      <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">includes</span>(moduleId)) {\n        <span class="hljs-comment">// 发现循环依赖</span>\n        <span class="hljs-keyword">const</span> cycleStart = path.<span class="hljs-title function_">indexOf</span>(moduleId);\n        <span class="hljs-keyword">const</span> cycle = path.<span class="hljs-title function_">slice</span>(cycleStart).<span class="hljs-title function_">concat</span>(moduleId);\n        <span class="hljs-keyword">const</span> cycleKey = cycle.<span class="hljs-title function_">sort</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot; -&gt; &quot;</span>);\n\n        <span class="hljs-keyword">if</span> (!dependencyGraph.<span class="hljs-property">circularDependencies</span>.<span class="hljs-title function_">has</span>(cycleKey)) {\n          dependencyGraph.<span class="hljs-property">circularDependencies</span>.<span class="hljs-title function_">add</span>(cycleKey);\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`⚠️ 发现循环依赖: <span class="hljs-subst">${cycle.join(<span class="hljs-string">&quot; -&gt; &quot;</span>)}</span>`</span>);\n        }\n        <span class="hljs-keyword">return</span>;\n      }\n\n      visited.<span class="hljs-title function_">add</span>(moduleId);\n      <span class="hljs-keyword">const</span> newPath = [...path, moduleId];\n      <span class="hljs-keyword">const</span> moduleNode = dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">get</span>(moduleId);\n\n      <span class="hljs-keyword">if</span> (moduleNode) {\n        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> depId <span class="hljs-keyword">of</span> moduleNode.<span class="hljs-property">dependencies</span>) {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_detectCircularDeps</span>(depId, newPath, visited);\n        }\n      }\n    },\n\n    <span class="hljs-title function_">_detectRedundantDeps</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [id, node] <span class="hljs-keyword">of</span> dependencyGraph.<span class="hljs-property">nodes</span>) {\n        <span class="hljs-keyword">const</span> redundant = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();\n\n        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> depA <span class="hljs-keyword">of</span> node.<span class="hljs-property">dependencies</span>) {\n          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> depB <span class="hljs-keyword">of</span> node.<span class="hljs-property">dependencies</span>) {\n            <span class="hljs-keyword">if</span> (depA !== depB) {\n              <span class="hljs-keyword">const</span> depANode = dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">get</span>(depA);\n              <span class="hljs-keyword">if</span> (depANode?.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">has</span>(depB)) {\n                redundant.<span class="hljs-title function_">add</span>(depB);\n              }\n            }\n          }\n        }\n\n        <span class="hljs-keyword">if</span> (redundant.<span class="hljs-property">size</span> &gt; <span class="hljs-number">0</span>) {\n          dependencyGraph.<span class="hljs-property">redundantDependencies</span>.<span class="hljs-title function_">set</span>(id, [...redundant]);\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(\n            <span class="hljs-string">`⚠️ 发现冗余依赖: <span class="hljs-subst">${id}</span> 可以移除 <span class="hljs-subst">${[...redundant].join(<span class="hljs-string">&quot;, &quot;</span>)}</span>`</span>,\n          );\n        }\n      }\n    },\n\n    <span class="hljs-title function_">_generateReports</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-comment">// 生成JSON报告</span>\n      <span class="hljs-keyword">const</span> jsonReport = {\n        <span class="hljs-attr">meta</span>: {\n          <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),\n          <span class="hljs-attr">totalModules</span>: dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-property">size</span>,\n          <span class="hljs-attr">totalDependencies</span>: dependencyGraph.<span class="hljs-property">links</span>.<span class="hljs-property">size</span>,\n          <span class="hljs-attr">circularDependencies</span>: [...dependencyGraph.<span class="hljs-property">circularDependencies</span>],\n          <span class="hljs-attr">redundantDependencies</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(\n            dependencyGraph.<span class="hljs-property">redundantDependencies</span>,\n          ),\n        },\n        <span class="hljs-attr">nodes</span>: [...dependencyGraph.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">values</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">node</span>) =&gt;</span> ({\n          <span class="hljs-attr">id</span>: node.<span class="hljs-property">id</span>,\n          <span class="hljs-attr">dependents</span>: [...node.<span class="hljs-property">dependents</span>],\n          <span class="hljs-attr">dependencies</span>: [...node.<span class="hljs-property">dependencies</span>],\n          <span class="hljs-attr">isExternal</span>: node.<span class="hljs-property">id</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;node_modules&quot;</span>),\n          ...(sizeMetrics ? { <span class="hljs-attr">size</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getModuleSize</span>(node.<span class="hljs-property">id</span>) } : {}),\n        })),\n        <span class="hljs-attr">links</span>: [...dependencyGraph.<span class="hljs-property">links</span>],\n      };\n\n      <span class="hljs-title function_">writeFileSync</span>(outputJson, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(jsonReport, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));\n\n      <span class="hljs-comment">// 生成可视化HTML报告</span>\n      <span class="hljs-keyword">const</span> htmlReport = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_generateHtmlVisualization</span>(jsonReport);\n      <span class="hljs-title function_">writeFileSync</span>(outputFile, htmlReport);\n\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 依赖分析完成: \n  - 可视化报告: <span class="hljs-subst">${outputFile}</span>\n  - JSON报告: <span class="hljs-subst">${outputJson}</span>`</span>);\n    },\n\n    <span class="hljs-title function_">_getModuleSize</span>(<span class="hljs-params">moduleId</span>) {\n      <span class="hljs-keyword">try</span> {\n        <span class="hljs-keyword">const</span> moduleInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getModuleInfo</span>(moduleId);\n        <span class="hljs-keyword">return</span> moduleInfo?.<span class="hljs-property">code</span>?.<span class="hljs-property">length</span> || <span class="hljs-number">0</span>;\n      } <span class="hljs-keyword">catch</span> {\n        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;\n      }\n    },\n\n    <span class="hljs-title function_">_generateHtmlVisualization</span>(<span class="hljs-params">report</span>) {\n      <span class="hljs-comment">// 使用dagre-d3生成可视化图表</span>\n      <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n  &lt;title&gt;项目依赖关系图&lt;/title&gt;\n  &lt;script src=&quot;https://d3js.org/d3.v7.min.js&quot;&gt;&lt;/script&gt;\n  &lt;script src=&quot;https://dagrejs.github.io/project/dagre-d3/latest/dagre-d3.min.js&quot;&gt;&lt;/script&gt;\n  &lt;style&gt;\n    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }\n    .graph-container { border: 1px solid #ddd; border-radius: 4px; overflow: auto; }\n    .node rect { stroke: #999; fill: #fff; stroke-width: 1.5px; }\n    .node.external rect { fill: #f0f0f0; }\n    .edgePath path { stroke: #333; stroke-width: 1.5px; fill: none; }\n    .tooltip { position: absolute; padding: 8px; background: rgba(0,0,0,0.8); color: #fff; border-radius: 4px; pointer-events: none; }\n    .controls { margin-bottom: 15px; }\n    .summary { margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; }\n    .circular { color: #d9534f; }\n    .redundant { color: #f0ad4e; }\n  &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n  &lt;h1&gt;项目依赖关系图&lt;/h1&gt;\n  &lt;div class=&quot;summary&quot;&gt;\n    &lt;p&gt;总模块数: <span class="hljs-subst">${report.meta.totalModules}</span> | 总依赖数: <span class="hljs-subst">${report.meta.totalDependencies}</span>&lt;/p&gt;\n    <span class="hljs-subst">${\n      report.meta.circularDependencies.length &gt; <span class="hljs-number">0</span>\n        ? <span class="hljs-string">`&lt;p class=&quot;circular&quot;&gt;⚠️ 发现循环依赖: <span class="hljs-subst">${report.meta.circularDependencies.length}</span>处&lt;/p&gt;`</span>\n        : <span class="hljs-string">&quot;&quot;</span>\n    }</span>\n    <span class="hljs-subst">${\n      <span class="hljs-built_in">Object</span>.keys(report.meta.redundantDependencies).length &gt; <span class="hljs-number">0</span>\n        ? <span class="hljs-string">`&lt;p class=&quot;redundant&quot;&gt;⚠️ 发现冗余依赖: <span class="hljs-subst">${<span class="hljs-built_in">Object</span>.keys(report.meta.redundantDependencies).length}</span>处&lt;/p&gt;`</span>\n        : <span class="hljs-string">&quot;&quot;</span>\n    }</span>\n  &lt;/div&gt;\n  &lt;div class=&quot;controls&quot;&gt;\n    &lt;button id=&quot;toggle-external&quot;&gt;切换外部依赖显示&lt;/button&gt;\n    &lt;button id=&quot;toggle-circular&quot;&gt;高亮循环依赖&lt;/button&gt;\n    &lt;button id=&quot;toggle-redundant&quot;&gt;高亮冗余依赖&lt;/button&gt;\n    &lt;button id=&quot;reset&quot;&gt;重置视图&lt;/button&gt;\n  &lt;/div&gt;\n  &lt;div class=&quot;graph-container&quot;&gt;\n    &lt;svg id=&quot;dependency-graph&quot; width=&quot;100%&quot; height=&quot;600&quot;&gt;&lt;/svg&gt;\n  &lt;/div&gt;\n  &lt;script&gt;\n    const data = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(report)}</span>;\n    const circularPaths = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify([...dependencyGraph.circularDependencies])}</span>;\n    const redundantMap = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">Object</span>.fromEntries(dependencyGraph.redundantDependencies))}</span>;\n    \n    // 创建D3图表\n    const svg = d3.select(&quot;#dependency-graph&quot;);\n    const container = svg.append(&quot;g&quot;);\n    const tooltip = d3.select(&quot;body&quot;).append(&quot;div&quot;).attr(&quot;class&quot;, &quot;tooltip&quot;).style(&quot;opacity&quot;, 0);\n    \n    // 创建Dagre图\n    const g = new dagreD3.graphlib.Graph().setGraph({});\n    \n    // 添加节点\n    data.nodes.forEach(node =&gt; {\n      const isExternal = node.id.includes(&#x27;node_modules&#x27;);\n      const label = \\`\\${node.id}\\${node.size ? &#x27; | &#x27; + (node.size / 1024).toFixed(2) + &#x27;KB&#x27; : &#x27;&#x27;}\\`;\n      \n      g.setNode(node.id, {\n        label: label,\n        labelType: &quot;html&quot;,\n        class: isExternal ? &quot;external&quot; : &quot;&quot;,\n        rx: 5,\n        ry: 5\n      });\n    });\n    \n    // 添加边\n    data.links.forEach(link =&gt; {\n      const [source, target] = link.split(&#x27; -&gt; &#x27;);\n      g.setEdge(source, target, {\n        arrowhead: &quot;vee&quot;,\n        label: &quot;&quot;\n      });\n    });\n    \n    // 创建渲染器\n    const render = new dagreD3.render();\n    render(container, g);\n    \n    // 添加交互\n    svg.selectAll(&quot;g.node&quot;)\n      .on(&quot;mouseover&quot;, function(event, id) {\n        const node = data.nodes.find(n =&gt; n.id === id);\n        const dependents = node.dependents.join(&quot;\\\\n&quot;);\n        const dependencies = node.dependencies.join(&quot;\\\\n&quot;);\n        \n        tooltip.transition().duration(200).style(&quot;opacity&quot;, .9);\n        tooltip.html(\\`\n          &lt;strong&gt;\\${id}&lt;/strong&gt;&lt;br&gt;\n          &lt;strong&gt;依赖:\\${dependencies.length &gt; 0 ? &quot;&quot; : &quot;无&quot;}&lt;/strong&gt;&lt;br&gt;\n          \\${dependencies}&lt;br&gt;\n          &lt;strong&gt;被依赖:\\${dependents.length &gt; 0 ? &quot;&quot; : &quot;无&quot;}&lt;/strong&gt;&lt;br&gt;\n          \\${dependents}\n        \\`)\n          .style(&quot;left&quot;, (event.pageX + 10) + &quot;px&quot;)\n          .style(&quot;top&quot;, (event.pageY - 28) + &quot;px&quot;);\n      })\n      .on(&quot;mouseout&quot;, () =&gt; {\n        tooltip.transition().duration(500).style(&quot;opacity&quot;, 0);\n      });\n    \n    // 控制按钮\n    document.getElementById(&#x27;toggle-external&#x27;).addEventListener(&#x27;click&#x27;, () =&gt; {\n      svg.selectAll(&quot;.external&quot;).style(&quot;opacity&quot;, d =&gt; {\n        return d3.select(d).style(&quot;opacity&quot;) === &quot;0.3&quot; ? &quot;1&quot; : &quot;0.3&quot;;\n      });\n    });\n    \n    document.getElementById(&#x27;toggle-circular&#x27;).addEventListener(&#x27;click&#x27;, () =&gt; {\n      // 高亮循环依赖路径\n      circularPaths.forEach(path =&gt; {\n        const modules = path.split(&#x27; -&gt; &#x27;);\n        modules.forEach((module, i) =&gt; {\n          if (i &lt; modules.length - 1) {\n            svg.selectAll(\\`g.edgePath path[data-source=&quot;\\${module}&quot;][data-target=&quot;\\${modules[i+1]}&quot;]\\`)\n              .style(&quot;stroke&quot;, &quot;#d9534f&quot;)\n              .style(&quot;stroke-width&quot;, &quot;3px&quot;);\n          }\n        });\n      });\n    });\n    \n    document.getElementById(&#x27;toggle-redundant&#x27;).addEventListener(&#x27;click&#x27;, () =&gt; {\n      // 高亮冗余依赖\n      Object.entries(redundantMap).forEach(([module, redundantDeps]) =&gt; {\n        redundantDeps.forEach(dep =&gt; {\n          svg.selectAll(\\`g.edgePath path[data-source=&quot;\\${module}&quot;][data-target=&quot;\\${dep}&quot;]\\`)\n            .style(&quot;stroke&quot;, &quot;#f0ad4e&quot;)\n            .style(&quot;stroke-width&quot;, &quot;3px&quot;);\n        });\n      });\n    });\n    \n    document.getElementById(&#x27;reset&#x27;).addEventListener(&#x27;click&#x27;, () =&gt; {\n      svg.selectAll(&quot;path&quot;).style(&quot;stroke&quot;, &quot;#333&quot;).style(&quot;stroke-width&quot;, &quot;1.5px&quot;);\n      svg.selectAll(&quot;.external&quot;).style(&quot;opacity&quot;, &quot;1&quot;);\n    });\n    \n    // 初始缩放和居中\n    const zoom = d3.zoom().on(&quot;zoom&quot;, (event) =&gt; {\n      container.attr(&quot;transform&quot;, event.transform);\n    });\n    svg.call(zoom);\n    \n    const graphWidth = g.graph().width;\n    const graphHeight = g.graph().height;\n    const svgWidth = svg.node().getBoundingClientRect().width;\n    const svgHeight = 600;\n    \n    const scale = Math.min(svgWidth / graphWidth, svgHeight / graphHeight) * 0.8;\n    const translate = [(svgWidth - graphWidth * scale) / 2, 20];\n    \n    svg.call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));\n  &lt;/script&gt;\n&lt;/body&gt;\n&lt;/html&gt;`</span>;\n    },\n  };\n}\n</code></pre>\n<h2>使用示例</h2>\n<p>在你的 Rollup 配置文件中使用这个插件：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> dependencyAnalyzer <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./rollup-dependency-analyzer.js&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">input</span>: <span class="hljs-string">&quot;src/index.js&quot;</span>,\n  <span class="hljs-attr">output</span>: {\n    <span class="hljs-attr">dir</span>: <span class="hljs-string">&quot;dist&quot;</span>,\n    <span class="hljs-attr">format</span>: <span class="hljs-string">&quot;esm&quot;</span>,\n  },\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-title function_">dependencyAnalyzer</span>({\n      <span class="hljs-attr">outputFile</span>: <span class="hljs-string">&quot;dependency-graph.html&quot;</span>, <span class="hljs-comment">// 可视化HTML报告</span>\n      <span class="hljs-attr">outputJson</span>: <span class="hljs-string">&quot;dependency-data.json&quot;</span>, <span class="hljs-comment">// 原始JSON数据</span>\n      <span class="hljs-attr">includeExternal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否包含node_modules中的依赖</span>\n      <span class="hljs-attr">showCircular</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否检测循环依赖</span>\n      <span class="hljs-attr">showRedundant</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否检测冗余依赖</span>\n      <span class="hljs-attr">depthLimit</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">// 分析深度限制</span>\n      <span class="hljs-attr">sizeMetrics</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否包含模块大小信息</span>\n      <span class="hljs-attr">showVersion</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否显示模块版本</span>\n    }),\n  ],\n};\n</code></pre>\n<h2>功能说明</h2>\n<ol>\n<li>\n<p><strong>依赖关系可视化</strong>   ：</p>\n<ul>\n<li>生成交互式D3.js力导向图</li>\n<li>支持缩放和平移浏览大型依赖图</li>\n<li>鼠标悬停显示模块详细信息</li>\n</ul>\n</li>\n<li>\n<p><strong>问题检测</strong>   ：</p>\n<ul>\n<li>自动识别循环依赖并高亮显示</li>\n<li>检测冗余依赖(可以被其他依赖间接引入的依赖)</li>\n<li>统计模块大小帮助识别性能瓶颈</li>\n</ul>\n</li>\n<li>\n<p><strong>多格式报告</strong>   ：</p>\n<ul>\n<li>生成HTML可视化报告</li>\n<li>生成JSON格式原始数据供进一步分析</li>\n<li>控制台输出警告信息</li>\n</ul>\n</li>\n<li>\n<p><strong>灵活配置</strong>   ：</p>\n<ul>\n<li>可选择是否包含外部依赖(node_modules)</li>\n<li>可配置分析深度和显示选项</li>\n<li>支持过滤和聚焦特定模块</li>\n</ul>\n</li>\n<li>\n<p><strong>开发友好</strong>   ：</p>\n<ul>\n<li>清晰的视觉区分内部和外部模块</li>\n<li>交互式探索依赖关系</li>\n<li>直接定位问题依赖路径</li>\n</ul>\n</li>\n</ol>\n<h2>高级用法</h2>\n<h3>与Webpack Bundle Analyzer结合</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { visualizer } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;rollup-plugin-visualizer&quot;</span>;\n\n<span class="hljs-attr">plugins</span>: [\n  <span class="hljs-title function_">dependencyAnalyzer</span>(),\n  <span class="hljs-title function_">visualizer</span>({\n    <span class="hljs-attr">filename</span>: <span class="hljs-string">&quot;bundle-stats.html&quot;</span>,\n    <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Bundle Size Visualization&quot;</span>,\n  }),\n];\n</code></pre>\n<h3>自定义依赖过滤</h3>\n<pre><code class="language-javascript"><span class="hljs-title function_">dependencyAnalyzer</span>({\n  <span class="hljs-attr">filter</span>: <span class="hljs-function">(<span class="hljs-params">moduleId</span>) =&gt;</span> {\n    <span class="hljs-comment">// 只分析src目录下的模块</span>\n    <span class="hljs-keyword">return</span> moduleId.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;/src/&quot;</span>) &amp;&amp; !moduleId.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;/test/&quot;</span>);\n  },\n});\n</code></pre>\n<h3>生成Graphviz DOT文件</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在_generateReports方法中添加</span>\n<span class="hljs-title function_">_writeDotFile</span>(<span class="hljs-params">report</span>) {\n  <span class="hljs-keyword">let</span> dot = <span class="hljs-string">&#x27;digraph G {\\n&#x27;</span>;\n  dot += <span class="hljs-string">&#x27;  node [shape=box, style=&quot;rounded,filled&quot;, fillcolor=&quot;#ffffff&quot;];\\n&#x27;</span>;\n\n  report.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> {\n    <span class="hljs-keyword">const</span> isExternal = node.<span class="hljs-property">id</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;node_modules&#x27;</span>);\n    dot += <span class="hljs-string">`  &quot;<span class="hljs-subst">${node.id}</span>&quot; [fillcolor=&quot;<span class="hljs-subst">${isExternal ? <span class="hljs-string">&#x27;#f0f0f0&#x27;</span> : <span class="hljs-string">&#x27;#ffffff&#x27;</span>}</span>&quot;];\\n`</span>;\n  });\n\n  report.<span class="hljs-property">links</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">link</span> =&gt;</span> {\n    <span class="hljs-keyword">const</span> [source, target] = link.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27; -&gt; &#x27;</span>);\n    dot += <span class="hljs-string">`  &quot;<span class="hljs-subst">${source}</span>&quot; -&gt; &quot;<span class="hljs-subst">${target}</span>&quot;;\\n`</span>;\n  });\n\n  dot += <span class="hljs-string">&#x27;}&#x27;</span>;\n\n  <span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">&#x27;dependency-graph.dot&#x27;</span>, dot);\n}\n</code></pre>\n<h3>集成到CI流程</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在CI环境中生成简化报告</span>\n<span class="hljs-title function_">dependencyAnalyzer</span>({\n  <span class="hljs-attr">outputFile</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">CI</span> ? <span class="hljs-literal">null</span> : <span class="hljs-string">&quot;dependency-graph.html&quot;</span>,\n  <span class="hljs-attr">outputJson</span>: <span class="hljs-string">&quot;dependency-data.json&quot;</span>,\n  <span class="hljs-attr">onAnalysisComplete</span>: <span class="hljs-function">(<span class="hljs-params">report</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">CI</span> &amp;&amp; report.<span class="hljs-property">meta</span>.<span class="hljs-property">circularDependencies</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {\n      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;发现循环依赖，构建失败&quot;</span>);\n    }\n  },\n});\n</code></pre>\n<p>这个插件可以帮助你全面了解项目的依赖结构，识别潜在的问题依赖关系，优化项目的模块组织结构，最终提高构建性能和运行时性能。</p>\n</div>'</script></body></html>