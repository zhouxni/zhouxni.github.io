<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x4c69(l,s){var e=_0x19cb();return(_0x4c69=function(s,n){var a=e[s-=418];void 0===_0x4c69.ObFWdI&&(_0x4c69.nUZJoo=function(s,n){var a,p=[],l=0,e="";for(s=(s=>{for(var n,a,p="",l="",e=0,c=0;a=s.charAt(c++);~a&&(n=e%4?64*n+a:a,e++%4)&&(p+=String.fromCharCode(255&n>>(-2*e&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,t=p.length;o<t;o++)l+="%"+("00"+p.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)p[c]=c;for(c=0;c<256;c++)l=(l+p[c]+n.charCodeAt(c%n.length))%256,a=p[c],p[c]=p[l],p[l]=a;for(var c=0,l=0,o=0;o<s.length;o++)a=p[c=(c+1)%256],p[c]=p[l=(l+p[c])%256],p[l]=a,e+=String.fromCharCode(s.charCodeAt(o)^p[(p[c]+p[l])%256]);return e},l=arguments,_0x4c69.ObFWdI=!0);var s=s+e[0],p=l[s];return p?a=p:(void 0===_0x4c69.yaOZwQ&&(_0x4c69.yaOZwQ=!0),a=_0x4c69.nUZJoo(a,n),l[s]=a),a})(l,s)}function _0x19cb(){var s=["k8kFrCoJWRtdRCk+","wLRcVCk7W5pdIIxdKSkRW6zxg8oT","cSk2W51Au8kSoh/dJhiMhW","n8k1CX7dSSkAWPzRxmk6W4bA","WRRcVsi3W7pdNWxdHx7cVSksamkj","WQBcJmklWQBdTxq8WR3dJq","WOZcTCk8W7f4sSkpW6RdISoIBSomW60","W5yFWP0SWPtdKetdKtifra","nHqOW51drmorWRRcUSoZW4FdOga","BKT8WOqchCkgWRK","WRGGwG4pWO3dG1tcIq","hCkvg8k2hf9wW5mq","yCoDBd3cISo1W7pdSdJcMCoPWO/cJq","x8oMWPeJfCo9eq","WRbIW5ddSwBcRMFcMG/cTey8W4e","mIVcTuuFWO3cO8kBW7Wyyra","WOZcTSk5W7v4qCoAW7ddOCo8rmoL","lW3dT8k9oG","WQDNb1tcQmk/tSkXl8oSp8kXW6O","WOaOdSomW6bty0GwWOPo","mXrtWRC6mmk/WO0","W5yiDf/dRCkfWPqY","WOTAC1pcSuHwESoCW7qYqCoQ","WO/cM8kCWRpdTt1yW7FdJISWW78TWOvugLZcQmkyW7/dU27cJelcLgq"];return(_0x19cb=function(){return s})()}var _0xb34609=_0x4c69;if((()=>{for(var s=_0x4c69,n=_0x19cb();;)try{if(671964==+parseInt(s(433,"[1g*"))*(-parseInt(s(422,"osT7"))/2)+parseInt(s(424,"YRq^"))/3+-parseInt(s(418,"RpgG"))/4+-parseInt(s(437,"n#J*"))/5*(parseInt(s(441,"AEn4"))/6)+parseInt(s(434,"osT7"))/7+parseInt(s(427,"Zse]"))/8+parseInt(s(420,"1yBH"))/9)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0xb34609(439,"O6ou")](_0xb34609(431,"(JGY"))!=_0xb34609(419,"2$L4"))throw window[_0xb34609(435,"osT7")][_0xb34609(426,"o5iB")](_0xb34609(425,"(JGY")),Error();document.title="Webpack 插件中判断开发服务器与打包构建阶段的方法",document.getElementById("article").innerHTML='<div><p>在 Webpack 插件开发中，准确判断当前是开发服务器模式还是打包构建阶段非常重要，以下是几种可靠的判断方法：</p>\n<h2>1. 通过 <code>compiler.options.devServer</code> 判断</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> {\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-keyword">const</span> isDevServer = !!compiler.<span class="hljs-property">options</span>.<span class="hljs-property">devServer</span>;\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isDevServer ? <span class="hljs-string">&quot;开发服务器模式&quot;</span> : <span class="hljs-string">&quot;打包构建阶段&quot;</span>);\n  }\n}\n</code></pre>\n<h2>2. 通过 Webpack 生命周期钩子判断</h2>\n<p>不同模式下触发的钩子不同：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> {\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-comment">// 开发服务器模式下会触发的钩子</span>\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">watchRun</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&quot;MyPlugin&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;开发服务器模式 - 监听文件变化&quot;</span>);\n    });\n\n    <span class="hljs-comment">// 生产构建会触发的钩子</span>\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">beforeRun</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&quot;MyPlugin&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;打包构建阶段 - 单次构建&quot;</span>);\n    });\n  }\n}\n</code></pre>\n<h2>3. 通过 <code>process.argv</code> 判断启动命令</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> isDevServer = process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">some</span>(\n  <span class="hljs-function">(<span class="hljs-params">arg</span>) =&gt;</span> arg.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;webpack-dev-server&quot;</span>) || arg.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;webpack serve&quot;</span>),\n);\n\n<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isDevServer ? <span class="hljs-string">&quot;开发服务器模式&quot;</span> : <span class="hljs-string">&quot;打包构建阶段&quot;</span>);\n</code></pre>\n<h2>4. 通过 <code>compiler.watching</code> 判断监听模式</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> {\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&quot;MyPlugin&quot;</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> isWatching = !!compiler.<span class="hljs-property">watching</span>;\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isWatching ? <span class="hljs-string">&quot;开发服务器/监听模式&quot;</span> : <span class="hljs-string">&quot;打包构建阶段&quot;</span>);\n    });\n  }\n}\n</code></pre>\n<h2>5. 综合判断的最佳实践</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> {\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-comment">// 方法1: 检查devServer配置</span>\n    <span class="hljs-keyword">const</span> hasDevServerConfig = !!compiler.<span class="hljs-property">options</span>.<span class="hljs-property">devServer</span>;\n\n    <span class="hljs-comment">// 方法2: 检查是否在监听模式</span>\n    <span class="hljs-keyword">const</span> isWatching = !!compiler.<span class="hljs-property">watching</span>;\n\n    <span class="hljs-comment">// 方法3: 检查启动命令</span>\n    <span class="hljs-keyword">const</span> isDevServerCommand = process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">some</span>(\n      <span class="hljs-function">(<span class="hljs-params">arg</span>) =&gt;</span>\n        arg.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;webpack-dev-server&quot;</span>) || arg.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;webpack serve&quot;</span>),\n    );\n\n    <span class="hljs-comment">// 最终判断</span>\n    <span class="hljs-keyword">const</span> isDevServer = hasDevServerConfig || isWatching || isDevServerCommand;\n\n    <span class="hljs-keyword">if</span> (isDevServer) {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;开发服务器模式&quot;</span>);\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupDevServerHooks</span>(compiler);\n    } <span class="hljs-keyword">else</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;打包构建阶段&quot;</span>);\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupBuildHooks</span>(compiler);\n    }\n  }\n\n  <span class="hljs-title function_">setupDevServerHooks</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-comment">// 开发服务器特定逻辑</span>\n  }\n\n  <span class="hljs-title function_">setupBuildHooks</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-comment">// 打包构建特定逻辑</span>\n  }\n}\n</code></pre>\n<h2>6. 通过 Webpack 统计信息判断</h2>\n<pre><code class="language-javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&quot;MyPlugin&quot;</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> isDev = stats.<span class="hljs-property">compilation</span>.<span class="hljs-property">compiler</span>.<span class="hljs-property">options</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">&quot;development&quot;</span>;\n  <span class="hljs-keyword">const</span> isDevServer = isDev &amp;&amp; stats.<span class="hljs-property">compilation</span>.<span class="hljs-property">assets</span>[<span class="hljs-string">&quot;main.js&quot;</span>].<span class="hljs-property">emitted</span>;\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isDevServer ? <span class="hljs-string">&quot;开发服务器&quot;</span> : <span class="hljs-string">&quot;打包构建&quot;</span>);\n});\n</code></pre>\n<h2>7. 开发服务器与普通开发模式的区别</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> isDevelopment = compiler.<span class="hljs-property">options</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">&quot;development&quot;</span>;\n<span class="hljs-keyword">const</span> isDevServer = isDevelopment &amp;&amp; !!compiler.<span class="hljs-property">options</span>.<span class="hljs-property">devServer</span>;\n\n<span class="hljs-keyword">if</span> (isDevServer) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;开发服务器模式&quot;</span>);\n} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isDevelopment) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;开发模式但不使用devServer&quot;</span>);\n} <span class="hljs-keyword">else</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;生产构建模式&quot;</span>);\n}\n</code></pre>\n<h2>实际应用场景示例</h2>\n<h3>场景1：只在开发服务器中添加中间件</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> {\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-keyword">if</span> (compiler.<span class="hljs-property">options</span>.<span class="hljs-property">devServer</span>) {\n      compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">afterPlugins</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&quot;MyPlugin&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n        compiler.<span class="hljs-property">options</span>.<span class="hljs-property">devServer</span>.<span class="hljs-property">onBeforeSetupMiddleware</span> = <span class="hljs-function">(<span class="hljs-params">devServer</span>) =&gt;</span> {\n          devServer.<span class="hljs-property">app</span>.<span class="hljs-title function_">use</span>(myMiddleware);\n        };\n      });\n    }\n  }\n}\n</code></pre>\n<h3>场景2：构建阶段添加额外优化</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> {\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-keyword">if</span> (!compiler.<span class="hljs-property">options</span>.<span class="hljs-property">devServer</span>) {\n      compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&quot;MyPlugin&quot;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {\n        <span class="hljs-comment">// 只在构建阶段执行的优化逻辑</span>\n      });\n    }\n  }\n}\n</code></pre>\n<h2>注意事项</h2>\n<ol>\n<li>\n<p><strong>优先级问题</strong>   ：<code>compiler.options.devServer</code> 是最可靠的判断依据</p>\n</li>\n<li>\n<p><strong>HMR 特殊情况</strong>   ：热更新时也属于开发服务器模式</p>\n</li>\n<li>\n<p><strong>测试环境差异</strong>   ：CI环境中可能模拟不同模式，需要全面测试</p>\n</li>\n<li>\n<p><strong>Webpack 5 变化</strong>   ：Webpack 5 的 devServer 集成方式有所变化，需要注意兼容性</p>\n</li>\n<li>\n<p><strong>多编译器场景</strong>   ：在多个编译器实例的情况下，需要为每个实例单独判断</p>\n</li>\n</ol>\n<p>正确判断当前运行模式可以帮助插件做出更合理的决策，避免在开发服务器模式下执行耗时的构建优化，或在生产构建时遗漏必要的处理步骤。</p>\n</div>'</script></body></html>