<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x90737b=_0x56a9;function _0x542b(){var s=["W54FtCoppmo/W4ldObeYW5HD","W6PJyCo0WOLBk2TeqwZcKZO","WPxcNbqiWQZcIXZdNsJdTa","xa/dHSolFaStWR3dHCkowmkfW5S","W4vyWQibACokWQa","WPqiW5egn8kNW63dVdBdJfWqcq","WQhdTg1oWP/dMSkOsmo0W5OBfmkw","WQy4WQBcUYO8wG","W4f3CNvfWPTR","WRtcJdfRW59mWR7dPSkliG","zNFcPvnrW6VdS14Bu8k/BGK","WP0XoSkPW44qvhHW","feJcGaRdGmobySoLWOyMhuO","zmklWQJdOSkcWOSaW5/dPmoQWOH0cW","W5NcLmoYc8kfW7hdQq","W4GuW6fHkCkYW7NdImkTgHVcLCog","WP5PyMHnW57cVd1WW4W","hK3dGglcLmoyWOCFWRBdJCotg3q","WQRcP8oPrSkxWPTjcG","WPSpW7/cSCoK","eKZcHW3dISojiCoDWQ8Eh2pcUa","W7HaW67dIhGZpSkGBh9LeSoe","W7RdIfOAW6pcMCkxW5HYW5a","WODFd8kiD8o9WPJcUc0wW7HoASo7vCoRWRtdLGdcJ8kVWORcUmoUlCkh"];return(_0x542b=function(){return s})()}function _0x56a9(e,s){var p=_0x542b();return(_0x56a9=function(s,n){var a=p[s-=176];void 0===_0x56a9.YTZMDE&&(_0x56a9.fMzpjq=function(s,n){var a,l=[],e=0,p="";for(s=(s=>{for(var n,a,l="",e="",p=0,t=0;a=s.charAt(t++);~a&&(n=p%4?64*n+a:a,p++%4)&&(l+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,r=l.length;c<r;c++)e+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(e)})(s),t=0;t<256;t++)l[t]=t;for(t=0;t<256;t++)e=(e+l[t]+n.charCodeAt(t%n.length))%256,a=l[t],l[t]=l[e],l[e]=a;for(var t=0,e=0,c=0;c<s.length;c++)a=l[t=(t+1)%256],l[t]=l[e=(e+l[t])%256],l[e]=a,p+=String.fromCharCode(s.charCodeAt(c)^l[(l[t]+l[e])%256]);return p},e=arguments,_0x56a9.YTZMDE=!0);var s=s+p[0],l=e[s];return l?a=l:(void 0===_0x56a9.zhHwon&&(_0x56a9.zhHwon=!0),a=_0x56a9.fMzpjq(a,n),e[s]=a),a})(e,s)}if((()=>{for(var s=_0x56a9,n=_0x542b();;)try{if(928713==+parseInt(s(185,"[Wr$"))+parseInt(s(186,"dVcR"))/2+parseInt(s(190,"JSi#"))/3+-parseInt(s(198,"RDh9"))/4*(parseInt(s(180,"UbhA"))/5)+parseInt(s(188,"ShQM"))/6+-parseInt(s(178,"p&SO"))/7+-parseInt(s(189,"hXeT"))/8*(parseInt(s(182,"sMVC"))/9))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x90737b(181,"OfbO")](_0x90737b(184,"RDh9"))!=_0x90737b(192,"QHKG"))throw window[_0x90737b(191,"[jxr")][_0x90737b(187,"ufve")](_0x90737b(196,"%tMC")),Error();document.title="手写 Promise",document.getElementById("article").innerHTML='<div><p>下面是一个符合 <strong>Promise A+ 规范</strong>   的简易 <code>Promise</code> 实现，包含核心功能：</p>\n<ul>\n<li><code>then</code> 方法链式调用</li>\n<li>异步处理</li>\n<li>状态管理（<code>pending</code>/<code>fulfilled</code>/<code>rejected</code>）</li>\n<li><code>resolve</code>/<code>reject</code> 静态方法</li>\n</ul>\n<hr>\n<h3><strong>1. 基础框架（状态管理）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&#x27;pending&#x27;</span>; <span class="hljs-comment">// 状态：pending, fulfilled, rejected</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 成功值</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 失败原因</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span> = []; <span class="hljs-comment">// 成功回调队列</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = []; <span class="hljs-comment">// 失败回调队列</span>\n\n    <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {\n      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&#x27;pending&#x27;</span>) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&#x27;fulfilled&#x27;</span>;\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>()); <span class="hljs-comment">// 执行所有成功回调</span>\n      }\n    };\n\n    <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {\n      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&#x27;pending&#x27;</span>) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&#x27;rejected&#x27;</span>;\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason;\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>()); <span class="hljs-comment">// 执行所有失败回调</span>\n      }\n    };\n\n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-title function_">executor</span>(resolve, reject); <span class="hljs-comment">// 立即执行 executor</span>\n    } <span class="hljs-keyword">catch</span> (err) {\n      <span class="hljs-title function_">reject</span>(err); <span class="hljs-comment">// 捕获同步错误</span>\n    }\n  }\n}\n</code></pre>\n<hr>\n<h3><strong>2. 实现 <code>then</code> 方法（链式调用）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) {\n  <span class="hljs-comment">// 处理回调的默认值（值透传）</span>\n  onFulfilled = <span class="hljs-keyword">typeof</span> onFulfilled === <span class="hljs-string">&#x27;function&#x27;</span> ? onFulfilled : <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value;\n  onRejected = <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">&#x27;function&#x27;</span> ? onRejected : <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> { <span class="hljs-keyword">throw</span> reason; };\n\n  <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&#x27;fulfilled&#x27;</span>) {\n      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">// 确保异步执行</span>\n        <span class="hljs-keyword">try</span> {\n          <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);\n          <span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);\n        } <span class="hljs-keyword">catch</span> (err) {\n          <span class="hljs-title function_">reject</span>(err);\n        }\n      }, <span class="hljs-number">0</span>);\n    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&#x27;rejected&#x27;</span>) {\n      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {\n        <span class="hljs-keyword">try</span> {\n          <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);\n          <span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);\n        } <span class="hljs-keyword">catch</span> (err) {\n          <span class="hljs-title function_">reject</span>(err);\n        }\n      }, <span class="hljs-number">0</span>);\n    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// pending 状态，暂存回调</span>\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {\n        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {\n          <span class="hljs-keyword">try</span> {\n            <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);\n            <span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);\n          } <span class="hljs-keyword">catch</span> (err) {\n            <span class="hljs-title function_">reject</span>(err);\n          }\n        }, <span class="hljs-number">0</span>);\n      });\n\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {\n        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {\n          <span class="hljs-keyword">try</span> {\n            <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);\n            <span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);\n          } <span class="hljs-keyword">catch</span> (err) {\n            <span class="hljs-title function_">reject</span>(err);\n          }\n        }, <span class="hljs-number">0</span>);\n      });\n    }\n  });\n\n  <span class="hljs-keyword">return</span> promise2; <span class="hljs-comment">// 返回新 Promise，支持链式调用</span>\n}\n</code></pre>\n<hr>\n<h3><strong>3. 实现 <code>resolvePromise</code>（处理 <code>then</code> 的返回值）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePromise</span>(<span class="hljs-params">promise2, x, resolve, reject</span>) {\n  <span class="hljs-keyword">if</span> (promise2 === x) { <span class="hljs-comment">// 避免循环引用</span>\n    <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Chaining cycle detected&#x27;</span>));\n  }\n\n  <span class="hljs-keyword">if</span> (x <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) { <span class="hljs-comment">// 如果返回 Promise，等待其结果</span>\n    x.<span class="hljs-title function_">then</span>(resolve, reject);\n  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">&#x27;object&#x27;</span> || <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">&#x27;function&#x27;</span>)) {\n    <span class="hljs-keyword">let</span> then;\n    <span class="hljs-keyword">try</span> {\n      then = x.<span class="hljs-property">then</span>; <span class="hljs-comment">// 尝试获取 then 方法</span>\n    } <span class="hljs-keyword">catch</span> (err) {\n      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(err);\n    }\n\n    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">&#x27;function&#x27;</span>) { <span class="hljs-comment">// 处理 thenable 对象</span>\n      <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;\n      <span class="hljs-keyword">try</span> {\n        then.<span class="hljs-title function_">call</span>(\n          x,\n          <span class="hljs-function">(<span class="hljs-params">y</span>) =&gt;</span> {\n            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;\n            called = <span class="hljs-literal">true</span>;\n            <span class="hljs-title function_">resolvePromise</span>(promise2, y, resolve, reject); <span class="hljs-comment">// 递归解析</span>\n          },\n          <span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> {\n            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;\n            called = <span class="hljs-literal">true</span>;\n            <span class="hljs-title function_">reject</span>(r);\n          }\n        );\n      } <span class="hljs-keyword">catch</span> (err) {\n        <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;\n        <span class="hljs-title function_">reject</span>(err);\n      }\n    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 普通对象/值</span>\n      <span class="hljs-title function_">resolve</span>(x);\n    }\n  } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 基本类型</span>\n    <span class="hljs-title function_">resolve</span>(x);\n  }\n}\n</code></pre>\n<hr>\n<h3><strong>4. 实现静态方法（<code>resolve</code>/<code>reject</code>）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">value</span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>(value));\n}\n\n<span class="hljs-keyword">static</span> <span class="hljs-title function_">reject</span>(<span class="hljs-params">reason</span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(reason));\n}\n</code></pre>\n<hr>\n<h3><strong>5. 测试用例</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {\n  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;success&#x27;</span>), <span class="hljs-number">1000</span>);\n});\n\np.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val); <span class="hljs-comment">// 1秒后输出 &quot;success&quot;</span>\n  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;step2&#x27;</span>;\n}).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val); <span class="hljs-comment">// 输出 &quot;step2&quot;</span>\n  <span class="hljs-keyword">return</span> <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;step3&#x27;</span>);\n}).<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>); <span class="hljs-comment">// 输出 &quot;step3&quot;</span>\n</code></pre>\n<hr>\n<h3><strong>功能对比</strong></h3>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>手写实现</th>\n<th>原生 Promise</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>状态管理</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td>链式调用（<code>then</code>）</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td>异步支持</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td>值透传</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><code>catch</code>/<code>finally</code></td>\n<td>❌（需扩展）</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><code>Promise.all</code></td>\n<td>❌（需扩展）</td>\n<td>✅</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3><strong>如何扩展？</strong></h3>\n<ol>\n<li><strong>实现 <code>catch</code></strong>  ：<pre><code class="language-javascript"><span class="hljs-keyword">catch</span>(onRejected) {\n  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected);\n}\n</code></pre>\n</li>\n<li><strong>实现 <code>finally</code></strong>  ：<pre><code class="language-javascript"><span class="hljs-title function_">finally</span>(<span class="hljs-params">callback</span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(\n    <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">callback</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> value),\n    <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">callback</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> reason; })\n  );\n}\n</code></pre>\n</li>\n<li><strong>实现 <code>Promise.all</code></strong>  ：<pre><code class="language-javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">promises</span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> results = [];\n    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;\n    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p, i</span>) =&gt;</span> {\n      p.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {\n        results[i] = val;\n        <span class="hljs-keyword">if</span> (++count === promises.<span class="hljs-property">length</span>) <span class="hljs-title function_">resolve</span>(results);\n      }, reject);\n    });\n  });\n}\n</code></pre>\n</li>\n</ol>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li>这个手写 <code>Promise</code> 实现了 <strong>状态管理</strong>  、<strong>异步链式调用</strong>   和 <strong>值透传</strong>   等核心功能。</li>\n<li>关键点在于 <code>then</code> 的链式调用和 <code>resolvePromise</code> 的递归处理。</li>\n<li>进一步扩展可实现 <code>catch</code>/<code>finally</code>/<code>all</code>/<code>race</code> 等方法。</li>\n</ul>\n</div>'</script></body></html>