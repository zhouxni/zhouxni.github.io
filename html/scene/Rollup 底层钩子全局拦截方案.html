<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x1fcd(p,s){var t=_0x28b7();return(_0x1fcd=function(s,n){var a=t[s-=265];void 0===_0x1fcd.jJqaVC&&(_0x1fcd.sBwHHU=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,r=0;a=s.charAt(r++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,o=l.length;e<o;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),r=0;r<256;r++)l[r]=r;for(r=0;r<256;r++)p=(p+l[r]+n.charCodeAt(r%n.length))%256,a=l[r],l[r]=l[p],l[p]=a;for(var r=0,p=0,e=0;e<s.length;e++)a=l[r=(r+1)%256],l[r]=l[p=(p+l[r])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(e)^l[(l[r]+l[p])%256]);return t},p=arguments,_0x1fcd.jJqaVC=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x1fcd.hLLNqJ&&(_0x1fcd.hLLNqJ=!0),a=_0x1fcd.sBwHHU(a,n),p[s]=a),a})(p,s)}var _0x5d82e8=_0x1fcd;if((()=>{for(var s=_0x1fcd,n=_0x28b7();;)try{if(492113==-parseInt(s(284,")*#r"))*(parseInt(s(286,"9gU@"))/2)+parseInt(s(268,"KutJ"))/3+-parseInt(s(265,"hs#V"))/4*(-parseInt(s(290,"N&HC"))/5)+parseInt(s(279,"#CUb"))/6+parseInt(s(271,"Af5["))/7*(parseInt(s(277,"^PF)"))/8)+parseInt(s(274,"$YIP"))/9+-parseInt(s(269,"$IOq"))/10*(parseInt(s(270,"^PF)"))/11))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x5d82e8(272,"Af5[")](_0x5d82e8(285,"#CUb"))!=_0x5d82e8(273,"i6QY"))throw window[_0x5d82e8(275,"IlCF")][_0x5d82e8(281,"H)Ck")](_0x5d82e8(267,"IcWL")),Error();function _0x28b7(){var s=["W63dGqGoW6ddTLtcGK/dRW","W7dcHSkZW5mmW5FdKa","WOuTWQTyW53dUNhdK8kbnmoJW44","W5RdUCo5WONcPNrgohFcKX19WPm","W5lcImooW5JcSCodumk6tSoqfmkfbdVdVuqLW4L/WP3dQaRcNXngW5q","WQNcHmkFi8o+EmkrW7WSW5qyjHC","W57dMCobWR3cRx4Oga","W6JcTupcMmkPWQZdVHaPEXvYvqW","W4XbWO/cTf1haudcVmoMi8ocxG","WP0CW43dHb0vxq","WPZcTmk8W4pdQW","WP7dVIS4WRJdVcRdICoiWPBcGqqe","WOKVlSkgW5xdI8kGiq","WOP0smoxW63cNmoA","W6hdHrtdOSo3W6ZcKW","mKtcQSomv37dGrNcR8kBWOK/kG","aZ5OW4TomSoBW5dcKmkFW5VdIIi","z3RcPGNdNCkouSoNaKeVbIC+","WQFcLHTqkKag","W6hdGLOjFbuKWObEDIWs","kSoXW53cT8k1uH/dQW","WOKumCowW57dJmkN","CwW8WP8iECkOW43cHW","a8oiW73cVvhdIbDCWQlcLG","WQLjWPmtmmkdeSotW4yMwudcGa","W5nZFmowWPxcKCo/hdZdTCoXp8kh","jCo2nc3dQKlcJCo3","hgTWm8o+WPhdISoU"];return(_0x28b7=function(){return s})()}document.title="Rollup 底层钩子全局拦截方案",document.getElementById("article").innerHTML='<div><p>我理解您需要的是拦截 Rollup <strong>内部所有插件</strong>   的钩子执行，而不仅仅是当前插件的钩子。以下是几种实现全局底层钩子拦截的方案：</p>\n<h2>1. 基于 Rollup 内部插件系统的全局拦截</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> globalInterceptor = {\n  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;rollup-global-interceptor&quot;</span>,\n  <span class="hljs-comment">// 在构建开始时拦截所有插件</span>\n  <span class="hljs-title function_">options</span>(<span class="hljs-params">inputOptions</span>) {\n    <span class="hljs-keyword">const</span> originalPlugins = inputOptions.<span class="hljs-property">plugins</span> || [];\n\n    <span class="hljs-comment">// 包装所有插件</span>\n    <span class="hljs-keyword">const</span> wrappedPlugins = originalPlugins.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">plugin</span>) =&gt;</span> {\n      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> plugin !== <span class="hljs-string">&quot;object&quot;</span>) <span class="hljs-keyword">return</span> plugin;\n\n      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(plugin, {\n        <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {\n          <span class="hljs-comment">// 只拦截插件钩子方法</span>\n          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target[prop] === <span class="hljs-string">&quot;function&quot;</span> &amp;&amp; prop !== <span class="hljs-string">&quot;name&quot;</span>) {\n            <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {\n              <span class="hljs-keyword">const</span> pluginName = target.<span class="hljs-property">name</span> || <span class="hljs-string">&quot;anonymous-plugin&quot;</span>;\n              <span class="hljs-keyword">const</span> hookName = prop;\n              <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n\n              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[PRE] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span>`</span>, args);\n\n              <span class="hljs-keyword">try</span> {\n                <span class="hljs-keyword">const</span> result = target[prop].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);\n\n                <span class="hljs-keyword">if</span> (result &amp;&amp; <span class="hljs-keyword">typeof</span> result.<span class="hljs-property">then</span> === <span class="hljs-string">&quot;function&quot;</span>) {\n                  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {\n                    <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n                      <span class="hljs-string">`[POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n                      res,\n                    );\n                    <span class="hljs-keyword">return</span> res;\n                  });\n                }\n\n                <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n                  <span class="hljs-string">`[POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n                  result,\n                );\n                <span class="hljs-keyword">return</span> result;\n              } <span class="hljs-keyword">catch</span> (err) {\n                <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(\n                  <span class="hljs-string">`[ERROR] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> failed after <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n                  err,\n                );\n                <span class="hljs-keyword">throw</span> err;\n              }\n            };\n          }\n          <span class="hljs-keyword">return</span> target[prop];\n        },\n      });\n    });\n\n    <span class="hljs-keyword">return</span> { ...inputOptions, <span class="hljs-attr">plugins</span>: wrappedPlugins };\n  },\n};\n</code></pre>\n<h2>2. 修改 Rollup 内部插件处理器（高级）</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> deepInterceptor = {\n  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;rollup-deep-interceptor&quot;</span>,\n  <span class="hljs-title function_">buildStart</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 获取 Rollup 内部插件处理器</span>\n    <span class="hljs-keyword">const</span> pluginDriver = <span class="hljs-variable language_">this</span>.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>;\n\n    <span class="hljs-comment">// 保存原始方法</span>\n    <span class="hljs-keyword">const</span> originalHook = pluginDriver.<span class="hljs-property">hook</span>;\n\n    <span class="hljs-comment">// 重写插件处理器</span>\n    pluginDriver.<span class="hljs-property">hook</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">hookName, hookFn, ...args</span>) {\n      <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n      <span class="hljs-keyword">const</span> pluginName = <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugin</span>.<span class="hljs-property">name</span> || <span class="hljs-string">&quot;anonymous-plugin&quot;</span>;\n\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[DEEP PRE] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span>`</span>, args);\n\n      <span class="hljs-keyword">try</span> {\n        <span class="hljs-keyword">const</span> result = originalHook.<span class="hljs-title function_">call</span>(\n          <span class="hljs-variable language_">this</span>,\n          hookName,\n          <span class="hljs-function">(<span class="hljs-params">...innerArgs</span>) =&gt;</span> {\n            <span class="hljs-keyword">const</span> innerStart = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n            <span class="hljs-keyword">const</span> innerResult = hookFn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, innerArgs);\n\n            <span class="hljs-keyword">if</span> (innerResult &amp;&amp; <span class="hljs-keyword">typeof</span> innerResult.<span class="hljs-property">then</span> === <span class="hljs-string">&quot;function&quot;</span>) {\n              <span class="hljs-keyword">return</span> innerResult.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {\n                <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - innerStart;\n                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n                  <span class="hljs-string">`[DEEP INNER POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n                  res,\n                );\n                <span class="hljs-keyword">return</span> res;\n              });\n            }\n\n            <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - innerStart;\n            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n              <span class="hljs-string">`[DEEP INNER POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n              innerResult,\n            );\n            <span class="hljs-keyword">return</span> innerResult;\n          },\n          ...args,\n        );\n\n        <span class="hljs-keyword">if</span> (result &amp;&amp; <span class="hljs-keyword">typeof</span> result.<span class="hljs-property">then</span> === <span class="hljs-string">&quot;function&quot;</span>) {\n          <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {\n            <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n              <span class="hljs-string">`[DEEP POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n              res,\n            );\n            <span class="hljs-keyword">return</span> res;\n          });\n        }\n\n        <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n          <span class="hljs-string">`[DEEP POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n          result,\n        );\n        <span class="hljs-keyword">return</span> result;\n      } <span class="hljs-keyword">catch</span> (err) {\n        <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(\n          <span class="hljs-string">`[DEEP ERROR] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> failed after <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n          err,\n        );\n        <span class="hljs-keyword">throw</span> err;\n      }\n    };\n  },\n};\n</code></pre>\n<h2>3. 使用 Rollup 的插件上下文方法（Rollup 3+）</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> contextAwareInterceptor = {\n  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;context-aware-interceptor&quot;</span>,\n  <span class="hljs-title function_">buildStart</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// Rollup 3+ 提供了访问插件上下文的方法</span>\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">rollupVersion</span> &gt;= <span class="hljs-string">&quot;3.0.0&quot;</span>) {\n      <span class="hljs-comment">// 拦截所有后续插件的钩子</span>\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resolveOriginalHook</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">hookName</span>) {\n        <span class="hljs-keyword">const</span> original = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_originalHooks</span>[hookName];\n        <span class="hljs-keyword">if</span> (!original) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n\n        <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {\n          <span class="hljs-keyword">const</span> pluginName = <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> || <span class="hljs-string">&quot;anonymous-plugin&quot;</span>;\n          <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[CTX PRE] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span>`</span>, args);\n\n          <span class="hljs-keyword">try</span> {\n            <span class="hljs-keyword">const</span> result = original.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);\n\n            <span class="hljs-keyword">if</span> (result &amp;&amp; <span class="hljs-keyword">typeof</span> result.<span class="hljs-property">then</span> === <span class="hljs-string">&quot;function&quot;</span>) {\n              <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {\n                <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n                  <span class="hljs-string">`[CTX POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n                  res,\n                );\n                <span class="hljs-keyword">return</span> res;\n              });\n            }\n\n            <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n              <span class="hljs-string">`[CTX POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n              result,\n            );\n            <span class="hljs-keyword">return</span> result;\n          } <span class="hljs-keyword">catch</span> (err) {\n            <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(\n              <span class="hljs-string">`[CTX ERROR] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> failed after <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n              err,\n            );\n            <span class="hljs-keyword">throw</span> err;\n          }\n        };\n      };\n    }\n  },\n};\n</code></pre>\n<h2>4. 终极方案：Hook Rollup 的模块加载系统</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> originalRequire = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;module&quot;</span>).<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">require</span>;\n\n<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;module&quot;</span>).<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">require</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">hijackedRequire</span>(<span class="hljs-params">path</span>) {\n  <span class="hljs-keyword">if</span> (path === <span class="hljs-string">&quot;rollup&quot;</span>) {\n    <span class="hljs-keyword">const</span> rollup = originalRequire.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);\n\n    <span class="hljs-comment">// 拦截 Rollup 内部 PluginDriver</span>\n    <span class="hljs-keyword">const</span> originalBuild = rollup.<span class="hljs-property">rollup</span>;\n    rollup.<span class="hljs-property">rollup</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">options</span>) {\n      <span class="hljs-keyword">const</span> originalPlugins = options.<span class="hljs-property">plugins</span> || [];\n\n      options.<span class="hljs-property">plugins</span> = originalPlugins.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">plugin</span>) =&gt;</span> {\n        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> plugin !== <span class="hljs-string">&quot;object&quot;</span>) <span class="hljs-keyword">return</span> plugin;\n\n        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(plugin, {\n          <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {\n            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target[prop] === <span class="hljs-string">&quot;function&quot;</span> &amp;&amp; prop !== <span class="hljs-string">&quot;name&quot;</span>) {\n              <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {\n                <span class="hljs-keyword">const</span> pluginName = target.<span class="hljs-property">name</span> || <span class="hljs-string">&quot;anonymous-plugin&quot;</span>;\n                <span class="hljs-keyword">const</span> hookName = prop;\n                <span class="hljs-keyword">const</span> start = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>();\n\n                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[HOOK PRE] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span>`</span>, args);\n\n                <span class="hljs-keyword">try</span> {\n                  <span class="hljs-keyword">const</span> result = target[prop].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);\n\n                  <span class="hljs-keyword">if</span> (result &amp;&amp; <span class="hljs-keyword">typeof</span> result.<span class="hljs-property">then</span> === <span class="hljs-string">&quot;function&quot;</span>) {\n                    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {\n                      <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n                      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n                        <span class="hljs-string">`[HOOK POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n                        res,\n                      );\n                      <span class="hljs-keyword">return</span> res;\n                    });\n                  }\n\n                  <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n                    <span class="hljs-string">`[HOOK POST] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> completed in <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n                    result,\n                  );\n                  <span class="hljs-keyword">return</span> result;\n                } <span class="hljs-keyword">catch</span> (err) {\n                  <span class="hljs-keyword">const</span> duration = process.<span class="hljs-property">hrtime</span>.<span class="hljs-title function_">bigint</span>() - start;\n                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(\n                    <span class="hljs-string">`[HOOK ERROR] <span class="hljs-subst">${pluginName}</span>.<span class="hljs-subst">${hookName}</span> failed after <span class="hljs-subst">${<span class="hljs-built_in">Number</span>(duration) / <span class="hljs-number">1e6</span>}</span>ms`</span>,\n                    err,\n                  );\n                  <span class="hljs-keyword">throw</span> err;\n                }\n              };\n            }\n            <span class="hljs-keyword">return</span> target[prop];\n          },\n        });\n      });\n\n      <span class="hljs-keyword">return</span> originalBuild.<span class="hljs-title function_">call</span>(rollup, options);\n    };\n\n    <span class="hljs-keyword">return</span> rollup;\n  }\n  <span class="hljs-keyword">return</span> originalRequire.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);\n};\n\n<span class="hljs-comment">// 必须作为第一个加载的模块</span>\n<span class="hljs-keyword">const</span> interceptorPlugin = {\n  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;module-hijack-interceptor&quot;</span>,\n  <span class="hljs-comment">// 空实现，实际的拦截已经在模块加载时完成</span>\n};\n</code></pre>\n<h2>使用注意事项</h2>\n<ol>\n<li>\n<p><strong>执行顺序</strong>   ：</p>\n<ul>\n<li>全局拦截器必须作为第一个插件加载</li>\n<li>在 rollup.config.js 的 plugins 数组中最先声明</li>\n</ul>\n</li>\n<li>\n<p><strong>版本兼容性</strong>   ：</p>\n<ul>\n<li>方案2和方案3需要 Rollup 3+</li>\n<li>方案4是最彻底但也最具侵入性的方案</li>\n</ul>\n</li>\n<li>\n<p><strong>生产环境</strong>   ：</p>\n<ul>\n<li>建议通过环境变量控制是否启用</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&quot;development&quot;</span>) {\n  plugins.<span class="hljs-title function_">unshift</span>(globalInterceptor);\n}\n</code></pre>\n</li>\n<li>\n<p><strong>性能影响</strong>   ：</p>\n<ul>\n<li>深度拦截会增加构建时间</li>\n<li>建议添加过滤条件，只监控特定插件或钩子</li>\n</ul>\n</li>\n</ol>\n<p>这些方案提供了从外部包装到内部 Hook 的不同层次的 Rollup 全局拦截能力，您可以根据需要选择适合的拦截深度。</p>\n</div>'</script></body></html>