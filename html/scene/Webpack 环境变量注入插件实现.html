<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x4a97c2=_0x167f;function _0x2b75(){var s=["W7ZdPuXFW5xcSNe","q8oEEZRcRsG1WP4PW5CTma","uSocW41+W7WzBsLD","mSkimJFdM8oGCW","WQKeW6VcKq7dUtpcP8oV","W4JcSIygWODKWRiIlmoDWOTh","lbZdUmo1W5anWQ8fWOldTq86W5W","W6HfWQ/cQWq","WQhcVcy0W47dJSkIFCkx","WPq1W6hdOsyXDHnEsCkrWRW","WRhdTSoRt8o4WPBdHba","e8oPW4RdTSoYpCogWONdOGtcJq","cCoQWP7dNJ/cOSoq","WORdUqPBW5xdLCoUkHNdGNna","ofBdM8k8o8kBW4GwBNf3","xCoxWPDWpKpdICoZiwj5WQSB","W6NcJmo/W6VcUmo0tZnUrmoZW5pcVG","cghdLuNcKutdT0xcTSodWPhdOWbpWRThaSoBWR3cJCkZW5mdW6bRha","WPPJihdcQqvgBqeDW4ddTq","dJe2sSk+hmkAc8knpf0d","qJZdRCokAIFdQG","BSkgDmkipeddK8ktWOLmWQHvyG","kbtdU8oYW5bUW6mbWRFdOcW","tCouWOZdTmoKn8kPbmoTlby","vh3dUwNcHdVcJW","W6ldRwerW5ZdVCkx"];return(_0x2b75=function(){return s})()}function _0x167f(p,s){var t=_0x2b75();return(_0x167f=function(s,n){var a=t[s-=233];void 0===_0x167f.iJAoap&&(_0x167f.CWoMMt=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=l.length;c<o;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,c=0;c<s.length;c++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x167f.iJAoap=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x167f.RhmWwv&&(_0x167f.RhmWwv=!0),a=_0x167f.CWoMMt(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x167f,n=_0x2b75();;)try{if(101449==-parseInt(s(236,"buUt"))+-parseInt(s(245,"fzMS"))/2+parseInt(s(238,"ogtp"))/3*(parseInt(s(247,"GKrq"))/4)+-parseInt(s(256,"s(S^"))/5*(parseInt(s(254,"#6BX"))/6)+-parseInt(s(235,"Zr$f"))/7*(-parseInt(s(250,"Z7KL"))/8)+-parseInt(s(242,"P3Zc"))/9+parseInt(s(248,"kAjX"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x4a97c2(239,"3%Ro")](_0x4a97c2(255,"0EX$"))!=_0x4a97c2(234,"ud&D"))throw window[_0x4a97c2(237,"mH8v")][_0x4a97c2(252,"Zr$f")](_0x4a97c2(244,"Yetw")),Error();document.title="Webpack 环境变量注入插件实现",document.getElementById("article").innerHTML='<div><p>下面是一个实现 Webpack 环境变量注入插件的完整代码，该插件可以根据不同环境（开发/生产/测试等）自动注入对应的环境变量，无需手动修改配置文件。</p>\n<h2>插件代码</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">DefinePlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;webpack&quot;</span>);\n<span class="hljs-keyword">const</span> dotenv = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;dotenv&quot;</span>);\n<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;fs&quot;</span>);\n<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;path&quot;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">EnvInjectionPlugin</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {\n      <span class="hljs-attr">envFile</span>: <span class="hljs-string">&quot;.env&quot;</span>,\n      <span class="hljs-attr">prefix</span>: <span class="hljs-string">&quot;APP_&quot;</span>,\n      <span class="hljs-attr">definePrefix</span>: <span class="hljs-string">&quot;process.env.&quot;</span>,\n      <span class="hljs-attr">expand</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">systemvars</span>: <span class="hljs-literal">true</span>,\n      ...options,\n    };\n  }\n\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-comment">// 确定当前环境</span>\n    <span class="hljs-keyword">const</span> env = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getEnvironment</span>(compiler.<span class="hljs-property">options</span>.<span class="hljs-property">mode</span>);\n\n    <span class="hljs-comment">// 加载环境变量</span>\n    <span class="hljs-keyword">const</span> envVars = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadEnvVariables</span>(env);\n\n    <span class="hljs-comment">// 转换变量为DefinePlugin需要的格式</span>\n    <span class="hljs-keyword">const</span> defineVars = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transformVars</span>(envVars);\n\n    <span class="hljs-comment">// 应用DefinePlugin</span>\n    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefinePlugin</span>(defineVars).<span class="hljs-title function_">apply</span>(compiler);\n\n    <span class="hljs-comment">// 生成类型声明文件（可选）</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateTypeDeclarations</span>(envVars);\n  }\n\n  <span class="hljs-title function_">getEnvironment</span>(<span class="hljs-params">mode</span>) {\n    <span class="hljs-comment">// 从NODE_ENV或webpack的mode参数获取环境</span>\n    <span class="hljs-keyword">return</span> process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> || mode || <span class="hljs-string">&quot;development&quot;</span>;\n  }\n\n  <span class="hljs-title function_">loadEnvVariables</span>(<span class="hljs-params">env</span>) {\n    <span class="hljs-keyword">const</span> envDir = process.<span class="hljs-title function_">cwd</span>();\n    <span class="hljs-keyword">const</span> baseEnvPath = path.<span class="hljs-title function_">join</span>(envDir, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">envFile</span>);\n    <span class="hljs-keyword">const</span> envPath = path.<span class="hljs-title function_">join</span>(envDir, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.options.envFile}</span>.<span class="hljs-subst">${env}</span>`</span>);\n\n    <span class="hljs-comment">// 加载基础.env文件和特定环境的.env文件</span>\n    <span class="hljs-keyword">const</span> envConfig = {\n      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadDotenvFile</span>(baseEnvPath),\n      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadDotenvFile</span>(envPath),\n      ...(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">systemvars</span> ? process.<span class="hljs-property">env</span> : {}),\n    };\n\n    <span class="hljs-comment">// 过滤出带有指定前缀的变量</span>\n    <span class="hljs-keyword">const</span> filteredVars = {};\n    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> envConfig) {\n      <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">prefix</span>)) {\n        filteredVars[key] = envConfig[key];\n      }\n    }\n\n    <span class="hljs-keyword">return</span> filteredVars;\n  }\n\n  <span class="hljs-title function_">loadDotenvFile</span>(<span class="hljs-params">filePath</span>) {\n    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">existsSync</span>(filePath)) {\n      <span class="hljs-keyword">return</span> (\n        dotenv.<span class="hljs-title function_">config</span>({ <span class="hljs-attr">path</span>: filePath, <span class="hljs-attr">expand</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">expand</span> }).<span class="hljs-property">parsed</span> ||\n        {}\n      );\n    }\n    <span class="hljs-keyword">return</span> {};\n  }\n\n  <span class="hljs-title function_">transformVars</span>(<span class="hljs-params">envVars</span>) {\n    <span class="hljs-keyword">const</span> result = {};\n    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> envVars) {\n      <span class="hljs-comment">// 将环境变量转换为DefinePlugin需要的格式</span>\n      <span class="hljs-keyword">const</span> defineKey = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.options.definePrefix}</span><span class="hljs-subst">${key}</span>`</span>;\n\n      <span class="hljs-comment">// 尝试解析JSON字符串，如果不是JSON则直接使用字符串值</span>\n      <span class="hljs-keyword">try</span> {\n        result[defineKey] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(envVars[key]);\n      } <span class="hljs-keyword">catch</span> (e) {\n        result[defineKey] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(envVars[key]);\n      }\n    }\n\n    <span class="hljs-comment">// 添加环境标识</span>\n    result[<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.options.definePrefix}</span>NODE_ENV`</span>] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(\n      process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span>,\n    );\n\n    <span class="hljs-keyword">return</span> result;\n  }\n\n  <span class="hljs-title function_">generateTypeDeclarations</span>(<span class="hljs-params">envVars</span>) {\n    <span class="hljs-keyword">const</span> typeDeclarations = [];\n    typeDeclarations.<span class="hljs-title function_">push</span>(<span class="hljs-string">&quot;// Auto-generated environment variable types&quot;</span>);\n    typeDeclarations.<span class="hljs-title function_">push</span>(<span class="hljs-string">&quot;declare namespace NodeJS {&quot;</span>);\n    typeDeclarations.<span class="hljs-title function_">push</span>(<span class="hljs-string">&quot;  interface ProcessEnv {&quot;</span>);\n\n    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> envVars) {\n      typeDeclarations.<span class="hljs-title function_">push</span>(<span class="hljs-string">`    <span class="hljs-subst">${key}</span>: string;`</span>);\n    }\n\n    typeDeclarations.<span class="hljs-title function_">push</span>(<span class="hljs-string">&quot;  }&quot;</span>);\n    typeDeclarations.<span class="hljs-title function_">push</span>(<span class="hljs-string">&quot;}&quot;</span>);\n\n    <span class="hljs-keyword">const</span> outputPath = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">&quot;env.d.ts&quot;</span>);\n    fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, typeDeclarations.<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;\\n&quot;</span>));\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">EnvInjectionPlugin</span>;\n</code></pre>\n<h2>使用示例</h2>\n<p>在 webpack 配置中使用该插件：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">EnvInjectionPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./EnvInjectionPlugin&quot;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">env, argv</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-comment">// ...其他webpack配置</span>\n    <span class="hljs-attr">plugins</span>: [\n      <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnvInjectionPlugin</span>({\n        <span class="hljs-attr">envFile</span>: <span class="hljs-string">&quot;.env&quot;</span>, <span class="hljs-comment">// 基础环境文件</span>\n        <span class="hljs-attr">prefix</span>: <span class="hljs-string">&quot;APP_&quot;</span>, <span class="hljs-comment">// 只注入以APP_开头的变量</span>\n        <span class="hljs-attr">definePrefix</span>: <span class="hljs-string">&quot;process.env.&quot;</span>, <span class="hljs-comment">// 定义变量的前缀</span>\n        <span class="hljs-attr">expand</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否展开变量</span>\n        <span class="hljs-attr">systemvars</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否包含系统环境变量</span>\n      }),\n    ],\n  };\n};\n</code></pre>\n<h2>环境文件示例</h2>\n<p><code>.env</code> (基础环境变量):</p>\n<pre><code>APP_NAME=MyApplication\nAPP_VERSION=1.0.0\n</code></pre>\n<p><code>.env.development</code> (开发环境):</p>\n<pre><code>APP_API_BASE=http://localhost:3000/api\nAPP_DEBUG=true\n</code></pre>\n<p><code>.env.production</code> (生产环境):</p>\n<pre><code>APP_API_BASE=https://api.example.com\nAPP_DEBUG=false\n</code></pre>\n<h2>功能说明</h2>\n<ol>\n<li>\n<p><strong>多环境支持</strong>   ：</p>\n<ul>\n<li>自动根据NODE_ENV或webpack mode加载对应环境变量</li>\n<li>支持基础.env文件和特定环境的.env文件合并</li>\n</ul>\n</li>\n<li>\n<p><strong>变量过滤</strong>   ：</p>\n<ul>\n<li>只注入指定前缀的环境变量（默认APP_）</li>\n<li>避免注入不必要的系统环境变量</li>\n</ul>\n</li>\n<li>\n<p><strong>类型安全</strong>   ：</p>\n<ul>\n<li>自动生成TypeScript类型声明文件（env.d.ts）</li>\n<li>支持在TypeScript项目中获得环境变量的类型提示</li>\n</ul>\n</li>\n<li>\n<p><strong>变量扩展</strong>   ：</p>\n<ul>\n<li>支持.env文件中的变量扩展（如BASE_URL=/api，API_URL=${BASE_URL}/v1）</li>\n</ul>\n</li>\n<li>\n<p><strong>与Webpack DefinePlugin集成</strong>   ：</p>\n<ul>\n<li>将环境变量转换为webpack DefinePlugin需要的格式</li>\n<li>支持JSON值自动解析</li>\n</ul>\n</li>\n</ol>\n<h2>高级用法</h2>\n<ol>\n<li><strong>自定义变量前缀</strong>   ：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">EnvInjectionPlugin</span>({\n  <span class="hljs-attr">prefix</span>: <span class="hljs-string">&quot;MY_APP_&quot;</span>, <span class="hljs-comment">// 只注入MY_APP_开头的变量</span>\n});\n</code></pre>\n<ol start="2">\n<li><strong>禁用系统变量</strong>   ：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">EnvInjectionPlugin</span>({\n  <span class="hljs-attr">systemvars</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 不注入系统环境变量</span>\n});\n</code></pre>\n<ol start="3">\n<li><strong>自定义类型声明文件路径</strong>   ：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">EnvInjectionPlugin</span>({\n  <span class="hljs-attr">onGenerateTypes</span>: <span class="hljs-function">(<span class="hljs-params">declarations</span>) =&gt;</span> {\n    fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">&quot;./types/env.d.ts&quot;</span>, declarations);\n  },\n});\n</code></pre>\n<h2>注意事项</h2>\n<ol>\n<li>确保.env文件不被提交到版本控制（添加到.gitignore）</li>\n<li>敏感信息应使用环境变量而非硬编码在配置文件中</li>\n<li>在CI/CD环境中，可以直接设置系统环境变量</li>\n<li>生产环境变量应严格管理访问权限</li>\n</ol>\n<p>这个插件可以帮助开发者轻松管理多环境配置，提高应用的安全性，同时为TypeScript项目提供更好的类型支持。</p>\n</div>'</script></body></html>