<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0xcd21(p,s){var t=_0x1132();return(_0xcd21=function(s,n){var a=t[s-=199];void 0===_0xcd21.SQdwfA&&(_0xcd21.Ovhiem=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=l.length;c<o;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,c=0;c<s.length;c++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[p])%256]);return t},p=arguments,_0xcd21.SQdwfA=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0xcd21.OBAIZV&&(_0xcd21.OBAIZV=!0),a=_0xcd21.Ovhiem(a,n),p[s]=a),a})(p,s)}var _0x851cd3=_0xcd21;if((()=>{for(var s=_0xcd21,n=_0x1132();;)try{if(606366==+parseInt(s(219,"Mz7H"))*(-parseInt(s(203,"qA6*"))/2)+parseInt(s(224,"OeFT"))/3+-parseInt(s(214,"pt#K"))/4+-parseInt(s(206,"RyeH"))/5*(-parseInt(s(200,"u@p9"))/6)+parseInt(s(217,"DQeD"))/7+-parseInt(s(205,"TllB"))/8*(parseInt(s(220,"GU[o"))/9)+parseInt(s(210,"T7Ql"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x851cd3(209,"rSXw")](_0x851cd3(213,"DQeD"))!=_0x851cd3(204,"8m#s"))throw window[_0x851cd3(222,"arSy")][_0x851cd3(201,"QX@i")](_0x851cd3(223,"u9tG")),Error();function _0x1132(){var s=["WPuhatNcGqbPoW","phpdP2eGcJtdK8kNW79WaW","EmoHWRNcRLxdJGlcGIm","waa6umkisGZdRCoSWR9Zbcy","W6dcU8khuhHoq8od","WP3cO8ojW6JcTCoUWRxdQSoDWQWLWOlcUmoFWOmqeSk9W6VcLcFdH2/dKXRcKq","z8kyD8o6W4RcN1mmb3BdRCov","W4H7W5aOB0XPqCouk8o7WQS","eCoTWOhcTCkRgZ7cRbWsW7rM","WOSCWQ/cUmkuWQRcOa","WQtdN8oNWRbTpvrRnx10ta","WRRcUHddMSk/jtO","raldLsnT","mJtdSxXcW6FcKCoIENHNWPy","WRXyW7ddL8ofwSkmW6e","emoHWO/cVmkTh37dRW0NW55OW5ddMq","p8oiWQlcO8kNisW","W4nsiGRcPZfr","W5VcK8kcic4BjmkoWQtdHCoSW77dH8kO","oxddOwSLcsZdUSkLW7PYjG","yCooW6yKnc0hW4/dICk1a0NcLG","W7P0iSkhW6bjWPnKW6G","W4H7W5KNBK0Rz8oQn8ojWPhcQG","phZdRZnGFJldGCku","W7GNaxdcJYvkWPNdLSoAWQHV","WOOMDmowWQSlW6LKW53dHaBdIeW"];return(_0x1132=function(){return s})()}document.title="Webpack 依赖分析插件实现",document.getElementById("article").innerHTML='<div><p>下面是一个实现 Webpack 依赖分析插件的完整代码，该插件可以分析项目依赖关系，生成可视化的依赖图谱，并帮助识别冗余依赖和循环依赖。</p>\n<h2>插件代码</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;fs&quot;</span>);\n<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;path&quot;</span>);\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">ModuleGraph</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;webpack&quot;</span>);\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">CircularDependencyPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;circular-dependency-plugin&quot;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">DependencyAnalyzerPlugin</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {\n      <span class="hljs-attr">filename</span>: <span class="hljs-string">&quot;dependency-report.json&quot;</span>,\n      <span class="hljs-attr">outputPath</span>: path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">&quot;reports&quot;</span>),\n      <span class="hljs-attr">analyzeCircular</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">analyzeRedundant</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">analyzeDepth</span>: <span class="hljs-number">3</span>,\n      <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,\n      ...options,\n    };\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span> = {};\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">circularDependencies</span> = [];\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">redundantDependencies</span> = [];\n  }\n\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-comment">// 确保输出目录存在</span>\n    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">outputPath</span>)) {\n      fs.<span class="hljs-title function_">mkdirSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">outputPath</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });\n    }\n\n    <span class="hljs-comment">// 收集依赖信息</span>\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(\n      <span class="hljs-string">&quot;DependencyAnalyzerPlugin&quot;</span>,\n      <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {\n        compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">finishModules</span>.<span class="hljs-title function_">tap</span>(\n          <span class="hljs-string">&quot;DependencyAnalyzerPlugin&quot;</span>,\n          <span class="hljs-function">(<span class="hljs-params">modules</span>) =&gt;</span> {\n            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildDependencyGraph</span>(compilation.<span class="hljs-property">moduleGraph</span>, modules);\n          },\n        );\n      },\n    );\n\n    <span class="hljs-comment">// 分析循环依赖</span>\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">analyzeCircular</span>) {\n      <span class="hljs-keyword">new</span> <span class="hljs-title class_">CircularDependencyPlugin</span>({\n        <span class="hljs-attr">exclude</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">exclude</span>,\n        <span class="hljs-attr">onDetected</span>: <span class="hljs-function">(<span class="hljs-params">{ paths, compilation }</span>) =&gt;</span> {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-property">circularDependencies</span>.<span class="hljs-title function_">push</span>(paths);\n        },\n      }).<span class="hljs-title function_">apply</span>(compiler);\n    }\n\n    <span class="hljs-comment">// 生成最终报告</span>\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&quot;DependencyAnalyzerPlugin&quot;</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {\n      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">analyzeRedundant</span>) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeRedundantDependencies</span>();\n      }\n\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateReport</span>(stats);\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateVisualization</span>();\n    });\n  }\n\n  <span class="hljs-title function_">buildDependencyGraph</span>(<span class="hljs-params">moduleGraph, modules</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span> = {};\n\n    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> <span class="hljs-keyword">of</span> modules) {\n      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">exclude</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">exclude</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">resource</span>)) {\n        <span class="hljs-keyword">continue</span>;\n      }\n\n      <span class="hljs-keyword">const</span> modulePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getModulePath</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">resource</span>);\n      <span class="hljs-keyword">if</span> (!modulePath) <span class="hljs-keyword">continue</span>;\n\n      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[modulePath]) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[modulePath] = {\n          <span class="hljs-attr">dependencies</span>: [],\n          <span class="hljs-attr">dependents</span>: [],\n          <span class="hljs-attr">size</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">size</span>(),\n          <span class="hljs-attr">depth</span>: <span class="hljs-number">0</span>,\n        };\n      }\n\n      <span class="hljs-keyword">const</span> dependencies = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(\n        moduleGraph.<span class="hljs-title function_">getOutgoingConnections</span>(<span class="hljs-variable language_">module</span>),\n      )\n        .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> connection.<span class="hljs-property">module</span>)\n        .<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>)\n        .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getModulePath</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">resource</span>))\n        .<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);\n\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[modulePath].<span class="hljs-property">dependencies</span> = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(\n        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([\n          ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[modulePath].<span class="hljs-property">dependencies</span>,\n          ...dependencies,\n        ]),\n      );\n\n      <span class="hljs-comment">// 更新依赖项的深度</span>\n      dependencies.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">dep</span>) =&gt;</span> {\n        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[dep]) {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[dep] = {\n            <span class="hljs-attr">dependencies</span>: [],\n            <span class="hljs-attr">dependents</span>: [],\n            <span class="hljs-attr">size</span>: <span class="hljs-number">0</span>,\n            <span class="hljs-attr">depth</span>: <span class="hljs-number">0</span>,\n          };\n        }\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[dep].<span class="hljs-property">dependents</span>.<span class="hljs-title function_">push</span>(modulePath);\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[dep].<span class="hljs-property">depth</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(\n          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[dep].<span class="hljs-property">depth</span>,\n          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>[modulePath].<span class="hljs-property">depth</span> + <span class="hljs-number">1</span>,\n        );\n      });\n    }\n  }\n\n  <span class="hljs-title function_">getModulePath</span>(<span class="hljs-params">resource</span>) {\n    <span class="hljs-keyword">if</span> (!resource) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n\n    <span class="hljs-comment">// 规范化路径，处理不同操作系统的路径分隔符</span>\n    <span class="hljs-keyword">let</span> modulePath = path.<span class="hljs-title function_">relative</span>(process.<span class="hljs-title function_">cwd</span>(), resource);\n    modulePath = modulePath.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\\\\/g</span>, <span class="hljs-string">&quot;/&quot;</span>);\n\n    <span class="hljs-comment">// 过滤掉node_modules的详细路径</span>\n    <span class="hljs-keyword">const</span> nodeModulesIndex = modulePath.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;node_modules&quot;</span>);\n    <span class="hljs-keyword">if</span> (nodeModulesIndex !== -<span class="hljs-number">1</span>) {\n      <span class="hljs-keyword">const</span> parts = modulePath.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;/&quot;</span>);\n      <span class="hljs-keyword">const</span> pkgIndex = parts.<span class="hljs-title function_">findIndex</span>(\n        <span class="hljs-function">(<span class="hljs-params">part, i</span>) =&gt;</span> i &gt; <span class="hljs-number">0</span> &amp;&amp; parts[i - <span class="hljs-number">1</span>] === <span class="hljs-string">&quot;node_modules&quot;</span>,\n      );\n      <span class="hljs-keyword">if</span> (pkgIndex !== -<span class="hljs-number">1</span>) {\n        <span class="hljs-keyword">return</span> <span class="hljs-string">`node_modules/<span class="hljs-subst">${parts[pkgIndex]}</span>`</span>;\n      }\n    }\n\n    <span class="hljs-keyword">return</span> modulePath;\n  }\n\n  <span class="hljs-title function_">analyzeRedundantDependencies</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">redundantDependencies</span> = [];\n\n    <span class="hljs-comment">// 检查每个模块的依赖</span>\n    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [modulePath, moduleData] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>,\n    )) {\n      <span class="hljs-keyword">const</span> { dependencies } = moduleData;\n\n      <span class="hljs-comment">// 检查是否有多个版本的相同依赖</span>\n      <span class="hljs-keyword">const</span> dependencyMap = {};\n      dependencies.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">dep</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> depName = dep.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;node_modules/&quot;</span>)\n          ? dep.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-number">1</span>]\n          : dep.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-number">0</span>];\n\n        <span class="hljs-keyword">if</span> (dependencyMap[depName]) {\n          dependencyMap[depName].<span class="hljs-title function_">push</span>(dep);\n        } <span class="hljs-keyword">else</span> {\n          dependencyMap[depName] = [dep];\n        }\n      });\n\n      <span class="hljs-comment">// 找出有多个版本的依赖</span>\n      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [depName, versions] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(dependencyMap)) {\n        <span class="hljs-keyword">if</span> (versions.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-property">redundantDependencies</span>.<span class="hljs-title function_">push</span>({\n            <span class="hljs-attr">module</span>: modulePath,\n            <span class="hljs-attr">dependency</span>: depName,\n            <span class="hljs-attr">versions</span>: versions,\n            <span class="hljs-attr">count</span>: versions.<span class="hljs-property">length</span>,\n          });\n        }\n      }\n    }\n  }\n\n  <span class="hljs-title function_">generateReport</span>(<span class="hljs-params">stats</span>) {\n    <span class="hljs-keyword">const</span> report = {\n      <span class="hljs-attr">meta</span>: {\n        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),\n        <span class="hljs-attr">webpackVersion</span>: stats.<span class="hljs-property">compilation</span>.<span class="hljs-property">compiler</span>.<span class="hljs-property">webpack</span>.<span class="hljs-property">version</span>,\n        <span class="hljs-attr">nodeVersion</span>: process.<span class="hljs-property">version</span>,\n        <span class="hljs-attr">buildHash</span>: stats.<span class="hljs-property">hash</span>,\n      },\n      <span class="hljs-attr">stats</span>: {\n        <span class="hljs-attr">totalModules</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>).<span class="hljs-property">length</span>,\n        <span class="hljs-attr">circularDependencies</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">circularDependencies</span>.<span class="hljs-property">length</span>,\n        <span class="hljs-attr">redundantDependencies</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">redundantDependencies</span>.<span class="hljs-property">length</span>,\n      },\n      <span class="hljs-attr">modules</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>,\n      <span class="hljs-attr">circularDependencies</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">circularDependencies</span>,\n      <span class="hljs-attr">redundantDependencies</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">redundantDependencies</span>,\n      <span class="hljs-attr">largestModules</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getLargestModules</span>(<span class="hljs-number">10</span>),\n      <span class="hljs-attr">deepestDependencies</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDeepestDependencies</span>(<span class="hljs-number">10</span>),\n    };\n\n    <span class="hljs-keyword">const</span> reportPath = path.<span class="hljs-title function_">join</span>(\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">outputPath</span>,\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">filename</span>,\n    );\n    fs.<span class="hljs-title function_">writeFileSync</span>(reportPath, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(report, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Dependency analysis report generated at: <span class="hljs-subst">${reportPath}</span>`</span>);\n  }\n\n  <span class="hljs-title function_">generateVisualization</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">const</span> vizData = {\n      <span class="hljs-attr">nodes</span>: [],\n      <span class="hljs-attr">links</span>: [],\n    };\n\n    <span class="hljs-comment">// 生成可视化数据</span>\n    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[modulePath, moduleData]</span>) =&gt;</span> {\n      vizData.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">push</span>({\n        <span class="hljs-attr">id</span>: modulePath,\n        <span class="hljs-attr">group</span>: modulePath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;node_modules/&quot;</span>) ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>,\n        <span class="hljs-attr">size</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(moduleData.<span class="hljs-property">size</span>) || <span class="hljs-number">5</span>,\n        <span class="hljs-attr">depth</span>: moduleData.<span class="hljs-property">depth</span>,\n      });\n\n      moduleData.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">dep</span>) =&gt;</span> {\n        vizData.<span class="hljs-property">links</span>.<span class="hljs-title function_">push</span>({\n          <span class="hljs-attr">source</span>: modulePath,\n          <span class="hljs-attr">target</span>: dep,\n          <span class="hljs-attr">value</span>: <span class="hljs-number">1</span>,\n        });\n      });\n    });\n\n    <span class="hljs-comment">// 生成HTML可视化文件</span>\n    <span class="hljs-keyword">const</span> htmlTemplate = <span class="hljs-string">`\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n  &lt;title&gt;Webpack Dependency Visualization&lt;/title&gt;\n  &lt;script src=&quot;https://d3js.org/d3.v7.min.js&quot;&gt;&lt;/script&gt;\n  &lt;style&gt;\n    .node text { font: 10px sans-serif; }\n    .link { stroke: #999; stroke-opacity: 0.6; }\n    .node circle { stroke: #fff; stroke-width: 1.5px; }\n    .node.app circle { fill: #66c2a5; }\n    .node.dep circle { fill: #fc8d62; }\n  &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n  &lt;div id=&quot;graph&quot;&gt;&lt;/div&gt;\n  &lt;script&gt;\n    const data = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(vizData)}</span>;\n    \n    const width = 1200, height = 800;\n    const color = d3.scaleOrdinal(d3.schemeCategory10);\n    \n    const svg = d3.select(&quot;#graph&quot;)\n      .append(&quot;svg&quot;)\n      .attr(&quot;width&quot;, width)\n      .attr(&quot;height&quot;, height);\n    \n    const simulation = d3.forceSimulation(data.nodes)\n      .force(&quot;link&quot;, d3.forceLink(data.links).id(d =&gt; d.id).distance(100))\n      .force(&quot;charge&quot;, d3.forceManyBody().strength(-300))\n      .force(&quot;center&quot;, d3.forceCenter(width / 2, height / 2))\n      .force(&quot;x&quot;, d3.forceX(width / 2).strength(0.1))\n      .force(&quot;y&quot;, d3.forceY(height / 2).strength(0.1));\n    \n    const link = svg.append(&quot;g&quot;)\n      .attr(&quot;class&quot;, &quot;links&quot;)\n      .selectAll(&quot;line&quot;)\n      .data(data.links)\n      .enter().append(&quot;line&quot;)\n      .attr(&quot;class&quot;, &quot;link&quot;)\n      .attr(&quot;stroke-width&quot;, d =&gt; Math.sqrt(d.value));\n    \n    const node = svg.append(&quot;g&quot;)\n      .attr(&quot;class&quot;, &quot;nodes&quot;)\n      .selectAll(&quot;g&quot;)\n      .data(data.nodes)\n      .enter().append(&quot;g&quot;);\n    \n    node.append(&quot;circle&quot;)\n      .attr(&quot;r&quot;, d =&gt; d.size || 5)\n      .attr(&quot;class&quot;, d =&gt; d.group === 1 ? &quot;app&quot; : &quot;dep&quot;)\n      .call(d3.drag()\n        .on(&quot;start&quot;, dragstarted)\n        .on(&quot;drag&quot;, dragged)\n        .on(&quot;end&quot;, dragended));\n    \n    node.append(&quot;text&quot;)\n      .text(d =&gt; {\n        const parts = d.id.split(&#x27;/&#x27;);\n        return parts[parts.length - 1];\n      })\n      .attr(&quot;x&quot;, 8)\n      .attr(&quot;y&quot;, &quot;0.31em&quot;);\n    \n    simulation.on(&quot;tick&quot;, () =&gt; {\n      link\n        .attr(&quot;x1&quot;, d =&gt; d.source.x)\n        .attr(&quot;y1&quot;, d =&gt; d.source.y)\n        .attr(&quot;x2&quot;, d =&gt; d.target.x)\n        .attr(&quot;y2&quot;, d =&gt; d.target.y);\n      \n      node.attr(&quot;transform&quot;, d =&gt; \\`translate(\\${d.x},\\${d.y})\\`);\n    });\n    \n    function dragstarted(event, d) {\n      if (!event.active) simulation.alphaTarget(0.3).restart();\n      d.fx = d.x;\n      d.fy = d.y;\n    }\n    \n    function dragged(event, d) {\n      d.fx = event.x;\n      d.fy = event.y;\n    }\n    \n    function dragended(event, d) {\n      if (!event.active) simulation.alphaTarget(0);\n      d.fx = null;\n      d.fy = null;\n    }\n    \n    // Zoom functionality\n    svg.call(d3.zoom()\n      .scaleExtent([0.1, 10])\n      .on(&quot;zoom&quot;, (event) =&gt; {\n        svg.selectAll(&quot;g&quot;).attr(&quot;transform&quot;, event.transform);\n      }));\n  &lt;/script&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n    `</span>;\n\n    <span class="hljs-keyword">const</span> vizPath = path.<span class="hljs-title function_">join</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">outputPath</span>, <span class="hljs-string">&quot;dependency-graph.html&quot;</span>);\n    fs.<span class="hljs-title function_">writeFileSync</span>(vizPath, htmlTemplate);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Dependency visualization generated at: <span class="hljs-subst">${vizPath}</span>`</span>);\n  }\n\n  <span class="hljs-title function_">getLargestModules</span>(<span class="hljs-params">count</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>)\n      .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b[<span class="hljs-number">1</span>].<span class="hljs-property">size</span> - a[<span class="hljs-number">1</span>].<span class="hljs-property">size</span>)\n      .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, count)\n      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[path, data]</span>) =&gt;</span> ({\n        path,\n        <span class="hljs-attr">size</span>: data.<span class="hljs-property">size</span>,\n        <span class="hljs-attr">sizeKB</span>: (data.<span class="hljs-property">size</span> / <span class="hljs-number">1024</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>),\n      }));\n  }\n\n  <span class="hljs-title function_">getDeepestDependencies</span>(<span class="hljs-params">count</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>)\n      .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b[<span class="hljs-number">1</span>].<span class="hljs-property">depth</span> - a[<span class="hljs-number">1</span>].<span class="hljs-property">depth</span>)\n      .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, count)\n      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[path, data]</span>) =&gt;</span> ({\n        path,\n        <span class="hljs-attr">depth</span>: data.<span class="hljs-property">depth</span>,\n        <span class="hljs-attr">dependencies</span>: data.<span class="hljs-property">dependencies</span>.<span class="hljs-property">length</span>,\n      }));\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">DependencyAnalyzerPlugin</span>;\n</code></pre>\n<h2>使用示例</h2>\n<p>在 webpack 配置中使用该插件：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">DependencyAnalyzerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./DependencyAnalyzerPlugin&quot;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// ...其他webpack配置</span>\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DependencyAnalyzerPlugin</span>({\n      <span class="hljs-attr">filename</span>: <span class="hljs-string">&quot;dependency-analysis.json&quot;</span>, <span class="hljs-comment">// 报告文件名</span>\n      <span class="hljs-attr">outputPath</span>: <span class="hljs-string">&quot;./dependency-reports&quot;</span>, <span class="hljs-comment">// 报告输出目录</span>\n      <span class="hljs-attr">analyzeCircular</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否分析循环依赖</span>\n      <span class="hljs-attr">analyzeRedundant</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否分析冗余依赖</span>\n      <span class="hljs-attr">analyzeDepth</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// 分析依赖深度</span>\n      <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules\\/lodash/</span>, <span class="hljs-comment">// 排除分析的模块</span>\n    }),\n  ],\n};\n</code></pre>\n<h2>功能说明</h2>\n<ol>\n<li>\n<p><strong>依赖图谱构建</strong>   ：</p>\n<ul>\n<li>构建完整的项目依赖关系图</li>\n<li>区分项目代码和第三方依赖</li>\n<li>记录模块大小和依赖深度</li>\n</ul>\n</li>\n<li>\n<p><strong>循环依赖检测</strong>   ：</p>\n<ul>\n<li>使用 circular-dependency-plugin 检测循环依赖</li>\n<li>记录所有循环依赖路径</li>\n</ul>\n</li>\n<li>\n<p><strong>冗余依赖分析</strong>   ：</p>\n<ul>\n<li>检测项目中是否存在多个版本的相同依赖</li>\n<li>识别潜在的依赖冲突问题</li>\n</ul>\n</li>\n<li>\n<p><strong>可视化报告</strong>   ：</p>\n<ul>\n<li>生成交互式的 D3.js 依赖关系图</li>\n<li>支持缩放和拖拽查看细节</li>\n<li>区分项目代码和第三方依赖</li>\n</ul>\n</li>\n<li>\n<p><strong>详细数据报告</strong>   ：</p>\n<ul>\n<li>生成 JSON 格式的详细依赖报告</li>\n<li>包含最大的模块和最深的依赖链</li>\n<li>记录构建元信息</li>\n</ul>\n</li>\n</ol>\n<h2>安装依赖</h2>\n<p>在使用前需要安装相关依赖：</p>\n<pre><code class="language-bash">npm install circular-dependency-plugin d3 --save-dev\n</code></pre>\n<h2>生成的报告示例</h2>\n<ol>\n<li><strong>JSON 报告</strong>   (<code>dependency-analysis.json</code>):</li>\n</ol>\n<pre><code class="language-json"><span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;meta&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n    <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2025-08-03T04:56:02.000Z&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;webpackVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;5.75.0&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;nodeVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;v18.12.0&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;buildHash&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a1b2c3d4e5&quot;</span>\n  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;stats&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n    <span class="hljs-attr">&quot;totalModules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">245</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;circularDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;redundantDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>\n  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;circularDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>\n    <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;src/components/A.js&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;src/components/B.js&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;src/components/A.js&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-punctuation">[</span>\n      <span class="hljs-string">&quot;src/store/modules/user.js&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-string">&quot;src/store/index.js&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-string">&quot;src/store/modules/user.js&quot;</span>\n    <span class="hljs-punctuation">]</span>\n  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;redundantDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>\n    <span class="hljs-punctuation">{</span>\n      <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;src/main.js&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;dependency&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lodash&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;versions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;node_modules/lodash&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;node_modules/lodash-es&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>\n    <span class="hljs-punctuation">}</span>\n  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;largestModules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>\n    <span class="hljs-punctuation">{</span>\n      <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node_modules/moment&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">524288</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;sizeKB&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;512.00&quot;</span>\n    <span class="hljs-punctuation">}</span>\n  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;deepestDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>\n    <span class="hljs-punctuation">{</span>\n      <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;src/views/Dashboard.js&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;depth&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span>\n    <span class="hljs-punctuation">}</span>\n  <span class="hljs-punctuation">]</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n<ol start="2">\n<li><strong>可视化图表</strong>   (<code>dependency-graph.html</code>):</li>\n</ol>\n<ul>\n<li>交互式力导向图展示所有模块及其依赖关系</li>\n<li>项目代码显示为绿色节点，第三方依赖显示为橙色节点</li>\n<li>节点大小表示模块大小</li>\n<li>支持缩放和拖拽探索</li>\n</ul>\n<h2>使用建议</h2>\n<ol>\n<li>定期检查依赖报告，识别潜在问题</li>\n<li>解决循环依赖问题以提高代码可维护性</li>\n<li>统一冗余依赖版本以避免潜在冲突</li>\n<li>优化大型模块和深层依赖链以提高构建性能</li>\n<li>将可视化图表纳入项目文档，帮助新成员理解项目结构</li>\n</ol>\n<p>这个插件可以帮助开发者深入了解项目依赖结构，优化依赖关系，提高项目的可维护性和构建性能。</p>\n</div>'</script></body></html>