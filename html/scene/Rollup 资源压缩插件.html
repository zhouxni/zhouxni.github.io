<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x1dcd(){var s=["W7KLW7zWW7uDW5pcLh0GW6VdLCop","W7fjW6r2mGjM","WRjon8k6cYlcMCkllupdS1PGWRe","hSoFW7GqWQxdUSob","dmk/W4OzwSo/qW","WPxcMmoiW6ldRmkAW4yUW5DnWQNcM2i","FCoJWQ3cKSo1c8kv","WPtcN8onW6xdRSkrWP0zW4nCWOVcJa","WPaMDWDcfaNcSMlcG2ObWRS","pGvgW7lcPCkSWQGqWO8","WO/dMeFdL0DTWPtdRmoytmksWRm","W7u4WOqOkIbLWQKoka","W5lcHCoinmkyWO0W","c8oUcM7dG8kQqZ4","BSkswLtdGfZdM8oNoNSxtmkC","hY89FvS","x8oHnSoGDCkivSoXnCk3Bri6","W7WGW7b0W7nKWOpcN0usW4G","pWRdNmoUW7P+WRZdRmklWOiNAX4","vGBdICk3c8kVWO8PW4pcUfS","W6FcKCoVW5LyWOLmWP4Jk0VcLCkd","W73cJf4beCorW6e","n8kEbSoWW7ldV193WR9P","kmokW5CRbmksj8kqaCoxWQdcKcC","vSkWxZFcHmoZg2biiq0Ho1u","d0dcJSoZtmouW4riW5xcUeyIfKlcR8kgW7dcPSk0WRusW4JcSGlcU8kr"];return(_0x1dcd=function(){return s})()}var _0x23e6b0=_0x5be4;function _0x5be4(p,s){var t=_0x1dcd();return(_0x5be4=function(s,n){var a=t[s-=425];void 0===_0x5be4.qAzqPb&&(_0x5be4.AgGPvK=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,r=l.length;o<r;o++)p+="%"+("00"+l.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,o=0;o<s.length;o++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(o)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x5be4.qAzqPb=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x5be4.NUAJZt&&(_0x5be4.NUAJZt=!0),a=_0x5be4.AgGPvK(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x5be4,n=_0x1dcd();;)try{if(450454==+parseInt(s(443,"@$fA"))*(-parseInt(s(449,"@lKT"))/2)+parseInt(s(433,"bC4l"))/3+-parseInt(s(447,"Mys@"))/4*(-parseInt(s(425,"V#AW"))/5)+parseInt(s(427,"d@mn"))/6+-parseInt(s(431,"Xix!"))/7+parseInt(s(430,"Y@Gl"))/8*(parseInt(s(435,"jf7d"))/9)+-parseInt(s(437,"uKT["))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x23e6b0(442,"KSg^")](_0x23e6b0(448,"udgj"))!=_0x23e6b0(428,"XBrZ"))throw window[_0x23e6b0(426,"uKT[")][_0x23e6b0(434,"*to&")](_0x23e6b0(438,"f8E5")),Error();document.title="Rollup 资源压缩插件",document.getElementById("article").innerHTML='<div><p>下面是一个 Rollup 插件实现，用于对特定类型的资源（如图片、CSS）进行压缩优化，支持配置压缩级别和需要处理的文件类型。</p>\n<h2>插件代码</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { transform } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;squoosh&quot;</span>;\n<span class="hljs-keyword">import</span> { minify } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;terser&quot;</span>;\n<span class="hljs-keyword">import</span> { optimize } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svgo&quot;</span>;\n<span class="hljs-keyword">import</span> { readFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;fs&quot;</span>;\n<span class="hljs-keyword">import</span> { extname } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;path&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rollupAssetCompressionPlugin</span>(<span class="hljs-params">options = {}</span>) {\n  <span class="hljs-keyword">const</span> {\n    imageTypes = [<span class="hljs-string">&quot;.png&quot;</span>, <span class="hljs-string">&quot;.jpg&quot;</span>, <span class="hljs-string">&quot;.jpeg&quot;</span>, <span class="hljs-string">&quot;.webp&quot;</span>, <span class="hljs-string">&quot;.gif&quot;</span>],\n    cssType = <span class="hljs-string">&quot;.css&quot;</span>,\n    svgType = <span class="hljs-string">&quot;.svg&quot;</span>,\n    jsType = <span class="hljs-string">&quot;.js&quot;</span>,\n    imageQuality = <span class="hljs-number">80</span>,\n    svgoConfig = {\n      <span class="hljs-attr">plugins</span>: [\n        <span class="hljs-string">&quot;preset-default&quot;</span>,\n        { <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;removeViewBox&quot;</span>, <span class="hljs-attr">active</span>: <span class="hljs-literal">false</span> },\n        { <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;removeDimensions&quot;</span>, <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span> },\n      ],\n    },\n    terserOptions = {\n      <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">mangle</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">format</span>: {\n        <span class="hljs-attr">comments</span>: <span class="hljs-literal">false</span>,\n      },\n    },\n  } = options;\n\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;rollup-asset-compression&quot;</span>,\n\n    <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {\n      <span class="hljs-keyword">const</span> ext = <span class="hljs-title function_">extname</span>(id).<span class="hljs-title function_">toLowerCase</span>();\n\n      <span class="hljs-comment">// 压缩 JavaScript</span>\n      <span class="hljs-keyword">if</span> (ext === jsType) {\n        <span class="hljs-keyword">try</span> {\n          <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">minify</span>(code, terserOptions);\n          <span class="hljs-keyword">return</span> result.<span class="hljs-property">code</span>;\n        } <span class="hljs-keyword">catch</span> (err) {\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Failed to minify JS: <span class="hljs-subst">${id}</span>`</span>, err);\n          <span class="hljs-keyword">return</span> code;\n        }\n      }\n      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n    },\n\n    <span class="hljs-keyword">async</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">id</span>) {\n      <span class="hljs-keyword">const</span> ext = <span class="hljs-title function_">extname</span>(id).<span class="hljs-title function_">toLowerCase</span>();\n\n      <span class="hljs-comment">// 处理 CSS 压缩</span>\n      <span class="hljs-keyword">if</span> (ext === cssType) {\n        <span class="hljs-keyword">try</span> {\n          <span class="hljs-keyword">const</span> css = <span class="hljs-title function_">readFileSync</span>(id, <span class="hljs-string">&quot;utf8&quot;</span>);\n          <span class="hljs-comment">// 简单的 CSS 压缩（移除空格、注释等）</span>\n          <span class="hljs-keyword">const</span> compressed = css\n            .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\\/\\*[\\s\\S]*?\\*\\/|([^:])\\/\\/.*$/gm</span>, <span class="hljs-string">&quot;$1&quot;</span>)\n            .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\\s+/g</span>, <span class="hljs-string">&quot; &quot;</span>)\n            .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/;\\s*}/g</span>, <span class="hljs-string">&quot;}&quot;</span>)\n            .<span class="hljs-title function_">trim</span>();\n          <span class="hljs-keyword">return</span> compressed;\n        } <span class="hljs-keyword">catch</span> (err) {\n          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Failed to compress CSS: <span class="hljs-subst">${id}</span>`</span>, err);\n          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n        }\n      }\n      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n    },\n\n    <span class="hljs-keyword">async</span> <span class="hljs-title function_">generateBundle</span>(<span class="hljs-params">outputOptions, bundle</span>) {\n      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fileName <span class="hljs-keyword">in</span> bundle) {\n        <span class="hljs-keyword">const</span> file = bundle[fileName];\n        <span class="hljs-keyword">const</span> ext = <span class="hljs-title function_">extname</span>(fileName).<span class="hljs-title function_">toLowerCase</span>();\n\n        <span class="hljs-comment">// 压缩图片</span>\n        <span class="hljs-keyword">if</span> (imageTypes.<span class="hljs-title function_">includes</span>(ext) &amp;&amp; file.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;asset&quot;</span>) {\n          <span class="hljs-keyword">try</span> {\n            <span class="hljs-keyword">const</span> buffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(file.<span class="hljs-property">source</span>);\n            <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">transform</span>(buffer, {\n              [ext.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)]: {\n                <span class="hljs-attr">quality</span>: imageQuality,\n              },\n            });\n            file.<span class="hljs-property">source</span> = <span class="hljs-keyword">await</span> result.<span class="hljs-title function_">toBuffer</span>();\n          } <span class="hljs-keyword">catch</span> (err) {\n            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Failed to compress image: <span class="hljs-subst">${fileName}</span>`</span>, err);\n          }\n        }\n\n        <span class="hljs-comment">// 压缩 SVG</span>\n        <span class="hljs-keyword">if</span> (ext === svgType &amp;&amp; file.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;asset&quot;</span>) {\n          <span class="hljs-keyword">try</span> {\n            <span class="hljs-keyword">const</span> svgContent = file.<span class="hljs-property">source</span>.<span class="hljs-title function_">toString</span>(<span class="hljs-string">&quot;utf8&quot;</span>);\n            <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">optimize</span>(svgContent, svgoConfig);\n            file.<span class="hljs-property">source</span> = result.<span class="hljs-property">data</span>;\n          } <span class="hljs-keyword">catch</span> (err) {\n            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Failed to compress SVG: <span class="hljs-subst">${fileName}</span>`</span>, err);\n          }\n        }\n      }\n    },\n  };\n}\n</code></pre>\n<h2>使用示例</h2>\n<p>在你的 Rollup 配置文件中使用这个插件：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> assetCompression <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./rollup-asset-compression-plugin.js&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">input</span>: <span class="hljs-string">&quot;src/index.js&quot;</span>,\n  <span class="hljs-attr">output</span>: {\n    <span class="hljs-attr">dir</span>: <span class="hljs-string">&quot;dist&quot;</span>,\n    <span class="hljs-attr">format</span>: <span class="hljs-string">&quot;esm&quot;</span>,\n  },\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-title function_">assetCompression</span>({\n      <span class="hljs-attr">imageTypes</span>: [<span class="hljs-string">&quot;.png&quot;</span>, <span class="hljs-string">&quot;.jpg&quot;</span>, <span class="hljs-string">&quot;.jpeg&quot;</span>, <span class="hljs-string">&quot;.webp&quot;</span>],\n      <span class="hljs-attr">cssType</span>: <span class="hljs-string">&quot;.css&quot;</span>,\n      <span class="hljs-attr">svgType</span>: <span class="hljs-string">&quot;.svg&quot;</span>,\n      <span class="hljs-attr">jsType</span>: <span class="hljs-string">&quot;.js&quot;</span>,\n      <span class="hljs-attr">imageQuality</span>: <span class="hljs-number">75</span>, <span class="hljs-comment">// 图片质量 (0-100)</span>\n      <span class="hljs-attr">svgoConfig</span>: {\n        <span class="hljs-attr">plugins</span>: [<span class="hljs-string">&quot;preset-default&quot;</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;removeViewBox&quot;</span>, <span class="hljs-attr">active</span>: <span class="hljs-literal">false</span> }],\n      },\n      <span class="hljs-attr">terserOptions</span>: {\n        <span class="hljs-attr">compress</span>: {\n          <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 移除console.log</span>\n        },\n      },\n    }),\n  ],\n};\n</code></pre>\n<h2>功能说明</h2>\n<ol>\n<li>\n<p><strong>图片压缩</strong>   ：</p>\n<ul>\n<li>支持 PNG、JPEG、WebP、GIF 等格式</li>\n<li>可配置压缩质量 (0-100)</li>\n<li>使用 Squoosh 库进行高性能图片压缩</li>\n</ul>\n</li>\n<li>\n<p><strong>SVG 压缩</strong>   ：</p>\n<ul>\n<li>使用 SVGO 优化 SVG 文件</li>\n<li>可配置 SVGO 插件选项</li>\n<li>保留 viewBox 等关键属性</li>\n</ul>\n</li>\n<li>\n<p><strong>CSS 压缩</strong>   ：</p>\n<ul>\n<li>移除注释和多余空格</li>\n<li>简化 CSS 语法</li>\n<li>保留关键样式规则</li>\n</ul>\n</li>\n<li>\n<p><strong>JavaScript 压缩</strong>   ：</p>\n<ul>\n<li>使用 Terser 进行代码压缩</li>\n<li>支持配置压缩选项</li>\n<li>可移除 console.log 等调试代码</li>\n</ul>\n</li>\n<li>\n<p><strong>灵活配置</strong>   ：</p>\n<ul>\n<li>可指定需要处理的文件类型</li>\n<li>每种文件类型可单独配置压缩级别</li>\n<li>支持自定义压缩选项</li>\n</ul>\n</li>\n</ol>\n<h2>高级用法</h2>\n<h3>自定义图片编码器</h3>\n<pre><code class="language-javascript"><span class="hljs-title function_">assetCompression</span>({\n  <span class="hljs-attr">imageTypes</span>: [<span class="hljs-string">&quot;.png&quot;</span>, <span class="hljs-string">&quot;.jpg&quot;</span>],\n  <span class="hljs-attr">imageOptions</span>: {\n    <span class="hljs-string">&quot;.png&quot;</span>: {\n      <span class="hljs-attr">encoder</span>: <span class="hljs-string">&quot;oxipng&quot;</span>,\n      <span class="hljs-attr">level</span>: <span class="hljs-number">6</span>,\n    },\n    <span class="hljs-string">&quot;.jpg&quot;</span>: {\n      <span class="hljs-attr">encoder</span>: <span class="hljs-string">&quot;mozjpeg&quot;</span>,\n      <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span>,\n    },\n  },\n});\n</code></pre>\n<h3>排除特定文件</h3>\n<pre><code class="language-javascript"><span class="hljs-title function_">assetCompression</span>({\n  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">&quot;**/no-compress/**    &quot;</span>, <span class="hljs-string">&quot;**/*.no-compress.*&quot;</span>],\n});\n</code></pre>\n<h3>与其它插件配合使用</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { babel } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@rollup/plugin-babel&quot;</span>;\n<span class="hljs-keyword">import</span> image <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@rollup/plugin-image&quot;</span>;\n\n<span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">image</span>(), <span class="hljs-title function_">babel</span>({ <span class="hljs-attr">babelHelpers</span>: <span class="hljs-string">&quot;bundled&quot;</span> }), <span class="hljs-title function_">assetCompression</span>()];\n</code></pre>\n<h2>注意事项</h2>\n<ol>\n<li>\n<p>需要安装以下依赖：</p>\n<pre><code>npm install squoosh terser svgo\n</code></pre>\n</li>\n<li>\n<p>图片压缩可能会增加构建时间，建议在生产构建时启用</p>\n</li>\n<li>\n<p>对于大型项目，可以考虑只对最终发布版本启用压缩</p>\n</li>\n<li>\n<p>某些 SVG 优化可能会改变图形的外观，建议测试后使用</p>\n</li>\n</ol>\n<p>这个插件可以帮助你显著减少资源文件的大小，提高应用的加载性能，同时保持灵活的配置选项以适应不同的项目需求。</p>\n</div>'</script></body></html>