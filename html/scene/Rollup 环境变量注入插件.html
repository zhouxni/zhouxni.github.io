<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5407(){var s=["xSo5dZTGhSolW7/cNZ/cOxO","zNBdL2ldJ8ojWQVdRwBdR8kJpW","rCotBM8WW7/dMuZdUG","dmoKsSofmmkDW5mk","WQm7W63dNb1yE8obWOSjBNZdPW","WPfNW5RcVqVdG2HkfHfMnq","aGeBW7jzWO5v","sSkCeSo8WONcUWhdRmoDb8kQ","nCkhoJ9XWRxdMfVdT1SLsG","lxHtw0igWR7cJqzrDa","trOaW7G7","WPnJW5JcUq3dG3L0aIfdea","d19lWRn6DgVcSY3dKdmo","rfnFW61XWR5Yexm","wGzrwNBdRt7dV2jPpa","v8kQo0RdJSoQW6iT","EsWviaeGWQa","WO/cPWTMW74zb8oxWRVdV8opW5irWQrNWOGEqvHkW5VdLCoxAd3dGW","q1zDWQOjW5Sff3PrW7TxuG","W5xdO0CUWRuttSkiWQNdH8oyW5q","WQXPdx7cH8oFBwWwW4JdI2O","WPnJWP7dK3dcUN1V","W7RcHtzfWR8AvSkHuW","itT2B8kKW5tcTu55qCkt"];return(_0x5407=function(){return s})()}var _0x2bcc92=_0x2a0d;function _0x2a0d(p,s){var t=_0x5407();return(_0x2a0d=function(s,n){var a=t[s-=402];void 0===_0x2a0d.apNZbe&&(_0x2a0d.NpOFIj=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=l.length;c<o;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,c=0;c<s.length;c++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x2a0d.apNZbe=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x2a0d.hMiNKM&&(_0x2a0d.hMiNKM=!0),a=_0x2a0d.NpOFIj(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x2a0d,n=_0x5407();;)try{if(183717==+parseInt(s(407,")MoV"))+parseInt(s(410,"WfGp"))/2+parseInt(s(413,"ZtN]"))/3*(-parseInt(s(414,"rKWs"))/4)+parseInt(s(411,"U&^Q"))/5+parseInt(s(412,"mTAY"))/6*(-parseInt(s(408,"ezp#"))/7)+parseInt(s(404,"WfGp"))/8+parseInt(s(403,"Lx]v"))/9)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x2bcc92(415,"ezp#")](_0x2bcc92(425,")MoV"))!=_0x2bcc92(409,"U&^Q"))throw window[_0x2bcc92(402,"I&&w")][_0x2bcc92(405,"mTAY")](_0x2bcc92(416,"H8^i")),Error();document.title="Rollup 环境变量注入插件",document.getElementById("article").innerHTML='<div><p>下面是一个 Rollup 插件实现，用于根据不同环境（开发/生产）自动注入对应的环境变量。</p>\n<h2>插件代码</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { readFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;fs&quot;</span>;\n<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;dotenv&quot;</span>;\n<span class="hljs-keyword">import</span> dotenvExpand <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;dotenv-expand&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rollupEnvPlugin</span>(<span class="hljs-params">options = {}</span>) {\n  <span class="hljs-keyword">const</span> {\n    envFile = <span class="hljs-string">&quot;.env&quot;</span>,\n    envPrefix = <span class="hljs-string">&quot;ROLLUP_&quot;</span>,\n    envMode = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> || <span class="hljs-string">&quot;development&quot;</span>,\n    define = {},\n    includeProcessEnv = <span class="hljs-literal">false</span>,\n    replaceInFiles = [<span class="hljs-string">&quot;.js&quot;</span>, <span class="hljs-string">&quot;.jsx&quot;</span>, <span class="hljs-string">&quot;.ts&quot;</span>, <span class="hljs-string">&quot;.tsx&quot;</span>],\n  } = options;\n\n  <span class="hljs-comment">// 加载环境变量文件</span>\n  <span class="hljs-keyword">const</span> envResult = dotenv.<span class="hljs-title function_">config</span>({ <span class="hljs-attr">path</span>: envFile });\n  <span class="hljs-keyword">if</span> (envResult.<span class="hljs-property">error</span> &amp;&amp; envFile !== <span class="hljs-string">&quot;.env&quot;</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Failed to load env file: <span class="hljs-subst">${envFile}</span>`</span>, envResult.<span class="hljs-property">error</span>);\n  }\n  dotenvExpand.<span class="hljs-title function_">expand</span>(envResult);\n\n  <span class="hljs-comment">// 收集环境变量</span>\n  <span class="hljs-keyword">const</span> envVars = {\n    ...(includeProcessEnv ? process.<span class="hljs-property">env</span> : {}),\n    ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(envResult.<span class="hljs-property">parsed</span> || {}).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, key</span>) =&gt;</span> {\n      <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(envPrefix)) {\n        acc[key] = envResult.<span class="hljs-property">parsed</span>[key];\n      }\n      <span class="hljs-keyword">return</span> acc;\n    }, {}),\n    <span class="hljs-attr">NODE_ENV</span>: envMode,\n    ...define,\n  };\n\n  <span class="hljs-comment">// 准备替换模板</span>\n  <span class="hljs-keyword">const</span> replacementPatterns = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(envVars).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> ({\n    <span class="hljs-attr">find</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(\n      <span class="hljs-string">`(process\\\\.env\\\\.<span class="hljs-subst">${key}</span>|import\\\\.meta\\\\.env\\\\.<span class="hljs-subst">${key}</span>)`</span>,\n      <span class="hljs-string">&quot;g&quot;</span>,\n    ),\n    <span class="hljs-attr">replacement</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value),\n  }));\n\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;rollup-env-plugin&quot;</span>,\n\n    <span class="hljs-title function_">config</span>(<span class="hljs-params">config</span>) {\n      <span class="hljs-comment">// 注入全局变量</span>\n      <span class="hljs-keyword">return</span> {\n        <span class="hljs-attr">define</span>: {\n          <span class="hljs-string">&quot;process.env&quot;</span>: envVars,\n          <span class="hljs-string">&quot;import.meta.env&quot;</span>: envVars,\n          ...config.<span class="hljs-property">define</span>,\n        },\n      };\n    },\n\n    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {\n      <span class="hljs-keyword">const</span> ext = id.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>).<span class="hljs-title function_">pop</span>().<span class="hljs-title function_">toLowerCase</span>();\n\n      <span class="hljs-keyword">if</span> (replaceInFiles.<span class="hljs-title function_">includes</span>(<span class="hljs-string">`.<span class="hljs-subst">${ext}</span>`</span>)) {\n        <span class="hljs-comment">// 替换代码中的环境变量引用</span>\n        <span class="hljs-keyword">let</span> transformedCode = code;\n        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { find, replacement } <span class="hljs-keyword">of</span> replacementPatterns) {\n          transformedCode = transformedCode.<span class="hljs-title function_">replace</span>(find, replacement);\n        }\n        <span class="hljs-keyword">return</span> {\n          <span class="hljs-attr">code</span>: transformedCode,\n          <span class="hljs-attr">map</span>: <span class="hljs-literal">null</span>,\n        };\n      }\n      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n    },\n\n    <span class="hljs-title function_">generateBundle</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-comment">// 生成环境变量类型声明文件（用于TypeScript）</span>\n      <span class="hljs-keyword">if</span> (envMode === <span class="hljs-string">&quot;development&quot;</span>) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitFile</span>({\n          <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;asset&quot;</span>,\n          <span class="hljs-attr">fileName</span>: <span class="hljs-string">&quot;env.d.ts&quot;</span>,\n          <span class="hljs-attr">source</span>: <span class="hljs-string">`// Auto-generated by rollup-env-plugin\ninterface ImportMetaEnv {\n<span class="hljs-subst">${<span class="hljs-built_in">Object</span>.entries(envVars)\n  .map(([key, value]) =&gt; <span class="hljs-string">`  <span class="hljs-subst">${key}</span>: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(value)}</span>;`</span>)\n  .join(<span class="hljs-string">&quot;\\n&quot;</span>)}</span>\n}\n\ninterface ProcessEnv {\n<span class="hljs-subst">${<span class="hljs-built_in">Object</span>.entries(envVars)\n  .map(([key, value]) =&gt; <span class="hljs-string">`  <span class="hljs-subst">${key}</span>: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(value)}</span>;`</span>)\n  .join(<span class="hljs-string">&quot;\\n&quot;</span>)}</span>\n}`</span>,\n        });\n      }\n    },\n  };\n}\n</code></pre>\n<h2>使用示例</h2>\n<p>在你的 Rollup 配置文件中使用这个插件：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> envPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./rollup-env-plugin.js&quot;</span>;\n\n<span class="hljs-comment">// 环境变量文件示例 (.env.production)</span>\n<span class="hljs-comment">// ROLLUP_API_URL=https://api.example.com</span>\n<span class="hljs-comment">// ROLLUP_DEBUG=false</span>\n\n<span class="hljs-comment">// 环境变量文件示例 (.env.development)</span>\n<span class="hljs-comment">// ROLLUP_API_URL=http://localhost:3000</span>\n<span class="hljs-comment">// ROLLUP_DEBUG=true</span>\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">input</span>: <span class="hljs-string">&quot;src/index.js&quot;</span>,\n  <span class="hljs-attr">output</span>: {\n    <span class="hljs-attr">dir</span>: <span class="hljs-string">&quot;dist&quot;</span>,\n    <span class="hljs-attr">format</span>: <span class="hljs-string">&quot;esm&quot;</span>,\n  },\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-title function_">envPlugin</span>({\n      <span class="hljs-attr">envFile</span>: <span class="hljs-string">`.env.<span class="hljs-subst">${process.env.NODE_ENV || <span class="hljs-string">&quot;development&quot;</span>}</span>`</span>, <span class="hljs-comment">// 根据环境加载不同的文件</span>\n      <span class="hljs-attr">envPrefix</span>: <span class="hljs-string">&quot;ROLLUP_&quot;</span>, <span class="hljs-comment">// 只注入以ROLLUP_开头的变量</span>\n      <span class="hljs-attr">envMode</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> || <span class="hljs-string">&quot;development&quot;</span>, <span class="hljs-comment">// 当前环境</span>\n      <span class="hljs-attr">define</span>: {\n        <span class="hljs-comment">// 可以在这里直接定义变量</span>\n        <span class="hljs-attr">ROLLUP_BUILD_TIME</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()),\n      },\n      <span class="hljs-attr">includeProcessEnv</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否包含process.env中的所有变量</span>\n      <span class="hljs-attr">replaceInFiles</span>: [<span class="hljs-string">&quot;.js&quot;</span>, <span class="hljs-string">&quot;.jsx&quot;</span>, <span class="hljs-string">&quot;.ts&quot;</span>, <span class="hljs-string">&quot;.tsx&quot;</span>], <span class="hljs-comment">// 需要替换环境变量的文件类型</span>\n    }),\n  ],\n};\n</code></pre>\n<h2>功能说明</h2>\n<ol>\n<li>\n<p><strong>多环境支持</strong>   ：</p>\n<ul>\n<li>自动识别开发(development)和生产(production)环境</li>\n<li>支持加载不同环境的环境变量文件(.env, .env.production, .env.development等)</li>\n</ul>\n</li>\n<li>\n<p><strong>变量注入方式</strong>   ：</p>\n<ul>\n<li>支持 <code>process.env.VAR_NAME</code> 和 <code>import.meta.env.VAR_NAME</code> 两种形式</li>\n<li>可配置变量名前缀(如只注入<code>ROLLUP_</code>开头的变量)</li>\n</ul>\n</li>\n<li>\n<p><strong>安全控制</strong>   ：</p>\n<ul>\n<li>默认不包含process.env中的所有变量(防止意外泄露敏感信息)</li>\n<li>可精确控制哪些变量会被注入到打包结果中</li>\n</ul>\n</li>\n<li>\n<p><strong>开发友好</strong>   ：</p>\n<ul>\n<li>开发环境自动生成env.d.ts类型声明文件</li>\n<li>支持TypeScript项目中的环境变量类型提示</li>\n</ul>\n</li>\n<li>\n<p><strong>灵活配置</strong>   ：</p>\n<ul>\n<li>可自定义需要处理的文件类型</li>\n<li>支持直接定义变量(绕过环境文件)</li>\n<li>可配置变量替换策略</li>\n</ul>\n</li>\n</ol>\n<h2>高级用法</h2>\n<h3>多环境配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// rollup.config.js</span>\n<span class="hljs-keyword">import</span> envPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./rollup-env-plugin.js&quot;</span>;\n\n<span class="hljs-keyword">const</span> envConfigs = {\n  <span class="hljs-attr">development</span>: {\n    <span class="hljs-attr">envFile</span>: <span class="hljs-string">&quot;.env.development&quot;</span>,\n    <span class="hljs-attr">define</span>: {\n      <span class="hljs-attr">ROLLUP_DEBUG</span>: <span class="hljs-string">&quot;true&quot;</span>,\n    },\n  },\n  <span class="hljs-attr">production</span>: {\n    <span class="hljs-attr">envFile</span>: <span class="hljs-string">&quot;.env.production&quot;</span>,\n    <span class="hljs-attr">define</span>: {\n      <span class="hljs-attr">ROLLUP_DEBUG</span>: <span class="hljs-string">&quot;false&quot;</span>,\n    },\n  },\n};\n\n<span class="hljs-keyword">const</span> currentEnv = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> || <span class="hljs-string">&quot;development&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-title function_">envPlugin</span>({\n      ...envConfigs[currentEnv],\n      <span class="hljs-attr">envMode</span>: currentEnv,\n    }),\n  ],\n};\n</code></pre>\n<h3>与Vite风格环境变量兼容</h3>\n<pre><code class="language-javascript"><span class="hljs-title function_">envPlugin</span>({\n  <span class="hljs-attr">envPrefix</span>: <span class="hljs-string">&quot;VITE_&quot;</span>, <span class="hljs-comment">// 使用Vite风格的环境变量前缀</span>\n  <span class="hljs-attr">replacePatterns</span>: [\n    {\n      <span class="hljs-attr">find</span>: <span class="hljs-regexp">/import\\.meta\\.env\\.([A-Z_]+)/g</span>,\n      <span class="hljs-attr">replacement</span>: <span class="hljs-function">(<span class="hljs-params">_, key</span>) =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(envVars[key] || <span class="hljs-string">&quot;&quot;</span>),\n    },\n  ],\n});\n</code></pre>\n<h3>条件编译</h3>\n<pre><code class="language-javascript"><span class="hljs-title function_">envPlugin</span>({\n  <span class="hljs-attr">define</span>: {\n    <span class="hljs-attr">__DEV__</span>: envMode === <span class="hljs-string">&quot;development&quot;</span>,\n    <span class="hljs-attr">__PROD__</span>: envMode === <span class="hljs-string">&quot;production&quot;</span>,\n  },\n});\n</code></pre>\n<p>然后在代码中可以使用条件编译：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">if</span> (__DEV__) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;开发环境特有逻辑&quot;</span>);\n}\n</code></pre>\n<p>这个插件可以帮助你轻松管理不同环境下的变量配置，避免手动修改配置文件，同时保证敏感信息不会意外泄露到客户端代码中。</p>\n</div>'</script></body></html>