<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x1c0a7d=_0x5d02;function _0x5d02(t,s){var l=_0x5ddb();return(_0x5d02=function(s,n){var a=l[s-=225];void 0===_0x5d02.Ouespr&&(_0x5d02.OOxOQG=function(s,n){var a,e=[],t=0,l="";for(s=(s=>{for(var n,a,e="",t="",l=0,o=0;a=s.charAt(o++);~a&&(n=l%4?64*n+a:a,l++%4)&&(e+=String.fromCharCode(255&n>>(-2*l&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,p=e.length;c<p;c++)t+="%"+("00"+e.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(t)})(s),o=0;o<256;o++)e[o]=o;for(o=0;o<256;o++)t=(t+e[o]+n.charCodeAt(o%n.length))%256,a=e[o],e[o]=e[t],e[t]=a;for(var o=0,t=0,c=0;c<s.length;c++)a=e[o=(o+1)%256],e[o]=e[t=(t+e[o])%256],e[t]=a,l+=String.fromCharCode(s.charCodeAt(c)^e[(e[o]+e[t])%256]);return l},t=arguments,_0x5d02.Ouespr=!0);var s=s+l[0],e=t[s];return e?a=e:(void 0===_0x5d02.wTBzRI&&(_0x5d02.wTBzRI=!0),a=_0x5d02.OOxOQG(a,n),t[s]=a),a})(t,s)}function _0x5ddb(){var s=["W5LqW6JcNCkLWRyDW5CFea","WQhcJqhcQgtdMguGnxOUWRFcVG","s8oWWQFdMNm","W6VdUr/cPCk2WQ3cHSotBvrRjSkN","oqfCFSofsIr2nmkj","W4jLjKBcQCoOWQ5c","W6FcQCo5b8o8BSoaWRNcVanYhq","WQRcR1JdVSoLW7BdMW","bN/dRSkQe8k/WPNdL8oJaYjk","BmkeW5qVeexcVa","WRfytH8JW48JvSkQnmoU","fSoCWPXCWQvmWPtdRCkb","WPC/C1dcVmojWQnEW7e","W5xcOwFcR8osW5/dI3BdQ8kAWOVdJ2K","WOeWWO3cG2VcKa3dSCkibwu","WOhdRCkicMhdVvdcG8od","ASocWOBdLHFdOmk9WQ/dOrjBymo/WOBdPb0xsHyPW5xdH8kMF8kMAG","pM3dTfq8W7RdM8oVnCorW4JcLae","W78VAvKlW57cQ8otWQ/dQKVcJSok","bNZdQSkIemk+WOZdV8ovfs9T","fSkxmCocW7RdTCoatmkt","W7qaDNldNtddRSk2WRCXoCotWOy","o8kdW4tdKqxcKSoWW7ldNa","W65dECk3gxyBrSkmW7WjqG"];return(_0x5ddb=function(){return s})()}if((()=>{for(var s=_0x5d02,n=_0x5ddb();;)try{if(525574==-parseInt(s(248,"ca]A"))+-parseInt(s(237,"@rw5"))/2*(parseInt(s(229,"^%GI"))/3)+parseInt(s(228,"@XOM"))/4+-parseInt(s(245,"epMG"))/5*(-parseInt(s(239,"kuER"))/6)+parseInt(s(233,"VqZ2"))/7+-parseInt(s(246,"wWhB"))/8+parseInt(s(238,"eQPP"))/9)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x1c0a7d(234,"BZIi")](_0x1c0a7d(240,"txaA"))!=_0x1c0a7d(227,"dy#@"))throw window[_0x1c0a7d(230,"@rw5")][_0x1c0a7d(232,"@XOM")](_0x1c0a7d(241,"l^4G")),Error();document.title="å‰ç«¯ç›‘æ§é¡µé¢ç¦»å¼€",document.getElementById("article").innerHTML='<div><p>å‰ç«¯ç›‘æ§é¡µé¢ç¦»å¼€ï¼ˆå¦‚å…³é—­ã€è·³è½¬ã€åˆ·æ–°ç­‰ï¼‰æ˜¯ç”¨æˆ·è¡Œä¸ºåˆ†æçš„é‡è¦éƒ¨åˆ†ï¼Œé€šå¸¸ç”¨äºç»Ÿè®¡ç”¨æˆ·åœç•™æ—¶é—´ã€æµå¤±ç‡ç­‰ã€‚ä»¥ä¸‹æ˜¯ <strong>å®Œæ•´çš„å‰ç«¯ç›‘æ§é¡µé¢ç¦»å¼€çš„æ–¹æ³•</strong>   ï¼Œæ¶µç›–ä¸åŒåœºæ™¯å’Œå…¼å®¹æ€§å¤„ç†ï¼š</p>\n<hr>\n<h2><strong>1. æ ¸å¿ƒæ–¹æ³•ï¼šç›‘å¬é¡µé¢å¸è½½äº‹ä»¶</strong></h2>\n<p>é¡µé¢ç¦»å¼€çš„æ ¸å¿ƒäº‹ä»¶åŒ…æ‹¬ <code>beforeunload</code>ã€<code>unload</code> å’Œ <code>pagehide</code>ï¼Œå®ƒä»¬åœ¨ä¸åŒåœºæ™¯ä¸‹è§¦å‘ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>äº‹ä»¶</th>\n<th>è§¦å‘æ—¶æœº</th>\n<th>æ˜¯å¦å¯é </th>\n<th>é€‚ç”¨åœºæ™¯</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>beforeunload</code></td>\n<td>é¡µé¢å³å°†å¸è½½ï¼ˆåˆ·æ–°ã€å…³é—­ã€å¯¼èˆªï¼‰</td>\n<td>éƒ¨åˆ†æµè§ˆå™¨å¯èƒ½ä¸è§¦å‘ï¼ˆå¦‚ç§»åŠ¨ç«¯ï¼‰</td>\n<td>ç®€å•åœºæ™¯</td>\n</tr>\n<tr>\n<td><code>unload</code></td>\n<td>é¡µé¢æ­£åœ¨å¸è½½ï¼ˆèµ„æºæ¸…ç†é˜¶æ®µï¼‰</td>\n<td>å¯é æ€§è¾ƒä½ï¼Œå¼‚æ­¥è¯·æ±‚å¯èƒ½è¢«ä¸­æ–­</td>\n<td>æ•°æ®æ¸…ç†</td>\n</tr>\n<tr>\n<td><code>pagehide</code></td>\n<td>é¡µé¢éšè—æˆ–å¯¼èˆªç¦»å¼€ï¼ˆåŒ…æ‹¬ bfcache æƒ…å†µï¼‰</td>\n<td>æ›´å¯é ï¼Œè¦†ç›–ç§»åŠ¨ç«¯å’Œ bfcache</td>\n<td>ç§»åŠ¨ç«¯ã€SPA</td>\n</tr>\n</tbody>\n</table>\n<h3><strong>åŸºç¡€å®ç°ï¼ˆ<code>beforeunload</code> + <code>unload</code>ï¼‰</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// è®°å½•é¡µé¢åŠ è½½æ—¶é—´</span>\n<span class="hljs-keyword">let</span> pageLoadTime = performance.<span class="hljs-title function_">now</span>();\n\n<span class="hljs-comment">// ç›‘å¬é¡µé¢å¸è½½äº‹ä»¶</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;beforeunload&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">const</span> stayTime = performance.<span class="hljs-title function_">now</span>() - pageLoadTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>(stayTime); <span class="hljs-comment">// éœ€å¼‚æ­¥å¤„ç†ï¼ˆè§ä¸‹æ–‡ï¼‰</span>\n});\n\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;unload&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-comment">// å¯ç”¨äºæ¸…ç†æ•°æ®ï¼Œä½†é¿å…å¼‚æ­¥æ“ä½œ</span>\n});\n</code></pre>\n<p><strong>é—®é¢˜</strong>   ï¼š</p>\n<ul>\n<li><code>beforeunload</code> åœ¨ç§»åŠ¨ç«¯å¯èƒ½ä¸è§¦å‘ã€‚</li>\n<li><code>unload</code> ä¸­çš„å¼‚æ­¥è¯·æ±‚ï¼ˆå¦‚ <code>fetch</code>ï¼‰å¯èƒ½è¢«æµè§ˆå™¨ä¸­æ–­ã€‚</li>\n</ul>\n<hr>\n<h2><strong>2. æ›´å¯é çš„æ–¹æ¡ˆï¼š<code>pagehide</code> + <code>visibilitychange</code></strong></h2>\n<p>ç»“åˆ <code>pagehide</code>ï¼ˆè¦†ç›–ç§»åŠ¨ç«¯å’Œ bfcacheï¼‰å’Œ <code>visibilitychange</code>ï¼ˆç›‘å¬æ ‡ç­¾é¡µåˆ‡æ¢ï¼‰ï¼Œæé«˜è¦†ç›–ç‡ã€‚</p>\n<h3><strong>å®Œæ•´å®ç°</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">let</span> pageLoadTime = performance.<span class="hljs-title function_">now</span>();\n<span class="hljs-keyword">let</span> totalStayTime = <span class="hljs-number">0</span>;\n<span class="hljs-keyword">let</span> lastVisibleTime = pageLoadTime;\n\n<span class="hljs-comment">// 1. ç›‘å¬å¯è§æ€§å˜åŒ–ï¼ˆæ ‡ç­¾é¡µåˆ‡æ¢ã€æœ€å°åŒ–ï¼‰</span>\n<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;visibilitychange&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">&quot;hidden&quot;</span>) {\n    totalStayTime += performance.<span class="hljs-title function_">now</span>() - lastVisibleTime;\n  } <span class="hljs-keyword">else</span> {\n    lastVisibleTime = performance.<span class="hljs-title function_">now</span>();\n  }\n});\n\n<span class="hljs-comment">// 2. ç›‘å¬é¡µé¢éšè—ï¼ˆç§»åŠ¨ç«¯ã€bfcacheï¼‰</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;pagehide&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  totalStayTime += performance.<span class="hljs-title function_">now</span>() - lastVisibleTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>(totalStayTime); <span class="hljs-comment">// ä½¿ç”¨ sendBeacon</span>\n});\n\n<span class="hljs-comment">// 3. ç›‘å¬å¸è½½äº‹ä»¶ï¼ˆå…œåº•ï¼‰</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;beforeunload&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  totalStayTime += performance.<span class="hljs-title function_">now</span>() - lastVisibleTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>(totalStayTime); <span class="hljs-comment">// å…œåº•ä¸ŠæŠ¥</span>\n});\n</code></pre>\n<p><strong>ä¼˜ç‚¹</strong>   ï¼š</p>\n<ul>\n<li>è¦†ç›–ç§»åŠ¨ç«¯ã€SPAã€bfcache ç­‰å¤æ‚åœºæ™¯ã€‚</li>\n<li><code>visibilitychange</code> å¯ç»Ÿè®¡æ ‡ç­¾é¡µåˆ‡æ¢æ—¶é—´ã€‚</li>\n</ul>\n<hr>\n<h2><strong>3. å®šæ—¶ä¸ŠæŠ¥ + ä¼šè¯ç®¡ç†ï¼ˆé«˜å®æ—¶æ€§æ–¹æ¡ˆï¼‰</strong></h2>\n<p>é€šè¿‡å®šæ—¶ä¸ŠæŠ¥ï¼ˆå¦‚æ¯ 30 ç§’ï¼‰ç»“åˆä¼šè¯ IDï¼Œé¿å…ä¾èµ–å¸è½½äº‹ä»¶ï¼Œæ•°æ®æ›´å®æ—¶ã€‚</p>\n<h3><strong>å®ç°ä»£ç </strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">let</span> pageLoadTime = performance.<span class="hljs-title function_">now</span>();\n<span class="hljs-keyword">let</span> sessionId = <span class="hljs-title function_">generateSessionId</span>(); <span class="hljs-comment">// ç”Ÿæˆå”¯ä¸€ä¼šè¯ID</span>\n<span class="hljs-keyword">const</span> reportInterval = <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 30ç§’ä¸ŠæŠ¥ä¸€æ¬¡</span>\n\n<span class="hljs-comment">// å®šæ—¶ä¸ŠæŠ¥</span>\n<span class="hljs-keyword">const</span> intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">const</span> stayTime = performance.<span class="hljs-title function_">now</span>() - pageLoadTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>({ sessionId, stayTime });\n}, reportInterval);\n\n<span class="hljs-comment">// é¡µé¢å¸è½½æ—¶å‘é€æœ€ç»ˆæ•°æ®</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;beforeunload&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-built_in">clearInterval</span>(intervalId);\n  <span class="hljs-keyword">const</span> finalStayTime = performance.<span class="hljs-title function_">now</span>() - pageLoadTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>({ sessionId, <span class="hljs-attr">stayTime</span>: finalStayTime, <span class="hljs-attr">isFinal</span>: <span class="hljs-literal">true</span> });\n});\n</code></pre>\n<p><strong>ä¼˜ç‚¹</strong>   ï¼š</p>\n<ul>\n<li>å³ä½¿ç”¨æˆ·çªç„¶å…³é—­é¡µé¢ï¼Œä¹Ÿèƒ½é€šè¿‡æœ€åä¸€æ¬¡ä¸ŠæŠ¥ä¼°ç®—æ—¶é—´ã€‚</li>\n<li>é€‚åˆéœ€è¦å®æ—¶åˆ†æçš„åœºæ™¯ï¼ˆå¦‚æµå¤±é¢„è­¦ï¼‰ã€‚</li>\n</ul>\n<hr>\n<h2><strong>4. å•é¡µåº”ç”¨ï¼ˆSPAï¼‰çš„ç‰¹æ®Šå¤„ç†</strong></h2>\n<p>SPA çš„è·¯ç”±åˆ‡æ¢ä¸ä¼šè§¦å‘é¡µé¢åˆ·æ–°ï¼Œéœ€ç›‘å¬æ¡†æ¶çš„è·¯ç”±äº‹ä»¶ï¼ˆå¦‚ <code>vue-router</code> æˆ– <code>react-router</code>ï¼‰ã€‚</p>\n<h3><strong>ä»¥ Vue Router ä¸ºä¾‹</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">let</span> routeEnterTime = performance.<span class="hljs-title function_">now</span>();\n\n<span class="hljs-comment">// ç›‘å¬è·¯ç”±å˜åŒ–</span>\nrouter.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> stayTime = performance.<span class="hljs-title function_">now</span>() - routeEnterTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>({ <span class="hljs-attr">path</span>: <span class="hljs-keyword">from</span>.<span class="hljs-property">path</span>, stayTime });\n  routeEnterTime = performance.<span class="hljs-title function_">now</span>(); <span class="hljs-comment">// é‡ç½®ä¸ºæ–°è·¯ç”±çš„è¿›å…¥æ—¶é—´</span>\n});\n\n<span class="hljs-comment">// åˆå§‹é¡µé¢åŠ è½½ä»éœ€ç›‘å¬ beforeunload</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;beforeunload&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">const</span> finalStayTime = performance.<span class="hljs-title function_">now</span>() - routeEnterTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>({\n    <span class="hljs-attr">path</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>,\n    <span class="hljs-attr">stayTime</span>: finalStayTime,\n  });\n});\n</code></pre>\n<p><strong>æ³¨æ„</strong>   ï¼š</p>\n<ul>\n<li>éœ€ç»“åˆæ¡†æ¶çš„è·¯ç”±ç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚ React çš„ <code>useEffect</code>ï¼‰ã€‚</li>\n<li>åˆå§‹é¡µé¢åŠ è½½ä»éœ€ç›‘å¬ <code>beforeunload</code> æˆ– <code>pagehide</code>ã€‚</li>\n</ul>\n<hr>\n<h2><strong>5. æ•°æ®ä¸ŠæŠ¥ï¼šå¦‚ä½•ç¡®ä¿æˆåŠŸï¼Ÿ</strong></h2>\n<p>åœ¨å¸è½½é˜¶æ®µï¼ˆå¦‚ <code>beforeunload</code>ï¼‰ï¼Œå¼‚æ­¥è¯·æ±‚ï¼ˆå¦‚ <code>fetch</code>ï¼‰å¯èƒ½è¢«ä¸­æ–­ï¼Œéœ€ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p>\n<h3><strong>(1) <code>navigator.sendBeacon()</code>ï¼ˆæ¨èï¼‰</strong></h3>\n<p>ä¸“ä¸ºå¸è½½é˜¶æ®µè®¾è®¡ï¼Œæµè§ˆå™¨ä¼šä¿è¯è¯·æ±‚å®Œæˆã€‚</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendStayTimeToServer</span>(<span class="hljs-params">data</span>) {\n  <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)], { <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;application/json&quot;</span> });\n  navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-string">&quot;/api/log-stay-time&quot;</span>, blob);\n}\n</code></pre>\n<h3><strong>(2) <code>Image</code> å¯¹è±¡åŒæ­¥å‘é€ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendStayTimeToServer</span>(<span class="hljs-params">data</span>) {\n  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();\n  img.<span class="hljs-property">src</span> = <span class="hljs-string">`/api/log-stay-time?data=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">JSON</span>.stringify(data))}</span>`</span>;\n}\n</code></pre>\n<p><strong>æ³¨æ„</strong>   ï¼š</p>\n<ul>\n<li>é¿å…åœ¨å¸è½½é˜¶æ®µå‘é€å¤§é‡æ•°æ®ï¼ˆå¯èƒ½è¢«æµè§ˆå™¨ä¸¢å¼ƒï¼‰ã€‚</li>\n<li>æ•°æ®å°½é‡è½»é‡åŒ–ï¼ˆå¦‚ä»…å‘é€æ—¶é—´æˆ³å’Œå…³é”®æŒ‡æ ‡ï¼‰ã€‚</li>\n</ul>\n<hr>\n<h2><strong>6. ç‰¹æ®Šåœºæ™¯å¤„ç†</strong></h2>\n<h3><strong>(1) ç§»åŠ¨ç«¯å…¼å®¹æ€§</strong></h3>\n<ul>\n<li>iOS Safari å¯¹ <code>beforeunload</code> æ”¯æŒè¾ƒå·®ï¼Œä¼˜å…ˆç”¨ <code>pagehide</code> + <code>visibilitychange</code>ã€‚</li>\n<li>éƒ¨åˆ†å®‰å“æµè§ˆå™¨å¯èƒ½é™åˆ¶ <code>alert()</code> æˆ–åŒæ­¥è¯·æ±‚ï¼Œéœ€ä¾èµ– <code>sendBeacon</code>ã€‚</li>\n</ul>\n<h3><strong>(2) bfcacheï¼ˆBack-Forward Cacheï¼‰</strong></h3>\n<ul>\n<li>å½“ç”¨æˆ·é€šè¿‡åé€€æŒ‰é’®è¿”å›é¡µé¢æ—¶ï¼Œæµè§ˆå™¨å¯èƒ½ä»ç¼“å­˜åŠ è½½é¡µé¢ï¼Œæ­¤æ—¶ <code>pagehide</code> å’Œ <code>pageshow</code> å¯æ­£ç¡®ç»Ÿè®¡æ—¶é—´ã€‚</li>\n<li>ç›‘å¬ <code>pageshow</code> çš„ <code>event.persisted</code> å±æ€§ï¼š<pre><code class="language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;pageshow&quot;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">persisted</span>) {\n    <span class="hljs-comment">// é¡µé¢ä» bfcache æ¢å¤ï¼Œé‡ç½®è®¡æ—¶</span>\n    pageLoadTime = performance.<span class="hljs-title function_">now</span>();\n  }\n});\n</code></pre>\n</li>\n</ul>\n<h3><strong>(3) è·¨é¡µé¢ä¼šè¯è·Ÿè¸ª</strong></h3>\n<ul>\n<li>é€šè¿‡ <code>localStorage</code> æˆ– <code>Cookie</code> å­˜å‚¨ä¼šè¯ IDï¼Œç¡®ä¿è·¨é¡µé¢è¡Œä¸ºå¯å…³è”ï¼š<pre><code class="language-javascript"><span class="hljs-keyword">let</span> sessionId = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&quot;sessionId&quot;</span>) || <span class="hljs-title function_">generateSessionId</span>();\n<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&quot;sessionId&quot;</span>, sessionId);\n</code></pre>\n</li>\n</ul>\n<hr>\n<h2><strong>7. å®Œæ•´ä»£ç ç¤ºä¾‹ï¼ˆæ¨èæ–¹æ¡ˆï¼‰</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-comment">// 1. åˆå§‹åŒ–</span>\n<span class="hljs-keyword">let</span> pageLoadTime = performance.<span class="hljs-title function_">now</span>();\n<span class="hljs-keyword">let</span> totalStayTime = <span class="hljs-number">0</span>;\n<span class="hljs-keyword">let</span> lastVisibleTime = pageLoadTime;\n<span class="hljs-keyword">let</span> sessionId = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&quot;sessionId&quot;</span>) || <span class="hljs-title function_">generateSessionId</span>();\n\n<span class="hljs-comment">// 2. ç›‘å¬å¯è§æ€§å˜åŒ–</span>\n<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;visibilitychange&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">&quot;hidden&quot;</span>) {\n    totalStayTime += performance.<span class="hljs-title function_">now</span>() - lastVisibleTime;\n  } <span class="hljs-keyword">else</span> {\n    lastVisibleTime = performance.<span class="hljs-title function_">now</span>();\n  }\n});\n\n<span class="hljs-comment">// 3. ç›‘å¬é¡µé¢éšè—ï¼ˆç§»åŠ¨ç«¯ã€bfcacheï¼‰</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;pagehide&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  totalStayTime += performance.<span class="hljs-title function_">now</span>() - lastVisibleTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>({ sessionId, <span class="hljs-attr">stayTime</span>: totalStayTime });\n});\n\n<span class="hljs-comment">// 4. ç›‘å¬å¸è½½äº‹ä»¶ï¼ˆå…œåº•ï¼‰</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;beforeunload&quot;</span>, <span class="hljs-function">() =&gt;</span> {\n  totalStayTime += performance.<span class="hljs-title function_">now</span>() - lastVisibleTime;\n  <span class="hljs-title function_">sendStayTimeToServer</span>({ sessionId, <span class="hljs-attr">stayTime</span>: totalStayTime });\n});\n\n<span class="hljs-comment">// 5. å‘é€æ•°æ®å‡½æ•°ï¼ˆä½¿ç”¨ sendBeaconï¼‰</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendStayTimeToServer</span>(<span class="hljs-params">data</span>) {\n  <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)], { <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;application/json&quot;</span> });\n  navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-string">&quot;/api/log-stay-time&quot;</span>, blob);\n}\n\n<span class="hljs-comment">// 6. ç”Ÿæˆä¼šè¯IDï¼ˆç¤ºä¾‹ï¼‰</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateSessionId</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;session_&quot;</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>);\n}\n</code></pre>\n<hr>\n<h2><strong>8. æ€»ç»“</strong></h2>\n<table>\n<thead>\n<tr>\n<th>åœºæ™¯</th>\n<th>æ¨èæ–¹æ³•</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>æ™®é€š PC é¡µé¢</strong></td>\n<td><code>visibilitychange</code> + <code>beforeunload</code> + <code>sendBeacon</code></td>\n</tr>\n<tr>\n<td><strong>ç§»åŠ¨ç«¯é¡µé¢</strong></td>\n<td><code>pagehide</code> + <code>visibilitychange</code> + <code>sendBeacon</code></td>\n</tr>\n<tr>\n<td><strong>SPA åº”ç”¨</strong></td>\n<td>ç›‘å¬è·¯ç”±å˜åŒ– + <code>pagehide</code>/<code>beforeunload</code></td>\n</tr>\n<tr>\n<td><strong>é«˜å®æ—¶æ€§éœ€æ±‚</strong></td>\n<td>å®šæ—¶ä¸ŠæŠ¥ï¼ˆ<code>setInterval</code>ï¼‰ + <code>beforeunload</code> å…œåº•</td>\n</tr>\n<tr>\n<td><strong>bfcache å…¼å®¹</strong></td>\n<td>ç›‘å¬ <code>pageshow</code> çš„ <code>event.persisted</code></td>\n</tr>\n</tbody>\n</table>\n<p><strong>å…³é”®ç‚¹</strong>   ï¼š</p>\n<ol>\n<li><strong>ä¼˜å…ˆä½¿ç”¨ <code>visibilitychange</code></strong>   ï¼ˆè¦†ç›–æ ‡ç­¾é¡µåˆ‡æ¢ï¼‰ã€‚</li>\n<li><strong>ç§»åŠ¨ç«¯è¡¥å…… <code>pagehide</code></strong>   ï¼ˆæ¯” <code>beforeunload</code> æ›´å¯é ï¼‰ã€‚</li>\n<li><strong>SPA éœ€ç›‘å¬è·¯ç”±å˜åŒ–</strong>   ã€‚</li>\n<li><strong>æ•°æ®ä¸ŠæŠ¥ç”¨ <code>sendBeacon</code></strong>   ï¼ˆé¿å…è¯·æ±‚ä¸­æ–­ï¼‰ã€‚</li>\n<li><strong>ç»“åˆä¼šè¯ ID</strong>   å®ç°è·¨é¡µé¢è¡Œä¸ºåˆ†æã€‚</li>\n</ol>\n<p>è¿™æ ·å¯ä»¥æœ€å¤§åŒ–è¦†ç›–ç”¨æˆ·ç¦»å¼€é¡µé¢çš„åœºæ™¯ï¼Œç¡®ä¿æ•°æ®ç»Ÿè®¡çš„å‡†ç¡®æ€§ï¼ ğŸš€</p>\n</div>'</script></body></html>