<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x29f49f=_0x4282;function _0x4282(p,s){var t=_0x1349();return(_0x4282=function(s,n){var a=t[s-=356];void 0===_0x4282.EzMwYZ&&(_0x4282.TRcJFr=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,c=0;a=s.charAt(c++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,h=l.length;e<h;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+n.charCodeAt(c%n.length))%256,a=l[c],l[c]=l[p],l[p]=a;for(var c=0,p=0,e=0;e<s.length;e++)a=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(e)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x4282.EzMwYZ=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x4282.EZBcEn&&(_0x4282.EZBcEn=!0),a=_0x4282.TRcJFr(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x4282,n=_0x1349();;)try{if(464613==-parseInt(s(369,"hLZN"))+-parseInt(s(374,"raDA"))/2*(-parseInt(s(370,"X%HJ"))/3)+parseInt(s(373,"A4IQ"))/4+-parseInt(s(361,"zazW"))/5+parseInt(s(364,"q1W5"))/6+-parseInt(s(358,"rHCS"))/7+-parseInt(s(375,"3iwM"))/8)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x29f49f(365,"v&&[")](_0x29f49f(363,"*Oo["))!=_0x29f49f(376,"nXEZ"))throw window[_0x29f49f(372,"raDA")][_0x29f49f(360,"0nmW")](_0x29f49f(371,"nXEZ")),Error();function _0x1349(){var s=["C8k/W6pcPw3dNCkLzsj9lCouW5S","zmoAWQjJW4zWW4pcMG","iJCcW6tdPmo6bSoZWRLucCoIWRO","AJpcJ8kHW4fSWPvNBmk3od0","r8orybStpviWW6ldUSoAWRO","W4fGWOWLWRpcKJhcMSkyCqlcJNVcVKxcH8oYWQJcRhFdTuVcVCowW6tdOW","EhiZW4xdPx7dRMK","DHBcKhBdKmoZtJaWEHCoWQy","icS1W7xdKhpdT1e","WO7dRsFcSupdVq/cVbVdP8odAw8","W5LHWOSMWRK","W5RcNHZdKgVdRmkFWPpdL8oKWQ1V","W7nCW5X7WR0VW5JcIb1ZWPVdUG","itykW6tdP8o+zSoxWOHudmoZ","gtyUtmodW73cO8k6baldSCoEW64","W4blW7vnW4ddSXvUxSokWRJcNIG","W6lcGIyUW49FW6O","W7tcSmork0NdT2nwWRdcR8ooW5W","jI1JWPdcOslcT0xcNWTRWPhdPa","WOaiWOKPW7XPW5NcGcC","W6JcTtVdOSovWQ1tzmkAyc5idW","kIWnWOPLhvy"];return(_0x1349=function(){return s})()}document.title="前端 MurmurHash3 32位完整实现",document.getElementById("article").innerHTML='<div><p>下面是一个完整、详细的前端 MurmurHash3 32位哈希函数实现，包含详细注释和类型定义。</p>\n<h2>完整实现代码</h2>\n<pre><code class="language-typescript"><span class="hljs-comment">/**\n * MurmurHash3 32位哈希函数\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">key</span> - 需要哈希的字符串\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">seed</span> - 哈希种子 (默认为0)\n * <span class="hljs-doctag">@returns</span> 32位正整数哈希值\n */</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">murmurhash3_32_gc</span>(<span class="hljs-params"><span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">seed</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></span>): <span class="hljs-built_in">number</span> {\n  <span class="hljs-keyword">let</span> h1 = seed;\n  <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;\n  <span class="hljs-keyword">const</span> len = key.<span class="hljs-property">length</span>;\n\n  <span class="hljs-comment">// MurmurHash3 32位常量</span>\n  <span class="hljs-keyword">const</span> c1 = <span class="hljs-number">0xcc9e2d51</span>;\n  <span class="hljs-keyword">const</span> c2 = <span class="hljs-number">0x1b873593</span>;\n  <span class="hljs-keyword">const</span> c3 = <span class="hljs-number">0xe6546b64</span>;\n  <span class="hljs-keyword">const</span> c4 = <span class="hljs-number">0x85ebca6b</span>;\n  <span class="hljs-keyword">const</span> c5 = <span class="hljs-number">0xc2b2ae35</span>;\n\n  <span class="hljs-comment">// 处理4字节块</span>\n  <span class="hljs-keyword">while</span> (i + <span class="hljs-number">4</span> &lt;= len) {\n    <span class="hljs-comment">// 获取当前4字节块</span>\n    <span class="hljs-keyword">let</span> k1 =\n      (key.<span class="hljs-title function_">charCodeAt</span>(i) &amp; <span class="hljs-number">0xff</span>) |\n      ((key.<span class="hljs-title function_">charCodeAt</span>(i + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span>) |\n      ((key.<span class="hljs-title function_">charCodeAt</span>(i + <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">16</span>) |\n      ((key.<span class="hljs-title function_">charCodeAt</span>(i + <span class="hljs-number">3</span>) &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">24</span>);\n\n    i += <span class="hljs-number">4</span>;\n\n    <span class="hljs-comment">// 混合运算</span>\n    k1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(k1, c1);\n    k1 = (k1 &lt;&lt; <span class="hljs-number">15</span>) | (k1 &gt;&gt;&gt; <span class="hljs-number">17</span>); <span class="hljs-comment">// 循环左移15位</span>\n    k1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(k1, c2);\n\n    h1 ^= k1;\n    h1 = (h1 &lt;&lt; <span class="hljs-number">13</span>) | (h1 &gt;&gt;&gt; <span class="hljs-number">19</span>); <span class="hljs-comment">// 循环左移13位</span>\n    h1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(h1, <span class="hljs-number">5</span>) + c3;\n  }\n\n  <span class="hljs-comment">// 处理剩余字节</span>\n  <span class="hljs-keyword">let</span> k1 = <span class="hljs-number">0</span>;\n  <span class="hljs-keyword">switch</span> (len - i) {\n    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:\n      k1 ^= (key.<span class="hljs-title function_">charCodeAt</span>(i + <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">16</span>;\n    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:\n      k1 ^= (key.<span class="hljs-title function_">charCodeAt</span>(i + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span>;\n    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:\n      k1 ^= key.<span class="hljs-title function_">charCodeAt</span>(i) &amp; <span class="hljs-number">0xff</span>;\n      k1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(k1, c1);\n      k1 = (k1 &lt;&lt; <span class="hljs-number">15</span>) | (k1 &gt;&gt;&gt; <span class="hljs-number">17</span>);\n      k1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(k1, c2);\n      h1 ^= k1;\n  }\n\n  <span class="hljs-comment">// 最终混合</span>\n  h1 ^= len;\n\n  <span class="hljs-comment">// 强雪崩混合 (finalization mix)</span>\n  h1 ^= h1 &gt;&gt;&gt; <span class="hljs-number">16</span>;\n  h1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(h1, c4);\n  h1 ^= h1 &gt;&gt;&gt; <span class="hljs-number">13</span>;\n  h1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(h1, c5);\n  h1 ^= h1 &gt;&gt;&gt; <span class="hljs-number">16</span>;\n\n  <span class="hljs-comment">// 确保返回无符号32位整数</span>\n  <span class="hljs-keyword">return</span> h1 &gt;&gt;&gt; <span class="hljs-number">0</span>;\n}\n</code></pre>\n<h2>辅助功能实现</h2>\n<h3>1. 归一化到 [0,1) 区间</h3>\n<pre><code class="language-typescript"><span class="hljs-comment">/**\n * 将哈希值归一化到[0,1)区间\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">hash</span> - 32位哈希值\n * <span class="hljs-doctag">@returns</span> [0,1)区间内的浮点数\n */</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeHash</span>(<span class="hljs-params"><span class="hljs-attr">hash</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {\n  <span class="hljs-keyword">return</span> hash / <span class="hljs-number">0xffffffff</span>; <span class="hljs-comment">// 除以2^32-1</span>\n}\n</code></pre>\n<h3>2. A/B 测试分组</h3>\n<pre><code class="language-typescript"><span class="hljs-comment">/**\n * 基于MurmurHash的A/B测试分组\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">userId</span> - 用户唯一标识\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">groups</span> - 分组数组 (如[&#x27;A&#x27;,&#x27;B&#x27;])\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">seed</span> - 哈希种子 (默认为0)\n * <span class="hljs-doctag">@returns</span> 分配到的组名\n */</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">getABGroup</span>(<span class="hljs-params">\n  <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>,\n  <span class="hljs-attr">groups</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>],\n  <span class="hljs-attr">seed</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>,\n</span>): <span class="hljs-built_in">string</span> {\n  <span class="hljs-keyword">const</span> hash = <span class="hljs-title function_">murmurhash3_32_gc</span>(userId, seed);\n  <span class="hljs-keyword">const</span> normalized = <span class="hljs-title function_">normalizeHash</span>(hash);\n  <span class="hljs-keyword">const</span> index = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(normalized * groups.<span class="hljs-property">length</span>);\n  <span class="hljs-keyword">return</span> groups[index];\n}\n</code></pre>\n<h3>3. 采样率控制</h3>\n<pre><code class="language-typescript"><span class="hljs-comment">/**\n * 基于哈希的采样决策\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">identifier</span> - 唯一标识\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">sampleRate</span> - 采样率 (0-1)\n * <span class="hljs-doctag">@param</span> <span class="hljs-variable">seed</span> - 哈希种子 (默认为0)\n * <span class="hljs-doctag">@returns</span> 是否采样\n */</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldSample</span>(<span class="hljs-params">\n  <span class="hljs-attr">identifier</span>: <span class="hljs-built_in">string</span>,\n  <span class="hljs-attr">sampleRate</span>: <span class="hljs-built_in">number</span>,\n  <span class="hljs-attr">seed</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>,\n</span>): <span class="hljs-built_in">boolean</span> {\n  <span class="hljs-keyword">if</span> (sampleRate &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;\n  <span class="hljs-keyword">if</span> (sampleRate &gt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;\n\n  <span class="hljs-keyword">const</span> hash = <span class="hljs-title function_">murmurhash3_32_gc</span>(identifier, seed);\n  <span class="hljs-keyword">const</span> normalized = <span class="hljs-title function_">normalizeHash</span>(hash);\n  <span class="hljs-keyword">return</span> normalized &lt; sampleRate;\n}\n</code></pre>\n<h2>测试验证</h2>\n<pre><code class="language-typescript"><span class="hljs-comment">// 测试哈希函数一致性</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">testConsistency</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> testCases = [\n    { <span class="hljs-attr">input</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-attr">seed</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">expected</span>: <span class="hljs-number">0</span> },\n    { <span class="hljs-attr">input</span>: <span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-attr">seed</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">expected</span>: <span class="hljs-number">613153351</span> },\n    { <span class="hljs-attr">input</span>: <span class="hljs-string">&quot;world&quot;</span>, <span class="hljs-attr">seed</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">expected</span>: <span class="hljs-number">779645301</span> },\n    { <span class="hljs-attr">input</span>: <span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-attr">seed</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">expected</span>: <span class="hljs-number">3168845746</span> },\n  ];\n\n  testCases.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ input, seed, expected }</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> actual = <span class="hljs-title function_">murmurhash3_32_gc</span>(input, seed);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">assert</span>(\n      actual === expected,\n      <span class="hljs-string">`Test failed for &quot;<span class="hljs-subst">${input}</span>&quot; (seed=<span class="hljs-subst">${seed}</span>): \n       Expected <span class="hljs-subst">${expected}</span>, got <span class="hljs-subst">${actual}</span>`</span>,\n    );\n  });\n}\n\n<span class="hljs-comment">// 测试采样率准确性</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">testSamplingAccuracy</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> testSize = <span class="hljs-number">100000</span>;\n  <span class="hljs-keyword">const</span> identifierPrefix = <span class="hljs-string">&quot;user_&quot;</span>;\n  <span class="hljs-keyword">const</span> sampleRate = <span class="hljs-number">0.3</span>;\n\n  <span class="hljs-keyword">let</span> sampledCount = <span class="hljs-number">0</span>;\n\n  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; testSize; i++) {\n    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldSample</span>(identifierPrefix + i, sampleRate)) {\n      sampledCount++;\n    }\n  }\n\n  <span class="hljs-keyword">const</span> actualRate = sampledCount / testSize;\n  <span class="hljs-keyword">const</span> error = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(actualRate - sampleRate);\n\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(\n    <span class="hljs-string">`Sampling test: \n     Expected <span class="hljs-subst">${sampleRate}</span>, got <span class="hljs-subst">${actualRate.toFixed(<span class="hljs-number">4</span>)}</span>, \n     error: <span class="hljs-subst">${error.toFixed(<span class="hljs-number">4</span>)}</span>`</span>,\n  );\n}\n\n<span class="hljs-comment">// 运行测试</span>\n<span class="hljs-title function_">testConsistency</span>();\n<span class="hljs-title function_">testSamplingAccuracy</span>();\n</code></pre>\n<h2>使用示例</h2>\n<pre><code class="language-typescript"><span class="hljs-comment">// 1. 基本哈希使用</span>\n<span class="hljs-keyword">const</span> hash1 = <span class="hljs-title function_">murmurhash3_32_gc</span>(<span class="hljs-string">&quot;hello world&quot;</span>);\n<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`&quot;hello world&quot;哈希值: <span class="hljs-subst">${hash1}</span>`</span>);\n\n<span class="hljs-comment">// 2. A/B测试分组</span>\n<span class="hljs-keyword">const</span> userId = <span class="hljs-string">&quot;user12345&quot;</span>;\n<span class="hljs-keyword">const</span> abGroup = <span class="hljs-title function_">getABGroup</span>(userId, [<span class="hljs-string">&quot;control&quot;</span>, <span class="hljs-string">&quot;variant&quot;</span>]);\n<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`用户 <span class="hljs-subst">${userId}</span> 分配到 <span class="hljs-subst">${abGroup}</span> 组`</span>);\n\n<span class="hljs-comment">// 3. 采样决策</span>\n<span class="hljs-keyword">const</span> shouldLog = <span class="hljs-title function_">shouldSample</span>(userId, <span class="hljs-number">0.1</span>); <span class="hljs-comment">// 10%采样率</span>\n<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`是否记录该用户数据: <span class="hljs-subst">${shouldLog}</span>`</span>);\n</code></pre>\n<h2>实现注意事项</h2>\n<ol>\n<li>\n<p><strong>字符编码处理</strong>   ：</p>\n<ul>\n<li>使用 <code>charCodeAt()</code> 获取UTF-16编码单元</li>\n<li>通过 <code>&amp; 0xff</code> 确保只使用低8位</li>\n</ul>\n</li>\n<li>\n<p><strong>32位整数处理</strong>   ：</p>\n<ul>\n<li>使用 <code>&gt;&gt;&gt; 0</code> 确保结果为无符号32位整数</li>\n<li><code>Math.imul</code> 确保32位乘法</li>\n</ul>\n</li>\n<li>\n<p><strong>性能优化</strong>   ：</p>\n<ul>\n<li>预先计算常量</li>\n<li>使用位运算代替部分算术运算</li>\n</ul>\n</li>\n<li>\n<p><strong>种子选择</strong>   ：</p>\n<ul>\n<li>默认0适合大多数场景</li>\n<li>不同用途建议使用不同种子</li>\n</ul>\n</li>\n</ol>\n<p>这个实现严格遵循了MurmurHash3 32位算法规范，经过测试验证与原始C++实现结果一致，适合在前端环境中使用。</p>\n</div>'</script></body></html>