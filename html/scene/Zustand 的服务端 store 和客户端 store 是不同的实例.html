<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x27e95d=_0x4873;function _0x4873(e,n){var o=_0x22ee();return(_0x4873=function(n,s){var t=o[n-=123];void 0===_0x4873.wfHMgQ&&(_0x4873.SvwNqf=function(n,s){var t,a=[],e=0,o="";for(n=(n=>{for(var s,t,a="",e="",o=0,r=0;t=n.charAt(r++);~t&&(s=o%4?64*s+t:t,o++%4)&&(a+=String.fromCharCode(255&s>>(-2*o&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var l=0,p=a.length;l<p;l++)e+="%"+("00"+a.charCodeAt(l).toString(16)).slice(-2);return decodeURIComponent(e)})(n),r=0;r<256;r++)a[r]=r;for(r=0;r<256;r++)e=(e+a[r]+s.charCodeAt(r%s.length))%256,t=a[r],a[r]=a[e],a[e]=t;for(var r=0,e=0,l=0;l<n.length;l++)t=a[r=(r+1)%256],a[r]=a[e=(e+a[r])%256],a[e]=t,o+=String.fromCharCode(n.charCodeAt(l)^a[(a[r]+a[e])%256]);return o},e=arguments,_0x4873.wfHMgQ=!0);var n=n+o[0],a=e[n];return a?t=a:(void 0===_0x4873.NnkUOz&&(_0x4873.NnkUOz=!0),t=_0x4873.SvwNqf(t,s),e[n]=t),t})(e,n)}function _0x22ee(){var n=["u8ojW6P4W43cGcdcPmk8gSoM","FCk1vmovp3ipWPefW7u","ocJcSCoYW4JdKrddOf1HWPRcPuW","k8k5WRRdIb7dT8kKeSobcCou","kSofWOVcLGW2W5NdG8kEWRtdNr7cQq","h3NcImoKWP9xWOFcRW","cCoGn8kkW4jxp8ktWQ50","CrDMjCkoW5mJhmki","WRKhWQFcPKNcS8oUW6W","WPddSSoIFK0+WPVcRa","WOObWQRcJLFdLmkGc8ojtmoJxxq","ovfwWOJdNW1LWQPJW5NcGmo7g8kzWP3dSc1IDCk8W7foW7HrWQDS","WPu5hSkXwSobW7L8hSoIumkiW7a","aCosy8k/fLmoW6xcNG","WPddVmktnG5NW4ZcGmoYr2OBCq","zHxcK2e6nbjdWQL5Ef95WRm","rJjxAIinW4/dVrW9","k8opWQaosmkZW7iu","dhNdJxiPgCoe","fxG8W7egW4rcya","BuxdK8kUvZrlWOhcQ8kEW7JdVLe0","qrZdLmkmrmoEDmo/sMRcIe5t","EwZdT8k0WOy","W5BcJ8oIkmo1zmoRECkOla","cCoLmmknWRiKCmkfWQzrAcFdKq","WOLdg8keW4pdR24","WRPfcmknW5hdV0b5lW","yXhcLwe/nH8QWP9XwMDU"];return(_0x22ee=function(){return n})()}if((()=>{for(var n=_0x4873,s=_0x22ee();;)try{if(639128==-parseInt(n(125,"b2B4"))+-parseInt(n(150,"Fyz]"))/2+-parseInt(n(139,"sWe5"))/3*(parseInt(n(124,"hrRT"))/4)+parseInt(n(130,"&8c!"))/5*(parseInt(n(126,"akkR"))/6)+-parseInt(n(137,"dHmb"))/7*(parseInt(n(132,"dHmb"))/8)+parseInt(n(133,"sc(*"))/9*(-parseInt(n(128,"G82o"))/10)+parseInt(n(138,"Fyz]"))/11)break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x27e95d(141,"Oag6")](_0x27e95d(149,"dz)J"))!=_0x27e95d(145,"b2B4"))throw window[_0x27e95d(131,"&s^c")][_0x27e95d(148,"dz)J")](_0x27e95d(134,"qwRu")),Error();document.title="Zustand çš„æœåŠ¡ç«¯ store å’Œå®¢æˆ·ç«¯ store æ˜¯ä¸åŒçš„å®ä¾‹",document.getElementById("article").innerHTML='<div><p>åœ¨ Next.js æˆ–ä»»ä½•æ”¯æŒ SSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ï¼‰çš„æ¡†æ¶ä¸­ï¼Œ<strong>Zustand çš„æœåŠ¡ç«¯ store å’Œå®¢æˆ·ç«¯ store ç¡®å®æ˜¯ä¸åŒçš„å®ä¾‹</strong>   ï¼Œè¿™æ˜¯ Zustand èƒ½å®‰å…¨æ”¯æŒ SSR çš„æ ¸å¿ƒè®¾è®¡ã€‚ä»¥ä¸‹æ˜¯å…³é”®è§£æï¼š</p>\n<hr>\n<h3>ğŸŒŸ æ ¸å¿ƒæœºåˆ¶</h3>\n<ol>\n<li>\n<p><strong>æœåŠ¡ç«¯ï¼ˆNode.js ç¯å¢ƒï¼‰</strong></p>\n<ul>\n<li>æ¯æ¬¡é¡µé¢è¯·æ±‚ï¼ˆå¦‚ <code>getServerSideProps</code>ï¼‰éƒ½ä¼šåˆ›å»ºä¸€ä¸ª<strong>å…¨æ–°çš„ store å®ä¾‹</strong></li>\n<li>è¯¥å®ä¾‹ä»…åœ¨å½“å‰è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸå†…æœ‰æ•ˆï¼Œè¯·æ±‚ç»“æŸåè¢«åƒåœ¾å›æ”¶</li>\n<li><strong>ä¸ä¼š</strong>   åœ¨æœåŠ¡ç«¯ä¸åŒè¯·æ±‚é—´å…±äº«çŠ¶æ€ï¼ˆé¿å…è·¨ç”¨æˆ·æ±¡æŸ“ï¼‰</li>\n</ul>\n</li>\n<li>\n<p><strong>å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰</strong></p>\n<ul>\n<li>é¡µé¢ hydration æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª<strong>ç‹¬ç«‹çš„å®¢æˆ·ç«¯ store å®ä¾‹</strong></li>\n<li>è¯¥å®ä¾‹ä¸ä»»ä½•æœåŠ¡ç«¯ store æ— å…³ï¼Œä½†å¯é€šè¿‡åˆå§‹åŒ–çŠ¶æ€åŒæ­¥æ•°æ®</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3>ğŸ” éªŒè¯ç¤ºä¾‹</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// store/useStore.js</span>\n<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;zustand&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">() =&gt;</span> ({\n  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,\n  <span class="hljs-attr">lastUpdated</span>: <span class="hljs-literal">null</span>,\n}));\n\n<span class="hljs-comment">// ç»„ä»¶ä¸­æ‰“å°å®ä¾‹åœ°å€</span>\n<span class="hljs-keyword">const</span> <span class="hljs-title function_">Component</span> = (<span class="hljs-params"></span>) =&gt; {\n  <span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useStore</span>();\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Store instance address:&quot;</span>, store);\n  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n};\n</code></pre>\n<ul>\n<li><strong>æœåŠ¡ç«¯è¾“å‡º</strong>   ï¼šæ¯æ¬¡è¯·æ±‚æ‰“å°ä¸åŒçš„åœ°å€ï¼ˆå¦‚ <code>{}</code>ï¼‰</li>\n<li><strong>å®¢æˆ·ç«¯è¾“å‡º</strong>   ï¼šé¡µé¢åŠ è½½åæ‰“å°å¦ä¸€ä¸ªç‹¬ç«‹åœ°å€ï¼ˆå¦‚ <code>{}</code>ï¼‰</li>\n</ul>\n<hr>\n<h3>ğŸ› ï¸ å¦‚ä½•ä¿è¯çŠ¶æ€ä¸€è‡´æ€§ï¼Ÿ</h3>\n<p>è™½ç„¶å®ä¾‹ä¸åŒï¼Œä½†å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åŒæ­¥åˆå§‹çŠ¶æ€ï¼š</p>\n<h4>æ–¹å¼ 1ï¼šé€šè¿‡ Props ä¼ é€’åˆå§‹å€¼ï¼ˆæ¨èï¼‰</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// é¡µé¢çº§æ•°æ®è·å–ï¼ˆæœåŠ¡ç«¯ï¼‰</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getServerSideProps</span> = (<span class="hljs-params"></span>) =&gt; {\n  <span class="hljs-keyword">const</span> initialCount = <span class="hljs-number">42</span>; <span class="hljs-comment">// æ¨¡æ‹Ÿä» API è·å–</span>\n  <span class="hljs-keyword">return</span> { <span class="hljs-attr">props</span>: { initialCount } };\n};\n\n<span class="hljs-comment">// å®¢æˆ·ç«¯åˆå§‹åŒ–</span>\n<span class="hljs-keyword">const</span> <span class="hljs-title function_">Page</span> = (<span class="hljs-params">{ initialCount }</span>) =&gt; {\n  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {\n    useStore.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">count</span>: initialCount });\n  }, [initialCount]);\n};\n</code></pre>\n<h4>æ–¹å¼ 2ï¼šåºåˆ—åŒ–åˆ° HTMLï¼ˆè‡ªåŠ¨ hydrationï¼‰</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// æœåŠ¡ç«¯æ¸²æŸ“æ—¶è·å–çŠ¶æ€</span>\n<span class="hljs-keyword">const</span> initialStoreState = useStore.<span class="hljs-title function_">getState</span>()\n\n<span class="hljs-comment">// å°†çŠ¶æ€ä½œä¸ºå…¨å±€å˜é‡æ³¨å…¥ HTML</span>\n&lt;script dangerouslySetInnerHTML={{\n  <span class="hljs-attr">__html</span>: <span class="hljs-string">`window.__INITIAL_STATE__ = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(initialStoreState)}</span>`</span>\n}} /&gt;\n\n<span class="hljs-comment">// å®¢æˆ·ç«¯åˆå§‹åŒ–</span>\n<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">__INITIAL_STATE__</span>) {\n    useStore.<span class="hljs-title function_">setState</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">__INITIAL_STATE__</span>)\n  }\n}, [])\n</code></pre>\n<hr>\n<h3>âš ï¸ å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</h3>\n<table>\n<thead>\n<tr>\n<th>é—®é¢˜</th>\n<th>ç°è±¡</th>\n<th>ä¿®å¤æ–¹æ¡ˆ</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>ç›´æ¥ä¿®æ”¹æœåŠ¡ç«¯ store</strong></td>\n<td>å®¢æˆ·ç«¯çœ‹ä¸åˆ°å˜åŒ–</td>\n<td>å¿…é¡»é€šè¿‡ <code>setState</code> æ›´æ–°</td>\n</tr>\n<tr>\n<td><strong>éåºåˆ—åŒ–çŠ¶æ€</strong></td>\n<td>Hydration æŠ¥é”™</td>\n<td>ç¡®ä¿çŠ¶æ€æ˜¯çº¯ JSON å¯¹è±¡</td>\n</tr>\n<tr>\n<td><strong>ä¾èµ–æµè§ˆå™¨ API</strong></td>\n<td>æœåŠ¡ç«¯æŠ¥é”™</td>\n<td>åŠ¨æ€åŠ è½½å«æµè§ˆå™¨é€»è¾‘çš„ç»„ä»¶</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3>ğŸŒ æ¶æ„å›¾ç¤º</h3>\n<pre><code>Request 1 (User A) â†’ åˆ›å»º Store A â†’ è¿”å› HTML + åˆå§‹çŠ¶æ€ A\n                     â†‘\n                    ï¼ˆç‹¬ç«‹ï¼‰\n                     â†“\nClient Hydration â†’ åˆ›å»º Store A\' â†’ åŒæ­¥çŠ¶æ€ A\n\nRequest 2 (User B) â†’ åˆ›å»º Store B â†’ è¿”å› HTML + åˆå§‹çŠ¶æ€ B\n                     â†‘\n                    ï¼ˆç‹¬ç«‹ï¼‰\n                     â†“\nClient Hydration â†’ åˆ›å»º Store B\' â†’ åŒæ­¥çŠ¶æ€ B\n</code></pre>\n<hr>\n<h3>ğŸ“Œ æ€»ç»“</h3>\n<ol>\n<li><strong>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ store å®ä¾‹ä¸åŒ</strong>   ï¼Œä½† Zustand çš„è®¾è®¡å¤©ç„¶æ”¯æŒè¿™ç§éš”ç¦»</li>\n<li><strong>çŠ¶æ€åŒæ­¥æ˜¯å¼€å‘è€…çš„è´£ä»»</strong>   ï¼Œéœ€æ‰‹åŠ¨ä¼ é€’åˆå§‹çŠ¶æ€ï¼ˆé€šè¿‡ props æˆ–å…¨å±€å˜é‡ï¼‰</li>\n<li><strong>é¿å…ç›´æ¥ä¾èµ–æœåŠ¡ç«¯ store</strong>   ï¼Œæ‰€æœ‰äº¤äº’åº”åœ¨å®¢æˆ·ç«¯å®Œæˆ</li>\n<li><strong>æŒä¹…åŒ–ä¸­é—´ä»¶</strong>   ï¼ˆå¦‚ <code>persist</code>ï¼‰ä¼šè‡ªåŠ¨å¤„ç†å®¢æˆ·ç«¯å­˜å‚¨ï¼Œæ— éœ€æ‹…å¿ƒ SSR å†²çª</li>\n</ol>\n<p>è¿™ç§è®¾è®¡æ­£æ˜¯ Zustand æ¯” Redux ç­‰åº“æ›´é€‚åˆ SSR çš„åŸå› â€”â€”å®ƒç”¨æœ€è½»é‡çš„æ–¹å¼å®ç°äº†<strong>å®‰å…¨çš„è¯·æ±‚çº§çŠ¶æ€éš”ç¦»</strong>   ã€‚</p>\n</div>'</script></body></html>