<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x271e17=_0x1d08;function _0x4d4b(){var s=["gSkWW71mimoCbmoWWP7dSHBdUwG","W5CgW6ddRsK","W6xcVmktzLhdT8ouW4xcU3S","WOJcRNPfFmk7WR3cTfDaW5tdOxu","WO4zWQixd2Tfzq","W551W5qvW7xdQIixW6ym","g8kZWRmME8kTvCoR","lmk5WP7dOK1hW7yTuq4","u2b9WReti8o3","W6BcS09du8kcxmonsG","uCk4puJdPmobW55+sZL7W7/cMW","vCkrWQBcNSkyhw45sZ4","W5GEW6FdVSkRW4zNiSo+hsddOSoh","WPzcWQtcQgbpWRBcLmk+WOimWQRcVa","EuZdL8osCCkSW4Outmo+","W5bgWRyVgefdwW","W5pdQtCgn8kZWQRdKezUW4ZdNM9bdtqbW59ZbGNdR8o7WRKkAW","WOe6mWrqkmk0cXpdISouWRik","WPatW7fLW5xcKSoZ","oZVdTSoFW7tdK8oCWP7dSCk8CCox","W6tcU8kBBrdcHCkGW6ZcMfK9oSox","WQtdICkVWPqxEeNcJbDC","sCk7xJOKW7WlWQZdLmk9","W7qLW7XoWQ7cOfxcKmkyyCkAAce","WP9hWQVcP2bmW7VcPCkHWOmhWQK","W6zWoSocW4nfsmowW4FdTa"];return(_0x4d4b=function(){return s})()}function _0x1d08(p,s){var t=_0x4d4b();return(_0x1d08=function(s,n){var a=t[s-=258];void 0===_0x1d08.iXCOAy&&(_0x1d08.lYEXor=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var r=0,o=l.length;r<o;r++)p+="%"+("00"+l.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,r=0;r<s.length;r++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(r)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x1d08.iXCOAy=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x1d08.Iifoph&&(_0x1d08.Iifoph=!0),a=_0x1d08.lYEXor(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x1d08,n=_0x4d4b();;)try{if(465676==-parseInt(s(264,"4qsf"))+parseInt(s(263,"!Ul6"))/2+-parseInt(s(279,"4qsf"))/3+-parseInt(s(273,"L]@b"))/4*(parseInt(s(271,"w%D7"))/5)+parseInt(s(266,"lilD"))/6+-parseInt(s(280,"$lOj"))/7*(-parseInt(s(262,"A2S1"))/8)+-parseInt(s(260,"415e"))/9*(-parseInt(s(281,"&zYd"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x271e17(274,"w$K3")](_0x271e17(275,"V@0K"))!=_0x271e17(267,"4qsf"))throw window[_0x271e17(270,"&zYd")][_0x271e17(258,"6rl&")](_0x271e17(282,"5&mk")),Error();document.title="Next.js 的 API Routes 使用场景",document.getElementById("article").innerHTML='<div><p>Next.js 的 <strong>API Routes</strong>   允许你在同一个项目中编写后端逻辑，无需单独部署服务器。以下是其核心使用场景及具体实现方式：</p>\n<hr>\n<h3>一、核心使用场景</h3>\n<h4>1. <strong>轻量级后端接口</strong></h4>\n<ul>\n<li><strong>适用场景</strong>   ：\n<ul>\n<li>用户认证（登录/注册）</li>\n<li>表单提交（联系表单、支付回调）</li>\n<li>数据库操作（CRUD）</li>\n</ul>\n</li>\n<li><strong>优势</strong>   ：<br>\n✅ 避免跨域问题（同域请求）<br>\n✅ 无需维护独立后端服务</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-comment">// pages/api/auth/login.js</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) {\n  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">&quot;POST&quot;</span>) {\n    <span class="hljs-keyword">const</span> { email, password } = req.<span class="hljs-property">body</span>;\n    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> db.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({ <span class="hljs-attr">where</span>: { email } });\n\n    <span class="hljs-keyword">if</span> (user?.<span class="hljs-property">password</span> === <span class="hljs-title function_">hash</span>(password)) {\n      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">token</span>: <span class="hljs-title function_">generateToken</span>(user) });\n    } <span class="hljs-keyword">else</span> {\n      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;Invalid credentials&quot;</span> });\n    }\n  } <span class="hljs-keyword">else</span> {\n    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Allow&quot;</span>, [<span class="hljs-string">&quot;POST&quot;</span>]);\n    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">405</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;Method Not Allowed&quot;</span>);\n  }\n}\n</code></pre>\n<h4>2. <strong>代理第三方 API</strong></h4>\n<ul>\n<li><strong>适用场景</strong>   ：\n<ul>\n<li>隐藏敏感 API 密钥（如 Stripe、Google Maps）</li>\n<li>统一封装多个第三方接口</li>\n</ul>\n</li>\n<li><strong>优势</strong>   ：<br>\n✅ 前端不暴露密钥<br>\n✅ 可缓存或修改第三方响应</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-comment">// pages/api/proxy/weather.js</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) {\n  <span class="hljs-keyword">const</span> { city } = req.<span class="hljs-property">query</span>;\n  <span class="hljs-keyword">const</span> apiKey = process.<span class="hljs-property">env</span>.<span class="hljs-property">WEATHER_API_KEY</span>;\n  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(\n    <span class="hljs-string">`https://api.weatherapi.com/v1/current.json?key=<span class="hljs-subst">${apiKey}</span>&amp;q=<span class="hljs-subst">${city}</span>`</span>,\n  );\n  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();\n\n  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>(data);\n}\n</code></pre>\n<h4>3. <strong>Serverless 函数</strong></h4>\n<ul>\n<li><strong>适用场景</strong>   ：\n<ul>\n<li>定时任务（如每天清理数据库）</li>\n<li>文件上传处理（压缩/转码）</li>\n</ul>\n</li>\n<li><strong>优势</strong>   ：<br>\n✅ 按需执行，节省成本（Vercel/AWS Lambda）</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-comment">// pages/api/cron/cleanup.js</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) {\n  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span> !== <span class="hljs-string">`Bearer <span class="hljs-subst">${process.env.CRON_SECRET}</span>`</span>) {\n    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">end</span>();\n  }\n\n  <span class="hljs-keyword">await</span> db.<span class="hljs-property">logs</span>.<span class="hljs-title function_">deleteOldEntries</span>();\n  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> });\n}\n</code></pre>\n<h4>4. <strong>Webhook 接收器</strong></h4>\n<ul>\n<li><strong>适用场景</strong>   ：\n<ul>\n<li>GitHub/GitLab 的 CI 通知</li>\n<li>Stripe/PayPal 支付回调</li>\n</ul>\n</li>\n<li><strong>优势</strong>   ：<br>\n✅ 直接处理外部服务事件</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-comment">// pages/api/webhooks/stripe.js</span>\n<span class="hljs-keyword">import</span> <span class="hljs-title class_">Stripe</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;stripe&quot;</span>;\n\n<span class="hljs-keyword">const</span> stripe = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stripe</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">STRIPE_SECRET_KEY</span>);\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) {\n  <span class="hljs-keyword">const</span> sig = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;stripe-signature&quot;</span>];\n  <span class="hljs-keyword">let</span> event;\n\n  <span class="hljs-keyword">try</span> {\n    event = stripe.<span class="hljs-property">webhooks</span>.<span class="hljs-title function_">constructEvent</span>(\n      req.<span class="hljs-property">body</span>,\n      sig,\n      process.<span class="hljs-property">env</span>.<span class="hljs-property">STRIPE_WEBHOOK_SECRET</span>,\n    );\n  } <span class="hljs-keyword">catch</span> (err) {\n    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">`Webhook Error: <span class="hljs-subst">${err.message}</span>`</span>);\n  }\n\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;payment_intent.succeeded&quot;</span>) {\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">handleSuccessfulPayment</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">object</span>);\n  }\n\n  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">received</span>: <span class="hljs-literal">true</span> });\n}\n</code></pre>\n<hr>\n<h3>二、技术细节与最佳实践</h3>\n<h4>1. <strong>请求方法处理</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) {\n  <span class="hljs-keyword">switch</span> (req.<span class="hljs-property">method</span>) {\n    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;GET&quot;</span>:\n      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Read data&quot;</span> });\n      <span class="hljs-keyword">break</span>;\n    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;POST&quot;</span>:\n      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">201</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Create data&quot;</span> });\n      <span class="hljs-keyword">break</span>;\n    <span class="hljs-attr">default</span>:\n      res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Allow&quot;</span>, [<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>]);\n      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">405</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;Method Not Allowed&quot;</span>);\n  }\n}\n</code></pre>\n<h4>2. <strong>环境变量安全</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// .env.local</span>\n<span class="hljs-variable constant_">STRIPE_SECRET_KEY</span> = sk_test_xxx;\n\n<span class="hljs-comment">// pages/api/payment.js</span>\n<span class="hljs-keyword">const</span> key = process.<span class="hljs-property">env</span>.<span class="hljs-property">STRIPE_SECRET_KEY</span>; <span class="hljs-comment">// 仅服务端可见</span>\n</code></pre>\n<h4>3. <strong>TypeScript 类型支持</strong></h4>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next&quot;</span>;\n\n<span class="hljs-keyword">type</span> <span class="hljs-title class_">ResponseData</span> = {\n  <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>;\n  <span class="hljs-attr">data</span>?: <span class="hljs-built_in">any</span>;\n  <span class="hljs-attr">error</span>?: <span class="hljs-built_in">string</span>;\n};\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">\n  <span class="hljs-attr">req</span>: <span class="hljs-title class_">NextApiRequest</span>,\n  <span class="hljs-attr">res</span>: <span class="hljs-title class_">NextApiResponse</span>&lt;<span class="hljs-title class_">ResponseData</span>&gt;,\n</span>) {\n  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> });\n}\n</code></pre>\n<h4>4. <strong>数据库连接池优化</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// lib/db.js</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@prisma/client&#x27;</span>;\n\n<span class="hljs-keyword">const</span> globalForPrisma = globalThis;\n<span class="hljs-keyword">const</span> prisma = globalForPrisma.<span class="hljs-property">prisma</span> || <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>();\n\n<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">&#x27;production&#x27;</span>) globalForPrisma.<span class="hljs-property">prisma</span> = prisma;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> prisma;\n\n<span class="hljs-comment">// API 路由中使用</span>\n<span class="hljs-keyword">import</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../lib/db&#x27;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) {\n  <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> db.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>();\n  res.<span class="hljs-title function_">json</span>(users);\n}\n</code></pre>\n<hr>\n<h3>三、何时不适合使用 API Routes？</h3>\n<ol>\n<li>\n<p><strong>高性能计算</strong>   ：</p>\n<ul>\n<li>需要长时间 CPU 运算（如视频转码）</li>\n<li>❌ Serverless 函数有超时限制（Vercel 默认 10 秒）</li>\n</ul>\n</li>\n<li>\n<p><strong>持久化连接</strong>   ：</p>\n<ul>\n<li>WebSocket 实时通信</li>\n<li>❌ 无状态函数无法保持长连接</li>\n</ul>\n</li>\n<li>\n<p><strong>复杂微服务架构</strong>   ：</p>\n<ul>\n<li>需要 gRPC、消息队列等高级功能</li>\n<li>❌ 应使用 Nest.js、Fastify 等专业后端框架</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3>四、部署注意事项</h3>\n<table>\n<thead>\n<tr>\n<th>平台</th>\n<th>特性</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Vercel</strong></td>\n<td>自动优化 + 全球 CDN</td>\n</tr>\n<tr>\n<td><strong>AWS</strong></td>\n<td>通过 Lambda 部署</td>\n</tr>\n<tr>\n<td><strong>Docker</strong></td>\n<td>需自定义 <code>server.js</code> 配置</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3>总结：API Routes 的核心价值</h3>\n<ul>\n<li><strong>快速原型开发</strong>   ：前后端一体化，减少协作成本</li>\n<li><strong>无缝扩展</strong>   ：从简单接口逐步演进到复杂逻辑</li>\n<li><strong>生态集成</strong>   ：直接使用 Next.js 的中间件、ISR 等功能</li>\n</ul>\n<p>适合：中小型项目、需要快速迭代的全栈应用。<br>\n不适合：高并发计算、实时通信或超大规模服务。</p>\n</div>'</script></body></html>