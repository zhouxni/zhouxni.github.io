<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x4452d4=_0x186e;function _0x186e(e,s){var p=_0x1ff8();return(_0x186e=function(s,n){var a=p[s-=248];void 0===_0x186e.VdNNSb&&(_0x186e.EXgxRh=function(s,n){var a,l=[],e=0,p="";for(s=(s=>{for(var n,a,l="",e="",p=0,t=0;a=s.charAt(t++);~a&&(n=p%4?64*n+a:a,p++%4)&&(l+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,r=l.length;c<r;c++)e+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(e)})(s),t=0;t<256;t++)l[t]=t;for(t=0;t<256;t++)e=(e+l[t]+n.charCodeAt(t%n.length))%256,a=l[t],l[t]=l[e],l[e]=a;for(var t=0,e=0,c=0;c<s.length;c++)a=l[t=(t+1)%256],l[t]=l[e=(e+l[t])%256],l[e]=a,p+=String.fromCharCode(s.charCodeAt(c)^l[(l[t]+l[e])%256]);return p},e=arguments,_0x186e.VdNNSb=!0);var s=s+p[0],l=e[s];return l?a=l:(void 0===_0x186e.ftnlFZ&&(_0x186e.ftnlFZ=!0),a=_0x186e.EXgxRh(a,n),e[s]=a),a})(e,s)}function _0x1ff8(){var s=["WOZcMCoHm0KoWQJcT244","kSkogxNdTSknpNOD","vmoPW7DrWOqrW63dPmk5","WOFcT8kIWQTCsJC","W5pcTwBdGaJdVmkcW6pcJ3y/Ca","tadcUtlcKSkkWR/dGG","WOXlW54Ps23dJG","tmkjWOGorXjVgfqBiSkbza","ogddQc85amoHcSoFWOi","WO3dKCkfWOnSuWldMG","WOOjW4dcSZddHt3cUfRdMu8s","q8kjWOVdMdJcSqSxWQuyWORcIG","o2BdRc9TC8ofkmomWP5dfW","dSoZl1eXq8kfC3WLumk3W6G","W5JdHCkuW6mUlL9+tSoIWRmA","WPyPWQyeWQfPESkKW7BcUSoGgq","W617hdWgW6FdKqhcQe4hW7RcLdhcOGjnW5/cNZzyW6hdRZSvWPW","ACoHW5XTW4SlcITf","evFdQ2dcGSkYWRFdQLRdLG","W48BWPLZhtRcMW7cOgdcPCk/W5C","W5VcPN0drSoyyalcGmki","dCojW4Xlcq","W53cQ3KesCo/rIlcImkT","WOZdV8kPfdKqnHPkW7m","jmkRW7qqW5S8au/cTW","hSkZWOLEW5CAmsvS","W48BWPSvs3tdJJxcOa","W5ZdLH3cK0BcPmkg","EdxcGSoGjGNdJra8uSokeCoV","WOZcMSkEsx/dHa54","W5XzWOxdIxhcKd4","i8kVW7CwW5uKfhxcGG"];return(_0x1ff8=function(){return s})()}if((()=>{for(var s=_0x186e,n=_0x1ff8();;)try{if(957580==-parseInt(s(265,"rbIz"))*(-parseInt(s(279,"tgf9"))/2)+parseInt(s(259,"L[Uj"))/3*(-parseInt(s(256,"gn]8"))/4)+-parseInt(s(273,"xZ2v"))/5*(-parseInt(s(270,"gUVR"))/6)+-parseInt(s(260,"XGq3"))/7+parseInt(s(250,"gn]8"))/8*(parseInt(s(251,"r7(("))/9)+parseInt(s(257,"9bH%"))/10*(-parseInt(s(271,"N4L!"))/11)+parseInt(s(254,"8b4b"))/12*(parseInt(s(249,"*MTr"))/13))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x4452d4(277,"9bH%")](_0x4452d4(272,"L$M@"))!=_0x4452d4(268,"8b4b"))throw window[_0x4452d4(252,"rbIz")][_0x4452d4(253,"xZ2v")](_0x4452d4(263,"vvSw")),Error();document.title="使用 MurmurHash3 实现前端采样率控制",document.getElementById("article").innerHTML='<div><p>在前端监控、日志收集或功能灰度发布时，经常需要实现采样率控制（即只对部分用户/请求进行处理）。下面是基于 MurmurHash3 的前端采样率实现方案。</p>\n<h2>基础采样率实现</h2>\n<pre><code class="language-javascript"><span class="hljs-comment">/**\n * 判断当前用户/请求是否在采样范围内\n * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">identifier</span> - 用户/请求的唯一标识\n * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">sampleRate</span> - 采样率 (0-1)\n * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [seed=0] - 哈希种子\n * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否采样\n */</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldSample</span>(<span class="hljs-params">identifier, sampleRate, seed = <span class="hljs-number">0</span></span>) {\n  <span class="hljs-comment">// 参数校验</span>\n  <span class="hljs-keyword">if</span> (sampleRate &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;\n  <span class="hljs-keyword">if</span> (sampleRate &gt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;\n\n  <span class="hljs-comment">// 计算哈希值并归一化到[0,1)区间</span>\n  <span class="hljs-keyword">const</span> hash = <span class="hljs-title function_">murmurhash3_32_gc</span>(identifier, seed);\n  <span class="hljs-keyword">const</span> normalized = hash / <span class="hljs-number">0xffffffff</span>;\n\n  <span class="hljs-keyword">return</span> normalized &lt; sampleRate;\n}\n</code></pre>\n<h2>进阶功能实现</h2>\n<h3>1. 分层采样（不同功能不同采样率）</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> samplingConfig = {\n  <span class="hljs-attr">errorTracking</span>: <span class="hljs-number">0.1</span>, <span class="hljs-comment">// 10%的错误追踪采样</span>\n  <span class="hljs-attr">performance</span>: <span class="hljs-number">1.0</span>, <span class="hljs-comment">// 100%的性能监控</span>\n  <span class="hljs-attr">featureFlag</span>: <span class="hljs-number">0.5</span>, <span class="hljs-comment">// 50%的功能开关检查</span>\n};\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSamplingDecision</span>(<span class="hljs-params">identifier, featureName</span>) {\n  <span class="hljs-keyword">const</span> rate = samplingConfig[featureName] || <span class="hljs-number">0</span>;\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">shouldSample</span>(identifier + featureName, rate);\n}\n</code></pre>\n<h3>2. 确保用户一致性采样</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getConsistentSampling</span>(<span class="hljs-params">identifier, sampleRate, storageKey</span>) {\n  <span class="hljs-comment">// 检查是否已有采样决策</span>\n  <span class="hljs-keyword">const</span> storedDecision = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(storageKey);\n  <span class="hljs-keyword">if</span> (storedDecision !== <span class="hljs-literal">null</span>) {\n    <span class="hljs-keyword">return</span> storedDecision === <span class="hljs-string">&quot;true&quot;</span>;\n  }\n\n  <span class="hljs-comment">// 新决策</span>\n  <span class="hljs-keyword">const</span> decision = <span class="hljs-title function_">shouldSample</span>(identifier, sampleRate);\n  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(storageKey, decision.<span class="hljs-title function_">toString</span>());\n  <span class="hljs-keyword">return</span> decision;\n}\n</code></pre>\n<h3>3. 动态调整采样率</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 从配置中心获取动态采样率</span>\n<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDynamicSampling</span>(<span class="hljs-params">identifier, featureName</span>) {\n  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;/sampling-config&quot;</span>);\n  <span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();\n  <span class="hljs-keyword">const</span> rate = config[featureName] || <span class="hljs-number">0</span>;\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">shouldSample</span>(identifier, rate);\n}\n</code></pre>\n<h2>实际应用示例</h2>\n<h3>前端错误监控采样</h3>\n<pre><code class="language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">message, source, lineno, colno, error</span>) {\n  <span class="hljs-keyword">const</span> userId = <span class="hljs-title function_">getUserId</span>(); <span class="hljs-comment">// 获取用户ID</span>\n  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldSample</span>(userId, <span class="hljs-number">0.1</span>)) {\n    <span class="hljs-comment">// 10%采样</span>\n    <span class="hljs-title function_">sendErrorToServer</span>({\n      message,\n      source,\n      lineno,\n      colno,\n      error,\n    });\n  }\n};\n</code></pre>\n<h3>功能灰度发布</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isFeatureEnabled</span>(<span class="hljs-params">featureName, userId</span>) {\n  <span class="hljs-comment">// 50%用户看到新功能</span>\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">shouldSample</span>(userId + featureName, <span class="hljs-number">0.5</span>);\n}\n\n<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isFeatureEnabled</span>(<span class="hljs-string">&quot;new_ui&quot;</span>, userId)) {\n  <span class="hljs-title function_">showNewUI</span>();\n} <span class="hljs-keyword">else</span> {\n  <span class="hljs-title function_">showOldUI</span>();\n}\n</code></pre>\n<h2>实现注意事项</h2>\n<ol>\n<li>\n<p><strong>标识符选择</strong>   ：使用稳定唯一标识（用户ID/设备ID），避免使用易变值如IP</p>\n</li>\n<li>\n<p><strong>种子隔离</strong>   ：不同采样用途使用不同seed，避免相互影响</p>\n</li>\n<li>\n<p><strong>性能考虑</strong>   ：MurmurHash3性能很高，适合前端使用</p>\n</li>\n<li>\n<p><strong>结果一致性</strong>   ：确保相同输入在不同环境产生相同结果</p>\n</li>\n<li>\n<p><strong>采样率验证</strong>   ：定期验证实际采样比例是否符合预期</p>\n</li>\n</ol>\n<h2>采样率验证方法</h2>\n<pre><code class="language-javascript"><span class="hljs-comment">// 验证采样率是否准确</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateSamplingRate</span>(<span class="hljs-params">sampleRate, iterations = <span class="hljs-number">10000</span></span>) {\n  <span class="hljs-keyword">let</span> sampled = <span class="hljs-number">0</span>;\n  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; iterations; i++) {\n    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldSample</span>(<span class="hljs-string">&quot;test_&quot;</span> + i, sampleRate)) {\n      sampled++;\n    }\n  }\n  <span class="hljs-keyword">const</span> actualRate = sampled / iterations;\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`预期采样率: <span class="hljs-subst">${sampleRate}</span>, 实际采样率: <span class="hljs-subst">${actualRate}</span>`</span>);\n}\n\n<span class="hljs-title function_">validateSamplingRate</span>(<span class="hljs-number">0.3</span>); <span class="hljs-comment">// 验证30%采样率</span>\n</code></pre>\n<p>这种基于哈希的采样方法可以确保：</p>\n<ul>\n<li>相同用户在不同会话中保持相同的采样决策</li>\n<li>精确控制采样比例</li>\n<li>无需维护状态即可实现分布式一致性采样</li>\n</ul>\n</div>'</script></body></html>