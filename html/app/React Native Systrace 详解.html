<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x556982=_0x3d62;function _0x16a0(){var s=["WQi1WR7dRxzcwJddPuiejCk/","WQVdImoFWPHVWQnZgCkZbmkPW6y","z8onW7bNW5D0W77dQmoGumkrWQFcVZ3dTv5lFd7dTSkAkSozaWay","qSo3wSopW4uXWQm","WO8pW6NdICkyWRf8","ih3dQ8oUuZtcSKbRnwi","W6HfW6tcVCk7","lmkODSoRWPBdKIrzcmoa","WPuMq8kdWOBcMCkXCZVdLv51W7O","nu7cQXHjW64mdJ/dUSkJqmov","FchdVKyUcJhcHSk4vCkzW58","v1hdKMzAtYxdHe7dOcDLW6e","WPJcVmkdW4pcNmoDWRpcHmkz","kNhdRCoMgr7cTwPzdq","W54oW7pdRCkNWOru","WPldGCoIpf9xuCoEEtLyWQ0","W7lcU8kcvCkXjXZdQvi","cSoGsCk2WRZdQgFdNW","mKZcRrjfW6PnnZJdHmk9qW","WPxcNmk+zYaXxG","ymobeSkOWQZcPsyWW5rLzeq","fWtcJfK1WRFdQCk5FJxcTWFcSW","dmobbZRcJGecWOyGnsn6W4K","lYhcPqdcNmo1pKtdHeFdTa","fqVcIWzfW7JcVSkowq","WO/cLbvJW6pcG8koW7xdOg54W4G"];return(_0x16a0=function(){return s})()}function _0x3d62(t,s){var e=_0x16a0();return(_0x3d62=function(s,n){var a=e[s-=288];void 0===_0x3d62.BlKEYa&&(_0x3d62.hjzfgh=function(s,n){var a,l=[],t=0,e="";for(s=(s=>{for(var n,a,l="",t="",e=0,p=0;a=s.charAt(p++);~a&&(n=e%4?64*n+a:a,e++%4)&&(l+=String.fromCharCode(255&n>>(-2*e&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,r=l.length;c<r;c++)t+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(t)})(s),p=0;p<256;p++)l[p]=p;for(p=0;p<256;p++)t=(t+l[p]+n.charCodeAt(p%n.length))%256,a=l[p],l[p]=l[t],l[t]=a;for(var p=0,t=0,c=0;c<s.length;c++)a=l[p=(p+1)%256],l[p]=l[t=(t+l[p])%256],l[t]=a,e+=String.fromCharCode(s.charCodeAt(c)^l[(l[p]+l[t])%256]);return e},t=arguments,_0x3d62.BlKEYa=!0);var s=s+e[0],l=t[s];return l?a=l:(void 0===_0x3d62.VVYqNr&&(_0x3d62.VVYqNr=!0),a=_0x3d62.hjzfgh(a,n),t[s]=a),a})(t,s)}if((()=>{for(var s=_0x3d62,n=_0x16a0();;)try{if(502402==+parseInt(s(297,"U)ED"))+parseInt(s(312,"uGwC"))/2*(-parseInt(s(299,"YBWe"))/3)+-parseInt(s(294,"l^!v"))/4+-parseInt(s(292,"XaLU"))/5*(parseInt(s(288,"qnoc"))/6)+-parseInt(s(309,"!rf$"))/7+parseInt(s(298,"dKZH"))/8+-parseInt(s(305,"ayoi"))/9*(-parseInt(s(303,"1Rcw"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x556982(302,"uGwC")](_0x556982(310,"tt9A"))!=_0x556982(304,"L^*%"))throw window[_0x556982(289,"wTfn")][_0x556982(301,"j3fi")](_0x556982(300,"@CIl")),Error();document.title="React Native Systrace 详解",document.getElementById("article").innerHTML='<div><h1>React Native Systrace 详解</h1>\n<p>Systrace 是 React Native 提供的性能分析工具，用于追踪和诊断应用性能问题。以下是全面解析：</p>\n<h2>一、核心概念与基础使用</h2>\n<h3>1. 基本功能</h3>\n<ul>\n<li><strong>性能追踪</strong>  ：记录应用执行的详细时间线</li>\n<li><strong>JS与原生交互分析</strong>  ：监控跨桥接通信</li>\n<li><strong>帧率分析</strong>  ：识别UI线程和JS线程的卡顿</li>\n<li><strong>自定义标记</strong>  ：添加业务逻辑的性能标记</li>\n</ul>\n<h3>2. 基础API</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Systrace</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-native&#x27;</span>;\n\n<span class="hljs-comment">// 开始/结束追踪</span>\n<span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">true</span>); \n<span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">false</span>);\n\n<span class="hljs-comment">// 添加自定义事件标记</span>\n<span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">beginEvent</span>(<span class="hljs-string">&#x27;my_event&#x27;</span>);\n<span class="hljs-comment">// ...执行代码...</span>\n<span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">endEvent</span>();\n</code></pre>\n<h2>二、高级配置与使用</h2>\n<h3>1. 完整配置选项</h3>\n<pre><code class="language-javascript"><span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">true</span>, {\n  <span class="hljs-attr">showSystraceLines</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 显示系统级事件</span>\n  <span class="hljs-attr">showNativeIds</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 显示原生模块ID</span>\n  <span class="hljs-attr">enableStackTracking</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 记录调用堆栈</span>\n});\n</code></pre>\n<h3>2. 自动化性能分析</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withSystrace</span>(<span class="hljs-params">WrappedComponent</span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">Component</span> {\n    <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">beginEvent</span>(<span class="hljs-string">&#x27;ComponentMount_&#x27;</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>);\n    }\n    \n    <span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">beginEvent</span>(<span class="hljs-string">&#x27;ComponentUpdate_&#x27;</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>);\n    }\n    \n    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> {<span class="hljs-attr">...this.props</span>} /&gt;</span></span>;\n    }\n  };\n}\n</code></pre>\n<h2>三、性能数据分析</h2>\n<h3>1. 关键指标解析</h3>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>说明</th>\n<th>优化目标</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>JS帧时间</td>\n<td>JavaScript执行时间</td>\n<td>&lt;16ms</td>\n</tr>\n<tr>\n<td>UI帧时间</td>\n<td>原生UI线程时间</td>\n<td>&lt;16ms</td>\n</tr>\n<tr>\n<td>桥接调用</td>\n<td>JS与原生通信次数</td>\n<td>最小化</td>\n</tr>\n<tr>\n<td>内存占用</td>\n<td>各模块内存使用</td>\n<td>合理范围</td>\n</tr>\n</tbody>\n</table>\n<h3>2. 常见性能问题特征</h3>\n<ul>\n<li><strong>长帧</strong>  ：单帧时间超过16ms</li>\n<li><strong>桥接拥堵</strong>  ：大量Pending桥接调用</li>\n<li><strong>内存泄漏</strong>  ：内存占用持续增长</li>\n<li><strong>布局抖动</strong>  ：频繁重计算布局</li>\n</ul>\n<h2>四、平台集成与工具链</h2>\n<h3>1. Android集成</h3>\n<pre><code class="language-sh"><span class="hljs-comment"># 命令行捕获trace</span>\n$ adb shell systrace --<span class="hljs-keyword">time</span>=10 -o trace.html <span class="hljs-built_in">sched</span> gfx view util\n</code></pre>\n<h3>2. iOS集成</h3>\n<pre><code class="language-sh"><span class="hljs-comment"># 使用Instruments工具</span>\n$ xctrace record --template <span class="hljs-string">&#x27;Time Profiler&#x27;</span> --output trace.trace\n</code></pre>\n<h3>3. 可视化分析工具</h3>\n<ol>\n<li><strong>Chrome DevTools</strong>  ：加载<code>chrome://tracing</code></li>\n<li><strong>Perfetto</strong>  ：Android官方分析工具</li>\n<li><strong>Instruments</strong>  ：iOS官方工具套件</li>\n</ol>\n<h2>五、React Native特定优化</h2>\n<h3>1. 桥接调用优化标记</h3>\n<pre><code class="language-javascript"><span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">beginEvent</span>(<span class="hljs-string">&#x27;bridge_call&#x27;</span>);\n<span class="hljs-title class_">NativeModules</span>.<span class="hljs-property">MyModule</span>.<span class="hljs-title function_">doSomething</span>()\n  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">endEvent</span>());\n</code></pre>\n<h3>2. 渲染性能分析</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">traceRender</span>(<span class="hljs-params">componentName</span>) {\n  <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">beginEvent</span>(<span class="hljs-string">`render_<span class="hljs-subst">${componentName}</span>`</span>);\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">end</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">endEvent</span>(),\n    <span class="hljs-attr">mark</span>: <span class="hljs-function">(<span class="hljs-params">label</span>) =&gt;</span> <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">counterEvent</span>(<span class="hljs-string">`render_<span class="hljs-subst">${componentName}</span>_<span class="hljs-subst">${label}</span>`</span>)\n  };\n}\n\n<span class="hljs-comment">// 使用示例</span>\n<span class="hljs-keyword">const</span> trace = <span class="hljs-title function_">traceRender</span>(<span class="hljs-string">&#x27;MyComponent&#x27;</span>);\n<span class="hljs-comment">// ...渲染逻辑...</span>\ntrace.<span class="hljs-title function_">mark</span>(<span class="hljs-string">&#x27;state_updated&#x27;</span>);\n<span class="hljs-comment">// ...更多逻辑...</span>\ntrace.<span class="hljs-title function_">end</span>();\n</code></pre>\n<h2>六、生产环境实践</h2>\n<h3>1. 采样式性能监控</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PERF_SAMPLE_RATE</span> = <span class="hljs-number">0.01</span>; <span class="hljs-comment">// 1%采样率</span>\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">maybeTrace</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; <span class="hljs-variable constant_">PERF_SAMPLE_RATE</span>) {\n    <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">true</span>, { \n      <span class="hljs-attr">enableStackTracking</span>: <span class="hljs-literal">false</span> \n    });\n    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">false</span>), <span class="hljs-number">5000</span>);\n  }\n}\n\n<span class="hljs-comment">// 在关键用户路径调用</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleNavigation</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-title function_">maybeTrace</span>();\n  <span class="hljs-comment">// ...导航逻辑...</span>\n}\n</code></pre>\n<h3>2. 自动化分析流程</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureCriticalPath</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> traceFile = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>.trace`</span>;\n  \n  <span class="hljs-comment">// 开始记录</span>\n  <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">true</span>, { \n    traceFile,\n    <span class="hljs-attr">bufferSize</span>: <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment">// 5MB缓冲区</span>\n  });\n\n  <span class="hljs-comment">// 模拟用户操作</span>\n  <span class="hljs-keyword">await</span> <span class="hljs-title function_">simulateUserFlow</span>(); \n\n  <span class="hljs-comment">// 停止并上传</span>\n  <span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">false</span>);\n  <span class="hljs-title function_">uploadTraceFile</span>(traceFile);\n}\n</code></pre>\n<h2>七、调试技巧与问题解决</h2>\n<h3>1. 常见问题诊断表</h3>\n<table>\n<thead>\n<tr>\n<th>现象</th>\n<th>可能原因</th>\n<th>解决方案</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>JS线程卡顿</td>\n<td>复杂计算阻塞</td>\n<td>分片处理任务</td>\n</tr>\n<tr>\n<td>UI线程卡顿</td>\n<td>复杂布局/阴影</td>\n<td>简化视图层级</td>\n</tr>\n<tr>\n<td>桥接延迟</td>\n<td>频繁小数据通信</td>\n<td>批量处理调用</td>\n</tr>\n<tr>\n<td>内存增长</td>\n<td>未释放资源</td>\n<td>检查引用链</td>\n</tr>\n</tbody>\n</table>\n<h3>2. 标记命名规范建议</h3>\n<ol>\n<li><strong>模块前缀</strong>  ：<code>bridge_</code>、<code>ui_</code>、<code>js_</code></li>\n<li><strong>动作语义</strong>  ：<code>start</code>、<code>end</code>、<code>process</code></li>\n<li><strong>场景标识</strong>  ：<code>chat_scroll</code>、<code>image_load</code></li>\n<li><strong>性能关键</strong>  ：<code>slow_path</code>、<code>hot_spot</code></li>\n</ol>\n<h2>八、与其它工具集成</h2>\n<h3>1. 结合Flipper</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在Flipper配置中启用Systrace插件</span>\n{\n  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;react-native&#x27;</span>,\n  <span class="hljs-attr">config</span>: {\n    <span class="hljs-attr">systrace</span>: {\n      <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">bufferSize</span>: <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>\n    }\n  }\n}\n</code></pre>\n<h3>2. 结合React DevTools</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在性能分析时同时启用</span>\n<span class="hljs-title class_">Systrace</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">true</span>);\n<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;react-devtools-core&#x27;</span>).<span class="hljs-title function_">connectToDevTools</span>({\n  <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;localhost&#x27;</span>,\n  <span class="hljs-attr">port</span>: <span class="hljs-number">8097</span>\n});\n</code></pre>\n<p>通过深入使用Systrace，开发者可以：</p>\n<ol>\n<li>准确定位性能瓶颈</li>\n<li>优化关键渲染路径</li>\n<li>减少不必要的桥接通信</li>\n<li>建立性能监控体系</li>\n</ol>\n<p>建议将关键业务路径的追踪纳入CI流程，持续监控性能回归。</p>\n</div>'</script></body></html>