<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x174f(a,n){var r=_0x3fc3();return(_0x174f=function(n,s){var t=r[n-=320];void 0===_0x174f.ZVzFFh&&(_0x174f.HrLqiG=function(n,s){var t,e=[],a=0,r="";for(n=(n=>{for(var s,t,e="",a="",r=0,o=0;t=n.charAt(o++);~t&&(s=r%4?64*s+t:t,r++%4)&&(e+=String.fromCharCode(255&s>>(-2*r&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var l=0,c=e.length;l<c;l++)a+="%"+("00"+e.charCodeAt(l).toString(16)).slice(-2);return decodeURIComponent(a)})(n),o=0;o<256;o++)e[o]=o;for(o=0;o<256;o++)a=(a+e[o]+s.charCodeAt(o%s.length))%256,t=e[o],e[o]=e[a],e[a]=t;for(var o=0,a=0,l=0;l<n.length;l++)t=e[o=(o+1)%256],e[o]=e[a=(a+e[o])%256],e[a]=t,r+=String.fromCharCode(n.charCodeAt(l)^e[(e[o]+e[a])%256]);return r},a=arguments,_0x174f.ZVzFFh=!0);var n=n+r[0],e=a[n];return e?t=e:(void 0===_0x174f.InITLz&&(_0x174f.InITLz=!0),t=_0x174f.HrLqiG(t,s),a[n]=t),t})(a,n)}function _0x3fc3(){var n=["W4JcLmkie1qdWPtdKCo6W7pcMmkGW4y","tWuJW6FcGXviqCkVWOBdK8kzWOi","BmkbWQOKW6y","W4VcLSkiev1uW5RdNSoEW7xcPa","D8oelmksfCkHWPGF","omo3W51PWPyMW6W","DSoGi8oWl8o3bmoNmKpcUmorWRq","W4neitnSW6VcMJfL","DIaLWPRdVSkGbge","W6ZcS1/cUCkYW5ZcKmocev8","ASkIWP1fWRqQW4xcNSkJ","W7VcPSkTjtZcTtBcSG","WOxcQmkncHqFtW","CHRdO8ovW5OmfeVdNtC","WRiZtrxdPLm6wSoc","DrJdOSktW4KMavhdMG","rcVcISobWRTYW6VdJMae","uY8BuSoDW61LASoDW7nIhG","iKeHf8kqWQZcRcnnWOW","WQxdUmo3C3dcVYpcV8oXWRGy","WRzrc8kmWO3dI0tdUmkx","D8opxSoRb8koWOGpWOZdSG","jceNAuNcUanqW7JdT8oQqq","W7BcHM3dKq/dQmoriCoPkCoXDLq","WP/cUCkjfGzgbCozWQFcJJFcK8kTmCoPjCkqgfPqW5PyFmonnmk1","W5KHxSosW63cLmoznM7dNq","lSkADbKaW7Cgcmky","W7lcGwZcPuFcH8ksemo1"];return(_0x3fc3=function(){return n})()}var _0xc10e62=_0x174f;if((()=>{for(var n=_0x174f,s=_0x3fc3();;)try{if(143599==-parseInt(n(323,"0hww"))*(parseInt(n(328,"bfRH"))/2)+parseInt(n(333,"yiBy"))/3+-parseInt(n(337,"b9F%"))/4*(parseInt(n(343,")s95"))/5)+-parseInt(n(330,"yiBy"))/6+parseInt(n(338,"y(D8"))/7*(parseInt(n(347,"Oamr"))/8)+parseInt(n(327,"$gEB"))/9*(parseInt(n(344,"kjL@"))/10)+parseInt(n(331,"*ST5"))/11)break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0xc10e62(335,"g2Hb")](_0xc10e62(322,"Pyc]"))!=_0xc10e62(332,"#px2"))throw window[_0xc10e62(341,"E^kA")][_0xc10e62(342,"V(MV")](_0xc10e62(326,"V(MV")),Error();document.title="React Native Metro 详解",document.getElementById("article").innerHTML='<div><p>Metro 是 React Native 的默认 JavaScript 打包工具（bundler），负责：</p>\n<ol>\n<li><strong>代码转换</strong>  （Transforming）—— 使用 Babel 转换 JS/TS 代码。</li>\n<li><strong>依赖解析</strong>  （Resolving）—— 处理 <code>import/require</code> 依赖关系。</li>\n<li><strong>打包优化</strong>  （Serializing）—— 生成高效的单文件 bundle（如 <code>index.bundle</code>）。</li>\n</ol>\n<hr>\n<h2><strong>1. Metro 核心工作流程</strong></h2>\n<pre><code class="language-mermaid">graph LR\nA[入口文件 (index.js)] --&gt; B[代码转换 (Babel)]\nB --&gt; C[依赖解析]\nC --&gt; D[打包优化]\nD --&gt; E[输出 bundle (index.bundle)]\n</code></pre>\n<h3><strong>关键步骤</strong></h3>\n<ol>\n<li><strong>启动 Metro Server</strong>  （<code>react-native start</code>）：\n<ul>\n<li>监听文件变化，实时重新打包（HMR 热更新）。</li>\n</ul>\n</li>\n<li><strong>请求 Bundle</strong>  （<code>http://localhost:8081/index.bundle?platform=android</code>）：\n<ul>\n<li>设备/模拟器通过 HTTP 请求获取 bundle。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2><strong>2. 核心配置文件 <code>metro.config.js</code></strong></h2>\n<p>Metro 的配置基于 <code>metro-config</code>，常见结构如下：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { getDefaultConfig } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;metro-config&#x27;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = (<span class="hljs-title function_">async</span> () =&gt; {\n  <span class="hljs-keyword">const</span> {\n    <span class="hljs-attr">resolver</span>: { sourceExts, assetExts },\n  } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDefaultConfig</span>();\n\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">transformer</span>: {\n      <span class="hljs-comment">// Babel 转换配置</span>\n      <span class="hljs-attr">babelTransformerPath</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;react-native-svg-transformer&#x27;</span>),\n      <span class="hljs-attr">getTransformOptions</span>: <span class="hljs-title function_">async</span> () =&gt; ({\n        <span class="hljs-attr">transform</span>: {\n          <span class="hljs-attr">experimentalImportSupport</span>: <span class="hljs-literal">false</span>,\n          <span class="hljs-attr">inlineRequires</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用 inlineRequires 优化</span>\n        },\n      }),\n    },\n    <span class="hljs-attr">resolver</span>: {\n      <span class="hljs-comment">// 依赖解析配置</span>\n      <span class="hljs-attr">assetExts</span>: assetExts.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">ext</span> =&gt;</span> ext !== <span class="hljs-string">&#x27;svg&#x27;</span>), <span class="hljs-comment">// 排除 SVG</span>\n      <span class="hljs-attr">sourceExts</span>: [...sourceExts, <span class="hljs-string">&#x27;svg&#x27;</span>, <span class="hljs-string">&#x27;cjs&#x27;</span>], <span class="hljs-comment">// 添加额外扩展名</span>\n      <span class="hljs-attr">extraNodeModules</span>: {\n        <span class="hljs-comment">// 别名（Alias）</span>\n        <span class="hljs-string">&#x27;@components&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src/components&#x27;</span>),\n      },\n    },\n    <span class="hljs-attr">serializer</span>: {\n      <span class="hljs-comment">// 打包输出配置</span>\n      <span class="hljs-attr">experimentalSerializerHook</span>: <span class="hljs-function">() =&gt;</span> {},\n    },\n  };\n})();\n</code></pre>\n<hr>\n<h2><strong>3. 关键配置详解</strong></h2>\n<h3><strong>(1) <code>transformer</code>（代码转换）</strong></h3>\n<table>\n<thead>\n<tr>\n<th>配置项</th>\n<th>作用</th>\n<th>示例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>babelTransformerPath</code></td>\n<td>自定义 Babel 转换器</td>\n<td><code>require.resolve(\'react-native-svg-transformer\')</code></td>\n</tr>\n<tr>\n<td><code>getTransformOptions</code></td>\n<td>控制 Babel 转换行为</td>\n<td><code>inlineRequires: true</code>（优化启动速度）</td>\n</tr>\n<tr>\n<td><code>minifierPath</code></td>\n<td>替换默认压缩工具（如 Terser）</td>\n<td><code>require.resolve(\'metro-minify-terser\')</code></td>\n</tr>\n</tbody>\n</table>\n<h3><strong>(2) <code>resolver</code>（依赖解析）</strong></h3>\n<table>\n<thead>\n<tr>\n<th>配置项</th>\n<th>作用</th>\n<th>示例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>sourceExts</code></td>\n<td>支持的源代码扩展名</td>\n<td><code>[\'js\', \'jsx\', \'ts\', \'tsx\', \'svg\']</code></td>\n</tr>\n<tr>\n<td><code>assetExts</code></td>\n<td>静态资源扩展名</td>\n<td><code>[\'png\', \'jpg\', \'ttf\']</code></td>\n</tr>\n<tr>\n<td><code>extraNodeModules</code></td>\n<td>模块别名（Alias）</td>\n<td><code>{ \'@utils\': path.resolve(__dirname, \'src/utils\') }</code></td>\n</tr>\n<tr>\n<td><code>nodeModulesPaths</code></td>\n<td>自定义 <code>node_modules</code> 查找路径</td>\n<td><code>[\'./shared/node_modules\']</code></td>\n</tr>\n</tbody>\n</table>\n<h3><strong>(3) <code>serializer</code>（打包优化）</strong></h3>\n<table>\n<thead>\n<tr>\n<th>配置项</th>\n<th>作用</th>\n<th>示例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>experimentalSerializerHook</code></td>\n<td>自定义打包逻辑</td>\n<td>用于 Code Push 差分更新</td>\n</tr>\n<tr>\n<td><code>polyfillModuleNames</code></td>\n<td>强制注入 Polyfill</td>\n<td><code>[\'core-js/stable\']</code></td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>4. Metro 性能优化</strong></h2>\n<h3><strong>(1) 启用 <code>inlineRequires</code></strong></h3>\n<pre><code class="language-javascript"><span class="hljs-attr">transformer</span>: {\n  <span class="hljs-attr">getTransformOptions</span>: <span class="hljs-title function_">async</span> () =&gt; ({\n    <span class="hljs-attr">transform</span>: {\n      <span class="hljs-attr">inlineRequires</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 减少启动时的模块加载</span>\n    },\n  }),\n}\n</code></pre>\n<ul>\n<li><strong>效果</strong>  ：减少 bundle 加载时间（Facebook 实测降低 20% 启动时间）。</li>\n</ul>\n<h3><strong>(2) 排除不必要的文件</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-attr">resolver</span>: {\n  <span class="hljs-attr">blacklistRE</span>: <span class="hljs-regexp">/\\.spec\\.js$/</span>, <span class="hljs-comment">// 忽略测试文件</span>\n}\n</code></pre>\n<h3><strong>(3) 使用 RAM Bundle（iOS 专属）</strong></h3>\n<pre><code class="language-sh">npx react-native bundle \\\n  --platform ios \\\n  --dev <span class="hljs-literal">false</span> \\\n  --entry-file index.js \\\n  --bundle-output main.jsbundle \\\n  --assets-dest ./assets \\\n  --max-workers 4 \\\n  --reset-cache \\\n  --config $(<span class="hljs-built_in">pwd</span>)/metro.config.js \\\n  --verbose\n</code></pre>\n<ul>\n<li><strong>优势</strong>  ：按需加载模块，减少内存占用。</li>\n</ul>\n<hr>\n<h2><strong>5. Metro 与 Code Push 热更新</strong></h2>\n<p>Metro 生成的 bundle 是 Code Push 热更新的基础：</p>\n<ol>\n<li><strong>生成差分包</strong>  ：<pre><code class="language-sh">code-push release-react MyApp ios --output ./bundle --mandatory\n</code></pre>\n</li>\n<li><strong>自定义 Metro 序列化</strong>  （<code>serializer.experimentalSerializerHook</code>）：\n<ul>\n<li>可优化 Code Push 的增量更新策略。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2><strong>6. 常见问题</strong></h2>\n<h3><strong>(1) <code>Unable to resolve module</code> 错误</strong></h3>\n<p><strong>原因</strong>  ：Metro 未正确解析依赖。<br>\n<strong>解决</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-attr">resolver</span>: {\n  <span class="hljs-attr">extraNodeModules</span>: {\n    <span class="hljs-comment">// 确保所有别名路径正确</span>\n    <span class="hljs-string">&#x27;@assets&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src/assets&#x27;</span>),\n  },\n}\n</code></pre>\n<h3><strong>(2) HMR 热更新失效</strong></h3>\n<p><strong>原因</strong>  ：Metro Server 缓存问题。<br>\n<strong>解决</strong>  ：</p>\n<pre><code class="language-sh">npx react-native start --reset-cache\n</code></pre>\n<h3><strong>(3) 打包速度慢</strong></h3>\n<p><strong>优化方案</strong>  ：</p>\n<ul>\n<li>增加 <code>--max-workers</code>（多核并行打包）。</li>\n<li>使用 <code>--reset-cache</code> 清理缓存。</li>\n</ul>\n<hr>\n<h2><strong>总结</strong></h2>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>Metro 配置</th>\n<th>优化技巧</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>代码转换</strong></td>\n<td><code>transformer</code></td>\n<td><code>inlineRequires: true</code></td>\n</tr>\n<tr>\n<td><strong>依赖解析</strong></td>\n<td><code>resolver</code></td>\n<td>别名（Alias）+ 扩展名支持</td>\n</tr>\n<tr>\n<td><strong>打包输出</strong></td>\n<td><code>serializer</code></td>\n<td>RAM Bundle + 差分更新</td>\n</tr>\n<tr>\n<td><strong>调试工具</strong></td>\n<td><code>npx react-native start</code></td>\n<td><code>--reset-cache</code></td>\n</tr>\n</tbody>\n</table>\n<p>Metro 是 React Native 生态的核心工具，合理配置可显著提升开发效率和运行时性能。</p>\n</div>'</script></body></html>