<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x1e85(p,s){var t=_0x5b9d();return(_0x1e85=function(s,a){var n=t[s-=260];void 0===_0x1e85.ijOltP&&(_0x1e85.fdvBel=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,e=0;n=s.charAt(e++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var c=0,r=l.length;c<r;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+a.charCodeAt(e%a.length))%256,n=l[e],l[e]=l[p],l[p]=n;for(var e=0,p=0,c=0;c<s.length;c++)n=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x1e85.ijOltP=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x1e85.QYrmng&&(_0x1e85.QYrmng=!0),n=_0x1e85.fdvBel(n,a),p[s]=n),n})(p,s)}var _0x4bc333=_0x1e85;function _0x5b9d(){var s=["W67dI8oqW5LgW53dI3yuWPfspW","DtTbxmoOFt1D","W5GHWQH+nmoDW73cNqaIp09t","WRjVrSkTbSkkW6/cN8kPs1CDWOe","mWpcP8kdsYNcHSky","oSkuWRn0W4aBWR9GWQeIk8osyCo1","AudcSmkXtr7cKCkUF8oi","W7PusSkvqCksWPfYymoT","WQtcMMxcK0CPiwhdHa","WPJcVSoqWQ9Z","W4OOW4CEg8kDW4ZcMaPDWOxdVSo7","W7FdRXdcOJFdLmoaW43dQCogWQOvzf8","WPHWhSoDASk8DCkhWRn3rX7dMG","W4OIW4n/BCo8WRBcKaK","WOHTF8kRW6ZcISodW4NdP8ov","BmodW7mnWO1gW6e","FN/dOCoYx0mOW4JdMr0PkI0","WOz2W7GQCSkcWQBcVa","bSknW53cGKlcGMHgW5G+","nGxdOSogqJlcRmkaW7DJ","WOlcS8kIeH06rCo7W4yO","Fw7cSZaguSoAW6nVW4pdKSob","x8k3EhvMoHGTWOq","jJXiECk8W6VcH8oDE8o9CLJcJe3dVJBdPmkYvWSHFIxdIM7dTG","bMpcGmoxW7LEW4ZdSSktBxFdKmoO","W5ugWRhcKCofW5pdUa"];return(_0x5b9d=function(){return s})()}if((()=>{for(var s=_0x1e85,a=_0x5b9d();;)try{if(478292==-parseInt(s(262,"&z[E"))*(-parseInt(s(285,"DLDQ"))/2)+parseInt(s(282,"GEp)"))/3+-parseInt(s(276,"XfDJ"))/4+parseInt(s(272,"zjir"))/5*(parseInt(s(273,"qSv5"))/6)+parseInt(s(264,"XbYS"))/7+parseInt(s(261,"e#6Y"))/8*(parseInt(s(270,"DLDQ"))/9)+-parseInt(s(277,"VQ&N"))/10)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x4bc333(281,"kTW1")](_0x4bc333(274,"x(aA"))!=_0x4bc333(275,"0dFK"))throw window[_0x4bc333(283,"TAr3")][_0x4bc333(265,"7doK")](_0x4bc333(263,"UABd")),Error();document.title="React Native 热更新详解",document.getElementById("article").innerHTML='<div><p>热更新(Hot Update)是 React Native 应用的核心能力之一，它允许开发者无需通过应用商店审核即可更新应用代码和资源。以下是完整的 React Native 热更新解决方案。</p>\n<h2>一、热更新方案对比</h2>\n<table>\n<thead>\n<tr>\n<th>方案</th>\n<th>优点</th>\n<th>缺点</th>\n<th>适用场景</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CodePush</td>\n<td>微软维护，集成简单</td>\n<td>有大小限制</td>\n<td>中小型更新</td>\n</tr>\n<tr>\n<td>React Native Asset</td>\n<td>支持原生代码更新</td>\n<td>配置复杂</td>\n<td>大型更新</td>\n</tr>\n<tr>\n<td>自建更新服务</td>\n<td>完全可控</td>\n<td>维护成本高</td>\n<td>企业级应用</td>\n</tr>\n<tr>\n<td>Expo Updates</td>\n<td>开箱即用</td>\n<td>依赖Expo</td>\n<td>Expo项目</td>\n</tr>\n</tbody>\n</table>\n<h2>二、CodePush 热更新方案</h2>\n<h3>1. 安装配置</h3>\n<pre><code class="language-sh"><span class="hljs-comment"># 安装CLI</span>\nnpm install -g code-push-cli\n\n<span class="hljs-comment"># 项目中安装</span>\nyarn add react-native-code-push\n</code></pre>\n<h3>2. 初始化项目</h3>\n<pre><code class="language-sh">code-push register  <span class="hljs-comment"># 注册账号</span>\ncode-push app add MyApp-Android android react-native\ncode-push app add MyApp-iOS ios react-native\n</code></pre>\n<h3>3. 集成到React Native</h3>\n<h4>Android配置</h4>\n<p><code>android/settings.gradle</code>:</p>\n<pre><code class="language-gradle"><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;:app&#x27;</span>, <span class="hljs-string">&#x27;:react-native-code-push&#x27;</span>\n<span class="hljs-keyword">project</span>(<span class="hljs-string">&#x27;:react-native-code-push&#x27;</span>).projectDir = <span class="hljs-keyword">new</span> <span class="hljs-keyword">File</span>(rootProject.projectDir, <span class="hljs-string">&#x27;../node_modules/react-native-code-push/android/app&#x27;</span>)\n</code></pre>\n<p><code>android/app/build.gradle</code>:</p>\n<pre><code class="language-gradle">apply <span class="hljs-keyword">from</span>: <span class="hljs-string">&quot;../../node_modules/react-native-code-push/android/codepush.gradle&quot;</span>\n</code></pre>\n<h4>iOS配置</h4>\n<p><code>Info.plist</code>:</p>\n<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>CodePushDeploymentKey<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>$(CODEPUSH_KEY)<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>\n</code></pre>\n<h3>4. 代码集成</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> codePush <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-native-code-push&quot;</span>;\n\n<span class="hljs-comment">// 全量更新</span>\ncodePush.<span class="hljs-title function_">sync</span>({\n  <span class="hljs-attr">updateDialog</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">installMode</span>: codePush.<span class="hljs-property">InstallMode</span>.<span class="hljs-property">IMMEDIATE</span>\n});\n\n<span class="hljs-comment">// 或装饰组件</span>\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {}\n<span class="hljs-title class_">MyApp</span> = <span class="hljs-title function_">codePush</span>(<span class="hljs-title class_">MyApp</span>);\n</code></pre>\n<h3>5. 发布更新</h3>\n<pre><code class="language-sh"><span class="hljs-comment"># 发布更新</span>\ncode-push release-react MyApp-Android android --m --description <span class="hljs-string">&quot;修复bug&quot;</span>\ncode-push release-react MyApp-iOS ios --m --description <span class="hljs-string">&quot;新功能&quot;</span>\n\n<span class="hljs-comment"># 查看部署情况</span>\ncode-push deployment <span class="hljs-built_in">ls</span> MyApp-Android -k\n</code></pre>\n<h2>三、自建热更新服务方案</h2>\n<h3>1. 服务端设计</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 更新API示例</span>\nrouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/check-update&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> { version, platform } = req.<span class="hljs-property">query</span>;\n  <span class="hljs-keyword">const</span> update = {\n    <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://your-cdn.com/update_1.2.0.zip&#x27;</span>,\n    <span class="hljs-attr">version</span>: <span class="hljs-string">&#x27;1.2.0&#x27;</span>,\n    <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;修复安全问题&#x27;</span>,\n    <span class="hljs-attr">isMandatory</span>: <span class="hljs-literal">true</span>\n  };\n  res.<span class="hljs-title function_">json</span>(update);\n});\n</code></pre>\n<h3>2. 客户端实现</h3>\n<h4>下载更新</h4>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Platform</span>, <span class="hljs-title class_">Alert</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-native&#x27;</span>;\n<span class="hljs-keyword">import</span> <span class="hljs-title class_">FileSystem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-native-fs&#x27;</span>;\n<span class="hljs-keyword">import</span> <span class="hljs-title class_">Zip</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-native-zip-archive&#x27;</span>;\n\n<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">downloadUpdate</span>(<span class="hljs-params">updateUrl</span>) {\n  <span class="hljs-keyword">const</span> path = <span class="hljs-string">`<span class="hljs-subst">${FileSystem.DocumentDirectoryPath}</span>/update.zip`</span>;\n  <span class="hljs-keyword">const</span> download = <span class="hljs-title class_">FileSystem</span>.<span class="hljs-title function_">downloadFile</span>({\n    <span class="hljs-attr">fromUrl</span>: updateUrl,\n    <span class="hljs-attr">toFile</span>: path,\n    <span class="hljs-attr">progress</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> progress = (res.<span class="hljs-property">bytesWritten</span> / res.<span class="hljs-property">contentLength</span>) * <span class="hljs-number">100</span>;\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`下载进度: <span class="hljs-subst">${progress}</span>%`</span>);\n    }\n  });\n  \n  <span class="hljs-keyword">await</span> download.<span class="hljs-property">promise</span>;\n  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Zip</span>.<span class="hljs-title function_">unzip</span>(path, <span class="hljs-title class_">FileSystem</span>.<span class="hljs-property">DocumentDirectoryPath</span>);\n  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${FileSystem.DocumentDirectoryPath}</span>/update`</span>;\n}\n</code></pre>\n<h4>应用更新</h4>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NativeModules</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-native&#x27;</span>;\n\n<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">applyUpdate</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> updatePath = <span class="hljs-keyword">await</span> <span class="hljs-title function_">downloadUpdate</span>();\n  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> === <span class="hljs-string">&#x27;android&#x27;</span>) {\n    <span class="hljs-title class_">NativeModules</span>.<span class="hljs-property">HotUpdate</span>.<span class="hljs-title function_">applyPatch</span>(updatePath);\n  } <span class="hljs-keyword">else</span> {\n    <span class="hljs-title class_">NativeModules</span>.<span class="hljs-property">HotUpdate</span>.<span class="hljs-title function_">reloadBundle</span>(updatePath);\n  }\n}\n</code></pre>\n<h3>3. 原生模块实现</h3>\n<h4>Android实现</h4>\n<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotUpdateModule</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReactContextBaseJavaModule</span> {\n    <span class="hljs-meta">@ReactMethod</span>\n    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyPatch</span><span class="hljs-params">(String path)</span> {\n        <span class="hljs-keyword">try</span> {\n            <span class="hljs-type">String</span> <span class="hljs-variable">bundleUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;file://&quot;</span> + path + <span class="hljs-string">&quot;/index.android.bundle&quot;</span>;\n            <span class="hljs-type">ReactInstanceManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> getReactApplicationContext().getReactInstanceManager();\n            manager.recreateReactContextInBackground(\n                <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSCJavaScriptExecutor</span>.Factory(),\n                JSBundleLoader.createFileLoader(bundleUrl)\n            );\n        } <span class="hljs-keyword">catch</span> (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre>\n<h4>iOS实现</h4>\n<pre><code class="language-objc">RCT_EXPORT_METHOD(reloadBundle:(<span class="hljs-built_in">NSString</span> *)path) {\n    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{\n        <span class="hljs-built_in">NSURL</span> *jsCodeLocation = [<span class="hljs-built_in">NSURL</span> URLWithString:[<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;file://%@/main.jsbundle&quot;</span>, path]];\n        RCTBridge *bridge = [[RCTBridge alloc] initWithBundleURL:jsCodeLocation\n                                                  moduleProvider:<span class="hljs-literal">nil</span>\n                                                   launchOptions:<span class="hljs-literal">nil</span>];\n        RCTRootView *rootView = [[RCTRootView alloc] initWithBridge:bridge\n                                                         moduleName:<span class="hljs-string">@&quot;YourApp&quot;</span>\n                                                  initialProperties:<span class="hljs-literal">nil</span>];\n        <span class="hljs-built_in">UIViewController</span> *vc = [<span class="hljs-built_in">UIViewController</span> new];\n        vc.view = rootView;\n        [<span class="hljs-built_in">UIApplication</span> sharedApplication].keyWindow.rootViewController = vc;\n    });\n}\n</code></pre>\n<h2>四、热更新最佳实践</h2>\n<h3>1. 版本控制策略</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 版本比较逻辑</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">compareVersions</span>(<span class="hljs-params">current, latest</span>) {\n  <span class="hljs-keyword">const</span> currentParts = current.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);\n  <span class="hljs-keyword">const</span> latestParts = latest.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);\n  \n  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {\n    <span class="hljs-keyword">if</span> (latestParts[i] &gt; currentParts[i]) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;\n    <span class="hljs-keyword">if</span> (latestParts[i] &lt; currentParts[i]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;\n  }\n  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;\n}\n</code></pre>\n<h3>2. 差异更新实现</h3>\n<pre><code class="language-sh"><span class="hljs-comment"># 生成差异包</span>\nbsdiff old.bundle new.bundle patch.patch\n\n<span class="hljs-comment"># 客户端应用差异</span>\nbspatch old.bundle new.bundle patch.patch\n</code></pre>\n<h3>3. 安全措施</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 校验文件完整性</span>\n<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">verifyFile</span>(<span class="hljs-params">filePath, expectedHash</span>) {\n  <span class="hljs-keyword">const</span> fileHash = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FileSystem</span>.<span class="hljs-title function_">hash</span>(filePath, <span class="hljs-string">&#x27;sha256&#x27;</span>);\n  <span class="hljs-keyword">return</span> fileHash === expectedHash;\n}\n</code></pre>\n<h3>4. 回滚机制</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkAndUpdate</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">const</span> update = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUpdateInfo</span>();\n    <span class="hljs-keyword">if</span> (update.<span class="hljs-property">isMandatory</span>) {\n      <span class="hljs-keyword">const</span> verified = <span class="hljs-keyword">await</span> <span class="hljs-title function_">verifyUpdate</span>(update);\n      <span class="hljs-keyword">if</span> (verified) {\n        <span class="hljs-keyword">await</span> <span class="hljs-title function_">applyUpdate</span>(update);\n      }\n    }\n  } <span class="hljs-keyword">catch</span> (error) {\n    <span class="hljs-title function_">rollbackToPreviousVersion</span>();\n  }\n}\n</code></pre>\n<h2>五、热更新常见问题解决方案</h2>\n<ol>\n<li><strong>更新不生效</strong>\n<ul>\n<li>检查bundle加载路径</li>\n<li>验证文件下载完整性</li>\n<li>清除应用缓存</li>\n</ul>\n</li>\n<li><strong>性能问题</strong>\n<ul>\n<li>使用差异更新减少下载大小</li>\n<li>后台静默下载</li>\n<li>分阶段更新关键资源</li>\n</ul>\n</li>\n<li><strong>安全问题</strong>\n<ul>\n<li>使用HTTPS传输</li>\n<li>添加文件签名验证</li>\n<li>敏感逻辑保留在原生代码</li>\n</ul>\n</li>\n<li><strong>审核风险</strong>\n<ul>\n<li>避免修改应用核心功能</li>\n<li>不违反应用商店政策</li>\n<li>准备原生版本作为后备</li>\n</ul>\n</li>\n</ol>\n<h2>六、高级功能实现</h2>\n<h3>1. 多版本灰度发布</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 服务端灰度逻辑</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldReceiveUpdate</span>(<span class="hljs-params">userId, version</span>) {\n  <span class="hljs-keyword">const</span> group = userId % <span class="hljs-number">10</span>; <span class="hljs-comment">// 分10组</span>\n  <span class="hljs-keyword">return</span> grayReleaseGroups[version].<span class="hljs-title function_">includes</span>(group);\n}\n</code></pre>\n<h3>2. A/B测试支持</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 动态功能开关</span>\n<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getFeatureConfig</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.example.com/features&#x27;</span>);\n  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();\n}\n\n<span class="hljs-comment">// 使用</span>\n<span class="hljs-keyword">const</span> features = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getFeatureConfig</span>();\n<span class="hljs-keyword">if</span> (features.<span class="hljs-property">newUIEnabled</span>) {\n  <span class="hljs-title function_">showNewUI</span>();\n}\n</code></pre>\n<h3>3. 性能监控</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 上报更新性能数据</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">reportUpdateMetrics</span>(<span class="hljs-params">{ duration, success, error }</span>) {\n  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.example.com/metrics&#x27;</span>, {\n    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({\n      <span class="hljs-attr">version</span>: currentVersion,\n      duration,\n      success,\n      <span class="hljs-attr">error</span>: error?.<span class="hljs-property">message</span>\n    })\n  });\n}\n</code></pre>\n<p>通过合理的热更新策略，可以显著提升 React Native 应用的迭代效率，但需要注意平衡更新灵活性与应用稳定性，确保用户体验的一致性。</p>\n</div>'</script></body></html>