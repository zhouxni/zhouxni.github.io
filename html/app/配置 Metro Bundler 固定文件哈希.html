<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x149eff=_0x129a;function _0x129a(e,s){var l=_0x4b90();return(_0x129a=function(s,n){var a=l[s-=337];void 0===_0x129a.SqDdJR&&(_0x129a.cwXIst=function(s,n){var a,t=[],e=0,l="";for(s=(s=>{for(var n,a,t="",e="",l=0,p=0;a=s.charAt(p++);~a&&(n=l%4?64*n+a:a,l++%4)&&(t+=String.fromCharCode(255&n>>(-2*l&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var r=0,c=t.length;r<c;r++)e+="%"+("00"+t.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(e)})(s),p=0;p<256;p++)t[p]=p;for(p=0;p<256;p++)e=(e+t[p]+n.charCodeAt(p%n.length))%256,a=t[p],t[p]=t[e],t[e]=a;for(var p=0,e=0,r=0;r<s.length;r++)a=t[p=(p+1)%256],t[p]=t[e=(e+t[p])%256],t[e]=a,l+=String.fromCharCode(s.charCodeAt(r)^t[(t[p]+t[e])%256]);return l},e=arguments,_0x129a.SqDdJR=!0);var s=s+l[0],t=e[s];return t?a=t:(void 0===_0x129a.pOhjrL&&(_0x129a.pOhjrL=!0),a=_0x129a.cwXIst(a,n),e[s]=a),a})(e,s)}if((()=>{for(var s=_0x129a,n=_0x4b90();;)try{if(168963==+parseInt(s(361,"lfqq"))+-parseInt(s(351,"xjjW"))/2+parseInt(s(353,"%fwJ"))/3*(-parseInt(s(358,"%Mva"))/4)+parseInt(s(341,"wFeX"))/5+-parseInt(s(346,"Dh1D"))/6*(-parseInt(s(363,"#$vZ"))/7)+-parseInt(s(354,"xjjW"))/8*(parseInt(s(362,"cJ5l"))/9)+parseInt(s(340,"Nr4w"))/10*(parseInt(s(347,"&Sy9"))/11))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x149eff(360,"CYcG")](_0x149eff(356,"EFVK"))!=_0x149eff(364,"Nr4w"))throw window[_0x149eff(350,"GmkC")][_0x149eff(338,"%fwJ")](_0x149eff(355,"qmV8")),Error();function _0x4b90(){var s=["sHSHqNjenf/dGa","ltXLW40mWOC8tCkD","W4OoWOnIW7hcHsj9","uHa3WOZdHCkDWQNdHXG","B35xWPFdVCk3W4T9W7ddRgDV","W68Lqmo4l8oxW5hcSq","WR3cICkXetjxuZD/bH7dPa","vSkiW74NWRlcIdJcN8kDWOtdSSor","W6iCBt/cVSkZFSkEW5u","WR3cImk6Dw8oxdrb","yNeMWRFdIWhcOmofg8kmhZrsWOjlW7VdM8kko8orW6r/W4lcT2pcPq","WPRdJSojW7WPW7iBW4Gm","W67cNmkCWQ5JWRq1W7WSWO4Oiq","W7ddN3xcSCk4qCk5WOhcGai","W4P2W5hcJ1ipWQ0I","WOZcKmoEW5BdTxNcPG","p2eEW6KnW4RdQSoVrSocWRPW","W7f2WRlcSSkWWOfYWPRdLCkFFa","t8ooW75IW6/dMgpdR2tdR8oO","WQWeWQtcIsW","W5pcSSokDSonWPtdI2GbW74e","WQroldZcMSkPsa","kZTGW7qTWRGcDSk1","W61gW6tdJwv+kCkIWOBdRIm","W4eizmkHE8kltCoaWRaonmoH","W6PjW6hdJMDugSkMWR3dJsy","WP5Thu8WW47dNWldGWBcTW","cmoVdZHfW7ixamk6qG"];return(_0x4b90=function(){return s})()}document.title="配置 Metro Bundler 固定文件哈希",document.getElementById("article").innerHTML='<div><p>在 React Native 项目中，配置 Metro Bundler 固定文件哈希是确保 CodePush 差量更新（Delta Update）可靠性的关键步骤。以下是详细配置指南和注意事项：</p>\n<hr>\n<p>一、核心配置方案</p>\n<ol>\n<li>修改 <code>metro.config.js</code>（推荐）</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-comment">// metro.config.js</span>\n<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">transformer</span>: {\n    <span class="hljs-comment">// 禁用名称混淆，保持稳定标识符</span>\n    <span class="hljs-attr">minifierConfig</span>: {\n      <span class="hljs-attr">keep_classnames</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 保持类名不变</span>\n      <span class="hljs-attr">keep_fnames</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 保持函数名不变</span>\n      <span class="hljs-attr">mangle</span>: {\n        <span class="hljs-attr">keep_classnames</span>: <span class="hljs-literal">true</span>,\n        <span class="hljs-attr">keep_fnames</span>: <span class="hljs-literal">true</span>,\n      },\n    },\n    <span class="hljs-comment">// 固定模块ID生成逻辑</span>\n    <span class="hljs-attr">getTransformOptions</span>: <span class="hljs-title function_">async</span> () =&gt; ({\n      <span class="hljs-attr">transform</span>: {\n        <span class="hljs-attr">experimentalImportSupport</span>: <span class="hljs-literal">false</span>,\n        <span class="hljs-attr">inlineRequires</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 建议开启（需RN 0.64+）</span>\n      },\n    }),\n  },\n  <span class="hljs-attr">serializer</span>: {\n    <span class="hljs-comment">// 生成确定性模块ID（基于文件路径）</span>\n    <span class="hljs-attr">createModuleIdFactory</span>: <span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-keyword">const</span> projectRoot = __dirname;\n      <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">filePath</span>) =&gt;</span> {\n        <span class="hljs-keyword">const</span> relativePath = path.<span class="hljs-title function_">relative</span>(projectRoot, filePath);\n        <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;metro/src/lib/createModuleIdFactory&#x27;</span>)()(relativePath);\n      };\n    },\n  },\n};\n</code></pre>\n<ol start="2">\n<li>关键配置说明\n<table>\n<thead>\n<tr>\n<th>配置项</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>minifierConfig</code></td>\n<td>禁止压缩器修改类/函数名，避免随机命名</td>\n</tr>\n<tr>\n<td><code>createModuleIdFactory</code></td>\n<td>基于文件相对路径生成固定ID（而非随机哈希）</td>\n</tr>\n<tr>\n<td><code>inlineRequires</code></td>\n<td>启用静态分析优化（不影响哈希稳定性）</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ol>\n<hr>\n<p>二、验证配置有效性</p>\n<ol>\n<li>生成 Bundle 并检查</li>\n</ol>\n<pre><code class="language-sh">react-native bundle \\\n  --platform android \\\n  --entry-file index.js \\\n  --bundle-output out.bundle \\\n  --dev <span class="hljs-literal">false</span> \\\n  --reset-cache\n</code></pre>\n<p>检查输出文件：</p>\n<ul>\n<li>\n<p>模块ID：应保持相同文件路径生成相同ID</p>\n</li>\n<li>\n<p>变量名：类名/函数名不应被压缩为 <code>a</code>,<code>b</code> 等短名称</p>\n</li>\n</ul>\n<ol start="2">\n<li>差分更新测试流程</li>\n<li>发布初始版本：<pre><code class="language-sh">appcenter codepush release-react -a org/app -d Production\n</code></pre>\n</li>\n<li>修改少量代码后发布更新：<pre><code class="language-sh">appcenter codepush release-react -a org/app -d Production -m <span class="hljs-string">&quot;Minor update&quot;</span>\n</code></pre>\n</li>\n<li>在 App Center 控制台检查：</li>\n</ol>\n<ul>\n<li>更新包大小应显著小于完整包（如 200KB vs 2MB）</li>\n</ul>\n<hr>\n<p>三、常见问题解决</p>\n<ol>\n<li>资源文件哈希不稳定\n现象：图片/字体等资源文件每次构建哈希不同<br>\n解决方案：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-comment">// metro.config.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// ...</span>\n  <span class="hljs-attr">transformer</span>: {\n    <span class="hljs-attr">assetPlugins</span>: [<span class="hljs-string">&#x27;react-native-asset/tools/hashAssetFiles&#x27;</span>], <span class="hljs-comment">// 禁用自动哈希</span>\n  }\n};\n</code></pre>\n<ol start="2">\n<li>Hermes 引擎兼容问题\n现象：启用 Hermes 后差分更新失败<br>\n应对措施：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在 bundle 命令中明确指定引擎</span>\nreact-native bundle \\\n  --platform android \\\n  --dev <span class="hljs-literal">false</span> \\\n  --entry-file index.<span class="hljs-property">js</span> \\\n  --bundle-output out.<span class="hljs-property">bundle</span> \\\n  --minify <span class="hljs-literal">false</span> \\          # 与metro.<span class="hljs-property">config</span>.<span class="hljs-property">js</span>的minifierConfig配合\n  --reset-cache\n</code></pre>\n<ol start="3">\n<li>第三方库干扰\n排查方法：</li>\n</ol>\n<pre><code class="language-sh"><span class="hljs-comment"># 1. 生成依赖树</span>\nnpx react-native bundle --verbose &gt; bundle.log\n\n<span class="hljs-comment"># 2. 检查是否有库动态生成代码</span>\ngrep -r <span class="hljs-string">&quot;dynamic import&quot;</span> node_modules/\n</code></pre>\n<hr>\n<p>四、进阶优化建议</p>\n<ol>\n<li>锁定 Metro 版本<br>\n在 <code>package.json</code> 中固定版本避免意外升级：<pre><code class="language-json"><span class="hljs-attr">&quot;resolutions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;metro&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.72.3&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;metro-config&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.72.3&quot;</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n</li>\n<li>CI/CD 环境一致性<br>\n使用 Docker 镜像确保构建环境一致：<pre><code class="language-dockerfile"><span class="hljs-keyword">FROM</span> reactnativecommunity/react-native-android:<span class="hljs-number">8.1</span>\n<span class="hljs-keyword">RUN</span><span class="language-bash"> npm install -g appcenter-cli</span>\n</code></pre>\n</li>\n<li>差分更新监控<br>\n在客户端添加埋点：<pre><code class="language-javascript">codePush.<span class="hljs-title function_">getUpdateMetadata</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">update</span> =&gt;</span> {\n  <span class="hljs-title class_">Analytics</span>.<span class="hljs-title function_">logEvent</span>(<span class="hljs-string">&#x27;CODEPUSH_UPDATE&#x27;</span>, {\n    <span class="hljs-attr">size</span>: update.<span class="hljs-property">packageSize</span>,\n    <span class="hljs-attr">isPending</span>: update.<span class="hljs-property">isPending</span>\n  });\n});\n</code></pre>\n</li>\n</ol>\n<hr>\n<p>五、配置效果对比</p>\n<table>\n<thead>\n<tr>\n<th>场景</th>\n<th>未固定哈希</th>\n<th>固定哈希后</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>模块ID生成</td>\n<td>随机哈希（如 <code>_abc12</code>）</td>\n<td>基于路径的固定ID（如 <code>src/utils</code>）</td>\n</tr>\n<tr>\n<td>两次构建差异</td>\n<td>相同代码可能生成不同Bundle</td>\n<td>相同代码必生成相同Bundle</td>\n</tr>\n<tr>\n<td>CodePush 更新包大小</td>\n<td>常接近完整包大小</td>\n<td>通常减少50%-90%</td>\n</tr>\n<tr>\n<td>调试难度</td>\n<td>错误难以复现</td>\n<td>问题可稳定复现</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<p>通过以上配置，可确保 React Native 项目在 CodePush 热更新时始终生成确定性文件哈希，最大化利用差分更新优势。建议在重要版本发布前，通过 <code>--dry-run</code> 参数模拟完整更新流程进行验证。</p>\n</div>'</script></body></html>