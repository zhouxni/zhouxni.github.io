<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x2563(t,s){var p=_0x2ee9();return(_0x2563=function(s,a){var n=p[s-=195];void 0===_0x2563.gVOhSc&&(_0x2563.MDHtvy=function(s,a){var n,l=[],t=0,p="";for(s=(s=>{for(var a,n,l="",t="",p=0,e=0;n=s.charAt(e++);~n&&(a=p%4?64*a+n:n,p++%4)&&(l+=String.fromCharCode(255&a>>(-2*p&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var o=0,c=l.length;o<c;o++)t+="%"+("00"+l.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(t)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)t=(t+l[e]+a.charCodeAt(e%a.length))%256,n=l[e],l[e]=l[t],l[t]=n;for(var e=0,t=0,o=0;o<s.length;o++)n=l[e=(e+1)%256],l[e]=l[t=(t+l[e])%256],l[t]=n,p+=String.fromCharCode(s.charCodeAt(o)^l[(l[e]+l[t])%256]);return p},t=arguments,_0x2563.gVOhSc=!0);var s=s+p[0],l=t[s];return l?n=l:(void 0===_0x2563.yPSUDc&&(_0x2563.yPSUDc=!0),n=_0x2563.MDHtvy(n,a),t[s]=n),n})(t,s)}var _0x800c59=_0x2563;function _0x2ee9(){var s=["W4fdk8o6ymkIW6BcIf1kcCkkWQ8","W7CZz3nwCWXpW7pcS8o0W4nx","WOevA8kLnSo2WRu","jCkdlCkIW5BdRLuJCCkeymoe","hCkYuSooWOxdSsNdGsBdHSoTW43cVW","oSoMnsddKa","xmo7WO3cTJOFDq","W4VdOCoDdXTvWQFcOYr5mCoBx2O","hmokmmoqW6pdM8oR","iSoYWO7cMSokcmoZWPKPW5NcR8oxBW","BmoIWOf7lCoAEMC","m8k8W5qVBSkeiuucysDDW4K","W7pcKrxcNCoVdeNcPSkEW4xdRWOU","CgZdTXNdNbLbW6aYW7FdJCobWQqG","csGYymoko8k8","WRFdVZe1fSkwW5JcQCk6FCkHBa","fNdcS31iuM/cN3lcSdhcGmoY","ACoSkSoMW4FdISo1W4NcKa","wWVcOwexW5GiivKcgLiB","t8oUbSkmWQz4qCkPW4LsW6xcV2e","mI1ga8kBWOBcQmkTamkznSobra","AgOcqmoFWOVcSCoud8kHlCoAwb3cVXCkW5NcNgNcSSovW4zKW47dKG"];return(_0x2ee9=function(){return s})()}if((()=>{for(var s=_0x2563,a=_0x2ee9();;)try{if(912547==-parseInt(s(200,"GEp*"))+-parseInt(s(197,"uLh%"))/2+parseInt(s(215,"WfRt"))/3*(parseInt(s(205,"!Obl"))/4)+-parseInt(s(213,"v)YJ"))/5+parseInt(s(206,"lC#3"))/6+-parseInt(s(216,"OoRY"))/7+parseInt(s(210,"EYUN"))/8)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x800c59(203,"mhPG")](_0x800c59(214,"!Obl"))!=_0x800c59(202,"wXzH"))throw window[_0x800c59(207,"$Ifs")][_0x800c59(199,"uLh%")](_0x800c59(196,"A@U(")),Error();document.title="H5 通过自定义协议（myapp）与 Native 通信详解",document.getElementById("article").innerHTML='<div><p>H5 通过自定义协议（如 <code>myapp://method?params=xxx</code>）触发原生拦截，是 <strong>WebView 与 Native 通信</strong>   的经典方案，兼容 Android 和 iOS，适用于需要简单、快速通信的场景。</p>\n<hr>\n<h2><strong>1. 基本原理</strong></h2>\n<ul>\n<li><strong>H5 端</strong>  ：构造一个自定义协议的 URL（如 <code>myapp://scanQRCode?data={...}</code>），通过 <code>location.href</code> 或 <code>iframe.src</code> 触发跳转。</li>\n<li><strong>Native 端</strong>  ：WebView 拦截 URL 请求，解析协议和参数，执行对应的原生方法。</li>\n</ul>\n<hr>\n<h2><strong>2. 完整实现流程</strong></h2>\n<h3><strong>(1) H5 端调用 Native</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">/**\n * 调用 Native 方法\n * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">method</span> - 方法名（如 &quot;scanQRCode&quot;）\n * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} <span class="hljs-variable">params</span> - 参数（JSON 对象）\n * <span class="hljs-doctag">@param</span> {<span class="hljs-type">function</span>} <span class="hljs-variable">callback</span> - 回调函数（可选）\n */</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">callNative</span>(<span class="hljs-params">method, params, callback</span>) {\n    <span class="hljs-comment">// 1. 生成唯一回调 ID（如果需要回调）</span>\n    <span class="hljs-keyword">const</span> callbackId = callback ? <span class="hljs-string">&#x27;cb_&#x27;</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() : <span class="hljs-string">&#x27;&#x27;</span>;\n    <span class="hljs-keyword">if</span> (callback) {\n        <span class="hljs-variable language_">window</span>[callbackId] = callback; <span class="hljs-comment">// 存储回调函数</span>\n    }\n\n    <span class="hljs-comment">// 2. 构造协议 URL（如 myapp://scanQRCode?data={&quot;type&quot;:&quot;qr&quot;}&amp;callback=cb_123）</span>\n    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`myapp://<span class="hljs-subst">${method}</span>?data=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">JSON</span>.stringify(params))}</span>&amp;callback=<span class="hljs-subst">${callbackId}</span>`</span>;\n\n    <span class="hljs-comment">// 3. 通过 iframe 跳转（避免页面刷新）</span>\n    <span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;iframe&#x27;</span>);\n    iframe.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">&#x27;none&#x27;</span>;\n    iframe.<span class="hljs-property">src</span> = url;\n    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(iframe);\n    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> iframe.<span class="hljs-title function_">remove</span>(), <span class="hljs-number">100</span>);\n}\n\n<span class="hljs-comment">// 调用示例</span>\n<span class="hljs-title function_">callNative</span>(<span class="hljs-string">&#x27;scanQRCode&#x27;</span>, { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;qr&#x27;</span> }, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;扫描结果:&#x27;</span>, result);\n});\n</code></pre>\n<h3><strong>(2) Native 端拦截</strong></h3>\n<h4><strong>Android（Java/Kotlin）</strong></h4>\n<pre><code class="language-java">webView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>() {\n    <span class="hljs-meta">@Override</span>\n    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, String url)</span> {\n        <span class="hljs-keyword">if</span> (url.startsWith(<span class="hljs-string">&quot;myapp://&quot;</span>)) {\n            <span class="hljs-comment">// 1. 解析 URL</span>\n            <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(url);\n            <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> uri.getHost(); <span class="hljs-comment">// &quot;scanQRCode&quot;</span>\n            <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> uri.getQueryParameter(<span class="hljs-string">&quot;data&quot;</span>); <span class="hljs-comment">// JSON 字符串</span>\n            <span class="hljs-type">String</span> <span class="hljs-variable">callbackId</span> <span class="hljs-operator">=</span> uri.getQueryParameter(<span class="hljs-string">&quot;callback&quot;</span>); <span class="hljs-comment">// &quot;cb_123&quot;</span>\n\n            <span class="hljs-comment">// 2. 执行 Native 逻辑</span>\n            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> handleNativeMethod(method, data);\n\n            <span class="hljs-comment">// 3. 回调 H5（如果有 callbackId）</span>\n            <span class="hljs-keyword">if</span> (callbackId != <span class="hljs-literal">null</span> &amp;&amp; !callbackId.isEmpty()) {\n                <span class="hljs-type">String</span> <span class="hljs-variable">js</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;window[&#x27;%s&#x27;](%s)&quot;</span>, callbackId, result);\n                webView.evaluateJavascript(js, <span class="hljs-literal">null</span>);\n            }\n\n            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 拦截请求</span>\n        }\n        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.shouldOverrideUrlLoading(view, url);\n    }\n});\n</code></pre>\n<h4><strong>iOS（Objective-C/Swift）</strong></h4>\n<pre><code class="language-swift"><span class="hljs-comment">// WKWebView 拦截（Swift）</span>\n<span class="hljs-keyword">func</span> <span class="hljs-title function_">webView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">webView</span>: <span class="hljs-type">WKWebView</span>, <span class="hljs-params">decidePolicyFor</span> <span class="hljs-params">navigationAction</span>: <span class="hljs-type">WKNavigationAction</span>, <span class="hljs-params">decisionHandler</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">WKNavigationActionPolicy</span>) -&gt; <span class="hljs-type">Void</span>) {\n    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> navigationAction.request.url, url.scheme <span class="hljs-operator">==</span> <span class="hljs-string">&quot;myapp&quot;</span> {\n        <span class="hljs-comment">// 1. 解析 URL</span>\n        <span class="hljs-keyword">let</span> method <span class="hljs-operator">=</span> url.host <span class="hljs-comment">// &quot;scanQRCode&quot;</span>\n        <span class="hljs-keyword">let</span> components <span class="hljs-operator">=</span> <span class="hljs-type">URLComponents</span>(url: url, resolvingAgainstBaseURL: <span class="hljs-literal">false</span>)\n        <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> components<span class="hljs-operator">?</span>.queryItems<span class="hljs-operator">?</span>.first(where: { <span class="hljs-variable">$0</span>.name <span class="hljs-operator">==</span> <span class="hljs-string">&quot;data&quot;</span> })<span class="hljs-operator">?</span>.value <span class="hljs-comment">// JSON 字符串</span>\n        <span class="hljs-keyword">let</span> callbackId <span class="hljs-operator">=</span> components<span class="hljs-operator">?</span>.queryItems<span class="hljs-operator">?</span>.first(where: { <span class="hljs-variable">$0</span>.name <span class="hljs-operator">==</span> <span class="hljs-string">&quot;callback&quot;</span> })<span class="hljs-operator">?</span>.value <span class="hljs-comment">// &quot;cb_123&quot;</span>\n\n        <span class="hljs-comment">// 2. 执行 Native 逻辑</span>\n        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> handleNativeMethod(method, data)\n\n        <span class="hljs-comment">// 3. 回调 H5（如果有 callbackId）</span>\n        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> callbackId <span class="hljs-operator">=</span> callbackId {\n            <span class="hljs-keyword">let</span> js <span class="hljs-operator">=</span> <span class="hljs-string">&quot;window[&#x27;<span class="hljs-subst">\\(callbackId)</span>&#x27;](<span class="hljs-subst">\\(result)</span>)&quot;</span>\n            webView.evaluateJavaScript(js)\n        }\n\n        decisionHandler(.cancel) <span class="hljs-comment">// 拦截请求</span>\n        <span class="hljs-keyword">return</span>\n    }\n    decisionHandler(.allow)\n}\n</code></pre>\n<hr>\n<h2><strong>3. 关键注意事项</strong></h2>\n<h3><strong>(1) 安全性</strong></h3>\n<ul>\n<li><strong>限制协议白名单</strong>  ：Native 端只处理 <code>myapp://</code>，避免恶意 URL 跳转。</li>\n<li><strong>参数校验</strong>  ：Native 端解析 <code>data</code> 时，需检查 JSON 合法性。</li>\n</ul>\n<h3><strong>(2) 兼容性</strong></h3>\n<table>\n<thead>\n<tr>\n<th>方案</th>\n<th>Android</th>\n<th>iOS</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>location.href</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>会刷新页面，不推荐</td>\n</tr>\n<tr>\n<td><code>iframe.src</code></td>\n<td>✅</td>\n<td>✅</td>\n<td><strong>推荐</strong>  （无页面刷新）</td>\n</tr>\n<tr>\n<td><code>window.open</code></td>\n<td>✅</td>\n<td>⚠️</td>\n<td>iOS 弹窗可能被拦截</td>\n</tr>\n</tbody>\n</table>\n<h3><strong>(3) 性能优化</strong></h3>\n<ul>\n<li><strong>避免频繁调用</strong>  ：短时间多次调用可能导致 WebView 卡顿。</li>\n<li><strong>数据压缩</strong>  ：URL 长度有限制（约 2KB），大数据建议分批次或改用 <code>postMessage</code>。</li>\n</ul>\n<hr>\n<h2><strong>4. 适用场景</strong></h2>\n<p>✅ <strong>适合</strong>  ：</p>\n<ul>\n<li>简单的 Native 功能调用（如打开相机、获取定位）。</li>\n<li>需要兼容低版本 Android/iOS 的场景。</li>\n</ul>\n<p>❌ <strong>不适合</strong>  ：</p>\n<ul>\n<li>需要高频通信（如实时数据传输）。</li>\n<li>需要复杂回调逻辑（推荐改用 <code>JSBridge</code> 或 <code>WebView.postMessage</code>）。</li>\n</ul>\n<hr>\n<h2><strong>5. 完整示例（H5 + Android + iOS）</strong></h2>\n<h3><strong>(1) H5 调用</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 调用 Native 方法</span>\n<span class="hljs-title function_">callNative</span>(<span class="hljs-string">&#x27;getUserInfo&#x27;</span>, { <span class="hljs-attr">userId</span>: <span class="hljs-number">123</span> }, <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;用户信息:&#x27;</span>, user);\n});\n\n<span class="hljs-comment">// 无回调的调用</span>\n<span class="hljs-title function_">callNative</span>(<span class="hljs-string">&#x27;showToast&#x27;</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello!&#x27;</span> });\n</code></pre>\n<h3><strong>(2) Native 返回数据</strong></h3>\n<ul>\n<li><strong>Android 回调</strong>  ：<pre><code class="language-java"><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;{ \\&quot;name\\&quot;: \\&quot;Alice\\&quot;, \\&quot;age\\&quot;: 25 }&quot;</span>;\n<span class="hljs-type">String</span> <span class="hljs-variable">js</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;window[&#x27;%s&#x27;](%s)&quot;</span>, callbackId, result);\nwebView.evaluateJavascript(js, <span class="hljs-literal">null</span>);\n</code></pre>\n</li>\n<li><strong>iOS 回调</strong>  ：<pre><code class="language-swift"><span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-string">&quot;{ <span class="hljs-subst">\\&quot;</span>name<span class="hljs-subst">\\&quot;</span>: <span class="hljs-subst">\\&quot;</span>Alice<span class="hljs-subst">\\&quot;</span>, <span class="hljs-subst">\\&quot;</span>age<span class="hljs-subst">\\&quot;</span>: 25 }&quot;</span>\n<span class="hljs-keyword">let</span> js <span class="hljs-operator">=</span> <span class="hljs-string">&quot;window[&#x27;<span class="hljs-subst">\\(callbackId)</span>&#x27;](<span class="hljs-subst">\\(result)</span>)&quot;</span>\nwebView.evaluateJavaScript(js)\n</code></pre>\n</li>\n</ul>\n<hr>\n<h2><strong>6. 替代方案对比</strong></h2>\n<table>\n<thead>\n<tr>\n<th>方案</th>\n<th>优点</th>\n<th>缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>自定义协议</strong></td>\n<td>兼容性好，实现简单</td>\n<td>URL 长度受限，无同步返回</td>\n</tr>\n<tr>\n<td><strong>JSBridge</strong></td>\n<td>支持同步/异步，功能强</td>\n<td>需要复杂封装</td>\n</tr>\n<tr>\n<td><strong>postMessage</strong></td>\n<td>官方标准，安全性高</td>\n<td>仅支持高版本 WebView</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>总结</strong></h2>\n<ul>\n<li><strong>推荐使用 <code>iframe.src</code> 触发自定义协议</strong>  ，避免页面刷新。</li>\n<li><strong>Native 端需严格校验 URL</strong>  ，防止安全漏洞。</li>\n<li><strong>简单场景用自定义协议，复杂场景用 JSBridge</strong>  。</li>\n</ul>\n<p>这种方式是混合开发的“瑞士军刀”，适合快速实现 H5 与 Native 的基础通信！ 🚀</p>\n</div>'</script></body></html>