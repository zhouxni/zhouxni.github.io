<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x32c6(p,s){var e=_0x2ca2();return(_0x32c6=function(s,a){var n=e[s-=296];void 0===_0x32c6.xEhoBj&&(_0x32c6.KHrKYX=function(s,a){var n,l=[],p=0,e="";for(s=(s=>{for(var a,n,l="",p="",e=0,t=0;n=s.charAt(t++);~n&&(a=e%4?64*a+n:n,e++%4)&&(l+=String.fromCharCode(255&a>>(-2*e&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var c=0,r=l.length;c<r;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),t=0;t<256;t++)l[t]=t;for(t=0;t<256;t++)p=(p+l[t]+a.charCodeAt(t%a.length))%256,n=l[t],l[t]=l[p],l[p]=n;for(var t=0,p=0,c=0;c<s.length;c++)n=l[t=(t+1)%256],l[t]=l[p=(p+l[t])%256],l[p]=n,e+=String.fromCharCode(s.charCodeAt(c)^l[(l[t]+l[p])%256]);return e},p=arguments,_0x32c6.xEhoBj=!0);var s=s+e[0],l=p[s];return l?n=l:(void 0===_0x32c6.KmUPkP&&(_0x32c6.KmUPkP=!0),n=_0x32c6.KHrKYX(n,a),p[s]=n),n})(p,s)}var _0x1c80f0=_0x32c6;if((()=>{for(var s=_0x32c6,a=_0x2ca2();;)try{if(177356==+parseInt(s(299,"Lpi7"))+-parseInt(s(318,"WmBh"))/2*(parseInt(s(313,"JD&e"))/3)+parseInt(s(308,"Z@D#"))/4+parseInt(s(319,"ZwIo"))/5+-parseInt(s(305,"()IN"))/6*(-parseInt(s(306,"m*Wd"))/7)+-parseInt(s(311,"gEM@"))/8*(-parseInt(s(302,"oalN"))/9)+-parseInt(s(309,"vcoY"))/10*(parseInt(s(317,"gEM@"))/11))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x1c80f0(322,"gqAZ")](_0x1c80f0(321,"Lpi7"))!=_0x1c80f0(315,"PYWx"))throw window[_0x1c80f0(304,"vcoY")][_0x1c80f0(297,"IPg0")](_0x1c80f0(310,"a%Eg")),Error();function _0x2ca2(){var s=["nMvaWQLn","tCoLtCkuW5fsW6j4WOnOlCo0","wCofW5ldOCkHoSk6W67dKmkqha","qCo3g8kRdddcVfrvWQldKCkz","W7RdMMuAEWfIW7vrh8kx","wCofW5hdOSkMr8kJW5FdNmkgaL0","DSkyBHxcU8kiW4LVW6y","WPlcNK7dUdHKvq","bSopo0BdU8kYW49zW74OWQO","aSo1jdJcNSowW7CAWOSJWQRcNq","WOq5W5WDemkPWQe","W4PRWRZdJWS7WRSGwSkcWPbs","bSopoexdVmopW5zGW7i+WRr0","lgOMW7K+WO/dUG","W4tdRSoEW53dQc0vF8oes8oI","FYaJpmkaEWOZDSo6W6DAWPy","BSk5ACoBv0ldRW","s8oPnHGTgcu8","W4pcL8k6WRlcNcG2","iH1xzdPiAZ/cJGPFW6q","xSoxW7/cRCo7W43cSCouW5OBWOyNnG","WP3dR8onW5JdRvFdSmoyxMbxuW","fSk3BuKwhHmrrCk1","WOZcT8obW6dcTCooW4PAB8oVWRr7yHpcR8kUdqRdSCoJEgpcLmkSpe8","umkHWQBcHmo7j8kG","jqTCWPOyWRtdTmovWOJdUG","W4RdTmkiCr9TWPm","xhJdQCojW7LWWO4"];return(_0x2ca2=function(){return s})()}document.title="React Native WebView 通信详解",document.getElementById("article").innerHTML='<div><p>WebView 与 React Native 之间的通信是混合开发中的核心功能，下面详细介绍各种通信方式及其实现方法。</p>\n<h2>一、基础通信机制</h2>\n<h3>1. Web 向 React Native 发送消息</h3>\n<h4>实现方式：</h4>\n<pre><code class="language-jsx">&lt;<span class="hljs-title class_">WebView</span>\n  source={{ <span class="hljs-attr">uri</span>: <span class="hljs-string">&#x27;https://example.com&#x27;</span> }}\n  onMessage={<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> message = event.<span class="hljs-property">nativeEvent</span>.<span class="hljs-property">data</span>;\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received from Web:&#x27;</span>, message);\n  }}\n  injectedJavaScript={<span class="hljs-string">`\n    // 网页中调用此方法发送消息\n    window.ReactNativeWebView.postMessage(&#x27;Hello from Web&#x27;);\n    true; // 必须返回true避免警告\n  `</span>}\n/&gt;\n</code></pre>\n<h4>网页端代码：</h4>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToApp</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-comment">// 发送字符串</span>\n  <span class="hljs-variable language_">window</span>.<span class="hljs-property">ReactNativeWebView</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&#x27;简单消息&#x27;</span>);\n  \n  <span class="hljs-comment">// 发送结构化数据</span>\n  <span class="hljs-variable language_">window</span>.<span class="hljs-property">ReactNativeWebView</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;userAction&#x27;</span>,\n    <span class="hljs-attr">data</span>: { <span class="hljs-attr">action</span>: <span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;btn1&#x27;</span> }\n  }));\n}\n</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;sendToApp()&quot;</span>&gt;</span>发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>\n</code></pre>\n<h3>2. React Native 向 Web 发送消息</h3>\n<h4>实现方式：</h4>\n<pre><code class="language-jsx"><span class="hljs-keyword">const</span> webViewRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);\n\n<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendToWeb</span> = (<span class="hljs-params"></span>) =&gt; {\n  webViewRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">injectJavaScript</span>(<span class="hljs-string">`\n    // 网页中需要定义receiveRNMessage函数\n    if (window.receiveRNMessage) {\n      receiveRNMessage(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ msg: <span class="hljs-string">&#x27;来自RN的消息&#x27;</span> })}</span>);\n    }\n    true; // 防止警告\n  `</span>);\n};\n\n<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WebView</span>\n  <span class="hljs-attr">ref</span>=<span class="hljs-string">{webViewRef}</span>\n  <span class="hljs-attr">source</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">uri:</span> &#x27;<span class="hljs-attr">https:</span>//<span class="hljs-attr">example.com</span>&#x27; }}\n/&gt;</span></span>\n</code></pre>\n<h4>网页端准备：</h4>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">\n<span class="hljs-comment">// 接收RN消息的函数</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-property">receiveRNMessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received from RN:&#x27;</span>, data);\n  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;output&#x27;</span>).<span class="hljs-property">innerText</span> = data.<span class="hljs-property">msg</span>;\n};\n</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;output&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>\n</code></pre>\n<h2>二、高级通信方案</h2>\n<h3>1. 双向事件总线</h3>\n<h4>React Native 端实现：</h4>\n<pre><code class="language-jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">EventEmitter</span> = {\n  <span class="hljs-attr">events</span>: {},\n  <span class="hljs-title function_">emit</span>(<span class="hljs-params">event, data</span>) {\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[event]) {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[event].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(data));\n    }\n  },\n  <span class="hljs-title function_">on</span>(<span class="hljs-params">event, callback</span>) {\n    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[event]) <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[event] = [];\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[event].<span class="hljs-title function_">push</span>(callback);\n  }\n};\n\n<span class="hljs-comment">// 注入全局通信对象</span>\n<span class="hljs-keyword">const</span> injectGlobalBridge = <span class="hljs-string">`\n  window.RNBridge = {\n    postMessage: function(data) {\n      window.ReactNativeWebView.postMessage(JSON.stringify(data));\n    },\n    handlers: {},\n    on: function(event, handler) {\n      this.handlers[event] = handler;\n    }\n  };\n  true;\n`</span>;\n\n<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WebView</span>\n  <span class="hljs-attr">ref</span>=<span class="hljs-string">{webViewRef}</span>\n  <span class="hljs-attr">source</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">uri:</span> &#x27;<span class="hljs-attr">https:</span>//<span class="hljs-attr">example.com</span>&#x27; }}\n  <span class="hljs-attr">injectedJavaScriptBeforeContentLoaded</span>=<span class="hljs-string">{injectGlobalBridge}</span>\n  <span class="hljs-attr">onMessage</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {\n    const { event, data } = JSON.parse(e.nativeEvent.data);\n    EventEmitter.emit(event, data);\n  }}\n/&gt;</span>\n</code></pre>\n<h4>网页端使用：</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// 发送消息到RN</span>\n<span class="hljs-title class_">RNBridge</span>.<span class="hljs-title function_">postMessage</span>({\n  <span class="hljs-attr">event</span>: <span class="hljs-string">&#x27;userLogin&#x27;</span>,\n  <span class="hljs-attr">data</span>: { <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;test&#x27;</span> }\n});\n\n<span class="hljs-comment">// 接收RN消息</span>\n<span class="hljs-title class_">RNBridge</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;updateData&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received update:&#x27;</span>, data);\n});\n</code></pre>\n<h3>2. Promise 风格通信</h3>\n<h4>实现方案：</h4>\n<pre><code class="language-jsx"><span class="hljs-keyword">let</span> messageId = <span class="hljs-number">0</span>;\n<span class="hljs-keyword">const</span> pendingCallbacks = {};\n\n<span class="hljs-keyword">const</span> <span class="hljs-title function_">callWeb</span> = (<span class="hljs-params">method, params</span>) =&gt; {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> id = messageId++;\n    pendingCallbacks[id] = resolve;\n    \n    webViewRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">injectJavaScript</span>(<span class="hljs-string">`\n      if (window.webAPI) {\n        window.webAPI.handleRPC(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({\n          id: ${id},\n          method: <span class="hljs-string">&quot;${method}&quot;</span>,\n          params: ${<span class="hljs-built_in">JSON</span>.stringify(params)}\n        })}</span>);\n      }\n      true;\n    `</span>);\n  });\n};\n\n<span class="hljs-comment">// 在WebView中设置</span>\n<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WebView</span>\n  <span class="hljs-attr">onMessage</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {\n    const { id, result } = JSON.parse(e.nativeEvent.data);\n    if (pendingCallbacks[id]) {\n      pendingCallbacks[id](result);\n      delete pendingCallbacks[id];\n    }\n  }}\n/&gt;</span>\n</code></pre>\n<h4>网页端实现：</h4>\n<pre><code class="language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">webAPI</span> = {\n  <span class="hljs-attr">handleRPC</span>: <span class="hljs-title function_">async</span> (request) =&gt; {\n    <span class="hljs-keyword">let</span> result;\n    <span class="hljs-keyword">switch</span>(request.<span class="hljs-property">method</span>) {\n      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;getUserInfo&#x27;</span>:\n        result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/user&#x27;</span>);\n        <span class="hljs-keyword">break</span>;\n      <span class="hljs-comment">// 其他方法...</span>\n    }\n    \n    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ReactNativeWebView</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({\n      <span class="hljs-attr">id</span>: request.<span class="hljs-property">id</span>,\n      result\n    }));\n  }\n};\n</code></pre>\n<h2>三、性能优化技巧</h2>\n<h3>1. 批量消息处理</h3>\n<pre><code class="language-jsx"><span class="hljs-comment">// RN端</span>\n<span class="hljs-keyword">const</span> messageQueue = [];\n<span class="hljs-keyword">let</span> isProcessing = <span class="hljs-literal">false</span>;\n\n<span class="hljs-keyword">const</span> <span class="hljs-title function_">processQueue</span> = (<span class="hljs-params"></span>) =&gt; {\n  <span class="hljs-keyword">if</span> (messageQueue.<span class="hljs-property">length</span> === <span class="hljs-number">0</span> || isProcessing) <span class="hljs-keyword">return</span>;\n  \n  isProcessing = <span class="hljs-literal">true</span>;\n  <span class="hljs-keyword">const</span> batch = messageQueue.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);\n  \n  webViewRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">injectJavaScript</span>(<span class="hljs-string">`\n    window.processBatch(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(batch)}</span>);\n    true;\n  `</span>);\n  \n  isProcessing = <span class="hljs-literal">false</span>;\n  <span class="hljs-built_in">setTimeout</span>(processQueue, <span class="hljs-number">50</span>);\n};\n\n<span class="hljs-comment">// 收到消息时</span>\nonMessage={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {\n  messageQueue.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">nativeEvent</span>.<span class="hljs-property">data</span>));\n  <span class="hljs-title function_">processQueue</span>();\n}}\n</code></pre>\n<h3>2. 通信节流</h3>\n<pre><code class="language-jsx"><span class="hljs-keyword">const</span> lastSent = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);\n<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendThrottled</span> = (<span class="hljs-params">data</span>) =&gt; {\n  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n  <span class="hljs-keyword">if</span> (now - lastSent.<span class="hljs-property">current</span> &gt; <span class="hljs-number">200</span>) { <span class="hljs-comment">// 200ms节流</span>\n    webViewRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">injectJavaScript</span>(<span class="hljs-string">`...`</span>);\n    lastSent.<span class="hljs-property">current</span> = now;\n  }\n};\n</code></pre>\n<h2>四、调试技巧</h2>\n<h3>1. Chrome 远程调试</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在WebView中启用调试</span>\n&lt;<span class="hljs-title class_">WebView</span>\n  source={{ <span class="hljs-attr">uri</span>: <span class="hljs-string">&#x27;https://example.com&#x27;</span> }}\n  webviewDebuggingEnabled={<span class="hljs-literal">true</span>}\n/&gt;\n</code></pre>\n<p>然后：</p>\n<ol>\n<li>在 Chrome 地址栏输入 <code>chrome://inspect</code></li>\n<li>找到你的 WebView 进行调试</li>\n</ol>\n<h3>2. 日志输出</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 增强onMessage处理</span>\nonMessage={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (__DEV__) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Web-&gt;RN:&#x27;</span>, e.<span class="hljs-property">nativeEvent</span>.<span class="hljs-property">data</span>);\n  }\n  <span class="hljs-comment">// 实际处理逻辑...</span>\n}}\n</code></pre>\n<h2>五、安全注意事项</h2>\n<ol>\n<li><strong>消息验证</strong>  ：<pre><code class="language-javascript">onMessage={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">const</span> msg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">nativeEvent</span>.<span class="hljs-property">data</span>);\n    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">validateMessageSchema</span>(msg)) <span class="hljs-keyword">return</span>;\n    <span class="hljs-comment">// 处理有效消息</span>\n  } <span class="hljs-keyword">catch</span> (err) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;Invalid message format&#x27;</span>);\n  }\n}}\n</code></pre>\n</li>\n<li><strong>沙箱模式</strong>  ：<pre><code class="language-jsx">&lt;<span class="hljs-title class_">WebView</span>\n  source={{ <span class="hljs-attr">uri</span>: <span class="hljs-string">&#x27;https://example.com&#x27;</span> }}\n  javaScriptEnabled={<span class="hljs-literal">true</span>}\n  domStorageEnabled={<span class="hljs-literal">false</span>}\n  allowFileAccess={<span class="hljs-literal">false</span>}\n/&gt;\n</code></pre>\n</li>\n<li><strong>通信加密</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// 使用CryptoJS等库加密消息</span>\n<span class="hljs-keyword">const</span> encrypted = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">AES</span>.<span class="hljs-title function_">encrypt</span>(\n  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data), \n  <span class="hljs-string">&#x27;secret-key&#x27;</span>\n).<span class="hljs-title function_">toString</span>();\n</code></pre>\n</li>\n</ol>\n<h2>六、平台差异处理</h2>\n<h3>Android 特殊配置</h3>\n<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- AndroidManifest.xml --&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">application</span>\n  <span class="hljs-attr">android:usesCleartextTraffic</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>\n</code></pre>\n<h3>iOS 特殊处理</h3>\n<pre><code class="language-jsx">&lt;<span class="hljs-title class_">WebView</span>\n  source={{ \n    <span class="hljs-attr">uri</span>: <span class="hljs-string">&#x27;https://example.com&#x27;</span>,\n    <span class="hljs-attr">headers</span>: { <span class="hljs-string">&#x27;Custom-Header&#x27;</span>: <span class="hljs-string">&#x27;Value&#x27;</span> } \n  }}\n  allowsBackForwardNavigationGestures={<span class="hljs-literal">true</span>}\n/&gt;\n</code></pre>\n<p>通过以上方法，您可以实现高效、安全的 WebView 通信。记住根据实际需求选择合适的通信方案，简单的消息传递使用基础 API，复杂场景考虑事件总线或 RPC 模式。</p>\n</div>'</script></body></html>