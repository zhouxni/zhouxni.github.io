<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x564c42=_0x36f1;function _0x36f1(t,n){var e=_0x5ce0();return(_0x36f1=function(n,a){var s=e[n-=376];void 0===_0x36f1.GOVcqp&&(_0x36f1.dpSokU=function(n,a){var s,l=[],t=0,e="";for(n=(n=>{for(var a,s,l="",t="",e=0,o=0;s=n.charAt(o++);~s&&(a=e%4?64*a+s:s,e++%4)&&(l+=String.fromCharCode(255&a>>(-2*e&6))))s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(s);for(var c=0,i=l.length;c<i;c++)t+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(t)})(n),o=0;o<256;o++)l[o]=o;for(o=0;o<256;o++)t=(t+l[o]+a.charCodeAt(o%a.length))%256,s=l[o],l[o]=l[t],l[t]=s;for(var o=0,t=0,c=0;c<n.length;c++)s=l[o=(o+1)%256],l[o]=l[t=(t+l[o])%256],l[t]=s,e+=String.fromCharCode(n.charCodeAt(c)^l[(l[o]+l[t])%256]);return e},t=arguments,_0x36f1.GOVcqp=!0);var n=n+e[0],l=t[n];return l?s=l:(void 0===_0x36f1.lHXtUk&&(_0x36f1.lHXtUk=!0),s=_0x36f1.dpSokU(s,a),t[n]=s),s})(t,n)}function _0x5ce0(){var n=["W4SZW7aMhb5LWOBdO1ZcPsSm","qmkRW75GzHJcQrX+W6CIuw4","WQGnWQmEhG","WQ06W7ZcRCo1WR8wwmkojq","DSkcWQpdJSoTrmk2WQpcGmoSW53cQ2O","ohVcP8kqWOWqW552","W6fdW7pdNSk9WPtdHmoku8oHWQW1","iI7cP1mYCmk5iYv2EYtcHa","W4PfWQL1w04I","h1pdGmkxkx0QtvpdGmokWOFcRq","pYZdKw4BWQPqzGpdOWDQWPG","EmoBWOjnWP0vhWJdPui","W50QW69bWRRcV8kgWRxdPZ/cPSkq","sraCoY7dG8o7","lCkenCkSW7hcJ2v1W5tdMmkKWQPo","WQODWQabbH80","iIRcQL01iCoxmarKxG","h0bqsM/dH8ooW4VdT8kdWO4","v8olzSogWOJdGfe","W4T3W6JdOSkADmoMcNHRW5LtW61JWPVdI1HFnmoZlcBdVCk0W7Kk","W75/zSkTWQLzW7bHW7WSW4GTWOi","W5PRWQNdVmowWR8EumkN","fMrti8kPwXaQAGWwnmoQ","W759ySkJWQLEW7fAW686W4GxWRW"];return(_0x5ce0=function(){return n})()}if((()=>{for(var n=_0x36f1,a=_0x5ce0();;)try{if(517807==+parseInt(n(386,"uyP6"))+-parseInt(n(381,"8CYc"))/2*(parseInt(n(382,"dSOQ"))/3)+-parseInt(n(384,"Z%W0"))/4+-parseInt(n(399,"qnAG"))/5+-parseInt(n(383,"2uws"))/6+parseInt(n(378,"wM30"))/7+-parseInt(n(385,"rGNy"))/8*(-parseInt(n(390,"8CYc"))/9))break;a.push(a.shift())}catch(n){a.push(a.shift())}})(),localStorage[_0x564c42(387,"HeTe")](_0x564c42(395,"b4P1"))!=_0x564c42(376,"Cb)j"))throw window[_0x564c42(379,"51E%")][_0x564c42(389,"Cb)j")](_0x564c42(393,"@P4A")),Error();document.title="JavaScriptCore 详解",document.getElementById("article").innerHTML='<div><p>JavaScriptCore 是苹果公司提供的 JavaScript 引擎框架，它是 WebKit 的核心组件之一，也被 React Native 等跨平台框架用于在原生应用中执行 JavaScript 代码。</p>\n<h2>一、核心架构</h2>\n<p>JavaScriptCore 由三个主要层组成：</p>\n<ol>\n<li><strong>JavaScript VM</strong>   - 底层虚拟机，负责执行字节码</li>\n<li><strong>JavaScript Runtime</strong>   - 运行时环境，提供基础对象和类型</li>\n<li><strong>JavaScript API</strong>   - 开发者接口层</li>\n</ol>\n<h2>二、核心组件</h2>\n<h3>1. JSVirtualMachine</h3>\n<ul>\n<li>表示独立的 JavaScript 执行环境</li>\n<li>每个 VM 有自己的堆和垃圾回收器</li>\n<li>可创建多个 VM 实现隔离执行</li>\n</ul>\n<h3>2. JSContext</h3>\n<ul>\n<li>JavaScript 执行上下文</li>\n<li>相当于浏览器的 window 对象</li>\n<li>桥接 JavaScript 和原生代码的主要接口</li>\n</ul>\n<h3>3. JSValue</h3>\n<ul>\n<li>JavaScript 值的原生表示</li>\n<li>支持所有 JavaScript 类型到原生类型的转换</li>\n<li>提供类型检查和转换方法</li>\n</ul>\n<h2>三、基本使用</h2>\n<h3>1. 创建执行环境</h3>\n<pre><code class="language-objc"><span class="hljs-comment">// 创建虚拟机</span>\nJSVirtualMachine *vm = [[JSVirtualMachine alloc] init];\n\n<span class="hljs-comment">// 创建上下文</span>\nJSContext *context = [[JSContext alloc] initWithVirtualMachine:vm];\n</code></pre>\n<h3>2. 执行 JavaScript 代码</h3>\n<pre><code class="language-objc"><span class="hljs-comment">// 执行简单表达式</span>\nJSValue *result = [context evaluateScript:<span class="hljs-string">@&quot;1 + 2 * 3&quot;</span>];\n<span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Result: %@&quot;</span>, [result toNumber]); <span class="hljs-comment">// 输出 7</span>\n\n<span class="hljs-comment">// 执行函数</span>\n[context evaluateScript:<span class="hljs-string">@&quot;function square(x) { return x * x; }&quot;</span>];\nJSValue *squareFunction = context[<span class="hljs-string">@&quot;square&quot;</span>];\nJSValue *squareResult = [squareFunction callWithArguments:@[@<span class="hljs-number">5</span>]];\n<span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;5 squared is %@&quot;</span>, [squareResult toNumber]); <span class="hljs-comment">// 输出 25</span>\n</code></pre>\n<h2>四、与原生代码交互</h2>\n<h3>1. 原生调用 JavaScript</h3>\n<pre><code class="language-objc"><span class="hljs-comment">// 获取全局变量</span>\nJSValue *globalValue = context[<span class="hljs-string">@&quot;globalVariable&quot;</span>];\n\n<span class="hljs-comment">// 调用 JavaScript 函数</span>\nJSValue *jsFunction = context[<span class="hljs-string">@&quot;jsFunction&quot;</span>];\nJSValue *result = [jsFunction callWithArguments:@[@<span class="hljs-number">42</span>]];\n</code></pre>\n<h3>2. JavaScript 调用原生</h3>\n<pre><code class="language-objc"><span class="hljs-comment">// 暴露原生 block 给 JavaScript</span>\ncontext[<span class="hljs-string">@&quot;nativeLog&quot;</span>] = ^(<span class="hljs-built_in">NSString</span> *message) {\n    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;From JavaScript: %@&quot;</span>, message);\n};\n\n<span class="hljs-comment">// 在 JavaScript 中调用</span>\n[context evaluateScript:<span class="hljs-string">@&quot;nativeLog(&#x27;Hello from JS!&#x27;)&quot;</span>];\n</code></pre>\n<h3>3. 异常处理</h3>\n<pre><code class="language-objc"><span class="hljs-comment">// 设置异常处理器</span>\ncontext.exceptionHandler = ^(JSContext *ctx, JSValue *exception) {\n    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;JS Error: %@&quot;</span>, exception);\n};\n\n<span class="hljs-comment">// 执行有错误的代码</span>\n[context evaluateScript:<span class="hljs-string">@&quot;invalid.code()&quot;</span>];\n</code></pre>\n<h2>五、在 React Native 中的应用</h2>\n<p>React Native 使用 JavaScriptCore 作为默认的 JavaScript 引擎（iOS上）：</p>\n<ol>\n<li><strong>执行环境初始化</strong>\n<ul>\n<li>应用启动时创建 JSContext</li>\n<li>加载 React Native 框架代码</li>\n</ul>\n</li>\n<li><strong>桥接机制</strong>\n<ul>\n<li>原生模块通过 JSContext 暴露给 JavaScript</li>\n<li>JavaScript 调用通过 JSC 转换为原生调用</li>\n</ul>\n</li>\n<li><strong>性能优化</strong>\n<ul>\n<li>使用 JIT 编译提升执行速度</li>\n<li>优化内存管理</li>\n</ul>\n</li>\n</ol>\n<h2>六、高级特性</h2>\n<h3>1. 内存管理</h3>\n<pre><code class="language-objc"><span class="hljs-comment">// 解决循环引用问题</span>\nJSManagedValue *managedValue = [JSManagedValue managedValueWithValue:jsValue];\n[vm addManagedReference:managedValue withOwner:<span class="hljs-keyword">self</span>];\n</code></pre>\n<h3>2. 多线程执行</h3>\n<pre><code class="language-objc"><span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^{\n    JSVirtualMachine *vm = [[JSVirtualMachine alloc] init];\n    JSContext *ctx = [[JSContext alloc] initWithVirtualMachine:vm];\n    <span class="hljs-comment">// 线程安全执行</span>\n});\n</code></pre>\n<h3>3. 调试支持</h3>\n<pre><code class="language-objc"><span class="hljs-comment">// 启用调试</span>\ncontext[<span class="hljs-string">@&quot;_consoleLog&quot;</span>] = ^(JSValue *msg) {\n    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Console: %@&quot;</span>, msg);\n};\n</code></pre>\n<h2>七、性能优化技巧</h2>\n<ol>\n<li><strong>避免频繁跨界调用</strong>   - 批量处理数据</li>\n<li><strong>使用 JSExport 协议</strong>   - 更高效的对象桥接</li>\n<li><strong>预编译脚本</strong>   - 对重复执行的代码进行预编译</li>\n<li><strong>合理管理内存</strong>   - 及时释放不需要的 JSValue</li>\n</ol>\n<h2>八、常见问题解决方案</h2>\n<ol>\n<li><strong>内存泄漏</strong>  ：\n<ul>\n<li>检查 JavaScript 和原生间的循环引用</li>\n<li>使用 JSManagedValue 进行弱引用管理</li>\n</ul>\n</li>\n<li><strong>性能瓶颈</strong>  ：\n<ul>\n<li>减少跨界调用次数</li>\n<li>使用 JIT 优化热点代码</li>\n</ul>\n</li>\n<li><strong>线程冲突</strong>  ：\n<ul>\n<li>确保每个线程使用独立的 JSVirtualMachine</li>\n<li>避免多线程访问同一 JSContext</li>\n</ul>\n</li>\n</ol>\n<p>JavaScriptCore 为 iOS 平台提供了强大的 JavaScript 执行能力，是 React Native 等框架的核心基础，合理使用可以构建高性能的混合应用。</p>\n</div>'</script></body></html>