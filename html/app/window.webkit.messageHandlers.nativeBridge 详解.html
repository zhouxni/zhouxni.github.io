<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x5eb963=_0x48c8;function _0x48c8(e,s){var p=_0x301e();return(_0x48c8=function(s,a){var n=p[s-=481];void 0===_0x48c8.mzPBoe&&(_0x48c8.ImeAFO=function(s,a){var n,l=[],e=0,p="";for(s=(s=>{for(var a,n,l="",e="",p=0,t=0;n=s.charAt(t++);~n&&(a=p%4?64*a+n:n,p++%4)&&(l+=String.fromCharCode(255&a>>(-2*p&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var r=0,o=l.length;r<o;r++)e+="%"+("00"+l.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(e)})(s),t=0;t<256;t++)l[t]=t;for(t=0;t<256;t++)e=(e+l[t]+a.charCodeAt(t%a.length))%256,n=l[t],l[t]=l[e],l[e]=n;for(var t=0,e=0,r=0;r<s.length;r++)n=l[t=(t+1)%256],l[t]=l[e=(e+l[t])%256],l[e]=n,p+=String.fromCharCode(s.charCodeAt(r)^l[(l[t]+l[e])%256]);return p},e=arguments,_0x48c8.mzPBoe=!0);var s=s+p[0],l=e[s];return l?n=l:(void 0===_0x48c8.WSjEeP&&(_0x48c8.WSjEeP=!0),n=_0x48c8.ImeAFO(n,a),e[s]=n),n})(e,s)}function _0x301e(){var s=["xSkiWR/dMMJdMSovW70Y","jCk4W7npW7KfWOC","rmkCnSonW67dHxjjgSoo","WQdcUueFW5tdHqhcO8oRW5ms","W5lcUIddMXRdVCowomkt","sxLys2BcTgtcGmkqWP9c","WRj4WOpdGIVcJhz+WP43W44E","yqNcJxZcKCozWRxdI8o9EvBcQW","lmkwW5ZcGIddKCkq","WQ/dPmkToNmWvCkxWRdcRa","pwLsmSoDh8kaW5e","db4mWQ0tWRGCD8ktWRpdJG","lCoFWQ3dUgpdPCosW7S","WRJcGmoYW7PY","xSk3DmoOab18DSk6cq","W7pcThP8jdpdMmowwa","W6NdVq0lzmobiCk3","dbOaWQnCWQiFA8kkWRe","lWxcVSklW5tdTsrBwmkdlCkPEq","W4OlWQGJg8o+BvfIWObvi8oeW45NW4G0W596W5hdQSo1tc/dRCon","ymkdhhhdR0RcOmoAFvGIW4i","wSoIk2xcOvqjWPnWWR8p","WRD6W73cG3/dQhP6","dvHqW4X3WOKA","WQZcQmkRW4jgjmkADcWSpclcOW","eshdSCoTW7HJWR8","WPldMSoAWOFdIcrGwG","kGlcU8koW5ddS1zKEmkmhmkX","W4ZdHhJdHdlcHIFcLeRcP8oE","AqxcJNVcKCkXWPJdQmodzKC"];return(_0x301e=function(){return s})()}if((()=>{for(var s=_0x48c8,a=_0x301e();;)try{if(154820==+parseInt(s(492,"czxf"))+parseInt(s(493,"Xk0!"))/2+-parseInt(s(495,"ilW9"))/3*(-parseInt(s(508,"d8eR"))/4)+parseInt(s(505,"$][x"))/5*(-parseInt(s(484,"a#^$"))/6)+parseInt(s(506,"TAWp"))/7*(-parseInt(s(507,"Aq$%"))/8)+parseInt(s(496,"2hWF"))/9*(parseInt(s(494,"d8eR"))/10)+parseInt(s(504,"z&[O"))/11*(-parseInt(s(489,"ilW9"))/12))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x5eb963(497,")uam")](_0x5eb963(502,"a#^$"))!=_0x5eb963(485,"Sd3k"))throw window[_0x5eb963(498,"PrCn")][_0x5eb963(510,"(Enb")](_0x5eb963(491,"Uj4N")),Error();document.title="window.webkit.messageHandlers.nativeBridge 详解",document.getElementById("article").innerHTML='<div><p><code>window.webkit.messageHandlers.nativeBridge</code> 是 iOS 中 <strong>WKWebView</strong>   与 JavaScript 通信的核心 API，它允许 H5 页面直接调用原生 iOS 代码。这是目前 iOS 混合开发中最推荐的通信方式。</p>\n<h2>基本工作原理</h2>\n<ol>\n<li><strong>iOS 原生端</strong>  ：通过 <code>WKUserContentController</code> 注册消息处理器</li>\n<li><strong>H5 端</strong>  ：通过 <code>window.webkit.messageHandlers.{handlerName}.postMessage()</code> 发送消息</li>\n<li><strong>双向通信</strong>  ：原生可以获取 H5 发送的数据，也可以通过回调返回数据给 H5</li>\n</ol>\n<h2>完整实现示例</h2>\n<h3>iOS 原生端配置 (Swift)</h3>\n<pre><code class="language-swift"><span class="hljs-keyword">import</span> WebKit\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_ inherited__">UIViewController</span>, <span class="hljs-title class_ inherited__">WKScriptMessageHandler</span> {\n    <span class="hljs-keyword">var</span> webView: <span class="hljs-type">WKWebView</span>!\n    \n    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {\n        <span class="hljs-keyword">super</span>.viewDidLoad()\n        \n        <span class="hljs-comment">// 1. 创建配置并注册消息处理器</span>\n        <span class="hljs-keyword">let</span> config <span class="hljs-operator">=</span> <span class="hljs-type">WKWebViewConfiguration</span>()\n        <span class="hljs-keyword">let</span> contentController <span class="hljs-operator">=</span> <span class="hljs-type">WKUserContentController</span>()\n        contentController.add(<span class="hljs-keyword">self</span>, name: <span class="hljs-string">&quot;nativeBridge&quot;</span>) <span class="hljs-comment">// 注册名为 &quot;nativeBridge&quot; 的处理器</span>\n        config.userContentController <span class="hljs-operator">=</span> contentController\n        \n        <span class="hljs-comment">// 2. 初始化 WKWebView</span>\n        webView <span class="hljs-operator">=</span> <span class="hljs-type">WKWebView</span>(frame: view.bounds, configuration: config)\n        view.addSubview(webView)\n        \n        <span class="hljs-comment">// 3. 加载 HTML 或 URL</span>\n        <span class="hljs-keyword">let</span> htmlPath <span class="hljs-operator">=</span> <span class="hljs-type">Bundle</span>.main.path(forResource: <span class="hljs-string">&quot;index&quot;</span>, ofType: <span class="hljs-string">&quot;html&quot;</span>)\n        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(fileURLWithPath: htmlPath<span class="hljs-operator">!</span>)\n        webView.loadFileURL(url, allowingReadAccessTo: url)\n    }\n    \n    <span class="hljs-comment">// 4. 实现消息处理协议</span>\n    <span class="hljs-keyword">func</span> <span class="hljs-title function_">userContentController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">userContentController</span>: <span class="hljs-type">WKUserContentController</span>, <span class="hljs-params">didReceive</span> <span class="hljs-params">message</span>: <span class="hljs-type">WKScriptMessage</span>) {\n        <span class="hljs-keyword">if</span> message.name <span class="hljs-operator">==</span> <span class="hljs-string">&quot;nativeBridge&quot;</span> {\n            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;收到来自H5的消息:&quot;</span>, message.body)\n            \n            <span class="hljs-comment">// 可以在这里处理各种原生功能</span>\n            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> body <span class="hljs-operator">=</span> message.body <span class="hljs-keyword">as?</span> [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>],\n               <span class="hljs-keyword">let</span> action <span class="hljs-operator">=</span> body[<span class="hljs-string">&quot;action&quot;</span>] <span class="hljs-keyword">as?</span> <span class="hljs-type">String</span> {\n                \n                <span class="hljs-keyword">switch</span> action {\n                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;getDeviceInfo&quot;</span>:\n                    <span class="hljs-keyword">let</span> deviceInfo <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;os&quot;</span>: <span class="hljs-string">&quot;iOS&quot;</span>, <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-type">UIDevice</span>.current.systemVersion]\n                    <span class="hljs-comment">// 回调给H5</span>\n                    <span class="hljs-keyword">let</span> script <span class="hljs-operator">=</span> <span class="hljs-string">&quot;window.receiveNativeResponse(<span class="hljs-subst">\\(deviceInfo)</span>)&quot;</span>\n                    webView.evaluateJavaScript(script)\n                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;openCamera&quot;</span>:\n                    <span class="hljs-comment">// 调用原生相机...</span>\n                    <span class="hljs-keyword">break</span>\n                <span class="hljs-keyword">default</span>:\n                    <span class="hljs-keyword">break</span>\n                }\n            }\n        }\n    }\n    \n    <span class="hljs-comment">// 记得在适当时候移除处理器</span>\n    <span class="hljs-keyword">deinit</span> {\n        webView.configuration.userContentController.removeScriptMessageHandler(forName: <span class="hljs-string">&quot;nativeBridge&quot;</span>)\n    }\n}\n</code></pre>\n<h3>H5 端 JavaScript 调用</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 1. 定义接收原生回调的函数</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-property">receiveNativeResponse</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;收到原生返回:&#x27;</span>, data);\n};\n\n<span class="hljs-comment">// 2. 调用原生方法</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">callNative</span>(<span class="hljs-params">action, params</span>) {\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span>.<span class="hljs-property">messageHandlers</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span>.<span class="hljs-property">messageHandlers</span>.<span class="hljs-property">nativeBridge</span>) {\n        <span class="hljs-keyword">const</span> message = {\n            <span class="hljs-attr">action</span>: action,\n            <span class="hljs-attr">data</span>: params || {}\n        };\n        <span class="hljs-comment">// 调用原生处理器</span>\n        <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span>.<span class="hljs-property">messageHandlers</span>.<span class="hljs-property">nativeBridge</span>.<span class="hljs-title function_">postMessage</span>(message);\n    } <span class="hljs-keyword">else</span> {\n        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;原生桥接不可用&#x27;</span>);\n    }\n}\n\n<span class="hljs-comment">// 3. 使用示例</span>\n<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;btn&#x27;</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-title function_">callNative</span>(<span class="hljs-string">&#x27;getDeviceInfo&#x27;</span>);\n    \n    <span class="hljs-comment">// 带参数的调用</span>\n    <span class="hljs-title function_">callNative</span>(<span class="hljs-string">&#x27;openCamera&#x27;</span>, {\n        <span class="hljs-attr">quality</span>: <span class="hljs-string">&#x27;high&#x27;</span>,\n        <span class="hljs-attr">allowEdit</span>: <span class="hljs-literal">true</span>\n    });\n});\n</code></pre>\n<h2>关键注意事项</h2>\n<ol>\n<li><strong>内存管理</strong>  ：必须在不需要时移除消息处理器，避免内存泄漏<pre><code class="language-swift"><span class="hljs-keyword">deinit</span> {\n    webView.configuration.userContentController.removeScriptMessageHandler(forName: <span class="hljs-string">&quot;nativeBridge&quot;</span>)\n}\n</code></pre>\n</li>\n<li><strong>数据类型</strong>  ：<code>postMessage</code> 支持的基本数据类型：\n<ul>\n<li>NSNumber</li>\n<li>NSString</li>\n<li>NSDate</li>\n<li>NSArray</li>\n<li>NSDictionary</li>\n<li>NSNull</li>\n</ul>\n</li>\n<li><strong>性能优化</strong>  ：大量数据通信建议使用结构化数据而非字符串解析</li>\n<li><strong>调试技巧</strong>  ：在 Safari 的 Web Inspector 中可以查看消息传递情况</li>\n</ol>\n<h2>与 Android 的兼容方案</h2>\n<pre><code class="language-javascript"><span class="hljs-comment">// 统一调用接口</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">callNative</span>(<span class="hljs-params">action, params</span>) {\n    <span class="hljs-comment">// iOS</span>\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span>.<span class="hljs-property">messageHandlers</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span>.<span class="hljs-property">messageHandlers</span>.<span class="hljs-property">nativeBridge</span>) {\n        <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span>.<span class="hljs-property">messageHandlers</span>.<span class="hljs-property">nativeBridge</span>.<span class="hljs-title function_">postMessage</span>({\n            <span class="hljs-attr">action</span>: action,\n            <span class="hljs-attr">data</span>: params || {}\n        });\n    } \n    <span class="hljs-comment">// Android</span>\n    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">NativeBridge</span>) {\n        <span class="hljs-variable language_">window</span>.<span class="hljs-property">NativeBridge</span>[action](<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params || {}));\n    }\n    <span class="hljs-comment">// 其他情况</span>\n    <span class="hljs-keyword">else</span> {\n        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;原生桥接不可用&#x27;</span>);\n    }\n}\n</code></pre>\n<h2>常见问题解决</h2>\n<p><strong>Q1: 为什么调用后没有反应？</strong></p>\n<ul>\n<li>检查 iOS 端是否正确注册了消息处理器</li>\n<li>确认 <code>handlerName</code> 完全一致（大小写敏感）</li>\n<li>检查 WKWebView 是否已加载完成</li>\n</ul>\n<p><strong>Q2: 如何传递复杂对象？</strong></p>\n<ul>\n<li>将数据转换为字典/JSON格式传递</li>\n<li>避免传递循环引用的对象</li>\n</ul>\n<p><strong>Q3: 如何确保安全性？</strong></p>\n<ul>\n<li>验证消息来源（检查 webView.URL）</li>\n<li>对敏感操作增加权限检查</li>\n<li>不要直接执行来自H5的任意脚本</li>\n</ul>\n<p>这种通信方式是 iOS 混合开发中最稳定高效的方案，适合需要频繁交互的复杂应用场景。</p>\n</div>'</script></body></html>