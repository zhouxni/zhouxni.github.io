<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x2be547=_0x2c05;if((()=>{for(var n=_0x2c05,s=_0x422c();;)try{if(212666==+parseInt(n(391,"fAWq"))*(parseInt(n(392,"Z%VP"))/2)+-parseInt(n(382,"uK6Z"))/3+parseInt(n(399,"l$$U"))/4+-parseInt(n(403,"c^)O"))/5+parseInt(n(384,"b4K]"))/6*(-parseInt(n(398,"Tr%x"))/7)+-parseInt(n(383,"Tr%x"))/8+parseInt(n(402,"$hqp"))/9)break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x2be547(396,"oX@w")](_0x2be547(400,")112"))!=_0x2be547(401,"Izj2"))throw window[_0x2be547(381,"*f$l")][_0x2be547(388,"(fX3")](_0x2be547(390,"b4K]")),Error();function _0x2c05(r,n){var t=_0x422c();return(_0x2c05=function(n,s){var e=t[n-=381];void 0===_0x2c05.ObSpMV&&(_0x2c05.LtrpgE=function(n,s){var e,a=[],r=0,t="";for(n=(n=>{for(var s,e,a="",r="",t=0,l=0;e=n.charAt(l++);~e&&(s=t%4?64*s+e:e,t++%4)&&(a+=String.fromCharCode(255&s>>(-2*t&6))))e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(e);for(var o=0,p=a.length;o<p;o++)r+="%"+("00"+a.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(r)})(n),l=0;l<256;l++)a[l]=l;for(l=0;l<256;l++)r=(r+a[l]+s.charCodeAt(l%s.length))%256,e=a[l],a[l]=a[r],a[r]=e;for(var l=0,r=0,o=0;o<n.length;o++)e=a[l=(l+1)%256],a[l]=a[r=(r+a[l])%256],a[r]=e,t+=String.fromCharCode(n.charCodeAt(o)^a[(a[l]+a[r])%256]);return t},r=arguments,_0x2c05.ObSpMV=!0);var n=n+t[0],a=r[n];return a?e=a:(void 0===_0x2c05.RspyEc&&(_0x2c05.RspyEc=!0),e=_0x2c05.LtrpgE(e,s),r[n]=e),e})(r,n)}function _0x422c(){var n=["smoHW4xcHCobWQKHcY7dJG5u","pmkaAmopl1ddG8kYW7/dH1yZW50","nmoYfhtdRmoahW","W5ldHIFcKeldMCkMW6D6W5JcLCo9kG","WQqygmo9vXvO","f8o5zCk2E2NcJ8kCdIlcJmkD","fSkNWOtdHSkeWQfCstddQIvSbwbhpCkoggDQCt55W7ztnG","W6bXAXBdR8kDWQG","dmk3vKZcJ8k8wszhWRdcHa","WQzkWPS2WOzzWO0","W5RdUCocW69HWOWEBmoswclcGa","WOxdJSobW5hdV0eqWO0qawiGW7e","W6TIWPGIW6iIWQ0","W5RdUSopW6DIWOvJq8oMDYVcV8oI","xSkzW48lwtfd","WQNdObu5W6/cMmk1WPSobSogWPJcRW","rCogt8okWP/dJb42mG","iCo3WRS2W7m","smkaWOlcQuFdO8oKWOhcNCo3WQKfWPa","sCo1u8kuDLL+bSoxWOrrWPu","W5FdQd0dWPdcKgtcPKRcPSkq","yshdKCkCW63cJc7cQW","r8kmW5ZdHmkXW6GBDweTW5LrgW","wmocWQ15puqvWQ3dLmotWOXNW4y"];return(_0x422c=function(){return n})()}document.title="Jenkins 中动态生成小程序上传所需的 private.key 密钥文件",document.getElementById("article").innerHTML='<div><p>在 Jenkins 中动态生成小程序上传所需的 <strong>private.key</strong>   密钥文件，并确保安全地用于自动化构建和上传流程，可以通过以下步骤实现：</p>\n<hr>\n<h3><strong>1. 安全存储密钥内容到 Jenkins</strong></h3>\n<h4>方法一：直接存储密钥内容（适用于文本格式密钥）</h4>\n<ol>\n<li>进入 Jenkins → <strong>Manage Jenkins</strong>   → <strong>Credentials</strong>   → <strong>Add Credentials</strong></li>\n<li>选择类型为 <strong>Secret text</strong></li>\n<li>将 <code>private.key</code> 文件的内容粘贴到输入框中</li>\n<li>设置 ID 为 <code>wechat-private-key</code>（可自定义）</li>\n</ol>\n<h4>方法二：上传密钥文件（适用于二进制或复杂密钥）</h4>\n<ol>\n<li>选择类型为 <strong>Secret file</strong></li>\n<li>直接上传 <code>private.key</code> 文件</li>\n<li>设置 ID 为 <code>wechat-private-key-file</code></li>\n</ol>\n<hr>\n<h3><strong>2. 在 Jenkins Pipeline 中动态生成 private.key</strong></h3>\n<p>根据存储方式选择对应的生成方法：</p>\n<h4><strong>方案 A：从 Secret text 生成文件</strong></h4>\n<pre><code class="language-groovy">pipeline {\n    agent any\n    stages {\n        stage(<span class="hljs-string">&#x27;Generate Private Key&#x27;</span>) {\n            steps {\n                withCredentials([string(\n                    <span class="hljs-symbol">credentialsId:</span> <span class="hljs-string">&#x27;wechat-private-key&#x27;</span>,\n                    <span class="hljs-symbol">variable:</span> <span class="hljs-string">&#x27;PRIVATE_KEY_CONTENT&#x27;</span>\n                )]) {\n                    sh <span class="hljs-string">&#x27;&#x27;&#x27;\n                        # 将密钥内容写入文件\n                        echo &quot;$PRIVATE_KEY_CONTENT&quot; &gt; private.key\n                        chmod 600 private.key  # 限制权限\n\n                        # 验证文件内容（调试用）\n                        head -n 1 private.key | grep &quot;BEGIN PRIVATE KEY&quot;\n                    &#x27;&#x27;&#x27;</span>\n                }\n            }\n        }\n    }\n}\n</code></pre>\n<h4><strong>方案 B：从 Secret file 提取文件</strong></h4>\n<pre><code class="language-groovy">steps {\n    withCredentials([file(\n        <span class="hljs-symbol">credentialsId:</span> <span class="hljs-string">&#x27;wechat-private-key-file&#x27;</span>,\n        <span class="hljs-symbol">variable:</span> <span class="hljs-string">&#x27;KEY_FILE_TEMP&#x27;</span>\n    )]) {\n        sh <span class="hljs-string">&#x27;&#x27;&#x27;\n            # 直接复制密钥文件到工作目录\n            cp $KEY_FILE_TEMP private.key\n            chmod 600 private.key\n        &#x27;&#x27;&#x27;</span>\n    }\n}\n</code></pre>\n<hr>\n<h3><strong>3. 集成小程序上传工具</strong></h3>\n<h4>安装依赖工具（如 miniprogram-ci）</h4>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Upload WeApp&#x27;</span>) {\n    steps {\n        sh <span class="hljs-string">&#x27;&#x27;&#x27;\n            npm install -g miniprogram-ci\n            miniprogram-ci upload \\\n                --pp ./ \\\n                --pk ./private.key \\\n                --appid wx1234567890abcdef \\\n                --version ${BUILD_NUMBER}\n        &#x27;&#x27;&#x27;</span>\n    }\n}\n</code></pre>\n<hr>\n<h3><strong>4. 安全清理（构建后自动删除密钥）</strong></h3>\n<pre><code class="language-groovy">post {\n    always {\n        sh <span class="hljs-string">&#x27;&#x27;&#x27;\n            # 安全删除密钥文件\n            rm -f private.key\n            # 可选：用 shred 彻底清除（需安装）\n            if command -v shred &amp;&gt; /dev/null; then\n                shred -u private.key 2&gt;/dev/null || true\n            fi\n        &#x27;&#x27;&#x27;</span>\n    }\n}\n</code></pre>\n<hr>\n<h3><strong>5. 完整 Jenkinsfile 示例</strong></h3>\n<pre><code class="language-groovy">pipeline {\n    agent any\n    environment {\n        WECHAT_APPID = <span class="hljs-string">&#x27;wx1234567890abcdef&#x27;</span>  <span class="hljs-comment">// 可从参数或凭据读取</span>\n    }\n    stages {\n        stage(<span class="hljs-string">&#x27;Prepare Key&#x27;</span>) {\n            steps {\n                withCredentials([string(\n                    <span class="hljs-symbol">credentialsId:</span> <span class="hljs-string">&#x27;wechat-private-key&#x27;</span>,\n                    <span class="hljs-symbol">variable:</span> <span class="hljs-string">&#x27;PRIVATE_KEY&#x27;</span>\n                )]) {\n                    sh <span class="hljs-string">&#x27;&#x27;&#x27;\n                        echo &quot;$PRIVATE_KEY&quot; &gt; private.key\n                        chmod 600 private.key\n                    &#x27;&#x27;&#x27;</span>\n                }\n            }\n        }\n        stage(<span class="hljs-string">&#x27;Build &amp; Upload&#x27;</span>) {\n            steps {\n                sh <span class="hljs-string">&#x27;&#x27;&#x27;\n                    npm install\n                    npm run build\n                    miniprogram-ci upload \\\n                        --pp ./dist \\\n                        --pk ./private.key \\\n                        --appid $WECHAT_APPID \\\n                        --desc &quot;Jenkins Build ${BUILD_NUMBER}&quot;\n                &#x27;&#x27;&#x27;</span>\n            }\n        }\n    }\n    post {\n        always {\n            sh <span class="hljs-string">&#x27;rm -f private.key&#x27;</span>\n        }\n    }\n}\n</code></pre>\n<hr>\n<h3><strong>关键安全措施</strong></h3>\n<ol>\n<li>\n<p><strong>最小权限原则</strong></p>\n<ul>\n<li>为 Jenkins 任务使用专用账号，仅赋予小程序上传权限</li>\n<li>限制 <code>private.key</code> 文件权限为 <code>600</code>（仅所有者可读写）</li>\n</ul>\n</li>\n<li>\n<p><strong>敏感信息隐藏</strong></p>\n<ul>\n<li>使用 <code>withCredentials</code> 自动屏蔽日志中的密钥内容</li>\n<li>在 Jenkins 中启用 <strong>Mask Passwords</strong>   插件</li>\n</ul>\n</li>\n<li>\n<p><strong>多环境支持</strong></p>\n<pre><code class="language-groovy">parameters {\n    choice(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;ENV&#x27;</span>, <span class="hljs-attr">choices:</span> [<span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-string">&#x27;prod&#x27;</span>], <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;环境&#x27;</span>)\n}\nenvironment {\n    WECHAT_APPID = params.ENV == <span class="hljs-string">&#x27;prod&#x27;</span> ? <span class="hljs-string">&#x27;wxprod123&#x27;</span> : <span class="hljs-string">&#x27;wxdev456&#x27;</span>\n}\n</code></pre>\n</li>\n<li>\n<p><strong>审计与备份</strong></p>\n<ul>\n<li>开启 Jenkins 构建日志审计</li>\n<li>在安全位置（如 AWS Secrets Manager）备份原始密钥</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3><strong>常见问题解决</strong></h3>\n<p><strong>问题1：密钥格式错误</strong></p>\n<ul>\n<li>确保 <code>private.key</code> 内容包含完整的 PEM 格式（含 <code>-----BEGIN PRIVATE KEY-----</code> 头尾）</li>\n<li>可用命令验证：<code>openssl rsa -in private.key -check</code></li>\n</ul>\n<p><strong>问题2：权限不足</strong></p>\n<ul>\n<li>如果上传失败，检查小程序后台是否已为 Jenkins 使用的 IP 添加白名单</li>\n</ul>\n<p><strong>问题3：跨平台路径问题</strong></p>\n<ul>\n<li>在 Windows 代理上使用 PowerShell 替代 Shell：<pre><code class="language-groovy">powershell <span class="hljs-string">&#x27;&#x27;&#x27;\n    $PRIVATE_KEY | Out-File -FilePath private.key -Encoding ASCII\n    icacls private.key /inheritance:r /grant:r &quot;%USERNAME%:R&quot;\n&#x27;&#x27;&#x27;</span>\n</code></pre>\n</li>\n</ul>\n<p>通过以上方法，可以安全地在 Jenkins 流水线中动态生成和使用小程序密钥文件。</p>\n</div>'</script></body></html>