<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x117843=_0x747d;function _0x747d(e,n){var r=_0x6bf5();return(_0x747d=function(n,s){var a=r[n-=455];void 0===_0x747d.sjIwhj&&(_0x747d.sxgUTU=function(n,s){var a,t=[],e=0,r="";for(n=(n=>{for(var s,a,t="",e="",r=0,o=0;a=n.charAt(o++);~a&&(s=r%4?64*s+a:a,r++%4)&&(t+=String.fromCharCode(255&s>>(-2*r&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var p=0,l=t.length;p<l;p++)e+="%"+("00"+t.charCodeAt(p).toString(16)).slice(-2);return decodeURIComponent(e)})(n),o=0;o<256;o++)t[o]=o;for(o=0;o<256;o++)e=(e+t[o]+s.charCodeAt(o%s.length))%256,a=t[o],t[o]=t[e],t[e]=a;for(var o=0,e=0,p=0;p<n.length;p++)a=t[o=(o+1)%256],t[o]=t[e=(e+t[o])%256],t[e]=a,r+=String.fromCharCode(n.charCodeAt(p)^t[(t[o]+t[e])%256]);return r},e=arguments,_0x747d.sjIwhj=!0);var n=n+r[0],t=e[n];return t?a=t:(void 0===_0x747d.NNqGub&&(_0x747d.NNqGub=!0),a=_0x747d.sxgUTU(a,s),e[n]=a),a})(e,n)}function _0x6bf5(){var n=["lmocWRtdHSkOW47cHmkieW","WPr0WRTHdI7dVmoEnSkPW4nGlmojw8oRW4zGke3cS1BdIWGWWOG","W7ddMmojAchcLSoNegS","W6RdSxOzW5u6g2KOCtrvAW","s8o8W6XmmqddUa","W6XqrCkoW6WyhHPfWQmQDCkw","rx3dRLquWOfdiCk0fYxcJmo3","W5aoWRVdL8o0WPTDomoFW6LhWOe","WPiLW5ddUZS5W606fa","WPfbFvP1A1PgW7bIk8kVoW","lmoeWRlcTmoMWRRdLmkOp8kgjZZcKG","W53dLmojBcBcJmodgW","t8kXedRcHq3cLmoJjfFdQG","DCkfxmoHWRRcQSorWPWXeeX1","C8osWRpdSCoUumomjmk+ySkcDmkm","ECkchSk9W6FdSCo0WPS","w8o2xCkBqaDbW7pdSmoVd3ye","tSozWPKaWRpdRhxcJGFdICkU","e3RdMapcTgaDWRa","W5yvpG8Noq0","FSoajSkCW4pdUCor","W7BdUZ/dRgC","lb3cMIFcN8onWPa","WQ/cRCkbAvBdGI7cS0ZdJM3cUW","WOtcVXntEGBcTGCGWRmcAW"];return(_0x6bf5=function(){return n})()}if((()=>{for(var n=_0x747d,s=_0x6bf5();;)try{if(825867==+parseInt(n(464,"%X&3"))+-parseInt(n(473,"7(r!"))/2*(-parseInt(n(456,"@!6E"))/3)+-parseInt(n(468,"p5rU"))/4+parseInt(n(475,"#Cgu"))/5+parseInt(n(470,"R8@T"))/6+-parseInt(n(459,"b%TZ"))/7*(parseInt(n(469,"up]a"))/8)+parseInt(n(479,"e(%("))/9*(-parseInt(n(467,"vUw1"))/10))break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x117843(465,"HA4h")](_0x117843(463,"MPiv"))!=_0x117843(457,"Xo9^"))throw window[_0x117843(472,"MPiv")][_0x117843(455,"R8@T")](_0x117843(462,"9I^V")),Error();document.title="在 Jenkins 中构建时注入环境变量",document.getElementById("article").innerHTML='<div><p>在 Jenkins 中构建时注入环境变量有多种方式，以下是常见的 <strong>6 种方法</strong>   ，涵盖不同场景需求：</p>\n<hr>\n<h3><strong>1. 使用 <code>environment</code> 指令（声明式流水线）</strong></h3>\n<p>在 Jenkinsfile 中直接定义环境变量：</p>\n<pre><code class="language-groovy">pipeline {\n    agent any\n    environment {\n        APP_VERSION = <span class="hljs-string">&#x27;1.0.0&#x27;</span>                  <span class="hljs-comment">// 静态变量</span>\n        BUILD_TIME = sh(<span class="hljs-attr">returnStdout:</span> <span class="hljs-literal">true</span>, <span class="hljs-attr">script:</span> <span class="hljs-string">&#x27;date +%Y-%m-%d&#x27;</span>).trim()  <span class="hljs-comment">// 动态生成</span>\n        CREDENTIALS = credentials(<span class="hljs-string">&#x27;aws-secret&#x27;</span>) <span class="hljs-comment">// 从凭据系统读取（自动屏蔽输出）</span>\n    }\n    stages {\n        stage(<span class="hljs-string">&#x27;Build&#x27;</span>) {\n            steps {\n                sh <span class="hljs-string">&#x27;echo &quot;Building version ${APP_VERSION} at ${BUILD_TIME}&quot;&#x27;</span>\n                sh <span class="hljs-string">&#x27;echo &quot;AWS key: ${CREDENTIALS_USR}:${CREDENTIALS_PSW}&quot;&#x27;</span>\n            }\n        }\n    }\n}\n</code></pre>\n<p><strong>适用场景</strong>   ：需要在整个流水线中共享的变量。</p>\n<hr>\n<h3><strong>2. 通过 <code>withEnv</code> 临时注入变量</strong></h3>\n<p>在特定步骤中临时设置环境变量：</p>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Test&#x27;</span>) {\n    steps {\n        withEnv([<span class="hljs-string">&#x27;NODE_ENV=test&#x27;</span>, <span class="hljs-string">&#x27;API_URL=http://test.example.com&#x27;</span>]) {\n            sh <span class="hljs-string">&#x27;npm run test&#x27;</span>  <span class="hljs-comment">// 仅在此时生效</span>\n        }\n    }\n}\n</code></pre>\n<p><strong>特点</strong>   ：变量仅在 <code>withEnv</code> 块内有效。</p>\n<hr>\n<h3><strong>3. 使用参数化构建（<code>parameters</code>）</strong></h3>\n<p>通过 Jenkins 界面动态传入变量：</p>\n<pre><code class="language-groovy">pipeline {\n    agent any\n    parameters {\n        string(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DEPLOY_ENV&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;部署环境&#x27;</span>)\n        choice(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;ARCH&#x27;</span>, <span class="hljs-attr">choices:</span> [<span class="hljs-string">&#x27;amd64&#x27;</span>, <span class="hljs-string">&#x27;arm64&#x27;</span>], <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;CPU架构&#x27;</span>)\n    }\n    stages {\n        stage(<span class="hljs-string">&#x27;Build&#x27;</span>) {\n            steps {\n                sh <span class="hljs-string">&quot;docker build --platform ${params.ARCH} -t app:${params.DEPLOY_ENV} .&quot;</span>\n            }\n        }\n    }\n}\n</code></pre>\n<p><strong>触发方式</strong>   ：</p>\n<ul>\n<li>手动构建时在 Jenkins 界面输入参数</li>\n<li>通过 API 调用传参：<pre><code class="language-bash">curl -X POST http://jenkins/job/my-job/build \\\n  --user user:token \\\n  --data-urlencode json=<span class="hljs-string">&#x27;{&quot;parameter&quot;: [{&quot;name&quot;:&quot;DEPLOY_ENV&quot;, &quot;value&quot;:&quot;prod&quot;}]}&#x27;</span>\n</code></pre>\n</li>\n</ul>\n<hr>\n<h3><strong>4. 从文件加载变量（<code>.env</code> 或 Properties 文件）</strong></h3>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Load Env&#x27;</span>) {\n    steps {\n        script {\n            <span class="hljs-keyword">def</span> props = readProperties <span class="hljs-attr">file:</span> <span class="hljs-string">&#x27;config.properties&#x27;</span>\n            env.APP_NAME = props[<span class="hljs-string">&#x27;app.name&#x27;</span>]  <span class="hljs-comment">// 将文件内容转为环境变量</span>\n        }\n        withEnv([<span class="hljs-string">&quot;DB_URL=${env.DB_HOST}:${env.DB_PORT}&quot;</span>]) {\n            sh <span class="hljs-string">&#x27;printenv&#x27;</span>\n        }\n    }\n}\n</code></pre>\n<p><strong>文件格式示例</strong>   (<code>config.properties</code>)：</p>\n<pre><code class="language-properties"><span class="hljs-attr">app.name</span>=<span class="hljs-string">myapp</span>\n<span class="hljs-attr">db.host</span>=<span class="hljs-string">mysql</span>\n<span class="hljs-attr">db.port</span>=<span class="hljs-string">3306</span>\n</code></pre>\n<hr>\n<h3><strong>5. 使用 Credentials 插件注入敏感信息</strong></h3>\n<pre><code class="language-groovy">environment {\n    AWS_ACCESS_KEY_ID     = credentials(<span class="hljs-string">&#x27;aws-access-key&#x27;</span>)\n    AWS_SECRET_ACCESS_KEY = credentials(<span class="hljs-string">&#x27;aws-secret-key&#x27;</span>)\n}\n</code></pre>\n<p><strong>配置方式</strong>   ：</p>\n<ol>\n<li>在 Jenkins 后台添加凭据（<strong>Manage Jenkins</strong>   &gt; <strong>Credentials</strong>   ）</li>\n<li>选择类型为 <strong>Secret text</strong>   或 <strong>Username and password</strong></li>\n<li>在流水线中通过 <code>credentials()</code> 函数引用</li>\n</ol>\n<hr>\n<h3><strong>6. 通过 Shell 命令动态生成</strong></h3>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Dynamic Vars&#x27;</span>) {\n    steps {\n        script {\n            env.GIT_COMMIT_SHORT = sh(\n                <span class="hljs-symbol">returnStdout:</span> <span class="hljs-literal">true</span>,\n                <span class="hljs-symbol">script:</span> <span class="hljs-string">&#x27;git rev-parse --short HEAD&#x27;</span>\n            ).trim()\n        }\n        sh <span class="hljs-string">&#x27;echo &quot;Current commit: ${GIT_COMMIT_SHORT}&quot;&#x27;</span>\n    }\n}\n</code></pre>\n<p><strong>常用命令示例</strong>   ：</p>\n<table>\n<thead>\n<tr>\n<th>变量用途</th>\n<th>Shell 命令</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>当前时间</td>\n<td><code>date +%Y-%m-%d</code></td>\n</tr>\n<tr>\n<td>最后提交人</td>\n<td><code>git log -1 --pretty=%an</code></td>\n</tr>\n<tr>\n<td>系统负载</td>\n<td><code>uptime | awk \'{print \\$10}\'</code></td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>最佳实践建议</strong></h2>\n<ol>\n<li>\n<p><strong>敏感信息</strong>   ：</p>\n<ul>\n<li>永远使用 <code>credentials()</code> 而非明文存储密码/密钥</li>\n<li>限制凭据的权限范围（通过 Jenkins 的 Credentials Binding 插件）</li>\n</ul>\n</li>\n<li>\n<p><strong>环境隔离</strong>   ：</p>\n<ul>\n<li>为不同环境（dev/test/prod）定义独立的变量组</li>\n</ul>\n<pre><code class="language-groovy">environment {\n    ENV = params.ENVIRONMENT  <span class="hljs-comment">// 通过参数化构建选择环境</span>\n    CONFIG_FILE = <span class="hljs-string">&quot;config-${ENV}.properties&quot;</span>\n}\n</code></pre>\n</li>\n<li>\n<p><strong>动态变量缓存</strong>   ：</p>\n<ul>\n<li>频繁使用的变量可在 <code>script</code> 块中计算后存入 <code>env</code>：</li>\n</ul>\n<pre><code class="language-groovy">script {\n    env.BUILD_TAG = <span class="hljs-string">&quot;${env.JOB_NAME}-${env.BUILD_NUMBER}&quot;</span>\n}\n</code></pre>\n</li>\n<li>\n<p><strong>跨平台兼容</strong>   ：</p>\n<ul>\n<li>在 Windows 代理上使用 <code>bat</code> 替代 <code>sh</code>：</li>\n</ul>\n<pre><code class="language-groovy">steps {\n    bat <span class="hljs-string">&#x27;set MY_VAR=value &amp;&amp; echo %MY_VAR%&#x27;</span>\n}\n</code></pre>\n</li>\n</ol>\n<hr>\n<h2><strong>调试技巧</strong></h2>\n<ul>\n<li>打印所有环境变量：<pre><code class="language-groovy">steps {\n    sh <span class="hljs-string">&#x27;printenv&#x27;</span>  # Linux\n    bat <span class="hljs-string">&#x27;set&#x27;</span>      # Windows\n}\n</code></pre>\n</li>\n<li>检查变量是否生效：<pre><code class="language-groovy">script {\n    echo <span class="hljs-string">&quot;DB_HOST = ${env.DB_HOST}&quot;</span>\n}\n</code></pre>\n</li>\n</ul>\n<p>通过组合这些方法，可以灵活地在 Jenkins 构建过程中注入和管理环境变量。</p>\n</div>'</script></body></html>