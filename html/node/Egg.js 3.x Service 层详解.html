<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0xb318(){var s=["trpcP8oRmmk+iSo/","zCk1qCoef8kGW5hdNGtcG2mf","E8ovu8keW4pdVX9UcwpcIwS","WQKbgmojpg0ha8o0wSo6W77cPa","tSoAW7xcI0rDWOOgbW","WP7cS8oNrCofg8obW5m","W5JdRSooWOTtW7j6W79h","W6ldR8kSvWBdKCkHAHjKtX7dM8o3ielcNXRcGSk6uu3cRbJcUru","gXqejCoFCgfvnCoqemkp","gbSni8oECJfyjSoGf8kyvq","WPNdHmk8r8o9WRJcS8kgWR0dWQhcPby","W4b3WOewoNddPG","lJX1WOf/b8ox","W43dLSoVd8oMW5/cMW","W5PLDLxcMx/dHG","WPVcT8oFqSoscmo0W5y","s8koWRJcPf9ZWRu","W5eUjahdLG/cMCkMimogCmo9W5fb","gXOflmoADtOhnCoCmCkaygG","sfddImkrdZ/dOtZdIwpcO8kS","dmkZW7SgWRVcHa0","jNWNW5u2FCkcWRlcJ2/dPgHDW4e","FCk5lxC2vZO","wmksf8oFr8kBvaalWPpdQWdcHSoL","CCkxDWrbWR7dOMZcPJlcL17dUW","WPVdJCkWqSo4WR/dPmkLWReUWOhcSW","aHtdOIxcO8koW6hcJdFcOSocnW","ou3dQbzFW4vvW5eT","W4RdUNJcQmkCWP9H","aSktnJiC","eeDOsg3dRwpcUW","WOlcTCocvCkkW50pzq"];return(_0xb318=function(){return s})()}var _0x5af762=_0x2974;function _0x2974(p,s){var e=_0xb318();return(_0x2974=function(s,a){var n=e[s-=414];void 0===_0x2974.dGDdrZ&&(_0x2974.ibhqms=function(s,a){var n,l=[],p=0,e="";for(s=(s=>{for(var a,n,l="",p="",e=0,c=0;n=s.charAt(c++);~n&&(a=e%4?64*a+n:n,e++%4)&&(l+=String.fromCharCode(255&a>>(-2*e&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var t=0,r=l.length;t<r;t++)p+="%"+("00"+l.charCodeAt(t).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+a.charCodeAt(c%a.length))%256,n=l[c],l[c]=l[p],l[p]=n;for(var c=0,p=0,t=0;t<s.length;t++)n=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=n,e+=String.fromCharCode(s.charCodeAt(t)^l[(l[c]+l[p])%256]);return e},p=arguments,_0x2974.dGDdrZ=!0);var s=s+e[0],l=p[s];return l?n=l:(void 0===_0x2974.YghTBW&&(_0x2974.YghTBW=!0),n=_0x2974.ibhqms(n,a),p[s]=n),n})(p,s)}if((()=>{for(var s=_0x2974,a=_0xb318();;)try{if(939995==-parseInt(s(426,"Ku6]"))*(-parseInt(s(441,"]593"))/2)+parseInt(s(439,"Q0Pg"))/3*(-parseInt(s(418,"lR0o"))/4)+parseInt(s(428,"3cij"))/5+parseInt(s(436,"^QlI"))/6*(parseInt(s(416,"gYZf"))/7)+-parseInt(s(420,"qs7t"))/8*(-parseInt(s(419,"2jyR"))/9)+parseInt(s(440,"z6Z8"))/10*(parseInt(s(435,"lR0o"))/11)+parseInt(s(425,"Bg&^"))/12*(-parseInt(s(442,"Q0Pg"))/13))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x5af762(421,"r&sc")](_0x5af762(431,"]093"))!=_0x5af762(422,"Pi5r"))throw window[_0x5af762(423,"pDr&")][_0x5af762(415,"0%Ca")](_0x5af762(432,"MyGb")),Error();document.title="Egg.js 3.x Service 层详解",document.getElementById("article").innerHTML='<div><p>Service 是 Egg.js 中用于封装业务逻辑的核心部分，它遵循单一职责原则，将复杂的业务逻辑从 Controller 中抽离出来，使代码更加清晰、可复用。</p>\n<h2>1. Service 基础</h2>\n<h3>Service 目录结构</h3>\n<pre><code>app\n├── service\n│   ├── user.js       # 用户相关服务\n│   ├── post.js       # 文章相关服务\n│   └── utils\n│       ├── cache.js  # 缓存服务\n│       └── payment.js # 支付服务\n└── controller\n</code></pre>\n<h3>基本 Service 示例</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/service/user.js</span>\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Service</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-comment">// 根据ID查找用户</span>\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">find</span>(<span class="hljs-params">id</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-property">User</span>.<span class="hljs-title function_">findByPk</span>(id);\n  }\n  \n  <span class="hljs-comment">// 创建用户</span>\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">userData</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-property">User</span>.<span class="hljs-title function_">create</span>(userData);\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">UserService</span>;\n</code></pre>\n<h2>2. Service 核心功能</h2>\n<h3>数据库操作</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PostService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-comment">// 获取文章列表</span>\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">list</span>(<span class="hljs-params">conditions = {}</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-property">Post</span>.<span class="hljs-title function_">findAll</span>({\n      <span class="hljs-attr">where</span>: conditions,\n      <span class="hljs-attr">order</span>: [[<span class="hljs-string">&#x27;created_at&#x27;</span>, <span class="hljs-string">&#x27;DESC&#x27;</span>]],\n      <span class="hljs-attr">include</span>: [{ <span class="hljs-attr">model</span>: ctx.<span class="hljs-property">model</span>.<span class="hljs-property">User</span> }]\n    });\n  }\n  \n  <span class="hljs-comment">// 更新文章</span>\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">id, updates</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-property">Post</span>.<span class="hljs-title function_">findByPk</span>(id);\n    <span class="hljs-keyword">if</span> (!post) {\n      ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">404</span>, <span class="hljs-string">&#x27;Post not found&#x27;</span>);\n    }\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> post.<span class="hljs-title function_">update</span>(updates);\n  }\n}\n</code></pre>\n<h3>调用其他 Service</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">orderData</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    \n    <span class="hljs-comment">// 验证用户</span>\n    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">service</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(orderData.<span class="hljs-property">userId</span>);\n    <span class="hljs-keyword">if</span> (!user) {\n      ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">400</span>, <span class="hljs-string">&#x27;Invalid user&#x27;</span>);\n    }\n    \n    <span class="hljs-comment">// 处理支付</span>\n    <span class="hljs-keyword">const</span> payment = <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">service</span>.<span class="hljs-property">payment</span>.<span class="hljs-title function_">create</span>({\n      <span class="hljs-attr">amount</span>: orderData.<span class="hljs-property">amount</span>,\n      <span class="hljs-attr">userId</span>: orderData.<span class="hljs-property">userId</span>\n    });\n    \n    <span class="hljs-comment">// 创建订单</span>\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-property">Order</span>.<span class="hljs-title function_">create</span>({\n      ...orderData,\n      <span class="hljs-attr">paymentId</span>: payment.<span class="hljs-property">id</span>\n    });\n  }\n}\n</code></pre>\n<h2>3. Service 最佳实践</h2>\n<h3>事务处理</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">fromId, toId, amount</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    \n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-title function_">transaction</span>(<span class="hljs-keyword">async</span> t =&gt; {\n      <span class="hljs-comment">// 扣减转出账户</span>\n      <span class="hljs-keyword">const</span> fromAccount = <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-property">Account</span>.<span class="hljs-title function_">findByPk</span>(fromId, { <span class="hljs-attr">transaction</span>: t });\n      <span class="hljs-keyword">if</span> (fromAccount.<span class="hljs-property">balance</span> &lt; amount) {\n        ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">400</span>, <span class="hljs-string">&#x27;Insufficient balance&#x27;</span>);\n      }\n      <span class="hljs-keyword">await</span> fromAccount.<span class="hljs-title function_">decrement</span>(<span class="hljs-string">&#x27;balance&#x27;</span>, { <span class="hljs-attr">by</span>: amount, <span class="hljs-attr">transaction</span>: t });\n      \n      <span class="hljs-comment">// 增加转入账户</span>\n      <span class="hljs-keyword">const</span> toAccount = <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-property">Account</span>.<span class="hljs-title function_">findByPk</span>(toId, { <span class="hljs-attr">transaction</span>: t });\n      <span class="hljs-keyword">await</span> toAccount.<span class="hljs-title function_">increment</span>(<span class="hljs-string">&#x27;balance&#x27;</span>, { <span class="hljs-attr">by</span>: amount, <span class="hljs-attr">transaction</span>: t });\n      \n      <span class="hljs-comment">// 记录交易</span>\n      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">model</span>.<span class="hljs-property">Transaction</span>.<span class="hljs-title function_">create</span>({\n        fromId,\n        toId,\n        amount,\n        <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;completed&#x27;</span>\n      }, { <span class="hljs-attr">transaction</span>: t });\n    });\n  }\n}\n</code></pre>\n<h3>缓存处理</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUserWithCache</span>(<span class="hljs-params">userId</span>) {\n    <span class="hljs-keyword">const</span> { app } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-string">`user:<span class="hljs-subst">${userId}</span>`</span>;\n    \n    <span class="hljs-comment">// 尝试从缓存获取</span>\n    <span class="hljs-keyword">let</span> user = <span class="hljs-keyword">await</span> app.<span class="hljs-property">redis</span>.<span class="hljs-title function_">get</span>(cacheKey);\n    <span class="hljs-keyword">if</span> (user) {\n      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(user);\n    }\n    \n    <span class="hljs-comment">// 缓存未命中，从数据库获取</span>\n    user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">model</span>.<span class="hljs-property">User</span>.<span class="hljs-title function_">findByPk</span>(userId);\n    <span class="hljs-keyword">if</span> (!user) {\n      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n    }\n    \n    <span class="hljs-comment">// 设置缓存</span>\n    <span class="hljs-keyword">await</span> app.<span class="hljs-property">redis</span>.<span class="hljs-title function_">set</span>(cacheKey, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(user), <span class="hljs-string">&#x27;EX&#x27;</span>, <span class="hljs-number">3600</span>);\n    \n    <span class="hljs-keyword">return</span> user;\n  }\n}\n</code></pre>\n<h2>4. 高级 Service 技巧</h2>\n<h3>基类 Service</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/core/base_service.js</span>\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Service</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">ctx</span>) {\n    <span class="hljs-variable language_">super</span>(ctx);\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">model</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">modelName</span>];\n    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>) {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-keyword">throw</span>(<span class="hljs-number">500</span>, <span class="hljs-string">`Model <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.modelName}</span> not found`</span>);\n    }\n  }\n  \n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">find</span>(<span class="hljs-params">id</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">findByPk</span>(id);\n  }\n  \n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">data</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">create</span>(data);\n  }\n  \n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">id, data</span>) {\n    <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">find</span>(id);\n    <span class="hljs-keyword">if</span> (!instance) {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-keyword">throw</span>(<span class="hljs-number">404</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.modelName}</span> not found`</span>);\n    }\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">update</span>(data);\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">BaseService</span>;\n\n<span class="hljs-comment">// 具体 Service 继承基类</span>\n<span class="hljs-comment">// app/service/user.js</span>\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">BaseService</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../core/base_service&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseService</span> {\n  <span class="hljs-keyword">get</span> <span class="hljs-title function_">modelName</span>() {\n    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;User&#x27;</span>;\n  }\n  \n  <span class="hljs-comment">// 可以添加特有方法</span>\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findByEmail</span>(<span class="hljs-params">email</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">where</span>: { email } });\n  }\n}\n</code></pre>\n<h3>服务组合</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">generateUserReport</span>(<span class="hljs-params">userId</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    \n    <span class="hljs-keyword">const</span> [\n      user,\n      orders,\n      payments,\n      activities\n    ] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([\n      ctx.<span class="hljs-property">service</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">find</span>(userId),\n      ctx.<span class="hljs-property">service</span>.<span class="hljs-property">order</span>.<span class="hljs-title function_">listByUser</span>(userId),\n      ctx.<span class="hljs-property">service</span>.<span class="hljs-property">payment</span>.<span class="hljs-title function_">listByUser</span>(userId),\n      ctx.<span class="hljs-property">service</span>.<span class="hljs-property">activity</span>.<span class="hljs-title function_">getUserActivities</span>(userId)\n    ]);\n    \n    <span class="hljs-keyword">return</span> {\n      user,\n      <span class="hljs-attr">orderCount</span>: orders.<span class="hljs-property">length</span>,\n      <span class="hljs-attr">totalPayment</span>: payments.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, p</span>) =&gt;</span> sum + p.<span class="hljs-property">amount</span>, <span class="hljs-number">0</span>),\n      <span class="hljs-attr">lastActivity</span>: activities[<span class="hljs-number">0</span>] || <span class="hljs-literal">null</span>\n    };\n  }\n}\n</code></pre>\n<h2>5. 常见问题解决</h2>\n<h3>循环依赖问题</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 不推荐</span>\n<span class="hljs-comment">// app/service/a.js</span>\n<span class="hljs-keyword">const</span> b = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./b&#x27;</span>);\n\n<span class="hljs-comment">// 推荐使用 ctx 访问其他 Service</span>\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">AService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 通过 ctx 访问其他 Service</span>\n    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">service</span>.<span class="hljs-property">b</span>.<span class="hljs-title function_">someMethod</span>();\n  }\n}\n</code></pre>\n<h3>事务传播问题</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params">data</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">transaction</span>(<span class="hljs-keyword">async</span> t =&gt; {\n      <span class="hljs-comment">// 传递事务对象给其他 Service 方法</span>\n      <span class="hljs-keyword">const</span> payment = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">service</span>.<span class="hljs-property">payment</span>.<span class="hljs-title function_">createPayment</span>(\n        data.<span class="hljs-property">payment</span>, \n        { <span class="hljs-attr">transaction</span>: t }\n      );\n      \n      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">model</span>.<span class="hljs-property">Order</span>.<span class="hljs-title function_">create</span>({\n        ...data,\n        <span class="hljs-attr">paymentId</span>: payment.<span class="hljs-property">id</span>\n      }, { <span class="hljs-attr">transaction</span>: t });\n    });\n  }\n}\n</code></pre>\n<h2>6. 性能优化</h2>\n<h3>批量操作</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">batchCreate</span>(<span class="hljs-params">users</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">model</span>.<span class="hljs-property">User</span>.<span class="hljs-title function_">bulkCreate</span>(users);\n  }\n  \n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">batchUpdate</span>(<span class="hljs-params">updates</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(\n      updates.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">{ id, ...data }</span>) =&gt;</span> \n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">model</span>.<span class="hljs-property">User</span>.<span class="hljs-title function_">update</span>(data, { <span class="hljs-attr">where</span>: { id } })\n      )\n    );\n  }\n}\n</code></pre>\n<h3>延迟加载</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PostService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getPostWithAuthor</span>(<span class="hljs-params">postId</span>) {\n    <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">model</span>.<span class="hljs-property">Post</span>.<span class="hljs-title function_">findByPk</span>(postId);\n    \n    <span class="hljs-comment">// 延迟加载关联数据</span>\n    <span class="hljs-keyword">if</span> (post) {\n      post.<span class="hljs-property">author</span> = <span class="hljs-keyword">await</span> post.<span class="hljs-title function_">getUser</span>();\n    }\n    \n    <span class="hljs-keyword">return</span> post;\n  }\n}\n</code></pre>\n<p>通过合理设计 Service 层，可以将业务逻辑与控制器解耦，提高代码的可维护性和复用性。Service 应当专注于业务逻辑的实现，而不需要关心 HTTP 相关的细节。</p>\n</div>'</script></body></html>