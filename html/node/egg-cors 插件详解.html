<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x3d9fa1=_0x3e89;function _0x3e89(p,s){var t=_0xba02();return(_0x3e89=function(s,n){var a=t[s-=153];void 0===_0x3e89.ykBhCk&&(_0x3e89.WnEDxv=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,c=0;a=s.charAt(c++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var r=0,e=l.length;r<e;r++)p+="%"+("00"+l.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+n.charCodeAt(c%n.length))%256,a=l[c],l[c]=l[p],l[p]=a;for(var c=0,p=0,r=0;r<s.length;r++)a=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(r)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x3e89.ykBhCk=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x3e89.sYtNBL&&(_0x3e89.sYtNBL=!0),a=_0x3e89.WnEDxv(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x3e89,n=_0xba02();;)try{if(809628==+parseInt(s(165,"EOJi"))+-parseInt(s(164,"%Cl]"))/2*(parseInt(s(159,"EOJi"))/3)+parseInt(s(161,"@40f"))/4+-parseInt(s(171,"^P*T"))/5+parseInt(s(168,"*#$g"))/6+-parseInt(s(169,"8rXR"))/7+parseInt(s(158,"Y^(S"))/8)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x3d9fa1(153,"8rXR")](_0x3d9fa1(172,"LpWW"))!=_0x3d9fa1(156,"No2X"))throw window[_0x3d9fa1(174,"#Qo&")][_0x3d9fa1(166,"EOJi")](_0x3d9fa1(170,"dJ7)")),Error();function _0xba02(){var s=["W7fuhCovW4uGEJpcN8kHW7xdLq","WRiawCklWPj7Cq","ymkqENtdPutdG8kXbSkwW73dTSo2","W5VdKGqsos/dRCk0kCkOC8ooqq","WQlcSc9qFujWW4TtqCoXe0O","D8oOArCMW5RcP8k0W64bWQf5eqldGCkJj8ozWO/dVqhcUSoGbCo4dq","FfBcTSk+pL5TnSoPqGWeuq","WRBdKmopW7tdPdBdQvzn","W7FdTchdRg3dU8oyW77dN8kFvmkYW70","WORcMSo4tmogWO/cHCkG","W73dPw0Vpr8O","x1m1msLUv1a5W7LQWQNdRa","k2hdMmkcjCk8yCo6W7ldRmo7","aSoaW5ylra","W7ldVIRcKYdcImkdW5ldHG","cSkNW7ZdTHasW4miWR8ay8oSEeS","W7zugCoqW4rDzGJcImkaW44","rIRdPCkkawu2A2TXySkuW4G","vWBcImoxyd8tB8k/E2dcGCkY","ymoFjSoCWRqUW60okSoiW7qh","q8kaWPfkcSo0WOVdM2/dLhFdUSkzWQu","W6VcSt7cOSkvW7JcRSkiWOW"];return(_0xba02=function(){return s})()}document.title="egg-cors 插件详解",document.getElementById("article").innerHTML='<div><p>egg-cors 是 Egg.js 框架中用于处理跨域资源共享(CORS)的官方插件，基于 <a href="https://github.com/koajs/cors" target="_blank">koa-cors</a> 实现，可以方便地为应用配置跨域访问支持。</p>\n<h2>安装与配置</h2>\n<h3>1. 安装插件</h3>\n<pre><code class="language-sh">npm i egg-cors --save\n</code></pre>\n<h3>2. 启用插件</h3>\n<p>在 <code>config/plugin.js</code> 中启用：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-cors&#x27;</span>\n};\n</code></pre>\n<h2>基础配置</h2>\n<p>在 <code>config/config.default.js</code> 中进行基本配置：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-attr">origin</span>: <span class="hljs-string">&#x27;*&#x27;</span>,                      <span class="hljs-comment">// 允许所有来源</span>\n  <span class="hljs-attr">allowMethods</span>: <span class="hljs-string">&#x27;GET,HEAD,PUT,POST,DELETE,PATCH&#x27;</span>, <span class="hljs-comment">// 允许的HTTP方法</span>\n  <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>                 <span class="hljs-comment">// 允许发送Cookie</span>\n};\n</code></pre>\n<h2>详细配置选项</h2>\n<h3>1. 来源控制</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-comment">// 字符串形式 - 允许单个来源</span>\n  <span class="hljs-attr">origin</span>: <span class="hljs-string">&#x27;https://example.com&#x27;</span>,\n  \n  <span class="hljs-comment">// 数组形式 - 允许多个来源</span>\n  <span class="hljs-attr">origin</span>: [<span class="hljs-string">&#x27;https://example.com&#x27;</span>, <span class="hljs-string">&#x27;https://api.example.com&#x27;</span>],\n  \n  <span class="hljs-comment">// 函数形式 - 动态判断来源</span>\n  <span class="hljs-attr">origin</span>: <span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> {\n    <span class="hljs-keyword">const</span> allowedOrigins = [<span class="hljs-string">&#x27;https://example.com&#x27;</span>, <span class="hljs-string">&#x27;https://api.example.com&#x27;</span>];\n    <span class="hljs-keyword">const</span> requestOrigin = ctx.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Origin&#x27;</span>);\n    <span class="hljs-keyword">if</span> (allowedOrigins.<span class="hljs-title function_">includes</span>(requestOrigin)) {\n      <span class="hljs-keyword">return</span> requestOrigin;\n    }\n    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 不允许的来源返回false</span>\n  }\n};\n</code></pre>\n<h3>2. 方法控制</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-comment">// 默认允许的方法</span>\n  <span class="hljs-attr">allowMethods</span>: <span class="hljs-string">&#x27;GET,HEAD,PUT,POST,DELETE,PATCH&#x27;</span>,\n  \n  <span class="hljs-comment">// 也可以使用数组形式</span>\n  <span class="hljs-attr">allowMethods</span>: [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;PUT&#x27;</span>, <span class="hljs-string">&#x27;DELETE&#x27;</span>]\n};\n</code></pre>\n<h3>3. 头信息控制</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-comment">// 允许的请求头</span>\n  <span class="hljs-attr">allowHeaders</span>: [<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;Authorization&#x27;</span>, <span class="hljs-string">&#x27;Accept&#x27;</span>],\n  \n  <span class="hljs-comment">// 暴露的响应头</span>\n  <span class="hljs-attr">exposeHeaders</span>: [<span class="hljs-string">&#x27;Content-Length&#x27;</span>, <span class="hljs-string">&#x27;X-Request-Id&#x27;</span>],\n  \n  <span class="hljs-comment">// 允许客户端访问的特殊头</span>\n  <span class="hljs-attr">accessControlExposeHeaders</span>: <span class="hljs-string">&#x27;X-Custom-Header&#x27;</span>\n};\n</code></pre>\n<h3>4. 其他配置</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-comment">// 预检请求缓存时间(秒)</span>\n  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">86400</span>, <span class="hljs-comment">// 24小时</span>\n  \n  <span class="hljs-comment">// 是否允许发送Cookie</span>\n  <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>,\n  \n  <span class="hljs-comment">// 是否将请求头字段转为小写</span>\n  <span class="hljs-attr">keepHeadersOnError</span>: <span class="hljs-literal">true</span>\n};\n</code></pre>\n<h2>动态配置示例</h2>\n<h3>1. 开发/生产环境不同配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.${env}.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-attr">origin</span>: <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n    <span class="hljs-keyword">if</span> (app.<span class="hljs-property">config</span>.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;local&#x27;</span>) {\n      <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;*&#x27;</span>; <span class="hljs-comment">// 开发环境允许所有来源</span>\n    }\n    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;https://production.example.com&#x27;</span>; <span class="hljs-comment">// 生产环境只允许特定来源</span>\n  },\n  <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>\n};\n</code></pre>\n<h3>2. 基于路由的CORS配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/cors_middleware.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">options</span> =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cors</span>(<span class="hljs-params">ctx, next</span>) {\n    <span class="hljs-keyword">const</span> path = ctx.<span class="hljs-property">path</span>;\n    \n    <span class="hljs-comment">// API路由特殊处理</span>\n    <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/api&#x27;</span>)) {\n      ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="hljs-string">&#x27;https://api.example.com&#x27;</span>);\n      ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Credentials&#x27;</span>, <span class="hljs-string">&#x27;true&#x27;</span>);\n    } \n    <span class="hljs-comment">// 其他路由</span>\n    <span class="hljs-keyword">else</span> {\n      ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>);\n    }\n    \n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  };\n};\n\n<span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">middleware</span> = [<span class="hljs-string">&#x27;corsMiddleware&#x27;</span>];\n</code></pre>\n<h2>常见问题解决方案</h2>\n<h3>1. 处理复杂跨域请求</h3>\n<p>对于需要发送Cookie或自定义头的复杂跨域请求：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-attr">origin</span>: <span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> ctx.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;origin&#x27;</span>), <span class="hljs-comment">// 动态返回请求来源</span>\n  <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>,                <span class="hljs-comment">// 允许发送Cookie</span>\n  <span class="hljs-attr">allowHeaders</span>: [<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;Authorization&#x27;</span>] <span class="hljs-comment">// 允许的自定义头</span>\n};\n</code></pre>\n<h3>2. 预检请求(OPTIONS)处理</h3>\n<p>框架已自动处理OPTIONS方法，如需自定义：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  app.<span class="hljs-property">router</span>.<span class="hljs-title function_">options</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> {\n    ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>, ctx.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Origin&#x27;</span>));\n    ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Methods&#x27;</span>, <span class="hljs-string">&#x27;GET,POST,PUT,DELETE&#x27;</span>);\n    ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Headers&#x27;</span>, <span class="hljs-string">&#x27;Content-Type&#x27;</span>);\n    ctx.<span class="hljs-property">status</span> = <span class="hljs-number">204</span>; <span class="hljs-comment">// No Content</span>\n  });\n};\n</code></pre>\n<h3>3. WebSocket跨域支持</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-comment">// 允许WebSocket连接</span>\n  <span class="hljs-attr">origin</span>: <span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> {\n    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">request</span>.<span class="hljs-property">header</span>.<span class="hljs-property">upgrade</span> === <span class="hljs-string">&#x27;websocket&#x27;</span>) {\n      <span class="hljs-keyword">return</span> ctx.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Origin&#x27;</span>);\n    }\n    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;https://example.com&#x27;</span>;\n  }\n};\n</code></pre>\n<h2>安全最佳实践</h2>\n<ol>\n<li><strong>生产环境不要使用<code>*</code>通配符</strong><br>\n始终明确指定允许的来源</li>\n<li><strong>限制允许的方法</strong><br>\n只开放必要的HTTP方法</li>\n<li><strong>合理设置maxAge</strong><br>\n预检请求缓存时间不宜过长</li>\n<li><strong>敏感接口额外保护</strong><br>\n对于敏感接口，建议：\n<ul>\n<li>增加CSRF保护</li>\n<li>实施速率限制</li>\n<li>添加请求签名验证</li>\n</ul>\n</li>\n<li><strong>结合JWT验证</strong><br>\n即使启用CORS，也应实施身份验证：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-attr">origin</span>: <span class="hljs-string">&#x27;https://example.com&#x27;</span>,\n  <span class="hljs-attr">allowHeaders</span>: [<span class="hljs-string">&#x27;Authorization&#x27;</span>] <span class="hljs-comment">// 允许JWT Token头</span>\n};\n\n<span class="hljs-comment">// 然后在控制器中验证JWT</span>\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Authorization&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;Bearer &#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>);\n  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">service</span>.<span class="hljs-property">auth</span>.<span class="hljs-title function_">verifyToken</span>(token);\n  <span class="hljs-comment">// ...</span>\n}\n</code></pre>\n<h2>性能优化建议</h2>\n<ol>\n<li><strong>合理设置maxAge</strong><br>\n对于稳定的API，可以设置较长的预检缓存时间（如24小时）</li>\n<li><strong>避免复杂origin验证逻辑</strong><br>\norigin验证函数应尽可能高效</li>\n<li><strong>使用缓存</strong><br>\n对于频繁的跨域请求，可以缓存origin验证结果</li>\n<li><strong>CDN配置</strong><br>\n如果使用CDN，确保CDN也正确传递CORS头</li>\n</ol>\n<p>egg-cors插件为Egg.js应用提供了强大而灵活的跨域支持，通过合理配置可以满足各种跨域场景需求，同时保障应用的安全性。</p>\n</div>'</script></body></html>