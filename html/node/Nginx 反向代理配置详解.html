<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5459(){var s=["WQOWFSklW7xdOMlcTCkCcmonWQy","s8okiGZcRMK5imkh","W5xcI8o6dmkRwSkGWP4","rCkpWP16oCknnCkg","WOpdLf8jWOnzkr/dICkGW5NcIq","WQvoW6JdQCkQW7npmq","WO3cOCkzaLJdKmovvCkCoSo9WRtdGW","WO16lSoYEIddG8k+W5tcJtrbW58","iJ7dQ8kUWRK2tCo3W6hcHYBdMa","nSkBmLmg","m8kYW43cJSoQAsO","W5CbzHRcLq1fdW","nshcQ2FdU8o5WO5l","nmkXomkuWOP0WOZdHSke","dXzbW6pcNSoRyfNcQLaM","W7NcNe7dG8kLW67dI8oWWPi","W5xcHmkScCk0ASkVWPOG","WPz9WQJdLSoeWQOcxa","WOFdKfKlWO9sCsVdOmkhW6hcJLC","WOL+kmoWDIVcM8kkW73cQGXg","WOL8kmoYEIhdGCkVW5xcPqD9W4S","W5qCnNTQW4hcNSoFW5PTWOZcQG","WQ/dRci/WRFdK8orW6/cTe5MW6z2W5BcU3tcU8oWf8oztCoqsd7dU8o4","iSoHWPHekSkmzCos","WOL0iSoXDsRcKmkqW5FcVbXC","W5VdTmoFEXxcHSkl","qmkjW6fueSkTd8kVBG","DCoFCbLpWOXIWPu9W7CV"];return(_0x5459=function(){return s})()}var _0x38947e=_0x47b3;function _0x47b3(e,s){var p=_0x5459();return(_0x47b3=function(s,a){var n=p[s-=207];void 0===_0x47b3.OlyatT&&(_0x47b3.wZWswm=function(s,a){var n,t=[],e=0,p="";for(s=(s=>{for(var a,n,t="",e="",p=0,l=0;n=s.charAt(l++);~n&&(a=p%4?64*a+n:n,p++%4)&&(t+=String.fromCharCode(255&a>>(-2*p&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var r=0,c=t.length;r<c;r++)e+="%"+("00"+t.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(e)})(s),l=0;l<256;l++)t[l]=l;for(l=0;l<256;l++)e=(e+t[l]+a.charCodeAt(l%a.length))%256,n=t[l],t[l]=t[e],t[e]=n;for(var l=0,e=0,r=0;r<s.length;r++)n=t[l=(l+1)%256],t[l]=t[e=(e+t[l])%256],t[e]=n,p+=String.fromCharCode(s.charCodeAt(r)^t[(t[l]+t[e])%256]);return p},e=arguments,_0x47b3.OlyatT=!0);var s=s+p[0],t=e[s];return t?n=t:(void 0===_0x47b3.TvvRyZ&&(_0x47b3.TvvRyZ=!0),n=_0x47b3.wZWswm(n,a),e[s]=n),n})(e,s)}if((()=>{for(var s=_0x47b3,a=_0x5459();;)try{if(172535==+parseInt(s(233,"1@bm"))+parseInt(s(229,"*$HX"))/2+-parseInt(s(234,"jYO7"))/3*(-parseInt(s(214,"Z!$k"))/4)+-parseInt(s(215,"]Z6K"))/5*(parseInt(s(230,"$VH5"))/6)+-parseInt(s(209,"kn46"))/7*(parseInt(s(224,"L2*c"))/8)+parseInt(s(221,"6(kr"))/9*(-parseInt(s(212,"BT9I"))/10)+parseInt(s(208,"6(kr"))/11)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x38947e(226,"2b]A")](_0x38947e(216,"taQQ"))!=_0x38947e(210,"]j3j"))throw window[_0x38947e(218,"XWSO")][_0x38947e(211,"]ua4")](_0x38947e(223,"sXeY")),Error();document.title="Nginx 反向代理配置详解",document.getElementById("article").innerHTML='<div><p>Nginx 作为反向代理是现代化 Web 架构中的核心组件，它能够高效地将客户端请求转发到后端服务器。以下是 Nginx 反向代理的详细配置指南。</p>\n<h2>基础反向代理配置</h2>\n<h3>1. 最简单的反向代理设置</h3>\n<pre><code class="language-nginx"><span class="hljs-section">server</span> {\n    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;\n    <span class="hljs-attribute">server_name</span> example.com;\n\n    <span class="hljs-section">location</span> / {\n        <span class="hljs-attribute">proxy_pass</span> http://localhost:3000;  <span class="hljs-comment"># 转发到本地的Node.js应用</span>\n        <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;\n        <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;\n\t\t<span class="hljs-comment"># 设置CORS头</span>\n\t\t<span class="hljs-attribute">proxy_set_header</span> Access-Control-Allow-Origin <span class="hljs-variable">$http_origin</span>;\n\t\t<span class="hljs-attribute">proxy_set_header</span> Access-Control-Allow-Methods <span class="hljs-string">&quot;GET, POST, OPTIONS, PUT, DELETE&quot;</span>;\n\t\t<span class="hljs-attribute">proxy_set_header</span> Access-Control-Allow-Headers <span class="hljs-string">&quot;Authorization, Content-Type&quot;</span>;\n\t\t<span class="hljs-attribute">proxy_set_header</span> Access-Control-Allow-Credentials <span class="hljs-string">&quot;true&quot;</span>;\n    }\n}\n</code></pre>\n<h3>2. 常用代理指令说明</h3>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>作用</th>\n<th>示例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>proxy_pass</code></td>\n<td>定义后端服务器地址</td>\n<td><code>proxy_pass http://backend;</code></td>\n</tr>\n<tr>\n<td><code>proxy_set_header</code></td>\n<td>修改转发给后端的请求头</td>\n<td><code>proxy_set_header Host $host;</code></td>\n</tr>\n<tr>\n<td><code>proxy_redirect</code></td>\n<td>修改后端返回的Location和Refresh头</td>\n<td><code>proxy_redirect default;</code></td>\n</tr>\n<tr>\n<td><code>proxy_buffering</code></td>\n<td>控制是否缓冲响应</td>\n<td><code>proxy_buffering on;</code></td>\n</tr>\n<tr>\n<td><code>proxy_connect_timeout</code></td>\n<td>连接后端超时时间</td>\n<td><code>proxy_connect_timeout 60s;</code></td>\n</tr>\n</tbody>\n</table>\n<h2>高级配置选项</h2>\n<h3>1. 负载均衡配置</h3>\n<pre><code class="language-nginx"><span class="hljs-section">http</span> {\n    <span class="hljs-section">upstream</span> backend {\n        <span class="hljs-attribute">server</span> backend1.example.com weight=<span class="hljs-number">5</span>;\n        <span class="hljs-attribute">server</span> backend2.example.com;\n        <span class="hljs-attribute">server</span> backup1.example.com backup;\n    }\n\n    <span class="hljs-section">server</span> {\n        <span class="hljs-section">location</span> / {\n            <span class="hljs-attribute">proxy_pass</span> http://backend;\n        }\n    }\n}\n</code></pre>\n<h3>2. WebSocket 代理</h3>\n<pre><code class="language-nginx"><span class="hljs-section">location</span> /ws/ {\n    <span class="hljs-attribute">proxy_pass</span> http://backend;\n    <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;\n    <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;\n    <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">&quot;upgrade&quot;</span>;\n    <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">86400</span>;  <span class="hljs-comment"># 保持长时间连接</span>\n}\n</code></pre>\n<h3>3. 性能优化参数</h3>\n<pre><code class="language-nginx"><span class="hljs-section">location</span> / {\n    <span class="hljs-attribute">proxy_pass</span> http://backend;\n\n    <span class="hljs-comment"># 缓冲区设置</span>\n    <span class="hljs-attribute">proxy_buffers</span> <span class="hljs-number">16</span> <span class="hljs-number">32k</span>;\n    <span class="hljs-attribute">proxy_buffer_size</span> <span class="hljs-number">64k</span>;\n\n    <span class="hljs-comment"># 超时设置</span>\n    <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">5s</span>;\n    <span class="hljs-attribute">proxy_send_timeout</span> <span class="hljs-number">10s</span>;\n    <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">30s</span>;\n\n    <span class="hljs-comment"># 启用连接池</span>\n    <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;\n    <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">&quot;&quot;</span>;\n}\n</code></pre>\n<h2>安全相关配置</h2>\n<h3>1. 基础安全设置</h3>\n<pre><code class="language-nginx"><span class="hljs-section">location</span> / {\n    <span class="hljs-attribute">proxy_pass</span> http://backend;\n\n    <span class="hljs-comment"># 隐藏后端服务器信息</span>\n    <span class="hljs-attribute">proxy_hide_header</span> X-Powered-By;\n    <span class="hljs-attribute">proxy_hide_header</span> Server;\n\n    <span class="hljs-comment"># 防止头信息被篡改</span>\n    <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;\n    <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;\n\n    <span class="hljs-comment"># 禁用代理缓存敏感内容</span>\n    <span class="hljs-attribute">proxy_cache_bypass</span> <span class="hljs-variable">$cookie_session</span> <span class="hljs-variable">$http_authorization</span>;\n}\n</code></pre>\n<h3>2. 限制访问</h3>\n<pre><code class="language-nginx"><span class="hljs-section">location</span> /admin/ {\n    <span class="hljs-attribute">proxy_pass</span> http://backend;\n\n    <span class="hljs-comment"># IP白名单</span>\n    <span class="hljs-attribute">allow</span> <span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span>;\n    <span class="hljs-attribute">allow</span> <span class="hljs-number">10.0.0.1</span>;\n    <span class="hljs-attribute">deny</span> all;\n\n    <span class="hljs-comment"># 基础认证</span>\n    <span class="hljs-attribute">auth_basic</span> <span class="hljs-string">&quot;Admin Area&quot;</span>;\n    <span class="hljs-attribute">auth_basic_user_file</span> /etc/nginx/.htpasswd;\n}\n</code></pre>\n<h2>常见场景配置示例</h2>\n<h3>1. 静态文件和动态内容分离</h3>\n<pre><code class="language-nginx"><span class="hljs-section">server</span> {\n    <span class="hljs-section">location</span> / {\n        <span class="hljs-attribute">proxy_pass</span> http://backend;\n    }\n\n    <span class="hljs-section">location</span> /static/ {\n        <span class="hljs-attribute">alias</span> /var/www/static/;\n        <span class="hljs-attribute">expires</span> <span class="hljs-number">30d</span>;\n        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;\n    }\n\n    <span class="hljs-section">location</span> <span class="hljs-regexp">~* \\.(js|css|png|jpg|jpeg|gif|ico)$</span> {\n        <span class="hljs-attribute">expires</span> <span class="hljs-number">1y</span>;\n        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;\n        <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">&quot;public&quot;</span>;\n    }\n}\n</code></pre>\n<h3>2. 多应用路由</h3>\n<pre><code class="language-nginx"><span class="hljs-section">location</span> /app1/ {\n    <span class="hljs-attribute">proxy_pass</span> http://app1_backend/;  <span class="hljs-comment"># 注意结尾的/</span>\n    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/app1/(.*)</span> /<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;\n}\n\n<span class="hljs-section">location</span> /app2/ {\n    <span class="hljs-attribute">proxy_pass</span> http://app2_backend/;\n    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/app2/(.*)</span> /<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;\n}\n</code></pre>\n<h3>3. HTTPS 反向代理</h3>\n<pre><code class="language-nginx"><span class="hljs-section">server</span> {\n    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;\n    <span class="hljs-attribute">server_name</span> example.com;\n\n    <span class="hljs-attribute">ssl_certificate</span> /path/to/cert.pem;\n    <span class="hljs-attribute">ssl_certificate_key</span> /path/to/key.pem;\n\n    <span class="hljs-section">location</span> / {\n        <span class="hljs-attribute">proxy_pass</span> http://backend;\n        <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;\n        <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;\n        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;\n    }\n}\n</code></pre>\n<h2>调试与问题排查</h2>\n<ol>\n<li><strong>日志记录</strong>   ：<pre><code class="language-nginx"><span class="hljs-section">location</span> / {\n    <span class="hljs-attribute">proxy_pass</span> http://backend;\n    <span class="hljs-attribute">access_log</span> /var/log/nginx/proxy.access.log;\n    <span class="hljs-attribute">error_log</span> /var/log/nginx/proxy.<span class="hljs-literal">error</span>.log;\n}\n</code></pre>\n</li>\n<li><strong>查看传递的头信息</strong>   ：\n在后端应用中检查 <code>X-Forwarded-For</code> 和 <code>X-Real-IP</code> 头</li>\n<li><strong>常见问题</strong>   ：\n<ul>\n<li>502 Bad Gateway：后端服务未运行或连接超时</li>\n<li>504 Gateway Timeout：后端响应时间过长</li>\n<li>代理后URL错误：检查 <code>proxy_pass</code> 结尾是否有 <code>/</code></li>\n</ul>\n</li>\n</ol>\n<h2>最佳实践</h2>\n<ol>\n<li>始终设置 <code>Host</code> 和 <code>X-Real-IP</code> 头</li>\n<li>为长时间操作调整超时设置</li>\n<li>对敏感路径实施访问控制</li>\n<li>使用 <code>upstream</code> 模块实现负载均衡</li>\n<li>为生产环境启用HTTPS</li>\n<li>定期检查Nginx错误日志</li>\n</ol>\n<p>通过合理配置Nginx反向代理，可以显著提高Web应用的安全性、性能和可靠性。</p>\n</div>'</script></body></html>