<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x4e4d(l,s){var t=_0x81fb();return(_0x4e4d=function(s,n){var a=t[s-=439];void 0===_0x4e4d.VDLmNX&&(_0x4e4d.dUSyYW=function(s,n){var a,p=[],l=0,t="";for(s=(s=>{for(var n,a,p="",l="",t=0,c=0;a=s.charAt(c++);~a&&(n=t%4?64*n+a:a,t++%4)&&(p+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,r=p.length;e<r;e++)l+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)p[c]=c;for(c=0;c<256;c++)l=(l+p[c]+n.charCodeAt(c%n.length))%256,a=p[c],p[c]=p[l],p[l]=a;for(var c=0,l=0,e=0;e<s.length;e++)a=p[c=(c+1)%256],p[c]=p[l=(l+p[c])%256],p[l]=a,t+=String.fromCharCode(s.charCodeAt(e)^p[(p[c]+p[l])%256]);return t},l=arguments,_0x4e4d.VDLmNX=!0);var s=s+t[0],p=l[s];return p?a=p:(void 0===_0x4e4d.kVgmsx&&(_0x4e4d.kVgmsx=!0),a=_0x4e4d.dUSyYW(a,n),l[s]=a),a})(l,s)}function _0x81fb(){var s=["kXZcNX4FyGJcQmkMW7Weoqa","W5RcQe4cW4hcJ8otWPfF","W47cLmothmkOW7m8W4FdO8o8WRNdJCoh","t8kCxmk4W4JdV3RdVh3cGX8kW4O","mmkrW5KuhCkWW5RcLYldR8k+W4qv","W4VdHaNdS1tcNeWq","g3iujKDkW4u","WQCUWQThAKGnhW","jmkDe8kcv8knWRpdPYS","jCkMcCokjmkpeh4","ESohq8k1AmkkWPFdMG","W7DHW585s8o/W5xdGCkcW4/dNfpdPq","k2jnzaDIW67dI8kbW7W","W5JcTxFdVdmHzSoAWQi","WO9DW5VcHf8","pCkZW7RdUmorEZO","lr/cMHmEzaRcRSkBW64ecZu","W50uWQ7dOK1Wcmk+WRpdO2JdKmoi","WQjZWRb/xxGS","bYZcQM/dH8oiDxeGWP4","aNZdUKiUWPpdGt8DDSkHWPZdJCkkWO4yyCkqW6hdIG1idvWLWPC","s3iZfxvwW5K","mCkvW58zgSk6W57cTsJdGCknW7KA","WRDKxGFdP8kAtGVdTSkYxI7cTa","imkAhmolW40WucxcJ8oNEMqB","WR51WQ1yW7CbcuFcJsHPW4D0","WQ/dUXruWOVdHCkTWObUfCouWQzG","BmoJfmkNWRD1W6hdMq"];return(_0x81fb=function(){return s})()}var _0x2d3952=_0x4e4d;if((()=>{for(var s=_0x4e4d,n=_0x81fb();;)try{if(889351==-parseInt(s(458,"J0(Y"))*(parseInt(s(446,"%^Tu"))/2)+parseInt(s(456,"rCWQ"))/3+-parseInt(s(441,"8R(F"))/4+parseInt(s(448,"1wkf"))/5*(parseInt(s(442,"270q"))/6)+-parseInt(s(460,"9UZq"))/7*(-parseInt(s(461,"Xuil"))/8)+parseInt(s(455,"BMjt"))/9+-parseInt(s(439,"BMjt"))/10*(parseInt(s(447,"I6P6"))/11))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x2d3952(445,"9UZq")](_0x2d3952(440,"yx9X"))!=_0x2d3952(453,"(tHE"))throw window[_0x2d3952(449,"I6P6")][_0x2d3952(454,"iMm8")](_0x2d3952(459,"(&RE")),Error();document.title="Egg.js 3.x 插件系统详解",document.getElementById("article").innerHTML='<div><p>Egg.js 的插件系统是其核心功能之一，允许开发者通过插件机制扩展框架功能，实现模块化开发和功能复用。</p>\n<h2>1. 插件基础</h2>\n<h3>插件目录结构</h3>\n<pre><code>egg-plugin-name          # 插件包\n├── package.json         # 插件描述文件\n├── app.js               # 插件应用入口\n├── agent.js             # agent 入口\n├── app                  # 插件应用目录\n│   ├── extend           # 扩展目录\n│   │   ├── helper.js    # 扩展 helper\n│   │   ├── context.js   # 扩展 ctx\n│   │   └── application.js # 扩展 app\n│   ├── service         # 插件 service\n│   └── middleware      # 插件 middleware\n└── config               # 插件配置目录\n    ├── config.default.js\n    └── config.local.js\n</code></pre>\n<h3>插件配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/plugin.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">pluginName</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,          <span class="hljs-comment">// 是否启用</span>\n  <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-plugin-name&#x27;</span>, <span class="hljs-comment">// 插件包名</span>\n  <span class="hljs-attr">env</span>: [<span class="hljs-string">&#x27;local&#x27;</span>, <span class="hljs-string">&#x27;prod&#x27;</span>], <span class="hljs-comment">// 指定环境启用</span>\n  <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;../lib/plugin/plugin-name&#x27;</span>), <span class="hljs-comment">// 指定插件路径</span>\n};\n</code></pre>\n<h2>2. 插件开发</h2>\n<h3>基础插件示例</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  <span class="hljs-comment">// 启动前执行</span>\n  app.<span class="hljs-title function_">beforeStart</span>(<span class="hljs-title function_">async</span> () =&gt; {\n    <span class="hljs-keyword">await</span> app.<span class="hljs-property">pluginReady</span>;\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;Plugin loaded!&#x27;</span>);\n  });\n  \n  <span class="hljs-comment">// 添加全局方法</span>\n  app.<span class="hljs-property">pluginMethod</span> = <span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Hello from plugin&#x27;</span>;\n  };\n  \n  <span class="hljs-comment">// 添加中间件</span>\n  app.<span class="hljs-property">coreMiddleware</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;pluginMiddleware&#x27;</span>);\n};\n</code></pre>\n<h3>插件配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/config/config.default.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">appInfo</span> =&gt;</span> {\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">pluginConfig</span>: {\n      <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;value&#x27;</span>,\n      <span class="hljs-comment">// 根据应用信息动态配置</span>\n      <span class="hljs-attr">logPath</span>: path.<span class="hljs-title function_">join</span>(appInfo.<span class="hljs-property">root</span>, <span class="hljs-string">&#x27;logs&#x27;</span>, <span class="hljs-string">&#x27;plugin.log&#x27;</span>),\n    },\n  };\n};\n</code></pre>\n<h2>3. 插件功能扩展</h2>\n<h3>扩展 Context</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app/extend/context.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-keyword">get</span> <span class="hljs-title function_">pluginProp</span>() {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;x-plugin-data&#x27;</span>);\n  },\n  \n  <span class="hljs-keyword">set</span> <span class="hljs-title function_">pluginProp</span>(<span class="hljs-params">val</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;x-plugin-data&#x27;</span>, val);\n  },\n  \n  <span class="hljs-title function_">pluginMethod</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;from plugin context&#x27;</span>;\n  },\n};\n</code></pre>\n<h3>扩展 Application</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app/extend/application.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-keyword">get</span> <span class="hljs-title function_">pluginAppProp</span>() {\n    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;app extended prop&#x27;</span>;\n  },\n  \n  <span class="hljs-title function_">pluginAppMethod</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;from plugin application&#x27;</span>;\n  },\n};\n</code></pre>\n<h3>扩展 Helper</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app/extend/helper.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-title function_">pluginHelperFormat</span>(<span class="hljs-params">str</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-string">`[<span class="hljs-subst">${str}</span>]`</span>;\n  },\n};\n</code></pre>\n<h2>4. 插件中间件</h2>\n<h3>插件中间件开发</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app/middleware/plugin_middleware.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n    ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;x-plugin-start&#x27;</span>, start);\n    \n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n    \n    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Plugin middleware duration: <span class="hljs-subst">${duration}</span>ms`</span>);\n  };\n};\n</code></pre>\n<h3>中间件配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/config/config.default.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">middleware</span>: [<span class="hljs-string">&#x27;pluginMiddleware&#x27;</span>],\n  \n  <span class="hljs-attr">pluginMiddleware</span>: {\n    <span class="hljs-attr">ignore</span>: [<span class="hljs-string">&#x27;/api/ignore&#x27;</span>],\n  },\n};\n</code></pre>\n<h2>5. 插件 Service</h2>\n<h3>插件 Service 开发</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app/service/plugin.js</span>\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Service</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">const</span> { app } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> app.<span class="hljs-property">redis</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;plugin:data&#x27;</span>);\n  }\n  \n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setData</span>(<span class="hljs-params">value</span>) {\n    <span class="hljs-keyword">const</span> { app } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">await</span> app.<span class="hljs-property">redis</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;plugin:data&#x27;</span>, value);\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">PluginService</span>;\n</code></pre>\n<h3>Service 使用</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在应用中使用插件 Service</span>\n<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">service</span>.<span class="hljs-property">plugin</span>.<span class="hljs-title function_">getData</span>();\n</code></pre>\n<h2>6. 插件订阅</h2>\n<h3>事件订阅</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  <span class="hljs-comment">// 订阅应用事件</span>\n  app.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;server&#x27;</span>, <span class="hljs-function"><span class="hljs-params">server</span> =&gt;</span> {\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;Server started&#x27;</span>, server);\n  });\n  \n  app.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, ctx</span>) =&gt;</span> {\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Plugin caught error&#x27;</span>, err, ctx);\n  });\n  \n  <span class="hljs-comment">// 自定义事件</span>\n  app.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;customEvent&#x27;</span>, <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;Custom event triggered&#x27;</span>, data);\n  });\n};\n</code></pre>\n<h2>7. 插件最佳实践</h2>\n<h3>配置分离</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/config/config.default.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 默认配置</span>\n  <span class="hljs-attr">plugin</span>: {\n    <span class="hljs-attr">api</span>: <span class="hljs-string">&#x27;https://api.plugin.com&#x27;</span>,\n    <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,\n  },\n};\n\n<span class="hljs-comment">// plugin/config/config.prod.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">plugin</span>: {\n    <span class="hljs-attr">api</span>: <span class="hljs-string">&#x27;https://api.plugin.prod.com&#x27;</span>,\n  },\n};\n</code></pre>\n<h3>多环境支持</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  <span class="hljs-comment">// 只在特定环境启用功能</span>\n  <span class="hljs-keyword">if</span> (app.<span class="hljs-property">config</span>.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;local&#x27;</span>) {\n    app.<span class="hljs-property">developmentTool</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./lib/dev-tool&#x27;</span>);\n  }\n};\n</code></pre>\n<h3>依赖管理</h3>\n<pre><code class="language-json"><span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;egg-plugin-name&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;eggPlugin&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pluginName&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;pluginA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;pluginB&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;optionalDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;pluginC&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;env&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;local&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;prod&quot;</span><span class="hljs-punctuation">]</span>\n  <span class="hljs-punctuation">}</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n<h2>8. 插件调试</h2>\n<h3>本地开发调试</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/plugin.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">pluginName</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;../path/to/plugin&#x27;</span>),\n};\n</code></pre>\n<h3>单元测试</h3>\n<pre><code class="language-javascript"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;plugin test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">let</span> app;\n  <span class="hljs-title function_">before</span>(<span class="hljs-function">() =&gt;</span> {\n    app = mock.<span class="hljs-title function_">app</span>({\n      <span class="hljs-attr">baseDir</span>: <span class="hljs-string">&#x27;apps/plugin-test&#x27;</span>,\n      <span class="hljs-attr">plugin</span>: <span class="hljs-string">&#x27;pluginName&#x27;</span>,\n    });\n    <span class="hljs-keyword">return</span> app.<span class="hljs-title function_">ready</span>();\n  });\n  \n  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;should work&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">return</span> app.<span class="hljs-title function_">httpRequest</span>()\n      .<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>)\n      .<span class="hljs-title function_">expect</span>(<span class="hljs-number">200</span>);\n  });\n});\n</code></pre>\n<h2>9. 常见问题解决</h2>\n<h3>插件加载顺序问题</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// package.json</span>\n{\n  <span class="hljs-string">&quot;eggPlugin&quot;</span>: {\n    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;pluginA&quot;</span>,\n    <span class="hljs-string">&quot;dependsOn&quot;</span>: [<span class="hljs-string">&quot;pluginB&quot;</span>] <span class="hljs-comment">// 确保 pluginB 先加载</span>\n  }\n}\n</code></pre>\n<h3>插件冲突处理</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/plugin.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">pluginA</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 禁用冲突插件</span>\n};\n</code></pre>\n<h3>插件性能监控</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// plugin/app.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  app.<span class="hljs-title function_">beforeStart</span>(<span class="hljs-function">() =&gt;</span> {\n    app.<span class="hljs-property">monitor</span>.<span class="hljs-title function_">timing</span>(<span class="hljs-string">&#x27;plugin.init&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-comment">// 初始化逻辑</span>\n    });\n  });\n};\n</code></pre>\n<p>通过合理设计和开发 Egg.js 插件，可以实现功能模块化，提高代码复用性，同时保持应用的简洁和可维护性。插件系统是 Egg.js 生态强大的关键所在。</p>\n</div>'</script></body></html>