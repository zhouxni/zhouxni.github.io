<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x2cd4(){var n=["WQHxzWrPW5VcT8oM","z8osWOaPW5KWW77cUmoazaO","qHdcHbhdP8oxWPLCjmkWW4BdLW","qwNcJ2BcSmkxoCojcmoElmkjW6jYz8kZW418fCo+rrWoW4uyWPm","W63dGt3cM8kCWQVcNW","W6C1zmobWPfvjXFdHG","WP/dO3qxWPy2WQVcOexdHSkiW7i","W44mW5hcHSktj2BdTJ92W7GcWONdVW","BSorW4GBWPVdMtvgqtKnW47cQa","W65MbSoLECk7yq","W4hdUmoUoGuMicShcgFdOHS","WOmKC8o1zCk4WRLDfLNcQYmjhq","w8kfWPBcUCodW6r2BM/dTunuBa","WO1BWPFdN8obDZu","a8oLvf82W7ddRG","WRGWrSkvp8oSpCouWORcHCkvW63cS8o/","W7HFt8kSdmoBWQhcPv0","s8oVvYOrDCktymonomoG","W6Swa8o/r1PlW6S","zG1MumoLba3dGrS","W4FcOmk+z3f9ya","t8oKaCkOfCoIW4tcLG","ySoCWO0TW5HJWRlcP8oECXbriW","W57cPtfDW5G","yCovWO0SW55GWRZcRSoasHfXfG","W7RcPmoTkKldOCowFW","qHdcHHhdOSovW70Oo8keW7/dGx1a","ySoqW4DrWOGKW73cLG","ASkxW4PKlmo1ha","gctdGIhdTCkCi8kRimoFl8knW6G"];return(_0x2cd4=function(){return n})()}var _0x5f2b44=_0x1db0;function _0x1db0(l,n){var e=_0x2cd4();return(_0x1db0=function(n,s){var a=e[n-=192];void 0===_0x1db0.VMZOQw&&(_0x1db0.ZLdJvi=function(n,s){var a,t=[],l=0,e="";for(n=(n=>{for(var s,a,t="",l="",e=0,c=0;a=n.charAt(c++);~a&&(s=e%4?64*s+a:a,e++%4)&&(t+=String.fromCharCode(255&s>>(-2*e&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,r=t.length;o<r;o++)l+="%"+("00"+t.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(l)})(n),c=0;c<256;c++)t[c]=c;for(c=0;c<256;c++)l=(l+t[c]+s.charCodeAt(c%s.length))%256,a=t[c],t[c]=t[l],t[l]=a;for(var c=0,l=0,o=0;o<n.length;o++)a=t[c=(c+1)%256],t[c]=t[l=(l+t[c])%256],t[l]=a,e+=String.fromCharCode(n.charCodeAt(o)^t[(t[c]+t[l])%256]);return e},l=arguments,_0x1db0.VMZOQw=!0);var n=n+e[0],t=l[n];return t?a=t:(void 0===_0x1db0.GZjAZA&&(_0x1db0.GZjAZA=!0),a=_0x1db0.ZLdJvi(a,s),l[n]=a),a})(l,n)}if((()=>{for(var n=_0x1db0,s=_0x2cd4();;)try{if(861222==+parseInt(n(207,"@2Y#"))+-parseInt(n(198,"gA@g"))/2*(-parseInt(n(197,"o9JV"))/3)+-parseInt(n(205,"8PqP"))/4+-parseInt(n(209,"B7^h"))/5*(parseInt(n(195,"5(Qo"))/6)+parseInt(n(211,"c#Gj"))/7*(-parseInt(n(212,"(Kl]"))/8)+-parseInt(n(213,")y)X"))/9*(parseInt(n(203,"7Cgq"))/10)+-parseInt(n(208,"#WSi"))/11*(-parseInt(n(194,"gA@g"))/12))break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x5f2b44(206,"(Kl]")](_0x5f2b44(216,"[gev"))!=_0x5f2b44(220,"7Cgq"))throw window[_0x5f2b44(215,"4qN1")][_0x5f2b44(210,"[!6]")](_0x5f2b44(200,"dUwy")),Error();document.title="Redis SET lockKey 1 NX EX 5 参数详解",document.getElementById("article").innerHTML='<div><p>这个命令是 Redis 实现分布式锁的核心命令，下面我将详细解析每个参数的含义和作用：</p>\n<h2>命令结构</h2>\n<pre><code class="language-sh">SET key value [NX|XX] [EX seconds|PX milliseconds|EXAT timestamp|PXAT milliseconds-timestamp|KEEPTTL]\n</code></pre>\n<h2>参数详解</h2>\n<h3>1. <code>lockKey</code></h3>\n<ul>\n<li><strong>作用</strong>  ：锁的唯一标识符</li>\n<li><strong>命名建议</strong>  ：\n<ul>\n<li>业务前缀 + 资源标识：<code>order_lock:123</code></li>\n<li>包含客户端信息：<code>lock:payment:client1:order456</code></li>\n</ul>\n</li>\n<li><strong>示例</strong>  ：<pre><code class="language-javascript"><span class="hljs-keyword">const</span> lockKey = <span class="hljs-string">`user:<span class="hljs-subst">${userId}</span>:profile_lock`</span>;\n</code></pre>\n</li>\n</ul>\n<h3>2. <code>1</code></h3>\n<ul>\n<li><strong>作用</strong>  ：锁的值</li>\n<li><strong>最佳实践</strong>  ：\n<ul>\n<li>简单场景：可以设为固定值 <code>1</code></li>\n<li>生产环境：建议使用唯一标识（防止误删）<pre><code class="language-javascript"><span class="hljs-keyword">const</span> token = <span class="hljs-title function_">uuidv4</span>(); <span class="hljs-comment">// 或 `${process.pid}:${Date.now()}`</span>\n<span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">set</span>(lockKey, token, <span class="hljs-string">&#x27;NX&#x27;</span>, <span class="hljs-string">&#x27;EX&#x27;</span>, <span class="hljs-number">5</span>);\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<h3>3. <code>NX</code></h3>\n<ul>\n<li><strong>全称</strong>  ：If Not eXists</li>\n<li><strong>作用</strong>  ：仅当 key 不存在时才设置</li>\n<li><strong>锁获取逻辑</strong>  ：\n<ul>\n<li>返回 <code>OK</code>：获取锁成功</li>\n<li>返回 <code>null</code>：锁已被占用</li>\n</ul>\n</li>\n<li><strong>对比</strong>  ：\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>含义</th>\n<th>适用场景</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NX</td>\n<td>不存在时设置</td>\n<td>分布式锁实现</td>\n</tr>\n<tr>\n<td>XX</td>\n<td>存在时设置</td>\n<td>锁续期/值更新</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ul>\n<h3>4. <code>EX 5</code></h3>\n<ul>\n<li><strong>全称</strong>  ：EXpire time in Seconds</li>\n<li><strong>作用</strong>  ：设置 key 的过期时间（单位：秒）</li>\n<li><strong>关键点</strong>  ：\n<ul>\n<li>必须设置：防止客户端崩溃导致死锁</li>\n<li>时间选择：\n<ul>\n<li>太短：业务未完成锁已过期</li>\n<li>太长：系统故障时恢复慢</li>\n</ul>\n</li>\n<li>建议值：业务平均耗时的 2-3 倍</li>\n</ul>\n</li>\n<li><strong>其他时间选项</strong>  ：\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>单位</th>\n<th>示例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EX</td>\n<td>秒</td>\n<td>EX 5 (5秒)</td>\n</tr>\n<tr>\n<td>PX</td>\n<td>毫秒</td>\n<td>PX 5000 (5秒)</td>\n</tr>\n<tr>\n<td>EXAT</td>\n<td>秒级时间戳</td>\n<td>EXAT 1650000000</td>\n</tr>\n<tr>\n<td>PXAT</td>\n<td>毫秒级时间戳</td>\n<td>PXAT 1650000000000</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ul>\n<h2>完整工作流程</h2>\n<h3>获取锁</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// Egg.js 示例</span>\n<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> app.<span class="hljs-property">redis</span>.<span class="hljs-title function_">set</span>(\n  <span class="hljs-string">&#x27;user:123:lock&#x27;</span>, \n  <span class="hljs-string">&#x27;client1_12345&#x27;</span>,\n  <span class="hljs-string">&#x27;NX&#x27;</span>,\n  <span class="hljs-string">&#x27;EX&#x27;</span>, \n  <span class="hljs-number">10</span> <span class="hljs-comment">// 10秒过期</span>\n);\n\n<span class="hljs-keyword">if</span> (result === <span class="hljs-string">&#x27;OK&#x27;</span>) {\n  <span class="hljs-comment">// 获取锁成功</span>\n} <span class="hljs-keyword">else</span> {\n  <span class="hljs-comment">// 获取锁失败</span>\n}\n</code></pre>\n<h3>释放锁（安全方式）</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> script = <span class="hljs-string">`\nif redis.call(&quot;get&quot;, KEYS[1]) == ARGV[1] then\n    return redis.call(&quot;del&quot;, KEYS[1])\nelse\n    return 0\nend\n`</span>;\n<span class="hljs-keyword">await</span> app.<span class="hljs-property">redis</span>.<span class="hljs-built_in">eval</span>(script, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;user:123:lock&#x27;</span>, <span class="hljs-string">&#x27;client1_12345&#x27;</span>);\n</code></pre>\n<h2>参数组合示例</h2>\n<table>\n<thead>\n<tr>\n<th>场景</th>\n<th>命令示例</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>基础锁</td>\n<td><code>SET lockKey 1 NX EX 30</code></td>\n<td>30秒自动过期</td>\n</tr>\n<tr>\n<td>毫秒级精度</td>\n<td><code>SET lockKey 1 NX PX 30000</code></td>\n<td>30000毫秒(30秒)过期</td>\n</tr>\n<tr>\n<td>带唯一标识</td>\n<td><code>SET lockKey uuid123 NX EX 5</code></td>\n<td>值使用UUID</td>\n</tr>\n<tr>\n<td>检查存在时更新</td>\n<td><code>SET lockKey 1 XX EX 10</code></td>\n<td>仅当锁存在时更新</td>\n</tr>\n<tr>\n<td>保持现有TTL</td>\n<td><code>SET lockKey newValue KEEPTTL</code></td>\n<td>保留原有过期时间</td>\n</tr>\n</tbody>\n</table>\n<h2>生产环境注意事项</h2>\n<ol>\n<li><strong>过期时间动态计算</strong>  ：<pre><code class="language-javascript"><span class="hljs-keyword">const</span> avgTime = <span class="hljs-number">200</span>; <span class="hljs-comment">// 业务平均耗时ms</span>\n<span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">set</span>(lockKey, token, <span class="hljs-string">&#x27;NX&#x27;</span>, <span class="hljs-string">&#x27;PX&#x27;</span>, avgTime * <span class="hljs-number">3</span>);\n</code></pre>\n</li>\n<li><strong>锁续期机制</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// 获取锁后启动续期定时器</span>\n<span class="hljs-keyword">const</span> renewalInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {\n  redis.<span class="hljs-title function_">expire</span>(lockKey, <span class="hljs-number">10</span>);\n}, <span class="hljs-number">8000</span>); <span class="hljs-comment">// 8秒续期一次(小于10秒过期)</span>\n</code></pre>\n</li>\n<li><strong>锁等待实现</strong>  ：<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">waitLock</span>(<span class="hljs-params">key, timeout = <span class="hljs-number">3000</span></span>) {\n  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n  <span class="hljs-keyword">while</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start &lt; timeout) {\n    <span class="hljs-keyword">const</span> acquired = <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">set</span>(key, token, <span class="hljs-string">&#x27;NX&#x27;</span>, <span class="hljs-string">&#x27;EX&#x27;</span>, <span class="hljs-number">10</span>);\n    <span class="hljs-keyword">if</span> (acquired) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">100</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">50</span>); <span class="hljs-comment">// 随机等待</span>\n  }\n  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;\n}\n</code></pre>\n</li>\n<li><strong>监控指标</strong>  ：\n<ul>\n<li>锁获取成功率</li>\n<li>锁等待时间</li>\n<li>锁持有时间</li>\n</ul>\n</li>\n</ol>\n<p>通过合理配置这些参数，可以构建出安全可靠的 Redis 分布式锁解决方案。记住要根据实际业务场景调整过期时间和重试策略。</p>\n</div>'</script></body></html>