<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x2f618c=_0x5de3;function _0x2aba(){var s=["hL/dPdVcL38bW6q","W5NdNqmJlI7cJWFdVa","DIXix13dHM3cICoJgvW1WRu","qL5WrmkWWR4d","ACk3w3DqW4TuW7tdNx7dLW","AcRcPH3cGSoguq","W7dcOSkSh8oVySktWRnXjsnh","WR91AXD6ymofdwXkzG","xmkJW4JcNCo9k8onWQCMW63dVf0W","rCkEpchcN8kOWQOu","W7hdKeWpW5HVvuqP","W7JcTqxcGmkSW6uUW43dNG","qCkBWQLOndNcNfaPtmo1dSk9","W5VdSgPwtw3dKSoPvh7dP8oflG","ASk5vN5rWO89W77dUeldRmodCG","WO3dRXDyjdP4","tvRdQCoSW7ldR8o4Eq4iW7VcGSkNymoiWPxdL8osw8kJWOSdW4GXWObx","pxXuWRJdSLLqWOiPlX/dMhu","eL4ia8oUW77cG8o2WQnuz8oLWOK","uSo+WRxdJvG/AHCWm8oXW47cKW","W7VdO8kwtWhdKabWs8oDamoO","WQ4Ft3uPE0GI","WRzOW5pcKmoxW4dcPG","W4ldTaiismo5WRzDuSobAmkF","emk7W7hcIra","uraflthcSeJcHmk3C8ktW6O"];return(_0x2aba=function(){return s})()}function _0x5de3(p,s){var c=_0x2aba();return(_0x5de3=function(s,a){var n=c[s-=379];void 0===_0x5de3.PKJRMA&&(_0x5de3.ifqVLQ=function(s,a){var n,l=[],p=0,c="";for(s=(s=>{for(var a,n,l="",p="",c=0,r=0;n=s.charAt(r++);~n&&(a=c%4?64*a+n:n,c++%4)&&(l+=String.fromCharCode(255&a>>(-2*c&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,t=l.length;e<t;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),r=0;r<256;r++)l[r]=r;for(r=0;r<256;r++)p=(p+l[r]+a.charCodeAt(r%a.length))%256,n=l[r],l[r]=l[p],l[p]=n;for(var r=0,p=0,e=0;e<s.length;e++)n=l[r=(r+1)%256],l[r]=l[p=(p+l[r])%256],l[p]=n,c+=String.fromCharCode(s.charCodeAt(e)^l[(l[r]+l[p])%256]);return c},p=arguments,_0x5de3.PKJRMA=!0);var s=s+c[0],l=p[s];return l?n=l:(void 0===_0x5de3.AIqnvy&&(_0x5de3.AIqnvy=!0),n=_0x5de3.ifqVLQ(n,a),p[s]=n),n})(p,s)}if((()=>{for(var s=_0x5de3,a=_0x2aba();;)try{if(590644==+parseInt(s(394,"fwOK"))+-parseInt(s(397,"js6("))/2*(-parseInt(s(391,"oYki"))/3)+-parseInt(s(388,"P*@D"))/4+parseInt(s(401,"fNi0"))/5*(parseInt(s(398,"1iXN"))/6)+-parseInt(s(383,"v)J%"))/7+parseInt(s(385,"fNi0"))/8*(-parseInt(s(400,"*]K["))/9)+-parseInt(s(379,"x1[o"))/10)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x2f618c(402,"YBw0")](_0x2f618c(382,"3TnP"))!=_0x2f618c(395,"enZr"))throw window[_0x2f618c(392,"JB*x")][_0x2f618c(393,"wrTf")](_0x2f618c(387,"$9(h")),Error();document.title="Egg.js 3.x 配置 egg-circuit-breaker 插件",document.getElementById("article").innerHTML='<div><p>在 <strong>Egg.js 3.x</strong>   中配置 <code>egg-circuit-breaker</code> 插件，需要确保插件兼容性，并正确设置熔断策略。以下是详细配置指南：</p>\n<hr>\n<h3><strong>1. 安装插件</strong></h3>\n<p>确保使用支持 Egg.js 3.x 的版本（如 <code>egg-circuit-breaker@2.x</code>）：</p>\n<pre><code class="language-sh">npm install egg-circuit-breaker --save\n<span class="hljs-comment"># 或</span>\nyarn add egg-circuit-breaker\n</code></pre>\n<hr>\n<h3><strong>2. 启用插件</strong></h3>\n<p>在 <code>config/plugin.js</code> 中声明插件：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">circuitBreaker</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用插件</span>\n  <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-circuit-breaker&#x27;</span>, <span class="hljs-comment">// 插件包名</span>\n};\n</code></pre>\n<hr>\n<h3><strong>3. 基础配置（config/config.default.js）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">circuitBreaker</span> = {\n  <span class="hljs-comment">// 全局默认配置</span>\n  <span class="hljs-attr">default</span>: {\n    <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>, <span class="hljs-comment">// 请求超时时间（毫秒）</span>\n    <span class="hljs-attr">maxFailures</span>: <span class="hljs-number">3</span>, <span class="hljs-comment">// 连续失败次数触发熔断</span>\n    <span class="hljs-attr">resetTimeout</span>: <span class="hljs-number">30000</span>, <span class="hljs-comment">// 熔断后恢复时间（毫秒）</span>\n    <span class="hljs-attr">fallback</span>: <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> ({ <span class="hljs-comment">// 熔断时的降级数据</span>\n      <span class="hljs-attr">code</span>: <span class="hljs-number">503</span>,\n      <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;服务暂时不可用，请稍后重试&#x27;</span>,\n    }),\n  },\n  <span class="hljs-comment">// 针对特定服务的自定义配置</span>\n  <span class="hljs-attr">clients</span>: {\n    <span class="hljs-attr">userService</span>: {\n      <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,\n      <span class="hljs-attr">maxFailures</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 用户服务更敏感，快速熔断</span>\n    },\n    <span class="hljs-attr">paymentService</span>: {\n      <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>, <span class="hljs-comment">// 支付服务允许更长超时</span>\n      <span class="hljs-attr">resetTimeout</span>: <span class="hljs-number">60000</span>, <span class="hljs-comment">// 熔断后1分钟恢复</span>\n    },\n  },\n};\n</code></pre>\n<hr>\n<h3><strong>4. 在 Service/Controller 中使用</strong></h3>\n<h4><strong>方式1：通过 <code>ctx.breaker</code> 调用</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/service/user.js</span>\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">breaker</span>.<span class="hljs-title function_">call</span>(\n      <span class="hljs-string">&#x27;userService&#x27;</span>, <span class="hljs-comment">// 使用 clients 中定义的配置</span>\n      <span class="hljs-function">() =&gt;</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">`https://api.example.com/users/<span class="hljs-subst">${id}</span>`</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;GET&#x27;</span> })\n    );\n  } <span class="hljs-keyword">catch</span> (err) {\n    ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;[CircuitBreaker] 用户服务请求失败&#x27;</span>, err);\n    <span class="hljs-keyword">throw</span> err;\n  }\n}\n</code></pre>\n<h4><strong>方式2：直接调用（使用默认配置）</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/controller/home.js</span>\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">index</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">breaker</span>.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> \n    ctx.<span class="hljs-property">service</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">fetchData</span>()\n  );\n  ctx.<span class="hljs-property">body</span> = data;\n}\n</code></pre>\n<hr>\n<h3><strong>5. 高级配置（动态参数与事件监听）</strong></h3>\n<h4><strong>a. 动态调整参数</strong></h4>\n<p>通过环境变量或配置中心动态修改：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.{env}.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">circuitBreaker</span> = {\n  <span class="hljs-attr">default</span>: {\n    <span class="hljs-attr">timeout</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">CIRCUIT_TIMEOUT</span> || <span class="hljs-number">5000</span>,\n    <span class="hljs-attr">maxFailures</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">CIRCUIT_MAX_FAILURES</span> || <span class="hljs-number">3</span>,\n  },\n};\n</code></pre>\n<h4><strong>b. 监听熔断事件</strong></h4>\n<p>在 <code>app.js</code> 中扩展插件行为：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app.js</span>\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppBootHook</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">app</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span> = app;\n  }\n\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">const</span> { circuitBreaker } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>;\n    <span class="hljs-comment">// 监听熔断器状态变化</span>\n    circuitBreaker.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[熔断器触发] <span class="hljs-subst">${name}</span> 服务已熔断`</span>);\n    });\n    circuitBreaker.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;close&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[熔断器恢复] <span class="hljs-subst">${name}</span> 服务已恢复`</span>);\n    });\n  }\n}\n</code></pre>\n<hr>\n<h3><strong>6. 生产环境建议</strong></h3>\n<ol>\n<li><strong>参数调优</strong>\n<ul>\n<li>根据依赖服务的 SLA 调整 <code>timeout</code> 和 <code>maxFailures</code>。</li>\n<li>高频服务可缩短 <code>resetTimeout</code>（如 10秒），关键服务延长（如 60秒）。</li>\n</ul>\n</li>\n<li><strong>监控集成</strong>\n<ul>\n<li>使用 Prometheus + Grafana 监控熔断事件。</li>\n<li>日志记录熔断触发时的上下文（如 <code>ctx.traceId</code>）。</li>\n</ul>\n</li>\n<li><strong>降级策略</strong>\n<ul>\n<li>复杂降级逻辑可结合 <code>ctx.service.fallback</code> 处理：<pre><code class="language-javascript"><span class="hljs-attr">fallback</span>: <span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">service</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;fallback-data&#x27;</span>);\n},\n</code></pre>\n</li>\n</ul>\n</li>\n<li><strong>与重试插件配合</strong><br>\n若依赖服务偶发失败，可搭配 <code>egg-retry</code>：<pre><code class="language-javascript"><span class="hljs-keyword">const</span> retryOptions = { <span class="hljs-attr">retries</span>: <span class="hljs-number">2</span> };\n<span class="hljs-keyword">await</span> ctx.<span class="hljs-property">breaker</span>.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> \n  ctx.<span class="hljs-title function_">curl</span>(url, { ...retryOptions })\n);\n</code></pre>\n</li>\n</ol>\n<hr>\n<h3><strong>7. 常见问题排查</strong></h3>\n<ul>\n<li><strong>问题1：熔断未触发</strong>\n<ul>\n<li>检查 <code>maxFailures</code> 是否过小，或 <code>timeout</code> 是否超过实际服务超时时间。</li>\n</ul>\n</li>\n<li><strong>问题2：误熔断（如网络抖动导致）</strong>\n<ul>\n<li>增加 <code>maxFailures</code>（如从 3 调整为 5）或结合重试机制。</li>\n</ul>\n</li>\n<li><strong>问题3：Egg.js 3.x 不兼容</strong>\n<ul>\n<li>确认插件版本支持，或改用通用熔断库（如 <code>circuit-breaker-js</code>）手动封装。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3><strong>8. 参考文档</strong></h3>\n<ul>\n<li><a href="https://eggjs.org/zh-cn/advanced/plugin.html" target="_blank">Egg.js 插件开发指南</a></li>\n<li><a href="https://github.com/yammer/circuit-breaker-js" target="_blank">circuit-breaker-js 原理</a></li>\n</ul>\n<p>通过以上配置，<code>egg-circuit-breaker</code> 能在 Egg.js 3.x 中有效保护系统免于级联故障，建议根据实际业务压力测试后调整参数。</p>\n</div>'</script></body></html>