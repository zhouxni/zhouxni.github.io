<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x140577=_0x9f74;function _0x1dfd(){var s=["ACofiSkJqJf+fmkYW6ZdQse","gWaIu0JdGmoiWOrbx8orW6fFgq","W5tdJCoBuSoxWOLbjZpdGCkkWP/dGmkp","W6yreZhcQq","WP/dRmkeW6FcK8kCW6vPgW","WOy5W7OdphxcR2pcJqT8hmkJ","ba7dP8oQWOTTca","BCole3ddVCkQWQy","BCowWOhcTqFcTmoE","pCodWOC/WRbsWQya","ymkvW5W/WQPXWQGmWRq","WQ8tW7baWPKAWPxdUvrZBSoo","w8orWRNcQXG3WOeioYFcKuJcSSkJ","WQDDwcpcVN7cH8klWPK","hCoaWQ4zWQntkhddK8otW6eMeq","qmoxgmoUhSk/W6tcG2VcJNjD","W6JdJCklW7xcTmkmW6S","W4tcP3aIWPFcLmoCWP/dKCoLgSo8bq","twr4W4rbWPVdICkPu8kPbhWLW4G","D3xdQCodWPT3W7RdMmodWOZdGwS","WOdcMCkBi8krW58C","A8oai8kPqtebkSkQW67dOtNcPq","xxeJWR7dU8okWPS","xtlcPbOLrCk+FMOWWPr0FNJcRwRcMmoqi8oUwCk4WRuot8ox","WOddMmkHWQhcLSoClelcK2hcTXHa","WOC1W7ymph7cR0ZcJZ9BdSkm"];return(_0x1dfd=function(){return s})()}function _0x9f74(l,s){var p=_0x1dfd();return(_0x9f74=function(s,n){var a=p[s-=263];void 0===_0x9f74.ueNbOa&&(_0x9f74.viNLAO=function(s,n){var a,t=[],l=0,p="";for(s=(s=>{for(var n,a,t="",l="",p=0,c=0;a=s.charAt(c++);~a&&(n=p%4?64*n+a:a,p++%4)&&(t+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,e=t.length;o<e;o++)l+="%"+("00"+t.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)t[c]=c;for(c=0;c<256;c++)l=(l+t[c]+n.charCodeAt(c%n.length))%256,a=t[c],t[c]=t[l],t[l]=a;for(var c=0,l=0,o=0;o<s.length;o++)a=t[c=(c+1)%256],t[c]=t[l=(l+t[c])%256],t[l]=a,p+=String.fromCharCode(s.charCodeAt(o)^t[(t[c]+t[l])%256]);return p},l=arguments,_0x9f74.ueNbOa=!0);var s=s+p[0],t=l[s];return t?a=t:(void 0===_0x9f74.gawQzt&&(_0x9f74.gawQzt=!0),a=_0x9f74.viNLAO(a,n),l[s]=a),a})(l,s)}if((()=>{for(var s=_0x9f74,n=_0x1dfd();;)try{if(944018==-parseInt(s(282,"oPcO"))+-parseInt(s(277,"oPcO"))/2+-parseInt(s(263,"f29h"))/3*(-parseInt(s(280,"rXb@"))/4)+-parseInt(s(275,"tRNk"))/5*(-parseInt(s(269,"&XSk"))/6)+-parseInt(s(288,"^B1Q"))/7*(parseInt(s(287,"FHwG"))/8)+-parseInt(s(283,"Gnz&"))/9+parseInt(s(284,"Z9i["))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x140577(276,"Z9i[")](_0x140577(286,"bL*v"))!=_0x140577(285,"&XSk"))throw window[_0x140577(265,"SgOY")][_0x140577(278,"pG$4")](_0x140577(279,"rJOX")),Error();document.title="koa-cors 详解",document.getElementById("article").innerHTML='<div><p><code>koa-cors</code> 是 Koa 中用于处理 <strong>跨域资源共享（CORS）</strong>   的中间件，允许你控制哪些外部域名可以访问你的 API 或资源。它是 <code>@koa/cors</code> 的常用别名（实际包名为 <code>@koa/cors</code>）。</p>\n<hr>\n<h2><strong>1. 核心功能</strong></h2>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>允许特定域名跨域</strong></td>\n<td>限制只有白名单中的域名可以访问</td>\n</tr>\n<tr>\n<td><strong>自定义请求方法</strong></td>\n<td>允许的 HTTP 方法（如 <code>GET</code>, <code>POST</code>, <code>PUT</code> 等）</td>\n</tr>\n<tr>\n<td><strong>控制请求头</strong></td>\n<td>允许客户端发送的请求头（如 <code>Authorization</code>, <code>Content-Type</code>）</td>\n</tr>\n<tr>\n<td><strong>预检请求（OPTIONS）处理</strong></td>\n<td>自动响应 <code>OPTIONS</code> 预检请求</td>\n</tr>\n<tr>\n<td><strong>凭证（Cookies）支持</strong></td>\n<td>允许跨域请求携带 Cookie（<code>credentials: true</code>）</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>2. 安装与基础用法</strong></h2>\n<h3><strong>安装</strong></h3>\n<pre><code class="language-sh">npm install @koa/cors\n</code></pre>\n<h3><strong>基础使用（允许所有跨域请求）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@koa/cors&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>()); <span class="hljs-comment">// 默认允许所有跨域请求</span>\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello, CORS!&#x27;</span> };\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<p><strong>效果</strong>  ：</p>\n<ul>\n<li>响应头会自动添加 <code>Access-Control-Allow-Origin: *</code>，允许所有域名访问。</li>\n</ul>\n<hr>\n<h2><strong>3. 高级配置</strong></h2>\n<h3><strong>（1）限制允许的域名（白名单）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@koa/cors&#x27;</span>);\n\napp.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">cors</span>({\n    <span class="hljs-attr">origin</span>: <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> allowedOrigins = [<span class="hljs-string">&#x27;https://example.com&#x27;</span>, <span class="hljs-string">&#x27;https://api.example.com&#x27;</span>];\n      <span class="hljs-keyword">const</span> requestOrigin = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">header</span>.<span class="hljs-property">origin</span>;\n      <span class="hljs-keyword">if</span> (allowedOrigins.<span class="hljs-title function_">includes</span>(requestOrigin)) {\n        <span class="hljs-keyword">return</span> requestOrigin; <span class="hljs-comment">// 允许的域名</span>\n      }\n      <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>; <span class="hljs-comment">// 不在白名单的域名会被拒绝</span>\n    }\n  })\n);\n</code></pre>\n<h3><strong>（2）允许特定 HTTP 方法</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">cors</span>({\n    <span class="hljs-attr">allowMethods</span>: [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;PUT&#x27;</span>, <span class="hljs-string">&#x27;DELETE&#x27;</span>] <span class="hljs-comment">// 默认允许所有方法</span>\n  })\n);\n</code></pre>\n<h3><strong>（3）允许自定义请求头</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">cors</span>({\n    <span class="hljs-attr">allowHeaders</span>: [<span class="hljs-string">&#x27;Authorization&#x27;</span>, <span class="hljs-string">&#x27;Content-Type&#x27;</span>] <span class="hljs-comment">// 允许的请求头</span>\n  })\n);\n</code></pre>\n<h3><strong>（4）允许跨域携带 Cookie</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">cors</span>({\n    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 允许 `Access-Control-Allow-Credentials: true`</span>\n  })\n);\n</code></pre>\n<p><strong>注意</strong>  ：</p>\n<ul>\n<li>如果启用 <code>credentials</code>，<code>Access-Control-Allow-Origin</code> <strong>不能为 <code>*</code></strong>  ，必须指定具体域名。</li>\n</ul>\n<h3><strong>（5）缓存预检请求结果</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">cors</span>({\n    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">86400</span> <span class="hljs-comment">// 浏览器缓存 OPTIONS 预检请求结果的时间（秒）</span>\n  })\n);\n</code></pre>\n<hr>\n<h2><strong>4. 预检请求（OPTIONS）处理</strong></h2>\n<p>当浏览器发送 <code>POST</code>、<code>PUT</code> 等非简单请求时，会先发送 <code>OPTIONS</code> 请求进行预检。<code>@koa/cors</code> 会自动处理：</p>\n<pre><code class="language-http"><span class="hljs-keyword">OPTIONS</span> <span class="hljs-string">/api/data</span> <span class="hljs-meta">HTTP/1.1</span>\n<span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>https://example.com\n<span class="hljs-attribute">Access-Control-Request-Method</span><span class="hljs-punctuation">: </span>POST\n<span class="hljs-attribute">Access-Control-Request-Headers</span><span class="hljs-punctuation">: </span>Content-Type\n</code></pre>\n<p><strong>响应</strong>  ：</p>\n<pre><code class="language-http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">204</span> No Content\n<span class="hljs-attribute">Access-Control-Allow-Origin</span><span class="hljs-punctuation">: </span>https://example.com\n<span class="hljs-attribute">Access-Control-Allow-Methods</span><span class="hljs-punctuation">: </span>POST, GET, OPTIONS\n<span class="hljs-attribute">Access-Control-Allow-Headers</span><span class="hljs-punctuation">: </span>Content-Type\n<span class="hljs-attribute">Access-Control-Max-Age</span><span class="hljs-punctuation">: </span>86400\n</code></pre>\n<hr>\n<h2><strong>5. 常见问题</strong></h2>\n<h3><strong>Q: 为什么设置了 <code>credentials: true</code> 仍然无法携带 Cookie？</strong></h3>\n<ul>\n<li><strong>原因</strong>  ：<code>Access-Control-Allow-Origin</code> 不能为 <code>*</code>，必须指定具体域名。</li>\n<li><strong>解决</strong>  ：<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">cors</span>({\n    <span class="hljs-attr">origin</span>: <span class="hljs-string">&#x27;https://example.com&#x27;</span>, <span class="hljs-comment">// 明确指定域名</span>\n    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>\n  })\n);\n</code></pre>\n</li>\n</ul>\n<h3><strong>Q: 如何让多个域名允许跨域？</strong></h3>\n<ul>\n<li><strong>方案</strong>  ：动态检查 <code>Origin</code> 并返回允许的域名：<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">cors</span>({\n    <span class="hljs-attr">origin</span>: <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> allowedOrigins = [<span class="hljs-string">&#x27;https://site1.com&#x27;</span>, <span class="hljs-string">&#x27;https://site2.com&#x27;</span>];\n      <span class="hljs-keyword">const</span> requestOrigin = ctx.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Origin&#x27;</span>);\n      <span class="hljs-keyword">return</span> allowedOrigins.<span class="hljs-title function_">includes</span>(requestOrigin) ? requestOrigin : <span class="hljs-string">&#x27;&#x27;</span>;\n    }\n  })\n);\n</code></pre>\n</li>\n</ul>\n<h3><strong>Q: 和 <code>koa-helmet</code> 冲突？</strong></h3>\n<ul>\n<li><strong>现象</strong>  ：<code>helmet()</code> 可能覆盖 CORS 头。</li>\n<li><strong>解决</strong>  ：确保 <code>cors()</code> 在 <code>helmet()</code> <strong>之后</strong>  ：<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>());\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">helmet</span>());\n</code></pre>\n</li>\n</ul>\n<hr>\n<h2><strong>6. 生产环境最佳实践</strong></h2>\n<ol>\n<li><strong>严格限制域名</strong>  ：\n<ul>\n<li>避免使用 <code>origin: \'*\'</code>，改用白名单。</li>\n</ul>\n</li>\n<li><strong>最小化允许的方法和头</strong>  ：<pre><code class="language-javascript"><span class="hljs-attr">allowMethods</span>: [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>],\n<span class="hljs-attr">allowHeaders</span>: [<span class="hljs-string">&#x27;Content-Type&#x27;</span>]\n</code></pre>\n</li>\n<li><strong>启用 <code>credentials</code> 时务必指定域名</strong>  ：<pre><code class="language-javascript"><span class="hljs-attr">origin</span>: <span class="hljs-string">&#x27;https://your-frontend.com&#x27;</span>,\n<span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>\n</code></pre>\n</li>\n<li><strong>监控非法跨域请求</strong>  ：\n<ul>\n<li>记录被拒绝的 <code>Origin</code>，分析潜在攻击。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2><strong>7. 完整配置示例</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@koa/cors&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n\napp.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">cors</span>({\n    <span class="hljs-attr">origin</span>: <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> allowedOrigins = [<span class="hljs-string">&#x27;https://example.com&#x27;</span>, <span class="hljs-string">&#x27;http://localhost:3000&#x27;</span>];\n      <span class="hljs-keyword">const</span> requestOrigin = ctx.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Origin&#x27;</span>);\n      <span class="hljs-keyword">return</span> allowedOrigins.<span class="hljs-title function_">includes</span>(requestOrigin) ? requestOrigin : <span class="hljs-string">&#x27;&#x27;</span>;\n    },\n    <span class="hljs-attr">allowMethods</span>: [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;PUT&#x27;</span>, <span class="hljs-string">&#x27;DELETE&#x27;</span>],\n    <span class="hljs-attr">allowHeaders</span>: [<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;Authorization&#x27;</span>],\n    <span class="hljs-attr">exposeHeaders</span>: [<span class="hljs-string">&#x27;X-Custom-Header&#x27;</span>],\n    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">86400</span>\n  })\n);\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;CORS 配置生效！&#x27;</span> };\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li><strong>基础场景</strong>  ：直接 <code>app.use(cors())</code> 允许所有跨域（开发环境）。</li>\n<li><strong>生产环境</strong>  ：严格限制 <code>origin</code>、<code>methods</code> 和 <code>headers</code>。</li>\n<li><strong>带 Cookie 的请求</strong>  ：必须指定具体域名 + <code>credentials: true</code>。</li>\n<li><strong>安全建议</strong>  ：配合 <code>koa-helmet</code> 使用，但注意中间件顺序。</li>\n</ul>\n</div>'</script></body></html>