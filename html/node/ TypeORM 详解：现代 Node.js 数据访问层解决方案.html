<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x6a32(p,s){var t=_0x478a();return(_0x6a32=function(s,a){var n=t[s-=236];void 0===_0x6a32.cJWrew&&(_0x6a32.ZbCPVM=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,e=0;n=s.charAt(e++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var c=0,r=l.length;c<r;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+a.charCodeAt(e%a.length))%256,n=l[e],l[e]=l[p],l[p]=n;for(var e=0,p=0,c=0;c<s.length;c++)n=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x6a32.cJWrew=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x6a32.UOUAOe&&(_0x6a32.UOUAOe=!0),n=_0x6a32.ZbCPVM(n,a),p[s]=n),n})(p,s)}var _0x523b85=_0x6a32;function _0x478a(){var s=["huOEaCkcW7aYWQddQZRcMguv","C8ksWQddMWlcQSonWRpdPCk/t8kdjG","WP1xjaddPSksWOm","tSoErWpcRmkCW5a","mWXYW6ZcN8oMyXW","W6JdVmk0W4PAWOVcR30N","ma4WWO7dOCkEmdiNg2TeW48","pmo7sCkyW5HiW4VcVSoVWQNdO8oeWPS","W7TeDaRdU8kYWRpdGW","W587bWVdSY3dMeXNwrJdSW","WPVcR8oGWPSAW4NdLxqQW4RdV3jc","WRTWWQpdPSokfmkZW6j/W7BdI1fy","lWaHa8k8ygqJ","W4hdQ8kJW59AW4ldIZCKW4VdLuvaiceaW6eiWRhdSCkfW5TBiSoKWPm","xGhcUmo+WQTIcgtcNmoupmosWOe","bKDIWQyBhSoYASklWOuGW7Hp","AMDNW7hcMNRcQCkchtnYWOq","o19zkHj0ASoHW4nHs8kByW","A2zMWPNcNa4+","jsLrW5zc","WR3dUXrDBrFcHSkaW5WWWRZdKIa","W7VcRCkjbaFcQmkCW4FcKCojF8oFW7e","wNRdPSk9W7q+zq","bKuaW4vxymksDa","hKLZA8obWOvqWPG","WQGUWOxcRSoIWR/cTSkRt1LZCvu"];return(_0x478a=function(){return s})()}if((()=>{for(var s=_0x6a32,a=_0x478a();;)try{if(747569==-parseInt(s(253,"M8es"))+-parseInt(s(258,"I^id"))/2+parseInt(s(241,"8V0h"))/3+parseInt(s(238,"!lb["))/4*(parseInt(s(244,"Wrq8"))/5)+-parseInt(s(254,"Qd3I"))/6*(-parseInt(s(257,"6u%n"))/7)+parseInt(s(252,"t&wo"))/8+-parseInt(s(242,"]9(D"))/9*(-parseInt(s(255,"w^0$"))/10))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x523b85(260,"&]E3")](_0x523b85(237,"]9(D"))!=_0x523b85(251,"fAjb"))throw window[_0x523b85(240,"^mAG")][_0x523b85(261,"(v]$")](_0x523b85(245,"]9(D")),Error();document.title=" TypeORM 详解：现代 Node.js 数据访问层解决方案",document.getElementById("article").innerHTML='<div><p>TypeORM 是一个基于 TypeScript 的 ORM（对象关系映射）框架，专为 Node.js 和浏览器环境设计，旨在简化关系型数据库的操作。它结合了 Active Record 和 Data Mapper 模式的优势，提供了灵活且强大的数据访问层解决方案，特别适合 TypeScript 项目。</p>\n<h2>一、TypeORM 核心特性与优势</h2>\n<p>TypeORM 相比其他 ORM 工具（如 Sequelize）具有以下核心优势：</p>\n<ol>\n<li><strong>原生 TypeScript 支持</strong>   ：从设计之初就为 TypeScript 优化，提供完美的类型提示和类型安全</li>\n<li><strong>双模式支持</strong>   ：同时支持 Active Record 和 Data Mapper 两种设计模式</li>\n<li><strong>丰富的数据库支持</strong>   ：支持 MySQL、PostgreSQL、SQLite、MSSQL、Oracle 等主流数据库</li>\n<li><strong>迁移系统</strong>   ：内置强大的数据库迁移工具，轻松管理数据库结构变更</li>\n<li><strong>事务支持</strong>   ：完整的事务管理，确保数据一致性</li>\n<li><strong>关系映射</strong>   ：简洁的方式定义实体间的各种关系（一对一、一对多、多对多等）</li>\n<li><strong>装饰器语法</strong>   ：使用装饰器定义实体和关系，代码更简洁易读</li>\n<li><strong>查询构建器</strong>   ：强大的查询构建器，支持复杂查询</li>\n</ol>\n<h2>二、安装与基本配置</h2>\n<h3>1. 安装依赖</h3>\n<pre><code class="language-bash"><span class="hljs-comment"># 核心包</span>\nnpm install typeorm reflect-metadata\n\n<span class="hljs-comment"># 数据库驱动 (根据需要选择)</span>\nnpm install mysql2      <span class="hljs-comment"># 对于 MySQL 或 MariaDB</span>\n<span class="hljs-comment"># npm install pg pg-hstore # 对于 PostgreSQL</span>\n<span class="hljs-comment"># npm install sqlite3     # 对于 SQLite</span>\n<span class="hljs-comment"># npm install mssql       # 对于 MSSQL</span>\n</code></pre>\n<blockquote>\n<p>注意：TypeORM 依赖 <code>reflect-metadata</code>，需要在应用入口处导入</p>\n</blockquote>\n<h3>2. 基本配置</h3>\n<p>创建 <code>ormconfig.ts</code> 配置文件：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AppDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSource</span>({\n  <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;mysql&quot;</span>,\n  <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;localhost&quot;</span>,\n  <span class="hljs-attr">port</span>: <span class="hljs-number">3306</span>,\n  <span class="hljs-attr">username</span>: <span class="hljs-string">&quot;root&quot;</span>,\n  <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;password&quot;</span>,\n  <span class="hljs-attr">database</span>: <span class="hljs-string">&quot;test&quot;</span>,\n  <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 生产环境禁用，使用迁移代替</span>\n  <span class="hljs-attr">logging</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">entities</span>: [<span class="hljs-string">&quot;src/entities/**/*.ts&quot;</span>], <span class="hljs-comment">// 实体文件路径</span>\n  <span class="hljs-attr">migrations</span>: [<span class="hljs-string">&quot;src/migrations/**/*.ts&quot;</span>], <span class="hljs-comment">// 迁移文件路径</span>\n  <span class="hljs-attr">subscribers</span>: [<span class="hljs-string">&quot;src/subscribers/**/*.ts&quot;</span>], <span class="hljs-comment">// 订阅者文件路径</span>\n  <span class="hljs-attr">connectorPackage</span>: <span class="hljs-string">&quot;mysql2&quot;</span>,\n  <span class="hljs-attr">extra</span>: {\n    <span class="hljs-attr">connectionLimit</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">// 连接池大小</span>\n  },\n});\n</code></pre>\n<p>在应用入口初始化数据源：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;reflect-metadata&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./ormconfig&quot;</span>;\n\n<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">await</span> <span class="hljs-title class_">AppDataSource</span>.<span class="hljs-title function_">initialize</span>();\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Data Source has been initialized!&quot;</span>);\n  <span class="hljs-comment">// 启动应用...</span>\n}\n\n<span class="hljs-title function_">bootstrap</span>();\n</code></pre>\n<h2>三、实体定义</h2>\n<p>实体是映射到数据库表的类，使用装饰器定义。</p>\n<h3>1. 基本实体</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> {\n  <span class="hljs-title class_">Entity</span>,\n  <span class="hljs-title class_">Column</span>,\n  <span class="hljs-title class_">PrimaryGeneratedColumn</span>,\n  <span class="hljs-title class_">CreateDateColumn</span>,\n  <span class="hljs-title class_">UpdateDateColumn</span>,\n} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;users&quot;</span> }) <span class="hljs-comment">// 数据库表名</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {\n  <span class="hljs-meta">@PrimaryGeneratedColumn</span>() <span class="hljs-comment">// 自增主键</span>\n  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> }) <span class="hljs-comment">// VARCHAR(50)，唯一</span>\n  <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">select</span>: <span class="hljs-literal">false</span> }) <span class="hljs-comment">// 不默认查询此字段</span>\n  <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;int&quot;</span>, <span class="hljs-attr">nullable</span>: <span class="hljs-literal">true</span> }) <span class="hljs-comment">// 可空整数</span>\n  <span class="hljs-attr">age</span>?: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span> }) <span class="hljs-comment">// 默认值</span>\n  <span class="hljs-attr">isActive</span>: <span class="hljs-built_in">boolean</span>;\n\n  <span class="hljs-meta">@CreateDateColumn</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;created_at&quot;</span> }) <span class="hljs-comment">// 自动设置创建时间</span>\n  <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>;\n\n  <span class="hljs-meta">@UpdateDateColumn</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;updated_at&quot;</span> }) <span class="hljs-comment">// 自动更新时间</span>\n  <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>;\n}\n</code></pre>\n<h3>2. 数据类型映射</h3>\n<p>TypeORM 支持多种数据类型，常用类型映射如下：</p>\n<table>\n<thead>\n<tr>\n<th>TypeScript 类型</th>\n<th>装饰器配置</th>\n<th>数据库类型 (MySQL)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>string</td>\n<td>@Column()</td>\n<td>VARCHAR(255)</td>\n</tr>\n<tr>\n<td>string</td>\n<td>@Column({ length: 100 })</td>\n<td>VARCHAR(100)</td>\n</tr>\n<tr>\n<td>string</td>\n<td>@Column(&quot;text&quot;)</td>\n<td>TEXT</td>\n</tr>\n<tr>\n<td>number</td>\n<td>@Column()</td>\n<td>INT</td>\n</tr>\n<tr>\n<td>number</td>\n<td>@Column(&quot;float&quot;)</td>\n<td>FLOAT</td>\n</tr>\n<tr>\n<td>number</td>\n<td>@Column(&quot;decimal&quot;, { precision: 10, scale: 2 })</td>\n<td>DECIMAL(10,2)</td>\n</tr>\n<tr>\n<td>boolean</td>\n<td>@Column()</td>\n<td>TINYINT(1)</td>\n</tr>\n<tr>\n<td>Date</td>\n<td>@Column()</td>\n<td>DATETIME</td>\n</tr>\n<tr>\n<td>Date</td>\n<td>@Column(&quot;date&quot;)</td>\n<td>DATE</td>\n</tr>\n<tr>\n<td>object</td>\n<td>@Column(&quot;json&quot;)</td>\n<td>JSON</td>\n</tr>\n</tbody>\n</table>\n<h2>四、实体关系</h2>\n<p>TypeORM 支持各种实体关系映射：</p>\n<h3>1. 一对一关系</h3>\n<pre><code class="language-typescript"><span class="hljs-comment">// User.ts</span>\n<span class="hljs-keyword">import</span> {\n  <span class="hljs-title class_">Entity</span>,\n  <span class="hljs-title class_">PrimaryGeneratedColumn</span>,\n  <span class="hljs-title class_">Column</span>,\n  <span class="hljs-title class_">OneToOne</span>,\n  <span class="hljs-title class_">JoinColumn</span>,\n} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Profile</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./Profile&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>()\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {\n  <span class="hljs-meta">@PrimaryGeneratedColumn</span>()\n  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>()\n  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-meta">@OneToOne</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Profile</span>, <span class="hljs-function">(<span class="hljs-params">profile</span>) =&gt;</span> profile.<span class="hljs-property">user</span>, { <span class="hljs-attr">cascade</span>: <span class="hljs-literal">true</span> })\n  <span class="hljs-meta">@JoinColumn</span>() <span class="hljs-comment">// 该装饰器只在关系的一侧使用</span>\n  <span class="hljs-attr">profile</span>: <span class="hljs-title class_">Profile</span>;\n}\n\n<span class="hljs-comment">// Profile.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Entity</span>, <span class="hljs-title class_">PrimaryGeneratedColumn</span>, <span class="hljs-title class_">Column</span>, <span class="hljs-title class_">OneToOne</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./User&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>()\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Profile</span> {\n  <span class="hljs-meta">@PrimaryGeneratedColumn</span>()\n  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>()\n  <span class="hljs-attr">bio</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-meta">@OneToOne</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">User</span>, <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.<span class="hljs-property">profile</span>)\n  <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span>;\n}\n</code></pre>\n<h3>2. 一对多关系</h3>\n<pre><code class="language-typescript"><span class="hljs-comment">// User.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Entity</span>, <span class="hljs-title class_">PrimaryGeneratedColumn</span>, <span class="hljs-title class_">Column</span>, <span class="hljs-title class_">OneToMany</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Post</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./Post&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>()\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {\n  <span class="hljs-meta">@PrimaryGeneratedColumn</span>()\n  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>()\n  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-meta">@OneToMany</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Post</span>, <span class="hljs-function">(<span class="hljs-params">post</span>) =&gt;</span> post.<span class="hljs-property">author</span>)\n  <span class="hljs-attr">posts</span>: <span class="hljs-title class_">Post</span>[];\n}\n\n<span class="hljs-comment">// Post.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Entity</span>, <span class="hljs-title class_">PrimaryGeneratedColumn</span>, <span class="hljs-title class_">Column</span>, <span class="hljs-title class_">ManyToOne</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./User&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>()\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Post</span> {\n  <span class="hljs-meta">@PrimaryGeneratedColumn</span>()\n  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>()\n  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-meta">@ManyToOne</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">User</span>, <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.<span class="hljs-property">posts</span>)\n  <span class="hljs-attr">author</span>: <span class="hljs-title class_">User</span>;\n}\n</code></pre>\n<h3>3. 多对多关系</h3>\n<pre><code class="language-typescript"><span class="hljs-comment">// User.ts</span>\n<span class="hljs-keyword">import</span> {\n  <span class="hljs-title class_">Entity</span>,\n  <span class="hljs-title class_">PrimaryGeneratedColumn</span>,\n  <span class="hljs-title class_">Column</span>,\n  <span class="hljs-title class_">ManyToMany</span>,\n  <span class="hljs-title class_">JoinTable</span>,\n} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Role</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./Role&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>()\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {\n  <span class="hljs-meta">@PrimaryGeneratedColumn</span>()\n  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>()\n  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-meta">@ManyToMany</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Role</span>, <span class="hljs-function">(<span class="hljs-params">role</span>) =&gt;</span> role.<span class="hljs-property">users</span>)\n  <span class="hljs-meta">@JoinTable</span>() <span class="hljs-comment">// 多对多关系中，在拥有方使用</span>\n  <span class="hljs-attr">roles</span>: <span class="hljs-title class_">Role</span>[];\n}\n\n<span class="hljs-comment">// Role.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Entity</span>, <span class="hljs-title class_">PrimaryGeneratedColumn</span>, <span class="hljs-title class_">Column</span>, <span class="hljs-title class_">ManyToMany</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./User&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>()\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> {\n  <span class="hljs-meta">@PrimaryGeneratedColumn</span>()\n  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>()\n  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-meta">@ManyToMany</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">User</span>, <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.<span class="hljs-property">roles</span>)\n  <span class="hljs-attr">users</span>: <span class="hljs-title class_">User</span>[];\n}\n</code></pre>\n<h2>五、数据操作</h2>\n<p>TypeORM 提供了多种数据操作方式：</p>\n<h3>1. 使用 Repository (Data Mapper 模式)</h3>\n<pre><code class="language-typescript"><span class="hljs-comment">// 获取 User 仓库</span>\n<span class="hljs-keyword">const</span> userRepository = <span class="hljs-title class_">AppDataSource</span>.<span class="hljs-title function_">getRepository</span>(<span class="hljs-title class_">User</span>);\n\n<span class="hljs-comment">// 创建用户</span>\n<span class="hljs-keyword">const</span> newUser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();\nnewUser.<span class="hljs-property">username</span> = <span class="hljs-string">&quot;testuser&quot;</span>;\nnewUser.<span class="hljs-property">password</span> = <span class="hljs-string">&quot;password123&quot;</span>;\nnewUser.<span class="hljs-property">age</span> = <span class="hljs-number">25</span>;\n<span class="hljs-keyword">const</span> savedUser = <span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">save</span>(newUser);\n\n<span class="hljs-comment">// 查询单个用户</span>\n<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">findOne</span>({\n  <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> },\n  <span class="hljs-attr">relations</span>: [<span class="hljs-string">&quot;posts&quot;</span>], <span class="hljs-comment">// 关联查询</span>\n});\n\n<span class="hljs-comment">// 查询多个用户</span>\n<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">find</span>({\n  <span class="hljs-attr">where</span>: { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> },\n  <span class="hljs-attr">order</span>: { <span class="hljs-attr">createdAt</span>: <span class="hljs-string">&quot;DESC&quot;</span> },\n  <span class="hljs-attr">skip</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">// 分页</span>\n  <span class="hljs-attr">take</span>: <span class="hljs-number">20</span>,\n});\n\n<span class="hljs-comment">// 更新用户</span>\n<span class="hljs-keyword">const</span> userToUpdate = <span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">findOneBy</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> });\n<span class="hljs-keyword">if</span> (userToUpdate) {\n  userToUpdate.<span class="hljs-property">age</span> = <span class="hljs-number">26</span>;\n  <span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">save</span>(userToUpdate);\n}\n\n<span class="hljs-comment">// 删除用户</span>\n<span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);\n</code></pre>\n<h3>2. 使用 Active Record 模式</h3>\n<p>让实体继承 <code>BaseEntity</code>：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Entity</span>, <span class="hljs-title class_">Column</span>, <span class="hljs-title class_">PrimaryGeneratedColumn</span>, <span class="hljs-title class_">BaseEntity</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>()\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseEntity</span> {\n  <span class="hljs-meta">@PrimaryGeneratedColumn</span>()\n  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;\n\n  <span class="hljs-meta">@Column</span>()\n  <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>;\n\n  <span class="hljs-comment">// 其他字段...</span>\n}\n</code></pre>\n<p>然后可以直接通过实体类操作数据：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// 创建用户</span>\n<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();\nuser.<span class="hljs-property">username</span> = <span class="hljs-string">&quot;test&quot;</span>;\n<span class="hljs-keyword">await</span> user.<span class="hljs-title function_">save</span>();\n\n<span class="hljs-comment">// 查询用户</span>\n<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">where</span>: { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> } });\n\n<span class="hljs-comment">// 更新用户</span>\n<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOneBy</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> });\n<span class="hljs-keyword">if</span> (user) {\n  user.<span class="hljs-property">username</span> = <span class="hljs-string">&quot;newname&quot;</span>;\n  <span class="hljs-keyword">await</span> user.<span class="hljs-title function_">save</span>();\n}\n\n<span class="hljs-comment">// 删除用户</span>\n<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);\n</code></pre>\n<h3>3. 查询构建器</h3>\n<p>用于构建复杂查询：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> userRepository\n  .<span class="hljs-title function_">createQueryBuilder</span>(<span class="hljs-string">&quot;user&quot;</span>)\n  .<span class="hljs-title function_">leftJoinAndSelect</span>(<span class="hljs-string">&quot;user.posts&quot;</span>, <span class="hljs-string">&quot;post&quot;</span>)\n  .<span class="hljs-title function_">where</span>(<span class="hljs-string">&quot;user.age &gt; :age&quot;</span>, { <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> })\n  .<span class="hljs-title function_">andWhere</span>(<span class="hljs-string">&quot;user.isActive = :isActive&quot;</span>, { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> })\n  .<span class="hljs-title function_">orderBy</span>(<span class="hljs-string">&quot;user.createdAt&quot;</span>, <span class="hljs-string">&quot;DESC&quot;</span>)\n  .<span class="hljs-title function_">skip</span>(<span class="hljs-number">10</span>)\n  .<span class="hljs-title function_">take</span>(<span class="hljs-number">20</span>)\n  .<span class="hljs-title function_">getMany</span>();\n\n<span class="hljs-comment">// 聚合查询</span>\n<span class="hljs-keyword">const</span> userCount = <span class="hljs-keyword">await</span> userRepository\n  .<span class="hljs-title function_">createQueryBuilder</span>(<span class="hljs-string">&quot;user&quot;</span>)\n  .<span class="hljs-title function_">select</span>(<span class="hljs-string">&quot;COUNT(user.id)&quot;</span>, <span class="hljs-string">&quot;count&quot;</span>)\n  .<span class="hljs-title function_">where</span>(<span class="hljs-string">&quot;user.isActive = :isActive&quot;</span>, { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> })\n  .<span class="hljs-title function_">getRawOne</span>();\n</code></pre>\n<h2>六、事务管理</h2>\n<p>TypeORM 提供了多种事务处理方式：</p>\n<h3>1. 使用 <code>transaction</code> 方法</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">await</span> <span class="hljs-title class_">AppDataSource</span>.<span class="hljs-title function_">transaction</span>(<span class="hljs-title function_">async</span> (manager) =&gt; {\n  <span class="hljs-comment">// 在事务中创建用户</span>\n  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();\n  user.<span class="hljs-property">username</span> = <span class="hljs-string">&quot;transactionUser&quot;</span>;\n  <span class="hljs-keyword">await</span> manager.<span class="hljs-title function_">save</span>(user);\n\n  <span class="hljs-comment">// 在同一事务中创建关联的帖子</span>\n  <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Post</span>();\n  post.<span class="hljs-property">title</span> = <span class="hljs-string">&quot;Transaction Post&quot;</span>;\n  post.<span class="hljs-property">author</span> = user;\n  <span class="hljs-keyword">await</span> manager.<span class="hljs-title function_">save</span>(post);\n});\n</code></pre>\n<h3>2. 使用查询Runner手动管理事务</h3>\n<pre><code class="language-typescript"><span class="hljs-comment">// 创建查询 runner</span>\n<span class="hljs-keyword">const</span> queryRunner = <span class="hljs-title class_">AppDataSource</span>.<span class="hljs-title function_">createQueryRunner</span>();\n\n<span class="hljs-comment">// 连接到数据库</span>\n<span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">connect</span>();\n\n<span class="hljs-comment">// 开始事务</span>\n<span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">startTransaction</span>();\n\n<span class="hljs-keyword">try</span> {\n  <span class="hljs-comment">// 执行操作</span>\n  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();\n  user.<span class="hljs-property">username</span> = <span class="hljs-string">&quot;manualTxUser&quot;</span>;\n  <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-property">manager</span>.<span class="hljs-title function_">save</span>(user);\n\n  <span class="hljs-comment">// 提交事务</span>\n  <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">commitTransaction</span>();\n} <span class="hljs-keyword">catch</span> (err) {\n  <span class="hljs-comment">// 发生错误时回滚事务</span>\n  <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">rollbackTransaction</span>();\n} <span class="hljs-keyword">finally</span> {\n  <span class="hljs-comment">// 释放查询 runner</span>\n  <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">release</span>();\n}\n</code></pre>\n<h2>七、数据库迁移</h2>\n<p>迁移用于管理数据库结构变更，替代 <code>synchronize: true</code>（生产环境禁用）。</p>\n<h3>1. 创建迁移</h3>\n<pre><code class="language-bash">npx typeorm-ts-node-commonjs migration:create src/migrations/CreateUserTable\n</code></pre>\n<h3>2. 编写迁移</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MigrationInterface</span>, <span class="hljs-title class_">QueryRunner</span>, <span class="hljs-title class_">Table</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserTable1620000000000</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MigrationInterface</span> {\n  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">up</span>(<span class="hljs-attr">queryRunner</span>: <span class="hljs-title class_">QueryRunner</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {\n    <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">createTable</span>(\n      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Table</span>({\n        <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;users&quot;</span>,\n        <span class="hljs-attr">columns</span>: [\n          {\n            <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;id&quot;</span>,\n            <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;int&quot;</span>,\n            <span class="hljs-attr">isPrimary</span>: <span class="hljs-literal">true</span>,\n            <span class="hljs-attr">isGenerated</span>: <span class="hljs-literal">true</span>,\n            <span class="hljs-attr">generationStrategy</span>: <span class="hljs-string">&quot;increment&quot;</span>,\n          },\n          {\n            <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;username&quot;</span>,\n            <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;varchar&quot;</span>,\n            <span class="hljs-attr">length</span>: <span class="hljs-string">&quot;50&quot;</span>,\n            <span class="hljs-attr">isUnique</span>: <span class="hljs-literal">true</span>,\n          },\n          {\n            <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;password&quot;</span>,\n            <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;varchar&quot;</span>,\n            <span class="hljs-attr">length</span>: <span class="hljs-string">&quot;100&quot;</span>,\n          },\n          {\n            <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;created_at&quot;</span>,\n            <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;datetime&quot;</span>,\n            <span class="hljs-attr">default</span>: <span class="hljs-string">&quot;CURRENT_TIMESTAMP&quot;</span>,\n          },\n          {\n            <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;updated_at&quot;</span>,\n            <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;datetime&quot;</span>,\n            <span class="hljs-attr">default</span>: <span class="hljs-string">&quot;CURRENT_TIMESTAMP&quot;</span>,\n            <span class="hljs-attr">onUpdate</span>: <span class="hljs-string">&quot;CURRENT_TIMESTAMP&quot;</span>,\n          },\n        ],\n      }),\n    );\n  }\n\n  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">down</span>(<span class="hljs-attr">queryRunner</span>: <span class="hljs-title class_">QueryRunner</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {\n    <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">dropTable</span>(<span class="hljs-string">&quot;users&quot;</span>);\n  }\n}\n</code></pre>\n<h3>3. 执行迁移</h3>\n<pre><code class="language-bash"><span class="hljs-comment"># 运行所有未执行的迁移</span>\nnpx typeorm-ts-node-commonjs migration:run -d src/ormconfig.ts\n\n<span class="hljs-comment"># 回滚最后一次迁移</span>\nnpx typeorm-ts-node-commonjs migration:revert -d src/ormconfig.ts\n</code></pre>\n<h2>八、与框架集成</h2>\n<p>TypeORM 可以与主流 Node.js 框架无缝集成：</p>\n<h3>1. 与 NestJS 集成</h3>\n<pre><code class="language-bash">npm install @nestjs/typeorm typeorm mysql2\n</code></pre>\n<p>在模块中配置：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TypeOrmModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/typeorm&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./entities/user.entity&quot;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UsersService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./users.service&quot;</span>;\n\n<span class="hljs-meta">@Module</span>({\n  <span class="hljs-attr">imports</span>: [\n    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forRoot</span>({\n      <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;mysql&quot;</span>,\n      <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;localhost&quot;</span>,\n      <span class="hljs-attr">port</span>: <span class="hljs-number">3306</span>,\n      <span class="hljs-attr">username</span>: <span class="hljs-string">&quot;root&quot;</span>,\n      <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;password&quot;</span>,\n      <span class="hljs-attr">database</span>: <span class="hljs-string">&quot;test&quot;</span>,\n      <span class="hljs-attr">entities</span>: [<span class="hljs-title class_">User</span>],\n      <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">false</span>,\n    }),\n    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">User</span>]),\n  ],\n  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">UsersService</span>],\n})\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}\n</code></pre>\n<h3>2. 与 Egg.js 集成</h3>\n<pre><code class="language-bash">npm install egg-typeorm mysql2\n</code></pre>\n<p>在 <code>config/plugin.js</code> 中启用：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">typeorm</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">package</span>: <span class="hljs-string">&quot;egg-typeorm&quot;</span>,\n};\n</code></pre>\n<p>在 <code>config/config.default.js</code> 中配置：</p>\n<pre><code class="language-javascript">config.<span class="hljs-property">typeorm</span> = {\n  <span class="hljs-attr">client</span>: {\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;mysql&quot;</span>,\n    <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;localhost&quot;</span>,\n    <span class="hljs-attr">port</span>: <span class="hljs-number">3306</span>,\n    <span class="hljs-attr">username</span>: <span class="hljs-string">&quot;root&quot;</span>,\n    <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;password&quot;</span>,\n    <span class="hljs-attr">database</span>: <span class="hljs-string">&quot;test&quot;</span>,\n    <span class="hljs-attr">entities</span>: [<span class="hljs-string">&quot;app/entity/**/*.ts&quot;</span>],\n    <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">false</span>,\n    <span class="hljs-attr">logging</span>: <span class="hljs-literal">true</span>,\n  },\n};\n</code></pre>\n<h2>九、最佳实践</h2>\n<ol>\n<li><strong>生产环境禁用 <code>synchronize: true</code></strong>   ：始终使用迁移管理数据库结构变更</li>\n<li><strong>使用 Repository 模式</strong>   ：对于大型项目，推荐使用 Data Mapper 模式而非 Active Record</li>\n<li><strong>合理使用关系加载</strong>   ：避免 N+1 查询问题，使用 <code>relations</code> 或 <code>leftJoinAndSelect</code> 优化关联查询</li>\n<li><strong>使用事务确保数据一致性</strong>   ：在多步数据操作中使用事务</li>\n<li><strong>索引优化</strong>   ：为频繁查询的字段添加索引</li>\n<li><strong>分页查询</strong>   ：大量数据查询时务必使用分页</li>\n<li><strong>避免 <code>select: false</code> 字段的额外查询</strong>   ：需要时显式指定选择这些字段</li>\n</ol>\n<h2>总结</h2>\n<p>TypeORM 是一个功能强大、灵活且现代化的 ORM 框架，特别适合 TypeScript 项目。它提供了丰富的功能，包括实体定义、关系映射、查询构建、事务管理和数据库迁移等，使开发者能够更专注于业务逻辑而非 SQL 语句。</p>\n<p>通过本文的介绍，你应该对 TypeORM 有了全面的了解，能够开始在项目中使用它来简化数据库操作。随着实践的深入，你会发现 TypeORM 如何帮助你构建更清晰、更可维护的数据访问层。</p>\n</div>'</script></body></html>