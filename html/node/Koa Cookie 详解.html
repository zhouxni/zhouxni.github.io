<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x4871bf=_0x17c2;function _0x17c2(t,s){var p=_0x5a6e();return(_0x17c2=function(s,n){var a=p[s-=252];void 0===_0x17c2.syITFQ&&(_0x17c2.CNozZJ=function(s,n){var a,l=[],t=0,p="";for(s=(s=>{for(var n,a,l="",t="",p=0,e=0;a=s.charAt(e++);~a&&(n=p%4?64*n+a:a,p++%4)&&(l+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=l.length;c<o;c++)t+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(t)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)t=(t+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[t],l[t]=a;for(var e=0,t=0,c=0;c<s.length;c++)a=l[e=(e+1)%256],l[e]=l[t=(t+l[e])%256],l[t]=a,p+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[t])%256]);return p},t=arguments,_0x17c2.syITFQ=!0);var s=s+p[0],l=t[s];return l?a=l:(void 0===_0x17c2.WLEdyx&&(_0x17c2.WLEdyx=!0),a=_0x17c2.CNozZJ(a,n),t[s]=a),a})(t,s)}if((()=>{for(var s=_0x17c2,n=_0x5a6e();;)try{if(596587==+parseInt(s(257,"[JXw"))+parseInt(s(256,"!O%$"))/2+-parseInt(s(266,"4wwS"))/3+parseInt(s(268,"PPcL"))/4+parseInt(s(255,"sAO*"))/5*(-parseInt(s(253,"sAO*"))/6)+parseInt(s(258,"TYNz"))/7+-parseInt(s(254,"TYNz"))/8)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x4871bf(261,"XZfH")](_0x4871bf(262,"Fl$0"))!=_0x4871bf(252,"LSj%"))throw window[_0x4871bf(264,"Ij&I")][_0x4871bf(273,"as!K")](_0x4871bf(263,"F@V3")),Error();function _0x5a6e(){var s=["WRBdNfToeJBcS8kjubVcLmkIfa","WQjNaHiHtcPpW41YDmkRWOO","nmk/W7pcVgDQb8kkkq","W6tdN8kpBmotB3elWRVcIWSXaq","WPRcICojFuVcRSoCmJGpW63cPCor","W68eW5HTW4POW70qWPpcPJtcMdS","BXZdG8o7WOXHW7S","W6X/lfK1","n1G7W6pdL1hdTdJcQSk5","d8kIWRarW5CHWQdcMrOqbCoHWRW","mLu8WPBdHexdNcZcOG","neddGa95W7/dR8oQW4hdRINdMa","yCooW4NdLgqBWQVdN8k2W4/dPSkmnq","dmkTWRawW50KWQZcHb4gpCoWWQe","n18+W6NcVWhdUGpcJ8kYbri","m1KXW6NcTWhcIH/cQ8kFmdpdUW","W6dcIHGWx2VdQG","g8ozWRyXce3cUMOp","WRxdJSoKWOddG0PnW7HSd8ozBmkphmkYjM4gWONdRrj1hmo6WQb+","W6aWwmoJhmoloSok","gmowg8onDCopW5VdGSkCFW","W7f7W43cMSoumNFcIhPmC8oUzW"];return(_0x5a6e=function(){return s})()}document.title="Koa Cookie 详解",document.getElementById("article").innerHTML='<div><p>Cookie 是 Web 开发中用于在客户端存储小型数据的机制，Koa 通过 <code>ctx.cookies</code> 提供了便捷的 Cookie 操作接口。以下是 Koa Cookie 的完整指南：</p>\n<hr>\n<h2><strong>1. Cookie 基础操作</strong></h2>\n<h3><strong>1.1 设置 Cookie</strong></h3>\n<pre><code class="language-javascript">ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>, {\n  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">86400000</span>,    <span class="hljs-comment">// 有效期（毫秒）</span>\n  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 仅服务端可访问（防 XSS）</span>\n  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,        <span class="hljs-comment">// 仅 HTTPS 传输</span>\n  <span class="hljs-attr">domain</span>: <span class="hljs-string">&#x27;example.com&#x27;</span>, <span class="hljs-comment">// 生效域名</span>\n  <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,           <span class="hljs-comment">// 生效路径</span>\n  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">&#x27;Lax&#x27;</span>      <span class="hljs-comment">// 防 CSRF</span>\n});\n</code></pre>\n<h3><strong>1.2 读取 Cookie</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> cookieValue = ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;name&#x27;</span>); <span class="hljs-comment">// 获取 Cookie</span>\n</code></pre>\n<h3><strong>1.3 删除 Cookie</strong></h3>\n<pre><code class="language-javascript">ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-literal">null</span>, { <span class="hljs-attr">maxAge</span>: <span class="hljs-number">0</span> }); <span class="hljs-comment">// 设置过期时间为 0</span>\n</code></pre>\n<hr>\n<h2><strong>2. Cookie 安全配置</strong></h2>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>类型</th>\n<th>默认值</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>httpOnly</code></td>\n<td>boolean</td>\n<td><code>true</code></td>\n<td>禁止 JavaScript 访问 Cookie（防御 XSS）</td>\n</tr>\n<tr>\n<td><code>secure</code></td>\n<td>boolean</td>\n<td><code>false</code></td>\n<td>仅通过 HTTPS 传输（生产环境必启用）</td>\n</tr>\n<tr>\n<td><code>sameSite</code></td>\n<td>string</td>\n<td><code>undefined</code></td>\n<td><code>Strict</code>/<code>Lax</code>（防御 CSRF），现代浏览器默认 <code>Lax</code></td>\n</tr>\n<tr>\n<td><code>signed</code></td>\n<td>boolean</td>\n<td><code>false</code></td>\n<td>对 Cookie 签名（需配置 <code>app.keys</code>）</td>\n</tr>\n<tr>\n<td><code>maxAge</code></td>\n<td>number</td>\n<td><code>undefined</code></td>\n<td>过期时间（毫秒），优先级高于 <code>expires</code></td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>3. 签名 Cookie（防篡改）</strong></h2>\n<h3><strong>3.1 配置签名密钥</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n\napp.<span class="hljs-property">keys</span> = [<span class="hljs-string">&#x27;secret1&#x27;</span>, <span class="hljs-string">&#x27;secret2&#x27;</span>]; <span class="hljs-comment">// 轮换密钥</span>\n</code></pre>\n<h3><strong>3.2 设置签名 Cookie</strong></h3>\n<pre><code class="language-javascript">ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;session&#x27;</span>, <span class="hljs-string">&#x27;encrypted-data&#x27;</span>, {\n  <span class="hljs-attr">signed</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 启用签名</span>\n});\n</code></pre>\n<h3><strong>3.3 验证签名 Cookie</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> session = ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;session&#x27;</span>, { <span class="hljs-attr">signed</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// 自动验签</span>\n<span class="hljs-keyword">if</span> (!session) ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">403</span>, <span class="hljs-string">&#x27;Cookie 被篡改&#x27;</span>);\n</code></pre>\n<hr>\n<h2><strong>4. 常见场景示例</strong></h2>\n<h3><strong>4.1 用户登录会话</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 登录成功时设置</span>\nctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;session_id&#x27;</span>, <span class="hljs-title function_">generateSessionToken</span>(), {\n  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 7 天</span>\n});\n\n<span class="hljs-comment">// 后续请求验证</span>\n<span class="hljs-keyword">const</span> token = ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;session_id&#x27;</span>);\n<span class="hljs-keyword">if</span> (!token) ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">401</span>, <span class="hljs-string">&#x27;未登录&#x27;</span>);\n</code></pre>\n<h3><strong>4.2 多级域名共享 Cookie</strong></h3>\n<pre><code class="language-javascript">ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;shared_data&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>, {\n  <span class="hljs-attr">domain</span>: <span class="hljs-string">&#x27;.example.com&#x27;</span>, <span class="hljs-comment">// 顶级域名</span>\n  <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>\n});\n</code></pre>\n<h3><strong>4.3 CSRF 防御</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 生成 CSRF Token</span>\n<span class="hljs-keyword">const</span> csrfToken = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;hex&#x27;</span>);\nctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;csrf_token&#x27;</span>, csrfToken, {\n  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">&#x27;Strict&#x27;</span> <span class="hljs-comment">// 严格模式</span>\n});\n\n<span class="hljs-comment">// 前端提交时携带（如表单隐藏字段）</span>\n<span class="hljs-comment">// &lt;input type=&quot;hidden&quot; name=&quot;_csrf&quot; value=&quot;{{ csrfToken }}&quot;&gt;</span>\n</code></pre>\n<hr>\n<h2><strong>5. 生产环境最佳实践</strong></h2>\n<ol>\n<li><strong>强制 HTTPS</strong>  ：<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">protocol</span> !== <span class="hljs-string">&#x27;https&#x27;</span>) {\n    ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">403</span>, <span class="hljs-string">&#x27;请使用 HTTPS&#x27;</span>);\n  }\n  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n});\n</code></pre>\n</li>\n<li><strong>密钥管理</strong>  ：\n<ul>\n<li>通过环境变量配置 <code>app.keys</code>：<pre><code class="language-javascript">app.<span class="hljs-property">keys</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">COOKIE_SECRETS</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>);\n</code></pre>\n</li>\n</ul>\n</li>\n<li><strong>监控异常 Cookie</strong>  ：<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">const</span> cookieCount = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">header</span>.<span class="hljs-property">cookie</span> || {}).<span class="hljs-property">length</span>;\n  <span class="hljs-keyword">if</span> (cookieCount &gt; <span class="hljs-number">10</span>) {\n    ctx.<span class="hljs-property">log</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`可疑请求: 过多 Cookie (<span class="hljs-subst">${cookieCount}</span>个)`</span>);\n  }\n  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n});\n</code></pre>\n</li>\n</ol>\n<hr>\n<h2><strong>6. 常见问题</strong></h2>\n<h3><strong>Q: 为什么 Cookie 在浏览器不显示？</strong></h3>\n<ul>\n<li><strong>可能原因</strong>  ：\n<ul>\n<li><code>secure: true</code> 但未用 HTTPS。</li>\n<li><code>sameSite: \'Strict\'</code> 且跨站访问。</li>\n<li>域名/路径不匹配。</li>\n</ul>\n</li>\n</ul>\n<h3><strong>Q: 如何实现跨域 Cookie？</strong></h3>\n<ul>\n<li><strong>必要条件</strong>  ：\n<ul>\n<li>前端设置 <code>credentials: \'include\'</code>：<pre><code class="language-javascript"><span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">credentials</span>: <span class="hljs-string">&#x27;include&#x27;</span> });\n</code></pre>\n</li>\n<li>服务端配置：<pre><code class="language-javascript">ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>, {\n  <span class="hljs-attr">domain</span>: <span class="hljs-string">&#x27;.example.com&#x27;</span>,\n  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">&#x27;None&#x27;</span>,\n  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>\n});\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<h3><strong>Q: 签名 Cookie 报错 &quot;invalid signature&quot;</strong></h3>\n<ul>\n<li><strong>解决方案</strong>  ：\n<ul>\n<li>检查 <code>app.keys</code> 是否一致。</li>\n<li>确保未在未签名的 Cookie 上调用 <code>get(name, { signed: true })</code>。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2><strong>7. 完整示例</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\napp.<span class="hljs-property">keys</span> = [process.<span class="hljs-property">env</span>.<span class="hljs-property">COOKIE_SECRET</span> || <span class="hljs-string">&#x27;default-secret&#x27;</span>];\n\n<span class="hljs-comment">// 模拟用户登录</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">path</span> === <span class="hljs-string">&#x27;/login&#x27;</span>) {\n    <span class="hljs-keyword">const</span> token = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">32</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;hex&#x27;</span>);\n    ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;auth&#x27;</span>, token, {\n      <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">secure</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span>,\n      <span class="hljs-attr">maxAge</span>: <span class="hljs-number">3600000</span>,\n      <span class="hljs-attr">sameSite</span>: <span class="hljs-string">&#x27;Lax&#x27;</span>,\n      <span class="hljs-attr">signed</span>: <span class="hljs-literal">true</span>\n    });\n    ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;登录成功&#x27;</span>;\n  } <span class="hljs-keyword">else</span> {\n    <span class="hljs-keyword">const</span> authToken = ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;auth&#x27;</span>, { <span class="hljs-attr">signed</span>: <span class="hljs-literal">true</span> });\n    ctx.<span class="hljs-property">body</span> = authToken ? <span class="hljs-string">`用户 Token: <span class="hljs-subst">${authToken}</span>`</span> : <span class="hljs-string">&#x27;未登录&#x27;</span>;\n  }\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li><strong>原生支持</strong>  ：Koa 的 <code>ctx.cookies</code> 已覆盖绝大多数需求。</li>\n<li><strong>安全核心</strong>  ：<code>httpOnly</code> + <code>secure</code> + <code>sameSite</code> + 签名。</li>\n<li><strong>生产必做</strong>  ：密钥轮换、HTTPS 强制、异常监控。</li>\n</ul>\n</div>'</script></body></html>