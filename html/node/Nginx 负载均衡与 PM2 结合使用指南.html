<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x40a9(p,s){var l=_0x5bc9();return(_0x40a9=function(s,n){var a=l[s-=469];void 0===_0x40a9.OjsEAF&&(_0x40a9.BHHYHp=function(s,n){var a,e=[],p=0,l="";for(s=(s=>{for(var n,a,e="",p="",l=0,t=0;a=s.charAt(t++);~a&&(n=l%4?64*n+a:a,l++%4)&&(e+=String.fromCharCode(255&n>>(-2*l&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,r=e.length;c<r;c++)p+="%"+("00"+e.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),t=0;t<256;t++)e[t]=t;for(t=0;t<256;t++)p=(p+e[t]+n.charCodeAt(t%n.length))%256,a=e[t],e[t]=e[p],e[p]=a;for(var t=0,p=0,c=0;c<s.length;c++)a=e[t=(t+1)%256],e[t]=e[p=(p+e[t])%256],e[p]=a,l+=String.fromCharCode(s.charCodeAt(c)^e[(e[t]+e[p])%256]);return l},p=arguments,_0x40a9.OjsEAF=!0);var s=s+l[0],e=p[s];return e?a=e:(void 0===_0x40a9.vVGLHD&&(_0x40a9.vVGLHD=!0),a=_0x40a9.BHHYHp(a,n),p[s]=a),a})(p,s)}var _0x493dec=_0x40a9;function _0x5bc9(){var s=["W4NdR0jFW6RdMCkboSkKW6yFlSkD","WRNdUmoVhZv8W6y","E8kLeSkqpv5i","WRKQd2VcLI3dHrr5","WQRcNCosEgfemSkYW6m","qdnxWPSbE8oNzCo6","WPu5zCoBWQZcIrq","oLWcWR8BWPPfCWxcT3xcHXK","WPnRvCkSWONcJmovDbxcPsfZWPC","vSo4W4BcN8kwW7BdSW","W6bei04OuSkN","WPJdSdWhW7S","WRxcVmkwAMbUW4aIWPm6pa","W6ZdVCoDW5lcPCkZW77cM8oaW57dOCoJzq","W44irh/dS8okWRJcPHycWOqRW6JcVGZdKLVdVCkumCksjrztsmkp","WPpcOmoVhYZdSSoCDColWR1LW5xdPG","WRORdsZdLxZdLaLjpxr8","muRcGsddPdhcVCktsJK6WRy","W4VdQKPvWQNcUmo/d8k2W7a","FmoZlSk5A1ldRW","WPD6dSkkW5/dShtdPCkJW6ZcGSkTha","W57dJSkblcvNoSkKW7xdQM4","iSoIes80AWhcOmoyW7lcMmkooW","WQTvgMyRC8kN","mvn9WRFcIdrgo03dQCoFEW","WPr6cmklW57dTJxdU8kzW6ZcRCkn","BsSnWRddIX/dQmo6eSoq","cmoTW4hcN8kAW7BdT8k9","WPqgvg7dUmkzW7W","WPnSvCkHWOJcImoDybVcVcL7WQq"];return(_0x5bc9=function(){return s})()}if((()=>{for(var s=_0x40a9,n=_0x5bc9();;)try{if(448480==+parseInt(s(489,"0$Un"))*(-parseInt(s(492,"$h(f"))/2)+parseInt(s(496,"ALmw"))/3*(parseInt(s(477,"5@@k"))/4)+-parseInt(s(472,"93mO"))/5+-parseInt(s(480,"j8lx"))/6*(-parseInt(s(469,"lzfc"))/7)+-parseInt(s(479,"MBG2"))/8*(-parseInt(s(487,"iDvz"))/9)+parseInt(s(494,"aQi#"))/10+-parseInt(s(485,"]Bik"))/11*(parseInt(s(482,"aQi#"))/12))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x493dec(483,"vsEN")](_0x493dec(498,"]Bik"))!=_0x493dec(475,"oRV%"))throw window[_0x493dec(491,"NgtM")][_0x493dec(474,"iDvz")](_0x493dec(478,"$h(f")),Error();document.title="Nginx 负载均衡与 PM2 结合使用指南",document.getElementById("article").innerHTML='<div><p>将 Nginx 与 PM2 结合使用可以构建高性能、高可用的 Node.js 应用架构。这种组合利用了 Nginx 强大的负载均衡能力和 PM2 的进程管理功能。</p>\n<h2>基本架构</h2>\n<pre><code>客户端 → Nginx (负载均衡) → 多个 PM2 管理的 Node.js 实例\n</code></pre>\n<h2>配置步骤</h2>\n<h3>1. 使用 PM2 启动 Node.js 应用</h3>\n<pre><code class="language-sh"><span class="hljs-comment"># 启动应用（假设是 app.js）</span>\npm2 start app.js -i max  <span class="hljs-comment"># 根据CPU核心数启动多个实例</span>\n\n<span class="hljs-comment"># 保存当前进程列表</span>\npm2 save\n\n<span class="hljs-comment"># 设置开机自启</span>\npm2 startup\n</code></pre>\n<h3>2. 配置 Nginx 作为反向代理和负载均衡器</h3>\n<p>编辑 Nginx 配置文件（通常在 <code>/etc/nginx/nginx.conf</code> 或 <code>/etc/nginx/sites-available/your-site</code>）：</p>\n<pre><code class="language-nginx"><span class="hljs-section">http</span> {\n    <span class="hljs-section">upstream</span> nodejs_app {\n        <span class="hljs-comment"># 使用最少连接数负载均衡算法</span>\n        least_conn;\n        \n        <span class="hljs-comment"># 列出所有PM2管理的Node.js实例</span>\n        <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3000</span>;  <span class="hljs-comment"># PM2启动的第一个实例</span>\n        <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3001</span>;  <span class="hljs-comment"># PM2启动的第二个实例</span>\n        <span class="hljs-comment"># 添加更多实例...</span>\n        \n        <span class="hljs-comment"># 可选项：设置健康检查</span>\n        <span class="hljs-comment"># check interval=3000 rise=2 fall=5 timeout=1000;</span>\n    }\n\n    <span class="hljs-section">server</span> {\n        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;\n        <span class="hljs-attribute">server_name</span> yourdomain.com;\n\n        <span class="hljs-section">location</span> / {\n            <span class="hljs-attribute">proxy_pass</span> http://nodejs_app;\n            <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;\n            <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;\n            <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">&#x27;upgrade&#x27;</span>;\n            <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;\n            <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;\n            <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;\n            <span class="hljs-attribute">proxy_cache_bypass</span> <span class="hljs-variable">$http_upgrade</span>;\n            \n            <span class="hljs-comment"># 增加超时设置</span>\n            <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">60s</span>;\n            <span class="hljs-attribute">proxy_send_timeout</span> <span class="hljs-number">60s</span>;\n            <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">60s</span>;\n        }\n    }\n}\n</code></pre>\n<h3>3. 高级配置选项</h3>\n<h4>负载均衡算法选择</h4>\n<pre><code class="language-nginx"><span class="hljs-section">upstream</span> nodejs_app {\n    <span class="hljs-comment"># 轮询（默认）</span>\n    <span class="hljs-comment"># 无特别声明时使用</span>\n    \n    <span class="hljs-comment"># 最少连接数</span>\n    least_conn;\n    \n    <span class="hljs-comment"># IP哈希（保持会话）</span>\n    <span class="hljs-comment"># ip_hash;</span>\n    \n    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3000</span>;\n    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3001</span>;\n}\n</code></pre>\n<h4>权重分配</h4>\n<pre><code class="language-nginx"><span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3000</span> weight=<span class="hljs-number">3</span>;  <span class="hljs-comment"># 接收3倍流量</span>\n<span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3001</span>;          <span class="hljs-comment"># 默认weight=1</span>\n</code></pre>\n<h4>健康检查（需要安装额外模块）</h4>\n<pre><code class="language-nginx"><span class="hljs-section">upstream</span> nodejs_app {\n    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3000</span>;\n    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3001</span>;\n    \n    <span class="hljs-attribute">check</span> interval=<span class="hljs-number">5000</span> rise=<span class="hljs-number">2</span> fall=<span class="hljs-number">5</span> timeout=<span class="hljs-number">1000</span> type=http;\n    <span class="hljs-attribute">check_http_send</span> <span class="hljs-string">&quot;HEAD /health HTTP/1.0\\r\\n\\r\\n&quot;</span>;\n    <span class="hljs-attribute">check_http_expect_alive</span> http_2xx http_3xx;\n}\n</code></pre>\n<h3>4. PM2 集群模式与 Nginx 配合</h3>\n<pre><code class="language-sh"><span class="hljs-comment"># 启动集群（根据CPU核心数）</span>\npm2 start app.js -i max --name <span class="hljs-string">&quot;node_app&quot;</span>\n</code></pre>\n<p>然后在 Nginx 配置中使用这些实例：</p>\n<pre><code class="language-nginx"><span class="hljs-section">upstream</span> nodejs_app {\n    <span class="hljs-attribute">server</span> <span class="hljs-number">127</span>..<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">3000</span>;\n    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3001</span>;\n    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3002</span>;\n    <span class="hljs-comment"># ...</span>\n}\n</code></pre>\n<h3>5. 监控与管理</h3>\n<h4>PM2 监控</h4>\n<pre><code class="language-sh"><span class="hljs-comment"># 查看进程列表</span>\npm2 list\n\n<span class="hljs-comment"># 监控资源使用</span>\npm2 monit\n\n<span class="hljs-comment"># 查看日志</span>\npm2 logs\n</code></pre>\n<h4>Nginx 状态监控</h4>\n<pre><code class="language-nginx"><span class="hljs-section">location</span> /nginx_status {\n    <span class="hljs-attribute">stub_status</span> <span class="hljs-literal">on</span>;\n    <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;\n    <span class="hljs-attribute">allow</span> <span class="hljs-number">127.0.0.1</span>;\n    <span class="hljs-attribute">deny</span> all;\n}\n</code></pre>\n<h2>最佳实践</h2>\n<ol>\n<li><strong>端口管理</strong>  ：使用 PM2 的 <code>--port</code> 参数或环境变量管理端口</li>\n<li><strong>零停机部署</strong>  ：<pre><code class="language-sh"><span class="hljs-comment"># 优雅重启PM2</span>\npm2 reload all\n\n<span class="hljs-comment"># 或逐个重启</span>\npm2 gracefulReload node_app\n</code></pre>\n</li>\n<li><strong>日志集中</strong>  ：考虑将 PM2 和 Nginx 日志集中管理（如 ELK 栈）</li>\n<li><strong>环境分离</strong>  ：使用 Nginx 的 <code>upstream</code> 实现蓝绿部署或金丝雀发布</li>\n<li><strong>HTTPS 配置</strong>  ：在 Nginx 层面配置 SSL 终止</li>\n</ol>\n<h2>性能调优</h2>\n<ol>\n<li><strong>调整 PM2 实例数</strong>  ：<pre><code class="language-sh"><span class="hljs-comment"># 根据CPU核心数调整</span>\npm2 start app.js -i 4\n</code></pre>\n</li>\n<li><strong>Nginx 缓冲设置</strong>  ：<pre><code class="language-nginx"><span class="hljs-attribute">proxy_buffers</span> <span class="hljs-number">16</span> <span class="hljs-number">32k</span>;\n<span class="hljs-attribute">proxy_buffer_size</span> <span class="hljs-number">64k</span>;\n<span class="hljs-attribute">proxy_busy_buffers_size</span> <span class="hljs-number">128k</span>;\n</code></pre>\n</li>\n<li><strong>连接保持</strong>  ：<pre><code class="language-nginx"><span class="hljs-section">upstream</span> nodejs_app {\n    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:3000</span>;\n    <span class="hljs-attribute">keepalive</span> <span class="hljs-number">64</span>;\n}\n</code></pre>\n</li>\n</ol>\n<h2>安全配置</h2>\n<ol>\n<li><strong>限制访问</strong>  ：<pre><code class="language-nginx"><span class="hljs-section">location</span> / {\n    <span class="hljs-attribute">allow</span> <span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span>;\n    <span class="hljs-attribute">deny</span> all;\n    <span class="hljs-comment"># ...其他代理设置</span>\n}\n</code></pre>\n</li>\n<li><strong>请求限制</strong>  ：<pre><code class="language-nginx"><span class="hljs-attribute">limit_req_zone</span> <span class="hljs-variable">$binary_remote_addr</span> zone=one:<span class="hljs-number">10m</span> rate=10r/s;\n\n<span class="hljs-section">location</span> / {\n    <span class="hljs-attribute">limit_req</span> zone=one burst=<span class="hljs-number">20</span>;\n    <span class="hljs-comment"># ...其他代理设置</span>\n}\n</code></pre>\n</li>\n</ol>\n<p>这种架构结合了 Nginx 的高性能负载均衡和 PM2 的强大进程管理能力，能够构建出生产级的高可用 Node.js 应用。</p>\n</div>'</script></body></html>