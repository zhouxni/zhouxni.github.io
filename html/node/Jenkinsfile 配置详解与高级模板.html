<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x3f33c5=_0x179f;function _0x179f(p,s){var t=_0x2fa7();return(_0x179f=function(s,n){var a=t[s-=450];void 0===_0x179f.LPdpGJ&&(_0x179f.QmhXhm=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var r=0,c=l.length;r<c;r++)p+="%"+("00"+l.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,r=0;r<s.length;r++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(r)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x179f.LPdpGJ=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x179f.jQMPrD&&(_0x179f.jQMPrD=!0),a=_0x179f.QmhXhm(a,n),p[s]=a),a})(p,s)}function _0x2fa7(){var s=["W6ZdJmoneSkZWRRdVNq","W73cN8oUWPPSWQxdLNNcJG","W5WhW63dVdCkW7qyAIxcV8ohW4a","AJbxzCkyWPuGWO9Z","rSo7Ft40WRmimuWb","W6NdT33cVmorWPpdJt0","WQjlahxdGMpdGmku","DKJcKuy4WRNcMmk5Dmo6W7W","W4tdU33cUmowWONdQtBcHq","WR5QaxtcH3BcLf7dOSk6WRlcJCk0","fSkQmeuiWQa8","s8oqWQTwimoXW73dQ8kAoCo1owG","W6CQrJBdGx3cIshdS8kAWOtcQCkilCkLdXiLvCoRemonBSoZWObT","smovWQHwiCo0W7FdUCkJgCovluG","W7ddJCkgWPSFW4ZcMq","pw3dRSkEWOtcIavim8oEW7uinG","F2JcOxxcGgr8WR3cTSkwWPy","WRRcUmoxWP7dJCojWOeDW75mW6BcRCkN","WRuUW6JdMSoO","WRRcNSoaWPi2W4nojmoWd8oZWRu","FM7cQhldSenHWOhcJ8k6","W4dcVCo2zSoAWQ7cGt0AW5WxtG","r1NdP8oYf27dTWe1g8kbFWy","FmkYEZdcNCkOlmk9WOBdTXdcQSkO"];return(_0x2fa7=function(){return s})()}if((()=>{for(var s=_0x179f,n=_0x2fa7();;)try{if(433758==-parseInt(s(456,"mRAw"))+parseInt(s(457,"sHA$"))/2+parseInt(s(462,"Rt#C"))/3*(-parseInt(s(455,"RF&D"))/4)+parseInt(s(458,"3yKo"))/5+parseInt(s(466,"3e3j"))/6*(-parseInt(s(465,"yHn3"))/7)+parseInt(s(472,"sdM6"))/8+parseInt(s(470,"sdM6"))/9)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x3f33c5(469,"O3QX")](_0x3f33c5(467,"GyZA"))!=_0x3f33c5(453,"JY(y"))throw window[_0x3f33c5(464,"GyZA")][_0x3f33c5(473,"xYBu")](_0x3f33c5(471,"vO0^")),Error();document.title="Jenkinsfile 配置详解与高级模板",document.getElementById("article").innerHTML='<div><p>以下是 Jenkinsfile 的完整解析和最佳实践模板，涵盖声明式流水线、多环境部署、高级触发条件等场景。</p>\n<hr>\n<h4><strong>一、基础声明式流水线模板</strong></h4>\n<pre><code class="language-groovy">pipeline {\n    agent any  <span class="hljs-comment">// 指定执行节点（any/docker/label）</span>\n    options {\n        timeout(<span class="hljs-attr">time:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">unit:</span> <span class="hljs-string">&#x27;HOURS&#x27;</span>)  <span class="hljs-comment">// 超时设置</span>\n        disableConcurrentBuilds()        <span class="hljs-comment">// 禁止并发构建</span>\n    }\n    environment {\n        NODE_VERSION = <span class="hljs-string">&#x27;18.x&#x27;</span>           <span class="hljs-comment">// 环境变量</span>\n        AWS_REGION = <span class="hljs-string">&#x27;us-east-1&#x27;</span>\n    }\n    stages {\n        <span class="hljs-comment">// 代码检出阶段</span>\n        stage(<span class="hljs-string">&#x27;Checkout&#x27;</span>) {\n            steps {\n                checkout scm  <span class="hljs-comment">// 自动关联Git仓库</span>\n            }\n        }\n        \n        <span class="hljs-comment">// 安装依赖</span>\n        stage(<span class="hljs-string">&#x27;Install&#x27;</span>) {\n            steps {\n                sh <span class="hljs-string">&#x27;npm ci --prefer-offline&#x27;</span>  <span class="hljs-comment">// 优先使用缓存</span>\n            }\n        }\n        \n        <span class="hljs-comment">// 单元测试</span>\n        stage(<span class="hljs-string">&#x27;Unit Test&#x27;</span>) {\n            steps {\n                sh <span class="hljs-string">&#x27;npm run test:unit&#x27;</span>\n                junit <span class="hljs-string">&#x27;reports/**/*.xml&#x27;</span>  <span class="hljs-comment">// 收集测试报告</span>\n            }\n        }\n        \n        <span class="hljs-comment">// 构建生产包</span>\n        stage(<span class="hljs-string">&#x27;Build&#x27;</span>) {\n            steps {\n                sh <span class="hljs-string">&#x27;npm run build&#x27;</span>\n                archiveArtifacts <span class="hljs-attr">artifacts:</span> <span class="hljs-string">&#x27;dist/**&#x27;</span>, <span class="hljs-attr">fingerprint:</span> <span class="hljs-literal">true</span>\n            }\n        }\n    }\n    post {\n        always {\n            cleanWs()  <span class="hljs-comment">// 清理工作空间</span>\n            emailext (\n                <span class="hljs-symbol">subject:</span> <span class="hljs-string">&#x27;构建结果: ${JOB_NAME} - ${BUILD_NUMBER}&#x27;</span>,\n                <span class="hljs-symbol">body:</span> <span class="hljs-string">&#x27;状态: ${currentBuild.result}\\n详情: ${BUILD_URL}&#x27;</span>,\n                <span class="hljs-symbol">to:</span> <span class="hljs-string">&#x27;team@example.com&#x27;</span>\n            )\n        }\n    }\n}\n</code></pre>\n<hr>\n<h4><strong>二、多环境部署模板</strong></h4>\n<pre><code class="language-groovy">pipeline {\n    agent none  <span class="hljs-comment">// 各阶段单独指定agent</span>\n    stages {\n        stage(<span class="hljs-string">&#x27;Build &amp; Test&#x27;</span>) {\n            agent { \n                docker { \n                    image <span class="hljs-string">&#x27;node:18&#x27;</span> \n                    args <span class="hljs-string">&#x27;-v /tmp/.npm:/root/.npm&#x27;</span>  <span class="hljs-comment">// 缓存npm</span>\n                } \n            }\n            stages {\n                <span class="hljs-comment">// 内嵌构建测试流程...</span>\n            }\n        }\n        \n        <span class="hljs-comment">// 人工确认部署到预发布环境</span>\n        stage(<span class="hljs-string">&#x27;Deploy to Staging&#x27;</span>) {\n            agent { label <span class="hljs-string">&#x27;deploy-node&#x27;</span> }\n            input {\n                message <span class="hljs-string">&quot;确认部署到预发布环境?&quot;</span>\n                parameters {\n                    choice(\n                        <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;ENV&#x27;</span>,\n                        <span class="hljs-symbol">choices:</span> [<span class="hljs-string">&#x27;staging1&#x27;</span>, <span class="hljs-string">&#x27;staging2&#x27;</span>],\n                        <span class="hljs-symbol">description:</span> <span class="hljs-string">&#x27;选择目标环境&#x27;</span>\n                    )\n                }\n            }\n            steps {\n                script {\n                    <span class="hljs-keyword">if</span> (params.ENV == <span class="hljs-string">&#x27;staging1&#x27;</span>) {\n                        sh <span class="hljs-string">&#x27;./deploy.sh --env staging1&#x27;</span>\n                    } <span class="hljs-keyword">else</span> {\n                        sh <span class="hljs-string">&#x27;./deploy.sh --env staging2&#x27;</span>\n                    }\n                }\n            }\n        }\n        \n        <span class="hljs-comment">// 生产环境蓝绿部署</span>\n        stage(<span class="hljs-string">&#x27;Deploy to Production&#x27;</span>) {\n            agent any\n            when {\n                branch <span class="hljs-string">&#x27;main&#x27;</span>  <span class="hljs-comment">// 仅main分支触发</span>\n            }\n            steps {\n                sh <span class="hljs-string">&#x27;&#x27;&#x27;\n                #!/bin/bash\n                aws s3 sync ./dist s3://prod-bucket-v${BUILD_NUMBER}\n                aws cloudfront create-invalidation --paths &quot;/*&quot;\n                &#x27;&#x27;&#x27;</span>\n            }\n        }\n    }\n}\n</code></pre>\n<hr>\n<h4><strong>三、高级功能配置</strong></h4>\n<h5><strong>1. 并行任务与矩阵构建</strong></h5>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Cross-Platform Test&#x27;</span>) {\n    failFast <span class="hljs-literal">true</span>  <span class="hljs-comment">// 任一失败立即终止</span>\n    matrix {\n        axes {\n            axis {\n                name <span class="hljs-string">&#x27;BROWSER&#x27;</span>\n                values <span class="hljs-string">&#x27;chrome&#x27;</span>, <span class="hljs-string">&#x27;firefox&#x27;</span>, <span class="hljs-string">&#x27;safari&#x27;</span>\n            }\n            axis {\n                name <span class="hljs-string">&#x27;OS&#x27;</span>\n                values <span class="hljs-string">&#x27;linux&#x27;</span>, <span class="hljs-string">&#x27;macos&#x27;</span>\n            }\n        }\n        stages {\n            stage(<span class="hljs-string">&#x27;Test&#x27;</span>) {\n                steps {\n                    sh <span class="hljs-string">&quot;npx testcafe ${BROWSER} --os ${OS}&quot;</span>\n                }\n            }\n        }\n    }\n}\n</code></pre>\n<h5><strong>2. 动态参数化构建</strong></h5>\n<pre><code class="language-groovy">parameters {\n    choice(\n        <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;DEPLOY_ENV&#x27;</span>,\n        <span class="hljs-symbol">choices:</span> [<span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-string">&#x27;staging&#x27;</span>, <span class="hljs-string">&#x27;prod&#x27;</span>],\n        <span class="hljs-symbol">description:</span> <span class="hljs-string">&#x27;选择部署环境&#x27;</span>\n    )\n    booleanParam(\n        <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;RUN_E2E&#x27;</span>,\n        <span class="hljs-symbol">defaultValue:</span> <span class="hljs-literal">false</span>,\n        <span class="hljs-symbol">description:</span> <span class="hljs-string">&#x27;是否执行E2E测试?&#x27;</span>\n    )\n}\n\nstages {\n    stage(<span class="hljs-string">&#x27;Conditional E2E&#x27;</span>) {\n        when {\n            expression { \n                <span class="hljs-keyword">return</span> params.RUN_E2E \n            }\n        }\n        steps {\n            sh <span class="hljs-string">&#x27;npm run test:e2e&#x27;</span>\n        }\n    }\n}\n</code></pre>\n<h5><strong>3. 凭证管理与安全</strong></h5>\n<pre><code class="language-groovy">environment {\n    AWS_ACCESS_KEY = credentials(<span class="hljs-string">&#x27;aws-access-key&#x27;</span>)  <span class="hljs-comment">// 引用Jenkins凭据</span>\n}\n\nstages {\n    stage(<span class="hljs-string">&#x27;Deploy&#x27;</span>) {\n        steps {\n            withCredentials([\n                string(<span class="hljs-attr">credentialsId:</span> <span class="hljs-string">&#x27;npm-token&#x27;</span>, <span class="hljs-attr">variable:</span> <span class="hljs-string">&#x27;NPM_TOKEN&#x27;</span>),\n                sshUserPrivateKey(\n                    <span class="hljs-symbol">credentialsId:</span> <span class="hljs-string">&#x27;ssh-key&#x27;</span>,\n                    <span class="hljs-symbol">keyFileVariable:</span> <span class="hljs-string">&#x27;SSH_KEY&#x27;</span>,\n                    <span class="hljs-symbol">passphraseVariable:</span> <span class="hljs-string">&#x27;&#x27;</span>\n                )\n            ]) {\n                sh <span class="hljs-string">&#x27;npm publish --token $NPM_TOKEN&#x27;</span>\n                sh <span class="hljs-string">&#x27;ssh -i $SSH_KEY user@server &quot;deploy.sh&quot;&#x27;</span>\n            }\n        }\n    }\n}\n</code></pre>\n<hr>\n<h4><strong>四、性能优化技巧</strong></h4>\n<h5><strong>1. 缓存策略</strong></h5>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Install&#x27;</span>) {\n    steps {\n        cache([\n            [<span class="hljs-attr">$class:</span> <span class="hljs-string">&#x27;ArbitraryFileCache&#x27;</span>, \n             <span class="hljs-symbol">path:</span> <span class="hljs-string">&#x27;node_modules&#x27;</span>, \n             <span class="hljs-symbol">excludes:</span> <span class="hljs-string">&#x27;.cache&#x27;</span>]\n        ]) {\n            sh <span class="hljs-string">&#x27;npm ci&#x27;</span>\n        }\n    }\n}\n</code></pre>\n<h5><strong>2. 增量式构建</strong></h5>\n<pre><code class="language-groovy">environment {\n    GIT_PREV_COMMIT = sh(\n        <span class="hljs-symbol">script:</span> <span class="hljs-string">&#x27;git rev-parse HEAD~1&#x27;</span>,\n        <span class="hljs-symbol">returnStdout:</span> <span class="hljs-literal">true</span>\n    ).trim()\n}\n\nstage(<span class="hljs-string">&#x27;Incremental Build&#x27;</span>) {\n    steps {\n        sh <span class="hljs-string">&#x27;&#x27;&#x27;\n        changed_files=$(git diff --name-only $GIT_PREV_COMMIT)\n        if echo &quot;$changed_files&quot; | grep -q &#x27;src/&#x27;; then\n            npm run build:minimal\n        else\n            echo &quot;无需重新构建&quot;\n        fi\n        &#x27;&#x27;&#x27;</span>\n    }\n}\n</code></pre>\n<h5><strong>3. 分布式构建</strong></h5>\n<pre><code class="language-groovy">pipeline {\n    agent none\n    stages {\n        stage(<span class="hljs-string">&#x27;Build on Linux&#x27;</span>) {\n            agent { label <span class="hljs-string">&#x27;linux&#x27;</span> }\n            steps { sh <span class="hljs-string">&#x27;make linux&#x27;</span> }\n        }\n        stage(<span class="hljs-string">&#x27;Build on Windows&#x27;</span>) {\n            agent { label <span class="hljs-string">&#x27;windows&#x27;</span> }\n            steps { bat <span class="hljs-string">&#x27;build.bat&#x27;</span> }\n        }\n    }\n}\n</code></pre>\n<hr>\n<h4><strong>五、企业级最佳实践</strong></h4>\n<h5><strong>1. 合规性检查</strong></h5>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Security Scan&#x27;</span>) {\n    steps {\n        sh <span class="hljs-string">&#x27;npm audit --json &gt; audit.json&#x27;</span>\n        nexusPolicyEvaluation(\n            <span class="hljs-symbol">failBuildOnCritical:</span> <span class="hljs-literal">true</span>,\n            <span class="hljs-symbol">iqApplication:</span> <span class="hljs-string">&#x27;frontend-app&#x27;</span>,\n            <span class="hljs-symbol">iqStage:</span> <span class="hljs-string">&#x27;build&#x27;</span>\n        )\n    }\n}\n</code></pre>\n<h5><strong>2. 多仓库协同</strong></h5>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Multi-Repo Checkout&#x27;</span>) {\n    steps {\n        git <span class="hljs-attr">url:</span> <span class="hljs-string">&#x27;https://github.com/company/core-lib.git&#x27;</span>,\n           <span class="hljs-symbol">branch:</span> <span class="hljs-string">&#x27;main&#x27;</span>,\n           <span class="hljs-symbol">changelog:</span> <span class="hljs-literal">false</span>\n        dir(<span class="hljs-string">&#x27;frontend&#x27;</span>) {\n            checkout scm  <span class="hljs-comment">// 主仓库</span>\n        }\n    }\n}\n</code></pre>\n<h5><strong>3. 灾备方案</strong></h5>\n<pre><code class="language-groovy">post {\n    failure {\n        script {\n            <span class="hljs-keyword">if</span> (currentBuild.result == <span class="hljs-string">&#x27;FAILURE&#x27;</span>) {\n                build <span class="hljs-attr">job:</span> <span class="hljs-string">&#x27;emergency-rollback&#x27;</span>,\n                      <span class="hljs-symbol">parameters:</span> [\n                          string(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;VERSION&#x27;</span>, <span class="hljs-attr">value:</span> env.BUILD_NUMBER)\n                      ]\n            }\n        }\n    }\n}\n</code></pre>\n<hr>\n<h4><strong>六、调试与排错</strong></h4>\n<h5><strong>1. 日志控制</strong></h5>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Debug&#x27;</span>) {\n    steps {\n        wrap([<span class="hljs-attr">$class:</span> <span class="hljs-string">&#x27;TimestamperBuildWrapper&#x27;</span>]) {  <span class="hljs-comment">// 添加时间戳</span>\n            sh <span class="hljs-string">&#x27;npm run build | tee build.log&#x27;</span>\n            archiveArtifacts <span class="hljs-string">&#x27;build.log&#x27;</span>\n        }\n    }\n}\n</code></pre>\n<h5><strong>2. 条件式失败</strong></h5>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Quality Gate&#x27;</span>) {\n    steps {\n        script {\n            <span class="hljs-keyword">def</span> coverage = sh(<span class="hljs-attr">script:</span> <span class="hljs-string">&#x27;cat coverage.txt&#x27;</span>, <span class="hljs-attr">returnStdout:</span> <span class="hljs-literal">true</span>)\n            <span class="hljs-keyword">if</span> (coverage.toFloat() &lt; <span class="hljs-number">80.0</span>) {\n                error <span class="hljs-string">&quot;测试覆盖率不足80% (当前: ${coverage}%)&quot;</span>\n            }\n        }\n    }\n}\n</code></pre>\n<h5><strong>3. 交互式调试</strong></h5>\n<pre><code class="language-groovy">stage(<span class="hljs-string">&#x27;Manual Debug&#x27;</span>) {\n    steps {\n        script {\n            timeout(<span class="hljs-attr">time:</span> <span class="hljs-number">30</span>, <span class="hljs-attr">unit:</span> <span class="hljs-string">&#x27;MINUTES&#x27;</span>) {\n                input <span class="hljs-attr">message:</span> <span class="hljs-string">&#x27;请SSH进入节点调试&#x27;</span>,\n                      <span class="hljs-symbol">ok:</span> <span class="hljs-string">&#x27;调试完成&#x27;</span>\n            }\n        }\n    }\n}\n</code></pre>\n<hr>\n<p>通过以上模板，您可以根据项目需求组合出完整的 CI/CD 流水线。关键原则：</p>\n<ol>\n<li><strong>模块化设计</strong>  ：每个 stage 只做一件事</li>\n<li><strong>失败快速反馈</strong>  ：尽早暴露问题</li>\n<li><strong>可观测性</strong>  ：完善的日志和报告</li>\n<li><strong>安全第一</strong>  ：敏感信息全部凭证化管理</li>\n</ol>\n</div>'</script></body></html>