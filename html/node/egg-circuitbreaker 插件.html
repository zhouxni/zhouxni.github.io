<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x55bd64=_0x581d;function _0x3cd5(){var s=["W7/dUSk5w8kEa0pcTW","cIldUCkPCCoWibu","W63cR2qYWQ/dGa/dO1K","W5S5W57dI8oscH0WWQK3qmkyWQW","jaa3WQb8uSkZBhFcOSk9l8ownYBcTWdcQSkfnCo/W5aukxCj","WP3dVgqKWQtdUHBdQW","W7hdJ8k3os0sxrGviqqzCa","dItcUmo6oSowmH9QWOKh","WRJcJmoSW4vnzmkA","WRngW4BdNc9tz8oS","W6ZdNmkHWR8jm8ogiCkZoqy7ve4","eHaRy0ugW5C","WQ3cJsBdGCkzW7/cINRdIINdSSowhW","W6znedlcPmkyyfDzWPr/EmkR","c08HdSoi","j8kXW6amW75RWRavaXOw","WOmbW6pcLSosdvW2","W5HxWRtdHCkwuqu+oa3cR8oRpG","EKf7W6HOcSo0n2xcMq","ashcUCo2o8k1gsbqWRKqtq","AmkTW5/dHSopW7/cOa","WPCPWOyGiZldQNpcUwJdO8obWPe","q0KpemoBWRRcQmky","WP4yWOtdS24Fl8kn","W5HirCoHWOZdP8oqWRbAb8oxqa","j8k3W64nWQfCWOiZbsW","WPaycbRdG8odvq","lSooEsmvc8oNWPhcU8kXW7KQWONcUq"];return(_0x3cd5=function(){return s})()}function _0x581d(l,s){var t=_0x3cd5();return(_0x581d=function(s,a){var n=t[s-=332];void 0===_0x581d.IYpqwG&&(_0x581d.kqaoTl=function(s,a){var n,p=[],l=0,t="";for(s=(s=>{for(var a,n,p="",l="",t=0,c=0;n=s.charAt(c++);~n&&(a=t%4?64*a+n:n,t++%4)&&(p+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,r=p.length;e<r;e++)l+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)p[c]=c;for(c=0;c<256;c++)l=(l+p[c]+a.charCodeAt(c%a.length))%256,n=p[c],p[c]=p[l],p[l]=n;for(var c=0,l=0,e=0;e<s.length;e++)n=p[c=(c+1)%256],p[c]=p[l=(l+p[c])%256],p[l]=n,t+=String.fromCharCode(s.charCodeAt(e)^p[(p[c]+p[l])%256]);return t},l=arguments,_0x581d.IYpqwG=!0);var s=s+t[0],p=l[s];return p?n=p:(void 0===_0x581d.PXBSvP&&(_0x581d.PXBSvP=!0),n=_0x581d.kqaoTl(n,a),l[s]=n),n})(l,s)}if((()=>{for(var s=_0x581d,a=_0x3cd5();;)try{if(798163==-parseInt(s(333,"dBsd"))*(parseInt(s(335,"JvhE"))/2)+-parseInt(s(357,"b0zz"))/3+parseInt(s(344,"Dvgx"))/4*(-parseInt(s(355,"dBsd"))/5)+-parseInt(s(343,"eeyh"))/6+-parseInt(s(350,"FPmc"))/7*(-parseInt(s(337,"AB(I"))/8)+parseInt(s(347,"0C)E"))/9+-parseInt(s(354,"$Mha"))/10*(-parseInt(s(353,"aeM]"))/11))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x55bd64(334,"q#F)")](_0x55bd64(356,"II%J"))!=_0x55bd64(340,"(wUT"))throw window[_0x55bd64(342,"eeyh")][_0x55bd64(346,"Z0ax")](_0x55bd64(358,"Dvgx")),Error();document.title="egg-circuitbreaker 插件",document.getElementById("article").innerHTML='<div><p><code>egg-circuitbreaker</code> 是一个基于 <strong>断路器模式</strong>   的 Egg.js 插件，用于在分布式系统中防止级联故障。当依赖服务出现问题时，断路器会自动熔断请求并返回降级数据，避免系统资源被耗尽。以下是关于它的详细介绍和使用指南：</p>\n<h3><strong>一、安装插件</strong></h3>\n<pre><code class="language-sh">npm i egg-circuitbreaker --save\n</code></pre>\n<h3><strong>二、启用插件</strong></h3>\n<p>在 <code>config/plugin.ts</code> 中启用：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// config/plugin.ts</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">circuitbreaker</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-circuitbreaker&#x27;</span>,\n  },\n};\n</code></pre>\n<h3><strong>三、基本配置</strong></h3>\n<p>在 <code>config/config.default.ts</code> 中配置断路器参数：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// config/config.default.ts</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">circuitbreaker</span>: {\n    <span class="hljs-comment">// 全局默认配置</span>\n    <span class="hljs-attr">default</span>: {\n      <span class="hljs-attr">timeout</span>: <span class="hljs-number">1000</span>,          <span class="hljs-comment">// 请求超时时间（毫秒）</span>\n      <span class="hljs-attr">maxFailures</span>: <span class="hljs-number">5</span>,         <span class="hljs-comment">// 连续失败次数阈值</span>\n      <span class="hljs-attr">resetTimeout</span>: <span class="hljs-number">5000</span>,     <span class="hljs-comment">// 熔断后尝试恢复的时间（毫秒）</span>\n      <span class="hljs-attr">enableFallback</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 是否启用降级</span>\n    },\n    \n    <span class="hljs-comment">// 针对特定服务的配置</span>\n    <span class="hljs-attr">services</span>: {\n      <span class="hljs-attr">redisService</span>: {\n        <span class="hljs-attr">maxFailures</span>: <span class="hljs-number">3</span>,\n        <span class="hljs-attr">resetTimeout</span>: <span class="hljs-number">10000</span>,  <span class="hljs-comment">// Redis 服务熔断恢复时间更长</span>\n      },\n      <span class="hljs-attr">userService</span>: {\n        <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span>,        <span class="hljs-comment">// 用户服务允许更长的超时时间</span>\n      },\n    },\n  },\n};\n</code></pre>\n<h3><strong>四、使用方式</strong></h3>\n<h4>1. <strong>装饰器方式（推荐）</strong></h4>\n<p>在 Service 方法上使用 <code>@CircuitBreaker</code> 装饰器：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// app/service/redisService.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Service</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;egg&#x27;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CircuitBreaker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;egg-circuitbreaker&#x27;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-meta">@CircuitBreaker</span>({\n    <span class="hljs-attr">serviceKey</span>: <span class="hljs-string">&#x27;redisService&#x27;</span>, <span class="hljs-comment">// 服务标识</span>\n    <span class="hljs-attr">fallback</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">code</span>: <span class="hljs-number">503</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Redis 服务暂时不可用&#x27;</span> }), <span class="hljs-comment">// 降级函数</span>\n  })\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params"><span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">app</span>.<span class="hljs-property">redis</span>.<span class="hljs-title function_">get</span>(key);\n  }\n\n  <span class="hljs-meta">@CircuitBreaker</span>({\n    <span class="hljs-attr">serviceKey</span>: <span class="hljs-string">&#x27;redisService&#x27;</span>,\n    <span class="hljs-attr">fallback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">false</span>, <span class="hljs-comment">// 降级返回值</span>\n  })\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">set</span>(<span class="hljs-params"><span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">ttl</span>: <span class="hljs-built_in">number</span></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">app</span>.<span class="hljs-property">redis</span>.<span class="hljs-title function_">set</span>(key, value, <span class="hljs-string">&#x27;EX&#x27;</span>, ttl);\n  }\n}\n</code></pre>\n<h4>2. <strong>手动调用方式</strong></h4>\n<pre><code class="language-typescript"><span class="hljs-comment">// app/service/userService.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Service</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;egg&#x27;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span></span>) {\n    <span class="hljs-keyword">const</span> circuit = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">app</span>.<span class="hljs-property">circuitbreaker</span>.<span class="hljs-title function_">create</span>({\n      <span class="hljs-attr">serviceKey</span>: <span class="hljs-string">&#x27;userService&#x27;</span>,\n      <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span>,\n      <span class="hljs-attr">fallback</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">id</span>: -<span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;默认用户&#x27;</span> }),\n    });\n    \n    <span class="hljs-keyword">return</span> circuit.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-comment">// 实际服务调用</span>\n      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">curl</span>(<span class="hljs-string">`https://api.example.com/users/<span class="hljs-subst">${id}</span>`</span>, {\n        <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span>,\n        <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,\n      });\n    });\n  }\n}\n</code></pre>\n<h3><strong>五、降级策略</strong></h3>\n<h4>1. <strong>静态降级数据</strong></h4>\n<pre><code class="language-typescript"><span class="hljs-meta">@CircuitBreaker</span>({\n  <span class="hljs-attr">serviceKey</span>: <span class="hljs-string">&#x27;productService&#x27;</span>,\n  <span class="hljs-attr">fallback</span>: <span class="hljs-function">() =&gt;</span> ({\n    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,\n    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;商品服务暂时不可用&#x27;</span>,\n    <span class="hljs-attr">data</span>: [{ <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;默认商品&#x27;</span> }],\n  }),\n})\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">getProducts</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://api.example.com/products&#x27;</span>);\n}\n</code></pre>\n<h4>2. <strong>动态降级逻辑</strong></h4>\n<pre><code class="language-typescript"><span class="hljs-meta">@CircuitBreaker</span>({\n  <span class="hljs-attr">serviceKey</span>: <span class="hljs-string">&#x27;orderService&#x27;</span>,\n  <span class="hljs-attr">fallback</span>: <span class="hljs-title function_">async</span> () =&gt; {\n    <span class="hljs-comment">// 尝试从本地缓存获取</span>\n    <span class="hljs-keyword">const</span> cacheData = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">app</span>.<span class="hljs-property">redis</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;order-cache&#x27;</span>);\n    <span class="hljs-keyword">if</span> (cacheData) <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(cacheData);\n    \n    <span class="hljs-comment">// 无缓存时返回默认值</span>\n    <span class="hljs-keyword">return</span> { <span class="hljs-attr">orders</span>: [] };\n  },\n})\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">getOrders</span>(<span class="hljs-params"><span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span></span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">curl</span>(<span class="hljs-string">`https://api.example.com/orders/<span class="hljs-subst">${userId}</span>`</span>);\n}\n</code></pre>\n<h3><strong>六、事件监听</strong></h3>\n<p>监听断路器状态变化事件：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// app.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  <span class="hljs-comment">// 断路器打开事件</span>\n  app.<span class="hljs-property">circuitbreaker</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;circuitOpen&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">serviceKey, stats</span>) =&gt;</span> {\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`服务 <span class="hljs-subst">${serviceKey}</span> 已熔断，失败次数: <span class="hljs-subst">${stats.failures}</span>`</span>);\n    <span class="hljs-comment">// 发送告警通知</span>\n    app.<span class="hljs-property">service</span>.<span class="hljs-property">alert</span>.<span class="hljs-title function_">send</span>(<span class="hljs-string">`服务 <span class="hljs-subst">${serviceKey}</span> 熔断告警`</span>);\n  });\n\n  <span class="hljs-comment">// 断路器关闭事件</span>\n  app.<span class="hljs-property">circuitbreaker</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;circuitClose&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">serviceKey</span>) =&gt;</span> {\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`服务 <span class="hljs-subst">${serviceKey}</span> 已恢复`</span>);\n  });\n\n  <span class="hljs-comment">// 断路器半开事件</span>\n  app.<span class="hljs-property">circuitbreaker</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;circuitHalfOpen&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">serviceKey</span>) =&gt;</span> {\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`服务 <span class="hljs-subst">${serviceKey}</span> 尝试恢复`</span>);\n  });\n};\n</code></pre>\n<h3><strong>七、高级配置</strong></h3>\n<h4>1. <strong>自定义失败判断</strong></h4>\n<pre><code class="language-typescript"><span class="hljs-meta">@CircuitBreaker</span>({\n  <span class="hljs-attr">serviceKey</span>: <span class="hljs-string">&#x27;paymentService&#x27;</span>,\n  <span class="hljs-attr">isFailure</span>: <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {\n    <span class="hljs-comment">// 自定义失败判断逻辑（如业务状态码）</span>\n    <span class="hljs-keyword">return</span> result.<span class="hljs-property">code</span> !== <span class="hljs-number">200</span>;\n  },\n})\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params"><span class="hljs-attr">orderId</span>: <span class="hljs-built_in">string</span></span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">curl</span>(<span class="hljs-string">`https://api.example.com/pay/<span class="hljs-subst">${orderId}</span>`</span>);\n}\n</code></pre>\n<h4>2. <strong>自定义熔断器工厂</strong></h4>\n<pre><code class="language-typescript"><span class="hljs-comment">// config/config.default.ts</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {\n  <span class="hljs-attr">circuitbreaker</span>: {\n    <span class="hljs-comment">// 自定义熔断器工厂</span>\n    <span class="hljs-attr">factory</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> {\n      <span class="hljs-keyword">return</span> {\n        <span class="hljs-title function_">create</span>(<span class="hljs-params">options</span>) {\n          <span class="hljs-comment">// 添加自定义逻辑</span>\n          options.<span class="hljs-property">timeout</span> = options.<span class="hljs-property">timeout</span> || <span class="hljs-number">1000</span>;\n          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomCircuitBreaker</span>(options);\n        },\n      };\n    },\n  },\n};\n</code></pre>\n<h3><strong>八、与 Redis 结合使用</strong></h3>\n<p>针对 Redis 请求添加熔断保护：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// app/service/cacheService.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Service</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;egg&#x27;</span>;\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CircuitBreaker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;egg-circuitbreaker&#x27;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-meta">@CircuitBreaker</span>({\n    <span class="hljs-attr">serviceKey</span>: <span class="hljs-string">&#x27;redisCache&#x27;</span>,\n    <span class="hljs-attr">timeout</span>: <span class="hljs-number">500</span>,\n    <span class="hljs-attr">fallback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>,\n  })\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params"><span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">app</span>.<span class="hljs-property">redis</span>.<span class="hljs-title function_">get</span>(key);\n  }\n\n  <span class="hljs-meta">@CircuitBreaker</span>({\n    <span class="hljs-attr">serviceKey</span>: <span class="hljs-string">&#x27;redisCache&#x27;</span>,\n    <span class="hljs-attr">fallback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">false</span>,\n  })\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">set</span>(<span class="hljs-params"><span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>, ttl = <span class="hljs-number">60</span></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">app</span>.<span class="hljs-property">redis</span>.<span class="hljs-title function_">set</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value), <span class="hljs-string">&#x27;EX&#x27;</span>, ttl);\n  }\n}\n</code></pre>\n<h3><strong>九、监控与统计</strong></h3>\n<p>获取断路器状态统计信息：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// app/controller/monitor.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;egg&#x27;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitorController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Controller</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">circuitStats</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">const</span> stats = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">app</span>.<span class="hljs-property">circuitbreaker</span>.<span class="hljs-title function_">getStats</span>();\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">body</span> = stats;\n  }\n}\n</code></pre>\n<p>访问 <code>/api/monitor/circuit-stats</code> 获取：</p>\n<pre><code class="language-json"><span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;redisService&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n    <span class="hljs-attr">&quot;state&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;closed&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;failures&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;successes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1234</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;consecutiveFailures&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;lastFailure&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;lastSuccess&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-10-15T12:00:00.000Z&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;timeout&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;openTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>\n  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;userService&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n    <span class="hljs-attr">&quot;state&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;open&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;failures&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;consecutiveFailures&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;lastFailure&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-10-15T12:01:30.000Z&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;timeout&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;openTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1697361690000</span>\n  <span class="hljs-punctuation">}</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n<h3><strong>十、注意事项</strong></h3>\n<ol>\n<li><strong>服务标识唯一性</strong>  ：确保 <code>serviceKey</code> 全局唯一，否则会影响熔断判断。</li>\n<li><strong>异步降级函数</strong>  ：如果降级逻辑涉及异步操作（如读取缓存），需使用 <code>async</code> 函数。</li>\n<li><strong>异常处理</strong>  ：熔断降级不会捕获所有异常，建议结合全局异常处理中间件。</li>\n<li><strong>性能影响</strong>  ：断路器本身有一定性能开销，建议仅对关键依赖服务使用。</li>\n</ol>\n<p>通过 <code>egg-circuitbreaker</code>，可以轻松实现服务熔断降级，提升系统稳定性和容错能力。</p>\n</div>'</script></body></html>