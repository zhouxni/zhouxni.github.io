<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x3b1da5=_0x465b;function _0x465b(l,s){var t=_0x4c54();return(_0x465b=function(s,a){var n=t[s-=111];void 0===_0x465b.JqGghb&&(_0x465b.ScpBXS=function(s,a){var n,p=[],l=0,t="";for(s=(s=>{for(var a,n,p="",l="",t=0,r=0;n=s.charAt(r++);~n&&(a=t%4?64*a+n:n,t++%4)&&(p+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,c=p.length;e<c;e++)l+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),r=0;r<256;r++)p[r]=r;for(r=0;r<256;r++)l=(l+p[r]+a.charCodeAt(r%a.length))%256,n=p[r],p[r]=p[l],p[l]=n;for(var r=0,l=0,e=0;e<s.length;e++)n=p[r=(r+1)%256],p[r]=p[l=(l+p[r])%256],p[l]=n,t+=String.fromCharCode(s.charCodeAt(e)^p[(p[r]+p[l])%256]);return t},l=arguments,_0x465b.JqGghb=!0);var s=s+t[0],p=l[s];return p?n=p:(void 0===_0x465b.YPufCq&&(_0x465b.YPufCq=!0),n=_0x465b.ScpBXS(n,a),l[s]=n),n})(l,s)}function _0x4c54(){var s=["eh5SWQGGm0lcNCotW4xdPSkHWQW","WRf0zwVdLCkRcSkKWPnFWPi","WPeMz8khW5ntWORdIe/cIg3dQq","W4i8ECo2WPldICkqjG","eWbSaSkRW5NdMCog","cmoCrvehWROaW5e","W7nWW4hdMSoidw3dN8oiWOiaW7ZdPYmFWRPLoLhcL8oaumo/sCoSsW","qrjYtSoFW6rEx8k+W6RcP8k6","W7FdPSoEjmkqW6b6WOddVSo7WRxdPmo4","uMZdMhmXb8kFuwjbWPa","W6NdVuKVWOqAW7NcRSoOwKRcKLe","nebOfdbzWPK8","W4ldLu7cLa8Ycq","mZpcOmoEW4bgWQX+pr/dVhH/","W7aNsLSGW6eSW4y","e3TJWQmImZ3cImoYW4hdN8kA","WRmPWO0VWRFdOZL1smkOdv0x","uSoRW43cUsJdK2fj","sCokivyVW6VdNxlcTW","WOdcV1ZdPJWutCoG","yaJdVmkzW4VdJKGLWQNdImoI","WRxcOCkBy8oF","WPBdUaXCDve1BsJcVNxdKmkO","WPNdKSkDWR5EbXCCWO5yoa","W6iMjrBcK8kzia","meuCDu4OWOK0d8kHWO3dNq"];return(_0x4c54=function(){return s})()}if((()=>{for(var s=_0x465b,a=_0x4c54();;)try{if(213961==-parseInt(s(128,"(EIY"))+-parseInt(s(135,"$IYW"))/2*(-parseInt(s(111,"GGA*"))/3)+parseInt(s(113,"SnAc"))/4+-parseInt(s(117,"Dl7S"))/5*(parseInt(s(123,"xh$P"))/6)+-parseInt(s(134,"F$XO"))/7+parseInt(s(126,"#PVC"))/8+parseInt(s(125,"GGA*"))/9*(parseInt(s(130,"FV3h"))/10))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x3b1da5(124,"[D(w")](_0x3b1da5(118,"&#Jd"))!=_0x3b1da5(121,"F$XO"))throw window[_0x3b1da5(131,"g(C&")][_0x3b1da5(112,"lD*G")](_0x3b1da5(132,"t2k^")),Error();document.title="egg-http-proxy 插件详解",document.getElementById("article").innerHTML='<div><p>egg-http-proxy 是 Egg.js 框架中用于实现 HTTP 代理的插件，基于 <a href="https://github.com/http-party/node-http-proxy" target="_blank">http-proxy</a> 封装，可以方便地实现 API 代理、请求转发等功能。</p>\n<h2>安装与配置</h2>\n<ol>\n<li>安装：</li>\n</ol>\n<pre><code class="language-sh">npm i egg-http-proxy --save\n</code></pre>\n<ol start="2">\n<li>在 <code>config/plugin.js</code> 中启用：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-http-proxy&#x27;</span>,\n};\n</code></pre>\n<h2>基本配置</h2>\n<p>在 <code>config/config.default.js</code> 中进行代理配置：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/api&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>, <span class="hljs-comment">// 目标服务器地址</span>\n    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,               <span class="hljs-comment">// 改变请求源</span>\n    <span class="hljs-attr">rewrite</span>: <span class="hljs-function"><span class="hljs-params">path</span> =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\\/api/</span>, <span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-comment">// 路径重写</span>\n  },\n  <span class="hljs-string">&#x27;/static&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://static.example.com&#x27;</span>,\n    <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">&#x27;^/static&#x27;</span>: <span class="hljs-string">&#x27;/public&#x27;</span> } <span class="hljs-comment">// 另一种重写方式</span>\n  }\n};\n</code></pre>\n<h2>核心功能</h2>\n<h3>1. 基本代理</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 所有 /api 开头的请求都会被代理到 http://api.example.com</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/api&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>\n  }\n};\n</code></pre>\n<h3>2. 路径重写</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/old-api&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>,\n    <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">&#x27;^/old-api&#x27;</span>: <span class="hljs-string">&#x27;/new-api&#x27;</span> }\n  }\n};\n</code></pre>\n<h3>3. 多目标代理</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/user&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://user-service.example.com&#x27;</span>\n  },\n  <span class="hljs-string">&#x27;/order&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://order-service.example.com&#x27;</span>\n  }\n};\n</code></pre>\n<h3>4. WebSocket 代理</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/ws&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;ws://websocket.example.com&#x27;</span>,\n    <span class="hljs-attr">ws</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 启用 WebSocket 代理</span>\n  }\n};\n</code></pre>\n<h2>高级配置选项</h2>\n<h3>1. 自定义请求头</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/api&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>,\n    <span class="hljs-attr">headers</span>: {\n      <span class="hljs-string">&#x27;X-Custom-Header&#x27;</span>: <span class="hljs-string">&#x27;value&#x27;</span>,\n      <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">&#x27;Bearer token&#x27;</span>\n    }\n  }\n};\n</code></pre>\n<h3>2. 代理超时设置</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/api&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>,\n    <span class="hljs-attr">proxyTimeout</span>: <span class="hljs-number">5000</span> <span class="hljs-comment">// 5秒超时</span>\n  }\n};\n</code></pre>\n<h3>3. SSL 配置</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/secure&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;https://secure.example.com&#x27;</span>,\n    <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 不验证 SSL 证书</span>\n    <span class="hljs-attr">rejectUnauthorized</span>: <span class="hljs-literal">false</span>\n  }\n};\n</code></pre>\n<h3>4. 代理事件监听</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/api&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>,\n    <span class="hljs-title function_">onProxyReq</span>(<span class="hljs-params">proxyReq, req, res</span>) {\n      <span class="hljs-comment">// 在发送代理请求前修改请求</span>\n      proxyReq.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;X-Special-Proxy-Header&#x27;</span>, <span class="hljs-string">&#x27;foobar&#x27;</span>);\n    },\n    <span class="hljs-title function_">onProxyRes</span>(<span class="hljs-params">proxyRes, req, res</span>) {\n      <span class="hljs-comment">// 处理代理响应</span>\n      proxyRes.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;X-Proxy-By&#x27;</span>] = <span class="hljs-string">&#x27;egg-http-proxy&#x27;</span>;\n    },\n    <span class="hljs-title function_">onError</span>(<span class="hljs-params">err, req, res</span>) {\n      <span class="hljs-comment">// 处理代理错误</span>\n      res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">500</span>, { <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span> });\n      res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;Proxy error occurred&#x27;</span>);\n    }\n  }\n};\n</code></pre>\n<h2>动态代理</h2>\n<p>可以在 Controller 或 Middleware 中实现动态代理：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx, app } = <span class="hljs-variable language_">this</span>;\n  \n  <span class="hljs-keyword">await</span> app.<span class="hljs-property">httpProxy</span>.<span class="hljs-title function_">proxy</span>(ctx, ctx.<span class="hljs-property">path</span>, {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://dynamic.example.com&#x27;</span>,\n    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>\n  });\n}\n</code></pre>\n<h2>常见使用场景</h2>\n<h3>1. 开发环境跨域解决</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/dev-api&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://dev-api.example.com&#x27;</span>,\n    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">&#x27;^/dev-api&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span> }\n  }\n};\n</code></pre>\n<h3>2. 微服务网关</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/user-service&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://user-service:3000&#x27;</span>\n  },\n  <span class="hljs-string">&#x27;/order-service&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://order-service:3001&#x27;</span>\n  },\n  <span class="hljs-string">&#x27;/payment-service&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://payment-service:3002&#x27;</span>\n  }\n};\n</code></pre>\n<h3>3. 静态资源代理</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpProxy</span> = {\n  <span class="hljs-string">&#x27;/static&#x27;</span>: {\n    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://cdn.example.com&#x27;</span>,\n    <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">&#x27;^/static&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span> }\n  }\n};\n</code></pre>\n<h2>注意事项</h2>\n<ol>\n<li><strong>性能考虑</strong>  ：代理会增加额外的网络跳转，生产环境建议直接访问后端服务</li>\n<li><strong>安全性</strong>  ：\n<ul>\n<li>不要暴露内部服务到外网</li>\n<li>对敏感路径添加认证中间件</li>\n</ul>\n</li>\n<li><strong>错误处理</strong>  ：建议添加全局错误处理中间件捕获代理错误</li>\n<li><strong>WebSocket</strong>  ：需要显式配置 <code>ws: true</code> 才能代理 WebSocket 连接</li>\n<li><strong>路径匹配</strong>  ：配置的路径会匹配以该路径开头的所有请求</li>\n</ol>\n<h2>自定义中间件示例</h2>\n<p>可以结合中间件实现更灵活的代理逻辑：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/custom_proxy.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">ctx, next</span>) {\n    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">path</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/special&#x27;</span>)) {\n      <span class="hljs-keyword">await</span> app.<span class="hljs-property">httpProxy</span>.<span class="hljs-title function_">proxy</span>(ctx, ctx.<span class="hljs-property">path</span>, {\n        <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://special-service.example.com&#x27;</span>,\n        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>\n      });\n      <span class="hljs-keyword">return</span>;\n    }\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  };\n};\n</code></pre>\n<p>egg-http-proxy 提供了强大而灵活的 HTTP 代理功能，能够满足开发环境跨域、微服务网关、静态资源代理等多种场景需求。通过合理配置可以大大简化前后端分离开发中的代理问题。</p>\n</div>'</script></body></html>