<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5902(){var s=["fmo+WRtdOmkBjXmVWR7cPCocqSoH","W7ddGCo6WPxdOJ4CWPm3W7CvW4fw","W4n1WR3cMSk+W7OxWOm","emoxWPOZW6PgWR0vW5bKW4ZdSmkb","oIxdMCouCxLVmSk8qajgWQDgt8ofWOuwW5WKtCkBWQnrDgi","aNTkl8k3DCo6vCo9hhOZ","CSkOqCoJkSotuhmM","Ac1LWRhdTeJdH0lcSmov","iItdNSoxEW","W6xcUmoNDgWCWOn+WRPzW5JcTJS","WRddVSkgWO4Njfr9o8oBB8ofWQu","nKhcVSkCW4yOW6hdSxlcL2W","cM0sWP7cO2xdKSkM","ht5cW57dMWNcMSoCpCoFfhG","axzkkCk3FSkSDSoxlhy7W5e","gJTfW5RcIgVcTCoEbmoq","WOuGWP7cHSkAW4ag","W43dLmkjWORdQvOmBM5RpSk+Cq","CSkCrmkIEmohmq","A2pcNSkrmsKXsSkZusy","W6xcVmkemb9YW4vA","y2BcN8kxmxPYB8kvudrxWOu","AxXtWPxcJSksW4y","WQCcWOiupaCm","tHddRSomWOyXW5VdG34","DKZcMmoeWRxdTCkEWRxdNW"];return(_0x5902=function(){return s})()}var _0x4fc593=_0x1fc6;function _0x1fc6(r,s){var l=_0x5902();return(_0x1fc6=function(s,n){var t=l[s-=396];void 0===_0x1fc6.xkmPOQ&&(_0x1fc6.UooaoW=function(s,n){var t,a=[],r=0,l="";for(s=(s=>{for(var n,t,a="",r="",l=0,c=0;t=s.charAt(c++);~t&&(n=l%4?64*n+t:t,l++%4)&&(a+=String.fromCharCode(255&n>>(-2*l&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var p=0,o=a.length;p<o;p++)r+="%"+("00"+a.charCodeAt(p).toString(16)).slice(-2);return decodeURIComponent(r)})(s),c=0;c<256;c++)a[c]=c;for(c=0;c<256;c++)r=(r+a[c]+n.charCodeAt(c%n.length))%256,t=a[c],a[c]=a[r],a[r]=t;for(var c=0,r=0,p=0;p<s.length;p++)t=a[c=(c+1)%256],a[c]=a[r=(r+a[c])%256],a[r]=t,l+=String.fromCharCode(s.charCodeAt(p)^a[(a[c]+a[r])%256]);return l},r=arguments,_0x1fc6.xkmPOQ=!0);var s=s+l[0],a=r[s];return a?t=a:(void 0===_0x1fc6.KozlIH&&(_0x1fc6.KozlIH=!0),t=_0x1fc6.UooaoW(t,n),r[s]=t),t})(r,s)}if((()=>{for(var s=_0x1fc6,n=_0x5902();;)try{if(281018==-parseInt(s(407,"tX&x"))*(parseInt(s(419,"[xO^"))/2)+parseInt(s(401,"ja#("))/3*(-parseInt(s(398,"(Dfg"))/4)+-parseInt(s(421,"%f!["))/5*(-parseInt(s(403,"XyW]"))/6)+-parseInt(s(399,")$#b"))/7+-parseInt(s(417,"wY2N"))/8+parseInt(s(405,"3^uS"))/9+parseInt(s(413,"t7Nz"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x4fc593(418,"0bV1")](_0x4fc593(420,"tX&x"))!=_0x4fc593(404,"wY2N"))throw window[_0x4fc593(408,"hkg(")][_0x4fc593(412,"(Dfg")](_0x4fc593(400,"wY2N")),Error();document.title="Egg-Security æ’ä»¶è¯¦è§£",document.getElementById("article").innerHTML='<div><p><code>egg-security</code> æ˜¯ Egg.js å®˜æ–¹æä¾›çš„å®‰å…¨æ’ä»¶ï¼Œç”¨äºå¢å¼º Web åº”ç”¨çš„å®‰å…¨æ€§ï¼Œé»˜è®¤é›†æˆåœ¨ Egg.js æ¡†æ¶ä¸­ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—å®‰å…¨é˜²æŠ¤æœºåˆ¶ï¼ŒåŒ…æ‹¬ <strong>CSRF é˜²æŠ¤ã€XSS è¿‡æ»¤ã€CSP ç­–ç•¥ã€SSRF é˜²æŠ¤ã€SQL æ³¨å…¥é˜²æŠ¤</strong>   ç­‰ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£æï¼š</p>\n<hr>\n<h2><strong>1. æ ¸å¿ƒåŠŸèƒ½</strong></h2>\n<table>\n<thead>\n<tr>\n<th>åŠŸèƒ½</th>\n<th>ä½œç”¨</th>\n<th>é»˜è®¤å¯ç”¨</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>CSRF é˜²æŠ¤</strong></td>\n<td>é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆPOST/PUT/DELETE è¯·æ±‚éœ€æºå¸¦ tokenï¼‰</td>\n<td>âœ…</td>\n</tr>\n<tr>\n<td><strong>XSS è¿‡æ»¤</strong></td>\n<td>è‡ªåŠ¨è½¬ä¹‰ HTML/JS ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ XSS æ”»å‡»</td>\n<td>âœ…</td>\n</tr>\n<tr>\n<td><strong>CSP ç­–ç•¥</strong></td>\n<td>å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆé™åˆ¶èµ„æºåŠ è½½æ¥æºï¼‰</td>\n<td>âŒï¼ˆéœ€æ‰‹åŠ¨é…ç½®ï¼‰</td>\n</tr>\n<tr>\n<td><strong>SSRF é˜²æŠ¤</strong></td>\n<td>é˜²æ­¢æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼ˆé™åˆ¶å†…ç½‘ IP è®¿é—®ï¼‰</td>\n<td>âœ…</td>\n</tr>\n<tr>\n<td><strong>SQL æ³¨å…¥é˜²æŠ¤</strong></td>\n<td>è¿‡æ»¤ SQL ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ <code>\'</code>ã€<code>&quot;</code>ã€<code>\\</code>ï¼‰</td>\n<td>âœ…</td>\n</tr>\n<tr>\n<td><strong>å®‰å…¨å¤´è®¾ç½®</strong></td>\n<td>è‡ªåŠ¨è®¾ç½® HTTP å®‰å…¨å¤´ï¼ˆå¦‚ <code>X-Frame-Options</code>ï¼‰</td>\n<td>âœ…</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>2. é…ç½®æ–¹å¼</strong></h2>\n<p>åœ¨ <code>config/config.default.js</code> ä¸­é…ç½®ï¼š</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-comment">// ç¦ç”¨ CSRFï¼ˆä¸æ¨èï¼‰</span>\n  <span class="hljs-attr">csrf</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>,\n  },\n  <span class="hljs-comment">// é…ç½® CSP</span>\n  <span class="hljs-attr">csp</span>: {\n    <span class="hljs-attr">policy</span>: {\n      <span class="hljs-string">&#x27;default-src&#x27;</span>: <span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>,\n      <span class="hljs-string">&#x27;script-src&#x27;</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&quot;&#x27;unsafe-inline&#x27;&quot;</span>],\n    },\n  },\n  <span class="hljs-comment">// è‡ªå®šä¹‰ XSS è¿‡æ»¤è§„åˆ™</span>\n  <span class="hljs-attr">xss</span>: {\n    <span class="hljs-attr">escape</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// é»˜è®¤è½¬ä¹‰ HTML</span>\n  },\n};\n</code></pre>\n<hr>\n<h2><strong>3. æ ¸å¿ƒåŠŸèƒ½è¯¦è§£</strong></h2>\n<h3><strong>(1) CSRF é˜²æŠ¤</strong></h3>\n<ul>\n<li><strong>åŸç†</strong>  ï¼šè¦æ±‚æ‰€æœ‰éå®‰å…¨ HTTP æ–¹æ³•ï¼ˆPOST/PUT/DELETEï¼‰å¿…é¡»æºå¸¦ <code>_csrf</code> tokenã€‚</li>\n<li><strong>ä½¿ç”¨æ–¹å¼</strong>  ï¼š\n<ul>\n<li><strong>å‰ç«¯</strong>  ï¼šä» Cookie è·å– <code>csrfToken</code> å¹¶éšè¯·æ±‚å‘é€ï¼š<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;_csrf&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;{{ ctx.csrf }}&quot;</span> /&gt;</span>\n</code></pre>\n</li>\n<li><strong>AJAX</strong>  ï¼š<pre><code class="language-javascript"><span class="hljs-attr">headers</span>: { <span class="hljs-string">&#x27;X-CSRF-TOKEN&#x27;</span>: <span class="hljs-title function_">getCookie</span>(<span class="hljs-string">&#x27;csrfToken&#x27;</span>) }\n</code></pre>\n</li>\n</ul>\n</li>\n<li><strong>ç¦ç”¨</strong>  ï¼ˆä¸æ¨èï¼‰ï¼š<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csrf</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>,\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h3><strong>(2) XSS è¿‡æ»¤</strong></h3>\n<ul>\n<li><strong>é»˜è®¤è¡Œä¸º</strong>  ï¼š\n<ul>\n<li>è½¬ä¹‰è¯·æ±‚å‚æ•°ä¸­çš„ HTML æ ‡ç­¾ï¼ˆå¦‚ <code>&lt;script&gt;</code> â†’ <code>&amp;lt;script&amp;gt;</code>ï¼‰ã€‚</li>\n<li>é€šè¿‡ <code>ctx.escape()</code> æ‰‹åŠ¨è½¬ä¹‰ï¼š<pre><code class="language-javascript">ctx.<span class="hljs-built_in">escape</span>(<span class="hljs-string">&#x27;&lt;script&gt;alert(1)&lt;/script&gt;&#x27;</span>); <span class="hljs-comment">// è¾“å‡º &amp;lt;script&amp;gt;alert(1)&amp;lt;/script&amp;gt;</span>\n</code></pre>\n</li>\n</ul>\n</li>\n<li><strong>å…³é—­è¿‡æ»¤</strong>  ï¼š<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">xss</span>: {\n    <span class="hljs-attr">escape</span>: <span class="hljs-literal">false</span>,\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h3><strong>(3) CSP å†…å®¹å®‰å…¨ç­–ç•¥</strong></h3>\n<ul>\n<li><strong>ä½œç”¨</strong>  ï¼šé™åˆ¶é¡µé¢èµ„æºï¼ˆJS/CSS/å›¾ç‰‡ï¼‰çš„åŠ è½½æ¥æºï¼Œé˜²æ­¢æ¶æ„è„šæœ¬æ³¨å…¥ã€‚</li>\n<li><strong>ç¤ºä¾‹é…ç½®</strong>  ï¼š<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csp</span>: {\n    <span class="hljs-attr">policy</span>: {\n      <span class="hljs-string">&#x27;default-src&#x27;</span>: <span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-comment">// é»˜è®¤åªå…è®¸åŒæº</span>\n      <span class="hljs-string">&#x27;script-src&#x27;</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;https://unpkg.com&#x27;</span>], <span class="hljs-comment">// å…è®¸ unpkg CDN</span>\n    },\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h3><strong>(4) SSRF é˜²æŠ¤</strong></h3>\n<ul>\n<li><strong>åŸç†</strong>  ï¼šç¦æ­¢è¯·æ±‚å†…ç½‘ IPï¼ˆå¦‚ <code>127.0.0.1</code>ã€<code>192.168.x.x</code>ï¼‰ã€‚</li>\n<li><strong>ç»•è¿‡æ–¹å¼</strong>  ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ï¼š<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">ssrf</span>: {\n    <span class="hljs-attr">ipBlackList</span>: [], <span class="hljs-comment">// ç¦ç”¨ IP é»‘åå•</span>\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h3><strong>(5) å®‰å…¨ HTTP å¤´</strong></h3>\n<ul>\n<li>è‡ªåŠ¨è®¾ç½®ä»¥ä¸‹å“åº”å¤´ï¼š\n<ul>\n<li><code>X-Frame-Options</code>: é˜²æ­¢ç‚¹å‡»åŠ«æŒã€‚</li>\n<li><code>X-XSS-Protection</code>: å¯ç”¨æµè§ˆå™¨ XSS è¿‡æ»¤ã€‚</li>\n<li><code>X-Content-Type-Options</code>: ç¦æ­¢ MIME ç±»å‹å—…æ¢ã€‚</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2><strong>4. å¸¸è§é—®é¢˜</strong></h2>\n<h3><strong>Q1: å¦‚ä½•å…è®¸ç‰¹å®šåŸŸåç»•è¿‡ CSPï¼Ÿ</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csp</span>: {\n    <span class="hljs-attr">policy</span>: {\n      <span class="hljs-string">&#x27;script-src&#x27;</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;https://trusted.cdn.com&#x27;</span>],\n    },\n  },\n};\n</code></pre>\n<h3><strong>Q2: å¦‚ä½•å…³é—­ CSRF æ ¡éªŒï¼Ÿ</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csrf</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>,\n  },\n};\n</code></pre>\n<h3><strong>Q3: å¦‚ä½•æ‰‹åŠ¨æ ¡éªŒ CSRF Tokenï¼Ÿ</strong></h3>\n<pre><code class="language-javascript">ctx.<span class="hljs-title function_">assertCsrf</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>.<span class="hljs-property">_csrf</span>);\n</code></pre>\n<h3><strong>Q4: å¦‚ä½•è¿‡æ»¤ JSON è¯·æ±‚ä¸­çš„ XSSï¼Ÿ</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// åœ¨ä¸­é—´ä»¶ä¸­æ‰‹åŠ¨å¤„ç†</span>\n<span class="hljs-keyword">const</span> body = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>;\nctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span> = ctx.<span class="hljs-property">helper</span>.<span class="hljs-title function_">escapeJson</span>(body);\n</code></pre>\n<hr>\n<h2><strong>5. æœ€ä½³å®è·µ</strong></h2>\n<ol>\n<li><strong>ç”Ÿäº§ç¯å¢ƒä¸è¦ç¦ç”¨ CSRF</strong>  ï¼Œé™¤éæ˜¯çº¯ API æœåŠ¡ä¸”å·²ç”¨ JWT/OAuth é˜²æŠ¤ã€‚</li>\n<li><strong>è°¨æ…é…ç½® CSP</strong>  ï¼Œé¿å…è¿‡åº¦å®½æ¾çš„ç­–ç•¥ã€‚</li>\n<li><strong>æ•æ„Ÿæ“ä½œï¼ˆå¦‚ç™»å½•/æ”¯ä»˜ï¼‰</strong>   åº”é¢å¤–å¢åŠ äºŒæ¬¡éªŒè¯ï¼ˆå¦‚çŸ­ä¿¡éªŒè¯ç ï¼‰ã€‚</li>\n<li><strong>å®šæœŸæ›´æ–° Egg.js</strong>  ï¼Œç¡®ä¿å®‰å…¨æ’ä»¶ä¸ºæœ€æ–°ç‰ˆæœ¬ã€‚</li>\n</ol>\n<hr>\n<h2><strong>æ€»ç»“</strong></h2>\n<table>\n<thead>\n<tr>\n<th>å®‰å…¨å¨èƒ</th>\n<th><code>egg-security</code> è§£å†³æ–¹æ¡ˆ</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CSRF</td>\n<td>å¼ºåˆ¶æ ¡éªŒ <code>_csrf</code> token</td>\n</tr>\n<tr>\n<td>XSS</td>\n<td>è‡ªåŠ¨è½¬ä¹‰ HTML/JS</td>\n</tr>\n<tr>\n<td>SSRF</td>\n<td>æ‹¦æˆªå†…ç½‘ IP è¯·æ±‚</td>\n</tr>\n<tr>\n<td>SQL æ³¨å…¥</td>\n<td>è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦</td>\n</tr>\n<tr>\n<td>æ•°æ®æ³„éœ²</td>\n<td>è®¾ç½®å®‰å…¨ HTTP å¤´</td>\n</tr>\n</tbody>\n</table>\n<p>é€šè¿‡åˆç†é…ç½® <code>egg-security</code>ï¼Œå¯ä»¥æ˜¾è‘—æå‡ Egg.js åº”ç”¨çš„å®‰å…¨æ€§ï¼ ğŸ”’</p>\n</div>'</script></body></html>