<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5902(){var s=["fmo+WRtdOmkBjXmVWR7cPCocqSoH","W7ddGCo6WPxdOJ4CWPm3W7CvW4fw","W4n1WR3cMSk+W7OxWOm","emoxWPOZW6PgWR0vW5bKW4ZdSmkb","oIxdMCouCxLVmSk8qajgWQDgt8ofWOuwW5WKtCkBWQnrDgi","aNTkl8k3DCo6vCo9hhOZ","CSkOqCoJkSotuhmM","Ac1LWRhdTeJdH0lcSmov","iItdNSoxEW","W6xcUmoNDgWCWOn+WRPzW5JcTJS","WRddVSkgWO4Njfr9o8oBB8ofWQu","nKhcVSkCW4yOW6hdSxlcL2W","cM0sWP7cO2xdKSkM","ht5cW57dMWNcMSoCpCoFfhG","axzkkCk3FSkSDSoxlhy7W5e","gJTfW5RcIgVcTCoEbmoq","WOuGWP7cHSkAW4ag","W43dLmkjWORdQvOmBM5RpSk+Cq","CSkCrmkIEmohmq","A2pcNSkrmsKXsSkZusy","W6xcVmkemb9YW4vA","y2BcN8kxmxPYB8kvudrxWOu","AxXtWPxcJSksW4y","WQCcWOiupaCm","tHddRSomWOyXW5VdG34","DKZcMmoeWRxdTCkEWRxdNW"];return(_0x5902=function(){return s})()}var _0x4fc593=_0x1fc6;function _0x1fc6(r,s){var l=_0x5902();return(_0x1fc6=function(s,n){var t=l[s-=396];void 0===_0x1fc6.xkmPOQ&&(_0x1fc6.UooaoW=function(s,n){var t,a=[],r=0,l="";for(s=(s=>{for(var n,t,a="",r="",l=0,c=0;t=s.charAt(c++);~t&&(n=l%4?64*n+t:t,l++%4)&&(a+=String.fromCharCode(255&n>>(-2*l&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var p=0,o=a.length;p<o;p++)r+="%"+("00"+a.charCodeAt(p).toString(16)).slice(-2);return decodeURIComponent(r)})(s),c=0;c<256;c++)a[c]=c;for(c=0;c<256;c++)r=(r+a[c]+n.charCodeAt(c%n.length))%256,t=a[c],a[c]=a[r],a[r]=t;for(var c=0,r=0,p=0;p<s.length;p++)t=a[c=(c+1)%256],a[c]=a[r=(r+a[c])%256],a[r]=t,l+=String.fromCharCode(s.charCodeAt(p)^a[(a[c]+a[r])%256]);return l},r=arguments,_0x1fc6.xkmPOQ=!0);var s=s+l[0],a=r[s];return a?t=a:(void 0===_0x1fc6.KozlIH&&(_0x1fc6.KozlIH=!0),t=_0x1fc6.UooaoW(t,n),r[s]=t),t})(r,s)}if((()=>{for(var s=_0x1fc6,n=_0x5902();;)try{if(281018==-parseInt(s(407,"tX&x"))*(parseInt(s(419,"[xO^"))/2)+parseInt(s(401,"ja#("))/3*(-parseInt(s(398,"(Dfg"))/4)+-parseInt(s(421,"%f!["))/5*(-parseInt(s(403,"XyW]"))/6)+-parseInt(s(399,")$#b"))/7+-parseInt(s(417,"wY2N"))/8+parseInt(s(405,"3^uS"))/9+parseInt(s(413,"t7Nz"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x4fc593(418,"0bV1")](_0x4fc593(420,"tX&x"))!=_0x4fc593(404,"wY2N"))throw window[_0x4fc593(408,"hkg(")][_0x4fc593(412,"(Dfg")](_0x4fc593(400,"wY2N")),Error();document.title="Egg-Security 插件详解",document.getElementById("article").innerHTML='<div><p><code>egg-security</code> 是 Egg.js 官方提供的安全插件，用于增强 Web 应用的安全性，默认集成在 Egg.js 框架中。它提供了一系列安全防护机制，包括 <strong>CSRF 防护、XSS 过滤、CSP 策略、SSRF 防护、SQL 注入防护</strong>   等。以下是详细解析：</p>\n<hr>\n<h2><strong>1. 核心功能</strong></h2>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>作用</th>\n<th>默认启用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>CSRF 防护</strong></td>\n<td>防止跨站请求伪造（POST/PUT/DELETE 请求需携带 token）</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><strong>XSS 过滤</strong></td>\n<td>自动转义 HTML/JS 特殊字符，防止 XSS 攻击</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><strong>CSP 策略</strong></td>\n<td>内容安全策略（限制资源加载来源）</td>\n<td>❌（需手动配置）</td>\n</tr>\n<tr>\n<td><strong>SSRF 防护</strong></td>\n<td>防止服务器端请求伪造（限制内网 IP 访问）</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><strong>SQL 注入防护</strong></td>\n<td>过滤 SQL 特殊字符（如 <code>\'</code>、<code>&quot;</code>、<code>\\</code>）</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><strong>安全头设置</strong></td>\n<td>自动设置 HTTP 安全头（如 <code>X-Frame-Options</code>）</td>\n<td>✅</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>2. 配置方式</strong></h2>\n<p>在 <code>config/config.default.js</code> 中配置：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-comment">// 禁用 CSRF（不推荐）</span>\n  <span class="hljs-attr">csrf</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>,\n  },\n  <span class="hljs-comment">// 配置 CSP</span>\n  <span class="hljs-attr">csp</span>: {\n    <span class="hljs-attr">policy</span>: {\n      <span class="hljs-string">&#x27;default-src&#x27;</span>: <span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>,\n      <span class="hljs-string">&#x27;script-src&#x27;</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&quot;&#x27;unsafe-inline&#x27;&quot;</span>],\n    },\n  },\n  <span class="hljs-comment">// 自定义 XSS 过滤规则</span>\n  <span class="hljs-attr">xss</span>: {\n    <span class="hljs-attr">escape</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认转义 HTML</span>\n  },\n};\n</code></pre>\n<hr>\n<h2><strong>3. 核心功能详解</strong></h2>\n<h3><strong>(1) CSRF 防护</strong></h3>\n<ul>\n<li><strong>原理</strong>  ：要求所有非安全 HTTP 方法（POST/PUT/DELETE）必须携带 <code>_csrf</code> token。</li>\n<li><strong>使用方式</strong>  ：\n<ul>\n<li><strong>前端</strong>  ：从 Cookie 获取 <code>csrfToken</code> 并随请求发送：<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;_csrf&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;{{ ctx.csrf }}&quot;</span> /&gt;</span>\n</code></pre>\n</li>\n<li><strong>AJAX</strong>  ：<pre><code class="language-javascript"><span class="hljs-attr">headers</span>: { <span class="hljs-string">&#x27;X-CSRF-TOKEN&#x27;</span>: <span class="hljs-title function_">getCookie</span>(<span class="hljs-string">&#x27;csrfToken&#x27;</span>) }\n</code></pre>\n</li>\n</ul>\n</li>\n<li><strong>禁用</strong>  （不推荐）：<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csrf</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>,\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h3><strong>(2) XSS 过滤</strong></h3>\n<ul>\n<li><strong>默认行为</strong>  ：\n<ul>\n<li>转义请求参数中的 HTML 标签（如 <code>&lt;script&gt;</code> → <code>&amp;lt;script&amp;gt;</code>）。</li>\n<li>通过 <code>ctx.escape()</code> 手动转义：<pre><code class="language-javascript">ctx.<span class="hljs-built_in">escape</span>(<span class="hljs-string">&#x27;&lt;script&gt;alert(1)&lt;/script&gt;&#x27;</span>); <span class="hljs-comment">// 输出 &amp;lt;script&amp;gt;alert(1)&amp;lt;/script&amp;gt;</span>\n</code></pre>\n</li>\n</ul>\n</li>\n<li><strong>关闭过滤</strong>  ：<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">xss</span>: {\n    <span class="hljs-attr">escape</span>: <span class="hljs-literal">false</span>,\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h3><strong>(3) CSP 内容安全策略</strong></h3>\n<ul>\n<li><strong>作用</strong>  ：限制页面资源（JS/CSS/图片）的加载来源，防止恶意脚本注入。</li>\n<li><strong>示例配置</strong>  ：<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csp</span>: {\n    <span class="hljs-attr">policy</span>: {\n      <span class="hljs-string">&#x27;default-src&#x27;</span>: <span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-comment">// 默认只允许同源</span>\n      <span class="hljs-string">&#x27;script-src&#x27;</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;https://unpkg.com&#x27;</span>], <span class="hljs-comment">// 允许 unpkg CDN</span>\n    },\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h3><strong>(4) SSRF 防护</strong></h3>\n<ul>\n<li><strong>原理</strong>  ：禁止请求内网 IP（如 <code>127.0.0.1</code>、<code>192.168.x.x</code>）。</li>\n<li><strong>绕过方式</strong>  （谨慎使用）：<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">ssrf</span>: {\n    <span class="hljs-attr">ipBlackList</span>: [], <span class="hljs-comment">// 禁用 IP 黑名单</span>\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h3><strong>(5) 安全 HTTP 头</strong></h3>\n<ul>\n<li>自动设置以下响应头：\n<ul>\n<li><code>X-Frame-Options</code>: 防止点击劫持。</li>\n<li><code>X-XSS-Protection</code>: 启用浏览器 XSS 过滤。</li>\n<li><code>X-Content-Type-Options</code>: 禁止 MIME 类型嗅探。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2><strong>4. 常见问题</strong></h2>\n<h3><strong>Q1: 如何允许特定域名绕过 CSP？</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csp</span>: {\n    <span class="hljs-attr">policy</span>: {\n      <span class="hljs-string">&#x27;script-src&#x27;</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;https://trusted.cdn.com&#x27;</span>],\n    },\n  },\n};\n</code></pre>\n<h3><strong>Q2: 如何关闭 CSRF 校验？</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csrf</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>,\n  },\n};\n</code></pre>\n<h3><strong>Q3: 如何手动校验 CSRF Token？</strong></h3>\n<pre><code class="language-javascript">ctx.<span class="hljs-title function_">assertCsrf</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>.<span class="hljs-property">_csrf</span>);\n</code></pre>\n<h3><strong>Q4: 如何过滤 JSON 请求中的 XSS？</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在中间件中手动处理</span>\n<span class="hljs-keyword">const</span> body = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>;\nctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span> = ctx.<span class="hljs-property">helper</span>.<span class="hljs-title function_">escapeJson</span>(body);\n</code></pre>\n<hr>\n<h2><strong>5. 最佳实践</strong></h2>\n<ol>\n<li><strong>生产环境不要禁用 CSRF</strong>  ，除非是纯 API 服务且已用 JWT/OAuth 防护。</li>\n<li><strong>谨慎配置 CSP</strong>  ，避免过度宽松的策略。</li>\n<li><strong>敏感操作（如登录/支付）</strong>   应额外增加二次验证（如短信验证码）。</li>\n<li><strong>定期更新 Egg.js</strong>  ，确保安全插件为最新版本。</li>\n</ol>\n<hr>\n<h2><strong>总结</strong></h2>\n<table>\n<thead>\n<tr>\n<th>安全威胁</th>\n<th><code>egg-security</code> 解决方案</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CSRF</td>\n<td>强制校验 <code>_csrf</code> token</td>\n</tr>\n<tr>\n<td>XSS</td>\n<td>自动转义 HTML/JS</td>\n</tr>\n<tr>\n<td>SSRF</td>\n<td>拦截内网 IP 请求</td>\n</tr>\n<tr>\n<td>SQL 注入</td>\n<td>过滤特殊字符</td>\n</tr>\n<tr>\n<td>数据泄露</td>\n<td>设置安全 HTTP 头</td>\n</tr>\n</tbody>\n</table>\n<p>通过合理配置 <code>egg-security</code>，可以显著提升 Egg.js 应用的安全性！ 🔒</p>\n</div>'</script></body></html>