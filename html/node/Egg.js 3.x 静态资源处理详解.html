<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x4c7501=_0x2fda;function _0x1198(){var s=["W4RcKSkBCSomh3HgkCkiWOyqrmouECkHWRJdJmkWWOBcMGD+W7n0WQK","cSkyWRpdPruKW5BdT2FdVZlcUSozxq","W6e5m8ktW6RcHSknW7a","W6y6tSoxWQ3cSCkLW6ddMwSK","W4hdLYxcH8kiW6urlCk3W6dcTw9r","k8kwiNfhW4Ws","WQPQW4rdWOTAumkH","hGyiW7mHWPe8","WOjEWOZdVtbJoW","W4pcJKFdLmoiWOLT","jxqHrtbrWO/cPmkruLHQya","W5ldLXv9W4XwECkTqSkSvLtcVG","crpdHCojuSkKWRCbW6vCW5lcTXa","n8oWvmoKlYtcGeW","W4STAmoaW5S7WRaNWRxdHLa","rtNcJsldJSotW77cNf3cPSkNW6S","WQz4imoWWQO7WR7cSSkPud/cQf4","W5hdVfKwtG","jmkBWRehhKeWmrrvWQJdRmky","WPdcSbPsbSkSW5JcQCoab8k6WRflW7W","W5ldNwO9WQupk8kX","F24pg2Kpdmki","W7WfWROmbSope8kOWQnKcCoUrq","kImuhu9UWRrV","ACkUWQRcTSo6WRTWEXRcTHdcQa","W74fW6TNACkWxmkH","bY8uguH0WPbKW70","FCobBWekWP9jWR5RnSomfCkX"];return(_0x1198=function(){return s})()}function _0x2fda(l,s){var t=_0x1198();return(_0x2fda=function(s,a){var n=t[s-=486];void 0===_0x2fda.ShDZlj&&(_0x2fda.NcnacN=function(s,a){var n,p=[],l=0,t="";for(s=(s=>{for(var a,n,p="",l="",t=0,c=0;n=s.charAt(c++);~n&&(a=t%4?64*a+n:n,t++%4)&&(p+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,r=p.length;e<r;e++)l+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)p[c]=c;for(c=0;c<256;c++)l=(l+p[c]+a.charCodeAt(c%a.length))%256,n=p[c],p[c]=p[l],p[l]=n;for(var c=0,l=0,e=0;e<s.length;e++)n=p[c=(c+1)%256],p[c]=p[l=(l+p[c])%256],p[l]=n,t+=String.fromCharCode(s.charCodeAt(e)^p[(p[c]+p[l])%256]);return t},l=arguments,_0x2fda.ShDZlj=!0);var s=s+t[0],p=l[s];return p?n=p:(void 0===_0x2fda.mcUFAK&&(_0x2fda.mcUFAK=!0),n=_0x2fda.NcnacN(n,a),l[s]=n),n})(l,s)}if((()=>{for(var s=_0x2fda,a=_0x1198();;)try{if(231973==-parseInt(s(492,"6J#D"))*(-parseInt(s(491,"GW*C"))/2)+parseInt(s(487,"x^Nm"))/3*(parseInt(s(502,"JN%2"))/4)+-parseInt(s(512,"$NOs"))/5*(-parseInt(s(489,"C21k"))/6)+parseInt(s(500,"Juxl"))/7+-parseInt(s(510,"x^Nm"))/8*(-parseInt(s(499,"uouX"))/9)+parseInt(s(488,"xwT)"))/10+-parseInt(s(497,"Nu&h"))/11)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x4c7501(511,"N[dV")](_0x4c7501(504,"Pbzn"))!=_0x4c7501(495,"Nu&h"))throw window[_0x4c7501(501,"Pbzn")][_0x4c7501(513,"mEej")](_0x4c7501(506,"LIKg")),Error();document.title="Egg.js 3.x 静态资源处理详解",document.getElementById("article").innerHTML='<div><h2>一、静态资源基础配置</h2>\n<p>Egg.js 内置了静态资源插件 <code>egg-static</code>，默认已经开启。以下是基本配置方式：</p>\n<h3>1. 默认配置</h3>\n<p>在 <code>config/config.default.js</code> 中：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">static</span> = {\n  <span class="hljs-attr">prefix</span>: <span class="hljs-string">&#x27;/public/&#x27;</span>, <span class="hljs-comment">// URL 前缀</span>\n  <span class="hljs-attr">dir</span>: path.<span class="hljs-title function_">join</span>(appInfo.<span class="hljs-property">baseDir</span>, <span class="hljs-string">&#x27;app/public&#x27;</span>), <span class="hljs-comment">// 静态资源目录</span>\n  <span class="hljs-attr">dynamic</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否支持动态加载</span>\n  <span class="hljs-attr">preload</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否预加载</span>\n  <span class="hljs-attr">buffer</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否缓存到内存</span>\n  <span class="hljs-attr">maxFiles</span>: <span class="hljs-number">1000</span>, <span class="hljs-comment">// 最大文件数</span>\n};\n</code></pre>\n<h3>2. 目录结构</h3>\n<p>默认静态资源目录为 <code>app/public</code>，例如：</p>\n<pre><code>app\n├── public\n│   ├── css\n│   │   └── style.css\n│   ├── js\n│   │   └── app.js\n│   └── images\n│       └── logo.png\n</code></pre>\n<h2>二、高级配置选项</h2>\n<h3>1. 多静态目录配置</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">static</span> = {\n  <span class="hljs-comment">// 默认静态资源</span>\n  {\n    <span class="hljs-attr">prefix</span>: <span class="hljs-string">&#x27;/public/&#x27;</span>,\n    <span class="hljs-attr">dir</span>: path.<span class="hljs-title function_">join</span>(appInfo.<span class="hljs-property">baseDir</span>, <span class="hljs-string">&#x27;app/public&#x27;</span>),\n  },\n  <span class="hljs-comment">// 额外静态目录</span>\n  {\n    <span class="hljs-attr">prefix</span>: <span class="hljs-string">&#x27;/uploads/&#x27;</span>,\n    <span class="hljs-attr">dir</span>: path.<span class="hljs-title function_">join</span>(appInfo.<span class="hljs-property">baseDir</span>, <span class="hljs-string">&#x27;uploads&#x27;</span>),\n  }\n];\n</code></pre>\n<h3>2. 缓存控制</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">static</span> = {\n  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>, <span class="hljs-comment">// 缓存一年</span>\n  <span class="hljs-attr">cacheControl</span>: <span class="hljs-string">&#x27;public, max-age=31536000&#x27;</span>, <span class="hljs-comment">// HTTP 缓存头</span>\n  <span class="hljs-attr">lastModified</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用 Last-Modified</span>\n  <span class="hljs-attr">etag</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 启用 ETag</span>\n};\n</code></pre>\n<h2>三、开发环境与生产环境差异</h2>\n<h3>1. 开发环境</h3>\n<ul>\n<li>默认启用 <code>dynamic</code> 模式，文件修改会实时生效</li>\n<li>不推荐开启 <code>buffer</code> 选项</li>\n</ul>\n<h3>2. 生产环境</h3>\n<p>推荐配置：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// config.prod.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">static</span> = {\n  <span class="hljs-attr">dynamic</span>: <span class="hljs-literal">false</span>,\n  <span class="hljs-attr">preload</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">buffer</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>\n};\n</code></pre>\n<h2>四、最佳实践</h2>\n<h3>1. 前端资源构建</h3>\n<p>推荐使用 Webpack 等构建工具，输出到静态资源目录：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// 构建配置示例</span>\n{\n  <span class="hljs-attr">output</span>: {\n    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;../app/public&#x27;</span>),\n    <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;js/[name].[chunkhash:8].js&#x27;</span>,\n    <span class="hljs-attr">publicPath</span>: <span class="hljs-string">&#x27;/public/&#x27;</span>\n  }\n}\n</code></pre>\n<h3>2. 资源版本控制</h3>\n<p>推荐使用 hash 文件名：</p>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/public/css/app.3e7a3b8a.css&quot;</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;</span>\n</code></pre>\n<h3>3. CDN 配置</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">static</span> = {\n  <span class="hljs-attr">prefix</span>: <span class="hljs-string">&#x27;/public/&#x27;</span>,\n  <span class="hljs-attr">dir</span>: path.<span class="hljs-title function_">join</span>(appInfo.<span class="hljs-property">baseDir</span>, <span class="hljs-string">&#x27;app/public&#x27;</span>),\n  <span class="hljs-comment">// 生产环境配置CDN</span>\n  <span class="hljs-attr">dynamic</span>: <span class="hljs-literal">false</span>,\n  <span class="hljs-attr">buffer</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-comment">// 自定义加载函数</span>\n  <span class="hljs-title function_">load</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>* (next) {\n      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">path</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/public/&#x27;</span>)) {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">`https://cdn.yourdomain.com<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.path}</span>`</span>)();\n        <span class="hljs-keyword">return</span>;\n      }\n      <span class="hljs-keyword">yield</span> next;\n    };\n  }\n};\n</code></pre>\n<h2>五、安全注意事项</h2>\n<ol>\n<li><strong>目录遍历防护</strong>  ：\n<ul>\n<li>Egg.js 已内置防护，禁止访问 <code>../</code> 等路径</li>\n</ul>\n</li>\n<li><strong>敏感文件</strong>  ：\n<ul>\n<li>不要将配置文件、源代码等放在静态目录</li>\n</ul>\n</li>\n<li><strong>上传文件</strong>  ：\n<ul>\n<li>上传目录应与静态资源目录分开</li>\n<li>限制上传文件类型</li>\n</ul>\n</li>\n</ol>\n<h2>六、自定义中间件示例</h2>\n<p>如果需要特殊处理静态资源，可以自定义中间件：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/static.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">staticMiddleware</span>(<span class="hljs-params">ctx, next</span>) {\n    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">path</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/public/&#x27;</span>)) {\n      <span class="hljs-comment">// 自定义处理逻辑</span>\n      <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">path</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.js&#x27;</span>)) {\n        ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;X-Content-Type-Options&#x27;</span>, <span class="hljs-string">&#x27;nosniff&#x27;</span>);\n      }\n    }\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  };\n};\n\n<span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">middleware</span> = [<span class="hljs-string">&#x27;static&#x27;</span>];\n</code></pre>\n<h2>七、常见问题解决</h2>\n<h3>1. 404 问题</h3>\n<p>检查：</p>\n<ul>\n<li>文件是否存在于正确目录</li>\n<li>URL 前缀是否匹配配置</li>\n<li>文件权限是否正确</li>\n</ul>\n<h3>2. 性能优化</h3>\n<ul>\n<li>生产环境开启 <code>buffer</code> 和 <code>preload</code></li>\n<li>配置合适的 <code>maxAge</code></li>\n<li>使用 CDN 加速</li>\n</ul>\n<h3>3. 跨域问题</h3>\n<p>如需支持跨域：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">static</span> = {\n  <span class="hljs-title function_">setHeaders</span>(<span class="hljs-params">res, path, stat</span>) {\n    res.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>);\n  }\n};\n</code></pre>\n<p>通过以上配置和最佳实践，你可以在 Egg.js 中高效、安全地管理静态资源。</p>\n</div>'</script></body></html>