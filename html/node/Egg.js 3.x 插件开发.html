<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x39e2(l,s){var e=_0x2b90();return(_0x39e2=function(s,n){var a=e[s-=376];void 0===_0x39e2.SEfnml&&(_0x39e2.qCoYvN=function(s,n){var a,p=[],l=0,e="";for(s=(s=>{for(var n,a,p="",l="",e=0,t=0;a=s.charAt(t++);~a&&(n=e%4?64*n+a:a,e++%4)&&(p+=String.fromCharCode(255&n>>(-2*e&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=p.length;c<o;c++)l+="%"+("00"+p.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(l)})(s),t=0;t<256;t++)p[t]=t;for(t=0;t<256;t++)l=(l+p[t]+n.charCodeAt(t%n.length))%256,a=p[t],p[t]=p[l],p[l]=a;for(var t=0,l=0,c=0;c<s.length;c++)a=p[t=(t+1)%256],p[t]=p[l=(l+p[t])%256],p[l]=a,e+=String.fromCharCode(s.charCodeAt(c)^p[(p[t]+p[l])%256]);return e},l=arguments,_0x39e2.SEfnml=!0);var s=s+e[0],p=l[s];return p?a=p:(void 0===_0x39e2.lORwPU&&(_0x39e2.lORwPU=!0),a=_0x39e2.qCoYvN(a,n),l[s]=a),a})(l,s)}var _0xd3e041=_0x39e2;if((()=>{for(var s=_0x39e2,n=_0x2b90();;)try{if(478207==-parseInt(s(385,"ZoH0"))+-parseInt(s(381,"Foi)"))/2+parseInt(s(384,"pv1q"))/3+parseInt(s(391,"fF1F"))/4+-parseInt(s(377,"^(^f"))/5*(parseInt(s(386,"*wJA"))/6)+-parseInt(s(394,"#br3"))/7+-parseInt(s(376,"mE^B"))/8*(-parseInt(s(379,"mE^B"))/9))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0xd3e041(387,"Foi)")](_0xd3e041(397,"pw3g"))!=_0xd3e041(398,"mE^B"))throw window[_0xd3e041(383,"VqiJ")][_0xd3e041(380,"Sj(b")](_0xd3e041(390,"6wRB")),Error();function _0x2b90(){var s=["W4ZcVeRcLa4JpCoqj8owWQJdKCoS","ACoHW6ddL8kAWOaAlY7cGd3dTtK","W751zqfLo8oEWOW","W4pdGSkkWO7dJSoAr08dW63dGmkKaq","WRtcICkgWOldOxHthmop","WODXhhZcTq","W4pcVeNcKqWIEmolemoCWOZdOW","W4yYlwhcQ01HWQG","zSodg8kCW6hdVCkAFWxcMq","W6e5WQmupMxdL8kTWOOxkcu","W480wZ3dVJ06WQimWQFcISk1kG","W50hWOBcHSoNWQiw","W7LWfL42smozWOZcNaFdSCkb","z8k1WQFcU8o6WQBdTCkat8kf","puC3lK/cS1hdHq","W6tcNcddO8oYpbCwkNZcGSoI","W4VdHKacWOxdJHG4WQFcNCk/BW","W4ddSIyjESkYDhn/W4i","WQGMuYz2gCoC","A8oGW6xdN8kBWODakX/cRqRdSW","W6nMWPNcJ8kPDZ3dOCkrtG","W4lcNqhcKCoVrwWujCozDSo0Fe3cIe/dN198W5u3t8k4amoXW50","WOZcPJizfsNcKLSeW5uJiSkS","W4FdMSorW5FcOdOQg8o5WRhcIKtcTq"];return(_0x2b90=function(){return s})()}document.title="Egg.js 3.x 插件开发",document.getElementById("article").innerHTML='<div><p>以下是 Egg.js 3.x 插件开发的详细步骤指南，包含从初始化到发布的完整流程：</p>\n<hr>\n<h3><strong>一、插件开发基础步骤</strong></h3>\n<h4>1. 创建插件项目</h4>\n<pre><code class="language-sh"><span class="hljs-comment"># 使用官方脚手架初始化</span>\n<span class="hljs-built_in">mkdir</span> egg-xxx-plugin &amp;&amp; <span class="hljs-built_in">cd</span> egg-xxx-plugin\nnpm init egg --<span class="hljs-built_in">type</span>=plugin\n<span class="hljs-comment"># 或手动创建</span>\nnpm init -y\n<span class="hljs-built_in">mkdir</span> lib app config\n</code></pre>\n<h4>2. 目录结构规范</h4>\n<pre><code>egg-xxx-plugin/\n├── package.json\n├── config/               # 插件默认配置\n│   └── config.default.js\n├── app/                  # 插件功能实现\n│   ├── extend/           # 扩展点\n│   │   ├── application.js\n│   │   ├── context.js\n│   │   ├── helper.js\n│   │   └── request.js\n│   └── middleware/       # 中间件\n│       └── xxx.js\n├── lib/                  # 核心逻辑\n│   └── plugin.js         # 插件入口文件\n├── test/                 # 单元测试\n└── README.md             # 使用文档\n</code></pre>\n<h4>3. 核心文件实现</h4>\n<p><strong><code>lib/plugin.js</code> (插件入口)</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Plugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>).<span class="hljs-property">Plugin</span>;\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Plugin</span> {\n  <span class="hljs-comment">// 声明依赖（可选）</span>\n  <span class="hljs-keyword">static</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">dependencies</span>() {\n    <span class="hljs-keyword">return</span> [<span class="hljs-string">&#x27;sequelize&#x27;</span>];\n  }\n\n  <span class="hljs-comment">// 生命周期钩子</span>\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 插件加载完成时执行</span>\n  }\n\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">serverDidReady</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 服务启动后执行</span>\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">XxxPlugin</span>;\n</code></pre>\n<p><strong><code>config/config.default.js</code> (默认配置)</strong></p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">appInfo</span> =&gt;</span> ({\n  <span class="hljs-comment">// 插件默认配置</span>\n  <span class="hljs-attr">pluginXxx</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-xxx-plugin&#x27;</span>,\n    <span class="hljs-attr">option</span>: {\n      <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;defaultValue&#x27;</span>\n    }\n  }\n});\n</code></pre>\n<h4>4. 扩展点实现（可选）</h4>\n<p><strong><code>app/extend/application.js</code></strong></p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 扩展 app 对象</span>\n  <span class="hljs-title function_">getXxx</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">pluginXxx</span>.<span class="hljs-property">option</span>.<span class="hljs-property">key</span>;\n  }\n};\n</code></pre>\n<p><strong><code>app/extend/context.js</code></strong></p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 扩展 ctx 对象</span>\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchXxx</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">xxxService</span>.<span class="hljs-title function_">getData</span>();\n  }\n};\n</code></pre>\n<hr>\n<h3><strong>二、插件功能开发</strong></h3>\n<h4>1. 添加中间件</h4>\n<p><strong><code>app/middleware/xxx.js</code></strong></p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n    ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;X-Response-Time&#x27;</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - start}</span>ms`</span>);\n  };\n};\n</code></pre>\n<p><strong>注册中间件 (<code>lib/plugin.js</code>)</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Plugin</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 自动加载中间件</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">config</span>.<span class="hljs-property">coreMiddleware</span>.<span class="hljs-title function_">unshift</span>(<span class="hljs-string">&#x27;xxx&#x27;</span>);\n  }\n}\n</code></pre>\n<h4>2. 集成服务</h4>\n<p><strong>创建 Service (<code>app/service/xxx.js</code>)</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">Service</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">return</span> { <span class="hljs-attr">foo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">pluginXxx</span>.<span class="hljs-property">option</span>.<span class="hljs-property">key</span> };\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">XxxService</span>;\n</code></pre>\n<p><strong>注册 Service (<code>lib/plugin.js</code>)</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Plugin</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 挂载服务到 app</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">xxxService</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XxxService</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>);\n  }\n}\n</code></pre>\n<hr>\n<h3><strong>三、插件测试</strong></h3>\n<h4>1. 编写单元测试</h4>\n<p><strong><code>test/xxx.test.js</code></strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { app, mock, assert } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg-mock&#x27;</span>);\n\n<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;test plugin&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-title function_">before</span>(<span class="hljs-function">() =&gt;</span> app.<span class="hljs-title function_">ready</span>());\n\n  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;should extend app&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-title function_">assert</span>(app.<span class="hljs-title function_">getXxx</span>() === <span class="hljs-string">&#x27;defaultValue&#x27;</span>);\n  });\n\n  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;should add middleware&#x27;</span>, <span class="hljs-title function_">async</span> () =&gt; {\n    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">httpRequest</span>()\n      .<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>)\n      .<span class="hljs-title function_">expect</span>(<span class="hljs-number">200</span>);\n    <span class="hljs-title function_">assert</span>(res.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;x-response-time&#x27;</span>]);\n  });\n});\n</code></pre>\n<h4>2. 本地测试</h4>\n<pre><code class="language-sh"><span class="hljs-comment"># 在测试项目中链接插件</span>\n<span class="hljs-built_in">cd</span> test-project\nnpm <span class="hljs-built_in">link</span> ../egg-xxx-plugin\n\n<span class="hljs-comment"># 配置启用插件</span>\n// config/plugin.js\nexports.xxx = {\n  <span class="hljs-built_in">enable</span>: <span class="hljs-literal">true</span>,\n  package: <span class="hljs-string">&#x27;egg-xxx-plugin&#x27;</span>,\n  option: { key: <span class="hljs-string">&#x27;testValue&#x27;</span> }\n};\n</code></pre>\n<hr>\n<h3><strong>四、插件发布</strong></h3>\n<h4>1. 完善元信息</h4>\n<p><strong><code>package.json</code> 关键字段</strong></p>\n<pre><code class="language-json"><span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;egg-xxx-plugin&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Egg.js plugin for xxx&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;eggPlugin&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xxx&quot;</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;sequelize&quot;</span><span class="hljs-punctuation">]</span>\n  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;keywords&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;egg&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;egg-plugin&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;xxx&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;files&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;config&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;app&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;lib&quot;</span><span class="hljs-punctuation">]</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n<h4>2. 发布到 npm</h4>\n<pre><code class="language-sh">npm login\nnpm publish --access=public\n</code></pre>\n<h4>3. 版本更新</h4>\n<pre><code class="language-sh">npm version patch  <span class="hljs-comment"># 修复 bug</span>\nnpm version minor  <span class="hljs-comment"># 新增功能</span>\nnpm version major  <span class="hljs-comment"># 不兼容改动</span>\n</code></pre>\n<hr>\n<h3><strong>五、高级开发技巧</strong></h3>\n<h4>1. 多环境配置</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">pluginXxx</span>: {\n    <span class="hljs-attr">option</span>: {\n      <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;prodValue&#x27;</span>\n    }\n  }\n};\n</code></pre>\n<h4>2. 动态启用功能</h4>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Plugin</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">configDidLoad</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">config</span>.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;local&#x27;</span>) {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">disableXxx</span> = <span class="hljs-literal">true</span>;\n    }\n  }\n}\n</code></pre>\n<h4>3. 依赖其他插件</h4>\n<pre><code class="language-javascript"><span class="hljs-keyword">static</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">dependencies</span>() {\n  <span class="hljs-keyword">return</span> [<span class="hljs-string">&#x27;sequelize&#x27;</span>];\n}\n\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">sequelize</span>) {\n    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;请先启用 egg-sequelize 插件&#x27;</span>);\n  }\n}\n</code></pre>\n<h4>4. TypeScript 支持</h4>\n<p><strong>添加类型声明 (<code>index.d.ts</code>)</strong></p>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;egg&#x27;</span>;\n\n<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;egg&#x27;</span> {\n  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Application</span> {\n    <span class="hljs-title function_">getXxx</span>(): <span class="hljs-built_in">string</span>;\n  }\n\n  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Context</span> {\n    <span class="hljs-title function_">fetchXxx</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;;\n  }\n}\n</code></pre>\n<hr>\n<h3><strong>六、常见问题解决</strong></h3>\n<ol>\n<li><strong>插件加载顺序问题</strong><br>\n▸ 通过 <code>dependencies</code> 显式声明依赖<br>\n▸ 在 <code>didLoad</code> 阶段检查依赖是否就绪</li>\n<li><strong>配置合并冲突</strong><br>\n▸ 使用 <code>_.merge</code> 深度合并配置<br>\n▸ 避免使用常见命名如 <code>cache</code>/<code>db</code></li>\n<li><strong>性能优化</strong><br>\n▸ 延迟初始化耗资源的对象<br>\n▸ 使用 <code>Symbol</code> 作为扩展属性名</li>\n<li><strong>兼容性处理</strong><br>\n▸ 通过 <code>app.version</code> 判断 Egg.js 版本<br>\n▸ 提供降级方案：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-keyword">if</span> (app.<span class="hljs-property">router</span>) {\n  <span class="hljs-comment">// Egg 2.x+</span>\n  app.<span class="hljs-property">router</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/xxx&#x27;</span>, controller.<span class="hljs-property">handler</span>);\n} <span class="hljs-keyword">else</span> {\n  <span class="hljs-comment">// Egg 1.x</span>\n  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/xxx&#x27;</span>, app.<span class="hljs-property">controller</span>.<span class="hljs-property">handler</span>);\n}\n</code></pre>\n<hr>\n<p>通过以上步骤，你可以开发出功能完善、易于维护的 Egg.js 插件。建议参考官方插件 <a href="https://github.com/eggjs/egg-sequelize" target="_blank">egg-sequelize</a> 或 <a href="https://github.com/eggjs/egg-validate" target="_blank">egg-validate</a> 的实现。</p>\n</div>'</script></body></html>