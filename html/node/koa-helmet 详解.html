<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0xf89a9b=_0x1c3c;function _0x1c3c(l,s){var p=_0x30b7();return(_0x1c3c=function(s,n){var a=p[s-=275];void 0===_0x1c3c.HkByZd&&(_0x1c3c.euNBwl=function(s,n){var a,t=[],l=0,p="";for(s=(s=>{for(var n,a,t="",l="",p=0,c=0;a=s.charAt(c++);~a&&(n=p%4?64*n+a:a,p++%4)&&(t+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var r=0,e=t.length;r<e;r++)l+="%"+("00"+t.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)t[c]=c;for(c=0;c<256;c++)l=(l+t[c]+n.charCodeAt(c%n.length))%256,a=t[c],t[c]=t[l],t[l]=a;for(var c=0,l=0,r=0;r<s.length;r++)a=t[c=(c+1)%256],t[c]=t[l=(l+t[c])%256],t[l]=a,p+=String.fromCharCode(s.charCodeAt(r)^t[(t[c]+t[l])%256]);return p},l=arguments,_0x1c3c.HkByZd=!0);var s=s+p[0],t=l[s];return t?a=t:(void 0===_0x1c3c.OKcCGb&&(_0x1c3c.OKcCGb=!0),a=_0x1c3c.euNBwl(a,n),l[s]=a),a})(l,s)}function _0x30b7(){var s=["ns9Wumop","FCoWWQa4bSkdbXqdWRFdOG","W6VdRmoPW4aotsK","dsvaWOqtamksWOCf","WODCWR9mA8kWhCoOi8kwh2q","jmkYrxVcKCoDWQGPdrC","mJnqWRGJj3W","qSkDex3cImk3W5FdJSkzW7ddO8kP","e0pcSCkwWRLrcCo/ixid","xSkJFb99W7xdKZFdQZbKahq","WPdcVCoJqmoGn8kwWR7cKSol","b3KHrmkGdmk4FmkoBbNdRwO","W504y8k9W71RW6WTcSoX","WO07W7HLW5DwW7tcICoC","sSk0WQGbWOddSSkl","dSkZl0NcKSotbCkgixhdLq","WQTjyCk1WR7cImoN","WQ3cMb3dKYe1W4LeCKiBW44","WOjVWRRdUmoYWPOelIfJw8kT","mSobW4qYnCopWRGt","WQOog8o5W5/cKmoTsCkwhKK","lCkTWRWYWPpdHmk3mxBdMq","W5VdKCk+BmkBW6xdKCkQWORdN8oIwCoQ","WQBcNrZcTxvmW7jqCW","w8ksjfFdLmoSeSkoBmof","uSkOgui5WRLxuqzoWPxcLSkmDCoYg8o0WOT+FMNdMmoRimoyWO0","W6tdTSoVW5SIW7/cLSkYWPiO","WOJcP1RdSghdQCoiWPFdNLxdU3vW"];return(_0x30b7=function(){return s})()}if((()=>{for(var s=_0x1c3c,n=_0x30b7();;)try{if(900129==+parseInt(s(301,"EZqh"))+parseInt(s(287,"vA5V"))/2+-parseInt(s(281,"v$]O"))/3*(-parseInt(s(302,"L@b#"))/4)+parseInt(s(291,"FNG4"))/5+-parseInt(s(280,"ULqJ"))/6*(parseInt(s(275,"ZNn0"))/7)+parseInt(s(298,"Fkz3"))/8*(-parseInt(s(300,"OFr&"))/9)+parseInt(s(284,"wCUQ"))/10*(-parseInt(s(295,"a&Rm"))/11))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0xf89a9b(283,"%5fO")](_0xf89a9b(282,"[Sg7"))!=_0xf89a9b(297,"pI9I"))throw window[_0xf89a9b(288,"Nc*R")][_0xf89a9b(299,"OSir")](_0xf89a9b(294,"56qM")),Error();document.title="koa-helmet 详解",document.getElementById("article").innerHTML='<div><p><code>koa-helmet</code> 是一个用于增强 Koa 应用安全性的中间件，通过设置 HTTP 响应头来防御常见的 Web 攻击（如 XSS、CSRF、嗅探攻击等）。它是 Node.js 生态中 <strong>Helmet</strong>   库的 Koa 适配版本。</p>\n<hr>\n<h2><strong>1. 核心功能</strong></h2>\n<table>\n<thead>\n<tr>\n<th>安全防护类型</th>\n<th>对应 HTTP 头字段</th>\n<th>防御的威胁</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>XSS 防护</strong></td>\n<td><code>X-XSS-Protection</code></td>\n<td>反射型 XSS 攻击</td>\n</tr>\n<tr>\n<td><strong>点击劫持防护</strong></td>\n<td><code>X-Frame-Options</code></td>\n<td>iframe 嵌套劫持</td>\n</tr>\n<tr>\n<td><strong>MIME 类型嗅探防护</strong></td>\n<td><code>X-Content-Type-Options</code></td>\n<td>浏览器自动推断文件类型导致的漏洞</td>\n</tr>\n<tr>\n<td><strong>HSTS 强制 HTTPS</strong></td>\n<td><code>Strict-Transport-Security</code></td>\n<td>HTTP 降级攻击</td>\n</tr>\n<tr>\n<td><strong>DNS 预取防护</strong></td>\n<td><code>X-DNS-Prefetch-Control</code></td>\n<td>隐私泄露风险</td>\n</tr>\n<tr>\n<td><strong>内容安全策略 (CSP)</strong></td>\n<td><code>Content-Security-Policy</code></td>\n<td>数据注入攻击（如脚本、样式、图片）</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>2. 安装与基础用法</strong></h2>\n<h3><strong>安装</strong></h3>\n<pre><code class="language-sh">npm install koa-helmet\n</code></pre>\n<h3><strong>基础使用（默认启用所有防护）</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-helmet&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">helmet</span>()); <span class="hljs-comment">// 启用所有安全头</span>\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;Hello Secure World!&#x27;</span>;\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<p><strong>效果</strong>  ：<br>\n响应头会自动添加以下安全字段：</p>\n<pre><code class="language-http"><span class="hljs-attribute">X-DNS-Prefetch-Control</span><span class="hljs-punctuation">: </span>off\n<span class="hljs-attribute">X-Frame-Options</span><span class="hljs-punctuation">: </span>SAMEORIGIN\n<span class="hljs-attribute">Strict-Transport-Security</span><span class="hljs-punctuation">: </span>max-age=15552000; includeSubDomains\n<span class="hljs-attribute">X-Content-Type-Options</span><span class="hljs-punctuation">: </span>nosniff\n<span class="hljs-attribute">X-XSS-Protection</span><span class="hljs-punctuation">: </span>1; mode=block\n</code></pre>\n<hr>\n<h2><strong>3. 高级配置</strong></h2>\n<h3><strong>（1）自定义单项防护</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">helmet</span>({\n    <span class="hljs-attr">contentSecurityPolicy</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 禁用 CSP（需手动配置）</span>\n    <span class="hljs-attr">hsts</span>: {\n      <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>, <span class="hljs-comment">// 强制 HTTPS 1 年</span>\n      <span class="hljs-attr">includeSubDomains</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">preload</span>: <span class="hljs-literal">true</span>\n    },\n    <span class="hljs-attr">frameguard</span>: {\n      <span class="hljs-attr">action</span>: <span class="hljs-string">&#x27;deny&#x27;</span> <span class="hljs-comment">// 禁止所有 iframe 嵌套</span>\n    }\n  })\n);\n</code></pre>\n<h3><strong>（2）内容安全策略 (CSP)</strong></h3>\n<p>配置允许加载的资源来源：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">helmet</span>({\n    <span class="hljs-attr">contentSecurityPolicy</span>: {\n      <span class="hljs-attr">directives</span>: {\n        <span class="hljs-attr">defaultSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>],\n        <span class="hljs-attr">scriptSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;trusted.cdn.com&#x27;</span>],\n        <span class="hljs-attr">styleSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&quot;&#x27;unsafe-inline&#x27;&quot;</span>], <span class="hljs-comment">// 慎用 unsafe-inline</span>\n        <span class="hljs-attr">imgSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;data:&#x27;</span>]\n      }\n    }\n  })\n);\n</code></pre>\n<h3><strong>（3）开发环境特殊配置</strong></h3>\n<p>某些头（如 <code>HSTS</code>）在生产环境才需要：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">helmet</span>({\n    <span class="hljs-attr">hsts</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span> ? { <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span> } : <span class="hljs-literal">false</span>\n  })\n);\n</code></pre>\n<hr>\n<h2><strong>4. 各防护头详解</strong></h2>\n<h3><strong>（1）<code>X-Frame-Options</code></strong></h3>\n<ul>\n<li><strong>作用</strong>  ：控制页面是否允许被 <code>&lt;iframe&gt;</code> 嵌套。</li>\n<li><strong>可选值</strong>  ：\n<ul>\n<li><code>SAMEORIGIN</code>（默认）：仅允许同域名嵌套。</li>\n<li><code>DENY</code>：完全禁止嵌套。</li>\n<li><code>ALLOW-FROM uri</code>：允许指定来源嵌套（已废弃）。</li>\n</ul>\n</li>\n</ul>\n<h3><strong>（2）<code>Strict-Transport-Security</code> (HSTS)</strong></h3>\n<ul>\n<li><strong>作用</strong>  ：强制浏览器使用 HTTPS 访问。</li>\n<li><strong>生产环境必配</strong>  ：<pre><code class="language-javascript"><span class="hljs-attr">hsts</span>: {\n  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>, <span class="hljs-comment">// 有效期 1 年（单位：秒）</span>\n  <span class="hljs-attr">includeSubDomains</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 包含子域名</span>\n  <span class="hljs-attr">preload</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 提交到浏览器预加载列表</span>\n}\n</code></pre>\n</li>\n</ul>\n<h3><strong>（3）<code>Content-Security-Policy</code> (CSP)</strong></h3>\n<ul>\n<li><strong>作用</strong>  ：限制资源（脚本、样式、图片等）加载来源。</li>\n<li><strong>常见配置</strong>  ：<pre><code class="language-javascript"><span class="hljs-attr">directives</span>: {\n  <span class="hljs-attr">defaultSrc</span>: [<span class="hljs-string">&quot;&#x27;none&#x27;&quot;</span>], <span class="hljs-comment">// 默认禁止所有</span>\n  <span class="hljs-attr">scriptSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>],  <span class="hljs-comment">// 只允许同源脚本</span>\n  <span class="hljs-attr">connectSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;api.example.com&#x27;</span>], <span class="hljs-comment">// 允许连接的域名</span>\n  <span class="hljs-attr">reportUri</span>: <span class="hljs-string">&#x27;/csp-violation&#x27;</span> <span class="hljs-comment">// 违规报告地址</span>\n}\n</code></pre>\n</li>\n</ul>\n<hr>\n<h2><strong>5. 常见问题解决方案</strong></h2>\n<h3><strong>Q: 为什么我的静态资源被 CSP 拦截？</strong></h3>\n<ul>\n<li><strong>原因</strong>  ：未在 <code>scriptSrc</code>/<code>styleSrc</code> 中配置资源域名。</li>\n<li><strong>解决</strong>  ：扩展 CSP 规则：<pre><code class="language-javascript"><span class="hljs-attr">scriptSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;cdn.jsdelivr.net&#x27;</span>]\n</code></pre>\n</li>\n</ul>\n<h3><strong>Q: 如何临时禁用某些安全头？</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">helmet</span>({\n    <span class="hljs-attr">xssFilter</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 禁用 XSS 防护</span>\n    <span class="hljs-attr">dnsPrefetchControl</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 禁用 DNS 预取控制</span>\n  })\n);\n</code></pre>\n<h3><strong>Q: <code>koa-helmet</code> 和 <code>@koa/cors</code> 冲突？</strong></h3>\n<ul>\n<li><strong>现象</strong>  ：启用 CORS 后某些安全头失效。</li>\n<li><strong>解决</strong>  ：调整中间件顺序，确保 <code>helmet()</code> 在 <code>cors()</code> <strong>之后</strong>  ：<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>());\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">helmet</span>());\n</code></pre>\n</li>\n</ul>\n<hr>\n<h2><strong>6. 生产环境最佳实践</strong></h2>\n<ol>\n<li><strong>强制 HTTPS</strong>  ：<pre><code class="language-javascript"><span class="hljs-attr">hsts</span>: { <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>, <span class="hljs-attr">preload</span>: <span class="hljs-literal">true</span> }\n</code></pre>\n</li>\n<li><strong>严格 CSP</strong>  ：\n<ul>\n<li>禁止内联脚本（避免 <code>\'unsafe-inline\'</code>）。</li>\n<li>限制第三方资源域名。</li>\n</ul>\n</li>\n<li><strong>监控违规报告</strong>  ：<pre><code class="language-javascript"><span class="hljs-attr">contentSecurityPolicy</span>: {\n  <span class="hljs-attr">directives</span>: {\n    <span class="hljs-attr">reportUri</span>: <span class="hljs-string">&#x27;/security/csp-report&#x27;</span>\n  }\n}\n</code></pre>\n</li>\n<li><strong>定期更新配置</strong>  ：\n<ul>\n<li>关注 <a href="https://helmetjs.github.io/" target="_blank">Helmet 官方文档</a> 获取最新安全建议。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2><strong>7. 完整配置示例</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-helmet&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n\napp.<span class="hljs-title function_">use</span>(\n  <span class="hljs-title function_">helmet</span>({\n    <span class="hljs-attr">contentSecurityPolicy</span>: {\n      <span class="hljs-attr">directives</span>: {\n        <span class="hljs-attr">defaultSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>],\n        <span class="hljs-attr">scriptSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&quot;&#x27;unsafe-eval&#x27;&quot;</span>, <span class="hljs-string">&#x27;cdn.jsdelivr.net&#x27;</span>],\n        <span class="hljs-attr">styleSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&quot;&#x27;unsafe-inline&#x27;&quot;</span>],\n        <span class="hljs-attr">imgSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;data:&#x27;</span>, <span class="hljs-string">&#x27;static.example.com&#x27;</span>],\n        <span class="hljs-attr">connectSrc</span>: [<span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>, <span class="hljs-string">&#x27;api.example.com&#x27;</span>],\n        <span class="hljs-attr">reportUri</span>: <span class="hljs-string">&#x27;/report-csp&#x27;</span>\n      }\n    },\n    <span class="hljs-attr">hsts</span>: {\n      <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>,\n      <span class="hljs-attr">includeSubDomains</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">preload</span>: <span class="hljs-literal">true</span>\n    },\n    <span class="hljs-attr">frameguard</span>: {\n      <span class="hljs-attr">action</span>: <span class="hljs-string">&#x27;deny&#x27;</span>\n    },\n    <span class="hljs-attr">referrerPolicy</span>: { <span class="hljs-attr">policy</span>: <span class="hljs-string">&#x27;same-origin&#x27;</span> }\n  })\n);\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;安全头已全部启用！&#x27;</span>;\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li><code>koa-helmet</code> 是 Koa 应用的安全基石，<strong>生产环境必须启用</strong>  。</li>\n<li><strong>关键防护</strong>  ：CSP、HSTS、X-Frame-Options。</li>\n<li><strong>灵活配置</strong>  ：根据业务需求调整各项规则。</li>\n<li><strong>安全平衡</strong>  ：在安全性和功能便利性之间找到平衡（如谨慎使用 <code>unsafe-inline</code>）。</li>\n</ul>\n</div>'</script></body></html>