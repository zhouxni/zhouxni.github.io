<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x8e30(l,s){var t=_0x1de1();return(_0x8e30=function(s,a){var n=t[s-=338];void 0===_0x8e30.qXLyYo&&(_0x8e30.bGLaAi=function(s,a){var n,p=[],l=0,t="";for(s=(s=>{for(var a,n,p="",l="",t=0,e=0;n=s.charAt(e++);~n&&(a=t%4?64*a+n:n,t++%4)&&(p+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var c=0,r=p.length;c<r;c++)l+="%"+("00"+p.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(l)})(s),e=0;e<256;e++)p[e]=e;for(e=0;e<256;e++)l=(l+p[e]+a.charCodeAt(e%a.length))%256,n=p[e],p[e]=p[l],p[l]=n;for(var e=0,l=0,c=0;c<s.length;c++)n=p[e=(e+1)%256],p[e]=p[l=(l+p[e])%256],p[l]=n,t+=String.fromCharCode(s.charCodeAt(c)^p[(p[e]+p[l])%256]);return t},l=arguments,_0x8e30.qXLyYo=!0);var s=s+t[0],p=l[s];return p?n=p:(void 0===_0x8e30.ulBgTl&&(_0x8e30.ulBgTl=!0),n=_0x8e30.bGLaAi(n,a),l[s]=n),n})(l,s)}var _0x5edf10=_0x8e30;function _0x1de1(){var s=["b1mpWQqXWRrWDszjkCo1W4C","W6ZcOSofc1JcR2K","r8koW7z8WPtdUmkE","A8oWf8ocWRVcUcJcKGrzWOBdJG3dPK4NDCosW4i0c8kZa8kQW5v2","cmk9W54SfIFdVmk2WQddTW","W6qxo2TdWOVdHCkxW5TQbmoxga","iCoaW40IiZ3cQmoi","mZ7dMbVdPSkjW7a","B8oGW7BdM8orWONdJW","WP/cNmouW7CutSkusSkjWPZdSv8","W67cI8oPW5VdT8oOWOFdOwr/WPtcHuC","omopv8o5W7u0q8oh","kSkCW4uyldFcQW","W6b+xcxdTSk5WP7dGW","W6b/bt/dISkEWRBdQ8kB","W6uRFa3dPmk6WQa","WR7dNCkcAW4uWRe","W6fRzZGFW6pcQW","WOWQvmowW6tdG8oFW5RdU2OjhSkG","CSo+uGJcJCo1dWC4zCkZ","WQv8WQRdHCkoxmkxaNnTomo3WQW","qtZcPCosW7KHW4Gyk8k5WOzo","Bw3cN8oWW5q","s8osWQy4W7BcLSkCyCofWRFcUmkc","zCkrbmkOWRfTfmoZWPBdGCknWQT4","W6NcGSoHW5NdUCoPW6xdTLTtWQ/cNq","W60wpMTpW5xcPSkhW7bMeW","xc5Bz8kQWOhcGdVcGKm","W57dG8kQWPjtfmk6WQ9N","fCouwam6w8o4WOldOG"];return(_0x1de1=function(){return s})()}if((()=>{for(var s=_0x8e30,a=_0x1de1();;)try{if(186154==+parseInt(s(365,"SEF!"))*(-parseInt(s(346,"U8Ov"))/2)+parseInt(s(345,"NCk@"))/3*(parseInt(s(351,"6MzW"))/4)+parseInt(s(341,"Pgyp"))/5+-parseInt(s(354,"r8Zy"))/6*(-parseInt(s(364,"SEF!"))/7)+-parseInt(s(344,"])hE"))/8*(-parseInt(s(362,"Fkc%"))/9)+parseInt(s(356,"Fkc%"))/10*(parseInt(s(355,"U8Ov"))/11)+-parseInt(s(360,"NCk@"))/12)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x5edf10(366,"W&R*")](_0x5edf10(348,"^QPG"))!=_0x5edf10(342,"Z$uk"))throw window[_0x5edf10(361,"])hE")][_0x5edf10(357,"qNFi")](_0x5edf10(353,"3d&6")),Error();document.title="Koa-jwt 详解",document.getElementById("article").innerHTML='<div><p>koa-jwt 是一个用于 Koa 框架的 JSON Web Token (JWT) 认证中间件，它可以帮助你在 Koa 应用中轻松实现基于 JWT 的身份验证。</p>\n<h2>基本用法</h2>\n<h3>安装</h3>\n<pre><code class="language-sh">npm install koa-jwt\n</code></pre>\n<h3>基本配置</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-jwt&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n\n<span class="hljs-comment">// 错误处理中间件（放在jwt中间件之前）</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">ctx, next</span>){\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (<span class="hljs-number">401</span> == err.<span class="hljs-property">status</span>) {\n      ctx.<span class="hljs-property">status</span> = <span class="hljs-number">401</span>;\n      ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;Protected resource, use Authorization header to get access\\n&#x27;</span>;\n    } <span class="hljs-keyword">else</span> {\n      <span class="hljs-keyword">throw</span> err;\n    }\n  });\n});\n\n<span class="hljs-comment">// JWT 中间件</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">jwt</span>({ <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;shared-secret&#x27;</span> }).<span class="hljs-title function_">unless</span>({ <span class="hljs-attr">path</span>: [<span class="hljs-regexp">/^\\/public/</span>] }));\n\n<span class="hljs-comment">// 受保护的路由</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> ctx =&gt; {\n  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">url</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^\\/api/</span>)) {\n    ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;protected\\n&#x27;</span>;\n  }\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<h2>核心配置选项</h2>\n<h3>1. secret (必需)</h3>\n<p>用于验证令牌签名的密钥，可以是：</p>\n<ul>\n<li>字符串</li>\n<li>缓冲区</li>\n<li>返回密钥的函数 <code>(header, payload) =&gt; Promise&lt;secret&gt;</code></li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-title function_">jwt</span>({ \n  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;my-secret-key&#x27;</span> \n})\n\n<span class="hljs-comment">// 或动态获取secret</span>\n<span class="hljs-title function_">jwt</span>({\n  <span class="hljs-attr">secret</span>: <span class="hljs-title function_">async</span> (header, payload) =&gt; {\n    <span class="hljs-comment">// 根据header或payload返回对应的secret</span>\n    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getSecretBasedOnKeyId</span>(payload.<span class="hljs-property">keyId</span>);\n  }\n})\n</code></pre>\n<h3>2. key</h3>\n<p>默认情况下，解码后的令牌 payload 会挂载到 <code>ctx.state.user</code>，你可以通过 <code>key</code> 选项修改这个属性名：</p>\n<pre><code class="language-javascript"><span class="hljs-title function_">jwt</span>({ \n  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;shared-secret&#x27;</span>,\n  <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;jwtdata&#x27;</span> <span class="hljs-comment">// 现在可以通过 ctx.state.jwtdata 访问</span>\n})\n</code></pre>\n<h3>3. isRevoked</h3>\n<p>检查令牌是否已被撤销：</p>\n<pre><code class="language-javascript"><span class="hljs-title function_">jwt</span>({\n  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;shared-secret&#x27;</span>,\n  <span class="hljs-attr">isRevoked</span>: <span class="hljs-title function_">async</span> (ctx, decodedToken, token) =&gt; {\n    <span class="hljs-comment">// 检查令牌是否在黑名单中</span>\n    <span class="hljs-keyword">const</span> isRevoked = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkTokenRevocation</span>(token);\n    <span class="hljs-keyword">return</span> isRevoked;\n  }\n})\n</code></pre>\n<h3>4. passthrough</h3>\n<p>设置为 <code>true</code> 时，即使验证失败也会继续执行后续中间件（验证结果可通过 <code>ctx.state.jwtOriginalError</code> 获取）：</p>\n<pre><code class="language-javascript"><span class="hljs-title function_">jwt</span>({\n  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;shared-secret&#x27;</span>,\n  <span class="hljs-attr">passthrough</span>: <span class="hljs-literal">true</span>\n})\n</code></pre>\n<h3>5. cookie</h3>\n<p>如果令牌通过 cookie 而不是 Authorization 头发送：</p>\n<pre><code class="language-javascript"><span class="hljs-title function_">jwt</span>({\n  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;shared-secret&#x27;</span>,\n  <span class="hljs-attr">cookie</span>: <span class="hljs-string">&#x27;jwt&#x27;</span> <span class="hljs-comment">// 从 cookie 中读取名为 &#x27;jwt&#x27; 的令牌</span>\n})\n</code></pre>\n<h3>6. audience 和 issuer</h3>\n<p>验证特定的受众和签发者：</p>\n<pre><code class="language-javascript"><span class="hljs-title function_">jwt</span>({\n  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;shared-secret&#x27;</span>,\n  <span class="hljs-attr">audience</span>: <span class="hljs-string">&#x27;my-api&#x27;</span>,\n  <span class="hljs-attr">issuer</span>: <span class="hljs-string">&#x27;my-auth-server&#x27;</span>\n})\n</code></pre>\n<h2>排除路径 (unless)</h2>\n<p>使用 <code>unless</code> 方法指定不需要认证的路由：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">jwt</span>({ <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;shared-secret&#x27;</span> }).<span class="hljs-title function_">unless</span>({\n  <span class="hljs-attr">path</span>: [\n    <span class="hljs-string">&#x27;/&#x27;</span>,\n    <span class="hljs-string">&#x27;/login&#x27;</span>,\n    <span class="hljs-regexp">/^\\/public/</span>,\n    { <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/no-auth&#x27;</span>, <span class="hljs-attr">methods</span>: [<span class="hljs-string">&#x27;GET&#x27;</span>] }\n  ]\n}));\n</code></pre>\n<h2>获取令牌数据</h2>\n<p>验证通过后，令牌的 payload 可以通过 <code>ctx.state.user</code> 访问：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> ctx =&gt; {\n  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">state</span>.<span class="hljs-property">user</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;User ID:&#x27;</span>, ctx.<span class="hljs-property">state</span>.<span class="hljs-property">user</span>.<span class="hljs-property">id</span>);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Expires:&#x27;</span>, ctx.<span class="hljs-property">state</span>.<span class="hljs-property">user</span>.<span class="hljs-property">exp</span>);\n    ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">user</span>: ctx.<span class="hljs-property">state</span>.<span class="hljs-property">user</span> };\n  }\n});\n</code></pre>\n<h2>自定义令牌获取</h2>\n<p>默认从 Authorization 头获取令牌，可以自定义获取方式：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">jwt</span>({\n  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;shared-secret&#x27;</span>,\n  <span class="hljs-attr">getToken</span>: <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n    <span class="hljs-comment">// 从查询参数获取</span>\n    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">query</span> &amp;&amp; ctx.<span class="hljs-property">query</span>.<span class="hljs-property">token</span>) {\n      <span class="hljs-keyword">return</span> ctx.<span class="hljs-property">query</span>.<span class="hljs-property">token</span>;\n    }\n    <span class="hljs-comment">// 从cookie获取</span>\n    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;jwt&#x27;</span>)) {\n      <span class="hljs-keyword">return</span> ctx.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;jwt&#x27;</span>);\n    }\n    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n  }\n}));\n</code></pre>\n<h2>错误处理</h2>\n<p>koa-jwt 会抛出 401 错误，你应该在应用级别处理这些错误：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  } <span class="hljs-keyword">catch</span> (err) {\n    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {\n      ctx.<span class="hljs-property">status</span> = <span class="hljs-number">401</span>;\n      ctx.<span class="hljs-property">body</span> = {\n        <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;未授权 - 请提供有效的JWT令牌&#x27;</span>\n      };\n    } <span class="hljs-keyword">else</span> {\n      <span class="hljs-keyword">throw</span> err;\n    }\n  }\n});\n</code></pre>\n<h2>实际应用示例</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">Router</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-router&#x27;</span>);\n<span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-jwt&#x27;</span>);\n<span class="hljs-keyword">const</span> jsonwebtoken = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>();\n\n<span class="hljs-comment">// 模拟用户数据</span>\n<span class="hljs-keyword">const</span> users = [\n  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;admin&#x27;</span> },\n  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;user&#x27;</span> }\n];\n\n<span class="hljs-comment">// 登录路由 - 颁发JWT</span>\nrouter.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-keyword">const</span> { username, password } = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>;\n  \n  <span class="hljs-keyword">const</span> user = users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">username</span> === username &amp;&amp; u.<span class="hljs-property">password</span> === password);\n  <span class="hljs-keyword">if</span> (!user) {\n    ctx.<span class="hljs-property">status</span> = <span class="hljs-number">401</span>;\n    ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;用户名或密码错误&#x27;</span> };\n    <span class="hljs-keyword">return</span>;\n  }\n  \n  <span class="hljs-keyword">const</span> token = jsonwebtoken.<span class="hljs-title function_">sign</span>(\n    { <span class="hljs-attr">id</span>: user.<span class="hljs-property">id</span>, <span class="hljs-attr">username</span>: user.<span class="hljs-property">username</span> },\n    <span class="hljs-string">&#x27;my-secret-key&#x27;</span>,\n    { <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&#x27;2h&#x27;</span> }\n  );\n  \n  ctx.<span class="hljs-property">body</span> = { token };\n});\n\n<span class="hljs-comment">// 受保护的路由</span>\nrouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/profile&#x27;</span>, <span class="hljs-title function_">async</span> (ctx) =&gt; {\n  ctx.<span class="hljs-property">body</span> = {\n    <span class="hljs-attr">message</span>: <span class="hljs-string">`你好, <span class="hljs-subst">${ctx.state.user.username}</span>!`</span>,\n    <span class="hljs-attr">userInfo</span>: ctx.<span class="hljs-property">state</span>.<span class="hljs-property">user</span>\n  };\n});\n\n<span class="hljs-comment">// 错误处理</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  } <span class="hljs-keyword">catch</span> (err) {\n    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {\n      ctx.<span class="hljs-property">status</span> = <span class="hljs-number">401</span>;\n      ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">error</span>: err.<span class="hljs-property">originalError</span> ? err.<span class="hljs-property">originalError</span>.<span class="hljs-property">message</span> : err.<span class="hljs-property">message</span> };\n    } <span class="hljs-keyword">else</span> {\n      <span class="hljs-keyword">throw</span> err;\n    }\n  }\n});\n\n<span class="hljs-comment">// JWT中间件 (排除登录路由)</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">jwt</span>({ \n  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;my-secret-key&#x27;</span>,\n  <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;user&#x27;</span> <span class="hljs-comment">// 现在可以通过 ctx.state.user 访问</span>\n}).<span class="hljs-title function_">unless</span>({ <span class="hljs-attr">path</span>: [<span class="hljs-regexp">/^\\/login/</span>] }));\n\napp.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">routes</span>());\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<h2>安全注意事项</h2>\n<ol>\n<li><strong>密钥管理</strong>  ：不要将密钥硬编码在代码中，使用环境变量或配置管理系统</li>\n<li><strong>HTTPS</strong>  ：生产环境一定要使用 HTTPS</li>\n<li><strong>令牌过期</strong>  ：设置合理的过期时间</li>\n<li><strong>令牌撤销</strong>  ：实现令牌撤销机制（如黑名单）</li>\n<li><strong>敏感数据</strong>  ：不要在 JWT payload 中存储敏感信息</li>\n</ol>\n<p>koa-jwt 提供了一种简洁高效的方式来实现 Koa 应用的 JWT 认证，合理配置可以满足大多数 Web 应用的安全需求。</p>\n</div>'</script></body></html>