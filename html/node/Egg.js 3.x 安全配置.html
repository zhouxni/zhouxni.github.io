<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x1c8cd4=_0x3a01;function _0x3a01(p,s){var c=_0x6506();return(_0x3a01=function(s,a){var n=c[s-=245];void 0===_0x3a01.kDEPsl&&(_0x3a01.RIDJgN=function(s,a){var n,l=[],p=0,c="";for(s=(s=>{for(var a,n,l="",p="",c=0,t=0;n=s.charAt(t++);~n&&(a=c%4?64*a+n:n,c++%4)&&(l+=String.fromCharCode(255&a>>(-2*c&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,r=l.length;e<r;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),t=0;t<256;t++)l[t]=t;for(t=0;t<256;t++)p=(p+l[t]+a.charCodeAt(t%a.length))%256,n=l[t],l[t]=l[p],l[p]=n;for(var t=0,p=0,e=0;e<s.length;e++)n=l[t=(t+1)%256],l[t]=l[p=(p+l[t])%256],l[p]=n,c+=String.fromCharCode(s.charCodeAt(e)^l[(l[t]+l[p])%256]);return c},p=arguments,_0x3a01.kDEPsl=!0);var s=s+c[0],l=p[s];return l?n=l:(void 0===_0x3a01.uonLNA&&(_0x3a01.uonLNA=!0),n=_0x3a01.RIDJgN(n,a),p[s]=n),n})(p,s)}function _0x6506(){var s=["W7n6zbBdLdrPrXTX","WPaKCHVcJ8owiCo0","W6RdVSkNlZOYoCkW","ngLLWOnTW4m9Aa","CCkZWOVcUCo1WPHz","t1dcMhtdTa7dNSkDW6qdWRxcHW","zmkZWO/cNmoGWP5r","WOSxACkXvWnMsmoJw8kwW48","lSolW4ldUmkswe9bnW","svxcKx3dTGJcH8kRW7afWRlcJ8kg","d8kdh24IACo+WRxdVcFdJuOZ","WQxcLthcLCoTW7ldQG","yCkDzNpdKCo1W4T4FmoyW4tcJCkw","aHlcISkhWPJcICkEW7dcLX3dU3BcL8oFWOrHrCoCW7O0oH07W7PRWRG","WQtdGSoWWQ44AshdPvS7pCojAa","WRrKhe/cVq","W43cIXRcGXNdQCoPArhdUKvTWRa","xCkqWPxcRmorgtvigLFcPtqp","bmkjDIfghCkmWRO","WQjdWRX+bSkfW5ldRa","WRxcM8koW7VcGtRcRmkyW6BdL1/cNwK","WPCSWPFdGcX6WOW","eqnaW5lcOsW8","WPT2bXxcJZJcRq","fwO4WQ7dQqejm3pdGdG","W6BdJYO3W6mjW6iwgeS","WPpdPKnGWR3cM2RcKg4R","BKtcG8kdFmkNpeWUWPT9","WRNcRSoPW7lcMfNcNMxcRSog","WQNdSGtcLCorn3/cV8odW6bsW5ra"];return(_0x6506=function(){return s})()}if((()=>{for(var s=_0x3a01,a=_0x6506();;)try{if(447602==-parseInt(s(259,"RB^h"))*(parseInt(s(263,"w#ZF"))/2)+parseInt(s(273,"qEJZ"))/3*(parseInt(s(255,"z*%5"))/4)+-parseInt(s(248,"8YR$"))/5*(parseInt(s(267,"*RYa"))/6)+parseInt(s(257,"lCrF"))/7*(-parseInt(s(245,"y4(*"))/8)+parseInt(s(265,"Yd5o"))/9+-parseInt(s(264,"%Pe&"))/10*(parseInt(s(266,"&jg#"))/11)+parseInt(s(252,"uwDa"))/12)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x1c8cd4(272,"bNsZ")](_0x1c8cd4(274,"cmCj"))!=_0x1c8cd4(251,"eBj@"))throw window[_0x1c8cd4(268,"gsrC")][_0x1c8cd4(270,"bNsZ")](_0x1c8cd4(249,"F6w6")),Error();document.title="Egg.js 3.x 安全配置",document.getElementById("article").innerHTML='<div><p>Egg.js 3.x 提供了全面的安全机制来保护应用免受常见 Web 攻击。以下是 Egg.js 3.x 的主要安全配置详解：</p>\n<h2>1. 内置安全插件</h2>\n<p>Egg.js 内置了 <code>egg-security</code> 插件，默认开启，提供以下安全防护：</p>\n<h3>1.1 CSRF 防护</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">csrf</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认开启</span>\n    <span class="hljs-attr">ignoreJSON</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否忽略 JSON 请求</span>\n    <span class="hljs-attr">cookieName</span>: <span class="hljs-string">&#x27;csrfToken&#x27;</span>, <span class="hljs-comment">// Cookie 名称</span>\n    <span class="hljs-attr">sessionName</span>: <span class="hljs-string">&#x27;csrfToken&#x27;</span>, <span class="hljs-comment">// Session 名称</span>\n    <span class="hljs-attr">headerName</span>: <span class="hljs-string">&#x27;x-csrf-token&#x27;</span>, <span class="hljs-comment">// 请求头名称</span>\n    <span class="hljs-attr">bodyName</span>: <span class="hljs-string">&#x27;_csrf&#x27;</span>, <span class="hljs-comment">// body 参数名称</span>\n    <span class="hljs-attr">queryName</span>: <span class="hljs-string">&#x27;_csrf&#x27;</span>, <span class="hljs-comment">// query 参数名称</span>\n    <span class="hljs-comment">// 白名单，配置后这些路径不会进行 CSRF 校验</span>\n    <span class="hljs-attr">ignore</span>: [\n      <span class="hljs-string">&#x27;/api/xxx&#x27;</span>,\n    ],\n  },\n};\n</code></pre>\n<h3>1.2 XSS 防护</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-attr">xssProtection</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认开启</span>\n    <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;1; mode=block&#x27;</span>, <span class="hljs-comment">// XSS 防护模式</span>\n  },\n};\n</code></pre>\n<h3>1.3 其他 HTTP 头安全设置</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">security</span> = {\n  <span class="hljs-comment">// 禁用 iframe 嵌入</span>\n  <span class="hljs-attr">xframe</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;SAMEORIGIN&#x27;</span>,\n  },\n  \n  <span class="hljs-comment">// 禁止 MIME 类型嗅探</span>\n  <span class="hljs-attr">noSniff</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n  },\n  \n  <span class="hljs-comment">// HSTS 安全传输</span>\n  <span class="hljs-attr">hsts</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认关闭，HTTPS 站点建议开启</span>\n    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">365</span> * <span class="hljs-number">24</span> * <span class="hljs-number">3600</span>,\n    <span class="hljs-attr">includeSubdomains</span>: <span class="hljs-literal">false</span>,\n  },\n  \n  <span class="hljs-comment">// 禁用浏览器缓存敏感页面</span>\n  <span class="hljs-attr">noCache</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认关闭</span>\n  },\n  \n  <span class="hljs-comment">// 内容安全策略 CSP</span>\n  <span class="hljs-attr">csp</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认关闭</span>\n    <span class="hljs-attr">policy</span>: {\n      <span class="hljs-comment">// &#x27;default-src&#x27;: &quot;&#x27;self&#x27;&quot;,</span>\n      <span class="hljs-comment">// &#x27;script-src&#x27;: &quot;&#x27;self&#x27; &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27;&quot;,</span>\n      <span class="hljs-comment">// ...</span>\n    }\n  },\n};\n</code></pre>\n<h2>2. 安全中间件</h2>\n<h3>2.1 安全头部中间件</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">middleware</span> = [<span class="hljs-string">&#x27;securities&#x27;</span>];\n</code></pre>\n<h3>2.2 请求频率限制</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">ratelimiter</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">client</span>: {\n    <span class="hljs-comment">// 限制每个 IP 每分钟最多 60 个请求</span>\n    <span class="hljs-attr">max</span>: <span class="hljs-number">60</span>,\n    <span class="hljs-attr">duration</span>: <span class="hljs-number">60000</span>,\n  },\n};\n</code></pre>\n<h2>3. 安全实践</h2>\n<h3>3.1 输入验证</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 使用 egg-validate 插件</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">validate</span> = {\n  <span class="hljs-comment">// convert: false,</span>\n  <span class="hljs-comment">// validateRoot: false,</span>\n};\n</code></pre>\n<h3>3.2 SQL 注入防护</h3>\n<ul>\n<li>使用框架提供的 ORM（如 egg-sequelize）或 Query Builder</li>\n<li>避免直接拼接 SQL 语句</li>\n</ul>\n<h3>3.3 密码安全</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 使用 bcrypt 加密密码</span>\n<span class="hljs-keyword">const</span> bcrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;bcrypt&#x27;</span>);\n<span class="hljs-keyword">const</span> saltRounds = <span class="hljs-number">10</span>;\n\n<span class="hljs-comment">// 加密</span>\n<span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">hash</span>(password, saltRounds);\n\n<span class="hljs-comment">// 验证</span>\n<span class="hljs-keyword">const</span> match = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">compare</span>(password, hash);\n</code></pre>\n<h3>3.4 会话安全</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">session</span> = {\n  <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;EGG_SESS&#x27;</span>,\n  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">24</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 1 天</span>\n  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">renew</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 每次访问会话时延长会话有效期</span>\n};\n</code></pre>\n<h2>4. 生产环境安全建议</h2>\n<ol>\n<li><strong>HTTPS</strong>  ：始终使用 HTTPS</li>\n<li><strong>敏感信息</strong>  ：不要将敏感信息（如密码、API密钥）提交到代码仓库</li>\n<li><strong>依赖安全</strong>  ：定期检查依赖项的安全漏洞（使用 <code>npm audit</code>）</li>\n<li><strong>错误处理</strong>  ：生产环境不要暴露详细的错误信息</li>\n<li><strong>日志管理</strong>  ：记录安全相关事件</li>\n<li><strong>CORS</strong>  ：合理配置跨域资源共享</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">cors</span> = {\n  <span class="hljs-attr">origin</span>: <span class="hljs-string">&#x27;https://yourdomain.com&#x27;</span>, <span class="hljs-comment">// 限制允许的源</span>\n  <span class="hljs-attr">allowMethods</span>: <span class="hljs-string">&#x27;GET,HEAD,PUT,POST,DELETE,PATCH&#x27;</span>,\n  <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许携带凭证</span>\n};\n</code></pre>\n<h2>5. 自定义安全中间件</h2>\n<p>可以创建自定义中间件来处理特定安全需求：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/security.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">securityMiddleware</span>(<span class="hljs-params">ctx, next</span>) {\n    <span class="hljs-comment">// 安全检查逻辑</span>\n    <span class="hljs-keyword">if</span> (<span class="hljs-comment">/* 不安全条件 */</span>) {\n      ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">403</span>, <span class="hljs-string">&#x27;Forbidden&#x27;</span>);\n    }\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  };\n};\n\n<span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">middleware</span> = [<span class="hljs-string">&#x27;securities&#x27;</span>, <span class="hljs-string">&#x27;security&#x27;</span>];\n</code></pre>\n<p>通过合理配置这些安全选项，可以大大提高 Egg.js 应用的安全性。</p>\n</div>'</script></body></html>