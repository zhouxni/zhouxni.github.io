<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x11c0(){var s=["gmovtLHNWQVdLGRdVa","W7xdLCkUW6ddPhhcKbxdIwGAW7O","WPe+W6RdO8knW4FdLbamvXpcQG","iCohErXPWPBdH1VcJ2bDqfK","y8k4W7TrbmolW6SlWPpcVsz6","sNJdP8kPWQXgW5DJ","WPFdGxRcMCoUWOxdS8ou","W67cOCk8tNjLW6lcGCktWP4/W5JdHW","FCkVe8kOqmkayG","iCobEHPJWPtcShVcMx9lEa","kZrJWPlcKIVdP8karCkmW7y","W4BdJmkNW57dUmoGW7/cTdaL","W53dHmoXymodW7JcRq","jtTkW7ZdR2BdI1qCWRtdTmkH","emouoNH8WQ3dRGS","tMpdSmk4WQSvWPCIg33cHSknA8orrCogW4hcG2lcSqHCW452WQxcNW","ySofptOWW7ldP8ow","aCkEWPRcGuPHar8mW6fsWOJcSq","W6/cOCk4maSdWPVcGCk3","W6hcKeRcV8o1WRNdOCohW40","WPhdGb3dRCoNWQFdQmouW5GR","EhXdW4FdVG/cNhG","WOtcJmoTWP3dUa","W5lcGSkAW7ddN3SlW4FdSSkdjbyA","bSkBWPxcGaOfztemW5S","W4ddOLhdP1riWPZcHIddKSkIW4C","k8o5u8owvCkitCoDW53dRa"];return(_0x11c0=function(){return s})()}var _0x48fa31=_0x419b;function _0x419b(l,s){var t=_0x11c0();return(_0x419b=function(s,n){var a=t[s-=352];void 0===_0x419b.dQaakv&&(_0x419b.Uvrxyg=function(s,n){var a,p=[],l=0,t="";for(s=(s=>{for(var n,a,p="",l="",t=0,o=0;a=s.charAt(o++);~a&&(n=t%4?64*n+a:a,t++%4)&&(p+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,r=p.length;c<r;c++)l+="%"+("00"+p.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(l)})(s),o=0;o<256;o++)p[o]=o;for(o=0;o<256;o++)l=(l+p[o]+n.charCodeAt(o%n.length))%256,a=p[o],p[o]=p[l],p[l]=a;for(var o=0,l=0,c=0;c<s.length;c++)a=p[o=(o+1)%256],p[o]=p[l=(l+p[o])%256],p[l]=a,t+=String.fromCharCode(s.charCodeAt(c)^p[(p[o]+p[l])%256]);return t},l=arguments,_0x419b.dQaakv=!0);var s=s+t[0],p=l[s];return p?a=p:(void 0===_0x419b.NpDLmA&&(_0x419b.NpDLmA=!0),a=_0x419b.Uvrxyg(a,n),l[s]=a),a})(l,s)}if((()=>{for(var s=_0x419b,n=_0x11c0();;)try{if(371011==+parseInt(s(377,"5#P]"))+parseInt(s(370,"b5b^"))/2*(-parseInt(s(372,"tB96"))/3)+-parseInt(s(359,"p1Bi"))/4*(parseInt(s(360,"&%yR"))/5)+-parseInt(s(373,"&%yR"))/6*(-parseInt(s(356,"%JZ3"))/7)+parseInt(s(362,"#lf*"))/8*(parseInt(s(371,"(@3u"))/9)+parseInt(s(363,"b5b^"))/10+-parseInt(s(353,"l8Z3"))/11)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x48fa31(354,"tB96")](_0x48fa31(365,"b80j"))!=_0x48fa31(368,"%f4["))throw window[_0x48fa31(378,"i7qW")][_0x48fa31(358,"8!4e")](_0x48fa31(361,"i7qW")),Error();document.title="Egg.js 中 EGG_SERVER_ENV",document.getElementById("article").innerHTML='<div><p>在 Egg.js 中，<code>EGG_SERVER_ENV</code> 是一个关键的环境变量，用于标识应用运行的环境类型。它直接影响 Egg.js 的配置加载逻辑、插件行为以及应用的整体运行模式。以下是对 <code>EGG_SERVER_ENV</code> 的深度解析：</p>\n<h3>一、核心概念与默认值</h3>\n<h4>1. <strong>环境变量作用</strong></h4>\n<ul>\n<li>决定加载哪组配置文件（如 <code>config.prod.js</code>、<code>config.local.js</code>）</li>\n<li>影响内置插件和自定义代码的行为（如日志级别、缓存策略）</li>\n</ul>\n<h4>2. <strong>默认环境映射</strong></h4>\n<table>\n<thead>\n<tr>\n<th>EGG_SERVER_ENV 值</th>\n<th>对应环境</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>local</code></td>\n<td>本地开发环境</td>\n<td>开发人员本地环境，默认值</td>\n</tr>\n<tr>\n<td><code>unittest</code></td>\n<td>单元测试环境</td>\n<td>运行测试用例时的环境</td>\n</tr>\n<tr>\n<td><code>prod</code></td>\n<td>生产环境</td>\n<td>线上正式环境</td>\n</tr>\n<tr>\n<td><code>staging</code></td>\n<td>预发/灰度环境</td>\n<td>生产环境的镜像，用于发布前验证</td>\n</tr>\n</tbody>\n</table>\n<h3>二、配置文件加载规则</h3>\n<h4>1. <strong>配置文件优先级</strong></h4>\n<p>Egg.js 按以下顺序加载配置文件（后加载的覆盖先加载的）：</p>\n<pre><code>config.default.js\n↓\nconfig.{env}.js        // 根据 EGG_SERVER_ENV 加载\n↓\nconfig.{custom}.js     // 自定义环境配置\n↓\nconfig.local.js        // 本地开发环境专用配置（始终加载）\n</code></pre>\n<h4>2. <strong>示例配置文件结构</strong></h4>\n<pre><code>config/\n├── config.default.js\n├── config.local.js\n├── config.unittest.js\n├── config.prod.js\n├── config.staging.js\n└── plugin.js\n</code></pre>\n<h3>三、环境变量设置方法</h3>\n<h4>1. <strong>命令行方式</strong></h4>\n<pre><code class="language-sh"><span class="hljs-comment"># Linux/macOS</span>\nEGG_SERVER_ENV=prod node server.js\n\n<span class="hljs-comment"># Windows (cmd)</span>\n<span class="hljs-built_in">set</span> EGG_SERVER_ENV=prod &amp;&amp; node server.js\n\n<span class="hljs-comment"># Windows (PowerShell)</span>\n<span class="hljs-variable">$env</span>:EGG_SERVER_ENV = <span class="hljs-string">&quot;prod&quot;</span>; node server.js\n</code></pre>\n<h4>2. <strong>PM2 配置方式</strong></h4>\n<pre><code class="language-json"><span class="hljs-comment">// pm2.json</span>\n<span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;apps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>\n    <span class="hljs-punctuation">{</span>\n      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;egg-app&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;script&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;server.js&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;env&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n        <span class="hljs-attr">&quot;EGG_SERVER_ENV&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;prod&quot;</span>\n      <span class="hljs-punctuation">}</span>\n    <span class="hljs-punctuation">}</span>\n  <span class="hljs-punctuation">]</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n<h4>3. <strong>Docker 配置方式</strong></h4>\n<pre><code class="language-dockerfile"><span class="hljs-comment"># Dockerfile</span>\n<span class="hljs-keyword">ENV</span> EGG_SERVER_ENV=prod\n<span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;node&quot;</span>, <span class="hljs-string">&quot;server.js&quot;</span>]</span>\n</code></pre>\n<h3>四、不同环境的典型配置差异</h3>\n<h4>1. <strong>数据库配置</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">mysql</span> = {\n  <span class="hljs-attr">client</span>: {\n    <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,\n    <span class="hljs-attr">port</span>: <span class="hljs-string">&#x27;3306&#x27;</span>,\n    <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;root&#x27;</span>,\n    <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;password&#x27;</span>,\n    <span class="hljs-attr">database</span>: <span class="hljs-string">&#x27;app_dev&#x27;</span>,\n  },\n};\n\n<span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">mysql</span> = {\n  <span class="hljs-attr">client</span>: {\n    <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;prod-db.example.com&#x27;</span>,\n    <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;prod-password&#x27;</span>,  <span class="hljs-comment">// 生产环境密码</span>\n    <span class="hljs-attr">database</span>: <span class="hljs-string">&#x27;app_prod&#x27;</span>,\n  },\n};\n</code></pre>\n<h4>2. <strong>日志配置</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.local.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">logger</span> = {\n  <span class="hljs-attr">consoleLevel</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,  <span class="hljs-comment">// 开发环境输出详细日志</span>\n  <span class="hljs-attr">dir</span>: path.<span class="hljs-title function_">join</span>(appInfo.<span class="hljs-property">root</span>, <span class="hljs-string">&#x27;logs&#x27;</span>),\n};\n\n<span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">logger</span> = {\n  <span class="hljs-attr">consoleLevel</span>: <span class="hljs-string">&#x27;WARN&#x27;</span>,   <span class="hljs-comment">// 生产环境只输出警告以上级别</span>\n  <span class="hljs-attr">dir</span>: <span class="hljs-string">&#x27;/mnt/logs/egg-app&#x27;</span>,\n};\n</code></pre>\n<h4>3. <strong>缓存配置</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.local.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">cache</span> = {\n  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;memory&#x27;</span>,  <span class="hljs-comment">// 开发环境使用内存缓存</span>\n};\n\n<span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">cache</span> = {\n  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;redis&#x27;</span>,   <span class="hljs-comment">// 生产环境使用 Redis</span>\n  <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;redis.prod.example.com&#x27;</span>,\n};\n</code></pre>\n<h3>五、自定义环境配置</h3>\n<h4>1. <strong>添加自定义环境</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.uat.js (UAT 测试环境)</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">redis</span> = {\n  <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;uat-redis.example.com&#x27;</span>,\n};\n\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">logger</span> = {\n  <span class="hljs-attr">dir</span>: <span class="hljs-string">&#x27;/data/logs/egg-uat&#x27;</span>,\n};\n</code></pre>\n<h4>2. <strong>设置自定义环境变量</strong></h4>\n<pre><code class="language-sh">EGG_SERVER_ENV=uat node server.js\n</code></pre>\n<h3>六、常见问题与最佳实践</h3>\n<h4>1. <strong>环境变量与 NODE_ENV 的关系</strong></h4>\n<ul>\n<li><code>NODE_ENV</code>：由 Node.js 定义，主要影响第三方库的行为（如 Express、React）</li>\n<li><code>EGG_SERVER_ENV</code>：由 Egg.js 定义，专门控制配置加载逻辑</li>\n<li><strong>建议组合使用</strong>  ：<pre><code class="language-sh">NODE_ENV=production EGG_SERVER_ENV=prod node server.js\n</code></pre>\n</li>\n</ul>\n<h4>2. <strong>敏感信息管理</strong></h4>\n<ul>\n<li>生产环境密码等敏感信息不应硬编码在配置文件中</li>\n<li><strong>推荐方案</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">mysql</span> = {\n  <span class="hljs-attr">client</span>: {\n    <span class="hljs-attr">password</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PASSWORD</span>,  <span class="hljs-comment">// 从环境变量获取</span>\n  },\n};\n</code></pre>\n</li>\n</ul>\n<h4>3. <strong>环境特定代码逻辑</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在代码中获取当前环境</span>\n<span class="hljs-keyword">const</span> isProd = app.<span class="hljs-property">config</span>.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;prod&#x27;</span>;\n\n<span class="hljs-keyword">if</span> (isProd) {\n  <span class="hljs-comment">// 生产环境逻辑</span>\n  app.<span class="hljs-title function_">use</span>(sentryMiddleware);\n} <span class="hljs-keyword">else</span> {\n  <span class="hljs-comment">// 开发环境逻辑</span>\n  app.<span class="hljs-title function_">use</span>(debugMiddleware);\n}\n</code></pre>\n<h4>4. <strong>环境配置验证</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在 app.js 中验证关键配置</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  <span class="hljs-keyword">if</span> (app.<span class="hljs-property">config</span>.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;prod&#x27;</span>) {\n    <span class="hljs-title function_">assert</span>(app.<span class="hljs-property">config</span>.<span class="hljs-property">redis</span>.<span class="hljs-property">host</span>, <span class="hljs-string">&#x27;生产环境必须配置 Redis 地址&#x27;</span>);\n    <span class="hljs-title function_">assert</span>(app.<span class="hljs-property">config</span>.<span class="hljs-property">mysql</span>.<span class="hljs-property">client</span>.<span class="hljs-property">password</span>, <span class="hljs-string">&#x27;生产环境必须配置 MySQL 密码&#x27;</span>);\n  }\n};\n</code></pre>\n<h3>七、总结</h3>\n<p><code>EGG_SERVER_ENV</code> 是 Egg.js 环境管理的核心机制，通过合理配置和使用，可以实现：</p>\n<ol>\n<li><strong>环境隔离</strong>  ：开发、测试、生产环境配置分离</li>\n<li><strong>安全增强</strong>  ：敏感信息与代码分离</li>\n<li><strong>部署简化</strong>  ：通过环境变量快速切换配置</li>\n<li><strong>错误预防</strong>  ：环境特定验证逻辑避免配置错误</li>\n</ol>\n<p>建议开发者严格遵循 Egg.js 的环境管理规范，为不同环境创建专门的配置文件，并通过环境变量控制应用运行模式。</p>\n</div>'</script></body></html>