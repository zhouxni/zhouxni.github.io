<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5dad(l,s){var r=_0x21cc();return(_0x5dad=function(s,n){var a=r[s-=279];void 0===_0x5dad.LgVsOu&&(_0x5dad.HPGpIa=function(s,n){var a,e=[],l=0,r="";for(s=(s=>{for(var n,a,e="",l="",r=0,p=0;a=s.charAt(p++);~a&&(n=r%4?64*n+a:a,r++%4)&&(e+=String.fromCharCode(255&n>>(-2*r&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var t=0,o=e.length;t<o;t++)l+="%"+("00"+e.charCodeAt(t).toString(16)).slice(-2);return decodeURIComponent(l)})(s),p=0;p<256;p++)e[p]=p;for(p=0;p<256;p++)l=(l+e[p]+n.charCodeAt(p%n.length))%256,a=e[p],e[p]=e[l],e[l]=a;for(var p=0,l=0,t=0;t<s.length;t++)a=e[p=(p+1)%256],e[p]=e[l=(l+e[p])%256],e[l]=a,r+=String.fromCharCode(s.charCodeAt(t)^e[(e[p]+e[l])%256]);return r},l=arguments,_0x5dad.LgVsOu=!0);var s=s+r[0],e=l[s];return e?a=e:(void 0===_0x5dad.KAoJub&&(_0x5dad.KAoJub=!0),a=_0x5dad.HPGpIa(a,n),l[s]=a),a})(l,s)}var _0x190bf4=_0x5dad;if((()=>{for(var s=_0x5dad,n=_0x21cc();;)try{if(144423==-parseInt(s(288,"hu35"))*(-parseInt(s(295,"CxuW"))/2)+-parseInt(s(291,"x$Io"))/3*(parseInt(s(289,"2S0o"))/4)+-parseInt(s(292,"S%tK"))/5*(parseInt(s(305,"3vb4"))/6)+-parseInt(s(283,"x$Io"))/7+-parseInt(s(294,"1Kvs"))/8*(parseInt(s(300,"1d$2"))/9)+parseInt(s(302,"hu35"))/10+parseInt(s(298,"uS^V"))/11)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x190bf4(287,"sbjf")](_0x190bf4(281,"VOq6"))!=_0x190bf4(304,"Iw(b"))throw window[_0x190bf4(296,"ghOW")][_0x190bf4(293,"(!v!")](_0x190bf4(301,"8YW9")),Error();function _0x21cc(){var s=["WRrxW6/cGWpdVgdcSx/dNCk/","pNrZWORdR8khWQ9HWPyqfCkVW60","BdhdKYf6W7D0yq","CSoCmdpcPCk/qmkXyq4dha8","u8o1zSkouSklW7JdUvWPFwu","WOLZWQrLWOhdKmod","WQFdUJHKWONcOSkIj8oeW7mA","W7D1zCkCe8kZg8kI","W61HpCoVeCkYWRnXW5u5lSowFG","pNj+WO3dRSkdW5T9WPKDiSkg","xmobWOfUW6HRW6DSxCoOCW","mCkoEgNdSCoRea","zfuCzvmneSkCW4W2","kLRcJahdPHS/rW","W7yDgmoMrmkvAmoU","WOrWq1ydECktWPS3W4O","uCoYymkmx8kiWOZdLuuNu0aj","W5WHW6KFW43cHCkEWOeQvb/dNbq","W43dJmkRh1VdHZCjW5SY","jN5fW4KqzcK3uSo2WP8KzCogW7nqzqzDW5TurmoHvqpcHa","WQhdVJbHWOpdHSoalSoPW4yVv3e","BZBcP3zFW5v8D8kVWPi","n8oieSk1yq","W6/dIGRdO8kjW7TREq","ernUoSoxqmoMfa","WP7cP2WhcvFdTConW60MW4q","WRz1W4/cSmotWRTfWRS","W7CTW6xcQ8oJW7mGWP48"];return(_0x21cc=function(){return s})()}document.title="Eggjs 3.x é¡¹ç›®éƒ¨ç½²",document.getElementById("article").innerHTML='<div><p>éƒ¨ç½² Egg.js 3.x é¡¹ç›®é€šå¸¸æ¶‰åŠ <strong>ç”Ÿäº§ç¯å¢ƒé…ç½®</strong>  ã€<strong>è¿›ç¨‹ç®¡ç†</strong>  ã€<strong>æ—¥å¿—å¤„ç†</strong>   å’Œ <strong>æ€§èƒ½ä¼˜åŒ–</strong>  ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„éƒ¨ç½²æŒ‡å—ï¼Œæ¶µç›–å¤šç§åœºæ™¯ï¼ˆå¦‚äº‘æœåŠ¡å™¨ã€Dockerã€Serverless ç­‰ï¼‰ã€‚</p>\n<hr>\n<h2><strong>1. åŸºç¡€éƒ¨ç½²ï¼ˆNode.js ç¯å¢ƒï¼‰</strong></h2>\n<p>é€‚ç”¨äº <strong>Linux/Windows æœåŠ¡å™¨</strong>   æˆ– <strong>äº‘ä¸»æœºï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰</strong>  ã€‚</p>\n<h3><strong>1.1 ç”Ÿäº§ç¯å¢ƒé…ç½®</strong></h3>\n<h4><strong>(1) ä¿®æ”¹ <code>config/config.prod.js</code></strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// å…³é—­å¼€å‘å·¥å…·</span>\n  <span class="hljs-attr">security</span>: {\n    <span class="hljs-attr">csrf</span>: {\n      <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒå»ºè®®å¼€å¯å¹¶é…ç½®ç™½åå•</span>\n    },\n  },\n  <span class="hljs-comment">// é™æ€èµ„æº CDN é…ç½®ï¼ˆå¯é€‰ï¼‰</span>\n  <span class="hljs-attr">static</span>: {\n    <span class="hljs-attr">prefix</span>: <span class="hljs-string">&#x27;/public/&#x27;</span>,\n    <span class="hljs-attr">dir</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;../app/public&#x27;</span>),\n    <span class="hljs-attr">dynamic</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">preload</span>: <span class="hljs-literal">false</span>,\n    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>,\n  },\n};\n</code></pre>\n<h4><strong>(2) å®‰è£…ä¾èµ–ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰</strong></h4>\n<pre><code class="language-sh">npm install --production <span class="hljs-comment"># ä»…å®‰è£… dependencies</span>\n</code></pre>\n<h4><strong>(3) æ„å»ºå‰ç«¯èµ„æºï¼ˆå¦‚ SSR é¡¹ç›®ï¼‰</strong></h4>\n<pre><code class="language-sh">npm run build <span class="hljs-comment"># å¦‚æœå‰ç«¯æœ‰ Webpack/Vue/React æ„å»º</span>\n</code></pre>\n<hr>\n<h3><strong>1.2 ä½¿ç”¨ <code>egg-scripts</code> å¯åŠ¨æœåŠ¡</strong></h3>\n<p>Egg.js å®˜æ–¹æ¨èä½¿ç”¨ <a href="https://github.com/eggjs/egg-scripts" target="_blank">egg-scripts</a> ç®¡ç†è¿›ç¨‹ã€‚</p>\n<h4><strong>(1) å…¨å±€å®‰è£… <code>egg-scripts</code></strong></h4>\n<pre><code class="language-sh">npm install egg-scripts -g\n</code></pre>\n<h4><strong>(2) å¯åŠ¨æœåŠ¡</strong></h4>\n<pre><code class="language-sh">egg-scripts start --daemon --title=egg-server-app --workers=4\n</code></pre>\n<ul>\n<li><code>--daemon</code>ï¼šåå°è¿è¡Œ</li>\n<li><code>--title</code>ï¼šè¿›ç¨‹åï¼ˆç”¨äºç›‘æ§ï¼‰</li>\n<li><code>--workers</code>ï¼šæ ¹æ® CPU æ ¸å¿ƒæ•°è®¾ç½®ï¼ˆé€šå¸¸ <code>CPU æ ¸å¿ƒæ•° * 2</code>ï¼‰</li>\n</ul>\n<h4><strong>(3) åœæ­¢æœåŠ¡</strong></h4>\n<pre><code class="language-sh">egg-scripts stop\n</code></pre>\n<hr>\n<h2><strong>2. é«˜çº§éƒ¨ç½²æ–¹æ¡ˆ</strong></h2>\n<h3><strong>2.1 ä½¿ç”¨ PM2ï¼ˆæ¨èï¼‰</strong></h3>\n<p>PM2 æä¾›æ›´å¼ºå¤§çš„è¿›ç¨‹ç®¡ç†ã€æ—¥å¿—åˆ‡å‰²å’Œç›‘æ§ã€‚</p>\n<h4><strong>(1) å®‰è£… PM2</strong></h4>\n<pre><code class="language-sh">npm install pm2 -g\n</code></pre>\n<h4><strong>(2) é…ç½® <code>ecosystem.config.js</code></strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// ecosystem.config.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">apps</span>: [{\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;egg-app&#x27;</span>,\n    <span class="hljs-attr">script</span>: <span class="hljs-string">&#x27;node&#x27;</span>,\n    <span class="hljs-attr">args</span>: <span class="hljs-string">&#x27;dist/index.js&#x27;</span>, <span class="hljs-comment">// å¦‚æœæ˜¯ TS é¡¹ç›®ï¼Œç¼–è¯‘åå…¥å£æ–‡ä»¶</span>\n    <span class="hljs-attr">instances</span>: <span class="hljs-number">4</span>,         <span class="hljs-comment">// é›†ç¾¤æ¨¡å¼ï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰</span>\n    <span class="hljs-attr">exec_mode</span>: <span class="hljs-string">&#x27;cluster&#x27;</span>, <span class="hljs-comment">// å¤šè¿›ç¨‹</span>\n    <span class="hljs-attr">max_memory_restart</span>: <span class="hljs-string">&#x27;500M&#x27;</span>, <span class="hljs-comment">// å†…å­˜è¶…é™è‡ªåŠ¨é‡å¯</span>\n    <span class="hljs-attr">env</span>: {\n      <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;production&#x27;</span>,\n    },\n  }],\n};\n</code></pre>\n<h4><strong>(3) å¯åŠ¨æœåŠ¡</strong></h4>\n<pre><code class="language-sh">pm2 start ecosystem.config.js\n</code></pre>\n<h4><strong>(4) å¸¸ç”¨å‘½ä»¤</strong></h4>\n<pre><code class="language-sh">pm2 logs          <span class="hljs-comment"># æŸ¥çœ‹æ—¥å¿—</span>\npm2 monit         <span class="hljs-comment"># ç›‘æ§è¿›ç¨‹çŠ¶æ€</span>\npm2 reload egg-app <span class="hljs-comment"># å¹³æ»‘é‡å¯</span>\n</code></pre>\n<hr>\n<h3><strong>2.2 Docker éƒ¨ç½²</strong></h3>\n<p>é€‚åˆ <strong>å®¹å™¨åŒ–ç¯å¢ƒï¼ˆå¦‚ Kubernetesï¼‰</strong>  ã€‚</p>\n<h4><strong>(1) ç¼–å†™ <code>Dockerfile</code></strong></h4>\n<pre><code class="language-dockerfile"><span class="hljs-comment"># ä½¿ç”¨ Node.js å®˜æ–¹é•œåƒ</span>\n<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">16</span>-alpine\n\n<span class="hljs-comment"># è®¾ç½®å·¥ä½œç›®å½•</span>\n<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span>\n\n<span class="hljs-comment"># å¤åˆ¶ä¾èµ–å®šä¹‰</span>\n<span class="hljs-keyword">COPY</span><span class="language-bash"> package*.json ./</span>\n\n<span class="hljs-comment"># å®‰è£…ä¾èµ–ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰</span>\n<span class="hljs-keyword">RUN</span><span class="language-bash"> npm install --production</span>\n\n<span class="hljs-comment"># å¤åˆ¶é¡¹ç›®æ–‡ä»¶</span>\n<span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span>\n\n<span class="hljs-comment"># æ„å»ºï¼ˆå¦‚éœ€è¦ï¼‰</span>\n<span class="hljs-keyword">RUN</span><span class="language-bash"> npm run build</span>\n\n<span class="hljs-comment"># æš´éœ²ç«¯å£</span>\n<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">7001</span>\n\n<span class="hljs-comment"># å¯åŠ¨å‘½ä»¤</span>\n<span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;npm&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>]</span>\n</code></pre>\n<h4><strong>(2) æ„å»ºé•œåƒ</strong></h4>\n<pre><code class="language-sh">docker build -t egg-app .\n</code></pre>\n<h4><strong>(3) è¿è¡Œå®¹å™¨</strong></h4>\n<pre><code class="language-sh">docker run -d -p 7001:7001 --name egg-app egg-app\n</code></pre>\n<hr>\n<h3><strong>2.3 Serverless éƒ¨ç½²ï¼ˆå¦‚é˜¿é‡Œäº‘ FCï¼‰</strong></h3>\n<p>é€‚åˆ <strong>æ— æœåŠ¡å™¨æ¶æ„</strong>  ã€‚</p>\n<h4><strong>(1) å®‰è£… <code>@midwayjs/fc-starter</code></strong></h4>\n<pre><code class="language-sh">npm install @midwayjs/fc-starter --save\n</code></pre>\n<h4><strong>(2) ä¿®æ”¹ <code>f.yml</code> é…ç½®</strong></h4>\n<pre><code class="language-yaml"><span class="hljs-attr">service:</span>\n  <span class="hljs-attr">name:</span> <span class="hljs-string">egg-app</span>\n\n<span class="hljs-attr">provider:</span>\n  <span class="hljs-attr">name:</span> <span class="hljs-string">alibaba</span>\n\n<span class="hljs-attr">deployType:</span>\n  <span class="hljs-attr">type:</span> <span class="hljs-string">egg</span>\n\n<span class="hljs-attr">functions:</span>\n  <span class="hljs-attr">web:</span>\n    <span class="hljs-attr">handler:</span> <span class="hljs-string">index.handler</span>\n    <span class="hljs-attr">events:</span>\n      <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span>\n          <span class="hljs-attr">path:</span> <span class="hljs-string">/</span>\n          <span class="hljs-attr">method:</span> <span class="hljs-string">GET</span>\n</code></pre>\n<h4><strong>(3) éƒ¨ç½²åˆ°é˜¿é‡Œäº‘</strong></h4>\n<pre><code class="language-sh">npm run deploy\n</code></pre>\n<hr>\n<h2><strong>3. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–</strong></h2>\n<h3><strong>3.1 æ—¥å¿—ç®¡ç†</strong></h3>\n<ul>\n<li><strong>æ—¥å¿—åˆ‡å‰²</strong>  ï¼šä½¿ç”¨ <code>pm2-logrotate</code> æˆ– <code>logrotate</code></li>\n<li><strong>ELK æ”¶é›†</strong>  ï¼šæ¥å…¥ Elasticsearch + Kibana</li>\n</ul>\n<h3><strong>3.2 ç›‘æ§å‘Šè­¦</strong></h3>\n<ul>\n<li><strong>Prometheus + Grafana</strong>  ï¼šç›‘æ§ QPSã€CPUã€å†…å­˜</li>\n<li><strong>Sentry</strong>  ï¼šé”™è¯¯è¿½è¸ª</li>\n</ul>\n<h3><strong>3.3 æ€§èƒ½è°ƒä¼˜</strong></h3>\n<ul>\n<li><strong>Nginx åå‘ä»£ç†</strong>  ï¼ˆè´Ÿè½½å‡è¡¡ + HTTPSï¼‰<pre><code class="language-nginx"><span class="hljs-section">upstream</span> egg_servers {\n  <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:7001</span>;\n  <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:7002</span>;\n}\n\n<span class="hljs-section">server</span> {\n  <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;\n  <span class="hljs-attribute">server_name</span> yourdomain.com;\n\n  <span class="hljs-section">location</span> / {\n    <span class="hljs-attribute">proxy_pass</span> http://egg_servers;\n  }\n}\n</code></pre>\n</li>\n</ul>\n<hr>\n<h2><strong>4. å¸¸è§é—®é¢˜</strong></h2>\n<h3><strong>Q1: å¦‚ä½•å®ç°é›¶åœæœºå‘å¸ƒï¼Ÿ</strong></h3>\n<ul>\n<li><strong>æ–¹æ¡ˆ</strong>  ï¼š\n<ul>\n<li><code>pm2 reload</code>ï¼ˆå¹³æ»‘é‡å¯ï¼‰</li>\n<li>è“ç»¿éƒ¨ç½²ï¼ˆKubernetes + Nginxï¼‰</li>\n</ul>\n</li>\n</ul>\n<h3><strong>Q2: é™æ€èµ„æºå¦‚ä½•åŠ é€Ÿï¼Ÿ</strong></h3>\n<ul>\n<li><strong>æ–¹æ¡ˆ</strong>  ï¼š\n<ul>\n<li>ä¸Šä¼ è‡³ CDNï¼ˆå¦‚é˜¿é‡Œäº‘ OSS + CDNï¼‰</li>\n<li>é…ç½® <code>config.prod.js</code> ä¸­çš„ <code>static</code> é€‰é¡¹</li>\n</ul>\n</li>\n</ul>\n<h3><strong>Q3: å¦‚ä½•æ’æŸ¥å†…å­˜æ³„æ¼ï¼Ÿ</strong></h3>\n<ul>\n<li><strong>å·¥å…·</strong>  ï¼š\n<ul>\n<li><code>node --inspect</code> + Chrome DevTools</li>\n<li><code>heapdump</code> åˆ†æå†…å­˜å¿«ç…§</li>\n</ul>\n</li>\n</ul>\n<hr>\n<p>æŒ‰ç…§ä¸Šè¿°æ­¥éª¤ï¼Œä½ å¯ä»¥è½»æ¾éƒ¨ç½² Egg.js 3.x é¡¹ç›®åˆ°å„ç§ç¯å¢ƒã€‚å¦‚æœæœ‰ç‰¹å®šåœºæ™¯éœ€æ±‚ï¼ˆå¦‚ Kubernetes æˆ– Serverlessï¼‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ¢è®¨ï¼ ğŸš€</p>\n</div>'</script></body></html>