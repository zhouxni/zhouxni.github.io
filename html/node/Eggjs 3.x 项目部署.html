<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5dad(l,s){var r=_0x21cc();return(_0x5dad=function(s,n){var a=r[s-=279];void 0===_0x5dad.LgVsOu&&(_0x5dad.HPGpIa=function(s,n){var a,e=[],l=0,r="";for(s=(s=>{for(var n,a,e="",l="",r=0,p=0;a=s.charAt(p++);~a&&(n=r%4?64*n+a:a,r++%4)&&(e+=String.fromCharCode(255&n>>(-2*r&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var t=0,o=e.length;t<o;t++)l+="%"+("00"+e.charCodeAt(t).toString(16)).slice(-2);return decodeURIComponent(l)})(s),p=0;p<256;p++)e[p]=p;for(p=0;p<256;p++)l=(l+e[p]+n.charCodeAt(p%n.length))%256,a=e[p],e[p]=e[l],e[l]=a;for(var p=0,l=0,t=0;t<s.length;t++)a=e[p=(p+1)%256],e[p]=e[l=(l+e[p])%256],e[l]=a,r+=String.fromCharCode(s.charCodeAt(t)^e[(e[p]+e[l])%256]);return r},l=arguments,_0x5dad.LgVsOu=!0);var s=s+r[0],e=l[s];return e?a=e:(void 0===_0x5dad.KAoJub&&(_0x5dad.KAoJub=!0),a=_0x5dad.HPGpIa(a,n),l[s]=a),a})(l,s)}var _0x190bf4=_0x5dad;if((()=>{for(var s=_0x5dad,n=_0x21cc();;)try{if(144423==-parseInt(s(288,"hu35"))*(-parseInt(s(295,"CxuW"))/2)+-parseInt(s(291,"x$Io"))/3*(parseInt(s(289,"2S0o"))/4)+-parseInt(s(292,"S%tK"))/5*(parseInt(s(305,"3vb4"))/6)+-parseInt(s(283,"x$Io"))/7+-parseInt(s(294,"1Kvs"))/8*(parseInt(s(300,"1d$2"))/9)+parseInt(s(302,"hu35"))/10+parseInt(s(298,"uS^V"))/11)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x190bf4(287,"sbjf")](_0x190bf4(281,"VOq6"))!=_0x190bf4(304,"Iw(b"))throw window[_0x190bf4(296,"ghOW")][_0x190bf4(293,"(!v!")](_0x190bf4(301,"8YW9")),Error();function _0x21cc(){var s=["WRrxW6/cGWpdVgdcSx/dNCk/","pNrZWORdR8khWQ9HWPyqfCkVW60","BdhdKYf6W7D0yq","CSoCmdpcPCk/qmkXyq4dha8","u8o1zSkouSklW7JdUvWPFwu","WOLZWQrLWOhdKmod","WQFdUJHKWONcOSkIj8oeW7mA","W7D1zCkCe8kZg8kI","W61HpCoVeCkYWRnXW5u5lSowFG","pNj+WO3dRSkdW5T9WPKDiSkg","xmobWOfUW6HRW6DSxCoOCW","mCkoEgNdSCoRea","zfuCzvmneSkCW4W2","kLRcJahdPHS/rW","W7yDgmoMrmkvAmoU","WOrWq1ydECktWPS3W4O","uCoYymkmx8kiWOZdLuuNu0aj","W5WHW6KFW43cHCkEWOeQvb/dNbq","W43dJmkRh1VdHZCjW5SY","jN5fW4KqzcK3uSo2WP8KzCogW7nqzqzDW5TurmoHvqpcHa","WQhdVJbHWOpdHSoalSoPW4yVv3e","BZBcP3zFW5v8D8kVWPi","n8oieSk1yq","W6/dIGRdO8kjW7TREq","ernUoSoxqmoMfa","WP7cP2WhcvFdTConW60MW4q","WRz1W4/cSmotWRTfWRS","W7CTW6xcQ8oJW7mGWP48"];return(_0x21cc=function(){return s})()}document.title="Eggjs 3.x 项目部署",document.getElementById("article").innerHTML='<div><p>部署 Egg.js 3.x 项目通常涉及 <strong>生产环境配置</strong>  、<strong>进程管理</strong>  、<strong>日志处理</strong>   和 <strong>性能优化</strong>  。以下是详细的部署指南，涵盖多种场景（如云服务器、Docker、Serverless 等）。</p>\n<hr>\n<h2><strong>1. 基础部署（Node.js 环境）</strong></h2>\n<p>适用于 <strong>Linux/Windows 服务器</strong>   或 <strong>云主机（如阿里云、腾讯云）</strong>  。</p>\n<h3><strong>1.1 生产环境配置</strong></h3>\n<h4><strong>(1) 修改 <code>config/config.prod.js</code></strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 关闭开发工具</span>\n  <span class="hljs-attr">security</span>: {\n    <span class="hljs-attr">csrf</span>: {\n      <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 生产环境建议开启并配置白名单</span>\n    },\n  },\n  <span class="hljs-comment">// 静态资源 CDN 配置（可选）</span>\n  <span class="hljs-attr">static</span>: {\n    <span class="hljs-attr">prefix</span>: <span class="hljs-string">&#x27;/public/&#x27;</span>,\n    <span class="hljs-attr">dir</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;../app/public&#x27;</span>),\n    <span class="hljs-attr">dynamic</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">preload</span>: <span class="hljs-literal">false</span>,\n    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>,\n  },\n};\n</code></pre>\n<h4><strong>(2) 安装依赖（生产模式）</strong></h4>\n<pre><code class="language-sh">npm install --production <span class="hljs-comment"># 仅安装 dependencies</span>\n</code></pre>\n<h4><strong>(3) 构建前端资源（如 SSR 项目）</strong></h4>\n<pre><code class="language-sh">npm run build <span class="hljs-comment"># 如果前端有 Webpack/Vue/React 构建</span>\n</code></pre>\n<hr>\n<h3><strong>1.2 使用 <code>egg-scripts</code> 启动服务</strong></h3>\n<p>Egg.js 官方推荐使用 <a href="https://github.com/eggjs/egg-scripts" target="_blank">egg-scripts</a> 管理进程。</p>\n<h4><strong>(1) 全局安装 <code>egg-scripts</code></strong></h4>\n<pre><code class="language-sh">npm install egg-scripts -g\n</code></pre>\n<h4><strong>(2) 启动服务</strong></h4>\n<pre><code class="language-sh">egg-scripts start --daemon --title=egg-server-app --workers=4\n</code></pre>\n<ul>\n<li><code>--daemon</code>：后台运行</li>\n<li><code>--title</code>：进程名（用于监控）</li>\n<li><code>--workers</code>：根据 CPU 核心数设置（通常 <code>CPU 核心数 * 2</code>）</li>\n</ul>\n<h4><strong>(3) 停止服务</strong></h4>\n<pre><code class="language-sh">egg-scripts stop\n</code></pre>\n<hr>\n<h2><strong>2. 高级部署方案</strong></h2>\n<h3><strong>2.1 使用 PM2（推荐）</strong></h3>\n<p>PM2 提供更强大的进程管理、日志切割和监控。</p>\n<h4><strong>(1) 安装 PM2</strong></h4>\n<pre><code class="language-sh">npm install pm2 -g\n</code></pre>\n<h4><strong>(2) 配置 <code>ecosystem.config.js</code></strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// ecosystem.config.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">apps</span>: [{\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;egg-app&#x27;</span>,\n    <span class="hljs-attr">script</span>: <span class="hljs-string">&#x27;node&#x27;</span>,\n    <span class="hljs-attr">args</span>: <span class="hljs-string">&#x27;dist/index.js&#x27;</span>, <span class="hljs-comment">// 如果是 TS 项目，编译后入口文件</span>\n    <span class="hljs-attr">instances</span>: <span class="hljs-number">4</span>,         <span class="hljs-comment">// 集群模式（CPU 核心数）</span>\n    <span class="hljs-attr">exec_mode</span>: <span class="hljs-string">&#x27;cluster&#x27;</span>, <span class="hljs-comment">// 多进程</span>\n    <span class="hljs-attr">max_memory_restart</span>: <span class="hljs-string">&#x27;500M&#x27;</span>, <span class="hljs-comment">// 内存超限自动重启</span>\n    <span class="hljs-attr">env</span>: {\n      <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;production&#x27;</span>,\n    },\n  }],\n};\n</code></pre>\n<h4><strong>(3) 启动服务</strong></h4>\n<pre><code class="language-sh">pm2 start ecosystem.config.js\n</code></pre>\n<h4><strong>(4) 常用命令</strong></h4>\n<pre><code class="language-sh">pm2 logs          <span class="hljs-comment"># 查看日志</span>\npm2 monit         <span class="hljs-comment"># 监控进程状态</span>\npm2 reload egg-app <span class="hljs-comment"># 平滑重启</span>\n</code></pre>\n<hr>\n<h3><strong>2.2 Docker 部署</strong></h3>\n<p>适合 <strong>容器化环境（如 Kubernetes）</strong>  。</p>\n<h4><strong>(1) 编写 <code>Dockerfile</code></strong></h4>\n<pre><code class="language-dockerfile"><span class="hljs-comment"># 使用 Node.js 官方镜像</span>\n<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">16</span>-alpine\n\n<span class="hljs-comment"># 设置工作目录</span>\n<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span>\n\n<span class="hljs-comment"># 复制依赖定义</span>\n<span class="hljs-keyword">COPY</span><span class="language-bash"> package*.json ./</span>\n\n<span class="hljs-comment"># 安装依赖（生产模式）</span>\n<span class="hljs-keyword">RUN</span><span class="language-bash"> npm install --production</span>\n\n<span class="hljs-comment"># 复制项目文件</span>\n<span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span>\n\n<span class="hljs-comment"># 构建（如需要）</span>\n<span class="hljs-keyword">RUN</span><span class="language-bash"> npm run build</span>\n\n<span class="hljs-comment"># 暴露端口</span>\n<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">7001</span>\n\n<span class="hljs-comment"># 启动命令</span>\n<span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;npm&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>]</span>\n</code></pre>\n<h4><strong>(2) 构建镜像</strong></h4>\n<pre><code class="language-sh">docker build -t egg-app .\n</code></pre>\n<h4><strong>(3) 运行容器</strong></h4>\n<pre><code class="language-sh">docker run -d -p 7001:7001 --name egg-app egg-app\n</code></pre>\n<hr>\n<h3><strong>2.3 Serverless 部署（如阿里云 FC）</strong></h3>\n<p>适合 <strong>无服务器架构</strong>  。</p>\n<h4><strong>(1) 安装 <code>@midwayjs/fc-starter</code></strong></h4>\n<pre><code class="language-sh">npm install @midwayjs/fc-starter --save\n</code></pre>\n<h4><strong>(2) 修改 <code>f.yml</code> 配置</strong></h4>\n<pre><code class="language-yaml"><span class="hljs-attr">service:</span>\n  <span class="hljs-attr">name:</span> <span class="hljs-string">egg-app</span>\n\n<span class="hljs-attr">provider:</span>\n  <span class="hljs-attr">name:</span> <span class="hljs-string">alibaba</span>\n\n<span class="hljs-attr">deployType:</span>\n  <span class="hljs-attr">type:</span> <span class="hljs-string">egg</span>\n\n<span class="hljs-attr">functions:</span>\n  <span class="hljs-attr">web:</span>\n    <span class="hljs-attr">handler:</span> <span class="hljs-string">index.handler</span>\n    <span class="hljs-attr">events:</span>\n      <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span>\n          <span class="hljs-attr">path:</span> <span class="hljs-string">/</span>\n          <span class="hljs-attr">method:</span> <span class="hljs-string">GET</span>\n</code></pre>\n<h4><strong>(3) 部署到阿里云</strong></h4>\n<pre><code class="language-sh">npm run deploy\n</code></pre>\n<hr>\n<h2><strong>3. 生产环境优化</strong></h2>\n<h3><strong>3.1 日志管理</strong></h3>\n<ul>\n<li><strong>日志切割</strong>  ：使用 <code>pm2-logrotate</code> 或 <code>logrotate</code></li>\n<li><strong>ELK 收集</strong>  ：接入 Elasticsearch + Kibana</li>\n</ul>\n<h3><strong>3.2 监控告警</strong></h3>\n<ul>\n<li><strong>Prometheus + Grafana</strong>  ：监控 QPS、CPU、内存</li>\n<li><strong>Sentry</strong>  ：错误追踪</li>\n</ul>\n<h3><strong>3.3 性能调优</strong></h3>\n<ul>\n<li><strong>Nginx 反向代理</strong>  （负载均衡 + HTTPS）<pre><code class="language-nginx"><span class="hljs-section">upstream</span> egg_servers {\n  <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:7001</span>;\n  <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:7002</span>;\n}\n\n<span class="hljs-section">server</span> {\n  <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;\n  <span class="hljs-attribute">server_name</span> yourdomain.com;\n\n  <span class="hljs-section">location</span> / {\n    <span class="hljs-attribute">proxy_pass</span> http://egg_servers;\n  }\n}\n</code></pre>\n</li>\n</ul>\n<hr>\n<h2><strong>4. 常见问题</strong></h2>\n<h3><strong>Q1: 如何实现零停机发布？</strong></h3>\n<ul>\n<li><strong>方案</strong>  ：\n<ul>\n<li><code>pm2 reload</code>（平滑重启）</li>\n<li>蓝绿部署（Kubernetes + Nginx）</li>\n</ul>\n</li>\n</ul>\n<h3><strong>Q2: 静态资源如何加速？</strong></h3>\n<ul>\n<li><strong>方案</strong>  ：\n<ul>\n<li>上传至 CDN（如阿里云 OSS + CDN）</li>\n<li>配置 <code>config.prod.js</code> 中的 <code>static</code> 选项</li>\n</ul>\n</li>\n</ul>\n<h3><strong>Q3: 如何排查内存泄漏？</strong></h3>\n<ul>\n<li><strong>工具</strong>  ：\n<ul>\n<li><code>node --inspect</code> + Chrome DevTools</li>\n<li><code>heapdump</code> 分析内存快照</li>\n</ul>\n</li>\n</ul>\n<hr>\n<p>按照上述步骤，你可以轻松部署 Egg.js 3.x 项目到各种环境。如果有特定场景需求（如 Kubernetes 或 Serverless），可以进一步探讨！ 🚀</p>\n</div>'</script></body></html>