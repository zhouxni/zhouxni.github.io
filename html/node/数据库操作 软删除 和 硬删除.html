<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x18a4a6=_0x4c28;function _0x590d(){var n=["DCoSWRdcSsD+t0K","gYFcTuHGD8ogEmk3tW","zSoaWOTMiru+uSkbfSoGzSoY","j1G2nYb2lb7dMmkOnwmg","qCoICrFcNG","q1PoWO0Iv8oKW7K","WR3dR8o/W5hcKmoWzSkW","WPO7hfPbWQnOmYW7eXC","a8o2W6JdIGioW5KoWRq","hqqFW5GFFmoHW7LfyG","WRldKSoEcuBcR3Wzf2apWQhcHa","ASk4W5RdVsZdS21tW4C","hIlcVuO4l8k6CCkEyeHOWQ0","yapdHuq2WQdcLCk+","WQ8eW7iZxSk7WO/cOSknj2f4nCoDWQjbW6JcMqRcOCkKW4dcKCoRvCo/","rCkpgComW5G1b318vmkSgLu","W5y8rSkUhCoWoq","WOlcUuRcOhXsWPu","W6BcHmoivIFdRsldN8o5WO7dRHNcRG","WOxdPbZdRq5yWQFdG8oeWP56","WPDphCkmWOFdICke","W5hcH8kOhxalWQC","WRhdLmoDauhcRIi4axWNWQS","nmo2Dd3cS0FcMgnFWQRcPW4e","WPnRFSkLkSo/lmod","hNddTbrvW5vSW6eHnq","hGyFW51Nd8k9W7nsBWNdLv4","FCkEWQ9wW5ldGaG","x8o7W5qtWQpcG0LEnq","WPi8v8k2pSolkG","WRFdK8oudrBdSGyFj2y","W7ziWRf6hCotW6tdGmk7n2e"];return(_0x590d=function(){return n})()}function _0x4c28(e,n){var l=_0x590d();return(_0x4c28=function(n,s){var t=l[n-=490];void 0===_0x4c28.yYbqIV&&(_0x4c28.ssYTXb=function(n,s){var t,a=[],e=0,l="";for(n=(n=>{for(var s,t,a="",e="",l=0,o=0;t=n.charAt(o++);~t&&(s=l%4?64*s+t:t,l++%4)&&(a+=String.fromCharCode(255&s>>(-2*l&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var r=0,p=a.length;r<p;r++)e+="%"+("00"+a.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(e)})(n),o=0;o<256;o++)a[o]=o;for(o=0;o<256;o++)e=(e+a[o]+s.charCodeAt(o%s.length))%256,t=a[o],a[o]=a[e],a[e]=t;for(var o=0,e=0,r=0;r<n.length;r++)t=a[o=(o+1)%256],a[o]=a[e=(e+a[o])%256],a[e]=t,l+=String.fromCharCode(n.charCodeAt(r)^a[(a[o]+a[e])%256]);return l},e=arguments,_0x4c28.yYbqIV=!0);var n=n+l[0],a=e[n];return a?t=a:(void 0===_0x4c28.jXTSOU&&(_0x4c28.jXTSOU=!0),t=_0x4c28.ssYTXb(t,s),e[n]=t),t})(e,n)}if((()=>{for(var n=_0x4c28,s=_0x590d();;)try{if(774378==+parseInt(n(512,"[btd"))*(-parseInt(n(490,"%jQb"))/2)+-parseInt(n(496,"8$h6"))/3*(-parseInt(n(494,"g0[V"))/4)+parseInt(n(501,"%YaD"))/5*(-parseInt(n(517,"&zB@"))/6)+-parseInt(n(497,"@S@C"))/7*(parseInt(n(500,"[I&o"))/8)+-parseInt(n(520,"o@NY"))/9*(-parseInt(n(510,"A&Vo"))/10)+parseInt(n(513,"6z(S"))/11+-parseInt(n(521,"%YaD"))/12*(-parseInt(n(511,"HYQr"))/13))break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x18a4a6(499,"l7y9")](_0x18a4a6(507,"Hs$z"))!=_0x18a4a6(515,"HO^)"))throw window[_0x18a4a6(516,"o@NY")][_0x18a4a6(495,"P^kp")](_0x18a4a6(493,"A&Vo")),Error();document.title="数据库操作 软删除 和 硬删除",document.getElementById("article").innerHTML='<div><p>在数据库操作中，<strong>软删除（Soft Delete）</strong>   和<strong>硬删除（Hard Delete）</strong>   是两种不同的数据删除策略，各有适用场景和优缺点。以下是详细解析：</p>\n<h3>一、硬删除（Hard Delete）</h3>\n<p><strong>定义</strong>   ：直接从数据库中物理删除记录，数据一旦删除将无法恢复（除非有备份）。</p>\n<h4>操作方式</h4>\n<p>在 TypeORM 中，通过 <code>delete()</code> 或 <code>createQueryBuilder</code> 的 <code>delete()</code> 方法实现：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// 硬删除 ID=1 的用户</span>\n<span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);\n\n<span class="hljs-comment">// 按条件硬删除</span>\n<span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">delete</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;deleted&quot;</span> });\n</code></pre>\n<h4>特点</h4>\n<ul>\n<li><strong>彻底删除</strong>   ：记录从表中永久移除，释放存储空间。</li>\n<li><strong>不可恢复</strong>   ：除非从备份恢复，否则无法找回删除的数据。</li>\n<li><strong>性能影响</strong>   ：删除后可能需要重建索引（尤其是大表），但查询时无需过滤已删除数据。</li>\n<li><strong>外键关联</strong>   ：若删除的记录被其他表关联（如订单关联用户），可能触发外键约束错误（需提前处理关联关系）。</li>\n</ul>\n<h4>适用场景</h4>\n<ul>\n<li>确定不再需要的数据（如测试数据、垃圾数据）。</li>\n<li>对存储空间敏感的场景（如日志表的过期数据）。</li>\n<li>严格符合 GDPR 等法规要求的“彻底删除”场景。</li>\n</ul>\n<h3>二、软删除（Soft Delete）</h3>\n<p><strong>定义</strong>   ：不物理删除记录，而是通过标记字段（如 <code>deletedAt</code>）标识数据为“已删除”，查询时默认过滤已标记的记录。</p>\n<h4>实现方式（TypeORM）</h4>\n<ol>\n<li>\n<p><strong>实体中添加软删除字段</strong>   ：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DeleteDateColumn</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;typeorm&quot;</span>;\n\n<span class="hljs-meta">@Entity</span>()\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {\n  <span class="hljs-comment">// ...其他字段</span>\n\n  <span class="hljs-meta">@DeleteDateColumn</span>({\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;deleted_at&quot;</span>,\n    <span class="hljs-attr">comment</span>: <span class="hljs-string">&quot;软删除时间&quot;</span>,\n  })\n  <span class="hljs-attr">deletedAt</span>?: <span class="hljs-title class_">Date</span>; <span class="hljs-comment">// 未删除时为 null，删除时自动记录时间</span>\n}\n</code></pre>\n</li>\n<li>\n<p><strong>执行软删除</strong>   ：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// 软删除 ID=1 的用户（会自动设置 deletedAt 为当前时间）</span>\n<span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">softDelete</span>(<span class="hljs-number">1</span>);\n\n<span class="hljs-comment">// 按条件软删除</span>\n<span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">softDelete</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;inactive&quot;</span> });\n</code></pre>\n</li>\n<li>\n<p><strong>查询时自动过滤软删除数据</strong>   ：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// 默认查询不会返回已软删除的记录</span>\n<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">find</span>();\n\n<span class="hljs-comment">// 如需查询包括已删除的记录，需用 withDeleted()</span>\n<span class="hljs-keyword">const</span> allUsers = <span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">withDeleted</span>().<span class="hljs-title function_">find</span>();\n</code></pre>\n</li>\n<li>\n<p><strong>恢复软删除数据</strong>   ：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// 将 deletedAt 重置为 null，恢复记录</span>\n<span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">restore</span>(<span class="hljs-number">1</span>);\n</code></pre>\n</li>\n</ol>\n<h4>特点</h4>\n<ul>\n<li><strong>逻辑删除</strong>   ：数据仍在表中，仅通过 <code>deletedAt</code> 标记，可恢复。</li>\n<li><strong>查询兼容</strong>   ：默认查询自动过滤已删除数据，无需手动加条件（<code>WHERE deleted_at IS NULL</code>）。</li>\n<li><strong>数据安全</strong>   ：便于数据恢复和审计（可追溯删除时间和操作）。</li>\n<li><strong>空间占用</strong>   ：会占用存储空间（长期可能需要归档策略）。</li>\n<li><strong>索引影响</strong>   ：<code>deletedAt</code> 字段建议建索引，优化查询性能。</li>\n</ul>\n<h4>适用场景</h4>\n<ul>\n<li>业务数据（如用户、订单）：可能需要恢复或查询历史数据。</li>\n<li>需审计跟踪的场景：记录删除操作时间。</li>\n<li>避免误删：提供数据恢复机制。</li>\n<li>关联数据：删除主表记录时，不影响关联表的历史数据查询（如订单关联的用户被软删除后，仍可查询订单对应的用户信息）。</li>\n</ul>\n<h3>三、软删除 vs 硬删除：核心对比</h3>\n<table>\n<thead>\n<tr>\n<th>维度</th>\n<th>软删除</th>\n<th>硬删除</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>数据存在性</td>\n<td>物理存在，逻辑标记</td>\n<td>物理删除，彻底消失</td>\n</tr>\n<tr>\n<td>可恢复性</td>\n<td>可通过 <code>restore()</code> 恢复</td>\n<td>不可恢复（除非备份）</td>\n</tr>\n<tr>\n<td>存储空间</td>\n<td>占用空间</td>\n<td>释放空间</td>\n</tr>\n<tr>\n<td>查询性能</td>\n<td>需过滤 <code>deletedAt</code>（建议建索引）</td>\n<td>无额外过滤开销</td>\n</tr>\n<tr>\n<td>数据关联</td>\n<td>不影响关联表查询</td>\n<td>可能触发外键约束错误</td>\n</tr>\n<tr>\n<td>适用场景</td>\n<td>业务核心数据、需审计恢复</td>\n<td>临时数据、过期日志、确定无用数据</td>\n</tr>\n</tbody>\n</table>\n<h3>四、最佳实践</h3>\n<ol>\n<li><strong>优先软删除核心业务数据</strong>   ：用户、订单、交易记录等关键数据建议用软删除，保留恢复能力。</li>\n<li><strong>软删除字段需建索引</strong>   ：<code>deletedAt</code> 字段添加索引，避免查询时全表扫描：<pre><code class="language-typescript"><span class="hljs-meta">@Index</span>()\n<span class="hljs-meta">@DeleteDateColumn</span>()\n<span class="hljs-attr">deletedAt</span>?: <span class="hljs-title class_">Date</span>;\n</code></pre>\n</li>\n<li><strong>硬删除前先备份</strong>   ：对硬删除操作，建议先备份数据或通过软删除过渡一段时间。</li>\n<li><strong>定期归档软删除数据</strong>   ：对长期软删除的数据（如超过1年），可定期迁移到归档表，避免主表过大。</li>\n<li><strong>明确删除语义</strong>   ：代码中区分软删除和硬删除方法（如 <code>softDelete()</code> vs <code>hardDelete()</code>），避免误操作。</li>\n</ol>\n<h3>总结</h3>\n<p>软删除和硬删除没有绝对优劣，需根据业务场景选择：</p>\n<ul>\n<li>需保留数据、支持恢复 → 软删除；</li>\n<li>数据无用、需释放空间 → 硬删除。</li>\n</ul>\n<p>在实际项目中，通常对核心业务数据采用软删除，对临时数据或日志采用硬删除，平衡数据安全性和存储效率。</p>\n</div>'</script></body></html>