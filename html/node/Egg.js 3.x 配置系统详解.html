<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x4a176c=_0x1637;function _0x292b(){var s=["WP3dUYjWWQpcLCo4b8od","W5pdPSkqW6pdUvPP","WPHbb8kJcZbGWQZcOIj7WQK","bfnafmkiWPddPYhcPhtcVG","WOVcMCo8WPmHWP9/dSoU","WR56lCoTDmkTWOtcISkgW4NcOSkJeG","WQJdU8kbxdbAW78","W7mMWPTUsgWFtdJcOa","W7aRWP5RcJaEBWtcImo0hG","d0r8axmfnJBdRGFcIKu","W6/cQxmSW6xdLmkde8oUthv/Ca","WO3cOCoeW685WOC8b2a8WOj1","g3zhESk3WO1XWRG","WOvFWQKPlCkvjSoLmsxdVg4","dXa9qtr4mq","gLpdO1/cULC1W4ZdNmkgka","WQ7dLCozq3jrF27cGmknWO4cAq","AZq7WPzkW4X2","tZ3dHdlcUCkHaSkvWQ/dLCk4aK8","g1RdQ1ZdUNuzW4tdSCkD","lmoWjZf3DCkSqha","WOpcUCo8vmoeA8ojAmkDxb/cSa","cbucW73cHaeKfL4UW606hcvNW5ztEu0uaYdcJSobW7qg","W5xdVSk6vmov"];return(_0x292b=function(){return s})()}function _0x1637(l,s){var t=_0x292b();return(_0x1637=function(s,n){var a=t[s-=235];void 0===_0x1637.EhZXmC&&(_0x1637.gyYkvP=function(s,n){var a,p=[],l=0,t="";for(s=(s=>{for(var n,a,p="",l="",t=0,c=0;a=s.charAt(c++);~a&&(n=t%4?64*n+a:a,t++%4)&&(p+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,r=p.length;e<r;e++)l+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)p[c]=c;for(c=0;c<256;c++)l=(l+p[c]+n.charCodeAt(c%n.length))%256,a=p[c],p[c]=p[l],p[l]=a;for(var c=0,l=0,e=0;e<s.length;e++)a=p[c=(c+1)%256],p[c]=p[l=(l+p[c])%256],p[l]=a,t+=String.fromCharCode(s.charCodeAt(e)^p[(p[c]+p[l])%256]);return t},l=arguments,_0x1637.EhZXmC=!0);var s=s+t[0],p=l[s];return p?a=p:(void 0===_0x1637.iwkKBx&&(_0x1637.iwkKBx=!0),a=_0x1637.gyYkvP(a,n),l[s]=a),a})(l,s)}if((()=>{for(var s=_0x1637,n=_0x292b();;)try{if(228181==-parseInt(s(240,"Nye!"))+parseInt(s(245,"lB&c"))/2*(-parseInt(s(256,"YvYB"))/3)+parseInt(s(251,"9Hk%"))/4+parseInt(s(257,"YvYB"))/5+parseInt(s(238,"ul$T"))/6+-parseInt(s(255,"a!hg"))/7*(-parseInt(s(235,"LwmR"))/8)+-parseInt(s(254,"3^m2"))/9)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x4a176c(242,"zO9S")](_0x4a176c(249,"LwmR"))!=_0x4a176c(248,"*lPp"))throw window[_0x4a176c(237,"IKAF")][_0x4a176c(250,"ophg")](_0x4a176c(247,"24E!")),Error();document.title="Egg.js 3.x 配置系统详解",document.getElementById("article").innerHTML='<div><p>Egg.js 的配置系统是其核心功能之一，提供了灵活、分层的配置管理机制。以下是 Egg.js 3.x 配置系统的全面解析。</p>\n<h2>1. 配置文件结构</h2>\n<h3>默认配置目录</h3>\n<pre><code>config\n├── config.default.js   # 默认基础配置\n├── config.local.js     # 本地开发环境覆盖配置\n├── config.prod.js      # 生产环境配置\n├── config.test.js      # 测试环境配置\n├── plugin.js           # 插件配置\n└── config.unittest.js  # 单元测试配置\n</code></pre>\n<h3>多环境配置加载顺序</h3>\n<p>Egg.js 会按以下顺序合并配置（后面的配置会覆盖前面的）：</p>\n<ol>\n<li><code>config.default.js</code></li>\n<li><code>config.{env}.js</code> (根据 <code>EGG_SERVER_ENV</code> 加载对应环境配置)</li>\n<li><code>config.local.js</code> (本地开发环境特殊配置)</li>\n</ol>\n<h2>2. 配置格式</h2>\n<h3>基本配置格式</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 基础配置</span>\n  <span class="hljs-attr">keys</span>: <span class="hljs-string">&#x27;my-cookie-secret-key&#x27;</span>,\n  \n  <span class="hljs-comment">// 中间件配置</span>\n  <span class="hljs-attr">middleware</span>: [<span class="hljs-string">&#x27;gzip&#x27;</span>],\n  \n  <span class="hljs-comment">// 自定义配置</span>\n  <span class="hljs-attr">myConfig</span>: {\n    <span class="hljs-attr">apiEndpoint</span>: <span class="hljs-string">&#x27;https://api.example.com&#x27;</span>\n  }\n};\n</code></pre>\n<h3>函数式配置（动态配置）</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">appInfo</span> =&gt;</span> {\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">keys</span>: appInfo.<span class="hljs-property">name</span> + <span class="hljs-string">&#x27;_123456&#x27;</span>,\n    <span class="hljs-attr">view</span>: {\n      <span class="hljs-attr">defaultViewEngine</span>: <span class="hljs-string">&#x27;nunjucks&#x27;</span>,\n      <span class="hljs-attr">mapping</span>: {\n        <span class="hljs-string">&#x27;.tpl&#x27;</span>: <span class="hljs-string">&#x27;nunjucks&#x27;</span>,\n      },\n    },\n  };\n};\n</code></pre>\n<p><code>appInfo</code> 包含的属性：</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>pkg</code></td>\n<td>package.json</td>\n</tr>\n<tr>\n<td><code>name</code></td>\n<td>应用名（来自 pkg.name）</td>\n</tr>\n<tr>\n<td><code>baseDir</code></td>\n<td>应用代码目录</td>\n</tr>\n<tr>\n<td><code>HOME</code></td>\n<td>用户目录</td>\n</tr>\n<tr>\n<td><code>root</code></td>\n<td>应用根目录</td>\n</tr>\n</tbody>\n</table>\n<h2>3. 配置类型详解</h2>\n<h3>3.1 框架默认配置</h3>\n<h4>服务器配置</h4>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">cluster</span>: {\n    <span class="hljs-attr">listen</span>: {\n      <span class="hljs-attr">port</span>: <span class="hljs-number">7001</span>,\n      <span class="hljs-attr">hostname</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,\n    }\n  }\n};\n</code></pre>\n<h4>日志配置</h4>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">logger</span>: {\n    <span class="hljs-attr">dir</span>: <span class="hljs-string">&#x27;/path/to/log&#x27;</span>,\n    <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;INFO&#x27;</span>,\n    <span class="hljs-attr">consoleLevel</span>: <span class="hljs-string">&#x27;INFO&#x27;</span>,\n  }\n};\n</code></pre>\n<h4>安全配置</h4>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">security</span>: {\n    <span class="hljs-attr">csrf</span>: {\n      <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">ignoreJSON</span>: <span class="hljs-literal">false</span>,\n    },\n    <span class="hljs-attr">xframe</span>: {\n      <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;SAMEORIGIN&#x27;</span>,\n    },\n  }\n};\n</code></pre>\n<h3>3.2 自定义配置</h3>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 自定义业务配置</span>\n  <span class="hljs-attr">api</span>: {\n    <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,\n    <span class="hljs-attr">endpoints</span>: {\n      <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;https://api.user.com&#x27;</span>,\n      <span class="hljs-attr">order</span>: <span class="hljs-string">&#x27;https://api.order.com&#x27;</span>,\n    }\n  },\n  \n  <span class="hljs-comment">// 业务常量</span>\n  <span class="hljs-attr">constants</span>: {\n    <span class="hljs-attr">MAX_PAGE_SIZE</span>: <span class="hljs-number">100</span>,\n    <span class="hljs-attr">DEFAULT_AVATAR</span>: <span class="hljs-string">&#x27;/public/avatar.png&#x27;</span>,\n  }\n};\n</code></pre>\n<h2>4. 环境差异化配置</h2>\n<h3>环境特定配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 覆盖默认配置</span>\n  <span class="hljs-attr">logger</span>: {\n    <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;WARN&#x27;</span>,\n    <span class="hljs-attr">consoleLevel</span>: <span class="hljs-string">&#x27;WARN&#x27;</span>,\n  },\n  \n  <span class="hljs-comment">// 生产环境特有配置</span>\n  <span class="hljs-attr">redis</span>: {\n    <span class="hljs-attr">clients</span>: {\n      <span class="hljs-attr">cache</span>: {\n        <span class="hljs-attr">port</span>: <span class="hljs-number">6379</span>,\n        <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;redis.prod.com&#x27;</span>,\n        <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;redis-password&#x27;</span>,\n        <span class="hljs-attr">db</span>: <span class="hljs-number">0</span>,\n      },\n    },\n  },\n};\n</code></pre>\n<h3>本地开发配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.local.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">const</span> config = {};\n  \n  <span class="hljs-comment">// 本地开发关闭 CSRF</span>\n  config.<span class="hljs-property">security</span> = {\n    <span class="hljs-attr">csrf</span>: {\n      <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>,\n    },\n  };\n  \n  <span class="hljs-comment">// 本地开发数据库配置</span>\n  config.<span class="hljs-property">sequelize</span> = {\n    <span class="hljs-attr">dialect</span>: <span class="hljs-string">&#x27;mysql&#x27;</span>,\n    <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,\n    <span class="hljs-attr">port</span>: <span class="hljs-number">3306</span>,\n    <span class="hljs-attr">database</span>: <span class="hljs-string">&#x27;dev_db&#x27;</span>,\n    <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;root&#x27;</span>,\n    <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;&#x27;</span>,\n  };\n  \n  <span class="hljs-keyword">return</span> config;\n};\n</code></pre>\n<h2>5. 配置获取与使用</h2>\n<h3>在Controller/Service中使用</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/controller/home.js</span>\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Controller</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">HomeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Controller</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">index</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">const</span> { ctx, app } = <span class="hljs-variable language_">this</span>;\n    \n    <span class="hljs-comment">// 获取配置</span>\n    <span class="hljs-keyword">const</span> timeout = app.<span class="hljs-property">config</span>.<span class="hljs-property">api</span>.<span class="hljs-property">timeout</span>;\n    <span class="hljs-keyword">const</span> maxPageSize = app.<span class="hljs-property">config</span>.<span class="hljs-property">constants</span>.<span class="hljs-property">MAX_PAGE_SIZE</span>;\n    \n    ctx.<span class="hljs-property">body</span> = {\n      <span class="hljs-attr">config</span>: {\n        timeout,\n        maxPageSize,\n      }\n    };\n  }\n}\n</code></pre>\n<h3>在插件中使用</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 插件中获取应用配置</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  app.<span class="hljs-property">customMethod</span> = <span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-keyword">const</span> config = app.<span class="hljs-property">config</span>.<span class="hljs-property">pluginConfig</span>;\n    <span class="hljs-comment">// 使用配置</span>\n  };\n};\n</code></pre>\n<h2>6. 高级配置技巧</h2>\n<h3>配置动态更新</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 运行时修改配置（不推荐生产环境使用）</span>\napp.<span class="hljs-property">config</span>.<span class="hljs-property">api</span>.<span class="hljs-property">timeout</span> = <span class="hljs-number">5000</span>;\n</code></pre>\n<h3>配置文件拆分</h3>\n<pre><code>config\n├── api.config.js\n├── db.config.js\n├── security.config.js\n└── config.default.js\n</code></pre>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-keyword">const</span> apiConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./api.config&#x27;</span>);\n<span class="hljs-keyword">const</span> dbConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./db.config&#x27;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  ...apiConfig,\n  ...dbConfig,\n  <span class="hljs-comment">// 其他配置</span>\n};\n</code></pre>\n<h3>单元测试配置覆盖</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// test/controller/home.test.js</span>\n<span class="hljs-keyword">const</span> mock = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg-mock&#x27;</span>);\n\n<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;test/controller/home.test.js&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">let</span> app;\n  <span class="hljs-title function_">before</span>(<span class="hljs-function">() =&gt;</span> {\n    app = mock.<span class="hljs-title function_">app</span>({\n      <span class="hljs-comment">// 测试环境特殊配置</span>\n      <span class="hljs-attr">cache</span>: <span class="hljs-literal">false</span>,\n      <span class="hljs-attr">logger</span>: {\n        <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;ERROR&#x27;</span>,\n      },\n    });\n    <span class="hljs-keyword">return</span> app.<span class="hljs-title function_">ready</span>();\n  });\n});\n</code></pre>\n<h2>7. 最佳实践</h2>\n<ol>\n<li><strong>配置组织原则</strong>  ：\n<ul>\n<li>按功能拆分配置文件</li>\n<li>敏感信息通过环境变量注入</li>\n<li>保持 <code>config.default.js</code> 完整</li>\n</ul>\n</li>\n<li><strong>安全建议</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// 从环境变量读取敏感信息</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">db</span>: {\n    <span class="hljs-attr">password</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PASSWORD</span> || <span class="hljs-string">&#x27;dev-password&#x27;</span>,\n  }\n};\n</code></pre>\n</li>\n<li><strong>多环境管理</strong>  ：<pre><code class="language-sh"><span class="hljs-comment"># 启动不同环境</span>\nEGG_SERVER_ENV=prod npm start\nEGG_SERVER_ENV=<span class="hljs-built_in">test</span> npm <span class="hljs-built_in">test</span>\n</code></pre>\n</li>\n<li><strong>配置验证</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// 使用 egg-validate 验证配置</span>\n<span class="hljs-keyword">const</span> { validate } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg-validate&#x27;</span>);\n\n<span class="hljs-keyword">const</span> rule = {\n  <span class="hljs-attr">api</span>: {\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;object&#x27;</span>,\n    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">fields</span>: {\n      <span class="hljs-attr">timeout</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;number&#x27;</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">1000</span> },\n    }\n  }\n};\n\n<span class="hljs-title function_">validate</span>(app.<span class="hljs-property">config</span>, rule);\n</code></pre>\n</li>\n</ol>\n<p>通过合理利用 Egg.js 的配置系统，可以实现灵活的多环境管理，保持代码的整洁性和可维护性。</p>\n</div>'</script></body></html>