<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x2204(p,s){var t=_0x167c();return(_0x2204=function(s,n){var a=t[s-=389];void 0===_0x2204.pICfIs&&(_0x2204.ccNZEl=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,c=0;a=s.charAt(c++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,o=l.length;e<o;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+n.charCodeAt(c%n.length))%256,a=l[c],l[c]=l[p],l[p]=a;for(var c=0,p=0,e=0;e<s.length;e++)a=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(e)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x2204.pICfIs=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x2204.UqKcTR&&(_0x2204.UqKcTR=!0),a=_0x2204.ccNZEl(a,n),p[s]=a),a})(p,s)}var _0x572dc4=_0x2204;function _0x167c(){var s=["a8kPW5tcPSoiW4BcHrRcVqmbW5a","WPzzWRy+W48","W6ZcR8kRESolvatdQKyzWQeUW6G","W5unWPLQjCo1qCoRyCo8W5ziW5W","b8kQW5RcOmopW47dUb/cUsKbW5lcTq","WPpdHYPAi3r6WO7dGmokACokB2pdNbfaW6RcNXRdN1lcM8kUASkS","W5pcUSkhCCkmW6tdOK06o8kYFg4","WPuXasDig8kckMv5BYG","W402W41ZDrZcQWZcISk+dSkEuq","zSkSW5dcSL9pmG","rKJcJLhdRNNcSG","W5FcVxZdUgLEoCkdW6GmWRxdIW","dxzcWPP5WOn7W6evWRuBha","mG3cGCoTWPpdImkUW5G","W6nJEuOxWO9ZWQaICCkUDSkp","WO7dOI3cQcGho8kg","W5xdHZxcU8kxBmoAWQ8","W6/cRSo+d8kcoMldHa","rxtdUuFcRCkLlq","qvRcLCoSWOldTSkdW7ff","jmk1vLtcTSk6WRxcHMJdLCk9BmoP","W6xcRCoAkSkFo13dRG","W5BcRuCJi3pdOCoACGLvW7mT","WQzHWPXXW5KAyGS","W5pcUNFdUMLwBmkgW50zWQFdP8kh","W5ddMZJcSsKcla","hbb9vaqAWR/cRW","xgRdVCkso1mtnSkvbgOqBG"];return(_0x167c=function(){return s})()}if((()=>{for(var s=_0x2204,n=_0x167c();;)try{if(783392==+parseInt(s(416,"AI6n"))*(parseInt(s(411,"A8OV"))/2)+parseInt(s(394,"$TW("))/3+parseInt(s(390,")[F8"))/4+-parseInt(s(400,"0gkf"))/5*(parseInt(s(399,"C&Zl"))/6)+-parseInt(s(392,"GiZp"))/7+parseInt(s(398,"yIxN"))/8*(parseInt(s(407,"AI6n"))/9)+parseInt(s(393,"bf8F"))/10*(-parseInt(s(412,"ZFaE"))/11))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x572dc4(396,"VRUV")](_0x572dc4(405,"C&Zl"))!=_0x572dc4(415,"JUaY"))throw window[_0x572dc4(401,"A8OV")][_0x572dc4(395,"9n(8")](_0x572dc4(391,"o36S")),Error();document.title="koa-body 详解",document.getElementById("article").innerHTML='<div><p><code>koa-body</code> 是 Koa 生态中用于<strong>解析 HTTP 请求体</strong>  的核心中间件，支持 <code>multipart/form-data</code>（文件上传）、<code>application/json</code>、<code>x-www-form-urlencoded</code> 等多种格式。以下是深度解析：</p>\n<hr>\n<h2><strong>1. 核心功能</strong></h2>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>JSON 解析</strong></td>\n<td>解析 <code>Content-Type: application/json</code> 请求体</td>\n</tr>\n<tr>\n<td><strong>表单解析</strong></td>\n<td>解析 <code>x-www-form-urlencoded</code> 和 <code>multipart/form-data</code>（文件上传）</td>\n</tr>\n<tr>\n<td><strong>文件上传</strong></td>\n<td>支持多文件上传，可配置存储路径、文件名、大小限制等</td>\n</tr>\n<tr>\n<td><strong>文本/二进制解析</strong></td>\n<td>解析 <code>text/plain</code>、<code>application/octet-stream</code> 等原始数据</td>\n</tr>\n<tr>\n<td><strong>数据大小限制</strong></td>\n<td>防止恶意超大请求（如 <code>jsonLimit</code>、<code>formLimit</code>）</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>2. 安装与基础用法</strong></h2>\n<h3><strong>安装</strong></h3>\n<pre><code class="language-sh">npm install koa-body\n</code></pre>\n<h3><strong>基础示例</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> koaBody = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-body&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n\n<span class="hljs-comment">// 启用 koa-body</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">koaBody</span>());\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-comment">// 解析后的请求体数据</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>); <span class="hljs-comment">// JSON 或表单数据</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">files</span>); <span class="hljs-comment">// 上传的文件</span>\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;Received!&#x27;</span>;\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<hr>\n<h2><strong>3. 配置选项详解</strong></h2>\n<h3><strong>常用配置</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">koaBody</span>({\n  <span class="hljs-comment">// 配置项</span>\n  <span class="hljs-attr">multipart</span>: <span class="hljs-literal">true</span>,       <span class="hljs-comment">// 启用文件上传</span>\n  <span class="hljs-attr">formidable</span>: {\n    <span class="hljs-attr">uploadDir</span>: <span class="hljs-string">&#x27;/tmp&#x27;</span>,   <span class="hljs-comment">// 文件临时存储目录</span>\n    <span class="hljs-attr">keepExtensions</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 保留文件扩展名</span>\n  },\n  <span class="hljs-attr">jsonLimit</span>: <span class="hljs-string">&#x27;1mb&#x27;</span>,     <span class="hljs-comment">// JSON 数据大小限制</span>\n  <span class="hljs-attr">formLimit</span>: <span class="hljs-string">&#x27;56kb&#x27;</span>,     <span class="hljs-comment">// 表单数据大小限制</span>\n  <span class="hljs-attr">textLimit</span>: <span class="hljs-string">&#x27;1mb&#x27;</span>,      <span class="hljs-comment">// 文本数据大小限制</span>\n  <span class="hljs-attr">parsedMethods</span>: [<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;PUT&#x27;</span>, <span class="hljs-string">&#x27;PATCH&#x27;</span>, <span class="hljs-string">&#x27;DELETE&#x27;</span>] <span class="hljs-comment">// 仅解析这些方法的请求体</span>\n}));\n</code></pre>\n<h3><strong>文件上传配置</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">koaBody</span>({\n  <span class="hljs-attr">multipart</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">formidable</span>: {\n    <span class="hljs-attr">uploadDir</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;uploads&#x27;</span>), <span class="hljs-comment">// 文件存储路径</span>\n    <span class="hljs-attr">keepExtensions</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">maxFileSize</span>: <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>, <span class="hljs-comment">// 单个文件最大 10MB</span>\n    <span class="hljs-attr">onFileBegin</span>: <span class="hljs-function">(<span class="hljs-params">name, file</span>) =&gt;</span> { <span class="hljs-comment">// 文件上传前的钩子</span>\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`开始上传 <span class="hljs-subst">${name}</span>`</span>);\n    }\n  }\n}));\n</code></pre>\n<hr>\n<h2><strong>4. 不同数据类型的处理</strong></h2>\n<h3><strong>（1）JSON 数据</strong></h3>\n<p><strong>请求示例</strong>  ：</p>\n<pre><code class="language-sh">curl -X POST -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> -d <span class="hljs-string">&#x27;{&quot;name&quot;:&quot;John&quot;}&#x27;</span> http://localhost:3000\n</code></pre>\n<p><strong>服务端获取</strong>  ：</p>\n<pre><code class="language-javascript">ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>; <span class="hljs-comment">// { name: &#x27;John&#x27; }</span>\n</code></pre>\n<h3><strong>（2）表单数据</strong></h3>\n<p><strong>请求示例</strong>  ：</p>\n<pre><code class="language-sh">curl -X POST -d <span class="hljs-string">&quot;name=John&amp;age=30&quot;</span> http://localhost:3000\n</code></pre>\n<p><strong>服务端获取</strong>  ：</p>\n<pre><code class="language-javascript">ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>; <span class="hljs-comment">// { name: &#x27;John&#x27;, age: &#x27;30&#x27; }</span>\n</code></pre>\n<h3><strong>（3）文件上传</strong></h3>\n<p><strong>前端 HTML</strong>  ：</p>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/upload&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span>\n  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;avatar&quot;</span>&gt;</span>\n  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>上传<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>\n<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>\n</code></pre>\n<p><strong>服务端处理</strong>  ：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">koaBody</span>({ <span class="hljs-attr">multipart</span>: <span class="hljs-literal">true</span> }));\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-keyword">const</span> file = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">files</span>.<span class="hljs-property">avatar</span>; <span class="hljs-comment">// 上传的文件信息</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file.<span class="hljs-property">originalFilename</span>); <span class="hljs-comment">// 原始文件名</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file.<span class="hljs-property">filepath</span>);        <span class="hljs-comment">// 临时存储路径</span>\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;上传成功&#x27;</span>;\n});\n</code></pre>\n<hr>\n<h2><strong>5. 高级用法</strong></h2>\n<h3><strong>（1）自定义错误处理</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">koaBody</span>({\n  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">err, ctx</span>) =&gt;</span> {\n    ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">422</span>, <span class="hljs-string">`请求体解析失败: <span class="hljs-subst">${err.message}</span>`</span>);\n  }\n}));\n</code></pre>\n<h3><strong>（2）动态配置</strong></h3>\n<p>根据请求路径启用不同解析规则：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">path</span> === <span class="hljs-string">&#x27;/upload&#x27;</span>) {\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">koaBody</span>({ <span class="hljs-attr">multipart</span>: <span class="hljs-literal">true</span> })(ctx, next);\n  } <span class="hljs-keyword">else</span> {\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">koaBody</span>()(ctx, next);\n  }\n});\n</code></pre>\n<h3><strong>（3）流式处理文件</strong></h3>\n<p>直接操作上传的文件流：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);\n<span class="hljs-keyword">const</span> { promisify } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);\n<span class="hljs-keyword">const</span> pipeline = <span class="hljs-title function_">promisify</span>(<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;stream&#x27;</span>).<span class="hljs-property">pipeline</span>);\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-keyword">const</span> file = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">files</span>.<span class="hljs-property">avatar</span>;\n  <span class="hljs-keyword">await</span> <span class="hljs-title function_">pipeline</span>(\n    fs.<span class="hljs-title function_">createReadStream</span>(file.<span class="hljs-property">filepath</span>),\n    fs.<span class="hljs-title function_">createWriteStream</span>(<span class="hljs-string">`/final/path/<span class="hljs-subst">${file.originalFilename}</span>`</span>)\n  );\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;文件保存成功&#x27;</span>;\n});\n</code></pre>\n<hr>\n<h2><strong>6. 常见问题解决方案</strong></h2>\n<h3><strong>Q: 文件上传后如何永久保存？</strong></h3>\n<ul>\n<li>使用 <code>fs.rename</code> 将临时文件移动到目标目录：<pre><code class="language-javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>).<span class="hljs-property">promises</span>;\n<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rename</span>(file.<span class="hljs-property">filepath</span>, <span class="hljs-string">`/permanent/<span class="hljs-subst">${file.originalFilename}</span>`</span>);\n</code></pre>\n</li>\n</ul>\n<h3><strong>Q: 如何限制文件类型？</strong></h3>\n<ul>\n<li>在 <code>onFileBegin</code> 钩子中校验：<pre><code class="language-javascript"><span class="hljs-attr">onFileBegin</span>: <span class="hljs-function">(<span class="hljs-params">name, file</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (!file.<span class="hljs-property">originalFilename</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.png&#x27;</span>)) {\n    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;仅支持 PNG 文件&#x27;</span>);\n  }\n}\n</code></pre>\n</li>\n</ul>\n<h3><strong>Q: 为什么 <code>ctx.request.body</code> 为空？</strong></h3>\n<ul>\n<li>检查请求头 <code>Content-Type</code> 是否匹配（如 JSON 需设为 <code>application/json</code>）。</li>\n<li>确保请求方法在 <code>parsedMethods</code> 列表中。</li>\n</ul>\n<hr>\n<h2><strong>7. 性能与安全建议</strong></h2>\n<ol>\n<li><strong>生产环境必须配置大小限制</strong>  ：<pre><code class="language-javascript"><span class="hljs-attr">jsonLimit</span>: <span class="hljs-string">&#x27;100kb&#x27;</span>,\n<span class="hljs-attr">formLimit</span>: <span class="hljs-string">&#x27;100kb&#x27;</span>,\n<span class="hljs-attr">formidable</span>: { <span class="hljs-attr">maxFileSize</span>: <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> } <span class="hljs-comment">// 10MB</span>\n</code></pre>\n</li>\n<li><strong>文件上传目录权限</strong>  ：\n<ul>\n<li>确保上传目录（如 <code>uploads/</code>）有写入权限。</li>\n<li>禁止用户上传可执行文件（如 <code>.php</code>）。</li>\n</ul>\n</li>\n<li><strong>CDN 集成</strong>  ：\n<ul>\n<li>大文件上传建议直传云存储（如 AWS S3、阿里云 OSS）。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2><strong>8. 完整示例（文件上传 + JSON）</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);\n<span class="hljs-keyword">const</span> koaBody = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-body&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">koaBody</span>({\n  <span class="hljs-attr">multipart</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">formidable</span>: {\n    <span class="hljs-attr">uploadDir</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;uploads&#x27;</span>),\n    <span class="hljs-attr">keepExtensions</span>: <span class="hljs-literal">true</span>\n  }\n}));\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">method</span> === <span class="hljs-string">&#x27;POST&#x27;</span>) {\n    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">path</span> === <span class="hljs-string">&#x27;/api/data&#x27;</span>) {\n      <span class="hljs-comment">// 处理 JSON 数据</span>\n      ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">received</span>: ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span> };\n    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">path</span> === <span class="hljs-string">&#x27;/upload&#x27;</span>) {\n      <span class="hljs-comment">// 处理文件上传</span>\n      <span class="hljs-keyword">const</span> file = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">files</span>.<span class="hljs-property">file</span>;\n      ctx.<span class="hljs-property">body</span> = {\n        <span class="hljs-attr">filename</span>: file.<span class="hljs-property">originalFilename</span>,\n        <span class="hljs-attr">size</span>: file.<span class="hljs-property">size</span>\n      };\n    }\n  }\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on http://localhost:3000&#x27;</span>);\n});\n</code></pre>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li><code>koa-body</code> 是 Koa 中<strong>最全面的请求体解析工具</strong>  ，支持 JSON、表单、文件上传等场景。</li>\n<li><strong>关键配置</strong>  ：<code>multipart</code>（文件上传）、<code>formLimit/jsonLimit</code>（防攻击）、<code>formidable</code>（文件控制）。</li>\n<li><strong>安全必做</strong>  ：限制文件类型、大小，隔离上传目录权限。</li>\n</ul>\n</div>'</script></body></html>