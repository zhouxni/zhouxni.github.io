<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x45cf(){var s=["W5bFW7LUeqe9rCoKWOiNWQ3dQW","F0GYWOfNWRpcUSo7WPiE","W7yVWQ7cRaRcMaS","W4JdNSoIcmkuW4fqW7LZWReEW7O","WQtdKudcKsqYoNWdt8kQpSoy","W5ioDtnOW5NdOa","W7axW79EW7DbbW4","W4JdLCoTdCkzW4ejW51rWRmtW4r5","WOzEsdvRW6NdLmkj","or5lm8kHW41kWQ9JWQuniqbDW6pdVSkLkmoLv8k1dmoAWRScsW","WOxcNdj8h8ooW4GZW4q","ANnWvMFcMKDQ","q8oQWQxcKIDNW4qSWP5os1m","WRlcGCkwsCkFWPLtW4GOWOPOWPS","DMLGrgO","Fee1WOvLWO7cOmogWOCR","W4qfWQTZtu/cVCowicVcKmohWRa","W7XlWR0PoSkOW4un","EuK5WOC4W6tcMCoRWQqFj28","W7XjW6P8zSkMW4yao8khW7a","W4idWQ86lq/dGSonna","W4FdL0HoWO3cPfLAhvZdV2W","pK7dSSoNeSkVrSkqW4jGeq","zvHDiCk+WR4JW7u","WRZdM8kFW6xdSeddRhCn","WOBcQqa1WPi+WQDBWP97Fti","W7zctSoJW6X3ea","WOWzBYHXW5RdNa","fCkgx8owWQ3cUmosoCkZCG","WODsm017W5VdHmkCyqa"];return(_0x45cf=function(){return s})()}var _0x1624ac=_0x9f90;function _0x9f90(p,s){var t=_0x45cf();return(_0x9f90=function(s,a){var n=t[s-=497];void 0===_0x9f90.ZPvwwx&&(_0x9f90.DhBMPL=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,c=0;n=s.charAt(c++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,r=l.length;e<r;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+a.charCodeAt(c%a.length))%256,n=l[c],l[c]=l[p],l[p]=n;for(var c=0,p=0,e=0;e<s.length;e++)n=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(e)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x9f90.ZPvwwx=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x9f90.YMYaWC&&(_0x9f90.YMYaWC=!0),n=_0x9f90.DhBMPL(n,a),p[s]=n),n})(p,s)}if((()=>{for(var s=_0x9f90,a=_0x45cf();;)try{if(349360==-parseInt(s(519,"SAwp"))*(-parseInt(s(514,"q)cx"))/2)+-parseInt(s(522,"h0uI"))/3*(parseInt(s(508,"l8$y"))/4)+-parseInt(s(498,"SAwp"))/5*(parseInt(s(511,"dy%Q"))/6)+parseInt(s(507,"^GGE"))/7*(parseInt(s(502,"JBzA"))/8)+parseInt(s(518,"*T8S"))/9*(parseInt(s(512,"r6pe"))/10)+parseInt(s(497,"X6AV"))/11+-parseInt(s(524,"F3Pl"))/12)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x1624ac(525,"SAwp")](_0x1624ac(500,"%wgY"))!=_0x1624ac(504,"^kB("))throw window[_0x1624ac(501,"^kB(")][_0x1624ac(516,"gO[X")](_0x1624ac(499,"fswq")),Error();document.title="Egg.js 3.x 中的 curl 方法详解",document.getElementById("article").innerHTML='<div><p>在 Egg.js 3.x 中，<code>curl</code> 方法是框架提供的 HTTP 客户端工具，用于向其他服务发起 HTTP 请求。它是基于 <a href="https://github.com/node-modules/urllib" target="_blank">urllib</a> 封装的，提供了简洁易用的 API。</p>\n<h2>基本使用</h2>\n<h3>通过 app 对象使用</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在 service 或 controller 中使用</span>\n<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">curl</span>(url, options);\n</code></pre>\n<h3>通过 ctx 对象使用</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在 controller 中使用更方便（会自动处理 CSRF 等安全策略）</span>\n<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">curl</span>(url, options);\n</code></pre>\n<h2>常用参数选项</h2>\n<p><code>curl</code> 方法接受两个参数：<code>url</code> 和 <code>options</code>。以下是常用的 options 配置：</p>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-comment">// HTTP 方法，默认 GET</span>\n  <span class="hljs-attr">data</span>: {},      <span class="hljs-comment">// POST/PUT 请求体</span>\n  <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>, <span class="hljs-comment">// 响应数据格式，可选 json/text</span>\n  <span class="hljs-attr">contentType</span>: <span class="hljs-string">&#x27;json&#x27;</span>, <span class="hljs-comment">// 请求头 Content-Type</span>\n  <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>, <span class="hljs-comment">// 超时时间(毫秒)</span>\n  <span class="hljs-attr">headers</span>: {},   <span class="hljs-comment">// 自定义请求头</span>\n  <span class="hljs-attr">dataAsQueryString</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否将 data 转为 query string</span>\n  <span class="hljs-comment">// 其他 urllib 支持的参数...</span>\n}\n</code></pre>\n<h2>实际示例</h2>\n<h3>GET 请求</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://api.example.com/data&#x27;</span>, {\n    <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,\n    <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>\n  });\n  \n  <span class="hljs-comment">// result 包含以下属性：</span>\n  <span class="hljs-comment">// - status: HTTP 状态码</span>\n  <span class="hljs-comment">// - headers: 响应头</span>\n  <span class="hljs-comment">// - data: 响应体(根据 dataType 自动转换)</span>\n  \n  <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n}\n</code></pre>\n<h3>POST 请求</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">createItem</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://api.example.com/items&#x27;</span>, {\n    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n    <span class="hljs-attr">contentType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,\n    <span class="hljs-attr">data</span>: {\n      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;new item&#x27;</span>,\n      <span class="hljs-attr">value</span>: <span class="hljs-number">100</span>\n    },\n    <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>\n  });\n  \n  <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-number">201</span>) {\n    <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n  }\n  ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">502</span>, <span class="hljs-string">&#x27;Remote API error&#x27;</span>);\n}\n</code></pre>\n<h3>带查询参数的请求</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">search</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://api.example.com/search&#x27;</span>, {\n    <span class="hljs-attr">data</span>: { <span class="hljs-attr">q</span>: <span class="hljs-string">&#x27;egg&#x27;</span>, <span class="hljs-attr">page</span>: <span class="hljs-number">1</span> },\n    <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>\n  });\n  \n  <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n}\n</code></pre>\n<h2>高级用法</h2>\n<h3>文件上传</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">const</span> stream = fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">&#x27;/path/to/file&#x27;</span>);\n  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://api.example.com/upload&#x27;</span>, {\n    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n    <span class="hljs-attr">files</span>: {\n      <span class="hljs-attr">file</span>: stream <span class="hljs-comment">// 文件流</span>\n    },\n    <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>\n  });\n  \n  <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n}\n</code></pre>\n<h3>处理重定向</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">followRedirect</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://example.com/redirect&#x27;</span>, {\n    <span class="hljs-attr">followRedirect</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认 false</span>\n    <span class="hljs-attr">maxRedirects</span>: <span class="hljs-number">5</span>       <span class="hljs-comment">// 最大重定向次数</span>\n  });\n  \n  <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n}\n</code></pre>\n<h3>自定义请求头</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">withHeaders</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://api.example.com/auth&#x27;</span>, {\n    <span class="hljs-attr">headers</span>: {\n      <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">&#x27;Bearer token123&#x27;</span>,\n      <span class="hljs-string">&#x27;X-Custom-Header&#x27;</span>: <span class="hljs-string">&#x27;value&#x27;</span>\n    },\n    <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>\n  });\n  \n  <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n}\n</code></pre>\n<h2>错误处理</h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">safeRequest</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://api.example.com/unstable&#x27;</span>, {\n      <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>\n    });\n    \n    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span>) {\n      ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;API returned non-200 status: %s&#x27;</span>, result.<span class="hljs-property">status</span>);\n      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n    }\n    \n    <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n  } <span class="hljs-keyword">catch</span> (err) {\n    ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Request failed: %s&#x27;</span>, err.<span class="hljs-property">message</span>);\n    <span class="hljs-comment">// 可以根据 err.code 判断具体错误类型</span>\n    <span class="hljs-comment">// 如 ECONNREFUSED, ETIMEDOUT 等</span>\n    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n  }\n}\n</code></pre>\n<h2>最佳实践</h2>\n<ol>\n<li><strong>统一封装</strong>  ：建议在 service 层封装常用的 API 调用</li>\n<li><strong>配置管理</strong>  ：将 API 地址、超时时间等配置放在 config 文件中</li>\n<li><strong>错误处理</strong>  ：统一处理网络错误和业务错误</li>\n<li><strong>日志记录</strong>  ：记录重要请求的请求和响应信息</li>\n<li><strong>性能监控</strong>  ：记录请求耗时，监控外部 API 性能</li>\n</ol>\n<h2>Service 层封装示例</h2>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/service/api.js</span>\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">Service</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>).<span class="hljs-property">Service</span>;\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">path, options = {}</span>) {\n    <span class="hljs-keyword">const</span> { ctx, app } = <span class="hljs-variable language_">this</span>;\n    <span class="hljs-keyword">const</span> { apiBaseUrl, apiTimeout } = app.<span class="hljs-property">config</span>;\n    \n    <span class="hljs-keyword">const</span> defaultOptions = {\n      <span class="hljs-attr">timeout</span>: apiTimeout || <span class="hljs-number">3000</span>,\n      <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>\n    };\n    \n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">`<span class="hljs-subst">${apiBaseUrl}</span><span class="hljs-subst">${path}</span>`</span>, {\n        ...defaultOptions,\n        ...options\n      });\n      \n      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span>) {\n        ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(\n          <span class="hljs-string">&#x27;API request failed: %s %s, status: %s&#x27;</span>,\n          options.<span class="hljs-property">method</span> || <span class="hljs-string">&#x27;GET&#x27;</span>,\n          path,\n          result.<span class="hljs-property">status</span>\n        );\n        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n      }\n      \n      <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n    } <span class="hljs-keyword">catch</span> (err) {\n      ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(\n        <span class="hljs-string">&#x27;API request error: %s %s, error: %s&#x27;</span>,\n        options.<span class="hljs-property">method</span> || <span class="hljs-string">&#x27;GET&#x27;</span>,\n        path,\n        err.<span class="hljs-property">message</span>\n      );\n      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;\n    }\n  }\n  \n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`/users/<span class="hljs-subst">${id}</span>`</span>);\n  }\n  \n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">data</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, {\n      <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n      <span class="hljs-attr">contentType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,\n      data\n    });\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">ApiService</span>;\n</code></pre>\n<p>通过这样的封装，可以在整个应用中统一管理对外部 API 的调用。</p>\n</div>'</script></body></html>