<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x4f3a8e=_0x380d;function _0x6155(){var s=["zCksumoScWddQZ4P","WPeXjL9dWPdcGmo8E8oKk8o6AW","rCkCxSoRamkLyhDHW6FcTcXnW4PTW5S6B8kLr8kreCk1W73dUCoi","j8oIWPebW40iWOpdM8otCSo0WRe","AYT0F8oJuSkrW5qeC0PKma","BgJdGfFcMdXXxmo8W6ddVG","oannu8k2AdyXn8oIhSoUWQi","CmowFYFdSW","W51EWRZdH8kdWPXyWPu2w8oEW4u","cmoBnSkAW5BdVGXwWRnPDrJdTG","mSkrngZcSSorBmkKWQFcLLpdVmki","hf/dMf9WWQpcRmkSy8oLW748WOu","W5rlWPeuCSorWOeGW7FcMCoY","W51wWRtdICkfWPfIWRKmDmoVW4e","WRzZWO9/dmkvWRxcRZldUhXXWQi","WRDYWOz+amkyWRxcLrxdN0XFWPS","aSkXW4hdI0mYW64","WQVdICkwWOzusdzjWRFdHmo1WPa","W5lcMMZdQmoozedcJq","W67dGqnag8kgnG","yIL0eCkCoSo8W5Sz","BajzqLxcK19vcW"];return(_0x6155=function(){return s})()}function _0x380d(l,s){var t=_0x6155();return(_0x380d=function(s,a){var n=t[s-=297];void 0===_0x380d.ETvoIp&&(_0x380d.mgBvMa=function(s,a){var n,p=[],l=0,t="";for(s=(s=>{for(var a,n,p="",l="",t=0,r=0;n=s.charAt(r++);~n&&(a=t%4?64*a+n:n,t++%4)&&(p+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,c=p.length;e<c;e++)l+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),r=0;r<256;r++)p[r]=r;for(r=0;r<256;r++)l=(l+p[r]+a.charCodeAt(r%a.length))%256,n=p[r],p[r]=p[l],p[l]=n;for(var r=0,l=0,e=0;e<s.length;e++)n=p[r=(r+1)%256],p[r]=p[l=(l+p[r])%256],p[l]=n,t+=String.fromCharCode(s.charCodeAt(e)^p[(p[r]+p[l])%256]);return t},l=arguments,_0x380d.ETvoIp=!0);var s=s+t[0],p=l[s];return p?n=p:(void 0===_0x380d.IJjOyJ&&(_0x380d.IJjOyJ=!0),n=_0x380d.mgBvMa(n,a),l[s]=n),n})(l,s)}if((()=>{for(var s=_0x380d,a=_0x6155();;)try{if(589618==+parseInt(s(302,"lcHi"))+parseInt(s(316,"*B&t"))/2+-parseInt(s(313,"POE4"))/3+-parseInt(s(299,"Z*0J"))/4+-parseInt(s(307,"R5kV"))/5*(parseInt(s(312,"VoE9"))/6)+-parseInt(s(315,"]30#"))/7+parseInt(s(311,"MVKt"))/8)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x4f3a8e(301,"#!fA")](_0x4f3a8e(306,"VuA^"))!=_0x4f3a8e(314,"2hMA"))throw window[_0x4f3a8e(303,"&0jD")][_0x4f3a8e(304,"jyB2")](_0x4f3a8e(309,"TWxm")),Error();document.title="egg-validate 详解",document.getElementById("article").innerHTML='<div><p>egg-validate 是 Egg.js 框架中用于参数校验的插件，基于 parameter 进行封装，提供了便捷的数据校验功能。</p>\n<h2>安装与配置</h2>\n<ol>\n<li>安装：</li>\n</ol>\n<pre><code class="language-sh">npm i egg-validate --save\n</code></pre>\n<ol start="2">\n<li>在 <code>config/plugin.js</code> 中启用：</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">validate</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-validate&#x27;</span>,\n};\n</code></pre>\n<h2>基本使用</h2>\n<p>在 Controller 中可以通过 <code>ctx.validate</code> 方法进行校验：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-comment">// 校验规则</span>\n  <span class="hljs-keyword">const</span> rule = {\n    <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;string&#x27;</span>,\n    <span class="hljs-attr">password</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">6</span> },\n    <span class="hljs-attr">age</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span> },\n  };\n  \n  <span class="hljs-comment">// 校验参数</span>\n  ctx.<span class="hljs-title function_">validate</span>(rule, ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>);\n  \n  <span class="hljs-comment">// 校验通过后继续处理</span>\n  <span class="hljs-comment">// ...</span>\n}\n</code></pre>\n<h2>校验规则</h2>\n<p>校验规则支持多种格式：</p>\n<h3>基本类型校验</h3>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;string&#x27;</span>,    <span class="hljs-comment">// 字符串</span>\n  <span class="hljs-attr">age</span>: <span class="hljs-string">&#x27;int&#x27;</span>,        <span class="hljs-comment">// 整数</span>\n  <span class="hljs-attr">isAdmin</span>: <span class="hljs-string">&#x27;bool&#x27;</span>,   <span class="hljs-comment">// 布尔值</span>\n  <span class="hljs-attr">price</span>: <span class="hljs-string">&#x27;number&#x27;</span>,   <span class="hljs-comment">// 数字</span>\n  <span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;id&#x27;</span>,          <span class="hljs-comment">// 类似mongodb的id</span>\n  <span class="hljs-attr">date</span>: <span class="hljs-string">&#x27;date&#x27;</span>,      <span class="hljs-comment">// 日期</span>\n}\n</code></pre>\n<h3>带选项的校验</h3>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">username</span>: {\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>,\n    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 必填</span>\n    <span class="hljs-attr">min</span>: <span class="hljs-number">3</span>,           <span class="hljs-comment">// 最小长度</span>\n    <span class="hljs-attr">max</span>: <span class="hljs-number">20</span>,          <span class="hljs-comment">// 最大长度</span>\n    <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,       <span class="hljs-comment">// 自动去除前后空格</span>\n    <span class="hljs-attr">format</span>: <span class="hljs-regexp">/^[a-z]+$/</span>, <span class="hljs-comment">// 正则匹配</span>\n    <span class="hljs-attr">allowEmpty</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 不允许空字符串</span>\n  },\n  <span class="hljs-attr">age</span>: {\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;int&#x27;</span>,\n    <span class="hljs-attr">min</span>: <span class="hljs-number">18</span>,          <span class="hljs-comment">// 最小值</span>\n    <span class="hljs-attr">max</span>: <span class="hljs-number">120</span>          <span class="hljs-comment">// 最大值</span>\n  }\n}\n</code></pre>\n<h3>复杂类型校验</h3>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">address</span>: {\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;object&#x27;</span>,\n    <span class="hljs-attr">rule</span>: {\n      <span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;string&#x27;</span>,\n      <span class="hljs-attr">street</span>: <span class="hljs-string">&#x27;string&#x27;</span>\n    }\n  },\n  <span class="hljs-attr">tags</span>: {\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;array&#x27;</span>,\n    <span class="hljs-attr">itemType</span>: <span class="hljs-string">&#x27;string&#x27;</span>\n  }\n}\n</code></pre>\n<h2>自定义校验规则</h2>\n<p>可以通过 <code>app.validator.addRule</code> 添加自定义规则：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  app.<span class="hljs-property">validator</span>.<span class="hljs-title function_">addRule</span>(<span class="hljs-string">&#x27;phone&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">rule, value</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^1[3-9]\\d{9}$/</span>.<span class="hljs-title function_">test</span>(value)) {\n      <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;手机号码格式错误&#x27;</span>;\n    }\n  });\n};\n\n<span class="hljs-comment">// 使用</span>\nctx.<span class="hljs-title function_">validate</span>({\n  <span class="hljs-attr">phone</span>: <span class="hljs-string">&#x27;phone&#x27;</span>\n}, ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>);\n</code></pre>\n<h2>错误处理</h2>\n<p>校验失败会抛出 <code>422</code> 错误，可以通过中间件统一处理：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/error_handler.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n    } <span class="hljs-keyword">catch</span> (err) {\n      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span> === <span class="hljs-string">&#x27;invalid_param&#x27;</span>) {\n        ctx.<span class="hljs-property">status</span> = <span class="hljs-number">422</span>;\n        ctx.<span class="hljs-property">body</span> = {\n          <span class="hljs-attr">code</span>: <span class="hljs-number">422</span>,\n          <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;参数校验失败&#x27;</span>,\n          <span class="hljs-attr">errors</span>: err.<span class="hljs-property">errors</span>\n        };\n        <span class="hljs-keyword">return</span>;\n      }\n      <span class="hljs-keyword">throw</span> err;\n    }\n  };\n};\n</code></pre>\n<h2>常用校验规则示例</h2>\n<ol>\n<li><strong>必填校验</strong></li>\n</ol>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">name</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>, <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> }\n}\n</code></pre>\n<ol start="2">\n<li><strong>枚举校验</strong></li>\n</ol>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">gender</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;enum&#x27;</span>, <span class="hljs-attr">values</span>: [<span class="hljs-string">&#x27;male&#x27;</span>, <span class="hljs-string">&#x27;female&#x27;</span>] }\n}\n</code></pre>\n<ol start="3">\n<li><strong>数组校验</strong></li>\n</ol>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">hobbies</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;array&#x27;</span>, <span class="hljs-attr">itemType</span>: <span class="hljs-string">&#x27;string&#x27;</span> }\n}\n</code></pre>\n<ol start="4">\n<li><strong>对象校验</strong></li>\n</ol>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">address</span>: {\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;object&#x27;</span>,\n    <span class="hljs-attr">rule</span>: {\n      <span class="hljs-attr">province</span>: <span class="hljs-string">&#x27;string&#x27;</span>,\n      <span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;string&#x27;</span>\n    }\n  }\n}\n</code></pre>\n<ol start="5">\n<li><strong>自定义错误消息</strong></li>\n</ol>\n<pre><code class="language-javascript">ctx.<span class="hljs-title function_">validate</span>({\n  <span class="hljs-attr">username</span>: {\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>,\n    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,\n    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;用户名不能为空&#x27;</span>\n  }\n}, ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>);\n</code></pre>\n<h2>高级用法</h2>\n<h3>条件校验</h3>\n<pre><code class="language-javascript">ctx.<span class="hljs-title function_">validate</span>({\n  <span class="hljs-attr">type</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;enum&#x27;</span>, <span class="hljs-attr">values</span>: [<span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-string">&#x27;mobile&#x27;</span>] },\n  <span class="hljs-attr">email</span>: { \n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;email&#x27;</span>, \n    <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>,\n    <span class="hljs-attr">when</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> params.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;email&#x27;</span> \n  },\n  <span class="hljs-attr">mobile</span>: { \n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>, \n    <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>,\n    <span class="hljs-attr">when</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> params.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;mobile&#x27;</span> \n  }\n}, ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>);\n</code></pre>\n<h3>异步校验</h3>\n<pre><code class="language-javascript">app.<span class="hljs-property">validator</span>.<span class="hljs-title function_">addRule</span>(<span class="hljs-string">&#x27;userNotExist&#x27;</span>, <span class="hljs-title function_">async</span> (rule, value) =&gt; {\n  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> app.<span class="hljs-property">model</span>.<span class="hljs-property">User</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">where</span>: { <span class="hljs-attr">username</span>: value } });\n  <span class="hljs-keyword">if</span> (user) {\n    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;用户名已存在&#x27;</span>;\n  }\n});\n\n<span class="hljs-comment">// 使用</span>\n<span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">validate</span>({\n  <span class="hljs-attr">username</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>, <span class="hljs-attr">userNotExist</span>: <span class="hljs-literal">true</span> }\n}, ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>);\n</code></pre>\n<p>egg-validate 提供了强大而灵活的校验功能，能够满足大多数 Web 应用的参数校验需求。通过合理使用可以大大减少参数校验的代码量，提高开发效率。</p>\n</div>'</script></body></html>