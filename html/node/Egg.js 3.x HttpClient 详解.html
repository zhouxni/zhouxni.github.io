<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x400d35=_0x4216;function _0x3a50(){var s=["tmoxWOfuo8kVW7BcJ1OV","WQqQf8oBW4hcVSkZ","f8o3WP5sjaP1lW","C8ojvCoQW7hdHZfxWOrEBLa","WRaPW5yYWPFcMcZdJmkTWPGmW4K","xbP/WP3dTCkXi8kVbw9iWPKK","j8kOW7VcM8o3C8kwt8kjWQNdMCoo","zmkGWQ1oaIb1bmoU","W64bWQXgWP8xW5ZdHSoHWQO","W4D5qq8Qpmkq","W7zUWPD1W5W","hSkYiCkHCSk9pvrxbsTZcG","W67dQaNdOvi9DmkDWRi","W4SVW4JcJSoPW7WPWPZdGSkLF0u","iqNcO8oyW6/cN8kGW6K","WRK3WQjWWOTnESouW41oWObSW6nFaHJcPX4AEeyKW6BcUcFcQW","DmonumoNW7ldJq9jWRrfChu","qmoxWOTBr8olW6BcH3Koqmkw","rCozWOTwrCoiWOlcKemBtmkyCa","yKldNSksWQxdVMRcI8kRW4dcUSoFfG","W43dTSkttafqW7hcOIZdO8o5hhu","qSovWOS1nCkRW5BcH2q","WRnYW4LYWQTlW5usrNCjWP3dNa","tSkvWOZcK3rBya","WRJdGCojnCk2wSkHmG","tSoxWOj9kMVdHq","WQNcGmkxWOCMWO3cQCoZ"];return(_0x3a50=function(){return s})()}function _0x4216(p,s){var t=_0x3a50();return(_0x4216=function(s,a){var n=t[s-=461];void 0===_0x4216.cBssDy&&(_0x4216.YoEDDX=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,c=0;n=s.charAt(c++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,r=l.length;e<r;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+a.charCodeAt(c%a.length))%256,n=l[c],l[c]=l[p],l[p]=n;for(var c=0,p=0,e=0;e<s.length;e++)n=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(e)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x4216.cBssDy=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x4216.UGuHDa&&(_0x4216.UGuHDa=!0),n=_0x4216.YoEDDX(n,a),p[s]=n),n})(p,s)}if((()=>{for(var s=_0x4216,a=_0x3a50();;)try{if(268356==-parseInt(s(461,"f^W%"))+parseInt(s(475,"t&k0"))/2+-parseInt(s(482,"PdzS"))/3*(parseInt(s(476,"PdzS"))/4)+-parseInt(s(469,"&32h"))/5*(parseInt(s(468,"CSvq"))/6)+-parseInt(s(485,"QmbF"))/7*(-parseInt(s(484,"zC]D"))/8)+-parseInt(s(480,"YQis"))/9*(-parseInt(s(474,"]O^P"))/10)+parseInt(s(487,"J)Wl"))/11)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x400d35(478,"wnWR")](_0x400d35(462,"zC]D"))!=_0x400d35(465,"kSYZ"))throw window[_0x400d35(481,")V9j")][_0x400d35(483,"6LLn")](_0x400d35(470,"WnFK")),Error();document.title="Egg.js 3.x HttpClient 详解",document.getElementById("article").innerHTML='<div><h2>一、HttpClient 简介</h2>\n<p>Egg.js 内置了基于 <a href="https://github.com/node-modules/urllib" target="_blank">urllib</a> 的高性能 HttpClient，具有以下特点：</p>\n<ul>\n<li>内置 Promise 支持</li>\n<li>请求/响应拦截</li>\n<li>自动处理 JSON 格式</li>\n<li>超时重试机制</li>\n<li>DNS 缓存</li>\n<li>完善的错误处理</li>\n</ul>\n<h2>二、基本使用方式</h2>\n<h3>1. 通过 app 使用</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在 service/controller 中使用</span>\n<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">curl</span>(url, options);\n</code></pre>\n<h3>2. 通过 ctx 使用（推荐）</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在 controller 中使用</span>\n<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">curl</span>(url, options);\n</code></pre>\n<h2>三、核心 API</h2>\n<h3>1. 基本请求方法</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// GET 请求</span>\n<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://example.com/api/users&#x27;</span>, {\n  <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span> <span class="hljs-comment">// 自动解析响应为 JSON</span>\n});\n\n<span class="hljs-comment">// POST 请求</span>\n<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(<span class="hljs-string">&#x27;https://example.com/api/users&#x27;</span>, {\n  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n  <span class="hljs-attr">contentType</span>: <span class="hljs-string">&#x27;json&#x27;</span>, <span class="hljs-comment">// 声明发送 JSON</span>\n  <span class="hljs-attr">data</span>: {\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;egg&#x27;</span>,\n    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;framework&#x27;</span>\n  },\n  <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>\n});\n\n<span class="hljs-comment">// PUT/DELETE 等其他方法类似</span>\n</code></pre>\n<h3>2. 响应结构</h3>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">status</span>: <span class="hljs-number">200</span>,           <span class="hljs-comment">// HTTP 状态码</span>\n  <span class="hljs-attr">headers</span>: {},           <span class="hljs-comment">// 响应头</span>\n  <span class="hljs-attr">data</span>: {},              <span class="hljs-comment">// 响应体（根据 dataType 处理后的数据）</span>\n  <span class="hljs-attr">res</span>: {}                <span class="hljs-comment">// 原始响应对象</span>\n}\n</code></pre>\n<h2>四、高级配置</h2>\n<h3>1. 全局配置</h3>\n<p>在 <code>config/config.default.js</code> 中：</p>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpclient</span> = {\n  <span class="hljs-comment">// 默认超时时间</span>\n  <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,\n  \n  <span class="hljs-comment">// 请求重试次数</span>\n  <span class="hljs-attr">retry</span>: <span class="hljs-number">2</span>,\n  \n  <span class="hljs-comment">// 是否在开发环境下缓存 DNS</span>\n  <span class="hljs-attr">dnsCache</span>: <span class="hljs-literal">true</span>,\n  \n  <span class="hljs-comment">// 请求拦截器</span>\n  <span class="hljs-attr">requestInterceptor</span>: <span class="hljs-function"><span class="hljs-params">req</span> =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">url</span>);\n    <span class="hljs-keyword">return</span> req;\n  },\n  \n  <span class="hljs-comment">// 响应拦截器</span>\n  <span class="hljs-attr">responseInterceptor</span>: <span class="hljs-function"><span class="hljs-params">resp</span> =&gt;</span> {\n    <span class="hljs-keyword">if</span> (resp.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span>) {\n      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;request error&#x27;</span>);\n    }\n    <span class="hljs-keyword">return</span> resp;\n  }\n};\n</code></pre>\n<h3>2. 请求级别配置</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, {\n  <span class="hljs-comment">// 超时时间（毫秒）</span>\n  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,\n  \n  <span class="hljs-comment">// 重试次数</span>\n  <span class="hljs-attr">retries</span>: <span class="hljs-number">3</span>,\n  \n  <span class="hljs-comment">// 请求头</span>\n  <span class="hljs-attr">headers</span>: {\n    <span class="hljs-string">&#x27;X-Request-Id&#x27;</span>: <span class="hljs-string">&#x27;12345&#x27;</span>\n  },\n  \n  <span class="hljs-comment">// 查询参数</span>\n  <span class="hljs-attr">data</span>: {\n    <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,\n    <span class="hljs-attr">size</span>: <span class="hljs-number">10</span>\n  },\n  \n  <span class="hljs-comment">// 请求内容类型</span>\n  <span class="hljs-attr">contentType</span>: <span class="hljs-string">&#x27;json&#x27;</span>, <span class="hljs-comment">// 可选：json, form, text 等</span>\n  \n  <span class="hljs-comment">// 响应数据类型</span>\n  <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,   <span class="hljs-comment">// 可选：json, text, buffer 等</span>\n  \n  <span class="hljs-comment">// 是否自动处理 302 跳转</span>\n  <span class="hljs-attr">followRedirect</span>: <span class="hljs-literal">true</span>,\n  \n  <span class="hljs-comment">// 是否自动处理 gzip 响应</span>\n  <span class="hljs-attr">gzip</span>: <span class="hljs-literal">true</span>,\n  \n  <span class="hljs-comment">// 请求跟踪（用于日志）</span>\n  <span class="hljs-attr">timing</span>: <span class="hljs-literal">true</span>\n});\n</code></pre>\n<h2>五、最佳实践</h2>\n<h3>1. 封装 Service 层</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/service/http.js</span>\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Service</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Service</span> {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">url, options = {}</span>) {\n    <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n    \n    <span class="hljs-keyword">const</span> defaultOptions = {\n      <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,\n      <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,\n      <span class="hljs-attr">headers</span>: {\n        <span class="hljs-string">&#x27;X-Request-Id&#x27;</span>: ctx.<span class="hljs-property">traceId</span>\n      }\n    };\n    \n    <span class="hljs-keyword">const</span> mergedOptions = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, defaultOptions, options);\n    \n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, mergedOptions);\n      <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n    } <span class="hljs-keyword">catch</span> (err) {\n      ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;HttpClient request error&#x27;</span>, err);\n      <span class="hljs-keyword">throw</span> err;\n    }\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">HttpService</span>;\n\n<span class="hljs-comment">// 使用示例</span>\n<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">service</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">&#x27;https://api.example.com/users&#x27;</span>);\n</code></pre>\n<h3>2. 错误处理</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">try</span> {\n  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, options);\n  \n  <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span>) {\n    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Request failed with status code <span class="hljs-subst">${result.status}</span>`</span>);\n  }\n  \n  <span class="hljs-keyword">return</span> result.<span class="hljs-property">data</span>;\n} <span class="hljs-keyword">catch</span> (err) {\n  ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;HttpClient error&#x27;</span>, err);\n  \n  <span class="hljs-comment">// 根据错误类型处理</span>\n  <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span> === <span class="hljs-string">&#x27;ECONNREFUSED&#x27;</span>) {\n    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;服务不可用&#x27;</span>);\n  }\n  \n  <span class="hljs-keyword">throw</span> err;\n}\n</code></pre>\n<h3>3. 文件上传</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, {\n  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n  <span class="hljs-attr">files</span>: {\n    <span class="hljs-attr">file</span>: <span class="hljs-string">&#x27;/path/to/file.jpg&#x27;</span> <span class="hljs-comment">// 文件路径</span>\n  },\n  <span class="hljs-attr">data</span>: {\n    <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;test file&#x27;</span>\n  },\n  <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>\n});\n</code></pre>\n<h3>4. 文件下载</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, {\n  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;GET&#x27;</span>,\n  <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;stream&#x27;</span> <span class="hljs-comment">// 获取文件流</span>\n});\n\n<span class="hljs-comment">// 保存文件</span>\n<span class="hljs-keyword">const</span> writeStream = fs.<span class="hljs-title function_">createWriteStream</span>(<span class="hljs-string">&#x27;/path/to/save&#x27;</span>);\nresult.<span class="hljs-property">data</span>.<span class="hljs-title function_">pipe</span>(writeStream);\n</code></pre>\n<h2>六、性能优化</h2>\n<h3>1. 连接池配置</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpclient</span> = {\n  <span class="hljs-comment">// 每个 host 的最大连接数</span>\n  <span class="hljs-attr">maxSockets</span>: <span class="hljs-number">100</span>,\n  \n  <span class="hljs-comment">// 每个 host 的最大空闲连接数</span>\n  <span class="hljs-attr">maxFreeSockets</span>: <span class="hljs-number">10</span>,\n  \n  <span class="hljs-comment">// 空闲连接超时时间（毫秒）</span>\n  <span class="hljs-attr">freeSocketTimeout</span>: <span class="hljs-number">4000</span>\n};\n</code></pre>\n<h3>2. DNS 缓存</h3>\n<pre><code class="language-javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">httpclient</span> = {\n  <span class="hljs-comment">// 启用 DNS 缓存</span>\n  <span class="hljs-attr">dnsCache</span>: <span class="hljs-literal">true</span>,\n  \n  <span class="hljs-comment">// DNS 缓存时间（毫秒）</span>\n  <span class="hljs-attr">dnsCacheLookupInterval</span>: <span class="hljs-number">10000</span>\n};\n</code></pre>\n<h2>七、常见问题</h2>\n<h3>1. 代理配置</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, {\n  <span class="hljs-comment">// 通过环境变量配置代理</span>\n  <span class="hljs-attr">enableProxy</span>: <span class="hljs-literal">true</span>,\n  \n  <span class="hljs-comment">// 或直接指定代理</span>\n  <span class="hljs-attr">proxy</span>: <span class="hljs-string">&#x27;http://proxy.server.com:8080&#x27;</span>\n});\n</code></pre>\n<h3>2. HTTPS 证书问题</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, {\n  <span class="hljs-comment">// 忽略证书错误（不推荐生产环境使用）</span>\n  <span class="hljs-attr">rejectUnauthorized</span>: <span class="hljs-literal">false</span>,\n  \n  <span class="hljs-comment">// 或指定 CA 证书</span>\n  <span class="hljs-attr">ca</span>: fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;/path/to/ca.crt&#x27;</span>)\n});\n</code></pre>\n<h3>3. 大文件上传</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> form = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormStream</span>();\nform.<span class="hljs-title function_">file</span>(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-string">&#x27;/path/to/large-file.zip&#x27;</span>, {\n  <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;upload.zip&#x27;</span>\n});\n\n<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">curl</span>(url, {\n  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n  <span class="hljs-attr">headers</span>: form.<span class="hljs-title function_">headers</span>(),\n  <span class="hljs-attr">stream</span>: form,\n  <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>\n});\n</code></pre>\n<p>通过以上配置和使用方法，你可以在 Egg.js 中高效、可靠地使用 HttpClient 进行各种 HTTP 请求操作。</p>\n</div>'</script></body></html>