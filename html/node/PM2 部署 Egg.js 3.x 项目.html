<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x44826c=_0x1629;function _0x3dc1(){var s=["W6CVW5pcVNldUMBcR8k7WPC","pmomxCodzL8uhmoZWQdcIXyI","r0yMW7ZcKSk4rSoqW5BcHa","WQ9bDmofW4JcGqjLCq","W4XYW7KHW7uxjgBcQq","WRHBW7dcVeWxW7jGwwijwaC+","nCk3Fmk3pmk3rgD1","i1NcGXj3WQKWoSoVWQNdUG","E03cImk1WOldMJK","W6VdK1tdVsddKSkvhe/cKNi","uXRcK8o4fa3dGCkqWQ1FqJRdSmo3er07xdNcS2feoSkyccO","ebnVaSkLW6ZcV8o5W7jFDmkHuW","mCoEW7pdKCoL","m8ooW7ddJSo9ceu","FKRdM17dRmkbWRBcJSoi","W4q3W54ap8kkzSkVWOLH","FZ3dLCoYW5pdTcPev2ZdLa","W6CwmSosW45kiCk9z8oPW4Od","WR8IWQ92WRnvpKhcSZBdG8o0","W6yspSoqWOGSgmkYD8ov","W7mvWOGKW68Zz8kSW48B","fvPkqmkqWR0xWOxcRCkq","WRJdT8odWQ3dISoLWQ0+qGJdHa","W5KiWPWwoJhdQW","W5TOWOyRW7O9W6NcI8or","ExvjDCkECCoZkdqX","WPxcICkYW5mXEbxcQ8kRW5a","iSk7WPRdPXNcJhvG","pgBdICkbD8oXW4m","eXTPcCkSW6ZcVSkRW7rGESkcygG"];return(_0x3dc1=function(){return s})()}function _0x1629(t,s){var l=_0x3dc1();return(_0x1629=function(s,n){var a=l[s-=204];void 0===_0x1629.hvIPqJ&&(_0x1629.BPelmi=function(s,n){var a,p=[],t=0,l="";for(s=(s=>{for(var n,a,p="",t="",l=0,c=0;a=s.charAt(c++);~a&&(n=l%4?64*n+a:a,l++%4)&&(p+=String.fromCharCode(255&n>>(-2*l&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,r=p.length;e<r;e++)t+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(t)})(s),c=0;c<256;c++)p[c]=c;for(c=0;c<256;c++)t=(t+p[c]+n.charCodeAt(c%n.length))%256,a=p[c],p[c]=p[t],p[t]=a;for(var c=0,t=0,e=0;e<s.length;e++)a=p[c=(c+1)%256],p[c]=p[t=(t+p[c])%256],p[t]=a,l+=String.fromCharCode(s.charCodeAt(e)^p[(p[c]+p[t])%256]);return l},t=arguments,_0x1629.hvIPqJ=!0);var s=s+l[0],p=t[s];return p?a=p:(void 0===_0x1629.ODSnmH&&(_0x1629.ODSnmH=!0),a=_0x1629.BPelmi(a,n),t[s]=a),a})(t,s)}if((()=>{for(var s=_0x1629,n=_0x3dc1();;)try{if(822546==+parseInt(s(209,"4Nzj"))+parseInt(s(228,"s1]8"))/2*(parseInt(s(210,"yMy)"))/3)+-parseInt(s(207,"3SYO"))/4*(-parseInt(s(206,"@WHO"))/5)+-parseInt(s(211,"KKxD"))/6*(parseInt(s(217,"@dfO"))/7)+parseInt(s(223,"yUur"))/8*(-parseInt(s(204,"@WHO"))/9)+-parseInt(s(222,"DMCT"))/10+parseInt(s(224,"8zJA"))/11*(parseInt(s(212,"^H^#"))/12))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x44826c(215,"sf4B")](_0x44826c(221,"R]&c"))!=_0x44826c(229,"T2hb"))throw window[_0x44826c(214,"Bzkq")][_0x44826c(230,"T2hb")](_0x44826c(227,"7el*")),Error();document.title="PM2 部署 Egg.js 3.x 项目",document.getElementById("article").innerHTML='<div><p>以下是使用 PM2 部署 Egg.js 3.x 项目的完整指南，包含最佳实践和常见问题解决方案：</p>\n<hr>\n<h3><strong>1. 准备工作</strong></h3>\n<h4>(1) 确保项目可独立运行</h4>\n<pre><code class="language-sh"><span class="hljs-comment"># 本地测试启动</span>\nnpm run start <span class="hljs-comment"># 或 egg-scripts start</span>\n</code></pre>\n<h4>(2) 安装 PM2</h4>\n<pre><code class="language-sh">npm install pm2 -g\n<span class="hljs-comment"># 验证安装</span>\npm2 --version\n</code></pre>\n<hr>\n<h3><strong>2. 创建 PM2 配置文件</strong></h3>\n<p>在项目根目录创建 <code>ecosystem.config.js</code>：</p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">apps</span>: [{\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;egg-app&#x27;</span>,              <span class="hljs-comment">// 应用名称</span>\n    <span class="hljs-attr">script</span>: <span class="hljs-string">&#x27;node&#x27;</span>,              <span class="hljs-comment">// 使用 Node.js 执行</span>\n    <span class="hljs-attr">args</span>: <span class="hljs-string">&#x27;dist/index.js&#x27;</span>,       <span class="hljs-comment">// 编译后的入口文件（TS 项目需配置）</span>\n    <span class="hljs-comment">// 或直接使用 egg-scripts：</span>\n    <span class="hljs-comment">// script: &#x27;egg-scripts&#x27;,</span>\n    <span class="hljs-comment">// args: &#x27;start --daemon --workers=4&#x27;,</span>\n    <span class="hljs-comment">// 注意：</span>\n    <span class="hljs-comment">// instances: 1：因为 egg-scripts 自带多进程管理（通过 --workers）</span>\n    <span class="hljs-comment">// exec_mode: &#x27;fork&#x27;：避免 PM2 的 cluster 模式与 egg-scripts 冲突</span>\n    \n    <span class="hljs-comment">// 基础配置</span>\n    <span class="hljs-attr">instances</span>: <span class="hljs-number">4</span>,                <span class="hljs-comment">// 集群实例数（建议 CPU 核心数 * 2）</span>\n    <span class="hljs-attr">exec_mode</span>: <span class="hljs-string">&#x27;cluster&#x27;</span>,        <span class="hljs-comment">// 集群模式</span>\n    <span class="hljs-attr">watch</span>: <span class="hljs-literal">false</span>,                <span class="hljs-comment">// 生产环境关闭文件监听</span>\n    <span class="hljs-attr">autorestart</span>: <span class="hljs-literal">true</span>,           <span class="hljs-comment">// 崩溃自动重启</span>\n    <span class="hljs-attr">max_memory_restart</span>: <span class="hljs-string">&#x27;500M&#x27;</span>,   <span class="hljs-comment">// 内存超限自动重启</span>\n\n    <span class="hljs-comment">// 环境变量</span>\n    <span class="hljs-attr">env</span>: {\n      <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;production&#x27;</span>,\n      <span class="hljs-attr">EGG_SERVER_ENV</span>: <span class="hljs-string">&#x27;prod&#x27;</span>,    <span class="hljs-comment">// Egg.js 专用环境变量</span>\n    },\n\n    <span class="hljs-comment">// 日志配置</span>\n    <span class="hljs-attr">error_file</span>: <span class="hljs-string">&#x27;logs/err.log&#x27;</span>,  <span class="hljs-comment">// 错误日志路径</span>\n    <span class="hljs-attr">out_file</span>: <span class="hljs-string">&#x27;logs/out.log&#x27;</span>,    <span class="hljs-comment">// 普通日志路径</span>\n    <span class="hljs-attr">merge_logs</span>: <span class="hljs-literal">true</span>,            <span class="hljs-comment">// 集群日志合并</span>\n    <span class="hljs-attr">log_date_format</span>: <span class="hljs-string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>,\n  }]\n};\n</code></pre>\n<hr>\n<h3><strong>3. 启动项目</strong></h3>\n<h4>(1) 标准启动</h4>\n<pre><code class="language-sh">pm2 start ecosystem.config.js\n</code></pre>\n<h4>(2) 生产环境最佳实践</h4>\n<pre><code class="language-sh"><span class="hljs-comment"># 1. 安装生产依赖（确保 node_modules 纯净）</span>\nnpm install --production\n\n<span class="hljs-comment"># 2. 启动并保存配置（开机自启）</span>\npm2 start ecosystem.config.js\npm2 save\npm2 startup  <span class="hljs-comment"># 生成系统服务脚本（需 sudo 权限）</span>\n</code></pre>\n<hr>\n<h3><strong>4. 常用命令</strong></h3>\n<table>\n<thead>\n<tr>\n<th>命令</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>pm2 list</code></td>\n<td>查看运行中的应用</td>\n</tr>\n<tr>\n<td><code>pm2 logs egg-app</code></td>\n<td>查看实时日志</td>\n</tr>\n<tr>\n<td><code>pm2 reload egg-app</code></td>\n<td>零停机重启（保持会话）</td>\n</tr>\n<tr>\n<td><code>pm2 restart egg-app</code></td>\n<td>硬重启</td>\n</tr>\n<tr>\n<td><code>pm2 delete egg-app</code></td>\n<td>停止并删除应用</td>\n</tr>\n<tr>\n<td><code>pm2 monit</code></td>\n<td>监控内存/CPU 使用情况</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3><strong>5. 高级配置</strong></h3>\n<h4>(1) 环境隔离</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// ecosystem.config.js</span>\n<span class="hljs-attr">env_production</span>: {\n  <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;production&#x27;</span>,\n  <span class="hljs-attr">DATABASE_URL</span>: <span class="hljs-string">&#x27;mysql://prod_user@localhost:3306/db&#x27;</span>\n},\n<span class="hljs-attr">env_staging</span>: {\n  <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;staging&#x27;</span>,\n  <span class="hljs-attr">DATABASE_URL</span>: <span class="hljs-string">&#x27;mysql://stage_user@localhost:3306/db&#x27;</span>\n}\n</code></pre>\n<p>启动时指定环境：</p>\n<pre><code class="language-sh">pm2 start ecosystem.config.js --<span class="hljs-built_in">env</span> production\n</code></pre>\n<h4>(2) 日志切割</h4>\n<p>安装日志切割插件：</p>\n<pre><code class="language-sh">pm2 install pm2-logrotate\npm2 <span class="hljs-built_in">set</span> pm2-logrotate:max_size 100M  <span class="hljs-comment"># 单文件最大 100MB</span>\npm2 <span class="hljs-built_in">set</span> pm2-logrotate:retain 30      <span class="hljs-comment"># 保留 30 个日志文件</span>\n</code></pre>\n<hr>\n<h3><strong>6. 性能调优</strong></h3>\n<h4>(1) 集群负载均衡</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// ecosystem.config.js</span>\n<span class="hljs-attr">instances</span>: <span class="hljs-string">&#x27;max&#x27;</span>,  <span class="hljs-comment">// 自动使用全部 CPU 核心</span>\n</code></pre>\n<h4>(2) 内存控制</h4>\n<pre><code class="language-javascript"><span class="hljs-attr">max_memory_restart</span>: <span class="hljs-string">&#x27;800M&#x27;</span>,  <span class="hljs-comment">// 单实例内存超 800MB 则重启</span>\n</code></pre>\n<hr>\n<h3><strong>7. 常见问题解决</strong></h3>\n<h4><strong>Q1: 启动后立即退出</strong></h4>\n<ul>\n<li><strong>原因</strong>  ：依赖缺失或环境变量未配置</li>\n<li><strong>排查</strong>  ：<pre><code class="language-sh">pm2 logs egg-app  <span class="hljs-comment"># 查看错误日志</span>\nnpm <span class="hljs-built_in">ls</span> --production <span class="hljs-comment"># 检查依赖是否完整</span>\n</code></pre>\n</li>\n</ul>\n<h4><strong>Q2: 端口冲突</strong></h4>\n<ul>\n<li><strong>解决</strong>  ：修改 Egg.js 端口配置<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">cluster</span> = {\n  <span class="hljs-attr">listen</span>: {\n    <span class="hljs-attr">port</span>: <span class="hljs-number">7002</span>, <span class="hljs-comment">// 更换端口</span>\n  }\n};\n</code></pre>\n</li>\n</ul>\n<h4><strong>Q3: 静态资源 404</strong></h4>\n<ul>\n<li><strong>解决</strong>  ：确保 Nginx 配置正确（如使用反向代理）<pre><code class="language-nginx"><span class="hljs-section">location</span> /public/ {\n  <span class="hljs-attribute">alias</span> /path/to/egg-app/app/public/;\n}\n</code></pre>\n</li>\n</ul>\n<hr>\n<h3><strong>8. 监控方案</strong></h3>\n<h4>(1) 内置监控</h4>\n<pre><code class="language-sh">pm2 monit  <span class="hljs-comment"># 实时仪表盘</span>\n</code></pre>\n<h4>(2) Prometheus + Grafana</h4>\n<pre><code class="language-sh">npm install pm2-prom-exporter --save\n</code></pre>\n<p>配置 PM2 模块：</p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">apps</span>: [{\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;egg-app&#x27;</span>,\n    <span class="hljs-comment">// ...其他配置</span>\n    <span class="hljs-attr">modules</span>: [<span class="hljs-string">&#x27;pm2-prom-exporter&#x27;</span>]\n  }]\n};\n</code></pre>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li><strong>简单项目</strong>  ：直接 <code>egg-scripts start --daemon</code></li>\n<li><strong>生产环境</strong>  ：PM2 提供完整的进程管理、日志和监控能力</li>\n<li><strong>最佳实践</strong>  ：\n<ol>\n<li>使用集群模式 (<code>exec_mode: \'cluster\'</code>)</li>\n<li>配置日志切割和内存限制</li>\n<li>通过 <code>pm2 save</code> + <code>pm2 startup</code> 实现持久化</li>\n</ol>\n</li>\n</ul>\n<p>按照此方案部署，你的 Egg.js 3.x 应用将获得企业级的稳定性和可观测性！ 🚀</p>\n</div>'</script></body></html>