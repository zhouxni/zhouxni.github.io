<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x44826c=_0x1629;function _0x3dc1(){var s=["W6CVW5pcVNldUMBcR8k7WPC","pmomxCodzL8uhmoZWQdcIXyI","r0yMW7ZcKSk4rSoqW5BcHa","WQ9bDmofW4JcGqjLCq","W4XYW7KHW7uxjgBcQq","WRHBW7dcVeWxW7jGwwijwaC+","nCk3Fmk3pmk3rgD1","i1NcGXj3WQKWoSoVWQNdUG","E03cImk1WOldMJK","W6VdK1tdVsddKSkvhe/cKNi","uXRcK8o4fa3dGCkqWQ1FqJRdSmo3er07xdNcS2feoSkyccO","ebnVaSkLW6ZcV8o5W7jFDmkHuW","mCoEW7pdKCoL","m8ooW7ddJSo9ceu","FKRdM17dRmkbWRBcJSoi","W4q3W54ap8kkzSkVWOLH","FZ3dLCoYW5pdTcPev2ZdLa","W6CwmSosW45kiCk9z8oPW4Od","WR8IWQ92WRnvpKhcSZBdG8o0","W6yspSoqWOGSgmkYD8ov","W7mvWOGKW68Zz8kSW48B","fvPkqmkqWR0xWOxcRCkq","WRJdT8odWQ3dISoLWQ0+qGJdHa","W5KiWPWwoJhdQW","W5TOWOyRW7O9W6NcI8or","ExvjDCkECCoZkdqX","WPxcICkYW5mXEbxcQ8kRW5a","iSk7WPRdPXNcJhvG","pgBdICkbD8oXW4m","eXTPcCkSW6ZcVSkRW7rGESkcygG"];return(_0x3dc1=function(){return s})()}function _0x1629(t,s){var l=_0x3dc1();return(_0x1629=function(s,n){var a=l[s-=204];void 0===_0x1629.hvIPqJ&&(_0x1629.BPelmi=function(s,n){var a,p=[],t=0,l="";for(s=(s=>{for(var n,a,p="",t="",l=0,c=0;a=s.charAt(c++);~a&&(n=l%4?64*n+a:a,l++%4)&&(p+=String.fromCharCode(255&n>>(-2*l&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,r=p.length;e<r;e++)t+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(t)})(s),c=0;c<256;c++)p[c]=c;for(c=0;c<256;c++)t=(t+p[c]+n.charCodeAt(c%n.length))%256,a=p[c],p[c]=p[t],p[t]=a;for(var c=0,t=0,e=0;e<s.length;e++)a=p[c=(c+1)%256],p[c]=p[t=(t+p[c])%256],p[t]=a,l+=String.fromCharCode(s.charCodeAt(e)^p[(p[c]+p[t])%256]);return l},t=arguments,_0x1629.hvIPqJ=!0);var s=s+l[0],p=t[s];return p?a=p:(void 0===_0x1629.ODSnmH&&(_0x1629.ODSnmH=!0),a=_0x1629.BPelmi(a,n),t[s]=a),a})(t,s)}if((()=>{for(var s=_0x1629,n=_0x3dc1();;)try{if(822546==+parseInt(s(209,"4Nzj"))+parseInt(s(228,"s1]8"))/2*(parseInt(s(210,"yMy)"))/3)+-parseInt(s(207,"3SYO"))/4*(-parseInt(s(206,"@WHO"))/5)+-parseInt(s(211,"KKxD"))/6*(parseInt(s(217,"@dfO"))/7)+parseInt(s(223,"yUur"))/8*(-parseInt(s(204,"@WHO"))/9)+-parseInt(s(222,"DMCT"))/10+parseInt(s(224,"8zJA"))/11*(parseInt(s(212,"^H^#"))/12))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x44826c(215,"sf4B")](_0x44826c(221,"R]&c"))!=_0x44826c(229,"T2hb"))throw window[_0x44826c(214,"Bzkq")][_0x44826c(230,"T2hb")](_0x44826c(227,"7el*")),Error();document.title="PM2 éƒ¨ç½² Egg.js 3.x é¡¹ç›®",document.getElementById("article").innerHTML='<div><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ PM2 éƒ¨ç½² Egg.js 3.x é¡¹ç›®çš„å®Œæ•´æŒ‡å—ï¼ŒåŒ…å«æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š</p>\n<hr>\n<h3><strong>1. å‡†å¤‡å·¥ä½œ</strong></h3>\n<h4>(1) ç¡®ä¿é¡¹ç›®å¯ç‹¬ç«‹è¿è¡Œ</h4>\n<pre><code class="language-sh"><span class="hljs-comment"># æœ¬åœ°æµ‹è¯•å¯åŠ¨</span>\nnpm run start <span class="hljs-comment"># æˆ– egg-scripts start</span>\n</code></pre>\n<h4>(2) å®‰è£… PM2</h4>\n<pre><code class="language-sh">npm install pm2 -g\n<span class="hljs-comment"># éªŒè¯å®‰è£…</span>\npm2 --version\n</code></pre>\n<hr>\n<h3><strong>2. åˆ›å»º PM2 é…ç½®æ–‡ä»¶</strong></h3>\n<p>åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º <code>ecosystem.config.js</code>ï¼š</p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">apps</span>: [{\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;egg-app&#x27;</span>,              <span class="hljs-comment">// åº”ç”¨åç§°</span>\n    <span class="hljs-attr">script</span>: <span class="hljs-string">&#x27;node&#x27;</span>,              <span class="hljs-comment">// ä½¿ç”¨ Node.js æ‰§è¡Œ</span>\n    <span class="hljs-attr">args</span>: <span class="hljs-string">&#x27;dist/index.js&#x27;</span>,       <span class="hljs-comment">// ç¼–è¯‘åçš„å…¥å£æ–‡ä»¶ï¼ˆTS é¡¹ç›®éœ€é…ç½®ï¼‰</span>\n    <span class="hljs-comment">// æˆ–ç›´æ¥ä½¿ç”¨ egg-scriptsï¼š</span>\n    <span class="hljs-comment">// script: &#x27;egg-scripts&#x27;,</span>\n    <span class="hljs-comment">// args: &#x27;start --daemon --workers=4&#x27;,</span>\n    <span class="hljs-comment">// æ³¨æ„ï¼š</span>\n    <span class="hljs-comment">// instances: 1ï¼šå› ä¸º egg-scripts è‡ªå¸¦å¤šè¿›ç¨‹ç®¡ç†ï¼ˆé€šè¿‡ --workersï¼‰</span>\n    <span class="hljs-comment">// exec_mode: &#x27;fork&#x27;ï¼šé¿å… PM2 çš„ cluster æ¨¡å¼ä¸ egg-scripts å†²çª</span>\n    \n    <span class="hljs-comment">// åŸºç¡€é…ç½®</span>\n    <span class="hljs-attr">instances</span>: <span class="hljs-number">4</span>,                <span class="hljs-comment">// é›†ç¾¤å®ä¾‹æ•°ï¼ˆå»ºè®® CPU æ ¸å¿ƒæ•° * 2ï¼‰</span>\n    <span class="hljs-attr">exec_mode</span>: <span class="hljs-string">&#x27;cluster&#x27;</span>,        <span class="hljs-comment">// é›†ç¾¤æ¨¡å¼</span>\n    <span class="hljs-attr">watch</span>: <span class="hljs-literal">false</span>,                <span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒå…³é—­æ–‡ä»¶ç›‘å¬</span>\n    <span class="hljs-attr">autorestart</span>: <span class="hljs-literal">true</span>,           <span class="hljs-comment">// å´©æºƒè‡ªåŠ¨é‡å¯</span>\n    <span class="hljs-attr">max_memory_restart</span>: <span class="hljs-string">&#x27;500M&#x27;</span>,   <span class="hljs-comment">// å†…å­˜è¶…é™è‡ªåŠ¨é‡å¯</span>\n\n    <span class="hljs-comment">// ç¯å¢ƒå˜é‡</span>\n    <span class="hljs-attr">env</span>: {\n      <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;production&#x27;</span>,\n      <span class="hljs-attr">EGG_SERVER_ENV</span>: <span class="hljs-string">&#x27;prod&#x27;</span>,    <span class="hljs-comment">// Egg.js ä¸“ç”¨ç¯å¢ƒå˜é‡</span>\n    },\n\n    <span class="hljs-comment">// æ—¥å¿—é…ç½®</span>\n    <span class="hljs-attr">error_file</span>: <span class="hljs-string">&#x27;logs/err.log&#x27;</span>,  <span class="hljs-comment">// é”™è¯¯æ—¥å¿—è·¯å¾„</span>\n    <span class="hljs-attr">out_file</span>: <span class="hljs-string">&#x27;logs/out.log&#x27;</span>,    <span class="hljs-comment">// æ™®é€šæ—¥å¿—è·¯å¾„</span>\n    <span class="hljs-attr">merge_logs</span>: <span class="hljs-literal">true</span>,            <span class="hljs-comment">// é›†ç¾¤æ—¥å¿—åˆå¹¶</span>\n    <span class="hljs-attr">log_date_format</span>: <span class="hljs-string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>,\n  }]\n};\n</code></pre>\n<hr>\n<h3><strong>3. å¯åŠ¨é¡¹ç›®</strong></h3>\n<h4>(1) æ ‡å‡†å¯åŠ¨</h4>\n<pre><code class="language-sh">pm2 start ecosystem.config.js\n</code></pre>\n<h4>(2) ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ</h4>\n<pre><code class="language-sh"><span class="hljs-comment"># 1. å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆç¡®ä¿ node_modules çº¯å‡€ï¼‰</span>\nnpm install --production\n\n<span class="hljs-comment"># 2. å¯åŠ¨å¹¶ä¿å­˜é…ç½®ï¼ˆå¼€æœºè‡ªå¯ï¼‰</span>\npm2 start ecosystem.config.js\npm2 save\npm2 startup  <span class="hljs-comment"># ç”Ÿæˆç³»ç»ŸæœåŠ¡è„šæœ¬ï¼ˆéœ€ sudo æƒé™ï¼‰</span>\n</code></pre>\n<hr>\n<h3><strong>4. å¸¸ç”¨å‘½ä»¤</strong></h3>\n<table>\n<thead>\n<tr>\n<th>å‘½ä»¤</th>\n<th>ä½œç”¨</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>pm2 list</code></td>\n<td>æŸ¥çœ‹è¿è¡Œä¸­çš„åº”ç”¨</td>\n</tr>\n<tr>\n<td><code>pm2 logs egg-app</code></td>\n<td>æŸ¥çœ‹å®æ—¶æ—¥å¿—</td>\n</tr>\n<tr>\n<td><code>pm2 reload egg-app</code></td>\n<td>é›¶åœæœºé‡å¯ï¼ˆä¿æŒä¼šè¯ï¼‰</td>\n</tr>\n<tr>\n<td><code>pm2 restart egg-app</code></td>\n<td>ç¡¬é‡å¯</td>\n</tr>\n<tr>\n<td><code>pm2 delete egg-app</code></td>\n<td>åœæ­¢å¹¶åˆ é™¤åº”ç”¨</td>\n</tr>\n<tr>\n<td><code>pm2 monit</code></td>\n<td>ç›‘æ§å†…å­˜/CPU ä½¿ç”¨æƒ…å†µ</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3><strong>5. é«˜çº§é…ç½®</strong></h3>\n<h4>(1) ç¯å¢ƒéš”ç¦»</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// ecosystem.config.js</span>\n<span class="hljs-attr">env_production</span>: {\n  <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;production&#x27;</span>,\n  <span class="hljs-attr">DATABASE_URL</span>: <span class="hljs-string">&#x27;mysql://prod_user@localhost:3306/db&#x27;</span>\n},\n<span class="hljs-attr">env_staging</span>: {\n  <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;staging&#x27;</span>,\n  <span class="hljs-attr">DATABASE_URL</span>: <span class="hljs-string">&#x27;mysql://stage_user@localhost:3306/db&#x27;</span>\n}\n</code></pre>\n<p>å¯åŠ¨æ—¶æŒ‡å®šç¯å¢ƒï¼š</p>\n<pre><code class="language-sh">pm2 start ecosystem.config.js --<span class="hljs-built_in">env</span> production\n</code></pre>\n<h4>(2) æ—¥å¿—åˆ‡å‰²</h4>\n<p>å®‰è£…æ—¥å¿—åˆ‡å‰²æ’ä»¶ï¼š</p>\n<pre><code class="language-sh">pm2 install pm2-logrotate\npm2 <span class="hljs-built_in">set</span> pm2-logrotate:max_size 100M  <span class="hljs-comment"># å•æ–‡ä»¶æœ€å¤§ 100MB</span>\npm2 <span class="hljs-built_in">set</span> pm2-logrotate:retain 30      <span class="hljs-comment"># ä¿ç•™ 30 ä¸ªæ—¥å¿—æ–‡ä»¶</span>\n</code></pre>\n<hr>\n<h3><strong>6. æ€§èƒ½è°ƒä¼˜</strong></h3>\n<h4>(1) é›†ç¾¤è´Ÿè½½å‡è¡¡</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// ecosystem.config.js</span>\n<span class="hljs-attr">instances</span>: <span class="hljs-string">&#x27;max&#x27;</span>,  <span class="hljs-comment">// è‡ªåŠ¨ä½¿ç”¨å…¨éƒ¨ CPU æ ¸å¿ƒ</span>\n</code></pre>\n<h4>(2) å†…å­˜æ§åˆ¶</h4>\n<pre><code class="language-javascript"><span class="hljs-attr">max_memory_restart</span>: <span class="hljs-string">&#x27;800M&#x27;</span>,  <span class="hljs-comment">// å•å®ä¾‹å†…å­˜è¶… 800MB åˆ™é‡å¯</span>\n</code></pre>\n<hr>\n<h3><strong>7. å¸¸è§é—®é¢˜è§£å†³</strong></h3>\n<h4><strong>Q1: å¯åŠ¨åç«‹å³é€€å‡º</strong></h4>\n<ul>\n<li><strong>åŸå› </strong>  ï¼šä¾èµ–ç¼ºå¤±æˆ–ç¯å¢ƒå˜é‡æœªé…ç½®</li>\n<li><strong>æ’æŸ¥</strong>  ï¼š<pre><code class="language-sh">pm2 logs egg-app  <span class="hljs-comment"># æŸ¥çœ‹é”™è¯¯æ—¥å¿—</span>\nnpm <span class="hljs-built_in">ls</span> --production <span class="hljs-comment"># æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´</span>\n</code></pre>\n</li>\n</ul>\n<h4><strong>Q2: ç«¯å£å†²çª</strong></h4>\n<ul>\n<li><strong>è§£å†³</strong>  ï¼šä¿®æ”¹ Egg.js ç«¯å£é…ç½®<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">cluster</span> = {\n  <span class="hljs-attr">listen</span>: {\n    <span class="hljs-attr">port</span>: <span class="hljs-number">7002</span>, <span class="hljs-comment">// æ›´æ¢ç«¯å£</span>\n  }\n};\n</code></pre>\n</li>\n</ul>\n<h4><strong>Q3: é™æ€èµ„æº 404</strong></h4>\n<ul>\n<li><strong>è§£å†³</strong>  ï¼šç¡®ä¿ Nginx é…ç½®æ­£ç¡®ï¼ˆå¦‚ä½¿ç”¨åå‘ä»£ç†ï¼‰<pre><code class="language-nginx"><span class="hljs-section">location</span> /public/ {\n  <span class="hljs-attribute">alias</span> /path/to/egg-app/app/public/;\n}\n</code></pre>\n</li>\n</ul>\n<hr>\n<h3><strong>8. ç›‘æ§æ–¹æ¡ˆ</strong></h3>\n<h4>(1) å†…ç½®ç›‘æ§</h4>\n<pre><code class="language-sh">pm2 monit  <span class="hljs-comment"># å®æ—¶ä»ªè¡¨ç›˜</span>\n</code></pre>\n<h4>(2) Prometheus + Grafana</h4>\n<pre><code class="language-sh">npm install pm2-prom-exporter --save\n</code></pre>\n<p>é…ç½® PM2 æ¨¡å—ï¼š</p>\n<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">apps</span>: [{\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;egg-app&#x27;</span>,\n    <span class="hljs-comment">// ...å…¶ä»–é…ç½®</span>\n    <span class="hljs-attr">modules</span>: [<span class="hljs-string">&#x27;pm2-prom-exporter&#x27;</span>]\n  }]\n};\n</code></pre>\n<hr>\n<h3><strong>æ€»ç»“</strong></h3>\n<ul>\n<li><strong>ç®€å•é¡¹ç›®</strong>  ï¼šç›´æ¥ <code>egg-scripts start --daemon</code></li>\n<li><strong>ç”Ÿäº§ç¯å¢ƒ</strong>  ï¼šPM2 æä¾›å®Œæ•´çš„è¿›ç¨‹ç®¡ç†ã€æ—¥å¿—å’Œç›‘æ§èƒ½åŠ›</li>\n<li><strong>æœ€ä½³å®è·µ</strong>  ï¼š\n<ol>\n<li>ä½¿ç”¨é›†ç¾¤æ¨¡å¼ (<code>exec_mode: \'cluster\'</code>)</li>\n<li>é…ç½®æ—¥å¿—åˆ‡å‰²å’Œå†…å­˜é™åˆ¶</li>\n<li>é€šè¿‡ <code>pm2 save</code> + <code>pm2 startup</code> å®ç°æŒä¹…åŒ–</li>\n</ol>\n</li>\n</ul>\n<p>æŒ‰ç…§æ­¤æ–¹æ¡ˆéƒ¨ç½²ï¼Œä½ çš„ Egg.js 3.x åº”ç”¨å°†è·å¾—ä¼ä¸šçº§çš„ç¨³å®šæ€§å’Œå¯è§‚æµ‹æ€§ï¼ ğŸš€</p>\n</div>'</script></body></html>