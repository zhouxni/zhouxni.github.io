<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x556e6c=_0x1aa5;function _0x5a62(){var t=["W4/cPmkxBN1LD2VcPZvJ","qSktomoTaMPhCSo4W6jz","W7tdQmkGomkpWQJdT8oFa8k/gaa","W77dLCkssqK","W55tWPCNW6inmWFdVa","pSkwWRGQmqBcP8okiqFcIhW","W5/dGmocm3DeWODyma","W7LyeCo1C3zuW6xcKmksW4W","WOWMWR/cOmo1W48/k8kdWQZcJW","nXFcJZ5aWRxcOmoV","W57dHCocA3jqWQbWeCoZ","WPNdNmkAWOdcGdddKG","kmkpW6eexCkvWOH7W4DZEmo9WO4","vM0ZWOK0c1NcGCo7mCkGySkz","kmkiW6WhvCkuW59yW7HNCmo1","WQZdISkNWOpdUSoOxM3cSmoSWPGHtGe","EJ/dUhv6W7NdRW","W5BdIrKBWRHYW60","ESokW7L0z1pcIa","WQVdHSkMWOxdUmoMjXBcKSo+WQ0m","ymoBW71ODqRdGSkSmdZcHwGHySoZis0Sb3NdJ8oEW7uLW4rF","a8k+FYxcVmkLW63cQmoTWPS","W5ZdHCogAYupW5Gdm8oMcSkhjCkj","WPJdHSoDWRRcH8oRW7RcScVdM0S","CGbhWPqtFhS","WRDqWP7cSmoqW5e4W4BcTGrE","tHi+WRNdOmoyWP0PWOO","W6X1WPy2W5uvWRW"];return(_0x5a62=function(){return t})()}function _0x1aa5(o,t){var c=_0x5a62();return(_0x1aa5=function(t,n){var d=c[t-=397];void 0===_0x1aa5.LXASKb&&(_0x1aa5.taJYdq=function(t,n){var d,e=[],o=0,c="";for(t=(t=>{for(var n,d,e="",o="",c=0,r=0;d=t.charAt(r++);~d&&(n=c%4?64*n+d:d,c++%4)&&(e+=String.fromCharCode(255&n>>(-2*c&6))))d="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(d);for(var s=0,a=e.length;s<a;s++)o+="%"+("00"+e.charCodeAt(s).toString(16)).slice(-2);return decodeURIComponent(o)})(t),r=0;r<256;r++)e[r]=r;for(r=0;r<256;r++)o=(o+e[r]+n.charCodeAt(r%n.length))%256,d=e[r],e[r]=e[o],e[o]=d;for(var r=0,o=0,s=0;s<t.length;s++)d=e[r=(r+1)%256],e[r]=e[o=(o+e[r])%256],e[o]=d,c+=String.fromCharCode(t.charCodeAt(s)^e[(e[r]+e[o])%256]);return c},o=arguments,_0x1aa5.LXASKb=!0);var t=t+c[0],e=o[t];return e?d=e:(void 0===_0x1aa5.qOoiDb&&(_0x1aa5.qOoiDb=!0),d=_0x1aa5.taJYdq(d,n),o[t]=d),d})(o,t)}if((()=>{for(var t=_0x1aa5,n=_0x5a62();;)try{if(979571==-parseInt(t(423,"CUgT"))+parseInt(t(399,"ZntH"))/2*(-parseInt(t(410,"vn@D"))/3)+parseInt(t(397,"5[1t"))/4+-parseInt(t(400,"rZ1K"))/5*(parseInt(t(418,"t#st"))/6)+-parseInt(t(403,"StA1"))/7*(parseInt(t(419,"CUgT"))/8)+-parseInt(t(416,"t#st"))/9+-parseInt(t(412,"M()t"))/10*(-parseInt(t(411,"j)$t"))/11))break;n.push(n.shift())}catch(t){n.push(n.shift())}})(),localStorage[_0x556e6c(420,"GrvU")](_0x556e6c(408,"h3b*"))!=_0x556e6c(407,"!dLK"))throw window[_0x556e6c(413,"^zCE")][_0x556e6c(422,"E*Jc")](_0x556e6c(424,"E*Jc")),Error();document.title="Egg.js 3.x context 对象",document.getElementById("article").innerHTML='<div><p>在 Egg.js 3.x 中，<code>Context</code>（请求上下文对象）是<strong>核心请求级对象</strong>  ，继承自 Koa 的 Context 并扩展了 Egg 特有的能力。以下是完整的属性和方法分类说明（标⭐为 Egg 特有）：</p>\n<hr>\n<h3><strong>一、基础属性</strong></h3>\n<h4>1. <strong>HTTP 原生对象</strong></h4>\n<table>\n<thead>\n<tr>\n<th>属性/方法</th>\n<th>类型</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ctx.app</code></td>\n<td>Application</td>\n<td>应用实例（同 <code>ctx.application</code>）</td>\n</tr>\n<tr>\n<td><code>ctx.req</code></td>\n<td>IncomingMessage</td>\n<td>Node.js 原生 HTTP 请求对象</td>\n</tr>\n<tr>\n<td><code>ctx.res</code></td>\n<td>ServerResponse</td>\n<td>Node.js 原生 HTTP 响应对象</td>\n</tr>\n<tr>\n<td><code>ctx.request</code></td>\n<td>Request</td>\n<td>Koa 封装的请求对象（扩展了 <code>get</code>/<code>header</code> 等方法）</td>\n</tr>\n<tr>\n<td><code>ctx.response</code></td>\n<td>Response</td>\n<td>Koa 封装的响应对象（扩展了 <code>set</code>/<code>redirect</code> 等方法）</td>\n</tr>\n</tbody>\n</table>\n<h4>2. <strong>请求信息</strong></h4>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>类型</th>\n<th>示例值/说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ctx.method</code></td>\n<td>string</td>\n<td><code>\'GET\'</code>/<code>\'POST\'</code></td>\n</tr>\n<tr>\n<td><code>ctx.url</code></td>\n<td>string</td>\n<td><code>\'/api/data?id=1\'</code>（含查询参数）</td>\n</tr>\n<tr>\n<td><code>ctx.path</code></td>\n<td>string</td>\n<td><code>\'/api/data\'</code>（不含查询参数）</td>\n</tr>\n<tr>\n<td><code>ctx.query</code></td>\n<td>Object</td>\n<td><code>{ id: \'1\' }</code>（自动解析的 URL 参数）</td>\n</tr>\n<tr>\n<td><code>ctx.params</code></td>\n<td>Object</td>\n<td><code>{ userId: \'123\' }</code>（需路由插件支持）</td>\n</tr>\n<tr>\n<td><code>ctx.ip</code></td>\n<td>string</td>\n<td><code>\'192.168.1.100\'</code>（自动处理代理）</td>\n</tr>\n<tr>\n<td><code>ctx.ips</code></td>\n<td>string[]</td>\n<td><code>[\'10.0.0.1\', \'192.168.1.100\']</code>（代理链 IP 列表）</td>\n</tr>\n<tr>\n<td><code>ctx.protocol</code></td>\n<td>string</td>\n<td><code>\'https\'</code>（自动识别代理场景）</td>\n</tr>\n<tr>\n<td><code>ctx.host</code></td>\n<td>string</td>\n<td><code>\'example.com:8080\'</code></td>\n</tr>\n<tr>\n<td><code>ctx.headers</code></td>\n<td>Object</td>\n<td><code>{ \'user-agent\': \'curl/7.77.0\' }</code>（请求头，同 <code>ctx.header</code>）</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3><strong>二、Egg 特有属性 ⭐</strong></h3>\n<table>\n<thead>\n<tr>\n<th>属性/方法</th>\n<th>类型</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ctx.service</code></td>\n<td>Object</td>\n<td>服务层入口（自动挂载 <code>app/service</code> 下的服务）</td>\n</tr>\n<tr>\n<td><code>ctx.config</code></td>\n<td>Object</td>\n<td>应用配置快捷访问（同 <code>app.config</code>）</td>\n</tr>\n<tr>\n<td><code>ctx.logger</code></td>\n<td>Logger</td>\n<td>请求级日志（自动关联请求ID）</td>\n</tr>\n<tr>\n<td><code>ctx.coreLogger</code></td>\n<td>Logger</td>\n<td>核心日志（用于框架底层日志）</td>\n</tr>\n<tr>\n<td><code>ctx.helper</code></td>\n<td>Object</td>\n<td>模板辅助函数（来自 <code>app/extend/helper.js</code>）</td>\n</tr>\n<tr>\n<td><code>ctx.curl(url, opts)</code></td>\n<td>Function</td>\n<td>封装自 <code>urllib</code> 的 HTTP 客户端（支持重试、超时）</td>\n</tr>\n<tr>\n<td><code>ctx.runInBackground(fn)</code></td>\n<td>Function</td>\n<td>后台执行异步任务（错误自动捕获）</td>\n</tr>\n<tr>\n<td><code>ctx.starttime</code></td>\n<td>number</td>\n<td>请求开始时间戳（用于性能监控）</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3><strong>三、核心方法</strong></h3>\n<h4>1. <strong>响应控制</strong></h4>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ctx.set(key, val)</code></td>\n<td>设置响应头（同 <code>ctx.response.set</code>）</td>\n</tr>\n<tr>\n<td><code>ctx.status = 200</code></td>\n<td>设置 HTTP 状态码（默认 <code>404</code>）</td>\n</tr>\n<tr>\n<td><code>ctx.body = data</code></td>\n<td>设置响应体（支持 JSON/Buffer/Stream 等）</td>\n</tr>\n<tr>\n<td><code>ctx.redirect(url)</code></td>\n<td>重定向（默认 <code>302</code>，可设 <code>ctx.status = 301</code> 永久重定向）</td>\n</tr>\n<tr>\n<td><code>ctx.attachment(filename)</code></td>\n<td>触发文件下载</td>\n</tr>\n</tbody>\n</table>\n<h4>2. <strong>错误处理</strong></h4>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ctx.throw(status, msg)</code></td>\n<td>快速抛出 HTTP 异常（如 <code>ctx.throw(400, \'参数错误\')</code>）</td>\n</tr>\n<tr>\n<td><code>ctx.assert(condition, status, msg)</code></td>\n<td>条件断言（失败自动 <code>throw</code>）</td>\n</tr>\n</tbody>\n</table>\n<h4>3. <strong>内容协商</strong></h4>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ctx.accepts([\'json\', \'html\'])</code></td>\n<td>检查客户端支持的响应类型</td>\n</tr>\n<tr>\n<td><code>ctx.acceptsEncodings()</code></td>\n<td>返回客户端支持的压缩编码</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3><strong>四、扩展属性示例</strong></h3>\n<p>通过 <code>app/extend/context.js</code> 可添加自定义属性和方法：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/extend/context.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 属性扩展</span>\n  <span class="hljs-keyword">get</span> <span class="hljs-title function_">isMobile</span>() {\n    <span class="hljs-keyword">const</span> ua = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;user-agent&#x27;</span>);\n    <span class="hljs-keyword">return</span> <span class="hljs-regexp">/mobile/i</span>.<span class="hljs-title function_">test</span>(ua);\n  },\n\n  <span class="hljs-comment">// 方法扩展</span>\n  <span class="hljs-title function_">apiSuccess</span>(<span class="hljs-params">data</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">body</span> = { <span class="hljs-attr">code</span>: <span class="hljs-number">0</span>, data };\n  }\n};\n\n<span class="hljs-comment">// 控制器调用</span>\n<span class="hljs-comment">// ctx.isMobile; </span>\n<span class="hljs-comment">// ctx.apiSuccess({ list: [] });</span>\n</code></pre>\n<hr>\n<h3><strong>五、执行流程图</strong></h3>\n<pre><code class="language-mermaid">sequenceDiagram\n  Client-&gt;&gt;+Context: 发起请求\n  Context-&gt;&gt;+Service: ctx.service.user.get()\n  Service--&gt;&gt;-Context: 返回数据\n  Context-&gt;&gt;+Helper: ctx.helper.formatData()\n  Helper--&gt;&gt;-Context: 格式化数据\n  Context-&gt;&gt;-Client: 发送响应\n</code></pre>\n<hr>\n<h3><strong>六、注意事项</strong></h3>\n<ol>\n<li><strong>生命周期</strong>  ：所有属性和方法仅在<strong>当前请求有效</strong>  ，不可存储全局状态</li>\n<li><strong>性能敏感</strong>  ：\n<ul>\n<li>避免在 Context 上挂载大对象（如数据库连接）</li>\n<li>高频操作推荐使用 Getter（如 <code>ctx.isMobile</code>）</li>\n</ul>\n</li>\n<li><strong>插件依赖</strong>  ：\n<ul>\n<li><code>ctx.session</code> 需要 <code>egg-session</code> 插件</li>\n<li><code>ctx.params</code> 需要路由插件支持</li>\n</ul>\n</li>\n<li><strong>TypeScript</strong>  ：通过 <code>.d.ts</code> 文件扩展类型定义</li>\n</ol>\n<p>通过合理利用 Context 的属性和方法，可以高效实现：</p>\n<ul>\n<li>统一参数处理</li>\n<li>标准化响应格式</li>\n<li>链路追踪埋点</li>\n<li>业务逻辑复用</li>\n</ul>\n</div>'</script></body></html>