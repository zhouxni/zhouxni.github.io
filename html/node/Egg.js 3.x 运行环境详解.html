<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x231299=_0x30c2;if((()=>{for(var s=_0x30c2,n=_0x4f2f();;)try{if(510170==-parseInt(s(493,"ucuX"))+-parseInt(s(489,"fP6L"))/2+parseInt(s(471,"aHrb"))/3+parseInt(s(485,"s3js"))/4*(-parseInt(s(486,"ciTd"))/5)+parseInt(s(488,"wYPx"))/6*(parseInt(s(490,"yeNa"))/7)+parseInt(s(496,"FJrK"))/8+-parseInt(s(477,"gDeg"))/9*(-parseInt(s(479,"ZPU1"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x231299(483,"^#fK")](_0x231299(472,"$U#$"))!=_0x231299(484,"OBxT"))throw window[_0x231299(473,"yeNa")][_0x231299(474,"iGOP")](_0x231299(481,"iGOP")),Error();function _0x30c2(p,s){var c=_0x4f2f();return(_0x30c2=function(s,n){var a=c[s-=471];void 0===_0x30c2.LixHQx&&(_0x30c2.LTXLnN=function(s,n){var a,l=[],p=0,c="";for(s=(s=>{for(var n,a,l="",p="",c=0,e=0;a=s.charAt(e++);~a&&(n=c%4?64*n+a:a,c++%4)&&(l+=String.fromCharCode(255&n>>(-2*c&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var t=0,o=l.length;t<o;t++)p+="%"+("00"+l.charCodeAt(t).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+n.charCodeAt(e%n.length))%256,a=l[e],l[e]=l[p],l[p]=a;for(var e=0,p=0,t=0;t<s.length;t++)a=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=a,c+=String.fromCharCode(s.charCodeAt(t)^l[(l[e]+l[p])%256]);return c},p=arguments,_0x30c2.LixHQx=!0);var s=s+c[0],l=p[s];return l?a=l:(void 0===_0x30c2.FDwIZu&&(_0x30c2.FDwIZu=!0),a=_0x30c2.LTXLnN(a,n),p[s]=a),a})(p,s)}function _0x4f2f(){var s=["WQdcVSo8WOJdIgHTWRdcVmouW5VcHWq","jdFdVSovW6y5W7G","WR4xWOhdMLe","W6/cMSkkx8o7emkV","urBcHu7cMSoImmoXtt3dPmkXW6W","WQWrWQ5WmG1j","FSkcWPdcHmkLpmoxcmo6xui","W4RcHKydW5q1bfyhWOJdNSob","WRldUSoKh8oIofiMW6G","n2TWW6e3je0wwCkIW7u","W4LtFCkyfXZdRmo2fWf/W6pdIG","mCk0wGq4cL/cSmkUWReqW5q","jMZdMCk+WQPUWP8aWRurnmo1","cSodctujr8kLWRucW6Gs","WOhcGSoSn8oGvJFdGhanWOdcMsG","W6mMCw9PWRT1vaBdTCoXt8oq","WR9ii8oVWOW4WQlcSvu","W63cRmk+dSoKnwCQ","W6OYWQ1OhbL9","W6eME2CyW5ieustdSG","pSo7WP3dOCoOW5FdMdFdGHSPW7jq","mSkRW5RcNrfypSk/WQOD","pSo2WPpcOSkSWOpcTWtdUa","W7xdUIBcHSk9W7VdKSkHWOCwW7G","W6NdR8omhCkmuCkKW5hcKhRcTMW","W7aJWQL0dKa3WP/dNwddSKr/CZBcOCoAWQesxKtdMMavu0e"];return(_0x4f2f=function(){return s})()}document.title="Egg.js 3.x 运行环境详解",document.getElementById("article").innerHTML='<div><p>Egg.js 提供了完善的运行环境管理机制，让开发者能够轻松管理不同环境下的配置和行为。以下是 Egg.js 3.x 运行环境的全面解析。</p>\n<h2>1. 环境变量与运行环境</h2>\n<h3>核心环境变量</h3>\n<p>Egg.js 通过 <code>EGG_SERVER_ENV</code> 环境变量来区分不同运行环境：</p>\n<pre><code class="language-sh"><span class="hljs-comment"># 设置运行环境</span>\nEGG_SERVER_ENV=prod npm start\n</code></pre>\n<h3>标准环境类型</h3>\n<table>\n<thead>\n<tr>\n<th>环境变量值</th>\n<th>说明</th>\n<th>典型场景</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>local</code></td>\n<td>本地开发环境</td>\n<td>开发者本地机器</td>\n</tr>\n<tr>\n<td><code>test</code></td>\n<td>测试环境</td>\n<td>CI/CD 测试</td>\n</tr>\n<tr>\n<td><code>unittest</code></td>\n<td>单元测试环境</td>\n<td>执行单元测试</td>\n</tr>\n<tr>\n<td><code>prod</code></td>\n<td>生产环境</td>\n<td>线上正式环境</td>\n</tr>\n<tr>\n<td><code>pre</code></td>\n<td>预发布环境</td>\n<td>上线前验证</td>\n</tr>\n</tbody>\n</table>\n<h2>2. 环境检测与配置加载</h2>\n<h3>环境检测顺序</h3>\n<ol>\n<li>从 <code>EGG_SERVER_ENV</code> 环境变量获取</li>\n<li>如果未设置，尝试从 <code>NODE_ENV</code> 推断：\n<ul>\n<li><code>development</code> → <code>local</code></li>\n<li><code>test</code> → <code>unittest</code></li>\n<li><code>production</code> → <code>prod</code></li>\n</ul>\n</li>\n</ol>\n<h3>配置加载机制</h3>\n<p>Egg.js 会按以下顺序加载配置：</p>\n<ol>\n<li><code>config.default.js</code> - 基础默认配置</li>\n<li><code>config.{env}.js</code> - 环境特有配置</li>\n<li><code>config.local.js</code> - 本地开发覆盖配置</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 生产环境特有配置</span>\n  <span class="hljs-attr">logger</span>: {\n    <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;WARN&#x27;</span>\n  }\n};\n</code></pre>\n<h2>3. 运行环境 API</h2>\n<h3>应用实例中的环境信息</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在 middleware/controller/service 中</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app.<span class="hljs-property">config</span>.<span class="hljs-property">env</span>); <span class="hljs-comment">// 当前环境</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app.<span class="hljs-property">config</span>.<span class="hljs-property">isProd</span>); <span class="hljs-comment">// 是否生产环境</span>\n};\n</code></pre>\n<h3>环境判断方法</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 各种环境判断方式</span>\n<span class="hljs-keyword">if</span> (app.<span class="hljs-property">config</span>.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;local&#x27;</span>) {\n  <span class="hljs-comment">// 本地环境逻辑</span>\n}\n\n<span class="hljs-keyword">if</span> (app.<span class="hljs-property">config</span>.<span class="hljs-property">isProd</span>) {\n  <span class="hljs-comment">// 生产环境逻辑</span>\n}\n</code></pre>\n<h2>4. 多环境实践指南</h2>\n<h3>开发环境配置示例</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.local.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">const</span> config = {};\n  \n  <span class="hljs-comment">// 开发环境关闭 CSRF 校验</span>\n  config.<span class="hljs-property">security</span> = {\n    <span class="hljs-attr">csrf</span>: {\n      <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>\n    }\n  };\n  \n  <span class="hljs-comment">// 开发环境日志级别</span>\n  config.<span class="hljs-property">logger</span> = {\n    <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,\n    <span class="hljs-attr">consoleLevel</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>\n  };\n  \n  <span class="hljs-keyword">return</span> config;\n};\n</code></pre>\n<h3>生产环境配置示例</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.prod.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 生产环境关闭 egg-development 插件</span>\n  <span class="hljs-attr">development</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>\n  },\n  \n  <span class="hljs-comment">// 生产环境日志配置</span>\n  <span class="hljs-attr">logger</span>: {\n    <span class="hljs-attr">dir</span>: <span class="hljs-string">&#x27;/logs&#x27;</span>,\n    <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;INFO&#x27;</span>,\n    <span class="hljs-attr">consoleLevel</span>: <span class="hljs-string">&#x27;NONE&#x27;</span>\n  },\n  \n  <span class="hljs-comment">// 生产环境静态资源配置</span>\n  <span class="hljs-attr">static</span>: {\n    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>\n  }\n};\n</code></pre>\n<h2>5. 自定义环境实践</h2>\n<h3>创建自定义环境</h3>\n<ol>\n<li>设置环境变量：<pre><code class="language-sh">EGG_SERVER_ENV=pre npm start\n</code></pre>\n</li>\n<li>创建对应配置文件：<pre><code class="language-javascript"><span class="hljs-comment">// config/config.pre.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 预发环境特有配置</span>\n  <span class="hljs-attr">apiEndpoint</span>: <span class="hljs-string">&#x27;https://pre.api.example.com&#x27;</span>\n};\n</code></pre>\n</li>\n</ol>\n<h3>环境特定插件配置</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/plugin.js</span>\n<span class="hljs-built_in">exports</span>.<span class="hljs-property">myPlugin</span> = {\n  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n  <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-my-plugin&#x27;</span>,\n  <span class="hljs-attr">env</span>: [<span class="hljs-string">&#x27;prod&#x27;</span>, <span class="hljs-string">&#x27;pre&#x27;</span>] <span class="hljs-comment">// 只在生产和预发环境启用</span>\n};\n</code></pre>\n<h2>6. 环境相关工具方法</h2>\n<h3>获取当前环境</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { env } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(env); <span class="hljs-comment">// &#x27;local&#x27;/&#x27;test&#x27;/&#x27;prod&#x27; etc.</span>\n</code></pre>\n<h3>环境判断工具</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { isProd, isLocal, isTest } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>);\n\n<span class="hljs-keyword">if</span> (isProd) {\n  <span class="hljs-comment">// 生产环境逻辑</span>\n}\n</code></pre>\n<h2>7. 最佳实践建议</h2>\n<ol>\n<li><strong>配置管理原则</strong>  ：\n<ul>\n<li>将敏感信息放在环境变量中</li>\n<li>不同环境的差异尽量通过配置而非代码实现</li>\n<li>保持 <code>config.default.js</code> 的完整性</li>\n</ul>\n</li>\n<li><strong>环境特定代码处理</strong>  ：<pre><code class="language-javascript"><span class="hljs-comment">// 不推荐</span>\n<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span>) {\n  <span class="hljs-comment">// 开发环境代码</span>\n}\n\n<span class="hljs-comment">// 推荐（使用 Egg.js 提供的方法）</span>\n<span class="hljs-keyword">if</span> (app.<span class="hljs-property">config</span>.<span class="hljs-property">isLocal</span>) {\n  <span class="hljs-comment">// 本地环境代码</span>\n}\n</code></pre>\n</li>\n<li><strong>部署实践</strong>  ：\n<ul>\n<li>使用 <code>EGG_SERVER_ENV=prod</code> 启动生产环境</li>\n<li>预发环境使用 <code>EGG_SERVER_ENV=pre</code></li>\n<li>测试环境使用 <code>EGG_SERVER_ENV=test</code></li>\n</ul>\n</li>\n<li><strong>日志管理</strong>  ：\n<ul>\n<li>开发环境输出到控制台</li>\n<li>生产环境写入日志文件并设置合理的轮转策略</li>\n</ul>\n</li>\n</ol>\n<p>通过合理利用 Egg.js 的运行环境管理机制，可以显著提高应用的可维护性和部署灵活性，确保不同环境下的行为符合预期。</p>\n</div>'</script></body></html>