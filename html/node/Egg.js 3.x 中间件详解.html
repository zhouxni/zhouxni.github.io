<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x24bbab=_0x4295;function _0x4295(l,s){var t=_0x1768();return(_0x4295=function(s,n){var a=t[s-=178];void 0===_0x4295.GKwRta&&(_0x4295.MLviBP=function(s,n){var a,p=[],l=0,t="";for(s=(s=>{for(var n,a,p="",l="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(p+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,r=p.length;c<r;c++)l+="%"+("00"+p.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(l)})(s),e=0;e<256;e++)p[e]=e;for(e=0;e<256;e++)l=(l+p[e]+n.charCodeAt(e%n.length))%256,a=p[e],p[e]=p[l],p[l]=a;for(var e=0,l=0,c=0;c<s.length;c++)a=p[e=(e+1)%256],p[e]=p[l=(l+p[e])%256],p[l]=a,t+=String.fromCharCode(s.charCodeAt(c)^p[(p[e]+p[l])%256]);return t},l=arguments,_0x4295.GKwRta=!0);var s=s+t[0],p=l[s];return p?a=p:(void 0===_0x4295.petmFl&&(_0x4295.petmFl=!0),a=_0x4295.MLviBP(a,n),l[s]=a),a})(l,s)}function _0x1768(){var s=["WOG6pK4sFbFcVa","BSkJW4VdTmktWPtdLa","oSoGBZZcI8kTW6b3WOGPW6rVWQm","WRhdUcq1itagFqO","v8krWOmVkGFcUq","WPJdRZmGixLInWLsm2hdSmkjWQ/dGConW5JdOCoBWPtcLW5xvSo4","E8koWQ9Iae0OpKKhWRfw","WR3cM8olW7bRWOqI","umoEW5XlyxJdMJRcVHNcI8knwW","eG0rWPddSvn6z1JdOConANG","fCoXW6nyo8oPW7W6nCoU","v8orW55nz3NdNIlcGXdcRCk3wG","W7NdOW4poSoFWRdcPc1LW4KFW60","j24lWRVdSCoKnmo3W49KvaBcIq","ESkjW5HcDmoFtG","y8knW6fEvq9BW7/cMSkJCMW","cSkEW5riAxRdLmoHWRXa","W6y9xCoCuX7dL8o2","WPVcLKdcQmo6WQzZoq","lSouWP88nCkof8o5bSkjW5tdTXq","WO4gWPBdNsZcRGVdUwtcJ8kl","mSk7W4ePW70","iSkStfu5W7xcNe05qCorW7HT","W4pcQx5Pyxf9xbXVl3pdKa","W6H1g8oxW79IWRJdL8kdfd4","W7/dRqChmCozWRdcTrH+W6KPW5a"];return(_0x1768=function(){return s})()}if((()=>{for(var s=_0x4295,n=_0x1768();;)try{if(808668==+parseInt(s(200,"r&cC"))+-parseInt(s(180,"um^G"))/2*(-parseInt(s(195,"HU^X"))/3)+-parseInt(s(184,"v)Gc"))/4+parseInt(s(190,"zna4"))/5+-parseInt(s(203,"zna4"))/6*(parseInt(s(183,"PH*9"))/7)+parseInt(s(185,"1LT["))/8*(parseInt(s(201,"oBn!"))/9)+-parseInt(s(188,"!kNK"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x24bbab(179,"v)Gc")](_0x24bbab(194,"!kNK"))!=_0x24bbab(186,"bI2!"))throw window[_0x24bbab(182,"%&ta")][_0x24bbab(198,"qL[o")](_0x24bbab(196,"!kNK")),Error();document.title="Egg.js 3.x 中间件详解",document.getElementById("article").innerHTML='<div><p>Egg.js 的中间件是基于 Koa 的中间件机制实现的，提供了更强大的封装和配置能力。以下是 Egg.js 中间件的全面解析。</p>\n<h2>1. 中间件基础</h2>\n<h3>中间件执行顺序</h3>\n<p>Egg.js 中间件按照<strong>洋葱圈模型</strong>  执行，顺序如下：</p>\n<pre><code>请求 -&gt; 中间件1 -&gt; 中间件2 -&gt; ... -&gt; 控制器 -&gt; ... -&gt; 中间件2 -&gt; 中间件1 -&gt; 响应\n</code></pre>\n<h3>中间件目录结构</h3>\n<pre><code>app\n├── middleware          # 中间件目录\n│   ├── error_handler.js\n│   ├── request_logger.js\n│   └── auth.js\n└── router.js\n</code></pre>\n<h2>2. 编写自定义中间件</h2>\n<h3>基本中间件示例</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/request_logger.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[Request Start] <span class="hljs-subst">${ctx.method}</span> <span class="hljs-subst">${ctx.url}</span>`</span>);\n    \n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 执行后续中间件</span>\n    \n    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;\n    app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[Request End] <span class="hljs-subst">${ctx.method}</span> <span class="hljs-subst">${ctx.url}</span> <span class="hljs-subst">${duration}</span>ms`</span>);\n  };\n};\n</code></pre>\n<h3>带配置的中间件</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/auth.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">const</span> token = ctx.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;authorization&#x27;</span>];\n    \n    <span class="hljs-comment">// 验证token</span>\n    <span class="hljs-keyword">if</span> (!options.<span class="hljs-title function_">ignore</span>(ctx) &amp;&amp; !token) {\n      ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">401</span>, <span class="hljs-string">&#x27;Unauthorized&#x27;</span>);\n    }\n    \n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  };\n};\n</code></pre>\n<h2>3. 中间件配置与使用</h2>\n<h3>全局启用中间件</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">middleware</span>: [<span class="hljs-string">&#x27;errorHandler&#x27;</span>, <span class="hljs-string">&#x27;requestLogger&#x27;</span>],\n  \n  <span class="hljs-comment">// 中间件配置</span>\n  <span class="hljs-attr">requestLogger</span>: {\n    <span class="hljs-attr">ignore</span>: [<span class="hljs-string">&#x27;/healthcheck&#x27;</span>]\n  }\n};\n</code></pre>\n<h3>路由级中间件</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/router.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {\n  <span class="hljs-keyword">const</span> { router, middleware } = app;\n  \n  <span class="hljs-comment">// 单个路由使用</span>\n  router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>, middleware.<span class="hljs-title function_">auth</span>(), <span class="hljs-string">&#x27;admin.index&#x27;</span>);\n  \n  <span class="hljs-comment">// 路由分组使用</span>\n  <span class="hljs-keyword">const</span> auth = middleware.<span class="hljs-title function_">auth</span>({ <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> });\n  router.<span class="hljs-title function_">group</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-attr">prefix</span>: <span class="hljs-string">&#x27;/admin&#x27;</span> }, <span class="hljs-function"><span class="hljs-params">router</span> =&gt;</span> {\n    router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, auth, <span class="hljs-string">&#x27;admin.users&#x27;</span>);\n    router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/settings&#x27;</span>, auth, <span class="hljs-string">&#x27;admin.settings&#x27;</span>);\n  });\n};\n</code></pre>\n<h2>4. 框架内置中间件</h2>\n<h3>常用内置中间件</h3>\n<table>\n<thead>\n<tr>\n<th>中间件</th>\n<th>作用</th>\n<th>配置</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>meta</code></td>\n<td>添加一些元信息</td>\n<td><code>config.meta</code></td>\n</tr>\n<tr>\n<td><code>siteFile</code></td>\n<td>静态站点文件</td>\n<td><code>config.siteFile</code></td>\n</tr>\n<tr>\n<td><code>notfound</code></td>\n<td>404处理</td>\n<td><code>config.notfound</code></td>\n</tr>\n<tr>\n<td><code>bodyParser</code></td>\n<td>请求体解析</td>\n<td><code>config.bodyParser</code></td>\n</tr>\n<tr>\n<td><code>session</code></td>\n<td>Session管理</td>\n<td><code>config.session</code></td>\n</tr>\n<tr>\n<td><code>security</code></td>\n<td>安全防护</td>\n<td><code>config.security</code></td>\n</tr>\n</tbody>\n</table>\n<h3>安全中间件配置示例</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// config/config.default.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">security</span>: {\n    <span class="hljs-attr">csrf</span>: {\n      <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">ignoreJSON</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">cookieName</span>: <span class="hljs-string">&#x27;csrfToken&#x27;</span>,\n      <span class="hljs-attr">sessionName</span>: <span class="hljs-string">&#x27;csrfToken&#x27;</span>,\n      <span class="hljs-attr">headerName</span>: <span class="hljs-string">&#x27;x-csrf-token&#x27;</span>\n    },\n    <span class="hljs-attr">xframe</span>: {\n      <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,\n      <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;SAMEORIGIN&#x27;</span>\n    }\n  }\n};\n</code></pre>\n<h2>5. 中间件高级用法</h2>\n<h3>中间件依赖注入</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/db_query.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">{ modelName }, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    ctx.<span class="hljs-property">model</span> = app.<span class="hljs-property">model</span>[modelName];\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  };\n};\n\n<span class="hljs-comment">// 使用</span>\nrouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, middleware.<span class="hljs-title function_">db_query</span>({ <span class="hljs-attr">modelName</span>: <span class="hljs-string">&#x27;User&#x27;</span> }), <span class="hljs-string">&#x27;user.list&#x27;</span>);\n</code></pre>\n<h3>中间件条件执行</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/conditional.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">if</span> (options.<span class="hljs-title function_">filter</span>(ctx)) {\n      <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n    } <span class="hljs-keyword">else</span> {\n      ctx.<span class="hljs-title function_">redirect</span>(options.<span class="hljs-property">redirectTo</span>);\n    }\n  };\n};\n</code></pre>\n<h2>6. 中间件最佳实践</h2>\n<h3>错误处理中间件</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/error_handler.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n    } <span class="hljs-keyword">catch</span> (err) {\n      app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(err);\n      \n      ctx.<span class="hljs-property">status</span> = err.<span class="hljs-property">status</span> || <span class="hljs-number">500</span>;\n      ctx.<span class="hljs-property">body</span> = {\n        <span class="hljs-attr">code</span>: err.<span class="hljs-property">code</span> || <span class="hljs-string">&#x27;INTERNAL_ERROR&#x27;</span>,\n        <span class="hljs-attr">message</span>: options.<span class="hljs-property">hideProdError</span> &amp;&amp; ctx.<span class="hljs-property">app</span>.<span class="hljs-property">config</span>.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;prod&#x27;</span> \n          ? <span class="hljs-string">&#x27;Internal Server Error&#x27;</span> \n          : err.<span class="hljs-property">message</span>\n      };\n    }\n  };\n};\n</code></pre>\n<h3>性能监控中间件</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/performance.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">options, app</span>) =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">const</span> start = process.<span class="hljs-title function_">hrtime</span>();\n    \n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n    \n    <span class="hljs-keyword">const</span> diff = process.<span class="hljs-title function_">hrtime</span>(start);\n    <span class="hljs-keyword">const</span> duration = diff[<span class="hljs-number">0</span>] * <span class="hljs-number">1e3</span> + diff[<span class="hljs-number">1</span>] * <span class="hljs-number">1e-6</span>; <span class="hljs-comment">// 毫秒</span>\n    \n    <span class="hljs-keyword">if</span> (duration &gt; options.<span class="hljs-property">slowThreshold</span>) {\n      app.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Slow request: <span class="hljs-subst">${ctx.method}</span> <span class="hljs-subst">${ctx.url}</span> (<span class="hljs-subst">${duration.toFixed(<span class="hljs-number">2</span>)}</span>ms)`</span>);\n    }\n    \n    ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;X-Response-Time&#x27;</span>, <span class="hljs-string">`<span class="hljs-subst">${duration.toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>);\n  };\n};\n</code></pre>\n<h2>7. 常见问题解决</h2>\n<h3>中间件执行顺序问题</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 调整中间件顺序</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">middleware</span>: [<span class="hljs-string">&#x27;performance&#x27;</span>, <span class="hljs-string">&#x27;errorHandler&#x27;</span>, <span class="hljs-string">&#x27;auth&#x27;</span>],\n};\n</code></pre>\n<h3>中间件冲突处理</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 禁用内置中间件</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">bodyParser</span>: {\n    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>\n  }\n};\n</code></pre>\n<h3>异步中间件初始化</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/async_init.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">async</span> (options, app) =&gt; {\n  <span class="hljs-comment">// 异步初始化</span>\n  <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">await</span> <span class="hljs-title function_">initSomeClient</span>();\n  \n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    ctx.<span class="hljs-property">client</span> = client;\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  };\n};\n</code></pre>\n<p>通过合理使用中间件，可以在 Egg.js 中实现各种横切关注点(Cross-Cutting Concerns)，如日志记录、权限控制、性能监控等，保持业务代码的简洁和可维护性。</p>\n</div>'</script></body></html>