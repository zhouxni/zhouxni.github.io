<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x4a3609=_0x302f;function _0x302f(l,s){var t=_0x39f2();return(_0x302f=function(s,n){var a=t[s-=115];void 0===_0x302f.oXLzgE&&(_0x302f.OWcfXh=function(s,n){var a,p=[],l=0,t="";for(s=(s=>{for(var n,a,p="",l="",t=0,e=0;a=s.charAt(e++);~a&&(n=t%4?64*n+a:a,t++%4)&&(p+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,r=p.length;c<r;c++)l+="%"+("00"+p.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(l)})(s),e=0;e<256;e++)p[e]=e;for(e=0;e<256;e++)l=(l+p[e]+n.charCodeAt(e%n.length))%256,a=p[e],p[e]=p[l],p[l]=a;for(var e=0,l=0,c=0;c<s.length;c++)a=p[e=(e+1)%256],p[e]=p[l=(l+p[e])%256],p[l]=a,t+=String.fromCharCode(s.charCodeAt(c)^p[(p[e]+p[l])%256]);return t},l=arguments,_0x302f.oXLzgE=!0);var s=s+t[0],p=l[s];return p?a=p:(void 0===_0x302f.ouwLkK&&(_0x302f.ouwLkK=!0),a=_0x302f.OWcfXh(a,n),l[s]=a),a})(l,s)}if((()=>{for(var s=_0x302f,n=_0x39f2();;)try{if(278917==-parseInt(s(116,"5E&7"))+-parseInt(s(127,"vk#g"))/2*(parseInt(s(121,"@ivH"))/3)+parseInt(s(139,"Vg3)"))/4+parseInt(s(141,")V4f"))/5*(parseInt(s(125,"6A6X"))/6)+-parseInt(s(120,"i0Bc"))/7*(-parseInt(s(124,"AENI"))/8)+-parseInt(s(129,"yMDC"))/9*(parseInt(s(117,"ZaxI"))/10)+parseInt(s(137,"boaS"))/11)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x4a3609(131,"i0Bc")](_0x4a3609(126,"e6yU"))!=_0x4a3609(142,"esUi"))throw window[_0x4a3609(132,"pvOY")][_0x4a3609(130,"ZaxI")](_0x4a3609(133,"esUi")),Error();function _0x39f2(){var s=["x8k5WRWVcCklWRRdI8kl","WPaZlKLTySo/oxz4","nM0uWRCG","W73dR15/oxfyWRvrWR0GgG","yNRdIq40uZr+eSk/WOzj","EmoIDCoGyHyKW7xdT8o+EMddOq","W4JdKCooduhdG8oyW7NcImoPW5r4","dGDkW7dcKXFdUSo7W6vApCk/","W4ddKCodcuNdISowW53cJCo9W75H","W7CLFSkjE8k2kmo4WQXBWQFcHa","W4O3iN01yMldPSoagSkbWPBcUG","WOD8FmkfW4ZcOWlcVHW","WRhcLtNdLuVdOwpcU8k1","bWvnWPpdS2ldM8oSW4q","l0pdVCkfW4XVqWVdIG","WQJdJ8k9tCoNW4pdKG","WRldIhNdRxldMh8","W4RdNYxdICoPWO16","omk0pCk/mK1X","WPBcG8kcDqxcNSoz","cmoWWRtcGmk+WO07mq","lMWtWRqQW7ZdTSkTW5D4dMZcUCkPWORdGZymwKNdTSkrW5bBWO7cTG","ldtcSNDGsSkCW6yatrvK","WOddNb1IW6VcPhVcLSo0ta","WP0sW5GdWP5wu3VdJ1NdJmofWOK","WOBdV8o0md1sWQPXDH94d8o2","DfGSWO0JW5ddNG","AmodbqdcMfZdHqDmCNrx"];return(_0x39f2=function(){return s})()}document.title="Egg.js 3.x 框架扩展",document.getElementById("article").innerHTML='<div><p>在 Egg.js 3.x 中，<strong>框架扩展</strong>  是深度定制框架能力的核心机制，允许开发者通过原型链扩展或混入模式增强内置对象的功能。以下是完整的扩展指南和实战技巧：</p>\n<hr>\n<h3>一、扩展类型与实现方式</h3>\n<p>Egg.js 提供 <strong>5 种标准扩展点</strong>  ，文件需放在 <code>app/extend</code> 目录下：</p>\n<table>\n<thead>\n<tr>\n<th>扩展类型</th>\n<th>文件命名规则</th>\n<th>作用域</th>\n<th>典型应用场景</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Application</td>\n<td><code>application.js</code></td>\n<td><code>app</code> 对象</td>\n<td>挂载全局工具方法、覆盖 Koa 原型</td>\n</tr>\n<tr>\n<td>Context</td>\n<td><code>context.js</code></td>\n<td><code>ctx</code> 对象</td>\n<td>添加请求级工具方法</td>\n</tr>\n<tr>\n<td>Request</td>\n<td><code>request.js</code></td>\n<td><code>ctx.request</code></td>\n<td>扩展 HTTP 请求相关能力</td>\n</tr>\n<tr>\n<td>Response</td>\n<td><code>response.js</code></td>\n<td><code>ctx.response</code></td>\n<td>扩展 HTTP 响应相关能力</td>\n</tr>\n<tr>\n<td>Helper</td>\n<td><code>helper.js</code></td>\n<td><code>ctx.helper</code></td>\n<td>复用模板工具函数</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h3>二、扩展实战示例</h3>\n<h4>1. <strong>Application 扩展</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/extend/application.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 添加全局缓存方法</span>\n  <span class="hljs-attr">cache</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),\n\n  <span class="hljs-comment">// 覆盖 Koa 的 listen 方法</span>\n  <span class="hljs-title function_">listen</span>(<span class="hljs-params">...args</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server启动于&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_listen</span>(...args); <span class="hljs-comment">// 调用原始方法</span>\n  }\n};\n\n<span class="hljs-comment">// 使用场景</span>\n<span class="hljs-comment">// app.js 中通过 this.app.cache 访问</span>\n</code></pre>\n<h4>2. <strong>Context 扩展</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/extend/context.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 快速获取用户 IP（兼容代理场景）</span>\n  <span class="hljs-keyword">get</span> <span class="hljs-title function_">ip</span>() {\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ips</span>.<span class="hljs-property">length</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">ips</span>[<span class="hljs-number">0</span>] : <span class="hljs-variable language_">this</span>.<span class="hljs-property">ip</span>;\n  },\n\n  <span class="hljs-comment">// 封装统一响应格式</span>\n  <span class="hljs-title function_">apiSuccess</span>(<span class="hljs-params">data</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">body</span> = { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, data };\n  }\n};\n\n<span class="hljs-comment">// 控制器调用</span>\n<span class="hljs-comment">// ctx.apiSuccess({ list: [] });</span>\n</code></pre>\n<h4>3. <strong>Request 扩展</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/extend/request.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 增强 GET 参数解析</span>\n  <span class="hljs-keyword">get</span> <span class="hljs-title function_">pagination</span>() {\n    <span class="hljs-keyword">return</span> {\n      <span class="hljs-attr">page</span>: <span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>.<span class="hljs-property">page</span>) || <span class="hljs-number">1</span>,\n      <span class="hljs-attr">size</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>.<span class="hljs-property">size</span>) || <span class="hljs-number">10</span>, <span class="hljs-number">100</span>)\n    };\n  }\n};\n\n<span class="hljs-comment">// 使用方式</span>\n<span class="hljs-comment">// const { page, size } = ctx.request.pagination;</span>\n</code></pre>\n<h4>4. <strong>Helper 扩展</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/extend/helper.js</span>\n<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 生成加密签名</span>\n  <span class="hljs-title function_">sign</span>(<span class="hljs-params">text</span>) {\n    <span class="hljs-keyword">return</span> crypto\n      .<span class="hljs-title function_">createHash</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>)\n      .<span class="hljs-title function_">update</span>(text + <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">config</span>.<span class="hljs-property">secret</span>)\n      .<span class="hljs-title function_">digest</span>(<span class="hljs-string">&#x27;hex&#x27;</span>);\n  }\n};\n\n<span class="hljs-comment">// 模板中使用</span>\n<span class="hljs-comment">// {{ helper.sign(&#x27;data&#x27;) }}</span>\n</code></pre>\n<hr>\n<h3>三、高级扩展技巧</h3>\n<h4>1. <strong>原型链继承覆盖</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// 覆盖 Koa 的 toJSON 方法</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-title function_">toJSON</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">return</span> { \n      <span class="hljs-attr">custom</span>: <span class="hljs-string">&#x27;data&#x27;</span>,\n      <span class="hljs-comment">// 保留原方法属性</span>\n      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_toJSON</span>() \n    };\n  }\n};\n</code></pre>\n<h4>2. <strong>Symbol 属性扩展</strong></h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// 避免属性名冲突</span>\n<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">USER_SYMBOL</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;Context#user&#x27;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-keyword">get</span> <span class="hljs-title function_">user</span>() {\n    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>[<span class="hljs-variable constant_">USER_SYMBOL</span>]) {\n      <span class="hljs-variable language_">this</span>[<span class="hljs-variable constant_">USER_SYMBOL</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">service</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">getCurrent</span>();\n    }\n    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[<span class="hljs-variable constant_">USER_SYMBOL</span>];\n  }\n};\n</code></pre>\n<h4>3. <strong>TypeScript 支持</strong></h4>\n<pre><code class="language-typescript"><span class="hljs-comment">// typings/app/extend/context.d.ts</span>\n<span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;egg&#x27;</span>;\n\n<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;egg&#x27;</span> {\n  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Context</span> {\n    <span class="hljs-attr">apiSuccess</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;\n    <span class="hljs-attr">ip</span>: <span class="hljs-built_in">string</span>;\n  }\n}\n</code></pre>\n<hr>\n<h3>四、扩展执行顺序与优先级</h3>\n<ol>\n<li><strong>加载顺序</strong><br>\n<code>框架扩展</code> → <code>插件扩展</code> → <code>应用扩展</code>（后者覆盖前者）</li>\n<li><strong>最佳实践</strong>\n<ul>\n<li>避免在扩展中执行耗时操作</li>\n<li>优先使用 Symbol 避免属性污染</li>\n<li>通过 <code>app.config.env</code> 区分环境行为</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3>五、调试与注意事项</h3>\n<h4>1. 查看扩展结果</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// 启动时打印扩展方法</span>\napp.<span class="hljs-title function_">beforeStart</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;扩展方法:&#x27;</span>, <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(app));\n});\n</code></pre>\n<h4>2. 常见问题</h4>\n<ul>\n<li><strong>属性冲突</strong>  ：使用 <code>Object.getOwnPropertyDescriptor()</code> 检查现有属性</li>\n<li><strong>循环引用</strong>  ：避免在扩展中直接 require 控制器</li>\n<li><strong>性能影响</strong>  ：Getter 比方法调用更适合高频操作</li>\n</ul>\n<hr>\n<h3>六、实战案例：JWT 鉴权扩展</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/extend/context.js</span>\n<span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>);\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-comment">// 生成 Token</span>\n  <span class="hljs-title function_">generateToken</span>(<span class="hljs-params">payload</span>) {\n    <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">sign</span>(\n      payload, \n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">config</span>.<span class="hljs-property">jwt</span>.<span class="hljs-property">secret</span>,\n      { <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&#x27;2h&#x27;</span> }\n    );\n  },\n\n  <span class="hljs-comment">// 验证 Token</span>\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">verifyToken</span>(<span class="hljs-params">token</span>) {\n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> jwt.<span class="hljs-title function_">verify</span>(token, <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">config</span>.<span class="hljs-property">jwt</span>.<span class="hljs-property">secret</span>);\n    } <span class="hljs-keyword">catch</span> (e) {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-keyword">throw</span>(<span class="hljs-number">401</span>, <span class="hljs-string">&#x27;无效令牌&#x27;</span>);\n    }\n  }\n};\n\n<span class="hljs-comment">// 控制器调用</span>\n<span class="hljs-comment">// const token = ctx.generateToken({ userId: 123 });</span>\n</code></pre>\n<p>通过合理使用框架扩展，可以实现：</p>\n<ul>\n<li>减少重复代码</li>\n<li>统一业务规范</li>\n<li>深度定制框架行为</li>\n</ul>\n<p>建议结合 Egg.js 的<a href="https://eggjs.org/zh-cn/basics/plugin.html" target="_blank">插件机制</a>实现更复杂的扩展需求。</p>\n</div>'</script></body></html>