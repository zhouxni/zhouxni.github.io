<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x3979ea=_0x4041;function _0x27d2(){var s=["l8o3lfxdMfWdWO7dOtj4ruC","uW/cPNZcQCkRx0q+hXGqW5C","WQ0xzmkOW43cSCoNW5pdHa","Fmk2WP/dScPXkmkdWQy0pSoeiJK","W7FcS1FdIbjofmoRWPHW","Emk2WPBdVsnYlCo3WQ0OlSogla","CSoNWP7cS8kimx9nnCkIBCk6W73cHmodhmkbgSksEwZdJgNdMCkOWOC","pMZcNSoHWRVcNmo7lSoHWOe","Cmk2y24PW6xcU8khWQCbWPNcHCos","WQjFWONcQSk5W6tcTq","rL3cRCoNBCole8oAW58","W5xdGmkNW4flWRScaCkNB3K","W5apW47cR8kIWPKM","fXBcRWRcN8kUW7pdNq","twn2uSo0lmkT","W5hdGSo7WRmBWRiZfW","C8kZatb2WQNdO8kb","xCkqW7BdSWddP8kYqCkHeNO","suBcSLWvW61ZWQJdNhDvrXq6","WQLYk8o6q8odWRldUI0","AHFdNJpdSSkOWReCW4PZz8kUFW","WQ/dHG/cL0aQWPu","WOrSESo8d10iW74","wSktW7FdVqZcJ8o9tCkIk3Gtiq","F8kYW4pcN1WpsCoC","WQ3cLvNdHI18W4XLyWBcSeNdJa","W43cUMbazSk0qG","gt7dPLpcNtyG","ESoSpgOgW7FcIsfQW6BdM0rA","WQ3dRGhcMX9MfSoe","WPdcHSoHWOOk","ow/dGSkzWQRcJmoqlq"];return(_0x27d2=function(){return s})()}function _0x4041(l,s){var t=_0x27d2();return(_0x4041=function(s,n){var a=t[s-=327];void 0===_0x4041.yZRaBY&&(_0x4041.fyCoIe=function(s,n){var a,p=[],l=0,t="";for(s=(s=>{for(var n,a,p="",l="",t=0,c=0;a=s.charAt(c++);~a&&(n=t%4?64*n+a:a,t++%4)&&(p+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,o=p.length;e<o;e++)l+="%"+("00"+p.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)p[c]=c;for(c=0;c<256;c++)l=(l+p[c]+n.charCodeAt(c%n.length))%256,a=p[c],p[c]=p[l],p[l]=a;for(var c=0,l=0,e=0;e<s.length;e++)a=p[c=(c+1)%256],p[c]=p[l=(l+p[c])%256],p[l]=a,t+=String.fromCharCode(s.charCodeAt(e)^p[(p[c]+p[l])%256]);return t},l=arguments,_0x4041.yZRaBY=!0);var s=s+t[0],p=l[s];return p?a=p:(void 0===_0x4041.KAAsIH&&(_0x4041.KAAsIH=!0),a=_0x4041.fyCoIe(a,n),l[s]=a),a})(l,s)}if((()=>{for(var s=_0x4041,n=_0x27d2();;)try{if(893715==-parseInt(s(356,"Y04Y"))*(-parseInt(s(350,"[nus"))/2)+parseInt(s(347,"Rl4l"))/3+-parseInt(s(331,"%Qe9"))/4*(-parseInt(s(338,"72Bu"))/5)+-parseInt(s(342,"]C3X"))/6*(-parseInt(s(335,"FQCh"))/7)+-parseInt(s(349,"72Bu"))/8*(parseInt(s(340,"WUTg"))/9)+-parseInt(s(351,"72Bu"))/10*(parseInt(s(345,"I6Fn"))/11)+parseInt(s(337,"%Qe9"))/12*(parseInt(s(330,"hf$6"))/13))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x3979ea(341,"cUbl")](_0x3979ea(348,"l$zN"))!=_0x3979ea(344,"HeCm"))throw window[_0x3979ea(343,"[nus")][_0x3979ea(355,"EGls")](_0x3979ea(352,"j8tb")),Error();document.title="Koa 路由详解",document.getElementById("article").innerHTML='<div><p>Koa 本身是一个<strong>极简的框架</strong>  ，不包含内置的路由系统。开发者需要借助第三方库（如 <code>@koa/router</code> 或 <code>koa-route</code>）来实现路由功能。以下是 Koa 路由的完整指南，涵盖基本用法、动态路由、嵌套路由、中间件控制等核心内容。</p>\n<hr>\n<h2><strong>1. 安装路由库</strong></h2>\n<p>推荐使用 <strong><code>@koa/router</code></strong>  （官方维护，功能最全）：</p>\n<pre><code class="language-sh">npm install @koa/router\n</code></pre>\n<hr>\n<h2><strong>2. 基础路由示例</strong></h2>\n<h3><strong>（1）基本 GET/POST 路由</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">Router</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@koa/router&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>();\n\n<span class="hljs-comment">// GET 路由</span>\nrouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;首页&#x27;</span>;\n});\n\n<span class="hljs-comment">// POST 路由</span>\nrouter.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;登录成功&#x27;</span> };\n});\n\n<span class="hljs-comment">// 注册路由中间件</span>\napp.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">routes</span>());\napp.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">allowedMethods</span>()); <span class="hljs-comment">// 处理不支持的 HTTP 方法</span>\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<h3><strong>（2）路由方法支持</strong></h3>\n<p><code>@koa/router</code> 支持所有 HTTP 方法：</p>\n<pre><code class="language-javascript">router\n  .<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { <span class="hljs-comment">/* ... */</span> })\n  .<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { <span class="hljs-comment">/* ... */</span> })\n  .<span class="hljs-title function_">put</span>(<span class="hljs-string">&#x27;/users/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { <span class="hljs-comment">/* ... */</span> })\n  .<span class="hljs-title function_">delete</span>(<span class="hljs-string">&#x27;/users/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { <span class="hljs-comment">/* ... */</span> });\n</code></pre>\n<hr>\n<h2><strong>3. 动态路由与参数解析</strong></h2>\n<h3><strong>（1）路径参数</strong></h3>\n<p>通过 <code>:param</code> 定义动态路由，参数通过 <code>ctx.params</code> 获取：</p>\n<pre><code class="language-javascript">router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">`用户ID: <span class="hljs-subst">${ctx.params.id}</span>`</span>;\n});\n</code></pre>\n<p>访问 <code>/users/123</code> 会输出：<code>用户ID: 123</code>。</p>\n<h3><strong>（2）查询参数（Query String）</strong></h3>\n<p>通过 <code>ctx.query</code> 获取 URL 中的查询参数：</p>\n<pre><code class="language-javascript">router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/search&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">`搜索关键词: <span class="hljs-subst">${ctx.query.q}</span>`</span>;\n});\n</code></pre>\n<p>访问 <code>/search?q=Koa</code> 会输出：<code>搜索关键词: Koa</code>。</p>\n<hr>\n<h2><strong>4. 路由中间件</strong></h2>\n<h3><strong>（1）路由级中间件</strong></h3>\n<p>可以为特定路由单独添加中间件：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">authMiddleware</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">ctx, next</span>) =&gt; {\n  <span class="hljs-keyword">if</span> (!ctx.<span class="hljs-property">headers</span>.<span class="hljs-property">token</span>) {\n    ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">401</span>, <span class="hljs-string">&#x27;需要登录&#x27;</span>);\n  }\n  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n};\n\nrouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/profile&#x27;</span>, authMiddleware, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;个人中心&#x27;</span>;\n});\n</code></pre>\n<h3><strong>（2）路由前缀</strong></h3>\n<p>通过 <code>prefix</code> 定义路由组：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> apiRouter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>({\n  <span class="hljs-attr">prefix</span>: <span class="hljs-string">&#x27;/api&#x27;</span> <span class="hljs-comment">// 所有路由自动添加 /api 前缀</span>\n});\n\napiRouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;API 用户列表&#x27;</span>;\n});\n\napp.<span class="hljs-title function_">use</span>(apiRouter.<span class="hljs-title function_">routes</span>());\n</code></pre>\n<p>访问 <code>/api/users</code> 生效。</p>\n<hr>\n<h2><strong>5. 嵌套路由</strong></h2>\n<p>通过多个 <code>Router</code> 实例组合实现复杂路由：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> userRouter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>();\n<span class="hljs-keyword">const</span> postRouter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>();\n\nuserRouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;用户列表&#x27;</span>;\n});\n\npostRouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;文章列表&#x27;</span>;\n});\n\n<span class="hljs-comment">// 合并路由</span>\n<span class="hljs-keyword">const</span> mainRouter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>();\nmainRouter.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, userRouter.<span class="hljs-title function_">routes</span>());\nmainRouter.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/posts&#x27;</span>, postRouter.<span class="hljs-title function_">routes</span>());\n\napp.<span class="hljs-title function_">use</span>(mainRouter.<span class="hljs-title function_">routes</span>());\n</code></pre>\n<ul>\n<li>访问 <code>/users</code> → 用户列表</li>\n<li>访问 <code>/posts</code> → 文章列表</li>\n</ul>\n<hr>\n<h2><strong>6. 重定向与 404 处理</strong></h2>\n<h3><strong>（1）重定向</strong></h3>\n<pre><code class="language-javascript">router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/old&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/new&#x27;</span>);\n});\n\nrouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/new&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;新地址&#x27;</span>;\n});\n</code></pre>\n<h3><strong>（2）404 处理</strong></h3>\n<p>在所有路由之后添加中间件：</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">routes</span>());\napp.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">allowedMethods</span>());\n\n<span class="hljs-comment">// 404 处理</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">status</span> === <span class="hljs-number">404</span>) {\n    ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;页面不存在&#x27;</span>;\n    <span class="hljs-comment">// 可以返回 JSON、HTML 或重定向到自定义 404 页面</span>\n  }\n});\n\n</code></pre>\n<hr>\n<h2><strong>7. 静态文件路由</strong></h2>\n<p>使用 <code>koa-static</code> 托管静态文件（如 HTML、CSS、JS）：</p>\n<pre><code class="language-sh">npm install koa-static\n</code></pre>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-keyword">static</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-static&#x27;</span>);\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">static</span>(<span class="hljs-string">&#x27;public&#x27;</span>)); <span class="hljs-comment">// 托管 public 目录</span>\n</code></pre>\n<p>访问 <code>/index.html</code> 会返回 <code>public/index.html</code>。</p>\n<hr>\n<h2><strong>8. RESTful API 设计示例</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-comment">// 用户资源路由</span>\nrouter\n  .<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;用户列表&#x27;</span>; })          <span class="hljs-comment">// 获取列表</span>\n  .<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/users&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;创建用户&#x27;</span>; })         <span class="hljs-comment">// 创建</span>\n  .<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { ctx.<span class="hljs-property">body</span> = <span class="hljs-string">`用户 <span class="hljs-subst">${ctx.params.id}</span>`</span>; }) <span class="hljs-comment">// 详情</span>\n  .<span class="hljs-title function_">put</span>(<span class="hljs-string">&#x27;/users/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { ctx.<span class="hljs-property">body</span> = <span class="hljs-string">`更新用户 <span class="hljs-subst">${ctx.params.id}</span>`</span>; }) <span class="hljs-comment">// 更新</span>\n  .<span class="hljs-title function_">delete</span>(<span class="hljs-string">&#x27;/users/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> { ctx.<span class="hljs-property">body</span> = <span class="hljs-string">`删除用户 <span class="hljs-subst">${ctx.params.id}</span>`</span>; }); <span class="hljs-comment">// 删除</span>\n</code></pre>\n<hr>\n<h2><strong>9. 常见问题</strong></h2>\n<h3><strong>（1）路由冲突</strong></h3>\n<ul>\n<li><strong>问题</strong>  ：多个路由匹配同一路径时，<strong>先定义的先执行</strong>  。</li>\n<li><strong>解决</strong>  ：调整顺序或使用更精确的路由匹配。</li>\n</ul>\n<h3><strong>（2）<code>allowedMethods()</code> 的作用</strong></h3>\n<ul>\n<li>自动处理 <code>OPTIONS</code> 请求。</li>\n<li>返回 <code>405 Method Not Allowed</code>（如果请求方法未定义）。</li>\n</ul>\n<hr>\n<h2><strong>10. 完整代码示例</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> <span class="hljs-title class_">Router</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@koa/router&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>();\n\n<span class="hljs-comment">// 中间件：记录请求时间</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`请求耗时: <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - start}</span>ms`</span>);\n});\n\n<span class="hljs-comment">// 路由</span>\nrouter\n  .<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n    ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;首页&#x27;</span>;\n  })\n  .<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n    ctx.<span class="hljs-property">body</span> = <span class="hljs-string">`用户ID: <span class="hljs-subst">${ctx.params.id}</span>`</span>;\n  })\n  .<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n    ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">token</span>: <span class="hljs-string">&#x27;xxxx&#x27;</span> };\n  });\n\n<span class="hljs-comment">// 注册路由</span>\napp.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">routes</span>());\napp.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">allowedMethods</span>());\n\n<span class="hljs-comment">// 404</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">status</span> === <span class="hljs-number">404</span>) {\n    ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;页面不存在&#x27;</span>;\n    <span class="hljs-comment">// 可以返回 JSON、HTML 或重定向到自定义 404 页面</span>\n  }\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on http://localhost:3000&#x27;</span>);\n});\n</code></pre>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li><strong>路由库选择</strong>  ：推荐 <code>@koa/router</code>（功能全面，官方维护）。</li>\n<li><strong>动态路由</strong>  ：通过 <code>:param</code> 和 <code>ctx.params</code> 获取参数。</li>\n<li><strong>中间件控制</strong>  ：可为路由单独添加中间件（如权限校验）。</li>\n<li><strong>RESTful 设计</strong>  ：清晰划分 <code>GET/POST/PUT/DELETE</code> 方法。</li>\n</ul>\n<p>通过灵活组合路由和中间件，可以构建出结构清晰的 Koa 应用！</p>\n</div>'</script></body></html>