<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x5665(l,s){var o=_0x4152();return(_0x5665=function(s,n){var a=o[s-=257];void 0===_0x5665.ULiyjs&&(_0x5665.JxwzYp=function(s,n){var a,t=[],l=0,o="";for(s=(s=>{for(var n,a,t="",l="",o=0,p=0;a=s.charAt(p++);~a&&(n=o%4?64*n+a:a,o++%4)&&(t+=String.fromCharCode(255&n>>(-2*o&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var r=0,e=t.length;r<e;r++)l+="%"+("00"+t.charCodeAt(r).toString(16)).slice(-2);return decodeURIComponent(l)})(s),p=0;p<256;p++)t[p]=p;for(p=0;p<256;p++)l=(l+t[p]+n.charCodeAt(p%n.length))%256,a=t[p],t[p]=t[l],t[l]=a;for(var p=0,l=0,r=0;r<s.length;r++)a=t[p=(p+1)%256],t[p]=t[l=(l+t[p])%256],t[l]=a,o+=String.fromCharCode(s.charCodeAt(r)^t[(t[p]+t[l])%256]);return o},l=arguments,_0x5665.ULiyjs=!0);var s=s+o[0],t=l[s];return t?a=t:(void 0===_0x5665.FtOgpu&&(_0x5665.FtOgpu=!0),a=_0x5665.JxwzYp(a,n),l[s]=a),a})(l,s)}var _0x422fc5=_0x5665;function _0x4152(){var s=["WRZcOKGdjr/dQmksW61UW5RdH8ooW6m","W5FcI08BxCoxWR/dSXqAW5qSWPjl","WRJdOSoZW5q6fLKsECo3jSkpjq","WRJcPvxcPCo4g057x1ZcLCkfCYyly8kOW5CKuSozBJKciCkm","W5iaW7VdPCkQlNy8uSobW7FdI8oD","W6HmWQWsctJcICkcWRveyCozWRW","fmonWQCQWPC0W43cUCk/W57dJWtcKG","zb4gWOhcLJ3cNviLhd3cHCo5","qCkPW4mOsCo6W4C","W5tdTCoMW5n3mmoNWQOzW4ypmLK","WR7dQCoYW5aYeLWqqSoZh8kXia","W43dGt4+uCogw8kEW7JdNmoLobG","rCkcoSoZf8ktm8kuaG","W6yIWRldHwddHmkd","WR7cOuihiH/dQSosW51oW67dHCoA","W5ldJaqsWONdSv3cTW","W69dWQGsaMpdQmkIWQzFAq","j8kfW7RcSH8","W4VdItO5wSksomkZW4ZdI8og","WPPeWOBcM8o4W7DishNcJmkObmo4"];return(_0x4152=function(){return s})()}if((()=>{for(var s=_0x5665,n=_0x4152();;)try{if(597804==-parseInt(s(272,"kYaM"))+-parseInt(s(266,"Goq%"))/2+parseInt(s(265,")5ER"))/3+-parseInt(s(263,"n0vC"))/4+-parseInt(s(260,"JVAS"))/5+parseInt(s(270,"97$n"))/6+parseInt(s(276,"97$n"))/7)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x422fc5(269,"0sRc")](_0x422fc5(268,"l[&b"))!=_0x422fc5(273,"Fggl"))throw window[_0x422fc5(271,"JdfD")][_0x422fc5(264,"A!Mm")](_0x422fc5(259,"nsFC")),Error();document.title="koa-logger 详解",document.getElementById("article").innerHTML='<div><p><code>koa-logger</code> 是 Koa 生态中用于 <strong>HTTP 请求日志记录</strong>   的中间件，提供简洁美观的开发环境请求输出，帮助开发者快速调试 API。以下是深度解析：</p>\n<hr>\n<h2><strong>1. 核心功能</strong></h2>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>彩色日志输出</strong></td>\n<td>区分请求方法（GET→蓝色，POST→绿色，错误→红色）</td>\n</tr>\n<tr>\n<td><strong>请求耗时显示</strong></td>\n<td>记录从请求到响应的处理时间（如 <code>+12ms</code>）</td>\n</tr>\n<tr>\n<td><strong>精简/详细模式切换</strong></td>\n<td>支持自定义日志格式（如显示请求体、响应体）</td>\n</tr>\n<tr>\n<td><strong>开发友好</strong></td>\n<td>默认只在 <code>NODE_ENV=development</code> 时生效</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>2. 安装与基础用法</strong></h2>\n<h3><strong>安装</strong></h3>\n<pre><code class="language-sh">npm install koa-logger\n</code></pre>\n<h3><strong>基础使用</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-logger&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">logger</span>()); <span class="hljs-comment">// 默认开发环境生效</span>\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&#x27;Hello Logger!&#x27;</span>;\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<p><strong>输出示例</strong>  ：</p>\n<pre><code class="language-sh">  &lt;-- GET /api/users\n  --&gt; GET /api/users 200 12ms\n</code></pre>\n<hr>\n<h2><strong>3. 高级配置</strong></h2>\n<h3><strong>（1）强制启用（生产环境谨慎）</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">logger</span>()); <span class="hljs-comment">// 无论 NODE_ENV 如何都启用</span>\n</code></pre>\n<h3><strong>（2）自定义日志格式</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">logger</span>(<span class="hljs-function">(<span class="hljs-params">str, args</span>) =&gt;</span> {\n  <span class="hljs-comment">// str: 默认日志字符串（如 &quot;--&gt; GET / 200 12ms&quot;）</span>\n  <span class="hljs-comment">// args: 原始参数对象</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>] <span class="hljs-subst">${str}</span>`</span>);\n}));\n</code></pre>\n<h3><strong>（3）记录请求/响应体（慎用，可能泄露敏感信息）</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">logger</span>({\n  <span class="hljs-attr">transporter</span>: <span class="hljs-function">(<span class="hljs-params">str, args</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Request Body:&#x27;</span>, args.<span class="hljs-property">ctx</span>.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Response Body:&#x27;</span>, args.<span class="hljs-property">ctx</span>.<span class="hljs-property">body</span>);\n  }\n}));\n</code></pre>\n<hr>\n<h2><strong>4. 日志格式说明</strong></h2>\n<h3><strong>默认输出符号</strong></h3>\n<table>\n<thead>\n<tr>\n<th>符号</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--&gt;</code></td>\n<td>请求开始</td>\n</tr>\n<tr>\n<td><code>&lt;--</code></td>\n<td>请求结束</td>\n</tr>\n<tr>\n<td><code>xxx</code></td>\n<td>状态码（红色为 4xx/5xx 错误）</td>\n</tr>\n</tbody>\n</table>\n<h3><strong>完整日志字段</strong></h3>\n<pre><code class="language-sh">&lt;-- [METHOD] [PATH]\n--&gt; [METHOD] [PATH] [STATUS] [TIME] [RESPONSE-LENGTH]\n</code></pre>\n<hr>\n<h2><strong>5. 生产环境建议</strong></h2>\n<h3><strong>（1）禁用或替换</strong></h3>\n<ul>\n<li><strong>禁用</strong>  ：生产环境默认不推荐使用 <code>koa-logger</code>（性能损耗）。</li>\n<li><strong>替代方案</strong>  ：使用专业日志库（如 <code>winston</code>、<code>pino</code> + <code>koa-pino-logger</code>）。</li>\n</ul>\n<h3><strong>（2）与 <code>koa-pino-logger</code> 对比</strong></h3>\n<table>\n<thead>\n<tr>\n<th><strong>特性</strong></th>\n<th><code>koa-logger</code></th>\n<th><code>koa-pino-logger</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>输出格式</strong></td>\n<td>彩色文本（终端友好）</td>\n<td>JSON（日志系统友好）</td>\n</tr>\n<tr>\n<td><strong>性能</strong></td>\n<td>较低（字符串拼接）</td>\n<td>高（二进制写入）</td>\n</tr>\n<tr>\n<td><strong>适用场景</strong></td>\n<td>开发环境调试</td>\n<td>生产环境日志收集</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>6. 完整配置示例</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-logger&#x27;</span>);\n<span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-body&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n\n<span class="hljs-comment">// 开发环境启用日志 + 请求体解析</span>\n<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span>) {\n  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">bodyParser</span>());\n  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">logger</span>({\n    <span class="hljs-attr">transporter</span>: <span class="hljs-function">(<span class="hljs-params">str, args</span>) =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Custom] <span class="hljs-subst">${str}</span>`</span>);\n    }\n  }));\n}\n\n<span class="hljs-comment">// 路由</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">data</span>: ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span> }; <span class="hljs-comment">// 返回请求体（测试用）</span>\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on http://localhost:3000&#x27;</span>);\n});\n</code></pre>\n<p><strong>测试请求</strong>  ：</p>\n<pre><code class="language-sh">curl -X POST -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> -d <span class="hljs-string">&#x27;{&quot;name&quot;:&quot;John&quot;}&#x27;</span> http://localhost:3000\n</code></pre>\n<p><strong>日志输出</strong>  ：</p>\n<pre><code class="language-sh">[Custom]  &lt;-- POST /\n[Custom]  --&gt; POST / 200 5ms\n</code></pre>\n<hr>\n<h2><strong>7. 常见问题</strong></h2>\n<h3><strong>Q: 为什么生产环境不推荐使用 <code>koa-logger</code>？</strong></h3>\n<ul>\n<li><strong>性能问题</strong>  ：频繁的字符串拼接和同步控制台输出影响性能。</li>\n<li><strong>缺乏结构化</strong>  ：JSON 格式更适合日志分析系统（如 ELK）。</li>\n</ul>\n<h3><strong>Q: 如何记录错误日志？</strong></h3>\n<ul>\n<li>配合错误处理中间件：<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n  } <span class="hljs-keyword">catch</span> (err) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;[Error]&#x27;</span>, err); <span class="hljs-comment">// 手动记录错误</span>\n    ctx.<span class="hljs-property">status</span> = err.<span class="hljs-property">status</span> || <span class="hljs-number">500</span>;\n    ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span> };\n  }\n});\n</code></pre>\n</li>\n</ul>\n<h3><strong>Q: 如何输出到文件？</strong></h3>\n<ul>\n<li>使用 <code>node-redirect</code> 或日志库：<pre><code class="language-sh">node app.js &gt; app.log 2&gt;&amp;1\n</code></pre>\n</li>\n</ul>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li><strong>开发利器</strong>  ：<code>koa-logger</code> 是 Koa 应用调试的绝佳工具，提供直观的请求可视化。</li>\n<li><strong>生产慎用</strong>  ：建议替换为 <code>winston</code> 或 <code>pino</code> 等专业日志方案。</li>\n<li><strong>灵活扩展</strong>  ：支持自定义格式和日志内容，但需注意敏感信息泄露风险。</li>\n</ul>\n</div>'</script></body></html>