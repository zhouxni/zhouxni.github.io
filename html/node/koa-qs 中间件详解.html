<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x3233(p,s){var l=_0x37d6();return(_0x3233=function(s,n){var a=l[s-=370];void 0===_0x3233.SLAGzl&&(_0x3233.jChbnb=function(s,n){var a,t=[],p=0,l="";for(s=(s=>{for(var n,a,t="",p="",l=0,o=0;a=s.charAt(o++);~a&&(n=l%4?64*n+a:a,l++%4)&&(t+=String.fromCharCode(255&n>>(-2*l&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,e=t.length;c<e;c++)p+="%"+("00"+t.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),o=0;o<256;o++)t[o]=o;for(o=0;o<256;o++)p=(p+t[o]+n.charCodeAt(o%n.length))%256,a=t[o],t[o]=t[p],t[p]=a;for(var o=0,p=0,c=0;c<s.length;c++)a=t[o=(o+1)%256],t[o]=t[p=(p+t[o])%256],t[p]=a,l+=String.fromCharCode(s.charCodeAt(c)^t[(t[o]+t[p])%256]);return l},p=arguments,_0x3233.SLAGzl=!0);var s=s+l[0],t=p[s];return t?a=t:(void 0===_0x3233.jmXWwj&&(_0x3233.jmXWwj=!0),a=_0x3233.jChbnb(a,n),p[s]=a),a})(p,s)}var _0x18d61b=_0x3233;function _0x37d6(){var s=["rGSjWO3cH03cNCkOW6m0ea","btpcRa7cKCk5mq","qSoOWR/dQSogWRRcSCoiW6xdMG","FthdTmoJcSoYW5ddU8o6W7jWaSkE","WPddNCoDfCkCuM/dJG","W5tcOXhcQCoIkCoKWPFcVgZdNcCk","mqhdUepcQ8kpWOGnW4u","W47cTX3cICkEpmoGiW","a3zIWP/cQwC8nCknW6irrdZcUCoJns/cQtqQeY50WO9ZWOC","WPFcTY56z8oJqbSpuG","WOautmovW7uhqCkJCCoCWQFcOg8","W5hdPrVcOmooWPmychRcShDL","aSo8u2akkeSahG","W4vqWQaJaCkpW6VcQeW3BfRcLW","WRi4smozvmoWl8oQfMFdVK4","jen5WR5gfXVdVcVcU8oCW50s","D8kRbtraA0eaiCowWR1u","WO/dMmkdxWHoW5Wl","W5ldQHNcOmoeW5WyeeZcHvq","dgDIWQBcRJH+","W7WeW57dUYu","v3i1eSodW7SoW4yDdmkZW6KU","dbuMW7ncvfbquuWtFq","WO/cGCkdCdfcW60","F27cHCk5CSkkWQu","E8kTce4+he4WlG"];return(_0x37d6=function(){return s})()}if((()=>{for(var s=_0x3233,n=_0x37d6();;)try{if(204517==-parseInt(s(385,"7nWh"))+-parseInt(s(381,"Rwq8"))/2+parseInt(s(391,"w5c$"))/3*(-parseInt(s(370,"w5c$"))/4)+parseInt(s(372,"lMOE"))/5+-parseInt(s(392,"7[EQ"))/6*(-parseInt(s(376,"7eZN"))/7)+parseInt(s(382,"uH8y"))/8+parseInt(s(384,"*58!"))/9*(parseInt(s(383,"7[EQ"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x18d61b(386,"btRP")](_0x18d61b(379,"7[EQ"))!=_0x18d61b(387,"*J5i"))throw window[_0x18d61b(374,"wbtH")][_0x18d61b(394,"8%PJ")](_0x18d61b(375,"btRP")),Error();document.title="koa-qs 中间件详解",document.getElementById("article").innerHTML='<div><p><code>koa-qs</code> 是一个用于 <strong>增强 Koa 请求查询字符串解析能力</strong>   的中间件，它扩展了 Koa 原生 <code>ctx.query</code> 的功能，支持更复杂的参数结构（如嵌套对象、数组）。以下是它的核心特性和使用方法：</p>\n<hr>\n<h2><strong>1. 核心功能</strong></h2>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>嵌套对象解析</strong></td>\n<td>将 <code>?user[name]=John&amp;user[age]=30</code> 解析为 <code>{ user: { name: \'John\', age: \'30\' } }</code></td>\n</tr>\n<tr>\n<td><strong>数组解析</strong></td>\n<td>将 <code>?ids[]=1&amp;ids[]=2</code> 解析为 <code>{ ids: [\'1\', \'2\'] }</code></td>\n</tr>\n<tr>\n<td><strong>自定义解析模式</strong></td>\n<td>支持 <code>querystring</code>、<code>qs</code> 等解析库的配置</td>\n</tr>\n<tr>\n<td><strong>兼容原生 <code>ctx.query</code></strong></td>\n<td>不破坏 Koa 原有功能，仅增强解析能力</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>2. 安装与基础用法</strong></h2>\n<h3><strong>安装</strong></h3>\n<pre><code class="language-sh">npm install koa-qs\n</code></pre>\n<h3><strong>基础使用</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-qs&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n<span class="hljs-title function_">qs</span>(app); <span class="hljs-comment">// 挂载增强解析功能</span>\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-comment">// 原生 ctx.query 现在支持嵌套解析</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx.<span class="hljs-property">query</span>); \n  ctx.<span class="hljs-property">body</span> = ctx.<span class="hljs-property">query</span>;\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);\n</code></pre>\n<p><strong>测试请求</strong>  ：</p>\n<pre><code class="language-sh">curl <span class="hljs-string">&quot;http://localhost:3000?user[name]=John&amp;user[age]=30&amp;ids[]=1&amp;ids[]=2&quot;</span>\n</code></pre>\n<p><strong>输出</strong>  ：</p>\n<pre><code class="language-json"><span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;John&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;30&quot;</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;ids&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">]</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n<hr>\n<h2><strong>3. 高级配置</strong></h2>\n<h3><strong>（1）选择解析库</strong></h3>\n<p>默认使用 Node.js 内置的 <code>querystring</code>，但可以通过参数切换更强大的 <code>qs</code> 库：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-qs&#x27;</span>);\n\n<span class="hljs-comment">// 使用 qs 库（支持更复杂的嵌套结构）</span>\n<span class="hljs-title function_">qs</span>(app, <span class="hljs-string">&#x27;qs&#x27;</span>); \n\n<span class="hljs-comment">// 或自定义配置</span>\n<span class="hljs-title function_">qs</span>(app, {\n  <span class="hljs-attr">library</span>: <span class="hljs-string">&#x27;qs&#x27;</span>,\n  <span class="hljs-attr">options</span>: { <span class="hljs-attr">depth</span>: <span class="hljs-number">10</span> } <span class="hljs-comment">// 限制嵌套深度</span>\n});\n</code></pre>\n<h3><strong>（2）严格模式</strong></h3>\n<p>禁止解析数组和嵌套对象（回退到原生 <code>querystring</code>）：</p>\n<pre><code class="language-javascript"><span class="hljs-title function_">qs</span>(app, <span class="hljs-string">&#x27;strict&#x27;</span>); \n<span class="hljs-comment">// ?user[name]=John → { &quot;user[name]&quot;: &quot;John&quot; }</span>\n</code></pre>\n<hr>\n<h2><strong>4. 与 Koa 原生功能的对比</strong></h2>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>原生 <code>ctx.query</code></th>\n<th><code>koa-qs</code> 增强版</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>嵌套对象</td>\n<td>不支持（<code>{ &quot;user[name]&quot;: &quot;John&quot; }</code>）</td>\n<td>支持（<code>{ user: { name: &quot;John&quot; } }</code>）</td>\n</tr>\n<tr>\n<td>数组</td>\n<td>不支持（<code>{ &quot;ids[]&quot;: &quot;1&quot; }</code>）</td>\n<td>支持（<code>{ ids: [&quot;1&quot;] }</code>）</td>\n</tr>\n<tr>\n<td>解析库</td>\n<td><code>querystring</code></td>\n<td>可配置（<code>qs</code> 或 <code>querystring</code>）</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>5. 常见问题解决方案</strong></h2>\n<h3><strong>Q: 如何解析 POST 请求的查询字符串？</strong></h3>\n<p><code>koa-qs</code> 仅增强 <code>ctx.query</code>（URL 查询参数），如需解析 POST 请求体，需配合 <code>koa-body</code>：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-body&#x27;</span>);\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">bodyParser</span>()); <span class="hljs-comment">// 解析 application/x-www-form-urlencoded</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>); <span class="hljs-comment">// POST 请求体数据</span>\n});\n</code></pre>\n<h3><strong>Q: 为什么数组解析后值是字符串？</strong></h3>\n<p>HTTP 查询参数本质是字符串，需手动转换类型：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> ids = ctx.<span class="hljs-property">query</span>.<span class="hljs-property">ids</span>.<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>); <span class="hljs-comment">// [&quot;1&quot;, &quot;2&quot;] → [1, 2]</span>\n</code></pre>\n<h3><strong>Q: 如何禁用嵌套解析？</strong></h3>\n<p>使用严格模式：</p>\n<pre><code class="language-javascript"><span class="hljs-title function_">qs</span>(app, <span class="hljs-string">&#x27;strict&#x27;</span>);\n</code></pre>\n<hr>\n<h2><strong>6. 完整示例</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa&#x27;</span>);\n<span class="hljs-keyword">const</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-qs&#x27;</span>);\n<span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;koa-body&#x27;</span>);\n\n<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();\n\n<span class="hljs-comment">// 增强查询字符串解析</span>\n<span class="hljs-title function_">qs</span>(app, <span class="hljs-string">&#x27;qs&#x27;</span>); \n\n<span class="hljs-comment">// 解析 POST 请求体</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">bodyParser</span>());\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (ctx) =&gt; {\n  <span class="hljs-comment">// 输出增强后的查询参数</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;URL 参数:&#x27;</span>, ctx.<span class="hljs-property">query</span>); \n\n  <span class="hljs-comment">// 输出 POST 请求体</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;请求体:&#x27;</span>, ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>); \n\n  ctx.<span class="hljs-property">body</span> = {\n    <span class="hljs-attr">query</span>: ctx.<span class="hljs-property">query</span>,\n    <span class="hljs-attr">body</span>: ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>\n  };\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on http://localhost:3000&#x27;</span>);\n});\n</code></pre>\n<hr>\n<h2><strong>7. 适用场景建议</strong></h2>\n<ul>\n<li><strong>推荐使用</strong>  ：\n<ul>\n<li>RESTful API 需要接收复杂查询参数时。</li>\n<li>前端传递嵌套表单数据（如动态字段）。</li>\n</ul>\n</li>\n<li><strong>无需使用</strong>  ：\n<ul>\n<li>仅需简单键值对查询（如 <code>?page=1</code>）。</li>\n<li>使用 GraphQL 等替代方案时。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3><strong>总结</strong></h3>\n<ul>\n<li><code>koa-qs</code> 是 Koa 生态中<strong>处理复杂查询参数的首选工具</strong>  ，尤其适合需要解析嵌套对象或数组的场景。</li>\n<li>通过配置解析库（如 <code>qs</code>），可以灵活平衡功能与性能。</li>\n<li>生产环境中建议配合 <code>koa-body</code> 实现完整的请求数据解析。</li>\n</ul>\n</div>'</script></body></html>