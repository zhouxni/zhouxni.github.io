<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x416c61=_0xfae6;function _0xfae6(p,s){var e=_0x44ec();return(_0xfae6=function(s,n){var a=e[s-=314];void 0===_0xfae6.DMivmv&&(_0xfae6.oMWint=function(s,n){var a,l=[],p=0,e="";for(s=(s=>{for(var n,a,l="",p="",e=0,c=0;a=s.charAt(c++);~a&&(n=e%4?64*n+a:a,e++%4)&&(l+=String.fromCharCode(255&n>>(-2*e&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var t=0,o=l.length;t<o;t++)p+="%"+("00"+l.charCodeAt(t).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+n.charCodeAt(c%n.length))%256,a=l[c],l[c]=l[p],l[p]=a;for(var c=0,p=0,t=0;t<s.length;t++)a=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=a,e+=String.fromCharCode(s.charCodeAt(t)^l[(l[c]+l[p])%256]);return e},p=arguments,_0xfae6.DMivmv=!0);var s=s+e[0],l=p[s];return l?a=l:(void 0===_0xfae6.qTzHZT&&(_0xfae6.qTzHZT=!0),a=_0xfae6.oMWint(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0xfae6,n=_0x44ec();;)try{if(992521==+parseInt(s(335,"!U&["))+-parseInt(s(318,"V(DB"))/2*(-parseInt(s(339,"7[Tc"))/3)+parseInt(s(333,"zK3]"))/4+-parseInt(s(329,"UVEQ"))/5*(parseInt(s(314,"$YZ@"))/6)+parseInt(s(319,"O[*i"))/7+-parseInt(s(336,"Wfvh"))/8*(parseInt(s(323,"x&Fs"))/9)+-parseInt(s(327,"eDF2"))/10*(-parseInt(s(317,"Ytb!"))/11))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x416c61(341,"@[oi")](_0x416c61(321,"eT1Y"))!=_0x416c61(332,"b]IO"))throw window[_0x416c61(338,"k&Iz")][_0x416c61(320,"zK3]")](_0x416c61(322,"7[Tc")),Error();function _0x44ec(){var s=["vmoOFCoDW4ZdMSoUnW","ymoGe1hcI8oQWRm","WOpdUZHPhmoUW7/dRmorWQnhWQNdIq","jt7dSwSwW6WR","W6buy8oYFCkqCqFcHComquO","Af3cPmkDkCo2D2G","WOxdUt9VemoQWORdVCoAWRLyWPe","WQpdKCoRW7BdTmkIhSkBvNvGW6fE","qmksW57dVrdcJcrkWRuxqfaV","WRqYdt3cO8otFrFcNvdcRtzq","WRVdR8kXCSkxW7O9","WRxcV1jxWPxcKMTOW5u","o8oZmKFcR8kPW59sA8oYshVdTCoOxmoDW4KbW7ZdUsZcTSkjW6VcJSoC","FwzxsmoLF8o8WPFcG8ot","uIhdMSoFcITkW43cMtutWOVdIW","WPHveCkdW61/W6LSWPpcT2LYAq","WRlcSIZcSCkZWRjBWRpdOZO5WP50","gSo0WQ87WRPBWPRcQq","W5FcRdtcGCkow8oOWRGXnSks","yLJcOCkvf8o+EvK","n3SjW7n6WQhdUSob","W5FdU1ldKmoVBSoH","yIZdNSk1WQ8","W7JcVCoYj8ohWQTOWOKjW4uMW43dRG","W4FdRGidWPZcJMXMW7q3","WRLMpCo6hapcIGRdOmohxJ4Z","dCk6ggTkrCk2W6DaWQ7dOq","WOtdVtLVfmoOW7NdUCo3WOD5WO/dMa"];return(_0x44ec=function(){return s})()}document.title="Node-Schedule 模块详解",document.getElementById("article").innerHTML='<div><h1>Node-Schedule 模块详解</h1>\n<p>Node-Schedule 是 Node.js 中一个功能强大的定时任务调度模块，它提供了比原生 <code>setTimeout</code> 和 <code>setInterval</code> 更灵活、更强大的定时功能。</p>\n<h2>安装</h2>\n<pre><code class="language-bash">npm install node-schedule\n</code></pre>\n<h2>基本用法</h2>\n<h3>1. 使用 Cron 风格语法</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schedule = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;node-schedule&quot;</span>);\n\n<span class="hljs-comment">// 每分钟的第30秒执行</span>\n<span class="hljs-keyword">const</span> job = schedule.<span class="hljs-title function_">scheduleJob</span>(<span class="hljs-string">&quot;30 * * * * *&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;每分钟的第30秒执行:&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());\n});\n\n<span class="hljs-comment">// 每天的12:00执行</span>\n<span class="hljs-keyword">const</span> dailyJob = schedule.<span class="hljs-title function_">scheduleJob</span>(<span class="hljs-string">&quot;0 12 * * *&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;每天中午12点执行:&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());\n});\n</code></pre>\n<h3>2. 使用 Date 对象指定具体时间</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在2023年12月25日00:00执行</span>\n<span class="hljs-keyword">const</span> christmas = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2023</span>, <span class="hljs-number">11</span>, <span class="hljs-number">25</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);\nschedule.<span class="hljs-title function_">scheduleJob</span>(christmas, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;圣诞快乐！&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());\n});\n</code></pre>\n<h3>3. 使用 RecurrenceRule 对象</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> rule = <span class="hljs-keyword">new</span> schedule.<span class="hljs-title class_">RecurrenceRule</span>();\nrule.<span class="hljs-property">hour</span> = <span class="hljs-number">14</span>; <span class="hljs-comment">// 每天14点</span>\nrule.<span class="hljs-property">minute</span> = <span class="hljs-number">30</span>; <span class="hljs-comment">// 30分</span>\nrule.<span class="hljs-property">dayOfWeek</span> = [<span class="hljs-keyword">new</span> schedule.<span class="hljs-title class_">Range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)]; <span class="hljs-comment">// 周一到周五</span>\n\n<span class="hljs-keyword">const</span> weekdayJob = schedule.<span class="hljs-title function_">scheduleJob</span>(rule, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;工作日14:30执行:&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());\n});\n</code></pre>\n<h2>Cron 表达式语法</h2>\n<p>Node-Schedule 使用类似 cron 的语法，但有6个字段（秒级精度）：</p>\n<pre><code>*    *    *    *    *    *\n┬    ┬    ┬    ┬    ┬    ┬\n│    │    │    │    │    │\n│    │    │    │    │    └ 星期几 (0 - 7) (0和7都代表周日)\n│    │    │    │    └───── 月份 (1 - 12)\n│    │    │    └────────── 日 (1 - 31)\n│    │    └─────────────── 小时 (0 - 23)\n│    └──────────────────── 分钟 (0 - 59)\n└───────────────────────── 秒 (0 - 59)\n</code></pre>\n<h2>高级功能</h2>\n<h3>1. 取消任务</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> job = schedule.<span class="hljs-title function_">scheduleJob</span>(<span class="hljs-string">&quot;*/5 * * * * *&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;每5秒执行一次&quot;</span>);\n});\n\n<span class="hljs-comment">// 10秒后取消任务</span>\n<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  job.<span class="hljs-title function_">cancel</span>();\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;任务已取消&quot;</span>);\n}, <span class="hljs-number">10000</span>);\n</code></pre>\n<h3>2. 查看下次执行时间</h3>\n<pre><code class="language-javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;下次执行时间:&quot;</span>, job.<span class="hljs-title function_">nextInvocation</span>());\n</code></pre>\n<h3>3. 动态创建和取消任务</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">let</span> dynamicJob;\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">startJob</span>(<span class="hljs-params"></span>) {\n  dynamicJob = schedule.<span class="hljs-title function_">scheduleJob</span>(<span class="hljs-string">&quot;*/10 * * * * *&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;动态任务执行:&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());\n  });\n}\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">stopJob</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">if</span> (dynamicJob) {\n    dynamicJob.<span class="hljs-title function_">cancel</span>();\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;动态任务已停止&quot;</span>);\n  }\n}\n</code></pre>\n<h3>4. 使用对象配置</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> jobConfig = {\n  <span class="hljs-attr">hour</span>: <span class="hljs-number">14</span>,\n  <span class="hljs-attr">minute</span>: <span class="hljs-number">30</span>,\n  <span class="hljs-attr">dayOfWeek</span>: [<span class="hljs-number">1</span>, <span class="hljs-keyword">new</span> schedule.<span class="hljs-title class_">Range</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)],\n};\n\n<span class="hljs-keyword">const</span> configJob = schedule.<span class="hljs-title function_">scheduleJob</span>(jobConfig, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;配置对象方式的任务执行:&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());\n});\n</code></pre>\n<h2>实际应用示例</h2>\n<h3>1. 定时发送邮件</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> nodemailer = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;nodemailer&quot;</span>);\n<span class="hljs-keyword">const</span> transporter = nodemailer.<span class="hljs-title function_">createTransport</span>({\n  <span class="hljs-comment">/* 配置 */</span>\n});\n\n<span class="hljs-comment">// 每天上午9点发送日报</span>\nschedule.<span class="hljs-title function_">scheduleJob</span>(<span class="hljs-string">&quot;0 9 * * *&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  transporter.<span class="hljs-title function_">sendMail</span>({\n    <span class="hljs-attr">from</span>: <span class="hljs-string">&quot;report@example.com&quot;</span>,\n    <span class="hljs-attr">to</span>: <span class="hljs-string">&quot;team@example.com&quot;</span>,\n    <span class="hljs-attr">subject</span>: <span class="hljs-string">&quot;每日报告 - &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleDateString</span>(),\n    <span class="hljs-attr">text</span>: <span class="hljs-string">&quot;这里是每日报告内容...&quot;</span>,\n  });\n});\n</code></pre>\n<h3>2. 定时数据库备份</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { exec } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;child_process&quot;</span>);\n\n<span class="hljs-comment">// 每周日凌晨2点备份数据库</span>\nschedule.<span class="hljs-title function_">scheduleJob</span>(<span class="hljs-string">&quot;0 2 * * 0&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> backupFile = <span class="hljs-string">`backup-<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>.sql`</span>;\n  <span class="hljs-title function_">exec</span>(<span class="hljs-string">`mysqldump -u root -p password mydb &gt; <span class="hljs-subst">${backupFile}</span>`</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (err) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;备份失败:&quot;</span>, err);\n    <span class="hljs-keyword">else</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;数据库备份完成:&quot;</span>, backupFile);\n  });\n});\n</code></pre>\n<h2>注意事项</h2>\n<ol>\n<li>\n<p><strong>时区问题</strong>   ：Node-Schedule 默认使用服务器本地时间，如果需要处理时区，可以使用 <code>moment-timezone</code> 等库</p>\n</li>\n<li>\n<p><strong>长时间运行</strong>   ：对于长时间运行的应用，确保正确处理错误，避免内存泄漏</p>\n</li>\n<li>\n<p><strong>集群环境</strong>   ：在多进程/集群环境中，定时任务可能会在每个进程中都执行，需要考虑使用外部锁或专用调度服务</p>\n</li>\n<li>\n<p><strong>任务执行时间</strong>   ：如果任务执行时间过长，可能会影响后续任务的准时执行</p>\n</li>\n</ol>\n<p>Node-Schedule 提供了强大而灵活的定时任务功能，适合大多数 Node.js 应用的定时任务需求。</p>\n</div>'</script></body></html>