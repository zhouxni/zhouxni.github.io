<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x3090(e,s){var t=_0x3f19();return(_0x3090=function(s,n){var a=t[s-=208];void 0===_0x3090.rtYwoL&&(_0x3090.caDklh=function(s,n){var a,l=[],e=0,t="";for(s=(s=>{for(var n,a,l="",e="",t=0,p=0;a=s.charAt(p++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,r=l.length;c<r;c++)e+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(e)})(s),p=0;p<256;p++)l[p]=p;for(p=0;p<256;p++)e=(e+l[p]+n.charCodeAt(p%n.length))%256,a=l[p],l[p]=l[e],l[e]=a;for(var p=0,e=0,c=0;c<s.length;c++)a=l[p=(p+1)%256],l[p]=l[e=(e+l[p])%256],l[e]=a,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[p]+l[e])%256]);return t},e=arguments,_0x3090.rtYwoL=!0);var s=s+t[0],l=e[s];return l?a=l:(void 0===_0x3090.oFzFqV&&(_0x3090.oFzFqV=!0),a=_0x3090.caDklh(a,n),e[s]=a),a})(e,s)}var _0x5c8068=_0x3090;if((()=>{for(var s=_0x3090,n=_0x3f19();;)try{if(783158==+parseInt(s(215,"8lw)"))+parseInt(s(224,"6Qg8"))/2*(parseInt(s(210,"1qzn"))/3)+-parseInt(s(222,"^Cu5"))/4+parseInt(s(216,"6Qg8"))/5*(-parseInt(s(213,"CoQ!"))/6)+parseInt(s(217,"g52r"))/7*(parseInt(s(232,"r79Q"))/8)+parseInt(s(231,"OmD6"))/9+-parseInt(s(227,"!R2k"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x5c8068(233,"OmD6")](_0x5c8068(220,"VIl5"))!=_0x5c8068(230,"VIl5"))throw window[_0x5c8068(211,"6Qg8")][_0x5c8068(214,"!R2k")](_0x5c8068(223,"zl#%")),Error();function _0x3f19(){var s=["nsNcO8kQWO1xEHKykdhdKG","WQjJrdOgW7/cHCkAWP5bW77dVq","W67cS0ZcP8kmbfS","nGLXW4FdISkkWOOVgrhcSGy","omkwWPWgW6JdVrxdTG","W7VdQrBcQSknteVdUsjZprm","vIbwW4ZdVsrtaW","bSofrLZdLvtdImoAWQbiWPhdLgK","WPRdQKdcGayjeZ3dHa","W7aoW40FxI8hW6vmWRGMWPuLW5C","WO/cNXdcVGuMWOrLbbBdQgO","hLFdMmoAvq7cSx0Pl8ocWRaLsmk/F3vsCcZdQ8kVed/cM8o9","p8obWPWMW4hdRXW","q8okWR/dOtLbW70","WO3dJCo7kmk/WOX7bSosW78QW6O","WQ3dOa7dVmovuqDnxhiWkCo8gW","W4jiuSkvwrxcSs7dGSoVo20","WOblW6/dSKNdLWLWsG","WQVdVfdcLGW","W4vfswmSW54iECkkjHldRce","W4NcP0atW7JdUGJdSCoE","WPSrcb5VWOHs","qg7cMCkBWORdRY4dW5ddRSkxW6q","W7dcPLPHW6JdKmkTcSoarCkfW5S","W6v9ymo9W4aph8k2m8okxaG","yComWRaRW4tdHqRdKq"];return(_0x3f19=function(){return s})()}document.title="Express 中间件详解",document.getElementById("article").innerHTML='<div><p>Express 的中间件（Middleware）是它的核心机制，用于处理 HTTP 请求和响应。中间件可以访问请求对象（<code>req</code>）、响应对象（<code>res</code>）和 <code>next</code> 函数，并能在请求-响应周期中执行逻辑。</p>\n<hr>\n<h2><strong>1. 中间件的基本概念</strong></h2>\n<h3><strong>（1）什么是中间件？</strong></h3>\n<ul>\n<li>中间件是一个函数，接收 <code>req</code>、<code>res</code> 和 <code>next</code> 参数。</li>\n<li>它可以：\n<ul>\n<li>修改 <code>req</code> 和 <code>res</code>（如解析请求体、添加响应头）。</li>\n<li>执行额外逻辑（如日志记录、权限校验）。</li>\n<li>终止请求（如 <code>res.send()</code>）或调用 <code>next()</code> 进入下一个中间件。</li>\n</ul>\n</li>\n</ul>\n<h3><strong>（2）中间件的执行顺序</strong></h3>\n<p>Express 中间件按<strong>声明顺序</strong>  执行，必须调用 <code>next()</code> 才能进入下一个中间件，否则请求会被挂起。</p>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Middleware 1&#x27;</span>);\n  <span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 必须调用 next()，否则请求不会继续</span>\n});\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Middleware 2&#x27;</span>);\n  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Hello&#x27;</span>);\n});\n</code></pre>\n<hr>\n<h2><strong>2. 中间件的类型</strong></h2>\n<p>Express 中间件分为 5 类：</p>\n<h3><strong>（1）应用级中间件（Application-level）</strong></h3>\n<ul>\n<li>通过 <code>app.use()</code> 或 <code>app.METHOD()</code>（如 <code>app.get()</code>）绑定到整个应用。</li>\n<li>适用于全局逻辑（如日志、CORS）。</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-comment">// 所有请求都会经过</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Time:&#x27;</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());\n  <span class="hljs-title function_">next</span>();\n});\n\n<span class="hljs-comment">// 只处理 GET /user 请求</span>\napp.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/user&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;User Info&#x27;</span>);\n});\n</code></pre>\n<h3><strong>（2）路由级中间件（Router-level）</strong></h3>\n<ul>\n<li>通过 <code>express.Router()</code> 绑定到特定路由。</li>\n<li>适用于模块化路由。</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();\n\nrouter.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Router Middleware&#x27;</span>);\n  <span class="hljs-title function_">next</span>();\n});\n\nrouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Home Page&#x27;</span>);\n});\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>, router); <span class="hljs-comment">// 挂载到 /admin 路径</span>\n</code></pre>\n<h3><strong>（3）错误处理中间件（Error-handling）</strong></h3>\n<ul>\n<li>必须接收 4 个参数：<code>(err, req, res, next)</code>。</li>\n<li>用于捕获并处理错误。</li>\n</ul>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/error&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-title function_">next</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Something broke!&#x27;</span>)); <span class="hljs-comment">// 抛出错误</span>\n});\n\n<span class="hljs-comment">// 错误处理中间件（放在最后）</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);\n  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Server Error&#x27;</span>);\n});\n</code></pre>\n<h3><strong>（4）内置中间件（Built-in）</strong></h3>\n<p>Express 自带的中间件：</p>\n<ul>\n<li><code>express.json()</code>：解析 JSON 请求体（<code>Content-Type: application/json</code>）。</li>\n<li><code>express.urlencoded()</code>：解析表单数据（<code>Content-Type: application/x-www-form-urlencoded</code>）。</li>\n<li><code>express.static()</code>：托管静态文件（如 HTML、CSS、JS）。</li>\n</ul>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>()); <span class="hljs-comment">// 解析 JSON 请求体</span>\napp.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&#x27;public&#x27;</span>)); <span class="hljs-comment">// 托管 public 目录</span>\n</code></pre>\n<h3><strong>（5）第三方中间件（Third-party）</strong></h3>\n<p>社区提供的中间件，需通过 <code>npm</code> 安装：</p>\n<ul>\n<li><code>morgan</code>：HTTP 请求日志。</li>\n<li><code>helmet</code>：安全防护（设置 HTTP 头）。</li>\n<li><code>cors</code>：跨域支持。</li>\n<li><code>cookie-parser</code>：解析 Cookie。</li>\n</ul>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan&#x27;</span>);\n<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cors&#x27;</span>);\n\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">morgan</span>(<span class="hljs-string">&#x27;dev&#x27;</span>)); <span class="hljs-comment">// 日志记录</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>()); <span class="hljs-comment">// 允许跨域</span>\n</code></pre>\n<hr>\n<h2><strong>3. 中间件的常见用途</strong></h2>\n<h3><strong>（1）请求日志记录</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.url}</span>`</span>);\n  <span class="hljs-title function_">next</span>();\n});\n</code></pre>\n<h3><strong>（2）权限校验</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">headers</span>.<span class="hljs-property">token</span> !== <span class="hljs-string">&#x27;secret&#x27;</span>) {\n    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Forbidden&#x27;</span>);\n  }\n  <span class="hljs-title function_">next</span>();\n});\n</code></pre>\n<h3><strong>（3）解析请求数据</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>()); <span class="hljs-comment">// 解析 JSON</span>\napp.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> })); <span class="hljs-comment">// 解析表单</span>\n</code></pre>\n<h3><strong>（4）响应时间计算</strong></h3>\n<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;finish&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Request took <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - start}</span>ms`</span>);\n  });\n  <span class="hljs-title function_">next</span>();\n});\n</code></pre>\n<hr>\n<h2><strong>4. 中间件的注意事项</strong></h2>\n<ol>\n<li><strong>顺序敏感</strong>  ：中间件按代码顺序执行，错误处理中间件必须放在最后。</li>\n<li><strong>必须调用 <code>next()</code></strong>  ：除非终止请求（如 <code>res.send()</code>），否则必须调用 <code>next()</code>。</li>\n<li><strong>避免阻塞</strong>  ：同步代码会阻塞事件循环，耗时操作应使用异步（如 <code>fs.readFile</code> 用回调或 Promise）。</li>\n<li><strong>错误处理</strong>  ：同步错误会自动捕获，但异步错误需手动 <code>next(err)</code>。</li>\n</ol>\n<pre><code class="language-javascript"><span class="hljs-comment">// 异步错误示例</span>\napp.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/async-error&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;nonexistent.txt&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (err) <span class="hljs-title function_">next</span>(err); <span class="hljs-comment">// 必须手动传递错误</span>\n    <span class="hljs-keyword">else</span> res.<span class="hljs-title function_">send</span>(data);\n  });\n});\n</code></pre>\n<hr>\n<h2><strong>5. 完整示例</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);\n<span class="hljs-keyword">const</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan&#x27;</span>);\n<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();\n\n<span class="hljs-comment">// 第三方中间件</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">morgan</span>(<span class="hljs-string">&#x27;dev&#x27;</span>));\napp.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());\n\n<span class="hljs-comment">// 应用级中间件</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Request URL:&#x27;</span>, req.<span class="hljs-property">url</span>);\n  <span class="hljs-title function_">next</span>();\n});\n\n<span class="hljs-comment">// 路由</span>\napp.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {\n  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Home Page&#x27;</span>);\n});\n\n<span class="hljs-comment">// 错误处理</span>\napp.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);\n  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Something broke!&#x27;</span>);\n});\n\napp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on http://localhost:3000&#x27;</span>);\n});\n</code></pre>\n<hr>\n<h2><strong>总结</strong></h2>\n<table>\n<thead>\n<tr>\n<th><strong>中间件类型</strong></th>\n<th><strong>示例</strong></th>\n<th><strong>用途</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>应用级中间件</td>\n<td><code>app.use(logger)</code></td>\n<td>全局逻辑（日志、CORS）</td>\n</tr>\n<tr>\n<td>路由级中间件</td>\n<td><code>router.use(auth)</code></td>\n<td>模块化路由处理</td>\n</tr>\n<tr>\n<td>错误处理中间件</td>\n<td><code>app.use((err, req, res, next) =&gt; {})</code></td>\n<td>捕获异常</td>\n</tr>\n<tr>\n<td>内置中间件</td>\n<td><code>express.json()</code></td>\n<td>解析请求数据</td>\n</tr>\n<tr>\n<td>第三方中间件</td>\n<td><code>morgan</code>、<code>cors</code></td>\n<td>扩展功能（日志、跨域）</td>\n</tr>\n</tbody>\n</table>\n<p>Express 中间件是构建灵活 Web 应用的关键，合理使用能大幅提升代码复用性和可维护性！</p>\n</div>'</script></body></html>