<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x2e36b=_0x555d;function _0x555d(l,s){var r=_0x45c0();return(_0x555d=function(s,a){var n=r[s-=164];void 0===_0x555d.iUDvRW&&(_0x555d.bHLLHz=function(s,a){var n,p=[],l=0,r="";for(s=(s=>{for(var a,n,p="",l="",r=0,e=0;n=s.charAt(e++);~n&&(a=r%4?64*a+n:n,r++%4)&&(p+=String.fromCharCode(255&a>>(-2*r&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var t=0,c=p.length;t<c;t++)l+="%"+("00"+p.charCodeAt(t).toString(16)).slice(-2);return decodeURIComponent(l)})(s),e=0;e<256;e++)p[e]=e;for(e=0;e<256;e++)l=(l+p[e]+a.charCodeAt(e%a.length))%256,n=p[e],p[e]=p[l],p[l]=n;for(var e=0,l=0,t=0;t<s.length;t++)n=p[e=(e+1)%256],p[e]=p[l=(l+p[e])%256],p[l]=n,r+=String.fromCharCode(s.charCodeAt(t)^p[(p[e]+p[l])%256]);return r},l=arguments,_0x555d.iUDvRW=!0);var s=s+r[0],p=l[s];return p?n=p:(void 0===_0x555d.vUWyUK&&(_0x555d.vUWyUK=!0),n=_0x555d.bHLLHz(n,a),l[s]=n),n})(l,s)}function _0x45c0(){var s=["Bmk5W7BcGYf7WRZcLabSbSoeWRq","WO5/f1pdQCkOWQRcTa3dNSoqW6NcTmoY","WPBdRmoQkW9/xCkFthDAWPhdUW","WPpdH8oXWPRcPCkzWOirdSogW50zjG","W5dcTa1tWP/dMumCfX/dICo/","cvnRW4j9","WPLYW7fPCSkktSo6WOhdH8o5sZ0","W4dcIeyhWOFdQq4","WP1+mmonBJ9qsa4AWP9P","WQbJjvRcKr/cGaNcNmo8yxuyW5jqEmkTv8oqldrJq0n2WQm","W418kLmiWR3dIW","aSo3WQtcHCkklSkEWQFcGG","aCoSW6uBsSoBCfeRWP9FmW0","uCkFW55QkH7dQ8oEndfEWPjO","W44oCdnjW7/cVxeJcCo7WQPW","aSkps8orEb8Qiei9W7NdKSoU","W5VcTuxdLmoRoSoXW5W","js/cLSkmxmkfyfmvybPwWO8","WRqUfc1HW4jm","W7NcRSkVfMPCnCk8W6JdP8kxWPRcRq","W57cRCo8W6hdJCk7ma"];return(_0x45c0=function(){return s})()}if((()=>{for(var s=_0x555d,a=_0x45c0();;)try{if(703178==-parseInt(s(172,"kd72"))+parseInt(s(164,"CXcs"))/2+-parseInt(s(183,"H7@7"))/3+-parseInt(s(166,"V)M7"))/4+-parseInt(s(178,"OqNl"))/5*(-parseInt(s(170,"nJkL"))/6)+-parseInt(s(180,"^Tsm"))/7+parseInt(s(169,"pq6k"))/8)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x2e36b(165,"eXRR")](_0x2e36b(179,"JJOP"))!=_0x2e36b(173,"IbeL"))throw window[_0x2e36b(184,"q#s2")][_0x2e36b(167,"TvNb")](_0x2e36b(177,"Ndq]")),Error();document.title="Egg.js 内置异常机制详解",document.getElementById("article").innerHTML='<div><p>Egg.js 提供了一套完整的异常处理机制，使得开发者可以方便地抛出、捕获和处理各种异常情况。以下是 Egg.js 内置异常机制的全面解析。</p>\n<h2>1. 内置异常类</h2>\n<p>Egg.js 基于 <code>egg-errors</code> 模块提供了一系列内置异常类：</p>\n<h3>常用内置异常</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { \n  <span class="hljs-title class_">EggException</span>,\n  <span class="hljs-title class_">HttpException</span>,\n  <span class="hljs-title class_">BadRequestError</span>,\n  <span class="hljs-title class_">UnauthorizedError</span>,\n  <span class="hljs-title class_">ForbiddenError</span>,\n  <span class="hljs-title class_">NotFoundError</span>,\n  <span class="hljs-title class_">InternalServerError</span>,\n  <span class="hljs-title class_">ServiceUnavailableError</span>\n} = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg-errors&#x27;</span>);\n</code></pre>\n<h3>异常类继承关系</h3>\n<pre><code>Error\n  └── EggException\n      └── HttpException\n          ├── BadRequestError (400)\n          ├── UnauthorizedError (401)\n          ├── ForbiddenError (403)\n          ├── NotFoundError (404)\n          ├── InternalServerError (500)\n          └── ServiceUnavailableError (503)\n</code></pre>\n<h2>2. 异常抛出方式</h2>\n<h3>2.1 使用 ctx.throw 方法</h3>\n<p>在 Controller 中最常用的异常抛出方式：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  \n  <span class="hljs-comment">// 基本用法</span>\n  <span class="hljs-keyword">if</span> (!ctx.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>) {\n    ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">400</span>, <span class="hljs-string">&#x27;缺少ID参数&#x27;</span>);\n  }\n  \n  <span class="hljs-comment">// 使用状态码常量</span>\n  ctx.<span class="hljs-keyword">throw</span>(ctx.<span class="hljs-property">HttpStatus</span>.<span class="hljs-property">HTTP_STATUS_FORBIDDEN</span>, <span class="hljs-string">&#x27;无权访问&#x27;</span>);\n  \n  <span class="hljs-comment">// 直接使用内置错误类</span>\n  ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">403</span>, {\n    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;无权访问该资源&#x27;</span>,\n    <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;FORBIDDEN&#x27;</span>,\n    <span class="hljs-attr">detail</span>: {\n      <span class="hljs-attr">userId</span>: ctx.<span class="hljs-property">user</span>.<span class="hljs-property">id</span>,\n      <span class="hljs-attr">resource</span>: ctx.<span class="hljs-property">path</span>\n    }\n  });\n}\n</code></pre>\n<h3>2.2 直接实例化异常类</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">NotFoundError</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg-errors&#x27;</span>);\n\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">getPost</span>(<span class="hljs-params">id</span>) {\n  <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">service</span>.<span class="hljs-property">post</span>.<span class="hljs-title function_">find</span>(id);\n  <span class="hljs-keyword">if</span> (!post) {\n    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotFoundError</span>({\n      <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;文章不存在&#x27;</span>,\n      <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;POST_NOT_FOUND&#x27;</span>,\n      <span class="hljs-attr">data</span>: { id }\n    });\n  }\n  <span class="hljs-keyword">return</span> post;\n}\n</code></pre>\n<h2>3. 异常属性</h2>\n<p>所有 Egg.js 异常都包含以下标准属性：</p>\n<pre><code class="language-javascript">{\n  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Error&#x27;</span>,          <span class="hljs-comment">// 错误名称</span>\n  <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;&#x27;</span>,            <span class="hljs-comment">// 错误消息</span>\n  <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;&#x27;</span>,               <span class="hljs-comment">// 业务错误码</span>\n  <span class="hljs-attr">status</span>: <span class="hljs-number">500</span>,            <span class="hljs-comment">// HTTP 状态码</span>\n  <span class="hljs-attr">detail</span>: {},             <span class="hljs-comment">// 错误详情</span>\n  <span class="hljs-attr">stack</span>: <span class="hljs-string">&#x27;&#x27;</span>               <span class="hljs-comment">// 错误堆栈</span>\n}\n</code></pre>\n<h2>4. 异常捕获与处理</h2>\n<h3>4.1 中间件统一处理</h3>\n<p>推荐在中间件中统一处理异常：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/middleware/error_handler.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">return</span> <span class="hljs-title function_">async</span> (ctx, next) =&gt; {\n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();\n    } <span class="hljs-keyword">catch</span> (err) {\n      <span class="hljs-comment">// 记录错误日志</span>\n      ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(err);\n      \n      <span class="hljs-comment">// 设置响应状态码</span>\n      ctx.<span class="hljs-property">status</span> = err.<span class="hljs-property">status</span> || <span class="hljs-number">500</span>;\n      \n      <span class="hljs-comment">// 生产环境不返回错误详情</span>\n      <span class="hljs-keyword">const</span> isProd = ctx.<span class="hljs-property">app</span>.<span class="hljs-property">config</span>.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;prod&#x27;</span>;\n      ctx.<span class="hljs-property">body</span> = {\n        <span class="hljs-attr">code</span>: err.<span class="hljs-property">code</span> || <span class="hljs-string">&#x27;INTERNAL_ERROR&#x27;</span>,\n        <span class="hljs-attr">message</span>: isProd ? <span class="hljs-string">&#x27;服务器错误&#x27;</span> : err.<span class="hljs-property">message</span>,\n        <span class="hljs-attr">detail</span>: isProd ? <span class="hljs-literal">undefined</span> : err.<span class="hljs-property">detail</span>\n      };\n    }\n  };\n};\n</code></pre>\n<h3>4.2 框架默认错误处理</h3>\n<p>Egg.js 默认会处理所有未捕获的异常：</p>\n<ul>\n<li>状态码为 <code>500</code> 的错误会显示错误页面</li>\n<li>其他状态码会返回 JSON 格式的错误响应</li>\n<li>本地开发环境会显示详细的错误堆栈</li>\n</ul>\n<h2>5. 自定义异常类</h2>\n<p>可以扩展内置异常类创建自定义异常：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// app/errors/user.js</span>\n<span class="hljs-keyword">const</span> { <span class="hljs-title class_">HttpException</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg-errors&#x27;</span>);\n\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAlreadyExistsError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HttpException</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {\n    <span class="hljs-variable language_">super</span>({\n      <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;用户已存在&#x27;</span>,\n      <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;USER_ALREADY_EXISTS&#x27;</span>,\n      <span class="hljs-attr">status</span>: <span class="hljs-number">409</span>, <span class="hljs-comment">// Conflict</span>\n      <span class="hljs-attr">detail</span>: data\n    });\n  }\n}\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">UserAlreadyExistsError</span>;\n</code></pre>\n<p>使用自定义异常：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserAlreadyExistsError</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../errors/user&#x27;</span>);\n\n<span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;\n  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> ctx.<span class="hljs-property">service</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">findByEmail</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>.<span class="hljs-property">email</span>);\n  <span class="hljs-keyword">if</span> (user) {\n    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserAlreadyExistsError</span>({ <span class="hljs-attr">email</span>: ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>.<span class="hljs-property">email</span> });\n  }\n  <span class="hljs-comment">// ...其他逻辑</span>\n}\n</code></pre>\n<h2>6. 异常与日志</h2>\n<p>Egg.js 会自动记录错误日志，但建议在关键位置手动记录：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">try</span> {\n  <span class="hljs-keyword">await</span> <span class="hljs-title function_">someOperation</span>();\n} <span class="hljs-keyword">catch</span> (err) {\n  ctx.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;操作失败: %s, data: %j&#x27;</span>, err.<span class="hljs-property">message</span>, ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>);\n  <span class="hljs-keyword">throw</span> err; <span class="hljs-comment">// 继续向上抛出</span>\n}\n</code></pre>\n<h2>7. 最佳实践</h2>\n<ol>\n<li><strong>业务异常</strong>  ：使用有意义的错误码和状态码</li>\n<li><strong>错误消息</strong>  ：对用户友好的消息 + 开发调试用的详细信息</li>\n<li><strong>错误分类</strong>  ：\n<ul>\n<li>4xx 表示客户端错误</li>\n<li>5xx 表示服务器错误</li>\n</ul>\n</li>\n<li><strong>错误转换</strong>  ：在边界处将第三方库错误转换为业务错误</li>\n<li><strong>日志记录</strong>  ：在关键位置记录足够排查问题的上下文信息</li>\n</ol>\n<h2>8. 常见内置错误</h2>\n<p>Egg.js 会在特定情况下自动抛出这些错误：</p>\n<ul>\n<li><code>403</code> 当 CSRF 校验失败时</li>\n<li><code>404</code> 当路由不存在时</li>\n<li><code>422</code> 当参数校验失败时 (egg-validate)</li>\n<li><code>500</code> 当插件或框架内部错误时</li>\n</ul>\n<p>通过这套完善的异常机制，Egg.js 应用可以保持清晰统一的错误处理方式，提高代码的可维护性和可靠性。</p>\n</div>'</script></body></html>