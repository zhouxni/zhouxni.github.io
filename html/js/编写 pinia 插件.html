<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x338112=_0x3500;function _0x3500(l,s){var p=_0x105c();return(_0x3500=function(s,n){var a=p[s-=311];void 0===_0x3500.VvYjFe&&(_0x3500.qEdHck=function(s,n){var a,t=[],l=0,p="";for(s=(s=>{for(var n,a,t="",l="",p=0,e=0;a=s.charAt(e++);~a&&(n=p%4?64*n+a:a,p++%4)&&(t+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=t.length;c<o;c++)l+="%"+("00"+t.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(l)})(s),e=0;e<256;e++)t[e]=e;for(e=0;e<256;e++)l=(l+t[e]+n.charCodeAt(e%n.length))%256,a=t[e],t[e]=t[l],t[l]=a;for(var e=0,l=0,c=0;c<s.length;c++)a=t[e=(e+1)%256],t[e]=t[l=(l+t[e])%256],t[l]=a,p+=String.fromCharCode(s.charCodeAt(c)^t[(t[e]+t[l])%256]);return p},l=arguments,_0x3500.VvYjFe=!0);var s=s+p[0],t=l[s];return t?a=t:(void 0===_0x3500.uVPhAG&&(_0x3500.uVPhAG=!0),a=_0x3500.qEdHck(a,n),l[s]=a),a})(l,s)}function _0x105c(){var s=["fCkQWOn8iHmD","cHWdW7RcTaJcK8onpSo6rwy+W57dRKtdVu7cUZjQWQXHW6HEW4q","W51jsSo9BKddTSo7sCkpW5ZdMa","a8k/W4mBWRGvluVcPcu","W7FcNWO6AruOCq","gInUhXi","W7VdQc5DWQ/dSmoFWQ4","WRjnhbSxsCk4W5iHW4G","rmkyWQD5iqC9","dmkSW4LwW4OEWPddSSkdvNK","WOZdJmoKW5BdH8k7W65H","W5PCWPhdMCoPoMy","WRVcPG/cP0pcHcicosldJq","uMj+lYrSWQDP","WQnFWPlcNCkpW58RfCoAW4NcQmo9","WQzxWPxcMSknW5mUfSoxW6JcKCoE","qCo4W4qmye4zWR4hfmoiya","WQ8DgSkHkWVdLmo4sq","W59osSo0AeddICowEmkqW5hdMW","W4r8jSk2WQ0Wfa","hCk6kmobgqrQiJ99WQ0","W67dVv3dVWxcNsi1","xttcG8ohpSkjbNVcQCkSW5W","yCklA8okW6BcPSk6kebP","vLbdWR3dTqBdR8kQaCovxwO","ySkpASolW6lcOmkFchXg"];return(_0x105c=function(){return s})()}if((()=>{for(var s=_0x3500,n=_0x105c();;)try{if(131051==-parseInt(s(311,"ul5e"))+-parseInt(s(319,"rTR6"))/2+-parseInt(s(331,"[449"))/3*(-parseInt(s(312,"ul5e"))/4)+-parseInt(s(330,"eyhu"))/5*(parseInt(s(329,"@lG6"))/6)+parseInt(s(317,"Sx0L"))/7+parseInt(s(326,"OeKv"))/8+-parseInt(s(313,"[449"))/9*(-parseInt(s(333,"WTu7"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x338112(323,"[449")](_0x338112(314,"gJq!"))!=_0x338112(328,"mYzk"))throw window[_0x338112(318,"H0m^")][_0x338112(316,"eH@Y")](_0x338112(324,"PA4Y")),Error();document.title="编写 pinia 插件",document.getElementById("article").innerHTML='<div><p><strong>如何编写 Pinia 插件</strong></p>\n<p>Pinia 插件是一个函数或对象，用于扩展 Pinia 的功能（如持久化、日志、错误捕获等）。以下是编写 Pinia 插件的完整指南：</p>\n<hr>\n<p><strong>1. 插件基本结构</strong><br>\nPinia 插件接收 <code>context</code> 参数，包含 Pinia 实例和当前 store 的信息：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">myPlugin</span> = (<span class="hljs-params">context</span>) =&gt; {\n  <span class="hljs-comment">// 插件逻辑</span>\n};\n</code></pre>\n<p><strong>插件示例：简单日志插件</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">loggerPlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {\n  <span class="hljs-comment">// 监听 state 变化</span>\n  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${store.$id}</span>] mutation:`</span>, mutation);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${store.$id}</span>] new state:`</span>, state);\n  });\n\n  <span class="hljs-comment">// 监听 action 调用</span>\n  store.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, args, after, onError }</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${store.$id}</span>] action &quot;<span class="hljs-subst">${name}</span>&quot; called with:`</span>, args);\n\n    <span class="hljs-title function_">after</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${store.$id}</span>] action &quot;<span class="hljs-subst">${name}</span>&quot; succeeded`</span>);\n    });\n\n    <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${store.$id}</span>] action &quot;<span class="hljs-subst">${name}</span>&quot; failed:`</span>, error);\n    });\n  });\n};\n\n<span class="hljs-comment">// 使用插件</span>\n<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>();\npinia.<span class="hljs-title function_">use</span>(loggerPlugin);\n</code></pre>\n<hr>\n<p><strong>2. 插件核心 API</strong><br>\n<strong>(1) <code>store.$subscribe</code></strong><br>\n监听 state 变化（类似 Vuex 的 <code>subscribe</code>）：</p>\n<pre><code class="language-javascript">store.$subscribe(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;mutation:&#x27;</span>, mutation.<span class="hljs-property">type</span>, mutation.<span class="hljs-property">payload</span>);\n});\n</code></pre>\n<p><strong>(2) <code>store.$onAction</code></strong><br>\n监听 action 调用（支持异步操作的生命周期钩子）：</p>\n<pre><code class="language-javascript">store.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, args, after, onError }</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Action &quot;<span class="hljs-subst">${name}</span>&quot; started with args:`</span>, args);\n\n  <span class="hljs-title function_">after</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Action &quot;<span class="hljs-subst">${name}</span>&quot; completed with result:`</span>, result);\n  });\n\n  <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Action &quot;<span class="hljs-subst">${name}</span>&quot; failed with error:`</span>, error);\n  });\n});\n</code></pre>\n<p><strong>(3) <code>store.$patch</code></strong><br>\n批量修改 state（可跳过 action 直接调用）：</p>\n<pre><code class="language-javascript">store.$patch({\n  <span class="hljs-attr">count</span>: store.<span class="hljs-property">count</span> + <span class="hljs-number">1</span>,\n  <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Updated by plugin&#x27;</span>,\n});\n</code></pre>\n<hr>\n<p><strong>3. 常见插件示例</strong><br>\n<strong>(1) 持久化插件（localStorage）</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">persistPlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {\n  <span class="hljs-comment">// 初始化时从 localStorage 恢复数据</span>\n  <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(store.<span class="hljs-property">$id</span>);\n  <span class="hljs-keyword">if</span> (saved) {\n    store.$patch(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved));\n  }\n\n  <span class="hljs-comment">// 监听变化并保存</span>\n  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">_, state</span>) =&gt;</span> {\n    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(store.<span class="hljs-property">$id</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state));\n  });\n};\n\n<span class="hljs-comment">// 使用</span>\n<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>().<span class="hljs-title function_">use</span>(persistPlugin);\n</code></pre>\n<p><strong>(2) 错误捕获插件</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">errorPlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {\n  store.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, onError }</span>) =&gt;</span> {\n    <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${store.$id}</span>] action &quot;<span class="hljs-subst">${name}</span>&quot; failed:`</span>, error);\n      <span class="hljs-comment">// 可以统一上报错误到 Sentry</span>\n      <span class="hljs-comment">// sentry.captureException(error);</span>\n    });\n  });\n};\n</code></pre>\n<p><strong>(3) 性能监控插件</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">performancePlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {\n  store.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, after }</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n\n    <span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${store.$id}</span>] action &quot;<span class="hljs-subst">${name}</span>&quot; took <span class="hljs-subst">${duration}</span>ms`</span>);\n    });\n  });\n};\n</code></pre>\n<hr>\n<p><strong>4. 插件高级用法</strong><br>\n<strong>(1) 动态添加新属性</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">extendStorePlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {\n  <span class="hljs-comment">// 添加一个 $reset 方法</span>\n  store.<span class="hljs-property">$reset</span> = <span class="hljs-function">() =&gt;</span> {\n    store.$patch(store.$state());\n  };\n\n  <span class="hljs-comment">// 添加计算属性</span>\n  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(store, <span class="hljs-string">&#x27;doubleCount&#x27;</span>, {\n    <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> store.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>,\n  });\n};\n</code></pre>\n<p><strong>(2) 插件选项配置</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">createPersistPlugin</span> = (<span class="hljs-params">options = {}</span>) =&gt; {\n  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">{ store }</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> key = options.<span class="hljs-property">key</span> || store.<span class="hljs-property">$id</span>;\n    <span class="hljs-keyword">const</span> storage = options.<span class="hljs-property">storage</span> || <span class="hljs-variable language_">localStorage</span>;\n\n    <span class="hljs-keyword">const</span> saved = storage.<span class="hljs-title function_">getItem</span>(key);\n    <span class="hljs-keyword">if</span> (saved) store.$patch(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved));\n\n    store.$subscribe(<span class="hljs-function">(<span class="hljs-params">_, state</span>) =&gt;</span> {\n      storage.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state));\n    });\n  };\n};\n\n<span class="hljs-comment">// 使用</span>\npinia.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPersistPlugin</span>({\n  <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;my-custom-key&#x27;</span>,\n  <span class="hljs-attr">storage</span>: <span class="hljs-variable language_">sessionStorage</span>,\n}));\n</code></pre>\n<p><strong>(3) 依赖注入</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">injectServicePlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {\n  <span class="hljs-comment">// 为所有 store 注入 API 服务</span>\n  store.<span class="hljs-property">api</span> = <span class="hljs-title function_">inject</span>(<span class="hljs-string">&#x27;api&#x27;</span>);\n};\n\n<span class="hljs-comment">// 在应用中提供依赖</span>\n<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);\napp.<span class="hljs-title function_">provide</span>(<span class="hljs-string">&#x27;api&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiService</span>());\napp.<span class="hljs-title function_">use</span>(pinia.<span class="hljs-title function_">use</span>(injectServicePlugin));\n</code></pre>\n<hr>\n<p><strong>5. 插件最佳实践</strong></p>\n<ol>\n<li>命名空间：避免污染全局状态，使用 <code>$</code> 前缀（如 <code>$reset</code>）。</li>\n<li>类型安全：为插件扩展的类型添加声明：<pre><code class="language-typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;pinia&#x27;</span> {\n  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PiniaCustomProperties</span> {\n    <span class="hljs-attr">$reset</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;\n  }\n}\n</code></pre>\n</li>\n<li>性能优化：避免在插件中执行昂贵操作（如深度监听）。</li>\n<li>组合式复用：将复杂插件拆分为多个小插件。</li>\n</ol>\n<hr>\n<p><strong>6. Pinia 插件 vs. Vuex 插件</strong></p>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>Pinia 插件</th>\n<th>Vuex 插件</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>API 风格</td>\n<td>基于 Composition API</td>\n<td>基于 Options API</td>\n</tr>\n<tr>\n<td>类型支持</td>\n<td>原生 TypeScript 友好</td>\n<td>需要额外类型定义</td>\n</tr>\n<tr>\n<td>作用域</td>\n<td>可针对单个 store</td>\n<td>全局生效</td>\n</tr>\n<tr>\n<td>调试</td>\n<td>集成 Vue DevTools</td>\n<td>需手动配置</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<p><strong>总结</strong></p>\n<ul>\n<li>\n<p>Pinia 插件通过函数形式扩展功能，比 Vuex 更简洁灵活。</p>\n</li>\n<li>\n<p>核心 API：</p>\n<ul>\n<li>\n<p><code>$subscribe</code>：监听 state 变化。</p>\n</li>\n<li>\n<p><code>$onAction</code>：监听 action 生命周期。</p>\n</li>\n<li>\n<p><code>$patch</code>：直接修改 state。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>推荐场景：</p>\n<ul>\n<li>\n<p>持久化：<code>localStorage/sessionStorage</code>。</p>\n</li>\n<li>\n<p>错误监控：统一上报错误。</p>\n</li>\n<li>\n<p>性能分析：跟踪 action 执行时间。</p>\n</li>\n</ul>\n</li>\n</ul>\n<p>官方文档：<a href="https://pinia.vuejs.org/core-concepts/plugins.html" target="_blank">Pinia Plugins</a></p>\n</div>'</script></body></html>