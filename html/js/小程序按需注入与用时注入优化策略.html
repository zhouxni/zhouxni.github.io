<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x57db8d=_0x48f8;if((()=>{for(var s=_0x48f8,n=_0x2003();;)try{if(674517==-parseInt(s(450,"b9)9"))*(-parseInt(s(461,"ftq^"))/2)+parseInt(s(441,"n%7y"))/3*(-parseInt(s(439,"HpNs"))/4)+parseInt(s(469,"*XAr"))/5*(parseInt(s(466,"#r*H"))/6)+-parseInt(s(445,"0q4I"))/7*(parseInt(s(454,"W]w2"))/8)+parseInt(s(457,"b9)9"))/9*(-parseInt(s(459,"@H#R"))/10)+parseInt(s(471,"[5nz"))/11*(parseInt(s(467,"MMv!"))/12)+parseInt(s(462,"OKzt"))/13*(parseInt(s(456,"kF7M"))/14))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x57db8d(460,"@H#R")](_0x57db8d(440,"mQy9"))!=_0x57db8d(442,"9EC&"))throw window[_0x57db8d(463,"*XAr")][_0x57db8d(452,"9EC&")](_0x57db8d(453,"dL#s")),Error();function _0x48f8(l,s){var p=_0x2003();return(_0x48f8=function(s,n){var a=p[s-=439];void 0===_0x48f8.zcWdsR&&(_0x48f8.xadmjl=function(s,n){var a,t=[],l=0,p="";for(s=(s=>{for(var n,a,t="",l="",p=0,c=0;a=s.charAt(c++);~a&&(n=p%4?64*n+a:a,p++%4)&&(t+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,o=t.length;e<o;e++)l+="%"+("00"+t.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)t[c]=c;for(c=0;c<256;c++)l=(l+t[c]+n.charCodeAt(c%n.length))%256,a=t[c],t[c]=t[l],t[l]=a;for(var c=0,l=0,e=0;e<s.length;e++)a=t[c=(c+1)%256],t[c]=t[l=(l+t[c])%256],t[l]=a,p+=String.fromCharCode(s.charCodeAt(e)^t[(t[c]+t[l])%256]);return p},l=arguments,_0x48f8.zcWdsR=!0);var s=s+p[0],t=l[s];return t?a=t:(void 0===_0x48f8.YBqwit&&(_0x48f8.YBqwit=!0),a=_0x48f8.xadmjl(a,n),l[s]=a),a})(l,s)}function _0x2003(){var s=["pmkcW5KemviA","W4DbnqL2zmkXrSkGm8k0WO8","imkPWQbjf8kfucpcVe/dSYK","xmkDW4OIfSkHca","aN54WRbOCtZdQ8oM","WR/dO8oOWOFcQ8ocs25uW43dPCoAea","WQ3cNv/dPCkg","WRamewZdH3JdUmkYW6dcRSo/WP4V","ACo+W44ytvZcNa","WOJcNmoIW47cQmkvWQytDrhcNCkVWOC","WO7dOCkJWOVdVSoQW5u","bhH0W6NcHsOEv0OxcSke","WRRcJHxdLSopeSkn","CIWIW6iQmsldImolB8ogDG","W6/cSb/cVvHyWRNcTxXTDHu","WRakf2VdJN/dSCkjW5NcNCoTWRao","WQ/cJvZdUSkEW6VdQW","oCoWW4mYEYRdQ8kQWPFcLqGpW77cUCkDoSkMWRZcPcjIFSoVWQxdUmo2","WRddQGddI0nLWQG","y18kwwJcLsykW4dcT8o1amkk","s8o7h8onnd/dPhu","W6ZcT0JdLWyAWOFcHW","W6NcL8onmCo9WQ8jca","WRvLBSkeW452W7tcSHZcPfZcUG","W6m0lSo5WOWJW5y","W4CWDeGIg8kI","r8kvWQtcRbZcPfnDgWtcJ8kFW7a","zCkHW7WSl2O6iq","WO/cKCoMWRJdRSoNW64eFa","W4DTWR7cGCopW5ZdK8k8","iLddUmk0WRNcVwZdNtWHqCkXWR8","gw1DW6hcOd8MF8o6","b3v0W6NcGIPJvNqzdSkufq"];return(_0x2003=function(){return s})()}document.title="小程序按需注入与用时注入优化策略",document.getElementById("article").innerHTML='<div><h2>一、按需注入（Required Injection）</h2>\n<h3>1. 基础概念</h3>\n<p>按需注入是小程序在启动时只注入当前页面需要的代码和组件，而不是全部资源。这是通过配置实现的全局优化策略。</p>\n<h3>2. 配置方式</h3>\n<p>在<code>app.json</code>中启用：</p>\n<pre><code class="language-json"><span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;lazyCodeLoading&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;required&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;usingComponents&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>\n    <span class="hljs-attr">&quot;my-component&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/components/my-component&quot;</span>\n  <span class="hljs-punctuation">}</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n<h3>3. 实现原理</h3>\n<ul>\n<li>构建时分析页面依赖关系</li>\n<li>运行时按页面路由加载必要代码</li>\n<li>组件延迟注册机制</li>\n</ul>\n<h3>4. 优化效果</h3>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>传统方式</th>\n<th>按需注入</th>\n<th>提升幅度</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>启动加载代码量</td>\n<td>全量</td>\n<td>30-50%</td>\n<td>40-60%</td>\n</tr>\n<tr>\n<td>冷启动时间</td>\n<td>500ms</td>\n<td>300ms</td>\n<td>40%</td>\n</tr>\n</tbody>\n</table>\n<h3>5. 使用限制</h3>\n<ul>\n<li>仅支持自定义组件</li>\n<li>基础库要求2.11.1+</li>\n<li>不能与「用时注入」同时使用</li>\n</ul>\n<h2>二、用时注入（On-Demand Injection）</h2>\n<h3>1. 基础概念</h3>\n<p>用时注入是更细粒度的代码加载策略，允许在运行时动态注入组件和逻辑。</p>\n<h3>2. 实现方式</h3>\n<h4>动态组件注入</h4>\n<pre><code class="language-javascript"><span class="hljs-comment">// 页面JS中动态注册</span>\n<span class="hljs-title class_">Page</span>({\n  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&#x27;../../components/expensive-component&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">comp</span> =&gt;</span> {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selectComponent</span>(<span class="hljs-string">&#x27;#placeholder&#x27;</span>).<span class="hljs-title function_">replaceWith</span>(comp)\n    })\n  }\n})\n</code></pre>\n<h4>条件模板注入</h4>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">wx:if</span>=<span class="hljs-string">&quot;{{showComplex}}&quot;</span>&gt;</span>\n  <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../../templates/complex.wxml&quot;</span>/&gt;</span>\n<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>\n</code></pre>\n<h3>3. 性能对比</h3>\n<pre><code class="language-mermaid">graph TD\n  A[用户操作] --&gt; B{是否需要新代码}\n  B --&gt;|是| C[发起网络请求]\n  B --&gt;|否| D[继续当前流程]\n  C --&gt; E[注入并执行]\n</code></pre>\n<h3>4. 最佳实践</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 预加载策略</span>\n<span class="hljs-keyword">const</span> preloadMap = {\n  <span class="hljs-string">&#x27;/pages/user&#x27;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;../../components/user-card&#x27;</span>),\n  <span class="hljs-string">&#x27;/pages/shop&#x27;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;../../components/shop-list&#x27;</span>)\n}\n\n<span class="hljs-comment">// 路由监听</span>\nwx.<span class="hljs-title function_">onAppRoute</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {\n  preloadMap[res.<span class="hljs-property">path</span>]?.()\n})\n</code></pre>\n<h2>三、混合使用策略</h2>\n<h3>1. 页面级按需 + 组件级用时</h3>\n<pre><code>app.json\n├── lazyCodeLoading: &quot;required&quot;  // 页面级按需\npage.js\n└── require.async()  // 组件级用时\n</code></pre>\n<h3>2. 关键组件预加载</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app.js中预加载关键组件</span>\n<span class="hljs-title class_">App</span>({\n  <span class="hljs-title function_">onLaunch</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">preloadComponent</span> = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([\n      <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;../../components/core/modal&#x27;</span>),\n      <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;../../components/core/toast&#x27;</span>)\n    ])\n  }\n})\n</code></pre>\n<h2>四、性能优化指标</h2>\n<h3>1. 内存占用对比</h3>\n<table>\n<thead>\n<tr>\n<th>方式</th>\n<th>内存峰值</th>\n<th>稳定内存</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>全量注入</td>\n<td>85MB</td>\n<td>45MB</td>\n</tr>\n<tr>\n<td>按需注入</td>\n<td>60MB</td>\n<td>38MB</td>\n</tr>\n<tr>\n<td>用时注入</td>\n<td>55MB</td>\n<td>30MB</td>\n</tr>\n</tbody>\n</table>\n<h3>2. 加载耗时统计</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 性能埋点示例</span>\n<span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()\n<span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&#x27;./heavy.js&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {\n  wx.<span class="hljs-title function_">reportAnalytics</span>(<span class="hljs-string">&#x27;load_time&#x27;</span>, {\n    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;heavy&#x27;</span>,\n    <span class="hljs-attr">duration</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start\n  })\n})\n</code></pre>\n<h2>五、异常处理方案</h2>\n<h3>1. 加载失败重试</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">loadWithRetry</span>(<span class="hljs-params">component, retries = <span class="hljs-number">3</span></span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> <span class="hljs-title function_">attempt</span> = (<span class="hljs-params"></span>) =&gt; {\n      <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(component)\n        .<span class="hljs-title function_">then</span>(resolve)\n        .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {\n          <span class="hljs-keyword">if</span> (retries-- &gt; <span class="hljs-number">0</span>) <span class="hljs-title function_">attempt</span>()\n          <span class="hljs-keyword">else</span> <span class="hljs-title function_">reject</span>(err)\n        })\n    }\n    <span class="hljs-title function_">attempt</span>()\n  })\n}\n</code></pre>\n<h3>2. 降级方案</h3>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">block</span> <span class="hljs-attr">wx:if</span>=<span class="hljs-string">&quot;{{!componentLoaded}}&quot;</span>&gt;</span>\n  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;placeholder&quot;</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>\n<span class="hljs-tag">&lt;/<span class="hljs-name">block</span>&gt;</span>\n</code></pre>\n<h2>六、调试技巧</h2>\n<h3>1. 查看注入情况</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 获取当前加载的代码包</span>\n<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">require</span>.<span class="hljs-property">cache</span>)\n</code></pre>\n<h3>2. 性能分析</h3>\n<pre><code class="language-javascript">wx.<span class="hljs-title function_">getPerformance</span>().<span class="hljs-title function_">mark</span>(<span class="hljs-string">&#x27;inject_start&#x27;</span>)\n<span class="hljs-comment">// 注入操作...</span>\nwx.<span class="hljs-title function_">getPerformance</span>().<span class="hljs-title function_">mark</span>(<span class="hljs-string">&#x27;inject_end&#x27;</span>)\nwx.<span class="hljs-title function_">getPerformance</span>().<span class="hljs-title function_">measure</span>(<span class="hljs-string">&#x27;inject&#x27;</span>, <span class="hljs-string">&#x27;inject_start&#x27;</span>, <span class="hljs-string">&#x27;inject_end&#x27;</span>)\n</code></pre>\n<p>通过合理组合按需注入和用时注入策略，可使小程序包体积减少30%-70%，内存占用降低20%-40%，实现秒开体验。建议新项目直接采用按需注入基础架构，对复杂组件使用用时注入进行深度优化。</p>\n</div>'</script></body></html>