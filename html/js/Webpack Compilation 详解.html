<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x1fe08d=_0x9038;function _0x9038(l,s){var o=_0x238a();return(_0x9038=function(s,n){var a=o[s-=469];void 0===_0x9038.cgKxVI&&(_0x9038.lwlWSW=function(s,n){var a,t=[],l=0,o="";for(s=(s=>{for(var n,a,t="",l="",o=0,e=0;a=s.charAt(e++);~a&&(n=o%4?64*n+a:a,o++%4)&&(t+=String.fromCharCode(255&n>>(-2*o&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,p=t.length;c<p;c++)l+="%"+("00"+t.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(l)})(s),e=0;e<256;e++)t[e]=e;for(e=0;e<256;e++)l=(l+t[e]+n.charCodeAt(e%n.length))%256,a=t[e],t[e]=t[l],t[l]=a;for(var e=0,l=0,c=0;c<s.length;c++)a=t[e=(e+1)%256],t[e]=t[l=(l+t[e])%256],t[l]=a,o+=String.fromCharCode(s.charCodeAt(c)^t[(t[e]+t[l])%256]);return o},l=arguments,_0x9038.cgKxVI=!0);var s=s+o[0],t=l[s];return t?a=t:(void 0===_0x9038.eVyRPC&&(_0x9038.eVyRPC=!0),a=_0x9038.lwlWSW(a,n),l[s]=a),a})(l,s)}function _0x238a(){var s=["pmoJW6HkWQ8","oI9lWQ3dSmkhxmkTW6W7W7zzWRi","WOqFWR4ZW4VcOCoD","xCoTvJRcGx/dT8k9ythcNa7dJG","WQBdS8kcgSkOW4/dJa","W5pdMCoGDvazbqaqw3BdR8kHcq","m1VcKSo4W6LqW4pdNCo9WPtdUrSvW4G/W6v4B8o0WRBdKmomW4dcGmk7gG","W6SnchldQW91hmoTWRHTqmo1","vexdJmk9W6qCWRCxwtldMCkwhW","WOb4W6GMWQHFk8koec3cJLNcSmox","WPnxWOpcNb4hW65o","W57dLSkUWQyfWO8mW5m","WO05W5ZdVuyqna","WQGEWQ/dO0G4W4tdQmo9l8ouWP1M","W7BcO8oczSoQWP7cLcRcJ00Iygu","W73dJSo6adTqW7JcNrxdLcVcHN8","W4lcHKbyW6iMW4S","WRBcRK3cRWXXW6y","wdXUzZD+gNtcMmkpWPHDxG","W7rPoKjgoCkulmo3WOtcImo/mq","kvbICSoKvmkKWP9uW5e3BqK","nmoGWPn3W77dHhVcJa","W4VcH8oDtb8UW5BcKtS","W41SWPJcPbjfzxelW5lcKKyc","nY1aWQNdTmkpvmkSW4WrW5nQWQS","W4RdI2JcPSk0rGi"];return(_0x238a=function(){return s})()}if((()=>{for(var s=_0x9038,n=_0x238a();;)try{if(871427==+parseInt(s(472,")9Wn"))*(parseInt(s(475,"VIYR"))/2)+parseInt(s(484,"0KaP"))/3*(parseInt(s(482,"A#NG"))/4)+-parseInt(s(486,"s1oE"))/5+parseInt(s(474,"NAW["))/6+-parseInt(s(492,"W(wv"))/7+-parseInt(s(490,"xT0Z"))/8+-parseInt(s(477,"5&KB"))/9*(-parseInt(s(469,"5MxA"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x1fe08d(489,")Y[d")](_0x1fe08d(481,"2GbI"))!=_0x1fe08d(485,"bT0D"))throw window[_0x1fe08d(470,"zh*a")][_0x1fe08d(471,"A#NG")](_0x1fe08d(491,"QHUy")),Error();document.title="Webpack Compilation 详解",document.getElementById("article").innerHTML='<div><p><code>Compilation</code> 是 Webpack 构建过程中的核心对象，代表<strong>单次资源构建的上下文</strong>  ，包含模块依赖图、生成的代码、哈希等关键信息。它是插件系统的主要操作目标，开发者可通过它控制构建流程、修改输出资源或分析构建状态。</p>\n<hr>\n<h2><strong>1. Compilation 的核心职责</strong></h2>\n<ul>\n<li><strong>管理模块依赖关系</strong>  ：构建模块依赖图（Dependency Graph）。</li>\n<li><strong>生成最终资源</strong>  ：将模块转换为输出文件（Bundle）。</li>\n<li><strong>存储构建状态</strong>  ：记录本次构建的输入（Entry）、输出（Assets）、错误、警告等。</li>\n<li><strong>触发生命周期钩子</strong>  ：在关键阶段（如 <code>optimize</code>、<code>emit</code>）通知插件介入。</li>\n</ul>\n<hr>\n<h2><strong>2. Compilation 的关键属性和方法</strong></h2>\n<h3><strong>2.1 重要属性</strong></h3>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>类型</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>modules</code></td>\n<td><code>Set&lt;Module&gt;</code></td>\n<td>所有模块（包括入口文件、依赖的第三方库等）</td>\n</tr>\n<tr>\n<td><code>chunks</code></td>\n<td><code>Set&lt;Chunk&gt;</code></td>\n<td>代码块（Chunk）集合（一个 Chunk 可能包含多个模块）</td>\n</tr>\n<tr>\n<td><code>assets</code></td>\n<td><code>{ [filename]: Source }</code></td>\n<td>最终输出的资源（文件名到内容的映射）</td>\n</tr>\n<tr>\n<td><code>entrypoints</code></td>\n<td><code>Map&lt;string, Entrypoint&gt;</code></td>\n<td>入口点及其关联的 Chunk</td>\n</tr>\n<tr>\n<td><code>hash</code></td>\n<td><code>string</code></td>\n<td>本次构建的唯一哈希值（用于缓存失效）</td>\n</tr>\n<tr>\n<td><code>errors</code>/<code>warnings</code></td>\n<td><code>Array</code></td>\n<td>构建过程中的错误和警告</td>\n</tr>\n</tbody>\n</table>\n<h3><strong>2.2 常用方法</strong></h3>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>addModule(module)</code></td>\n<td>动态添加模块到构建中</td>\n</tr>\n<tr>\n<td><code>emitAsset(filename, source)</code></td>\n<td>手动生成输出文件（需 <code>Source</code> 对象）</td>\n</tr>\n<tr>\n<td><code>getStats()</code></td>\n<td>返回构建统计信息（用于生成 <code>stats.json</code>）</td>\n</tr>\n<tr>\n<td><code>getModule(moduleIdentifier)</code></td>\n<td>根据模块标识符获取模块实例</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>3. Compilation 的生命周期钩子（Hooks）</strong></h2>\n<p><code>Compilation</code> 继承自 <code>Tapable</code>，提供丰富的钩子供插件监听和干预构建流程。</p>\n<h3><strong>关键钩子示例</strong></h3>\n<table>\n<thead>\n<tr>\n<th>钩子名</th>\n<th>触发时机</th>\n<th>典型用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>buildModule</code></td>\n<td>开始构建单个模块前</td>\n<td>修改模块源码</td>\n</tr>\n<tr>\n<td><code>finishModules</code></td>\n<td>所有模块构建完成后</td>\n<td>分析模块依赖</td>\n</tr>\n<tr>\n<td><code>optimize</code></td>\n<td>优化阶段开始时</td>\n<td>代码压缩、Tree Shaking</td>\n</tr>\n<tr>\n<td><code>processAssets</code></td>\n<td>处理资源文件时</td>\n<td>修改/添加输出文件</td>\n</tr>\n<tr>\n<td><code>emit</code></td>\n<td>生成资源到输出目录前</td>\n<td>最后修改资源内容</td>\n</tr>\n<tr>\n<td><code>afterEmit</code></td>\n<td>资源写入磁盘后</td>\n<td>清理临时文件</td>\n</tr>\n</tbody>\n</table>\n<p><strong>示例：在文件头部添加注释</strong></p>\n<pre><code class="language-javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {\n  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [filename, asset] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(compilation.<span class="hljs-property">assets</span>)) {\n    <span class="hljs-keyword">if</span> (filename.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.js&#x27;</span>)) {\n      compilation.<span class="hljs-property">assets</span>[filename] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcatSource</span>(\n        <span class="hljs-string">&#x27;// Built by MyPlugin\\n&#x27;</span>,\n        asset\n      );\n    }\n  }\n});\n</code></pre>\n<hr>\n<h2><strong>4. Compilation 与 Compiler 的关系</strong></h2>\n<table>\n<thead>\n<tr>\n<th>对象</th>\n<th>作用域</th>\n<th>生命周期</th>\n<th>典型用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>Compiler</code></td>\n<td>全局</td>\n<td>从启动到结束（多次构建共享）</td>\n<td>读取配置、管理插件、启动构建</td>\n</tr>\n<tr>\n<td><code>Compilation</code></td>\n<td>单次构建</td>\n<td>每次构建（如 <code>watch</code> 模式下的每次文件变动）</td>\n<td>管理模块、生成资源、触发钩子</td>\n</tr>\n</tbody>\n</table>\n<p><strong>关键区别</strong>  ：</p>\n<ul>\n<li>一个 <code>Compiler</code> 实例可能生成多个 <code>Compilation</code>（例如开发模式下每次保存文件触发新构建）。</li>\n<li><code>Compiler</code> 关注全局状态（如配置），<code>Compilation</code> 关注本次构建的细节。</li>\n</ul>\n<hr>\n<h2><strong>5. 实际应用场景</strong></h2>\n<h3><strong>5.1 自定义资源处理</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 添加版本文件</span>\ncompilation.<span class="hljs-title function_">emitAsset</span>(\n  <span class="hljs-string">&#x27;version.txt&#x27;</span>,\n  <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawSource</span>(<span class="hljs-string">`Build Time: <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>`</span>)\n);\n</code></pre>\n<h3><strong>5.2 依赖分析</strong></h3>\n<pre><code class="language-javascript">compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">finishModules</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">modules</span>) =&gt;</span> {\n  modules.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Module: <span class="hljs-subst">${<span class="hljs-variable language_">module</span>.identifier()}</span>`</span>);\n  });\n});\n</code></pre>\n<h3><strong>5.3 性能优化</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 移除所有 console.log</span>\ncompilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">processAssets</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">assets</span>) =&gt;</span> {\n  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(assets).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[filename, asset]</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (filename.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.js&#x27;</span>)) {\n      <span class="hljs-keyword">const</span> code = asset.<span class="hljs-title function_">source</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/console\\.log\\(.*?\\);?/g</span>, <span class="hljs-string">&#x27;&#x27;</span>);\n      compilation.<span class="hljs-property">assets</span>[filename] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawSource</span>(code);\n    }\n  });\n});\n</code></pre>\n<h3><strong>5.4 错误处理</strong></h3>\n<pre><code class="language-javascript">compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">failed</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;构建失败:&#x27;</span>, error);\n});\n</code></pre>\n<hr>\n<h2><strong>6. 源码结构（简化版）</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Compilation</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">compiler</span> = compiler;\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">assets</span> = {};\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span> = {\n      <span class="hljs-attr">buildModule</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>([<span class="hljs-string">&#x27;module&#x27;</span>]),\n      <span class="hljs-attr">optimize</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>([]),\n      <span class="hljs-attr">emit</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSeriesHook</span>([<span class="hljs-string">&#x27;compilation&#x27;</span>]),\n      <span class="hljs-comment">// ...其他钩子</span>\n    };\n  }\n\n  <span class="hljs-title function_">addModule</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) { <span class="hljs-comment">/* ... */</span> }\n  <span class="hljs-title function_">emitAsset</span>(<span class="hljs-params">filename, source</span>) { <span class="hljs-comment">/* ... */</span> }\n}\n</code></pre>\n<hr>\n<h2><strong>7. 注意事项</strong></h2>\n<ol>\n<li><strong>避免直接修改内部属性</strong>  ：如 <code>compilation.modules</code> 是 <code>Set</code> 类型，应使用官方 API（如 <code>addModule</code>）操作。</li>\n<li><strong>性能敏感操作</strong>  ：在 <code>processAssets</code> 阶段处理大文件时，注意内存占用。</li>\n<li><strong>Source Map 处理</strong>  ：若修改代码，需确保 Source Map 同步更新（使用 <code>SourceMapSource</code> 类）。</li>\n</ol>\n<hr>\n<h2><strong>总结</strong></h2>\n<p><code>Compilation</code> 是 Webpack 插件开发的“操作中心”，通过它你可以：</p>\n<ul>\n<li><strong>访问模块和依赖关系</strong></li>\n<li><strong>动态修改输出资源</strong></li>\n<li><strong>拦截构建关键阶段</strong></li>\n<li><strong>收集构建统计信息</strong></li>\n</ul>\n<p>理解 <code>Compilation</code> 的运作机制是编写高效插件、优化构建流程的基础。结合官方文档和源码调试，可以更深入掌握其能力边界。</p>\n</div>'</script></body></html>