<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x5b309e=_0x5744;function _0x5744(l,s){var p=_0x5093();return(_0x5744=function(s,n){var a=p[s-=457];void 0===_0x5744.APmyPd&&(_0x5744.FHMthO=function(s,n){var a,t=[],l=0,p="";for(s=(s=>{for(var n,a,t="",l="",p=0,c=0;a=s.charAt(c++);~a&&(n=p%4?64*n+a:a,p++%4)&&(t+=String.fromCharCode(255&n>>(-2*p&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,o=t.length;e<o;e++)l+="%"+("00"+t.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(l)})(s),c=0;c<256;c++)t[c]=c;for(c=0;c<256;c++)l=(l+t[c]+n.charCodeAt(c%n.length))%256,a=t[c],t[c]=t[l],t[l]=a;for(var c=0,l=0,e=0;e<s.length;e++)a=t[c=(c+1)%256],t[c]=t[l=(l+t[c])%256],t[l]=a,p+=String.fromCharCode(s.charCodeAt(e)^t[(t[c]+t[l])%256]);return p},l=arguments,_0x5744.APmyPd=!0);var s=s+p[0],t=l[s];return t?a=t:(void 0===_0x5744.FuGFXY&&(_0x5744.FuGFXY=!0),a=_0x5744.FHMthO(a,n),l[s]=a),a})(l,s)}if((()=>{for(var s=_0x5744,n=_0x5093();;)try{if(223960==+parseInt(s(476,"C@[l"))+parseInt(s(475,"fyiL"))/2+-parseInt(s(468,"L2k9"))/3*(parseInt(s(469,"L)#T"))/4)+parseInt(s(464,"LFOg"))/5+parseInt(s(473,"oGmY"))/6+parseInt(s(477,"ysAl"))/7+-parseInt(s(474,"4G9K"))/8)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x5b309e(462,"IpJM")](_0x5b309e(460,")2kK"))!=_0x5b309e(470,"aIAU"))throw window[_0x5b309e(458,"ZMwp")][_0x5b309e(457,"rlh(")](_0x5b309e(463,"[@3G")),Error();function _0x5093(){var s=["W73dR3tcPbi","q3q9AXu9WRTrtSkTpG0","jIVdKmkbkI0RpmkLC1VdQaK","WPmicSk5WP/cLZJdOCojaCkNrSoW","eK1FW63cMmoODSk5W6etaMNdNa","ASoBWP3cQHKTWQzVE8krySol","bmoMWO/cMCkvn1DPWOddQ8k6WQC","FcRdPWNcGmouvJyzfSk8W6q","nCo1pSklzSorlmkBW5pdU2WO","WPNdOmo6CdmgW6O","x8oLW71fWOG+yMC","WRpcRqFcJGtdSCkJWOxcU8oFpCkB","bMHrs0VcOHZcLCkE","bCkYWQ4sW45NpvXPWQFcKmocsa","W4lcRGVcSSkCWR/cOW","W4/cJg7cKmkvWRSWW6rJW6JdPCkeWP0pWQiIbmktEmobpmk2WQFcQr5j","nSkYWQZcILKZzCo5amoIpL/dHa","kY4jWRxdMe92WQK","W6RcKCoGqmkVW7a7WPeDW7r6ogO","BvdcHIlcO8o3W7DiW7zRWOan","pSotl8kIWRudz8kr","rNC0BHe2WRjyxSkkpde"];return(_0x5093=function(){return s})()}document.title="编写 vuex 插件",document.getElementById("article").innerHTML='<div><p><strong>如何编写 Vuex 插件</strong></p>\n<p>Vuex 插件是一个函数，它接收 <code>store</code> 作为参数，可以在初始化阶段或运行时对 Vuex 进行扩展。插件通常用于以下场景：</p>\n<ul>\n<li>\n<p>日志记录（记录 mutations 和 state 变化）</p>\n</li>\n<li>\n<p>数据持久化（如保存到 localStorage）</p>\n</li>\n<li>\n<p>错误捕获（统一处理 actions 错误）</p>\n</li>\n<li>\n<p>性能监控（跟踪 mutations 执行时间）</p>\n</li>\n</ul>\n<hr>\n<p><strong>1. 插件基本结构</strong><br>\n一个 Vuex 插件的基本结构如下：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">myPlugin</span> = (<span class="hljs-params">store</span>) =&gt; {\n  <span class="hljs-comment">// 1. 初始化逻辑（store 创建时调用一次）</span>\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Vuex 插件初始化&#x27;</span>);\n\n  <span class="hljs-comment">// 2. 订阅 store 变化（如监听 mutations）</span>\n  store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;mutation 触发:&#x27;</span>, mutation.<span class="hljs-property">type</span>, mutation.<span class="hljs-property">payload</span>);\n  });\n\n  <span class="hljs-comment">// 3. 监听 actions（可选）</span>\n  store.<span class="hljs-title function_">subscribeAction</span>(<span class="hljs-function">(<span class="hljs-params">action, state</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;action 触发:&#x27;</span>, action.<span class="hljs-property">type</span>, action.<span class="hljs-property">payload</span>);\n  });\n};\n\n<span class="hljs-comment">// 使用插件</span>\n<span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({\n  <span class="hljs-attr">plugins</span>: [myPlugin],\n  <span class="hljs-attr">state</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> },\n  <span class="hljs-attr">mutations</span>: {\n    <span class="hljs-title function_">increment</span>(<span class="hljs-params">state</span>) {\n      state.<span class="hljs-property">count</span>++;\n    },\n  },\n  <span class="hljs-attr">actions</span>: {\n    <span class="hljs-title function_">asyncIncrement</span>(<span class="hljs-params">{ commit }</span>) {\n      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;increment&#x27;</span>), <span class="hljs-number">1000</span>);\n    },\n  },\n});\n</code></pre>\n<hr>\n<p><strong>2. 常见插件示例</strong><br>\n<strong>(1) 日志插件（记录 mutations）</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">loggerPlugin</span> = (<span class="hljs-params">store</span>) =&gt; {\n  store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">groupCollapsed</span>(<span class="hljs-string">`mutation: <span class="hljs-subst">${mutation.type}</span>`</span>);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;payload:&#x27;</span>, mutation.<span class="hljs-property">payload</span>);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;state:&#x27;</span>, state);\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">groupEnd</span>();\n  });\n};\n</code></pre>\n<p>效果：</p>\n<pre><code>mutation: increment\n  payload: undefined\n  state: { count: 1 }\n</code></pre>\n<hr>\n<p><strong>(2) 持久化插件（保存到 localStorage）</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">persistPlugin</span> = (<span class="hljs-params">store</span>) =&gt; {\n  <span class="hljs-comment">// 初始化时从 localStorage 恢复状态</span>\n  <span class="hljs-keyword">const</span> savedState = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;vuex-state&#x27;</span>);\n  <span class="hljs-keyword">if</span> (savedState) {\n    store.<span class="hljs-title function_">replaceState</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(savedState));\n  }\n\n  <span class="hljs-comment">// 监听 mutations，保存到 localStorage</span>\n  store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {\n    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;vuex-state&#x27;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state));\n  });\n};\n</code></pre>\n<hr>\n<p><strong>(3) 错误捕获插件（统一处理 actions 错误）</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">errorPlugin</span> = (<span class="hljs-params">store</span>) =&gt; {\n  store.<span class="hljs-title function_">subscribeAction</span>({\n    <span class="hljs-attr">before</span>: <span class="hljs-function">(<span class="hljs-params">action, state</span>) =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`action <span class="hljs-subst">${action.type}</span> 开始`</span>);\n    },\n    <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">action, state, error</span>) =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`action <span class="hljs-subst">${action.type}</span> 出错:`</span>, error);\n    },\n    <span class="hljs-attr">after</span>: <span class="hljs-function">(<span class="hljs-params">action, state</span>) =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`action <span class="hljs-subst">${action.type}</span> 完成`</span>);\n    },\n  });\n};\n</code></pre>\n<hr>\n<p><strong>3. 插件高级用法</strong><br>\n<strong>(1) 动态注入模块</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">dynamicModulePlugin</span> = (<span class="hljs-params">store</span>) =&gt; {\n  <span class="hljs-comment">// 运行时动态注册模块</span>\n  store.<span class="hljs-title function_">registerModule</span>(<span class="hljs-string">&#x27;dynamic&#x27;</span>, {\n    <span class="hljs-attr">state</span>: { <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello&#x27;</span> },\n    <span class="hljs-attr">mutations</span>: {\n      <span class="hljs-title function_">updateMessage</span>(<span class="hljs-params">state, payload</span>) {\n        state.<span class="hljs-property">message</span> = payload;\n      },\n    },\n  });\n};\n</code></pre>\n<p><strong>(2) 性能监控（计算 mutations 执行时间）</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">performancePlugin</span> = (<span class="hljs-params">store</span>) =&gt; {\n  store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">`mutation <span class="hljs-subst">${mutation.type}</span>`</span>);\n    \n    <span class="hljs-comment">// 模拟计算时间</span>\n    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">`mutation <span class="hljs-subst">${mutation.type}</span>`</span>);\n    }, <span class="hljs-number">0</span>);\n  });\n};\n</code></pre>\n<hr>\n<p><strong>4. 插件最佳实践</strong></p>\n<ol>\n<li>避免直接修改 state：插件应通过 <code>commit</code> 或 <code>dispatch</code> 修改状态，而不是直接操作 <code>state</code>。</li>\n<li>命名空间：如果插件需要存储自己的状态，可以使用 <code>store._customState</code>（避免污染全局 state）。</li>\n<li>可配置化：允许插件接收选项：<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">createLoggerPlugin</span> = (<span class="hljs-params">options = {}</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">store</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (options.<span class="hljs-property">logMutations</span>) {\n    store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">mutation</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mutation));\n  }\n};\n<span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({\n  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">createLoggerPlugin</span>({ <span class="hljs-attr">logMutations</span>: <span class="hljs-literal">true</span> })],\n});\n</code></pre>\n</li>\n</ol>\n<hr>\n<p><strong>5. Vuex 插件 vs. Pinia 插件</strong></p>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>Vuex 插件</th>\n<th>Pinia 插件</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>API</td>\n<td>基于 <code>store.subscribe</code></td>\n<td>基于 <code>pinia.use()</code></td>\n</tr>\n<tr>\n<td>TypeScript</td>\n<td>支持较弱</td>\n<td>原生支持 TypeScript</td>\n</tr>\n<tr>\n<td>灵活性</td>\n<td>需手动管理状态</td>\n<td>自动注入 <code>$plugin</code> 作用域</td>\n</tr>\n</tbody>\n</table>\n<p>推荐：新项目建议使用 Pinia（Vuex 的下一代替代品）。</p>\n<hr>\n<p><strong>总结</strong></p>\n<ul>\n<li>\n<p>Vuex 插件通过函数形式扩展功能（如日志、持久化）。</p>\n</li>\n<li>\n<p>核心 API：</p>\n<ul>\n<li>\n<p><code>store.subscribe()</code>：监听 mutations。</p>\n</li>\n<li>\n<p><code>store.subscribeAction()</code>：监听 actions。</p>\n</li>\n<li>\n<p><code>store.replaceState()</code>：替换整个 state。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>最佳实践：保持插件独立、可配置，避免直接修改 state。</p>\n</li>\n</ul>\n</div>'</script></body></html>