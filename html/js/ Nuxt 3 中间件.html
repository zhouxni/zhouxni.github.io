<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x43b4e9=_0x4af4;function _0x4af4(e,n){var l=_0x48a3();return(_0x4af4=function(n,s){var t=l[n-=311];void 0===_0x4af4.IttWDU&&(_0x4af4.xPoCcF=function(n,s){var t,a=[],e=0,l="";for(n=(n=>{for(var s,t,a="",e="",l=0,o=0;t=n.charAt(o++);~t&&(s=l%4?64*s+t:t,l++%4)&&(a+=String.fromCharCode(255&s>>(-2*l&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var d=0,p=a.length;d<p;d++)e+="%"+("00"+a.charCodeAt(d).toString(16)).slice(-2);return decodeURIComponent(e)})(n),o=0;o<256;o++)a[o]=o;for(o=0;o<256;o++)e=(e+a[o]+s.charCodeAt(o%s.length))%256,t=a[o],a[o]=a[e],a[e]=t;for(var o=0,e=0,d=0;d<n.length;d++)t=a[o=(o+1)%256],a[o]=a[e=(e+a[o])%256],a[e]=t,l+=String.fromCharCode(n.charCodeAt(d)^a[(a[o]+a[e])%256]);return l},e=arguments,_0x4af4.IttWDU=!0);var n=n+l[0],a=e[n];return a?t=a:(void 0===_0x4af4.xwZNqv&&(_0x4af4.xwZNqv=!0),t=_0x4af4.xPoCcF(t,s),e[n]=t),t})(e,n)}if((()=>{for(var n=_0x4af4,s=_0x48a3();;)try{if(984603==+parseInt(n(335,"SJ[p"))+parseInt(n(324,"es4w"))/2+-parseInt(n(315,"hWVG"))/3*(parseInt(n(328,"R^%S"))/4)+-parseInt(n(323,"FNIq"))/5*(-parseInt(n(321,"RzcK"))/6)+parseInt(n(312,"iBD&"))/7*(parseInt(n(334,"F!Zw"))/8)+parseInt(n(330,"bMba"))/9+-parseInt(n(311,"^(C["))/10)break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x43b4e9(318,"bAMN")](_0x43b4e9(329,"tnU%"))!=_0x43b4e9(336,"q[s#"))throw window[_0x43b4e9(331,"!X4y")][_0x43b4e9(322,"%8z]")](_0x43b4e9(314,"U#c^")),Error();function _0x48a3(){var n=["lmomWRFdLCkmmq3dGcr4wmo5WPdcRW","ySohitmFlXpdVwKeWRhcII4zW4tcHcxdUSk4hmkAWOKbW4CMW4S","x8oRqCkwWPZcHHm","W6JdVSoHWRxdMehcMfWOWRrNWPBcPG","WR8Mimo7W4RcJ8otWO8qEYCJW7RdUW","qGZcLq/cV8kXxW","sCkXWROzC8k7vSo9W4qSy8kw","WRuhwCo7W5NdQ3vlpSoZWOy","WRHuWRZcR8o2zSkqxv1UWOe","rCkcW67dLmkkWPBdKG","W5OkW7BdM2vcWRZcV8oyWOm","lmoEgSkmgGBcNSkQqSo0WP4jeW","a39teM3dSgS","grrSzqLgWR8Q","DmoCW6VdVHirlCo8hCo4duHS","WOj3WO3dK8oxWQyvWQddHxBdOSodna","qtD8EJCMW6K1Aa","W6JdVmoJWRZdKeBcKqKRWR9hWPtcRWC","DSkPWOddOdxcPt7cKa","gHOmntHaWQKAW589","WRddH0ngkf/cOCkKBCoPWRZdVq","DmoCW65WWPldMG0WhSo2fx4","WRZdHCkgWR4YWRxcPmo6xmkOWRmp","W5dcL8oJoSo9","DmoEW6ddVHyEiCkUamoyouDpW74","WR3dI8osi8kQWP/cR3i"];return(_0x48a3=function(){return n})()}document.title=" Nuxt 3 中间件",document.getElementById("article").innerHTML='<div><p>下面给出一份「Nuxt 3 中间件（Middleware）」的系统性指南，涵盖概念、生命周期、所有 API、TypeScript、常见坑与最佳实践。读完即可在任意规模的项目中熟练编写与维护路由中间件。</p>\n<hr>\n<h2>1. 什么是 Nuxt 3 中间件？</h2>\n<ul>\n<li>\n<p><strong>定义</strong><br>\n中间件是一段「在路由真正渲染之前自动执行的函数」，常用于：</p>\n<ul>\n<li>鉴权（未登录则跳转 <code>/login</code>）</li>\n<li>角色权限（Admin / User 路由守卫）</li>\n<li>国际化重定向（<code>/en/dashboard</code> → <code>/zh/dashboard</code>）</li>\n<li>埋点 / 日志 / A/B 测试</li>\n<li>全局 Loading、进度条</li>\n</ul>\n</li>\n<li>\n<p><strong>与 Nuxt 2 的差异</strong></p>\n<table>\n<thead>\n<tr>\n<th>维度</th>\n<th>Nuxt 2</th>\n<th>Nuxt 3</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>文件位置</td>\n<td><code>middleware/</code></td>\n<td><code>middleware/</code>（支持 <code>.js/.ts</code>）</td>\n</tr>\n<tr>\n<td>注册方式</td>\n<td><code>nuxt.config router.middleware</code></td>\n<td><strong>零配置</strong>   ，文件名即中间件名</td>\n</tr>\n<tr>\n<td>执行环境</td>\n<td>仅客户端 / SSR 均可</td>\n<td>两端都执行，可细粒度控制</td>\n</tr>\n<tr>\n<td>写法</td>\n<td><code>export default ({ store, redirect }) =&gt; {}</code></td>\n<td><code>export default defineNuxtRouteMiddleware(to =&gt; {})</code></td>\n</tr>\n</tbody>\n</table>\n</li>\n</ul>\n<hr>\n<h2>2. 文件约定与命名</h2>\n<pre><code>middleware/\n├─ auth.ts           # 全局 / 局部都可调用\n├─ admin-only.ts     # 仅部分路由使用\n└─ deep/\n   └─ log.ts         # 支持子目录\n</code></pre>\n<blockquote>\n<p>中间件名 = 文件名（不含后缀）。<br>\n不需要在 <code>nuxt.config</code> 中声明，Nuxt 3 自动扫描。</p>\n</blockquote>\n<hr>\n<h2>3. 三种作用域</h2>\n<table>\n<thead>\n<tr>\n<th>作用域</th>\n<th>声明位置</th>\n<th>优先级</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>全局</strong></td>\n<td><code>nuxt.config.ts</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td><strong>页面级</strong></td>\n<td>页面组件 <code>definePageMeta({ middleware: \'auth\' })</code></td>\n<td>2</td>\n</tr>\n<tr>\n<td><strong>布局级</strong></td>\n<td>布局组件 <code>definePageMeta({ middleware: \'auth\' })</code></td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2>4. 最小可运行示例</h2>\n<h3>4.1 定义中间件</h3>\n<p><code>middleware/auth.ts</code></p>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtRouteMiddleware</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&quot;user&quot;</span>); <span class="hljs-comment">// 或 useAuthStore() ...</span>\n  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">value</span>?.<span class="hljs-property">isLoggedIn</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title function_">navigateTo</span>(<span class="hljs-string">&quot;/login?redirect=&quot;</span> + <span class="hljs-built_in">encodeURIComponent</span>(to.<span class="hljs-property">fullPath</span>));\n  }\n});\n</code></pre>\n<h3>4.2 全局注册</h3>\n<p><code>nuxt.config.ts</code></p>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({\n  <span class="hljs-comment">// 等价于所有页面都添加 auth 中间件</span>\n  <span class="hljs-attr">routeRules</span>: {\n    <span class="hljs-string">&quot;/**&quot;</span>: { <span class="hljs-attr">middleware</span>: <span class="hljs-string">&quot;auth&quot;</span> },\n  },\n});\n</code></pre>\n<blockquote>\n<p>更推荐在页面 / 布局级按需使用，性能更好。</p>\n</blockquote>\n<h3>4.3 页面级使用</h3>\n<p><code>pages/dashboard.vue</code></p>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript">\n  <span class="hljs-title function_">definePageMeta</span>({\n    <span class="hljs-attr">middleware</span>: [<span class="hljs-string">&quot;auth&quot;</span>, <span class="hljs-string">&quot;admin-only&quot;</span>],\n  });\n</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>\n</code></pre>\n<hr>\n<h2>5. 函数签名详解</h2>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtRouteMiddleware</span>(<span class="hljs-title function_">async</span> (to, <span class="hljs-keyword">from</span>) =&gt; {\n  <span class="hljs-comment">// 1. 组合式函数随意用</span>\n  <span class="hljs-keyword">const</span> config = <span class="hljs-title function_">useRuntimeConfig</span>();\n  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">&quot;/api/me&quot;</span>);\n\n  <span class="hljs-comment">// 2. 终止后续渲染</span>\n  <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> <span class="hljs-title function_">navigateTo</span>(<span class="hljs-string">&quot;/login&quot;</span>);\n\n  <span class="hljs-comment">// 3. 404</span>\n  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">isAdmin</span> &amp;&amp; to.<span class="hljs-property">path</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;/admin&quot;</span>))\n    <span class="hljs-keyword">return</span> <span class="hljs-title function_">abortNavigation</span>({ <span class="hljs-attr">statusCode</span>: <span class="hljs-number">403</span> });\n\n  <span class="hljs-comment">// 4. 什么都不返回 → 继续</span>\n});\n</code></pre>\n<hr>\n<h2>6. 常用 API</h2>\n<table>\n<thead>\n<tr>\n<th>API</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>navigateTo(\'/url\')</code></td>\n<td>重定向（内部 / 外部均可）</td>\n</tr>\n<tr>\n<td><code>abortNavigation()</code></td>\n<td>中断导航并抛出 404/403/500</td>\n</tr>\n<tr>\n<td><code>setPageLayout(\'error\')</code></td>\n<td>动态切换布局</td>\n</tr>\n<tr>\n<td><code>setResponseStatus(404)</code></td>\n<td>SSR 时设置 HTTP 状态码</td>\n</tr>\n<tr>\n<td><code>useRequestHeaders()</code></td>\n<td>获取 Cookie / Authorization</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2>7. 服务端 vs 客户端</h2>\n<ul>\n<li>默认<strong>两端都执行</strong>   ；若需要仅在客户端，用 <code>process.client</code> 判断。</li>\n</ul>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtRouteMiddleware</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">client</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;仅在浏览器打印&quot;</span>);\n  }\n});\n</code></pre>\n<hr>\n<h2>8. 中间件可异步 / 并行</h2>\n<ul>\n<li>多个中间件按数组顺序<strong>串行</strong>   执行</li>\n<li>每个中间件内部可 <code>await</code>，Nuxt 会等待 Promise 完成</li>\n</ul>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtRouteMiddleware</span>(<span class="hljs-title function_">async</span> () =&gt; {\n  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">1000</span>)); <span class="hljs-comment">// 模拟接口</span>\n});\n</code></pre>\n<hr>\n<h2>9. 动态注册中间件（运行时）</h2>\n<p>Nuxt 3 支持在插件或布局中<strong>动态添加 / 移除</strong>   中间件：</p>\n<pre><code class="language-ts"><span class="hljs-comment">// plugins/add-middleware.ts</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-title function_">addRouteMiddleware</span>(\n    <span class="hljs-string">&quot;global-auth&quot;</span>,\n    <span class="hljs-function">() =&gt;</span> {\n      <span class="hljs-comment">// 动态中间件逻辑</span>\n    },\n    { <span class="hljs-attr">global</span>: <span class="hljs-literal">true</span> },\n  );\n});\n</code></pre>\n<hr>\n<h2>10. TypeScript 类型增强</h2>\n<p><code>types/middleware.d.ts</code></p>\n<pre><code class="language-ts"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&quot;#app&quot;</span> {\n  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PageMeta</span> {\n    <span class="hljs-attr">middleware</span>?: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">string</span>[];\n  }\n}\n</code></pre>\n<hr>\n<h2>11. 常见坑 &amp; 解决</h2>\n<table>\n<thead>\n<tr>\n<th>现象</th>\n<th>原因</th>\n<th>解决</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>中间件不生效</td>\n<td>文件放在错误目录 / 文件名大小写</td>\n<td>确保 <code>middleware/*.ts</code></td>\n</tr>\n<tr>\n<td>无限重定向循环</td>\n<td><code>navigateTo</code> 又匹配到同一中间件</td>\n<td>加条件判断 <code>to.path !== \'/login\'</code></td>\n</tr>\n<tr>\n<td>服务端 500 但客户端正常</td>\n<td>中间件里用了 <code>window</code></td>\n<td>用 <code>process.client</code> 包裹</td>\n</tr>\n<tr>\n<td>类型提示丢失</td>\n<td>没写 <code>declare module \'#app\'</code></td>\n<td>见第 10 节</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2>12. 最佳实践清单</h2>\n<p>✅ 用 <code>defineNuxtRouteMiddleware</code> 保证类型安全<br>\n✅ 鉴权中间件尽量在页面级使用，避免全局性能损耗<br>\n✅ 服务端敏感逻辑（Cookie 解析）放在中间件而不是客户端<br>\n✅ 不要把大段业务逻辑写在中间件，抽成 Composable（如 <code>useAuth()</code>）<br>\n✅ 需要服务端 404/403 时，务必 <code>abortNavigation({ statusCode: 404 })</code><br>\n✅ 与 Pinia stores 组合：<code>const auth = useAuthStore()</code> 直接可用</p>\n<hr>\n<h2>13. 完整范例仓库</h2>\n<p>GitHub 官方示例：<br>\nhttps://github.com/nuxt/examples/tree/main/features/middleware</p>\n<hr>\n<p>至此，你已掌握 Nuxt 3 中间件的全部核心能力。Happy coding!</p>\n</div>'</script></body></html>