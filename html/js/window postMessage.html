<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0xe04b(l,s){var t=_0xcb3f();return(_0xe04b=function(s,n){var a=t[s-=266];void 0===_0xe04b.PksmZT&&(_0xe04b.uLAeVm=function(s,n){var a,e=[],l=0,t="";for(s=(s=>{for(var n,a,e="",l="",t=0,p=0;a=s.charAt(p++);~a&&(n=t%4?64*n+a:a,t++%4)&&(e+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,r=e.length;o<r;o++)l+="%"+("00"+e.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(l)})(s),p=0;p<256;p++)e[p]=p;for(p=0;p<256;p++)l=(l+e[p]+n.charCodeAt(p%n.length))%256,a=e[p],e[p]=e[l],e[l]=a;for(var p=0,l=0,o=0;o<s.length;o++)a=e[p=(p+1)%256],e[p]=e[l=(l+e[p])%256],e[l]=a,t+=String.fromCharCode(s.charCodeAt(o)^e[(e[p]+e[l])%256]);return t},l=arguments,_0xe04b.PksmZT=!0);var s=s+t[0],e=l[s];return e?a=e:(void 0===_0xe04b.sRdTbE&&(_0xe04b.sRdTbE=!0),a=_0xe04b.uLAeVm(a,n),l[s]=a),a})(l,s)}var _0xf958c6=_0xe04b;if((()=>{for(var s=_0xe04b,n=_0xcb3f();;)try{if(141440==-parseInt(s(273,"xq3*"))*(parseInt(s(270,"lUBq"))/2)+parseInt(s(292,"nn&M"))/3*(parseInt(s(290,"Tif4"))/4)+parseInt(s(283,"@@Mw"))/5+-parseInt(s(267,"W[&G"))/6+parseInt(s(279,"ckSF"))/7+parseInt(s(286,"I^J4"))/8*(parseInt(s(266,"p*X7"))/9)+parseInt(s(281,"OPEN"))/10*(-parseInt(s(278,"w]iy"))/11))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0xf958c6(285,"KEqN")](_0xf958c6(287,"xq3*"))!=_0xf958c6(274,"$Tli"))throw window[_0xf958c6(276,"&#**")][_0xf958c6(291,"IdfW")](_0xf958c6(275,"xq3*")),Error();function _0xcb3f(){var s=["afOaWRFdMSkGWPy","A03cS1dcNGFdMG","qsxdPmkEaSo6EubEW5ZcSWq","yM7dK8koW5VcICkFkSo9W63dTWa","WRldGHiFW7zBzmoMAZ94jW","bmkDWRZdU2fbb8oUWQ7cQhG","CHldQCk4W4tdGSkHcLFdOa","W7ddS03dMKNdLCo2WOeE","WRRcG8kermkLyuG0W6q","aSkFWRtdVwq0fmoKWOpcIePk","x8owiSoUWRZcNY8yWP4","qSkDW5ddQZ0","bCkAzCoXWQ7dN3rJWRdcNZJdMZeKW7FcRSo8W6ZcOmo1W4dcNCoKzKhcKa","wCocW6FcRIvToSoW","WR/cGCkejmoWe1ieW4GPhmk7","W51RW60+u8kpWQdcQK/dTa","WP3dUmk7mSojEXOOFGSTpN4","CHFdP8k6WRJcRCklcetdHSoJW7i","WRfHW7v0DCkzqqHZWQ5K","WQVdRCofWPf6W6eT","WOBdKSkhcSoThK10W6CQWROt","zCoYv8kaW4C/W4lcR8kK","jdX7FKGNW68","W4xcGIr9W5aRWRn8","lmknCSoKWQ7cLHaPWRm","a8oFWPVcOxFcL8k1W4BcSMbPWQCt","WOVdIttdR8oqW7LKW5LNWPBcNCkT"];return(_0xcb3f=function(){return s})()}document.title="window postMessage",document.getElementById("article").innerHTML='<div><p><code>window.postMessage</code> 是一种强大的 API，用于在不同窗口（如 iframe、弹出窗口）或不同源（跨域）的页面之间安全地传递消息。它提供了一种灵活且安全的方式来实现跨窗口通信，避免了传统跨域通信的诸多限制。</p>\n<hr>\n<h3><strong>1. 基本概念</strong></h3>\n<ul>\n<li><strong>跨窗口通信</strong>  ：<code>postMessage</code> 允许一个窗口向另一个窗口发送消息，即使它们不在同一个源（域名、协议、端口）下。</li>\n<li><strong>安全性</strong>  ：通过指定目标窗口的源，<code>postMessage</code> 确保了消息只会被发送到可信任的接收方，防止了跨站脚本攻击（XSS）。</li>\n<li><strong>异步通信</strong>  ：消息传递是异步的，不会阻塞发送方的执行。</li>\n</ul>\n<hr>\n<h3><strong>2. 工作原理</strong></h3>\n<ul>\n<li><strong>发送消息</strong>  ：使用 <code>window.postMessage(message, targetOrigin)</code> 方法发送消息。\n<ul>\n<li><code>message</code>：要发送的数据，可以是字符串、对象等。</li>\n<li><code>targetOrigin</code>：指定消息的目标源，可以是具体的 URL（如 <code>\'https://example.com\'</code>），也可以是通配符 <code>\'*\'</code>（表示不限制目标源，但存在安全风险）。</li>\n</ul>\n</li>\n<li><strong>接收消息</strong>  ：在目标窗口中，通过监听 <code>message</code> 事件来接收消息。\n<ul>\n<li><code>event.data</code>：接收到的消息内容。</li>\n<li><code>event.origin</code>：发送消息的窗口的源，用于验证消息的来源。</li>\n<li><code>event.source</code>：发送消息的窗口的引用，可用于回复消息。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3><strong>3. 使用示例</strong></h3>\n<h4><strong>3.1 同源通信</strong></h4>\n<p><strong>主窗口代码</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;myIframe&#x27;</span>);\n\n<span class="hljs-comment">// 向 iframe 发送消息</span>\niframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&#x27;Hello from parent!&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>);\n\n<span class="hljs-comment">// 监听来自 iframe 的消息</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">&#x27;https://example.com&#x27;</span>) {\n    <span class="hljs-comment">// 验证消息来源</span>\n    <span class="hljs-keyword">return</span>;\n  }\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received from iframe:&#x27;</span>, event.<span class="hljs-property">data</span>);\n});\n</code></pre>\n<p><strong>iframe 代码</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// 监听来自父窗口的消息</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">&#x27;https://example.com&#x27;</span>) {\n    <span class="hljs-comment">// 验证消息来源</span>\n    <span class="hljs-keyword">return</span>;\n  }\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received from parent:&#x27;</span>, event.<span class="hljs-property">data</span>);\n\n  <span class="hljs-comment">// 回复消息给父窗口</span>\n  event.<span class="hljs-property">source</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&#x27;Hello from iframe!&#x27;</span>, event.<span class="hljs-property">origin</span>);\n});\n</code></pre>\n<p><strong>解释</strong>  ：</p>\n<ul>\n<li>主窗口向 iframe 发送消息，并监听来自 iframe 的消息。</li>\n<li>iframe 接收消息后，验证来源，并回复消息给主窗口。</li>\n</ul>\n<hr>\n<h4><strong>3.2 跨域通信</strong></h4>\n<p><strong>主窗口代码（https://domain1.com）</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;myIframe&#x27;</span>);\n\n<span class="hljs-comment">// 向跨域的 iframe 发送消息</span>\niframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&#x27;Hello from domain1!&#x27;</span>, <span class="hljs-string">&#x27;https://domain2.com&#x27;</span>);\n\n<span class="hljs-comment">// 监听来自 iframe 的消息</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">&#x27;https://domain2.com&#x27;</span>) {\n    <span class="hljs-comment">// 验证消息来源</span>\n    <span class="hljs-keyword">return</span>;\n  }\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received from domain2:&#x27;</span>, event.<span class="hljs-property">data</span>);\n});\n</code></pre>\n<p><strong>iframe 代码（https://domain2.com）</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// 监听来自主窗口的消息</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">&#x27;https://domain1.com&#x27;</span>) {\n    <span class="hljs-comment">// 验证消息来源</span>\n    <span class="hljs-keyword">return</span>;\n  }\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received from domain1:&#x27;</span>, event.<span class="hljs-property">data</span>);\n\n  <span class="hljs-comment">// 回复消息给主窗口</span>\n  event.<span class="hljs-property">source</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&#x27;Hello from domain2!&#x27;</span>, event.<span class="hljs-property">origin</span>);\n});\n</code></pre>\n<p><strong>解释</strong>  ：</p>\n<ul>\n<li>主窗口和 iframe 分别位于不同的域，通过 <code>postMessage</code> 实现跨域通信。</li>\n<li>双方都需要验证消息的来源，确保通信的安全性。</li>\n</ul>\n<hr>\n<h3><strong>4. 安全性考虑</strong></h3>\n<ul>\n<li><strong>验证来源</strong>  ：始终验证 <code>event.origin</code>，确保消息来自可信任的源。</li>\n<li><strong>限制目标源</strong>  ：在发送消息时，尽量指定具体的 <code>targetOrigin</code>，避免使用通配符 <code>\'*\'</code>。</li>\n<li><strong>敏感数据处理</strong>  ：避免在消息中传递敏感信息，如果必须传递，确保使用加密或其他安全措施。</li>\n</ul>\n<hr>\n<h3><strong>5. 适用场景</strong></h3>\n<ul>\n<li><strong>跨域数据共享</strong>  ：在不同域的页面之间安全地传递数据。</li>\n<li><strong>嵌入内容通信</strong>  ：主页面与嵌入的 iframe、弹出窗口等进行通信。</li>\n<li><strong>微前端架构</strong>  ：在微前端应用中，不同微应用之间通过 <code>postMessage</code> 进行通信。</li>\n</ul>\n<hr>\n<h3><strong>6. 与其他通信方式的比较</strong></h3>\n<ul>\n<li><strong><code>localStorage</code> 和 <code>sessionStorage</code></strong>  ：\n<ul>\n<li><strong>用途</strong>  ：用于在同一域的不同窗口之间共享数据。</li>\n<li><strong>限制</strong>  ：不支持跨域通信，且需要轮询机制来检测数据变化。</li>\n</ul>\n</li>\n<li><strong><code>cookie</code></strong>  ：\n<ul>\n<li><strong>用途</strong>  ：用于在不同页面之间共享数据。</li>\n<li><strong>限制</strong>  ：存在大小限制，且每次请求都会携带，增加网络开销。</li>\n</ul>\n</li>\n<li><strong><code>postMessage</code></strong>  ：\n<ul>\n<li><strong>用途</strong>  ：用于跨窗口、跨域的安全通信。</li>\n<li><strong>优势</strong>  ：支持异步通信，安全性高，灵活性好。</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3><strong>7. 高级用法</strong></h3>\n<ul>\n<li><strong>与 Web Worker 结合</strong>  ：虽然 <code>postMessage</code> 主要用于窗口间通信，但也可以与 Web Worker 结合使用，实现主线程与工作线程之间的通信。</li>\n<li><strong>结构化克隆算法</strong>  ：<code>postMessage</code> 使用结构化克隆算法来传递数据，支持复制大多数数据类型，但某些对象（如函数、DOM 节点）无法被克隆。</li>\n</ul>\n<hr>\n<h3><strong>8. 示例：跨域身份验证</strong></h3>\n<p><strong>场景</strong>  ：一个嵌入了第三方登录组件的页面，需要与第三方页面进行身份验证信息的传递。</p>\n<p><strong>主页面代码</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;loginIframe&#x27;</span>);\n\n<span class="hljs-comment">// 向第三方 iframe 发送身份验证请求</span>\niframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&#x27;requestAuth&#x27;</span>, <span class="hljs-string">&#x27;https://thirdparty.com&#x27;</span>);\n\n<span class="hljs-comment">// 监听身份验证结果</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">&#x27;https://thirdparty.com&#x27;</span>) {\n    <span class="hljs-keyword">return</span>;\n  }\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;authResult&#x27;</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Authentication result:&#x27;</span>, event.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>);\n  }\n});\n</code></pre>\n<p><strong>第三方 iframe 代码</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// 监听身份验证请求</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">&#x27;https://yourdomain.com&#x27;</span>) {\n    <span class="hljs-keyword">return</span>;\n  }\n  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span> === <span class="hljs-string">&#x27;requestAuth&#x27;</span>) {\n    <span class="hljs-comment">// 模拟身份验证过程</span>\n    <span class="hljs-keyword">const</span> token = <span class="hljs-string">&#x27;exampleAuthToken&#x27;</span>;\n    event.<span class="hljs-property">source</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;authResult&#x27;</span>, token }, event.<span class="hljs-property">origin</span>);\n  }\n});\n</code></pre>\n<p><strong>解释</strong>  ：</p>\n<ul>\n<li>主页面向第三方 iframe 发送身份验证请求。</li>\n<li>第三方 iframe 接收请求后，进行身份验证，并将结果发送回主页面。</li>\n<li>主页面验证消息来源，并处理身份验证结果。</li>\n</ul>\n<hr>\n<h3><strong>9. 总结</strong></h3>\n<p><code>window.postMessage</code> 是一种强大且灵活的 API，用于在不同窗口或不同源的页面之间安全地传递消息。通过合理使用 <code>postMessage</code>，开发者可以实现复杂的跨窗口通信需求，同时确保通信的安全性。在使用时，务必注意验证消息的来源，避免潜在的安全风险。</p>\n</div>'</script></body></html>