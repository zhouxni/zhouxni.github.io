<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x341990=_0x3e2f;function _0x32d5(){var s=["WRdcM8oXBwpdTmkuW74WvGzvBa","b8kvW43cOCkWWRXHzmooW5KaWR3dMW","W7hdI8kSW4rHDCoQWPGmW6HcW50","W79zqHaiWPWqumoeW4eL","WRlcLSo2ygBdSmkCW70hErTwDW","W7OjvepcNh/dIeVcOG","WQ0IxSoXW7pdQmocWOby","W6qFexuZoqq","WQWMv8kfWRlcV8k1WQvDwsG5uq","W5mXW7HKWRyFzSoIxHVcKG","FbXtW6iYEaLOW6ZdLeNcOmot","W4XCl8kNha","vM3cRmk0jmoXWRpdGmktW4CNWRtcMW","WOlcN8kwW7lcTGBcOCkebW","WQNdHmk+W4RcJhb6W54OWQCeiGu","eJzsFNS7W67dNa","vwJcQmkXiCkzW4xdSSk1W5me","u23cR8k1i8kVW5/dPCkWW40M","q8obe1pdI8kzW60rW4KYfSosWPtcSK3dJcBdRuGmz3Sbv8k7WQ8","W6JdGSk5vmkIvmkaW48","WPVcKCozxupcGCocWQu","W6BcQmkYWQCklNv4W70IWQJdGW","W4Kpr0RcJM/dPG","qSovWR9ZW6CWW5W","WRXFWPpdVCkCW65mW4ZcTwBcLg3cQa","W5FcPbyKW5qkWRa","WQehW7NcPmk2WPddMuu","WRBcL8kmdXxcV8owW7y"];return(_0x32d5=function(){return s})()}function _0x3e2f(p,s){var t=_0x32d5();return(_0x3e2f=function(s,a){var n=t[s-=489];void 0===_0x3e2f.JHqzis&&(_0x3e2f.EoaQqQ=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,c=0;n=s.charAt(c++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var e=0,h=l.length;e<h;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+a.charCodeAt(c%a.length))%256,n=l[c],l[c]=l[p],l[p]=n;for(var c=0,p=0,e=0;e<s.length;e++)n=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(e)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x3e2f.JHqzis=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x3e2f.nfNeLV&&(_0x3e2f.nfNeLV=!0),n=_0x3e2f.EoaQqQ(n,a),p[s]=n),n})(p,s)}if((()=>{for(var s=_0x3e2f,a=_0x32d5();;)try{if(753781==-parseInt(s(499,"YCbV"))*(parseInt(s(503,"w)o("))/2)+parseInt(s(493,"RA%1"))/3*(-parseInt(s(509,"1zYD"))/4)+parseInt(s(502,"bnnv"))/5+parseInt(s(495,"R7HQ"))/6*(parseInt(s(512,"6bs*"))/7)+parseInt(s(516,"TKO1"))/8+-parseInt(s(497,"Hx&k"))/9*(-parseInt(s(510,"Y6Y["))/10)+-parseInt(s(490,"R7HQ"))/11)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x341990(501,"dcQj")](_0x341990(511,"Gjb*"))!=_0x341990(489,"@zYW"))throw window[_0x341990(504,"2Dw1")][_0x341990(500,"Gjb*")](_0x341990(496,"$b4H")),Error();document.title="Vue 3 的 Patch Flags 机制详解",document.getElementById("article").innerHTML='<div><p>Patch Flags 是 Vue 3 在虚拟 DOM diff 算法中引入的重要优化机制，它通过标记动态节点的更新类型，大幅提升了 diff 过程的效率。</p>\n<h2>核心概念</h2>\n<h3>1. 什么是 Patch Flags</h3>\n<p>Patch Flags 是<strong>位掩码（bitmask）</strong>   形式的标记，用于标识虚拟 DOM 节点中哪些部分是动态的（可能会变化的）以及变化的具体类型。</p>\n<h3>2. 解决的问题</h3>\n<ul>\n<li>避免不必要的全量 diff</li>\n<li>快速识别需要更新的节点部分</li>\n<li>减少虚拟 DOM 比对的开销</li>\n</ul>\n<h2>Patch Flags 的类型</h2>\n<p>Vue 3 定义了多种 Patch Flags，以下是主要类型：</p>\n<pre><code class="language-typescript"><span class="hljs-comment">// 源码中的定义 (runtime-core/src/patchFlags.ts)</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">PatchFlags</span> {\n  <span class="hljs-variable constant_">TEXT</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">// 动态文本内容</span>\n  <span class="hljs-variable constant_">CLASS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>, <span class="hljs-comment">// 动态 class</span>\n  <span class="hljs-variable constant_">STYLE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>, <span class="hljs-comment">// 动态 style</span>\n  <span class="hljs-variable constant_">PROPS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>, <span class="hljs-comment">// 动态 props (不包括 class/style)</span>\n  <span class="hljs-variable constant_">FULL_PROPS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>, <span class="hljs-comment">// 动态 props (需要完整比较)</span>\n  <span class="hljs-variable constant_">HYDRATE_EVENTS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>, <span class="hljs-comment">// 带事件监听器</span>\n  <span class="hljs-variable constant_">STABLE_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>, <span class="hljs-comment">// 子节点顺序不变的 Fragment</span>\n  <span class="hljs-variable constant_">KEYED_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>, <span class="hljs-comment">// 带 key 的 Fragment</span>\n  <span class="hljs-variable constant_">UNKEYED_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>, <span class="hljs-comment">// 不带 key 的 Fragment</span>\n  <span class="hljs-variable constant_">NEED_PATCH</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>, <span class="hljs-comment">// 需要非 props 的 patching</span>\n  <span class="hljs-variable constant_">DYNAMIC_SLOTS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">10</span>, <span class="hljs-comment">// 动态插槽</span>\n  <span class="hljs-variable constant_">HOISTED</span> = -<span class="hljs-number">1</span>, <span class="hljs-comment">// 静态节点 (提升过)</span>\n  <span class="hljs-variable constant_">BAIL</span> = -<span class="hljs-number">2</span>, <span class="hljs-comment">// diff 应退出的特殊情况</span>\n}\n</code></pre>\n<h2>工作原理</h2>\n<h3>1. 编译阶段标记</h3>\n<p>在模板编译阶段，编译器会分析模板并标记动态部分：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// 模板示例</span>\n&lt;div :<span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;{ active: isActive }&quot;</span> :style=<span class="hljs-string">&quot;styles&quot;</span>&gt;\n  {{ message }}\n&lt;/div&gt;\n\n<span class="hljs-comment">// 生成的代码包含 patchFlag</span>\n<span class="hljs-keyword">const</span> _hoisted_1 = { <span class="hljs-attr">class</span>: <span class="hljs-string">&quot;container&quot;</span> }\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache</span>) {\n  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createBlock</span>(<span class="hljs-string">&quot;div&quot;</span>, {\n    <span class="hljs-attr">class</span>: <span class="hljs-title function_">_normalizeClass</span>({ <span class="hljs-attr">active</span>: _ctx.<span class="hljs-property">isActive</span> }),\n    <span class="hljs-attr">style</span>: <span class="hljs-title function_">_normalizeStyle</span>(_ctx.<span class="hljs-property">styles</span>),\n    <span class="hljs-comment">// 标记为 CLASS + STYLE + TEXT (1 + 2 + 4 = 7)</span>\n    <span class="hljs-attr">patchFlag</span>: <span class="hljs-number">7</span>\n  }, <span class="hljs-title function_">_toDisplayString</span>(_ctx.<span class="hljs-property">message</span>), <span class="hljs-number">1</span> <span class="hljs-comment">/* TEXT */</span>))\n}\n</code></pre>\n<h3>2. Diff 阶段优化</h3>\n<p>在虚拟 DOM diff 时，根据 patchFlag 跳过不必要的检查：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// 伪代码演示 diff 过程</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">patchElement</span>(<span class="hljs-params">n1, n2</span>) {\n  <span class="hljs-keyword">const</span> { patchFlag } = n2;\n\n  <span class="hljs-comment">// 如果有 patchFlag，只检查标记的部分</span>\n  <span class="hljs-keyword">if</span> (patchFlag &gt; <span class="hljs-number">0</span>) {\n    <span class="hljs-keyword">if</span> (patchFlag &amp; <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">CLASS</span>) {\n      <span class="hljs-title function_">updateClass</span>(n1, n2);\n    }\n    <span class="hljs-keyword">if</span> (patchFlag &amp; <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">STYLE</span>) {\n      <span class="hljs-title function_">updateStyle</span>(n1, n2);\n    }\n    <span class="hljs-keyword">if</span> (patchFlag &amp; <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">TEXT</span>) {\n      <span class="hljs-title function_">updateText</span>(n1, n2);\n    }\n    <span class="hljs-comment">// ...其他标志检查</span>\n  } <span class="hljs-keyword">else</span> {\n    <span class="hljs-comment">// 没有 patchFlag，需要全量比较</span>\n    <span class="hljs-title function_">fullDiff</span>(n1, n2);\n  }\n}\n</code></pre>\n<h2>实际应用示例</h2>\n<h3>1. 静态提升 + Patch Flags</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 模板</span>\n&lt;div&gt;\n  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>静态内容<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>\n  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">&quot;dynamicClass&quot;</span>&gt;</span>{{ dynamicText }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>\n&lt;/div&gt;\n\n<span class="hljs-comment">// 编译结果</span>\n<span class="hljs-keyword">const</span> _hoisted_1 = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-title function_">_createElementVNode</span>(\n  <span class="hljs-string">&quot;span&quot;</span>,\n  <span class="hljs-literal">null</span>,\n  <span class="hljs-string">&quot;静态内容&quot;</span>,\n  -<span class="hljs-number">1</span> <span class="hljs-comment">/* HOISTED */</span>\n)\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache</span>) {\n  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">&quot;div&quot;</span>, <span class="hljs-literal">null</span>, [\n    _hoisted_1,\n    <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">&quot;span&quot;</span>, {\n      <span class="hljs-attr">class</span>: <span class="hljs-title function_">_normalizeClass</span>(_ctx.<span class="hljs-property">dynamicClass</span>)\n    }, <span class="hljs-title function_">_toDisplayString</span>(_ctx.<span class="hljs-property">dynamicText</span>), <span class="hljs-number">3</span> <span class="hljs-comment">/* TEXT, CLASS */</span>)\n  ]))\n}\n</code></pre>\n<h3>2. 组合 Flags</h3>\n<p>多个动态属性时，flags 会进行位运算组合：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// CLASS (1) + STYLE (2) + TEXT (4) = 7</span>\n<span class="hljs-attr">patchFlag</span>: <span class="hljs-number">7</span>;\n\n<span class="hljs-comment">// PROPS (8) + TEXT (1) = 9</span>\n<span class="hljs-attr">patchFlag</span>: <span class="hljs-number">9</span>;\n</code></pre>\n<h2>性能优势</h2>\n<ol>\n<li><strong>精准更新</strong>   ：只更新标记的动态部分</li>\n<li><strong>跳过静态节点</strong>   ：静态节点被提升后完全跳过 diff</li>\n<li><strong>减少比较次数</strong>   ：避免全量属性比较</li>\n<li><strong>更快的首次渲染</strong>   ：静态节点在渲染函数外创建</li>\n</ol>\n<h2>开发者注意事项</h2>\n<ol>\n<li><strong>key 的使用仍然重要</strong>   ：对于列表项，key 帮助识别节点身份</li>\n<li><strong>避免不必要的动态绑定</strong>   ：过多的动态绑定会降低优化效果</li>\n<li><strong>理解 HOISTED 标记</strong>   ：静态节点会被提升到渲染函数外部</li>\n<li><strong>组合 API 中的优化</strong>   ：<code>setup()</code> 中的响应式数据自动受益于 patch flags</li>\n</ol>\n<p>Patch Flags 机制是 Vue 3 性能显著提升的关键技术之一，与静态提升、Tree Shaking 等优化共同作用，使得 Vue 3 在保持响应式优势的同时，达到了接近原生 JavaScript 的性能表现。</p>\n</div>'</script></body></html>