<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x2225a4=_0x4066;function _0x4066(p,s){var e=_0xbf29();return(_0x4066=function(s,n){var a=e[s-=265];void 0===_0x4066.TgdbPs&&(_0x4066.cMbyhv=function(s,n){var a,t=[],p=0,e="";for(s=(s=>{for(var n,a,t="",p="",e=0,l=0;a=s.charAt(l++);~a&&(n=e%4?64*n+a:a,e++%4)&&(t+=String.fromCharCode(255&n>>(-2*e&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=t.length;c<o;c++)p+="%"+("00"+t.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),l=0;l<256;l++)t[l]=l;for(l=0;l<256;l++)p=(p+t[l]+n.charCodeAt(l%n.length))%256,a=t[l],t[l]=t[p],t[p]=a;for(var l=0,p=0,c=0;c<s.length;c++)a=t[l=(l+1)%256],t[l]=t[p=(p+t[l])%256],t[p]=a,e+=String.fromCharCode(s.charCodeAt(c)^t[(t[l]+t[p])%256]);return e},p=arguments,_0x4066.TgdbPs=!0);var s=s+e[0],t=p[s];return t?a=t:(void 0===_0x4066.MSyvlB&&(_0x4066.MSyvlB=!0),a=_0x4066.cMbyhv(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x4066,n=_0xbf29();;)try{if(471625==+parseInt(s(276,"2Ly["))+parseInt(s(279,"d5rC"))/2+-parseInt(s(269,"&Bf]"))/3*(-parseInt(s(288,"2Ly["))/4)+parseInt(s(271,"o[O2"))/5*(-parseInt(s(287,"A&aQ"))/6)+-parseInt(s(290,"JDg^"))/7*(parseInt(s(282,"&Bf]"))/8)+-parseInt(s(273,"foHN"))/9+parseInt(s(265,"ANm&"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x2225a4(275,"UpdD")](_0x2225a4(272,"o[O2"))!=_0x2225a4(285,"d%80"))throw window[_0x2225a4(278,"Y*1^")][_0x2225a4(267,"a@uN")](_0x2225a4(289,"gtG9")),Error();function _0xbf29(){var s=["AtJdNN0RwxFdQfDD","zqdcI1GuWR7dVZbedCo7tey","W4/dV8oIqSossh1Z","WRVcQCojC8osuMrHW6K","jSo+WRFcImozWRvDamoIWO1zdSox","fSkxWQf4aCofodxdRxn+","tmoYW4lcNsRcVSou","ouZdKgpcSX/dNadcRSobWOJcVG","W454yGldK210zta","W5VcNr/dNSktW7lcTKu","cr4LWPDiW6ddMsZdOqJdQe4","WRSVWOShB3/cOZWbWQhdT8oh","g1TpW6GjqMeHWQqi","AZ/dNrGaEM3dNhC","fIe9c2xcHSkZrmo6tmoWda","d8ovDKaoWR0khmkeiNddOa","W6ykW7NcHaW","WPJdLKlcSGZcTmoeWRlcKSkkEgDZWPC","W4SDdY3cH8kAWQxdNSkudL/cPa","ouNcIJBdSLddGI0","WQtcTNH+FSkAFmkhWQpdR0GUFeDXWRiwm8oqnCkkWOWaW4dcLwK","hfLjW6jcv1OvWQ4Pbq","WQdcLSkmW5e/W6lcVSk1WOCdW5ddMXxcPG","BaBdKWTuW7VcUb4","WRmaWRpcVSocWRxdOG","W5FcNaFcHG1gAmov"];return(_0xbf29=function(){return s})()}document.title="pinia 原理详解",document.getElementById("article").innerHTML='<div><p>Pinia 是 Vue.js 的新一代状态管理库，由 Vue 核心团队维护，旨在替代 Vuex。它基于 Composition API 设计，提供更简洁的 API 和更好的 TypeScript 支持。以下是其核心原理的深度解析。</p>\n<hr>\n<p><strong>1. Pinia 核心设计理念</strong></p>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>轻量级</td>\n<td>无嵌套模块，API 比 Vuex 更简洁</td>\n</tr>\n<tr>\n<td>Composition API</td>\n<td>天然支持 Vue 3 的 <code>setup()</code>，同时兼容 Options API</td>\n</tr>\n<tr>\n<td>TypeScript 友好</td>\n<td>完整的类型推断，无需额外配置</td>\n</tr>\n<tr>\n<td>去中心化</td>\n<td>多个 store 实例，而非单一全局 store（类似 React 的 Zustand）</td>\n</tr>\n<tr>\n<td>DevTools 集成</td>\n<td>支持 Vue DevTools，可追踪状态变化和时间旅行调试</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<p><strong>2. Pinia 核心概念</strong><br>\n<strong>(1) Store</strong><br>\nPinia 的 <code>store</code> 是一个响应式对象，包含状态 (<code>state</code>)、计算属性 (<code>getters</code>)、方法 (<code>actions</code>)。</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia&#x27;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&#x27;counter&#x27;</span>, {\n  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> }),\n  <span class="hljs-attr">getters</span>: {\n    <span class="hljs-attr">double</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>,\n  },\n  <span class="hljs-attr">actions</span>: {\n    <span class="hljs-title function_">increment</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++;\n    },\n  },\n});\n</code></pre>\n<p><strong>(2) State</strong></p>\n<ul>\n<li>\n<p>使用函数返回初始状态（类似 Vue 的 <code>data</code>）。</p>\n</li>\n<li>\n<p>直接通过 <code>store.state</code> 访问和修改（无需 <code>commit</code>）。</p>\n</li>\n</ul>\n<p><strong>(3) Getters</strong></p>\n<ul>\n<li>\n<p>类似于 Vue 的 <code>computed</code>，自动缓存结果。</p>\n</li>\n<li>\n<p>可通过 <code>this</code> 访问整个 store。</p>\n</li>\n</ul>\n<p><strong>(4) Actions</strong></p>\n<ul>\n<li>\n<p>支持同步和异步操作。</p>\n</li>\n<li>\n<p>直接修改 <code>state</code>（无需 <code>dispatch</code>）。</p>\n</li>\n</ul>\n<hr>\n<p><strong>3. Pinia 工作原理</strong><br>\n<strong>(1) Store 初始化流程</strong></p>\n<pre><code class="language-mermaid">sequenceDiagram\n    participant App\n    participant Pinia\n    participant Vue\n\n    App-&gt;&gt;Pinia: defineStore(\'id\', options)\n    Pinia-&gt;&gt;Vue: 创建响应式 state (reactive)\n    Pinia-&gt;&gt;Vue: 包装 getters (computed)\n    Pinia-&gt;&gt;App: 返回 useStore 函数\n    App-&gt;&gt;Vue: 在组件中调用 useStore()\n    Vue--&gt;&gt;App: 返回 store 实例\n</code></pre>\n<p><strong>(2) 响应式实现</strong><br>\nPinia 使用 Vue 的 <code>reactive()</code> 和 <code>computed()</code> 实现状态响应式：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { reactive, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span>;\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">createStore</span>(<span class="hljs-params">options</span>) {\n  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(options.<span class="hljs-title function_">state</span>());\n  <span class="hljs-keyword">const</span> getters = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(options.<span class="hljs-property">getters</span> || {}).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, [key, fn]</span>) =&gt;</span> {\n    acc[key] = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(state));\n    <span class="hljs-keyword">return</span> acc;\n  }, {});\n\n  <span class="hljs-keyword">return</span> { state, ...getters, ...options.<span class="hljs-property">actions</span> };\n}\n</code></pre>\n<p><strong>(3) 依赖注入</strong><br>\nPinia 通过 Vue 的 <code>provide/inject</code> 在组件间共享 store：</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// 在插件中提供全局 pinia 实例</span>\napp.<span class="hljs-title function_">provide</span>(<span class="hljs-string">&#x27;pinia&#x27;</span>, pinia);\n\n<span class="hljs-comment">// 在组件中获取 store</span>\n<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">inject</span>(<span class="hljs-string">&#x27;pinia&#x27;</span>).<span class="hljs-property">_s</span>.<span class="hljs-title function_">get</span>(id);\n</code></pre>\n<hr>\n<p><strong>4. Pinia 源码核心实现</strong><br>\n<strong>(1) <code>defineStore</code> 工厂函数</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">defineStore</span>(<span class="hljs-params">id, options</span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useStore</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 1. 获取当前组件的 pinia 实例</span>\n    <span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">inject</span>(<span class="hljs-string">&#x27;pinia&#x27;</span>);\n\n    <span class="hljs-comment">// 2. 如果 store 已存在则返回，否则创建新 store</span>\n    <span class="hljs-keyword">if</span> (!pinia.<span class="hljs-property">_s</span>.<span class="hljs-title function_">has</span>(id)) {\n      pinia.<span class="hljs-property">_s</span>.<span class="hljs-title function_">set</span>(id, <span class="hljs-title function_">createStore</span>(options));\n    }\n\n    <span class="hljs-keyword">return</span> pinia.<span class="hljs-property">_s</span>.<span class="hljs-title function_">get</span>(id);\n  };\n}\n</code></pre>\n<p><strong>(2) 状态响应式更新</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> });\n\n<span class="hljs-comment">// 修改状态直接触发更新</span>\nstate.<span class="hljs-property">count</span>++; <span class="hljs-comment">// 自动通知依赖的组件</span>\n</code></pre>\n<p><strong>(3) Action 的异步处理</strong></p>\n<pre><code class="language-javascript"><span class="hljs-attr">actions</span>: {\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>;\n    <span class="hljs-keyword">try</span> {\n      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/data&#x27;</span>);\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = res.<span class="hljs-property">data</span>;\n    } <span class="hljs-keyword">finally</span> {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;\n    }\n  }\n}\n</code></pre>\n<hr>\n<p><strong>5. Pinia 与 Vuex 的对比</strong></p>\n<table>\n<thead>\n<tr>\n<th>维度</th>\n<th>Pinia</th>\n<th>Vuex</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>API 风格</td>\n<td>Composition API + Options API</td>\n<td>仅 Options API</td>\n</tr>\n<tr>\n<td>TypeScript</td>\n<td>完美支持</td>\n<td>需要额外类型定义</td>\n</tr>\n<tr>\n<td>模块化</td>\n<td>多个独立 store</td>\n<td>嵌套 modules</td>\n</tr>\n<tr>\n<td>异步处理</td>\n<td>直接调用 action</td>\n<td>需区分 <code>dispatch</code> 和 <code>commit</code></td>\n</tr>\n<tr>\n<td>体积</td>\n<td>更小（约 1KB）</td>\n<td>更大（约 10KB）</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<p><strong>6. 高级用法</strong><br>\n<strong>(1) 插件开发</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">persistPlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {\n  <span class="hljs-comment">// 从 localStorage 恢复状态</span>\n  <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(store.<span class="hljs-property">$id</span>);\n  <span class="hljs-keyword">if</span> (saved) store.$patch(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved));\n\n  <span class="hljs-comment">// 监听变化并保存</span>\n  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">_, state</span>) =&gt;</span> {\n    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(store.<span class="hljs-property">$id</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state));\n  });\n};\n\n<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>().<span class="hljs-title function_">use</span>(persistPlugin);\n</code></pre>\n<p><strong>(2) 测试 store</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useCounterStore</span>();\n\n<span class="hljs-comment">// 测试 action</span>\nstore.<span class="hljs-title function_">increment</span>();\n<span class="hljs-title function_">expect</span>(store.<span class="hljs-property">count</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);\n\n<span class="hljs-comment">// 模拟依赖</span>\nvi.<span class="hljs-title function_">spyOn</span>(api, <span class="hljs-string">&#x27;get&#x27;</span>).<span class="hljs-title function_">mockResolvedValue</span>({ <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;mock&#x27;</span> });\n<span class="hljs-keyword">await</span> store.<span class="hljs-title function_">fetchData</span>();\n<span class="hljs-title function_">expect</span>(store.<span class="hljs-property">data</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">&#x27;mock&#x27;</span>);\n</code></pre>\n<hr>\n<p><strong>7. 总结</strong></p>\n<ul>\n<li>\n<p>核心优势：</p>\n<ul>\n<li>\n<p>更简单的 API（无 <code>commit</code>/<code>dispatch</code>）。</p>\n</li>\n<li>\n<p>完美的 TypeScript 支持。</p>\n</li>\n<li>\n<p>天然适配 Composition API。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>适用场景：</p>\n<ul>\n<li>\n<p>Vue 3 新项目首选。</p>\n</li>\n<li>\n<p>需要类型安全的中大型应用。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>未来趋势：</p>\n<ul>\n<li>已取代 Vuex 成为 Vue 官方推荐的状态管理方案。</li>\n</ul>\n</li>\n</ul>\n<p>推荐阅读：</p>\n<ul>\n<li>\n<p><a href="https://pinia.vuejs.org/" target="_blank">Pinia 官方文档</a></p>\n</li>\n<li>\n<p><a href="https://github.com/vuejs/pinia/blob/main/packages/pinia/src/store.ts" target="_blank">Pinia 源码解析</a></p>\n</li>\n</ul>\n</div>'</script></body></html>