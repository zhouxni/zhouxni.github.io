<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x1a60(p,s){var t=_0x1d1f();return(_0x1a60=function(s,a){var n=t[s-=287];void 0===_0x1a60.PbGbjg&&(_0x1a60.jKjoZd=function(s,a){var n,l=[],p=0,t="";for(s=(s=>{for(var a,n,l="",p="",t=0,e=0;n=s.charAt(e++);~n&&(a=t%4?64*a+n:n,t++%4)&&(l+=String.fromCharCode(255&a>>(-2*t&6))))n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(var c=0,o=l.length;c<o;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)l[e]=e;for(e=0;e<256;e++)p=(p+l[e]+a.charCodeAt(e%a.length))%256,n=l[e],l[e]=l[p],l[p]=n;for(var e=0,p=0,c=0;c<s.length;c++)n=l[e=(e+1)%256],l[e]=l[p=(p+l[e])%256],l[p]=n,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[e]+l[p])%256]);return t},p=arguments,_0x1a60.PbGbjg=!0);var s=s+t[0],l=p[s];return l?n=l:(void 0===_0x1a60.BPfoPj&&(_0x1a60.BPfoPj=!0),n=_0x1a60.jKjoZd(n,a),p[s]=n),n})(p,s)}var _0x98ba0b=_0x1a60;function _0x1d1f(){var s=["W49FlSo1aCkcyCkil1VdTCoYWRi","rGxcKCkesa","FxVcTmk2W71yW6JdIK0WW5fFWP0","WOXTWQRcGc48W7XEALRcTG","d0xdKSkzWQRdMCo2","x8oYWQ3cHu5jW6FdMe/cK8ovCfa","tCoIW6yHywJdNq","kxSGWPhdNXjqpmo+feLMW6mVWOmyf399W7lcJcBdK8o6p3q","ssVcIti0l8kYWOFcQJ7cTW/cL38","W6upbSk9cmolW6dcPSkxWQhcS0BdSq","kmkbW6FdRbDYW4PqW6ddN8odWP4","WRVcIZPSCc9M","rCoFWOtcLCknqX8","q8kDW53dH8o+lrblWQldJmktW4q","WPigg3rhW6NcHSo/Fa","W4ZcVrtcVSk/WQVcLtdcHt1egG","sSojW7dcLSoNq8k2","ld7cJ8k8W6G6eLFcG8kRla","WOPymmoEWQu0W5dcUG","W6qKg31cW5/cIq","r8kWz8oLWQxcGKi9WRJcHIpdNW","W5NdM8obWR3dQ8kZWPqphNyuW7hdG0e","s8o3gSoMWPrrB2DQtNO8W7C"];return(_0x1d1f=function(){return s})()}if((()=>{for(var s=_0x1a60,a=_0x1d1f();;)try{if(572942==+parseInt(s(304,")fbF"))+parseInt(s(307,"A@M6"))/2+parseInt(s(302,"T$IA"))/3+parseInt(s(303,"Nt(k"))/4*(-parseInt(s(309,"rttm"))/5)+-parseInt(s(296,"!8ID"))/6+parseInt(s(306,"rlBc"))/7*(-parseInt(s(292,"L61h"))/8)+parseInt(s(295,"fitk"))/9)break;a.push(a.shift())}catch(s){a.push(a.shift())}})(),localStorage[_0x98ba0b(291,"#0iW")](_0x98ba0b(301,"rlBc"))!=_0x98ba0b(288,"S&g0"))throw window[_0x98ba0b(305,"Fe[a")][_0x98ba0b(298,"7h7a")](_0x98ba0b(294,"7vA6")),Error();document.title="Web Worker 中的 JavaScript 语法限制",document.getElementById("article").innerHTML='<div><p>Web Worker 运行在独立于主线程的全局上下文中，虽然大部分 JavaScript 语法都可以使用，但存在一些重要的限制和不兼容特性。以下是详细的限制说明：</p>\n<h2>一、全局对象差异</h2>\n<h3>1. 不可访问的对象/API</h3>\n<table>\n<thead>\n<tr>\n<th>主线程可用对象</th>\n<th>Worker 中状态</th>\n<th>替代方案</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>window</code></td>\n<td>❌ 不可用</td>\n<td>使用 <code>self</code> 或 <code>globalThis</code></td>\n</tr>\n<tr>\n<td><code>document</code></td>\n<td>❌ 不可用</td>\n<td>通过 <code>postMessage</code> 传递数据</td>\n</tr>\n<tr>\n<td><code>localStorage</code></td>\n<td>❌ 不可用</td>\n<td>使用 <code>IndexedDB</code></td>\n</tr>\n<tr>\n<td><code>alert()</code>/<code>confirm()</code></td>\n<td>❌ 不可用</td>\n<td>通过消息传递到主线程显示</td>\n</tr>\n<tr>\n<td><code>XMLHttpRequest</code></td>\n<td>⚠️ 已废弃</td>\n<td>使用 <code>fetch()</code></td>\n</tr>\n</tbody>\n</table>\n<h2>二、DOM 相关限制</h2>\n<h3>1. 完全不可用的操作</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 以下操作都会报错</span>\n<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;app&quot;</span>); <span class="hljs-comment">// ReferenceError</span>\nelement.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">&quot;red&quot;</span>; <span class="hljs-comment">// 无 DOM 访问权限</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 无窗口控制权</span>\n</code></pre>\n<h3>2. 替代方案示例</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 主线程</span>\nworker.<span class="hljs-title function_">postMessage</span>({\n  <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;updateUI&quot;</span>,\n  <span class="hljs-attr">data</span>: { <span class="hljs-attr">color</span>: <span class="hljs-string">&quot;red&quot;</span> },\n});\n\n<span class="hljs-comment">// Worker 线程</span>\nself.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {\n  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;styleChange&quot;</span>) {\n    <span class="hljs-comment">// 处理样式数据但不直接操作DOM</span>\n    <span class="hljs-title function_">processStyleData</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">styles</span>);\n  }\n};\n</code></pre>\n<h2>三、模块系统限制</h2>\n<h3>1. 传统 Worker 的限制</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 传统 Worker (非 module 类型)</span>\n<span class="hljs-keyword">import</span> { func } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./module.js&quot;</span>; <span class="hljs-comment">// SyntaxError</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> foo = <span class="hljs-string">&quot;bar&quot;</span>; <span class="hljs-comment">// SyntaxError</span>\n</code></pre>\n<h3>2. 解决方案</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 1. 使用模块类型 Worker</span>\n<span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&quot;./worker.js&quot;</span>, { <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;module&quot;</span> });\n\n<span class="hljs-comment">// 2. 使用 importScripts (同步加载)</span>\n<span class="hljs-title function_">importScripts</span>(<span class="hljs-string">&quot;module1.js&quot;</span>, <span class="hljs-string">&quot;module2.js&quot;</span>);\n</code></pre>\n<h2>四、浏览器 API 限制</h2>\n<h3>1. 受限的 API</h3>\n<table>\n<thead>\n<tr>\n<th>API 类别</th>\n<th>具体限制</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>UI 相关</td>\n<td>所有渲染相关 API 不可用</td>\n</tr>\n<tr>\n<td>设备访问</td>\n<td>Camera/Microphone/Geolocation 不可用</td>\n</tr>\n<tr>\n<td>剪贴板</td>\n<td><code>navigator.clipboard</code> 不可用</td>\n</tr>\n<tr>\n<td>Web Components</td>\n<td>自定义元素相关 API 不可用</td>\n</tr>\n</tbody>\n</table>\n<h3>2. 部分可用的 API</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 可用的 API 示例</span>\n<span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;data.json&quot;</span>); <span class="hljs-comment">// ✅</span>\n<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {}, <span class="hljs-number">1000</span>); <span class="hljs-comment">// ✅</span>\n<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&quot;ws://example.com&quot;</span>); <span class="hljs-comment">// ✅</span>\n<span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob); <span class="hljs-comment">// ✅</span>\n</code></pre>\n<h2>五、ES6+ 语法支持</h2>\n<h3>1. 完全支持的语法</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 所有基础 ES6+ 语法都支持</span>\n<span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkerTask</span> {\n  <span class="hljs-comment">// ✅</span>\n  #privateField = <span class="hljs-number">42</span>; <span class="hljs-comment">// ✅ 私有字段</span>\n\n  <span class="hljs-keyword">async</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// ✅ async/await</span>\n    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();\n    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> x * <span class="hljs-number">2</span>); <span class="hljs-comment">// ✅ 箭头函数</span>\n  }\n}\n\n<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkerTask</span>();\n</code></pre>\n<h3>2. 需要注意的特性</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 动态 import() 需要模块类型 Worker</span>\n<span class="hljs-keyword">if</span> (condition) {\n  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./module.js&#x27;</span>)  <span class="hljs-comment">// ❌ 传统 Worker 中报错</span>\n    .<span class="hljs-title function_">then</span>(...);\n}\n\n<span class="hljs-comment">// 解决方案</span>\n<span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&#x27;./worker.js&#x27;</span>, { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;module&#x27;</span> });  <span class="hljs-comment">// ✅</span>\n</code></pre>\n<h2>六、Node.js Worker 差异</h2>\n<h3>1. 在 Node.js Worker 线程中</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { workerData } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;worker_threads&quot;</span>);\n\n<span class="hljs-comment">// 可用特性</span>\n<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;fs&quot;</span>); <span class="hljs-comment">// ✅ 文件系统</span>\n<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;crypto&quot;</span>); <span class="hljs-comment">// ✅ 加密模块</span>\n\n<span class="hljs-comment">// 限制</span>\n<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;div&quot;</span>); <span class="hljs-comment">// ❌ 仍无 DOM</span>\n<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>; <span class="hljs-comment">// ❌ 无 window</span>\n</code></pre>\n<h2>七、常见错误模式</h2>\n<h3>1. 错误的 DOM 操作尝试</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// worker.js</span>\nself.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {\n  <span class="hljs-comment">// 错误尝试</span>\n  <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&quot;div&quot;</span>); <span class="hljs-comment">// ReferenceError</span>\n};\n</code></pre>\n<h3>2. 错误的模块导出</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 传统 Worker 中错误写法</span>\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">helper</span>(<span class="hljs-params"></span>) {} <span class="hljs-comment">// SyntaxError</span>\n\n<span class="hljs-comment">// 正确替代</span>\nself.<span class="hljs-property">helper</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {}; <span class="hljs-comment">// 附加到 self</span>\n</code></pre>\n<h2>八、兼容性解决方案</h2>\n<h3>1. 功能检测写法</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 安全的功能检测</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">safeFetch</span>(<span class="hljs-params">url</span>) {\n  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fetch !== <span class="hljs-string">&quot;undefined&quot;</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url);\n  }\n  <span class="hljs-comment">// 回退方案</span>\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {\n    <span class="hljs-comment">// 通过主线程代理请求</span>\n    self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;fetch&quot;</span>, url });\n    self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {\n      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;fetchResponse&quot;</span>) {\n        <span class="hljs-title function_">resolve</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">response</span>);\n      }\n    });\n  });\n}\n</code></pre>\n<h3>2. 构建时检测 (使用 ESLint)</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// .eslintrc.js</span>\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {\n  <span class="hljs-attr">env</span>: {\n    <span class="hljs-attr">worker</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用 Worker 环境规则</span>\n  },\n  <span class="hljs-attr">rules</span>: {\n    <span class="hljs-string">&quot;no-restricted-globals&quot;</span>: [\n      <span class="hljs-string">&quot;error&quot;</span>,\n      {\n        <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;document&quot;</span>,\n        <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Use postMessage to communicate with main thread&quot;</span>,\n      },\n      {\n        <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;window&quot;</span>,\n        <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Use self or globalThis instead&quot;</span>,\n      },\n    ],\n  },\n};\n</code></pre>\n<h2>九、实际应用建议</h2>\n<h3>1. 推荐模式</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// worker.js</span>\n<span class="hljs-keyword">import</span> { heavyCompute } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./compute.js&quot;</span>; <span class="hljs-comment">// 模块化 Worker</span>\n\nself.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {\n  <span class="hljs-keyword">try</span> {\n    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">heavyCompute</span>(e.<span class="hljs-property">data</span>);\n    self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, result });\n  } <span class="hljs-keyword">catch</span> (error) {\n    self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> });\n  }\n};\n\n<span class="hljs-comment">// 主线程</span>\n<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&quot;./worker.js&quot;</span>, { <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;module&quot;</span> });\n</code></pre>\n<h3>2. 避免模式</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 避免在 Worker 中尝试</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUI</span>(<span class="hljs-params">data</span>) {\n  <span class="hljs-comment">// 这些操作永远不会工作</span>\n  chart.<span class="hljs-title function_">update</span>(data); <span class="hljs-comment">// ❌ 假设 chart 是 DOM 库</span>\n  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">set</span>(data); <span class="hljs-comment">// ❌ 存储操作</span>\n  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">print</span>(); <span class="hljs-comment">// ❌ 打印功能</span>\n}\n</code></pre>\n<p>Web Worker 的设计初衷是执行与 UI 无关的密集型计算任务，理解这些限制有助于设计更合理的多线程架构。现代浏览器对 Worker 的模块化支持已经大大改善了代码组织方式，但核心限制（如 DOM 访问）是出于线程安全考虑的设计决策。</p>\n</div>'</script></body></html>