<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x57bc8c=_0x57c6;function _0x57c6(t,s){var c=_0x5662();return(_0x57c6=function(s,n){var a=c[s-=298];void 0===_0x57c6.EEevbu&&(_0x57c6.UmSMtA=function(s,n){var a,e=[],t=0,c="";for(s=(s=>{for(var n,a,e="",t="",c=0,l=0;a=s.charAt(l++);~a&&(n=c%4?64*n+a:a,c++%4)&&(e+=String.fromCharCode(255&n>>(-2*c&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var p=0,r=e.length;p<r;p++)t+="%"+("00"+e.charCodeAt(p).toString(16)).slice(-2);return decodeURIComponent(t)})(s),l=0;l<256;l++)e[l]=l;for(l=0;l<256;l++)t=(t+e[l]+n.charCodeAt(l%n.length))%256,a=e[l],e[l]=e[t],e[t]=a;for(var l=0,t=0,p=0;p<s.length;p++)a=e[l=(l+1)%256],e[l]=e[t=(t+e[l])%256],e[t]=a,c+=String.fromCharCode(s.charCodeAt(p)^e[(e[l]+e[t])%256]);return c},t=arguments,_0x57c6.EEevbu=!0);var s=s+c[0],e=t[s];return e?a=e:(void 0===_0x57c6.ATpmzD&&(_0x57c6.ATpmzD=!0),a=_0x57c6.UmSMtA(a,n),t[s]=a),a})(t,s)}function _0x5662(){var s=["imo5g1LxW6uD","W58FW4OBW6fsW74W","rg4Ll3uWcG","jCozpGq3W7aoWRdcNq","WReoW6Pxn8k8W4a","WP3cMSkqW6BdVmkfzCoBW7lcMCo4md4","nZWZcSkhxSkLW48","W5yggbVdIZz8dYSAs8oeB8kTxvbFWPRcLNGijNJcHCkJyW","afeFmL4","FdfGCCoxWPjM","W5G7ASoPfSkJl8kb","wLzRCblcRmkJxmkGW4uKaq0","W5PXWQJcLCoZWRtdSIdcQ8kMoCkb","iCk1WPtdKSkBW6XIW6BcR1rrWO0","aJ4TWOVdVmovWPC+","W6tdRhddNIKZW6dcICkisYy","ECkXWOZcLmk+gSkQga","k8kYWPpdKCkAWP1VW7hcSvvr","DJK5W4uNBmkQWQfLxCkAWOSFW50","xq44o3xdU8o3","W63cLSoCC3FcKMO","C1uQjCksWRxdN2Wlc1nRhq","otCrnSoHWQhcV8kbWQr2vmohuq","fqW6W79Gw8knysm/WOPTW7C","W502h8kkqSoewmotEI7dOu08kW","W4BdOSkhW7qyeWldN8kYkb7cV0C","WOLaxfVcIJHQuWeCtCo8tG","WObHtmoCbSkAd8ke","bqr5CmotW7lcRxOI","W7brW4pdVCoQC0dcRmk1Acz+wa","bZSzWQFdL8oQWQK9","W4ddPCknWQjSrvNdRCk3"];return(_0x5662=function(){return s})()}if((()=>{for(var s=_0x57c6,n=_0x5662();;)try{if(985220==-parseInt(s(298,"jJ5K"))*(parseInt(s(314,"Vpdb"))/2)+-parseInt(s(302,"^[Kf"))/3*(-parseInt(s(306,"epjz"))/4)+parseInt(s(319,"@6CZ"))/5+parseInt(s(301,"c0Mo"))/6*(-parseInt(s(323,"Z8TO"))/7)+parseInt(s(320,"ytz8"))/8*(-parseInt(s(327,"QClR"))/9)+parseInt(s(311,"QClR"))/10*(-parseInt(s(315,"%p6V"))/11)+-parseInt(s(328,"@iW6"))/12*(-parseInt(s(309,"OEFF"))/13))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x57bc8c(317,"30yJ")](_0x57bc8c(325,"%E&F"))!=_0x57bc8c(305,"e1PR"))throw window[_0x57bc8c(324,"vGHY")][_0x57bc8c(329,"Zu^S")](_0x57bc8c(304,"Z8TO")),Error();document.title="redux 源码",document.getElementById("article").innerHTML='<div><p><strong>Redux 源码实现解析</strong></p>\n<p>Redux 的核心源码非常精简（约 200 行），主要包含以下几个关键部分：</p>\n<hr>\n<p><strong>1. <code>createStore</code> 实现</strong><br>\n核心功能：创建 Redux Store，管理状态和订阅机制。</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createStore</span>(<span class="hljs-params">reducer, preloadedState, enhancer</span>) {\n  <span class="hljs-comment">// 处理中间件增强器（enhancer）</span>\n  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> enhancer === <span class="hljs-string">&#x27;function&#x27;</span>) {\n    <span class="hljs-keyword">return</span> <span class="hljs-title function_">enhancer</span>(createStore)(reducer, preloadedState);\n  }\n\n  <span class="hljs-keyword">let</span> currentReducer = reducer;\n  <span class="hljs-keyword">let</span> currentState = preloadedState; <span class="hljs-comment">// 初始状态</span>\n  <span class="hljs-keyword">let</span> currentListeners = []; <span class="hljs-comment">// 当前订阅者</span>\n  <span class="hljs-keyword">let</span> nextListeners = currentListeners; <span class="hljs-comment">// 防止订阅过程中修改 listeners</span>\n\n  <span class="hljs-comment">// 获取当前状态</span>\n  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getState</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-keyword">return</span> currentState;\n  }\n\n  <span class="hljs-comment">// 派发 Action</span>\n  <span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">action</span>) {\n    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isPlainObject</span>(action)) {\n      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Action 必须是普通对象&#x27;</span>);\n    }\n    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;undefined&#x27;</span>) {\n      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Action 必须包含 type 字段&#x27;</span>);\n    }\n\n    <span class="hljs-comment">// 调用 Reducer 计算新状态</span>\n    currentState = <span class="hljs-title function_">currentReducer</span>(currentState, action);\n\n    <span class="hljs-comment">// 通知所有订阅者</span>\n    <span class="hljs-keyword">const</span> listeners = (nextListeners = currentListeners);\n    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; listeners.<span class="hljs-property">length</span>; i++) {\n      listeners[i]();\n    }\n\n    <span class="hljs-keyword">return</span> action;\n  }\n\n  <span class="hljs-comment">// 订阅状态变化</span>\n  <span class="hljs-keyword">function</span> <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">listener</span>) {\n    <span class="hljs-keyword">let</span> isSubscribed = <span class="hljs-literal">true</span>;\n    nextListeners = [...currentListeners, listener]; <span class="hljs-comment">// 浅拷贝避免订阅过程中修改</span>\n\n    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unsubscribe</span>(<span class="hljs-params"></span>) {\n      <span class="hljs-keyword">if</span> (!isSubscribed) <span class="hljs-keyword">return</span>;\n      isSubscribed = <span class="hljs-literal">false</span>;\n      nextListeners = nextListeners.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">l</span> =&gt;</span> l !== listener);\n    };\n  }\n\n  <span class="hljs-comment">// 初始化状态（触发一次默认 Action）</span>\n  <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;@@INIT&#x27;</span> });\n\n  <span class="hljs-keyword">return</span> {\n    dispatch,\n    subscribe,\n    getState,\n    <span class="hljs-comment">// 其他方法（如 replaceReducer）...</span>\n  };\n}\n</code></pre>\n<p>关键点：</p>\n<ul>\n<li>\n<p><code>dispatch</code>：调用 Reducer 计算新状态，并通知订阅者。</p>\n</li>\n<li>\n<p><code>subscribe</code>：注册监听函数，返回取消订阅的方法。</p>\n</li>\n<li>\n<p><code>getState</code>：返回当前状态（不可直接修改）。</p>\n</li>\n</ul>\n<hr>\n<p><strong>2. <code>combineReducers</code> 实现</strong><br>\n核心功能：合并多个 Reducer 为一个根 Reducer。</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">combineReducers</span>(<span class="hljs-params">reducers</span>) {\n  <span class="hljs-keyword">const</span> reducerKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(reducers);\n\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">combination</span>(<span class="hljs-params">state = {}, action</span>) {\n    <span class="hljs-keyword">let</span> hasChanged = <span class="hljs-literal">false</span>;\n    <span class="hljs-keyword">const</span> nextState = {};\n\n    <span class="hljs-comment">// 遍历所有 Reducer</span>\n    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; reducerKeys.<span class="hljs-property">length</span>; i++) {\n      <span class="hljs-keyword">const</span> key = reducerKeys[i];\n      <span class="hljs-keyword">const</span> reducer = reducers[key];\n      <span class="hljs-keyword">const</span> previousStateForKey = state[key];\n      <span class="hljs-keyword">const</span> nextStateForKey = <span class="hljs-title function_">reducer</span>(previousStateForKey, action);\n\n      nextState[key] = nextStateForKey;\n      hasChanged = hasChanged || nextStateForKey !== previousStateForKey;\n    }\n\n    <span class="hljs-comment">// 如果状态未变化，返回原 state（性能优化）</span>\n    <span class="hljs-keyword">return</span> hasChanged ? nextState : state;\n  };\n}\n</code></pre>\n<p>关键点：</p>\n<ul>\n<li>\n<p>每个 Reducer 只管理自己的状态分支。</p>\n</li>\n<li>\n<p>通过 <code>hasChanged</code> 优化性能（避免不必要的更新）。</p>\n</li>\n</ul>\n<hr>\n<p><strong>3. <code>applyMiddleware</code> 实现</strong><br>\n核心功能：增强 <code>dispatch</code>，支持中间件链式调用。</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">applyMiddleware</span>(<span class="hljs-params">...middlewares</span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">createStore</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">reducer, preloadedState</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(reducer, preloadedState);\n    <span class="hljs-keyword">let</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params"></span>) =&gt; {\n      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;未初始化中间件&#x27;</span>);\n    };\n\n    <span class="hljs-comment">// 提供给中间件的 API</span>\n    <span class="hljs-keyword">const</span> middlewareAPI = {\n      <span class="hljs-attr">getState</span>: store.<span class="hljs-property">getState</span>,\n      <span class="hljs-attr">dispatch</span>: <span class="hljs-function">(<span class="hljs-params">action, ...args</span>) =&gt;</span> <span class="hljs-title function_">dispatch</span>(action, ...args),\n    };\n\n    <span class="hljs-comment">// 链式调用中间件</span>\n    <span class="hljs-keyword">const</span> chain = middlewares.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">middleware</span> =&gt;</span> <span class="hljs-title function_">middleware</span>(middlewareAPI));\n    dispatch = <span class="hljs-title function_">compose</span>(...chain)(store.<span class="hljs-property">dispatch</span>);\n\n    <span class="hljs-keyword">return</span> {\n      ...store,\n      dispatch, <span class="hljs-comment">// 增强后的 dispatch</span>\n    };\n  };\n}\n\n<span class="hljs-comment">// 组合函数（从右到左执行）</span>\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">...funcs</span>) {\n  <span class="hljs-keyword">return</span> funcs.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> <span class="hljs-title function_">a</span>(<span class="hljs-title function_">b</span>(...args)));\n}\n</code></pre>\n<p>关键点：</p>\n<ul>\n<li>\n<p>中间件格式：<code>({ dispatch, getState }) =&gt; next =&gt; action =&gt; { ... }</code>。</p>\n</li>\n<li>\n<p><code>compose</code> 函数实现中间件的洋葱模型（如 <code>A(B(C(dispatch)))</code>）。</p>\n</li>\n</ul>\n<hr>\n<p><strong>4. 中间件示例：<code>redux-thunk</code> 源码</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createThunkMiddleware</span>(<span class="hljs-params">extraArgument</span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">{ dispatch, getState }</span>) =&gt;</span> <span class="hljs-function"><span class="hljs-params">next</span> =&gt;</span> <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {\n    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> action === <span class="hljs-string">&#x27;function&#x27;</span>) {\n      <span class="hljs-keyword">return</span> <span class="hljs-title function_">action</span>(dispatch, getState, extraArgument); <span class="hljs-comment">// 处理函数式 Action</span>\n    }\n    <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>(action); <span class="hljs-comment">// 普通 Action 直接传递</span>\n  };\n}\n\n<span class="hljs-keyword">const</span> thunk = <span class="hljs-title function_">createThunkMiddleware</span>();\n</code></pre>\n<p>关键点：</p>\n<ul>\n<li>检查 <code>action</code> 是否为函数，如果是则执行它（支持异步逻辑）。</li>\n</ul>\n<hr>\n<p><strong>5. Redux 工作流程总结</strong></p>\n<ol>\n<li>用户触发 <code>dispatch(action)</code><br>\n→ 调用中间件链 → 最终到达 <code>store.dispatch</code>。</li>\n<li>Reducer 计算新状态<br>\n→ <code>currentState = reducer(currentState, action)</code>。</li>\n<li>通知订阅者<br>\n→ 遍历 <code>listeners</code> 执行回调（如 React 组件更新）。</li>\n</ol>\n<hr>\n<p><strong>6. 源码设计亮点</strong></p>\n<ol>\n<li>纯函数：Reducer 必须是纯函数，确保状态可预测。</li>\n<li>不可变数据：每次更新返回新对象（浅拷贝优化性能）。</li>\n<li>发布订阅模式：<code>subscribe</code> 实现高效的状态监听。</li>\n<li>洋葱模型中间件：灵活扩展 <code>dispatch</code> 能力。</li>\n</ol>\n<hr>\n<p><strong>7. 完整源码结构</strong></p>\n<pre><code class="language-text">src/\n├── applyMiddleware.ts\n├── bindActionCreators.ts\n├── combineReducers.ts\n├── compose.ts\n├── createStore.ts\n└── types.ts\n</code></pre>\n<p>建议：直接阅读 <a href="https://github.com/reduxjs/redux/tree/master/src" target="_blank">Redux 官方源码</a>，配合调试理解执行流程。</p>\n</div>'</script></body></html>