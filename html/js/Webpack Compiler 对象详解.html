<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x4796(o,n){var l=_0x3ca5();return(_0x4796=function(n,s){var t=l[n-=167];void 0===_0x4796.yAiNOw&&(_0x4796.WofUCD=function(n,s){var t,a=[],o=0,l="";for(n=(n=>{for(var s,t,a="",o="",l=0,e=0;t=n.charAt(e++);~t&&(s=l%4?64*s+t:t,l++%4)&&(a+=String.fromCharCode(255&s>>(-2*l&6))))t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(t);for(var c=0,p=a.length;c<p;c++)o+="%"+("00"+a.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(o)})(n),e=0;e<256;e++)a[e]=e;for(e=0;e<256;e++)o=(o+a[e]+s.charCodeAt(e%s.length))%256,t=a[e],a[e]=a[o],a[o]=t;for(var e=0,o=0,c=0;c<n.length;c++)t=a[e=(e+1)%256],a[e]=a[o=(o+a[e])%256],a[o]=t,l+=String.fromCharCode(n.charCodeAt(c)^a[(a[e]+a[o])%256]);return l},o=arguments,_0x4796.yAiNOw=!0);var n=n+l[0],a=o[n];return a?t=a:(void 0===_0x4796.mSnLSc&&(_0x4796.mSnLSc=!0),t=_0x4796.WofUCD(t,s),o[n]=t),t})(o,n)}var _0x19be58=_0x4796;function _0x3ca5(){var n=["WQrDWO/cN8kEoICbl8oggIVcHa","WRpcKtravCo3W4uc","WRPOWPddI8kOWR4vW5ZdUJ/dMmkh","WOtcGCkAcZC6emkLBSo3W5u","mf0ygHVdM8oMlmkWj8kuW4e","iSozymk+WPucnG","W4OabquxlrmfiuNcGSkXzq","WOdcICkAdJbcDCkfB8ouW7hcJ1u","ts/dTvhcJJur","W6iPWQ8eWOxdImkcmeiIW4XPW5S","gsnrp8o8vSkmW4VdNSo1C8kYWOiPmCo7aKuwtJ1qe8kiW6lcVG","aCoVbZ9hWPGIWQ7dLvCEWOu","aCkPWRT8W6tdLmocWPGscmoA","W47dRc1iBXBdUa","WRVcRmkaW5Tr","W7pdK8okwxqbdSkSBW","BmkIW6HrnwRcLW","W4XgimoRW6aEW4ddNq","m8ozW4pcI0/dPrfkcmk8g2O","W4GbbG1oF3KMauG","bSoVbtLgW6iuWQddQ3WX","z8ovWQlcNeiiWQzfW7LmWOdcUX0","WQzAWORcL8ogze8UnCoX","qMyxgCoNb8osWPhdNq","WOv8pSkbWO3cKSkDoCkjvCo4","W5SdWPSCW6mTW7/cRq","nfmufX7dM8kMjSkxeSksW78e","tmkbW7lcSbhdQH1ScW"];return(_0x3ca5=function(){return n})()}if((()=>{for(var n=_0x4796,s=_0x3ca5();;)try{if(555266==-parseInt(n(190,"c@lK"))+parseInt(n(192,"GR(y"))/2*(parseInt(n(175,"7n09"))/3)+-parseInt(n(169,"N8T$"))/4+-parseInt(n(182,"iGCc"))/5*(-parseInt(n(189,"3ur3"))/6)+parseInt(n(179,"Cqz!"))/7*(parseInt(n(180,"ud[H"))/8)+-parseInt(n(181,"b^rM"))/9*(-parseInt(n(186,"*1v7"))/10)+parseInt(n(188,"&mra"))/11)break;s.push(s.shift())}catch(n){s.push(s.shift())}})(),localStorage[_0x19be58(167,"&BCC")](_0x19be58(177,"N8T$"))!=_0x19be58(176,"q2xB"))throw window[_0x19be58(187,"*g!1")][_0x19be58(178,"5pk!")](_0x19be58(172,"85zR")),Error();document.title="Webpack Compiler 对象详解",document.getElementById("article").innerHTML='<div><p><code>Compiler</code> 是 Webpack 的<strong>核心调度器</strong>  ，负责管理整个构建生命周期（从启动到结束）。它贯穿整个 Webpack 运行过程，协调配置加载、插件执行、文件监听等全局任务，并生成每次构建的 <code>Compilation</code> 实例。</p>\n<hr>\n<h2><strong>1. Compiler 的核心职责</strong></h2>\n<ol>\n<li><strong>初始化环境</strong>\n<ul>\n<li>加载配置文件（<code>webpack.config.js</code>）。</li>\n<li>初始化插件系统（调用所有插件的 <code>apply</code> 方法）。</li>\n</ul>\n</li>\n<li><strong>控制构建流程</strong>\n<ul>\n<li>创建 <code>Compilation</code> 实例（每次构建生成一个新的 <code>Compilation</code>）。</li>\n<li>触发关键生命周期钩子（如 <code>beforeRun</code>、<code>compile</code>、<code>done</code>）。</li>\n</ul>\n</li>\n<li><strong>资源监听与持久化</strong>\n<ul>\n<li>在 <code>watch</code> 模式下监听文件变化，触发增量构建。</li>\n<li>管理输出文件（如清理旧资源、写入磁盘）。</li>\n</ul>\n</li>\n<li><strong>全局状态管理</strong>\n<ul>\n<li>存储共享数据（如 <code>options</code>、<code>inputFileSystem</code>/<code>outputFileSystem</code>）。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2><strong>2. Compiler 的关键属性和方法</strong></h2>\n<h3><strong>2.1 重要属性</strong></h3>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>类型</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>options</code></td>\n<td><code>Object</code></td>\n<td>合并后的完整配置（来自配置文件与 CLI 参数）</td>\n</tr>\n<tr>\n<td><code>context</code></td>\n<td><code>string</code></td>\n<td>项目根目录路径</td>\n</tr>\n<tr>\n<td><code>inputFileSystem</code></td>\n<td><code>fs</code></td>\n<td>输入文件系统（默认为 Node.js <code>fs</code>，可替换为内存文件系统）</td>\n</tr>\n<tr>\n<td><code>outputFileSystem</code></td>\n<td><code>fs</code></td>\n<td>输出文件系统（开发模式下可能为内存文件系统）</td>\n</tr>\n<tr>\n<td><code>hooks</code></td>\n<td><code>Object</code></td>\n<td>所有生命周期钩子（继承自 <code>Tapable</code>）</td>\n</tr>\n<tr>\n<td><code>watchMode</code></td>\n<td><code>boolean</code></td>\n<td>是否处于监听模式（<code>watch: true</code> 时启用）</td>\n</tr>\n</tbody>\n</table>\n<h3><strong>2.2 常用方法</strong></h3>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>run(callback)</code></td>\n<td>启动一次完整构建（非监听模式）</td>\n</tr>\n<tr>\n<td><code>watch(watchOptions, callback)</code></td>\n<td>启动监听模式，文件变化时触发增量构建</td>\n</tr>\n<tr>\n<td><code>close(callback)</code></td>\n<td>结束监听模式（释放资源）</td>\n</tr>\n<tr>\n<td><code>purgeInputFileSystem()</code></td>\n<td>清理输入文件系统缓存</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2><strong>3. Compiler 的生命周期钩子（Hooks）</strong></h2>\n<p><code>Compiler</code> 通过钩子（Hooks）控制构建流程，插件可通过这些钩子介入关键阶段：</p>\n<h3><strong>关键钩子列表</strong></h3>\n<table>\n<thead>\n<tr>\n<th>钩子名</th>\n<th>触发时机</th>\n<th>参数</th>\n<th>类型</th>\n<th>典型用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>environment</code></td>\n<td>环境准备完成后</td>\n<td>-</td>\n<td><code>SyncHook</code></td>\n<td>初始化自定义文件系统</td>\n</tr>\n<tr>\n<td><code>beforeRun</code></td>\n<td>构建开始前</td>\n<td><code>compiler</code></td>\n<td><code>AsyncSeriesHook</code></td>\n<td>清理临时文件</td>\n</tr>\n<tr>\n<td><code>run</code></td>\n<td>构建开始时</td>\n<td><code>compiler</code></td>\n<td><code>AsyncSeriesHook</code></td>\n<td>记录构建启动时间</td>\n</tr>\n<tr>\n<td><code>compile</code></td>\n<td>创建 <code>Compilation</code> 前</td>\n<td><code>params</code></td>\n<td><code>SyncHook</code></td>\n<td>修改编译参数</td>\n</tr>\n<tr>\n<td><code>compilation</code></td>\n<td><code>Compilation</code> 创建后</td>\n<td><code>compilation</code></td>\n<td><code>SyncHook</code></td>\n<td>操作 <code>Compilation</code> 对象</td>\n</tr>\n<tr>\n<td><code>emit</code></td>\n<td>生成资源到输出目录前</td>\n<td><code>compilation</code></td>\n<td><code>AsyncSeriesHook</code></td>\n<td>修改最终输出文件</td>\n</tr>\n<tr>\n<td><code>afterEmit</code></td>\n<td>资源写入磁盘后</td>\n<td><code>compilation</code></td>\n<td><code>AsyncSeriesHook</code></td>\n<td>上报构建结果</td>\n</tr>\n<tr>\n<td><code>done</code></td>\n<td>构建完成时</td>\n<td><code>stats</code></td>\n<td><code>AsyncSeriesHook</code></td>\n<td>输出日志或分析结果</td>\n</tr>\n<tr>\n<td><code>failed</code></td>\n<td>构建失败时</td>\n<td><code>error</code></td>\n<td><code>SyncHook</code></td>\n<td>错误监控上报</td>\n</tr>\n</tbody>\n</table>\n<p><strong>示例：记录构建耗时</strong></p>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BuildTimePlugin</span> {\n  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {\n    <span class="hljs-keyword">let</span> startTime;\n\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">beforeRun</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;BuildTimePlugin&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n      startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n    });\n\n    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;BuildTimePlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {\n      <span class="hljs-keyword">const</span> time = (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime) / <span class="hljs-number">1000</span>;\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`构建耗时: <span class="hljs-subst">${time}</span>s`</span>);\n    });\n  }\n}\n</code></pre>\n<hr>\n<h2><strong>4. Compiler 与 Compilation 的关系</strong></h2>\n<table>\n<thead>\n<tr>\n<th>对比项</th>\n<th><code>Compiler</code></th>\n<th><code>Compilation</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>作用域</strong></td>\n<td>全局（跨多次构建）</td>\n<td>单次构建</td>\n</tr>\n<tr>\n<td><strong>生命周期</strong></td>\n<td>从启动到结束（长期存在）</td>\n<td>仅单次构建期间</td>\n</tr>\n<tr>\n<td><strong>典型操作</strong></td>\n<td>管理配置、插件、文件监听</td>\n<td>处理模块、生成资源</td>\n</tr>\n<tr>\n<td><strong>生成关系</strong></td>\n<td>一个 <code>Compiler</code> 实例可生成多个 <code>Compilation</code></td>\n<td>每次构建由 <code>Compiler</code> 创建</td>\n</tr>\n</tbody>\n</table>\n<p><strong>协作流程</strong>  ：</p>\n<ol>\n<li><code>Compiler.run()</code> → 创建 <code>Compilation</code> → 触发 <code>compilation</code> 钩子。</li>\n<li><code>Compilation</code> 处理模块和资源 → 完成后触发 <code>Compiler</code> 的 <code>done</code> 钩子。</li>\n</ol>\n<hr>\n<h2><strong>5. 实际应用场景</strong></h2>\n<h3><strong>5.1 自定义文件系统</strong></h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">MemoryFS</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;memory-fs&#x27;</span>);\n\ncompiler.<span class="hljs-property">inputFileSystem</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryFS</span>(); <span class="hljs-comment">// 替换为内存文件系统</span>\ncompiler.<span class="hljs-property">outputFileSystem</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryFS</span>();\n</code></pre>\n<h3><strong>5.2 动态修改配置</strong></h3>\n<pre><code class="language-javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compile</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {\n  compiler.<span class="hljs-property">options</span>.<span class="hljs-property">entry</span> = { ... }; <span class="hljs-comment">// 动态调整入口</span>\n});\n</code></pre>\n<h3><strong>5.3 监听模式扩展</strong></h3>\n<pre><code class="language-javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">watchRun</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;检测到文件变化，重新构建...&#x27;</span>);\n});\n</code></pre>\n<h3><strong>5.4 构建结果上报</strong></h3>\n<pre><code class="language-javascript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {\n  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/build-report&#x27;</span>, {\n    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,\n    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(stats.<span class="hljs-title function_">toJson</span>()),\n  });\n});\n</code></pre>\n<hr>\n<h2><strong>6. 源码结构（简化版）</strong></h2>\n<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Compiler</span> {\n  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options;\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span> = {\n      <span class="hljs-attr">beforeRun</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSeriesHook</span>([<span class="hljs-string">&#x27;compiler&#x27;</span>]),\n      <span class="hljs-attr">compilation</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>([<span class="hljs-string">&#x27;compilation&#x27;</span>]),\n      <span class="hljs-attr">emit</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSeriesHook</span>([<span class="hljs-string">&#x27;compilation&#x27;</span>]),\n      <span class="hljs-comment">// ...其他钩子</span>\n    };\n  }\n\n  <span class="hljs-title function_">run</span>(<span class="hljs-params">callback</span>) {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">beforeRun</span>.<span class="hljs-title function_">callAsync</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {\n      <span class="hljs-keyword">const</span> compilation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Compilation</span>(<span class="hljs-variable language_">this</span>);\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">call</span>(compilation);\n      compilation.<span class="hljs-title function_">build</span>(<span class="hljs-function">() =&gt;</span> {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">callAsync</span>(compilation, <span class="hljs-function">() =&gt;</span> {\n          <span class="hljs-comment">// 写入文件系统</span>\n          <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">callAsync</span>(stats, callback);\n        });\n      });\n    });\n  }\n}\n</code></pre>\n<hr>\n<h2><strong>7. 注意事项</strong></h2>\n<ol>\n<li><strong>避免阻塞钩子</strong>  ：<br>\n<code>AsyncSeriesHook</code> 是异步串行钩子，需调用 <code>callback</code> 或返回 <code>Promise</code> 继续流程。</li>\n<li><strong>文件系统替换</strong>  ：<br>\n开发环境下可使用 <code>memory-fs</code> 提升性能，但需确保与插件兼容。</li>\n<li><strong>共享状态管理</strong>  ：<br>\n<code>Compiler</code> 的属性和方法会被所有插件共享，避免直接修改内部状态。</li>\n</ol>\n<hr>\n<h2><strong>总结</strong></h2>\n<p><code>Compiler</code> 是 Webpack 的“大脑”，负责：</p>\n<ul>\n<li><strong>调度构建流程</strong>  （通过钩子驱动 <code>Compilation</code>）。</li>\n<li><strong>管理全局资源</strong>  （配置、文件系统、插件）。</li>\n<li><strong>支持扩展性</strong>  （插件通过钩子深度定制行为）。</li>\n</ul>\n<p>理解 <code>Compiler</code> 的运作机制是开发高级插件、优化构建性能的关键。建议结合调试工具（如 <code>node --inspect</code>）观察其运行过程，或阅读 <a href="https://github.com/webpack/webpack" target="_blank">Webpack 源码</a> 中的 <code>lib/Compiler.js</code>。</p>\n</div>'</script></body></html>