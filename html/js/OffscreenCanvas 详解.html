<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x5db045=_0x28e9;function _0x28e9(e,s){var o=_0x3635();return(_0x28e9=function(s,n){var a=o[s-=235];void 0===_0x28e9.nbwBkH&&(_0x28e9.VjeGDX=function(s,n){var a,t=[],e=0,o="";for(s=(s=>{for(var n,a,t="",e="",o=0,r=0;a=s.charAt(r++);~a&&(n=o%4?64*n+a:a,o++%4)&&(t+=String.fromCharCode(255&n>>(-2*o&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var l=0,c=t.length;l<c;l++)e+="%"+("00"+t.charCodeAt(l).toString(16)).slice(-2);return decodeURIComponent(e)})(s),r=0;r<256;r++)t[r]=r;for(r=0;r<256;r++)e=(e+t[r]+n.charCodeAt(r%n.length))%256,a=t[r],t[r]=t[e],t[e]=a;for(var r=0,e=0,l=0;l<s.length;l++)a=t[r=(r+1)%256],t[r]=t[e=(e+t[r])%256],t[e]=a,o+=String.fromCharCode(s.charCodeAt(l)^t[(t[r]+t[e])%256]);return o},e=arguments,_0x28e9.nbwBkH=!0);var s=s+o[0],t=e[s];return t?a=t:(void 0===_0x28e9.PmcJsT&&(_0x28e9.PmcJsT=!0),a=_0x28e9.VjeGDX(a,n),e[s]=a),a})(e,s)}function _0x3635(){var s=["WOaHdSoIWRiOsG","o3ivFCo1WRldRr7dOhBcHXG7WO0namkfxmo1WRZdN8obWO/cPSonEW","A8kTWPpdVmkhaCkJCmkQWPH5bSk5","rvRdKL/dLSoPW5nsbSkbWOS","WQRcO8oSW6uwWQSOemoLW7XPWO9z","yL/cHY5uW7xdMq","ugRdM2LiWOZdH10xW58FWR4","WOBdImoHWPXPkmoCvgFcP8owja","WQpdGrmNjmk/WQv7","W598tCkEW7qVyw5iEtG","WRtcS8o2zSkYW40fWOn2","asRcQYHbWOpcVCoC","sCotWQhcMrNdMweiChxdNW","t13dLLVdKCkkW55pfCk4WQxdRa","oSk7W4xcSeVcMxpcOmk0","W4XrFmk0igBdJMS","wM3dN21pW6/dIKaeW6yX","WRFcS8oWi8oeWRPZWP5BW6HsEx8","Cd1tW5/cOCkIWPTm","emkEWQ1dW4a","aYRdRhGMW4dcImozfs7dLmka","W4xcT8kIECoNW6tcQbK","DdWxW4BcTmkxWPH7DW","W6FcJ8oGE3pdICkWW7tcIhn2BSko","nCoBW5lcN0aLW7ZdS2nryCkg","WQ/cOSoPW6KsWQPOp8o8W79HWO8"];return(_0x3635=function(){return s})()}if((()=>{for(var s=_0x28e9,n=_0x3635();;)try{if(458762==+parseInt(s(237,"vz)a"))*(parseInt(s(251,"d9#G"))/2)+parseInt(s(245,"dFHn"))/3*(parseInt(s(260,"Dhdc"))/4)+-parseInt(s(240,"kJid"))/5+-parseInt(s(259,"nyFQ"))/6+-parseInt(s(244,"HM%y"))/7+parseInt(s(248,"^X9F"))/8+-parseInt(s(236,"wa^q"))/9*(-parseInt(s(238,"Dhdc"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x5db045(242,"d9#G")](_0x5db045(256,"sYHw"))!=_0x5db045(235,"M#GH"))throw window[_0x5db045(250,"bBZw")][_0x5db045(247,"JY%v")](_0x5db045(243,"pkvx")),new Error;document.title="OffscreenCanvas è¯¦è§£",document.getElementById("article").innerHTML='<div><p><code>OffscreenCanvas</code> æ˜¯ç°ä»£ Web API ä¸­ç”¨äº<strong>åœ¨ä¸»çº¿ç¨‹ä¹‹å¤–ï¼ˆå¦‚ Web Workerï¼‰è¿›è¡Œ Canvas æ¸²æŸ“</strong>   çš„å¼ºå¤§å·¥å…·ã€‚å®ƒè§£å†³äº†ä¼ ç»Ÿ <code>&lt;canvas&gt;</code> å…ƒç´ åªèƒ½åœ¨ä¸»çº¿ç¨‹æ“ä½œã€å®¹æ˜“é€ æˆ UI å¡é¡¿çš„é—®é¢˜ï¼Œç‰¹åˆ«é€‚ç”¨äºå›¾åƒå¤„ç†ã€è§†é¢‘å¸§ç»˜åˆ¶ã€PDF æ¸²æŸ“ã€æ¸¸æˆæ¸²æŸ“ç­‰é«˜æ€§èƒ½åœºæ™¯ã€‚</p>\n<hr>\n<h2>ğŸ§  ä¸€ã€ä»€ä¹ˆæ˜¯ OffscreenCanvasï¼Ÿ</h2>\n<ul>\n<li><strong>å®šä¹‰</strong>   ï¼š<code>OffscreenCanvas</code> æ˜¯ä¸€ä¸ªè„±ç¦» DOM çš„ Canvas å¯¹è±¡ï¼Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹æˆ– Web Worker ä¸­åˆ›å»ºå’Œæ“ä½œã€‚</li>\n<li><strong>ç›®çš„</strong>   ï¼šå°†å›¾å½¢æ¸²æŸ“å·¥ä½œç§»å‡ºä¸»çº¿ç¨‹ï¼Œé¿å…é˜»å¡ UIï¼Œæå‡æ€§èƒ½å’Œå“åº”æ€§ã€‚</li>\n<li><strong>å…¼å®¹æ€§</strong>   ï¼šChrome 69+ã€Firefox 61+ã€Edge 79+ã€Safari 16.4+ï¼ˆ<a href="https://caniuse.com/offscreen-canvas" target="_blank">Can I Use</a>ï¼‰</li>\n</ul>\n<hr>\n<h2>ğŸ”§ äºŒã€åŸºæœ¬ç”¨æ³•</h2>\n<h3>âœ… æ­¥éª¤ 1ï¼šä»æ™®é€š <code>&lt;canvas&gt;</code> è·å– OffscreenCanvas</h3>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;myCanvas&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;800&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;600&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>\n</code></pre>\n<pre><code class="language-js"><span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;myCanvas&quot;</span>);\n<span class="hljs-keyword">const</span> offscreen = canvas.<span class="hljs-title function_">transferControlToOffscreen</span>();\n</code></pre>\n<blockquote>\n<p>âš ï¸ è°ƒç”¨ <code>transferControlToOffscreen()</code> åï¼ŒåŸ <code>&lt;canvas&gt;</code> å…ƒç´ <strong>å¤±å»æ§åˆ¶æƒ</strong>   ï¼Œä¸èƒ½å†é€šè¿‡ <code>getContext(\'2d\')</code> æ“ä½œå®ƒã€‚</p>\n</blockquote>\n<hr>\n<h3>âœ… æ­¥éª¤ 2ï¼šåœ¨ Worker ä¸­ä½¿ç”¨ OffscreenCanvas</h3>\n<h4>ä¸»çº¿ç¨‹ï¼š</h4>\n<pre><code class="language-js"><span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&quot;worker.js&quot;</span>);\n<span class="hljs-keyword">const</span> offscreen = canvas.<span class="hljs-title function_">transferControlToOffscreen</span>();\n\n<span class="hljs-comment">// å°† OffscreenCanvas ä¼ ç»™ Workerï¼ˆå¿…é¡»è½¬ç§»æ‰€æœ‰æƒï¼‰</span>\nworker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">canvas</span>: offscreen }, [offscreen]);\n</code></pre>\n<h4>Worker (<code>worker.js</code>)ï¼š</h4>\n<pre><code class="language-js">self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> { canvas } = e.<span class="hljs-property">data</span>;\n  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>);\n\n  <span class="hljs-comment">// æ­£å¸¸ç»˜å›¾ï¼</span>\n  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&quot;red&quot;</span>;\n  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);\n\n  <span class="hljs-comment">// OffscreenCanvas çš„å†…å®¹ä¼šè‡ªåŠ¨åŒæ­¥å›åŸ &lt;canvas&gt; å…ƒç´ </span>\n};\n</code></pre>\n<blockquote>\n<p>âœ… æ‰€æœ‰ç»˜å›¾æ“ä½œåœ¨ Worker ä¸­å®Œæˆï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ã€‚</p>\n</blockquote>\n<hr>\n<h2>ğŸŒ ä¸‰ã€å…³é”®ç‰¹æ€§</h2>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>è„±ç¦» DOM</strong></td>\n<td>ä¸ä¾èµ– <code>&lt;canvas&gt;</code> å…ƒç´ ï¼Œå¯åœ¨çº¯ JS ç¯å¢ƒåˆ›å»º</td>\n</tr>\n<tr>\n<td><strong>å¯è½¬ç§»ï¼ˆTransferableï¼‰</strong></td>\n<td>å¯é€šè¿‡ <code>postMessage</code> é«˜æ•ˆä¼ é€’ï¼ˆé›¶æ‹·è´ï¼‰</td>\n</tr>\n<tr>\n<td><strong>æ”¯æŒ 2D å’Œ WebGL</strong></td>\n<td><code>getContext(\'2d\')</code> æˆ– <code>getContext(\'webgl\')</code></td>\n</tr>\n<tr>\n<td><strong>è‡ªåŠ¨åŒæ­¥æ˜¾ç¤º</strong></td>\n<td>å¦‚æœæ˜¯ä» <code>&lt;canvas&gt;</code> è½¬ç§»è€Œæ¥ï¼Œç»˜åˆ¶ç»“æœä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š</td>\n</tr>\n<tr>\n<td><strong>ç‹¬ç«‹å­˜åœ¨</strong></td>\n<td>ä¹Ÿå¯ä¸å…³è” DOM å…ƒç´ ï¼Œç”¨äºåå°å›¾åƒç”Ÿæˆï¼ˆå¦‚å¯¼å‡º PNGï¼‰</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2>ğŸ›  å››ã€é«˜çº§ç”¨æ³•ç¤ºä¾‹</h2>\n<h3>1. <strong>å®Œå…¨åœ¨ Worker ä¸­åˆ›å»º OffscreenCanvasï¼ˆæ—  DOM å…³è”ï¼‰</strong></h3>\n<pre><code class="language-js"><span class="hljs-comment">// worker.js</span>\n<span class="hljs-keyword">const</span> offscreen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OffscreenCanvas</span>(<span class="hljs-number">800</span>, <span class="hljs-number">600</span>);\n<span class="hljs-keyword">const</span> ctx = offscreen.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>);\nctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">&quot;Hello from Worker!&quot;</span>, <span class="hljs-number">50</span>, <span class="hljs-number">50</span>);\n\n<span class="hljs-comment">// è½¬ä¸º Blob å¹¶å‘å›ä¸»çº¿ç¨‹</span>\n<span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">await</span> offscreen.<span class="hljs-title function_">convertToBlob</span>();\nself.<span class="hljs-title function_">postMessage</span>(blob);\n</code></pre>\n<blockquote>\n<p>é€‚ç”¨äºï¼šç”Ÿæˆå›¾ç‰‡ã€æ°´å°ã€å›¾è¡¨ç­‰ï¼Œå†ä¸Šä¼ æˆ–ä¸‹è½½ã€‚</p>\n</blockquote>\n<hr>\n<h3>2. <strong>ä¸ PDF.js ç»“åˆï¼ˆé«˜æ€§èƒ½ PDF æ¸²æŸ“ï¼‰</strong></h3>\n<pre><code class="language-js"><span class="hljs-comment">// worker.js (Module Worker)</span>\n<span class="hljs-keyword">import</span> { getDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;https://unpkg.com/pdfjs-dist/build/pdf.mjs&quot;</span>;\n\nself.<span class="hljs-property">onmessage</span> = <span class="hljs-title function_">async</span> (e) =&gt; {\n  <span class="hljs-keyword">const</span> { pdfData, canvas } = e.<span class="hljs-property">data</span>; <span class="hljs-comment">// pdfData: ArrayBuffer</span>\n\n  <span class="hljs-keyword">const</span> pdf = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDocument</span>({ <span class="hljs-attr">data</span>: pdfData }).<span class="hljs-property">promise</span>;\n  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> pdf.<span class="hljs-title function_">getPage</span>(<span class="hljs-number">1</span>);\n\n  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>);\n  <span class="hljs-keyword">const</span> viewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: <span class="hljs-number">1.5</span> });\n  canvas.<span class="hljs-property">width</span> = viewport.<span class="hljs-property">width</span>;\n  canvas.<span class="hljs-property">height</span> = viewport.<span class="hljs-property">height</span>;\n\n  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">render</span>({ <span class="hljs-attr">canvasContext</span>: ctx, viewport }).<span class="hljs-property">promise</span>;\n};\n</code></pre>\n<blockquote>\n<p>âœ… æ‰€æœ‰ PDF è§£æ + æ¸²æŸ“éƒ½åœ¨ Worker å®Œæˆï¼ŒUI æµç•…ã€‚</p>\n</blockquote>\n<hr>\n<h3>3. <strong>WebGL æ”¯æŒ</strong></h3>\n<pre><code class="language-js"><span class="hljs-comment">// worker.js</span>\n<span class="hljs-keyword">const</span> gl = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;webgl&quot;</span>);\n<span class="hljs-comment">// å¯è¿è¡Œå®Œæ•´çš„ WebGL ç¨‹åºï¼ˆå¦‚ Three.js æ¸²æŸ“å™¨ï¼‰</span>\n</code></pre>\n<blockquote>\n<p>æ³¨æ„ï¼šThree.js ä» r129 å¼€å§‹æ”¯æŒ OffscreenCanvasã€‚</p>\n</blockquote>\n<hr>\n<h2>âš ï¸ äº”ã€æ³¨æ„äº‹é¡¹ &amp; å‘ç‚¹</h2>\n<table>\n<thead>\n<tr>\n<th>é—®é¢˜</th>\n<th>è§£å†³æ–¹æ¡ˆ</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong><code>transferControlToOffscreen()</code> ååŸ canvas å¤±æ•ˆ</strong></td>\n<td>ä¸è¦å†å°è¯•æ“ä½œåŸ canvas</td>\n</tr>\n<tr>\n<td><strong>OffscreenCanvas ä¸èƒ½å…‹éš†ï¼Œåªèƒ½è½¬ç§»</strong></td>\n<td><code>postMessage(..., [offscreen])</code> å¿…é¡»æ”¾åœ¨ transfer list ä¸­</td>\n</tr>\n<tr>\n<td><strong>Safari æ—©æœŸç‰ˆæœ¬ä¸æ”¯æŒ</strong></td>\n<td>æ£€æµ‹ <code>HTMLCanvasElement.prototype.transferControlToOffscreen</code></td>\n</tr>\n<tr>\n<td><strong>Worker ä¸­æ— æ³•åŠ è½½å›¾ç‰‡/å­—ä½“ï¼Ÿ</strong></td>\n<td>éœ€æå‰åœ¨ä¸»çº¿ç¨‹åŠ è½½å¹¶ä¼ å…¥ ImageBitmapï¼ˆç”¨ <code>createImageBitmap</code>ï¼‰</td>\n</tr>\n<tr>\n<td><strong>è°ƒè¯•å›°éš¾</strong></td>\n<td>Worker ä¸­çš„ Canvas æ— æ³•ç›´æ¥ inspectï¼Œå¯ç”¨ <code>convertToBlob()</code> å¯¼å‡ºæŸ¥çœ‹</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2>ğŸ” å…­ã€å…¼å®¹æ€§æ£€æµ‹</h2>\n<pre><code class="language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">supportsOffscreenCanvas</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">return</span> (\n    <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">OffscreenCanvas</span> !== <span class="hljs-string">&quot;undefined&quot;</span> &amp;&amp;\n    <span class="hljs-title class_">HTMLCanvasElement</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">transferControlToOffscreen</span>\n  );\n}\n</code></pre>\n<p>å¦‚æœä¸æ”¯æŒï¼Œå¯é™çº§åˆ°ä¸»çº¿ç¨‹æ¸²æŸ“ã€‚</p>\n<hr>\n<h2>ğŸ“¦ ä¸ƒã€å…¸å‹åº”ç”¨åœºæ™¯</h2>\n<ul>\n<li><strong>PDF / æ–‡æ¡£æ¸²æŸ“</strong>   ï¼ˆå¦‚ä½ æ­£åœ¨åšçš„ï¼‰</li>\n<li><strong>è§†é¢‘å¸§å¤„ç†</strong>   ï¼ˆé…åˆ <code>VideoFrame</code> æˆ– <code>&lt;video&gt;</code>ï¼‰</li>\n<li><strong>æ¸¸æˆæ¸²æŸ“</strong>   ï¼ˆå°†æ¸¸æˆé€»è¾‘å’Œæ¸²æŸ“æ”¾å…¥ Workerï¼‰</li>\n<li><strong>å›¾åƒç¼–è¾‘ / æ»¤é•œ</strong></li>\n<li><strong>æ•°æ®å¯è§†åŒ–</strong>   ï¼ˆå¤§é‡å›¾è¡¨å®æ—¶æ›´æ–°ï¼‰</li>\n<li><strong>åå°ç”Ÿæˆå›¾ç‰‡</strong>   ï¼ˆå¦‚æµ·æŠ¥ã€äºŒç»´ç ã€æˆªå›¾ï¼‰</li>\n</ul>\n<hr>\n<h2>âœ… æ€»ç»“</h2>\n<table>\n<thead>\n<tr>\n<th>ä¼˜åŠ¿</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>é«˜æ€§èƒ½</strong></td>\n<td>æ¸²æŸ“ä¸é˜»å¡ UI çº¿ç¨‹</td>\n</tr>\n<tr>\n<td><strong>ç°ä»£åŒ–</strong></td>\n<td>ç¬¦åˆ Web Workers + ESM æ¶æ„è¶‹åŠ¿</td>\n</tr>\n<tr>\n<td><strong>çµæ´»</strong></td>\n<td>å¯å…³è” DOMï¼Œä¹Ÿå¯å®Œå…¨ç¦»å±</td>\n</tr>\n<tr>\n<td><strong>æœªæ¥-proof</strong></td>\n<td>æ˜¯ Web å›¾å½¢å¤„ç†çš„æ¨èæ–¹å‘</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>ğŸ’¡ <strong>æœ€ä½³å®è·µ</strong>   ï¼š<br>\nå¯¹äºå¤æ‚æˆ–é«˜é¢‘çš„ Canvas æ“ä½œï¼Œä¼˜å…ˆè€ƒè™‘ <code>OffscreenCanvas + Worker</code>ï¼›<br>\nç®€å•åŠ¨ç”»æˆ–äº¤äº’ä»å¯ç”¨æ™®é€š <code>&lt;canvas&gt;</code>ã€‚</p>\n</blockquote>\n<hr>\n<p>å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥æä¾›ä¸€ä¸ªå®Œæ•´çš„ <strong>PDF æ¸²æŸ“ + OffscreenCanvas + é”™è¯¯å¤„ç† + å…¼å®¹æ€§é™çº§</strong>   çš„å¯è¿è¡Œç¤ºä¾‹ï¼</p>\n</div>'</script></body></html>