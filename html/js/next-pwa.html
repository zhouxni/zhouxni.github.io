<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x376d(){var s=["qtHroCoexqq","EsHMW78fbSk6W5dcMqJdNgtdNq","WReCWQJdV8k6uuZcR8ovW6XTza","nCk5W6JcJMmlWR7cU3ZdK8kVDG","WQXtWPZcTuJcV2XfWRxcK8kWDq","euPae8klhSoVW4JdRmovnM8","WRS+WRujsehcUH1jF8ovu8kc","kaVdUXBdVSo6gNtdKcPncq","jmo+bmk9WRClW4SPW7zwFCoCW6m","C1FdSCk7sWpcQLRdNmorqga","h8kTW6JdMCoifSkXW7G","W5bOBSkny8klEq","cmkHqSocWPq","W60oW5JdRbddRf0","W7pcMxmvWPxcIrFcOIxdGZRcUa","e0jpeCkkfSkRW6ddJ8oDiLv2","WPTUgKddO8kzia","ASoUWR/dMI5sWOxcLG","W6aphYqed8kxW5xdRHKB","a8oWDwP/W6vKzM7dQSkPhmk9WRGxhbZcISoFgsi+W5mhomkc","WQ5AWP7cT0hcV0XPWOJcO8kSxW","WQHzWPJcT0NdHK5EWOtcKCk2","WOddGIzeW5xdJaBcPc8","tCo6umoRoJVcMq","W5xdT1riidqIWQe"];return(_0x376d=function(){return s})()}function _0x4e5c(p,s){var l=_0x376d();return(_0x4e5c=function(s,n){var a=l[s-=138];void 0===_0x4e5c.oRiNVr&&(_0x4e5c.tgqugK=function(s,n){var a,t=[],p=0,l="";for(s=(s=>{for(var n,a,t="",p="",l=0,c=0;a=s.charAt(c++);~a&&(n=l%4?64*n+a:a,l++%4)&&(t+=String.fromCharCode(255&n>>(-2*l&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var o=0,e=t.length;o<e;o++)p+="%"+("00"+t.charCodeAt(o).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)t[c]=c;for(c=0;c<256;c++)p=(p+t[c]+n.charCodeAt(c%n.length))%256,a=t[c],t[c]=t[p],t[p]=a;for(var c=0,p=0,o=0;o<s.length;o++)a=t[c=(c+1)%256],t[c]=t[p=(p+t[c])%256],t[p]=a,l+=String.fromCharCode(s.charCodeAt(o)^t[(t[c]+t[p])%256]);return l},p=arguments,_0x4e5c.oRiNVr=!0);var s=s+l[0],t=p[s];return t?a=t:(void 0===_0x4e5c.AMKdzK&&(_0x4e5c.AMKdzK=!0),a=_0x4e5c.tgqugK(a,n),p[s]=a),a})(p,s)}var _0x505f37=_0x4e5c;if((()=>{for(var s=_0x4e5c,n=_0x376d();;)try{if(295616==+parseInt(s(154,"H0xC"))+parseInt(s(149,"MrDB"))/2+parseInt(s(158,"ZotQ"))/3*(-parseInt(s(152,"v(T!"))/4)+-parseInt(s(157,"jTBw"))/5*(parseInt(s(140,"c5Jp"))/6)+parseInt(s(162,"v(T!"))/7+-parseInt(s(155,"E%z]"))/8+-parseInt(s(147,"T^U7"))/9*(-parseInt(s(151,"[T1W"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x505f37(138,"qis%")](_0x505f37(144,"T234"))!=_0x505f37(159,"&xRS"))throw window[_0x505f37(139,"1Tec")][_0x505f37(160,"[T1W")](_0x505f37(141,")&A%")),Error();document.title="next-pwa",document.getElementById("article").innerHTML='<div><p>好的，我们来详细解析 <strong><code>next-pwa</code></strong>   这个插件，它是在 Next.js 应用中集成 PWA（渐进式 Web 应用）功能的<strong>首选方案</strong>   。</p>\n<hr>\n<h3>一、next-pwa 是什么？</h3>\n<p><code>next-pwa</code> 是一个为 Next.js 项目提供<strong>零配置（Zero-Config）</strong>   或<strong>高度可定制</strong>   的 PWA 功能的插件。它底层基于 Google 的 <code>workbox-webpack-plugin</code>，自动为你处理 Service Worker 的生成、预缓存、运行时缓存等复杂逻辑，让你只需几步配置就能让 Next.js 应用具备 PWA 的核心能力。</p>\n<hr>\n<h3>二、核心特性与优势</h3>\n<ol>\n<li><strong>开箱即用</strong>   ：只需安装和简单配置，即可生成 Service Worker 和 <code>manifest.json</code> 文件。</li>\n<li><strong>自动预缓存</strong>   ：会自动预缓存 Next.js 应用本身的所有静态资源（如 JS、CSS、字体、图片），实现极速加载。</li>\n<li><strong>运行时缓存</strong>   ：可轻松配置策略来缓存外部 API 请求、第三方资源等，支持<strong>离线访问</strong>   。</li>\n<li><strong>自动更新</strong>   ：当您部署新版本时，Service Worker 会自动更新并在下次访问时生效。</li>\n<li><strong>与 Next.js 深度集成</strong>   ：完美支持 <code>getStaticProps</code>、<code>getServerSideProps</code>、<code>next/image</code> 等特性。</li>\n</ol>\n<hr>\n<h3>三、安装与基本配置</h3>\n<h4>1. 安装</h4>\n<pre><code class="language-bash">npm install next-pwa\n<span class="hljs-comment"># 或</span>\nyarn add next-pwa\n</code></pre>\n<h4>2. 在 <code>next.config.js</code> 中配置</h4>\n<p>这是最核心的一步。</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// next.config.js</span>\n<span class="hljs-keyword">const</span> withPWA = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;next-pwa&quot;</span>)({\n  <span class="hljs-attr">dest</span>: <span class="hljs-string">&quot;public&quot;</span>, <span class="hljs-comment">// Service Worker 文件和静态资源的输出目录</span>\n  <span class="hljs-attr">register</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否自动注册 Service Worker</span>\n  <span class="hljs-attr">skipWaiting</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否跳过等待期，让新的 Service Worker 立即激活</span>\n  <span class="hljs-comment">// runtimeCaching: [...], // 自定义运行时缓存策略（高级用法，后文详述）</span>\n});\n\n<span class="hljs-keyword">const</span> nextConfig = {\n  <span class="hljs-comment">// 你的 Next.js 其他配置...</span>\n};\n\n<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">withPWA</span>(nextConfig); <span class="hljs-comment">// 用 withPWA 包装你的配置</span>\n</code></pre>\n<h4>3. 创建 PWA 清单文件 (<code>public/manifest.json</code>)</h4>\n<p>这个文件定义了你的 App 如何被操作系统“以 App 的形式”对待。</p>\n<pre><code class="language-json"><span class="hljs-comment">// public/manifest.json</span>\n<span class="hljs-punctuation">{</span>\n  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;My Awesome PWA&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;short_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;MyPWA&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;A fantastic Next.js PWA application&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;start_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;display&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;standalone&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;background_color&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#ffffff&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;theme_color&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#000000&quot;</span><span class="hljs-punctuation">,</span>\n  <span class="hljs-attr">&quot;icons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>\n    <span class="hljs-punctuation">{</span>\n      <span class="hljs-attr">&quot;src&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/icon-192x192.png&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;sizes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;192x192&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/png&quot;</span>\n    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>\n    <span class="hljs-punctuation">{</span>\n      <span class="hljs-attr">&quot;src&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/icon-512x512.png&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;sizes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;512x512&quot;</span><span class="hljs-punctuation">,</span>\n      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/png&quot;</span>\n    <span class="hljs-punctuation">}</span>\n  <span class="hljs-punctuation">]</span>\n<span class="hljs-punctuation">}</span>\n</code></pre>\n<p><strong>记得将对应的图标文件（如 <code>icon-192x192.png</code>, <code>icon-512x512.png</code>）放到 <code>public</code> 目录下。</strong></p>\n<hr>\n<h3>四、核心配置详解（以 <code>runtimeCaching</code> 为例）</h3>\n<p><code>runtimeCaching</code> 是配置<strong>运行时缓存策略</strong>   的核心，它决定了如何缓存那些不是构建时生成的资源（如 API 响应）。</p>\n<pre><code class="language-javascript"><span class="hljs-comment">// next.config.js</span>\n<span class="hljs-keyword">const</span> withPWA = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;next-pwa&quot;</span>)({\n  <span class="hljs-attr">dest</span>: <span class="hljs-string">&quot;public&quot;</span>,\n  <span class="hljs-attr">runtimeCaching</span>: [\n    <span class="hljs-comment">// 1. 缓存 Google 字体</span>\n    {\n      <span class="hljs-attr">urlPattern</span>: <span class="hljs-regexp">/^https:\\/\\/fonts\\.(?:gstatic)\\.com\\/.*/i</span>,\n      <span class="hljs-attr">handler</span>: <span class="hljs-string">&quot;CacheFirst&quot;</span>,\n      <span class="hljs-attr">options</span>: {\n        <span class="hljs-attr">cacheName</span>: <span class="hljs-string">&quot;google-fonts-webfonts&quot;</span>,\n        <span class="hljs-attr">expiration</span>: {\n          <span class="hljs-attr">maxEntries</span>: <span class="hljs-number">4</span>,\n          <span class="hljs-attr">maxAgeSeconds</span>: <span class="hljs-number">365</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 365天</span>\n        },\n      },\n    },\n    <span class="hljs-comment">// 2. 缓存外部图片</span>\n    {\n      <span class="hljs-attr">urlPattern</span>:\n        <span class="hljs-regexp">/^https:\\/\\/my-awesome-cdn\\.com\\/.*\\.(png|jpg|jpeg|webp|avif|svg)/i</span>,\n      <span class="hljs-attr">handler</span>: <span class="hljs-string">&quot;CacheFirst&quot;</span>,\n      <span class="hljs-attr">options</span>: {\n        <span class="hljs-attr">cacheName</span>: <span class="hljs-string">&quot;external-images&quot;</span>,\n        <span class="hljs-attr">expiration</span>: {\n          <span class="hljs-attr">maxEntries</span>: <span class="hljs-number">32</span>,\n          <span class="hljs-attr">maxAgeSeconds</span>: <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 24小时</span>\n        },\n      },\n    },\n    <span class="hljs-comment">// 3. 缓存 API 请求（最重要的配置之一）</span>\n    {\n      <span class="hljs-attr">urlPattern</span>: <span class="hljs-regexp">/\\/api\\/.*/i</span>, <span class="hljs-comment">// 匹配所有 /api/ 开头的请求</span>\n      <span class="hljs-attr">handler</span>: <span class="hljs-string">&quot;NetworkFirst&quot;</span>, <span class="hljs-comment">// 优先从网络获取，失败则用缓存</span>\n      <span class="hljs-attr">options</span>: {\n        <span class="hljs-attr">cacheName</span>: <span class="hljs-string">&quot;api-cache&quot;</span>,\n        <span class="hljs-attr">networkTimeoutMs</span>: <span class="hljs-number">10000</span>, <span class="hljs-comment">// 网络请求超时时间（10秒）</span>\n        <span class="hljs-attr">expiration</span>: {\n          <span class="hljs-attr">maxEntries</span>: <span class="hljs-number">64</span>,\n          <span class="hljs-attr">maxAgeSeconds</span>: <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 24小时</span>\n        },\n        <span class="hljs-attr">cacheableResponse</span>: {\n          <span class="hljs-attr">statuses</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">200</span>], <span class="hljs-comment">// 缓存状态码为0（例如CORS）和200的响应</span>\n        },\n      },\n    },\n  ],\n});\n</code></pre>\n<p><strong>常用缓存策略 (<code>handler</code>):</strong></p>\n<ul>\n<li><strong><code>NetworkFirst</code></strong>   : 优先网络，失败则用缓存。<strong>适用于需要最新数据的 API</strong>   。</li>\n<li><strong><code>CacheFirst</code></strong>   : 优先缓存，没有则请求网络。<strong>适用于静态资源（图片、字体）</strong>   。</li>\n<li><strong><code>StaleWhileRevalidate</code></strong>   : 立即返回缓存（即使过期），同时在后台更新缓存。<strong>适用于可稍后更新的资源</strong>   。</li>\n<li><strong><code>NetworkOnly</code></strong>   : 只从网络获取。</li>\n<li><strong><code>CacheOnly</code></strong>   : 只从缓存获取。</li>\n</ul>\n<hr>\n<h3>五、在应用中使用</h3>\n<p>在你的应用根组件（如 <code>pages/_app.js</code> 或 <code>app/layout.js</code>）中，你需要添加 <code>meta</code> 标签来引用 <code>manifest.json</code>。</p>\n<pre><code class="language-jsx"><span class="hljs-comment">// pages/_app.js 或 app/layout.js</span>\n<span class="hljs-keyword">import</span> <span class="hljs-title class_">Head</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/head&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ Component, pageProps }</span>) {\n  <span class="hljs-keyword">return</span> (\n    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span>\n      <span class="hljs-tag">&lt;<span class="hljs-name">Head</span>&gt;</span>\n        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span>\n        <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;manifest&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/manifest.json&quot;</span> /&gt;</span>\n        {/* 主题色 meta 标签，用于移动端浏览器地址栏着色 */}\n        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;theme-color&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;#000000&quot;</span> /&gt;</span>\n        {/* Apple 图标，用于 iOS Safari */}\n        <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;apple-touch-icon&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/icon-192x192.png&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span>\n      <span class="hljs-tag">&lt;/<span class="hljs-name">Head</span>&gt;</span>\n      <span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...pageProps</span>} /&gt;</span>\n    <span class="hljs-tag">&lt;/&gt;</span></span>\n  );\n}\n</code></pre>\n<hr>\n<h3>六、开发与部署注意事项</h3>\n<ol>\n<li>\n<p><strong>开发环境</strong>   ：</p>\n<ul>\n<li>在开发时 (<code>next dev</code>)，Service Worker 默认<strong>不会</strong>   被注册，以避免缓存干扰开发。</li>\n<li>你可以通过设置 <code>disable: process.env.NODE_ENV === \'development\'</code> 来显式禁用它。</li>\n</ul>\n</li>\n<li>\n<p><strong>构建与部署</strong>   ：</p>\n<ul>\n<li>运行 <code>next build</code> 时，<code>next-pwa</code> 会开始工作，在 <code>public</code> 目录（或你指定的 <code>dest</code> 目录）生成 <code>sw.js</code> 和 <code>workbox-*.js</code> 文件。</li>\n<li>部署后，用户访问你的网站，浏览器就会自动注册 Service Worker。</li>\n</ul>\n</li>\n<li>\n<p><strong>调试</strong>   ：</p>\n<ul>\n<li>在 Chrome DevTools 的 <strong>Application</strong>   标签页中，可以查看和调试 Service Worker、Cache Storage 以及 Manifest。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3>七、总结</h3>\n<p><code>next-pwa</code> 极大地简化了在 Next.js 中实现 PWA 的复杂度。通过简单的配置，你就能为你的应用带来：</p>\n<ul>\n<li><strong>可靠性</strong>   ：在网络不稳定或离线时依然可以访问。</li>\n<li><strong>速度</strong>   ：静态资源的瞬时加载。</li>\n<li><strong>沉浸感</strong>   ：可像原生 App 一样添加到主屏幕，并全屏运行。</li>\n</ul>\n<p>它是提升 Next.js 应用用户体验和现代化程度的<strong>强力工具</strong>   。</p>\n</div>'</script></body></html>