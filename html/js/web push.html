<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>function _0x1007(){var s=["WPpcHCoFW78qASody8oicfvDWQ0","bCobCSkAWR/cLSouoSk3v8oSo2C","WRnDjSkfghL9k8oaWOtdUCkOWQu","qSobW77dTNevW4BdS8o8WRa","dIS+CWBcJ8kCW4Dnk3/cOaa","xCkkWQ/cQWBdKbO","qY4HcdZdRmovW6CJW5/cQXKC","W5JdI0VdUmklW5FcKa","WQnbkCooWP/cJSoyWRWEW5GSWPxdQq","omojArDkeSksWOJdRGi","tmofnbVcIZKs","bbBdLJakefNdJCoJfG","nColzX8Xl8kmWQFdTqhdMq","hmkEWQ3cOfieW6/dPq","WRRcJxSiW6FcPLiuW64fie3cPq","W53cISoSWONcV149W6VdPSoM","qCkEmKjWjmkaWOBdRW","W49sm8kZWOBdP1zNWPvFpCkEW6m","WPhdN8kyWQ84dSks","WPlcKqj2hMtcRCkcAJxdPCoFwG","vfBcMNaWBY/cICoHmmkYWR3dMeZcU8kwh8kuWRpdPsJcJt8aW7TH","W6ZdMqXnvW","W4TxmCk5WOdcRIbMWOn+la","d2BcISkEW7BcPKBcIwK9n8oAWOi","W7RdT37cHbyDWOq","kCoSr8kjy30K"];return(_0x1007=function(){return s})()}var _0x443ca7=_0x56ce;function _0x56ce(p,s){var t=_0x1007();return(_0x56ce=function(s,n){var a=t[s-=273];void 0===_0x56ce.TlWxLP&&(_0x56ce.nIPcOU=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,r=0;a=s.charAt(r++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,e=l.length;c<e;c++)p+="%"+("00"+l.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),r=0;r<256;r++)l[r]=r;for(r=0;r<256;r++)p=(p+l[r]+n.charCodeAt(r%n.length))%256,a=l[r],l[r]=l[p],l[p]=a;for(var r=0,p=0,c=0;c<s.length;c++)a=l[r=(r+1)%256],l[r]=l[p=(p+l[r])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(c)^l[(l[r]+l[p])%256]);return t},p=arguments,_0x56ce.TlWxLP=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x56ce.JSzMKh&&(_0x56ce.JSzMKh=!0),a=_0x56ce.nIPcOU(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x56ce,n=_0x1007();;)try{if(381987==-parseInt(s(280,"u%(S"))*(-parseInt(s(277,"yY[z"))/2)+-parseInt(s(283,"tcCM"))/3*(-parseInt(s(291,"gxVu"))/4)+-parseInt(s(281,"apve"))/5+parseInt(s(287,"LoFs"))/6+parseInt(s(298,"yY[z"))/7+parseInt(s(292,"*0YB"))/8*(parseInt(s(296,"nexG"))/9)+-parseInt(s(282,"zWtG"))/10)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x443ca7(286,"7@&U")](_0x443ca7(297,"dj0a"))!=_0x443ca7(276,"RYa$"))throw window[_0x443ca7(294,"@*I&")][_0x443ca7(273,"3BmV")](_0x443ca7(275,"*0YB")),Error();document.title="web push",document.getElementById("article").innerHTML='<div><p>使用 Service Worker 实现推送通知是 Web Push 通知的核心部分。Service Worker 是一个在浏览器后台运行的脚本，它独立于网页，能够在页面关闭或浏览器最小化时继续运行，非常适合处理推送通知。以下是实现推送通知的基本步骤：</p>\n<hr>\n<h3><strong>实现步骤</strong></h3>\n<h4><strong>1. 注册 Service Worker</strong></h4>\n<p>首先，需要在你的网页中注册 Service Worker。Service Worker 是一个独立的 JavaScript 文件，通常放在网站的根目录。</p>\n<p><strong>register-service-worker.js</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;serviceWorker&#x27;</span> <span class="hljs-keyword">in</span> navigator) {\n  navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">&#x27;/service-worker.js&#x27;</span>)\n    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Service Worker 注册成功，作用域:&#x27;</span>, registration.<span class="hljs-property">scope</span>);\n    })\n    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Service Worker 注册失败:&#x27;</span>, error);\n    });\n}\n</code></pre>\n<p><strong>在 HTML 中引入</strong>  ：</p>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;register-service-worker.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>\n</code></pre>\n<hr>\n<h4><strong>2. 创建 Service Worker 文件</strong></h4>\n<p>创建 <code>service-worker.js</code> 文件，用于处理推送事件。</p>\n<p><strong>service-worker.js</strong>  ：</p>\n<pre><code class="language-javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;push&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {\n  <span class="hljs-keyword">const</span> data = event.<span class="hljs-property">data</span> ? event.<span class="hljs-property">data</span>.<span class="hljs-title function_">json</span>() : {}; <span class="hljs-comment">// 获取推送数据</span>\n  <span class="hljs-keyword">const</span> title = data.<span class="hljs-property">title</span> || <span class="hljs-string">&#x27;默认标题&#x27;</span>;\n  <span class="hljs-keyword">const</span> options = {\n    <span class="hljs-attr">body</span>: data.<span class="hljs-property">body</span> || <span class="hljs-string">&#x27;默认内容&#x27;</span>,\n    <span class="hljs-attr">icon</span>: data.<span class="hljs-property">icon</span> || <span class="hljs-string">&#x27;/icon.png&#x27;</span>,\n    <span class="hljs-attr">badge</span>: data.<span class="hljs-property">badge</span> || <span class="hljs-string">&#x27;/badge.png&#x27;</span>,\n    <span class="hljs-attr">vibrate</span>: [<span class="hljs-number">200</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>], <span class="hljs-comment">// 振动模式</span>\n    <span class="hljs-attr">data</span>: data.<span class="hljs-property">url</span> ? { <span class="hljs-attr">url</span>: data.<span class="hljs-property">url</span> } : {} <span class="hljs-comment">// 自定义数据</span>\n  };\n\n  event.<span class="hljs-title function_">waitUntil</span>(\n    self.<span class="hljs-property">registration</span>.<span class="hljs-title function_">showNotification</span>(title, options)\n  );\n});\n\nself.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;notificationclick&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {\n  <span class="hljs-keyword">const</span> clickedNotification = event.<span class="hljs-property">notification</span>;\n  <span class="hljs-keyword">const</span> url = clickedNotification.<span class="hljs-property">data</span>.<span class="hljs-property">url</span> || <span class="hljs-string">&#x27;/&#x27;</span>; <span class="hljs-comment">// 点击后跳转的 URL</span>\n\n  clickedNotification.<span class="hljs-title function_">close</span>();\n\n  event.<span class="hljs-title function_">waitUntil</span>(\n    clients.<span class="hljs-title function_">openWindow</span>(url) <span class="hljs-comment">// 打开新窗口或标签页</span>\n  );\n});\n</code></pre>\n<hr>\n<h4><strong>3. 请求推送权限</strong></h4>\n<p>在用户订阅推送通知之前，需要请求他们的权限。</p>\n<p><strong>request-permission.js</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">requestPushPermission</span>(<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;PushManager&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {\n    <span class="hljs-title class_">Notification</span>.<span class="hljs-title function_">requestPermission</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">permission</span> =&gt;</span> {\n      <span class="hljs-keyword">if</span> (permission === <span class="hljs-string">&#x27;granted&#x27;</span>) {\n        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;用户已授予推送通知权限&#x27;</span>);\n        <span class="hljs-title function_">subscribeUserToPush</span>();\n      } <span class="hljs-keyword">else</span> {\n        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;用户拒绝了推送通知权限&#x27;</span>);\n      }\n    });\n  } <span class="hljs-keyword">else</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;当前浏览器不支持推送通知&#x27;</span>);\n  }\n}\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">subscribeUserToPush</span>(<span class="hljs-params"></span>) {\n  navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">ready</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {\n    registration.<span class="hljs-property">pushManager</span>.<span class="hljs-title function_">subscribe</span>({\n      <span class="hljs-attr">userVisibleOnly</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 必须设置为 true，表示通知对用户可见</span>\n      <span class="hljs-attr">applicationServerKey</span>: <span class="hljs-title function_">urlBase64ToUint8Array</span>(<span class="hljs-string">&#x27;YOUR_PUBLIC_VAPID_KEY&#x27;</span>) <span class="hljs-comment">// VAPID 密钥</span>\n    })\n    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">subscription</span> =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;订阅成功:&#x27;</span>, subscription);\n      <span class="hljs-title function_">sendSubscriptionToServer</span>(subscription); <span class="hljs-comment">// 将订阅信息发送到服务器</span>\n    })\n    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {\n      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;订阅失败:&#x27;</span>, error);\n    });\n  });\n}\n\n<span class="hljs-keyword">function</span> <span class="hljs-title function_">urlBase64ToUint8Array</span>(<span class="hljs-params">base64String</span>) {\n  <span class="hljs-keyword">const</span> padding = <span class="hljs-string">&#x27;=&#x27;</span>.<span class="hljs-title function_">repeat</span>((<span class="hljs-number">4</span> - base64String.<span class="hljs-property">length</span> % <span class="hljs-number">4</span>) % <span class="hljs-number">4</span>);\n  <span class="hljs-keyword">const</span> base64 = (base64String + padding)\n    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">&#x27;+&#x27;</span>)\n    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/_/g</span>, <span class="hljs-string">&#x27;/&#x27;</span>);\n\n  <span class="hljs-keyword">const</span> rawData = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">atob</span>(base64);\n  <span class="hljs-keyword">const</span> outputArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(rawData.<span class="hljs-property">length</span>);\n\n  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rawData.<span class="hljs-property">length</span>; ++i) {\n    outputArray[i] = rawData.<span class="hljs-title function_">charCodeAt</span>(i);\n  }\n  <span class="hljs-keyword">return</span> outputArray;\n}\n</code></pre>\n<p><strong>在 HTML 中添加按钮触发权限请求</strong>  ：</p>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;requestPushPermission()&quot;</span>&gt;</span>订阅推送通知<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>\n</code></pre>\n<hr>\n<h4><strong>4. 服务器端发送推送消息</strong></h4>\n<p>服务器端需要使用 Web Push 协议发送推送消息。以下是使用 Node.js 和 <code>web-push</code> 库的示例。</p>\n<p><strong>安装 <code>web-push</code> 库</strong>  ：</p>\n<pre><code class="language-sh">npm install web-push\n</code></pre>\n<p><strong>服务器代码示例</strong>  ：</p>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> webpush = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;web-push&#x27;</span>);\n\n<span class="hljs-comment">// VAPID 密钥</span>\n<span class="hljs-keyword">const</span> vapidKeys = {\n  <span class="hljs-attr">publicKey</span>: <span class="hljs-string">&#x27;YOUR_PUBLIC_VAPID_KEY&#x27;</span>,\n  <span class="hljs-attr">privateKey</span>: <span class="hljs-string">&#x27;YOUR_PRIVATE_VAPID_KEY&#x27;</span>\n};\n\nwebpush.<span class="hljs-title function_">setVapidDetails</span>(\n  <span class="hljs-string">&#x27;mailto:your-email@example.com&#x27;</span>,\n  vapidKeys.<span class="hljs-property">publicKey</span>,\n  vapidKeys.<span class="hljs-property">privateKey</span>\n);\n\n<span class="hljs-comment">// 订阅信息（从客户端接收）</span>\n<span class="hljs-keyword">const</span> subscription = {\n  <span class="hljs-attr">endpoint</span>: <span class="hljs-string">&#x27;YOUR_SUBSCRIPTION_ENDPOINT&#x27;</span>,\n  <span class="hljs-attr">keys</span>: {\n    <span class="hljs-attr">p256dh</span>: <span class="hljs-string">&#x27;YOUR_P256DH_KEY&#x27;</span>,\n    <span class="hljs-attr">auth</span>: <span class="hljs-string">&#x27;YOUR_AUTH_KEY&#x27;</span>\n  }\n};\n\n<span class="hljs-comment">// 发送推送消息</span>\n<span class="hljs-keyword">const</span> payload = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({\n  <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;新消息&#x27;</span>,\n  <span class="hljs-attr">body</span>: <span class="hljs-string">&#x27;这是一条推送通知&#x27;</span>,\n  <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;/icon.png&#x27;</span>,\n  <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://your-website.com&#x27;</span>\n});\n\nwebpush.<span class="hljs-title function_">sendNotification</span>(subscription, payload)\n  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;推送成功:&#x27;</span>, response);\n  })\n  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;推送失败:&#x27;</span>, error);\n  });\n</code></pre>\n<hr>\n<h3><strong>注意事项</strong></h3>\n<ol>\n<li><strong>HTTPS 协议</strong>  ：\n<ul>\n<li>Service Worker 和推送通知需要在 HTTPS 环境下运行（localhost 除外）。</li>\n</ul>\n</li>\n<li><strong>VAPID 密钥</strong>  ：\n<ul>\n<li>使用 VAPID（Voluntary Application Server Identification）密钥对推送消息进行签名，确保安全性。</li>\n</ul>\n</li>\n<li><strong>用户权限</strong>  ：\n<ul>\n<li>必须在用户授予权限后才能发送推送通知，且用户可以随时撤销权限。</li>\n</ul>\n</li>\n<li><strong>跨浏览器兼容性</strong>  ：\n<ul>\n<li>推送通知在主流浏览器（如 Chrome、Firefox、Edge）中受支持，但 Safari 的支持可能有限。</li>\n</ul>\n</li>\n<li><strong>错误处理</strong>  ：\n<ul>\n<li>处理推送订阅和消息发送过程中的错误，确保用户体验。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3><strong>总结</strong></h3>\n<p>通过 Service Worker 实现推送通知，可以为用户提供实时、个性化的消息体验。从注册 Service Worker、请求推送权限、订阅推送服务，到服务器端发送推送消息，整个流程需要客户端和服务器端的协同工作。确保遵循最佳实践，保护用户隐私，提供有价值的内容，才能提高用户的参与度和留存率。</p>\n</div>'</script></body></html>