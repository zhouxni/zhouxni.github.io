<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0x262052=_0x40f6;function _0x40f6(p,s){var l=_0x2ec8();return(_0x40f6=function(s,n){var a=l[s-=227];void 0===_0x40f6.xcDHDe&&(_0x40f6.mmNGjg=function(s,n){var a,t=[],p=0,l="";for(s=(s=>{for(var n,a,t="",p="",l=0,e=0;a=s.charAt(e++);~a&&(n=l%4?64*n+a:a,l++%4)&&(t+=String.fromCharCode(255&n>>(-2*l&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var c=0,o=t.length;c<o;c++)p+="%"+("00"+t.charCodeAt(c).toString(16)).slice(-2);return decodeURIComponent(p)})(s),e=0;e<256;e++)t[e]=e;for(e=0;e<256;e++)p=(p+t[e]+n.charCodeAt(e%n.length))%256,a=t[e],t[e]=t[p],t[p]=a;for(var e=0,p=0,c=0;c<s.length;c++)a=t[e=(e+1)%256],t[e]=t[p=(p+t[e])%256],t[p]=a,l+=String.fromCharCode(s.charCodeAt(c)^t[(t[e]+t[p])%256]);return l},p=arguments,_0x40f6.xcDHDe=!0);var s=s+l[0],t=p[s];return t?a=t:(void 0===_0x40f6.lGUmXv&&(_0x40f6.lGUmXv=!0),a=_0x40f6.mmNGjg(a,n),p[s]=a),a})(p,s)}if((()=>{for(var s=_0x40f6,n=_0x2ec8();;)try{if(764912==+parseInt(s(248,"Rwgd"))*(-parseInt(s(241,"4nkB"))/2)+-parseInt(s(254,"7yOa"))/3*(parseInt(s(227,"pq*q"))/4)+parseInt(s(232,"7Q!u"))/5*(-parseInt(s(247,"kEEN"))/6)+parseInt(s(239,"6(uC"))/7+-parseInt(s(246,"R4J5"))/8*(parseInt(s(252,"qfAx"))/9)+-parseInt(s(228,"zVAt"))/10+-parseInt(s(236,"lxGt"))/11*(-parseInt(s(238,")rvY"))/12))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0x262052(253,"9@y4")](_0x262052(249,"j%jf"))!=_0x262052(233,"R4J5"))throw window[_0x262052(245,"gMy[")][_0x262052(237,"4nkB")](_0x262052(231,"!Eb(")),Error();function _0x2ec8(){var s=["W651mM4gBmoX","W5C2WRxdMN83lfyzW5pcJKi","W4K7w34SjHePj8k0W5T9zCkHzvmaWQ0mWOLTWPNdPmoraCor","qsGCyCkJldzO","amkoWP/dGci","W6CcW7nkiGWyivbmbmog","DhuYBhpcJCoVfq","fZqqcCoVCSoBc8k5CW","WQPXWQ1Wkufk","WOVcI8k7WRZdHmo+jXP3sJC","W51IWRNdSCkuAuxcSHpdKf/cNxu","o8knWRb4FxFdHmkrW7FdOxy","W6aGW6uQErPcWPhdQmkUnCk3","y2ymWPldII7cGNxdQCooW5u","WR8GWRBcTYuVs3aJbbJdUCoA","W5vIWRZdTmkqBKFcMHVdPLRcK0q","WPZdRJNcTNe8WRK+","qCopW57cHMVcKmk2xeRcGfCdzq","hCoJrN86WPW+iaRcGGi","W7KdWR/cMNxdJhu","BNGPe0mHtCo3kq","vvRcPvVdQSkGWRi1dCk6","WRiSWRlcSIqRmhe/ctFdMG","WOmfdLTrmSoAWRm","W44Yymk9erZdSG","DZ7cJGm/WPZcImkhWQaaW6RcHa","Cd/dOvvIW4hcV8kp","W7mFxfZdK8kDvW","b2VcTmoHwxVdUCk3xNJcK8oI"];return(_0x2ec8=function(){return s})()}document.title=" Nuxt3 插件",document.getElementById("article").innerHTML='<div><p>下面给出一份「Nuxt 3 插件（Plugins）」的系统性指南，涵盖概念、生命周期、实战写法、类型提示、常见坑及最佳实践。读完即可在任何规模的项目中熟练编写与维护 Nuxt 3 插件。</p>\n<hr>\n<h2>1. 什么是 Nuxt 3 插件？</h2>\n<ul>\n<li>\n<p><strong>定义</strong><br>\n插件是「在 Nuxt 应用启动早期被自动加载的一段代码」，用于：</p>\n<ul>\n<li>注册全局组件 / 指令 / 库（如 VueUse、Vuetify）</li>\n<li>把第三方实例注入到 Nuxt 上下文（<code>$axios</code>, <code>$dayjs</code> …）</li>\n<li>运行一次性初始化逻辑（拦截器、i18n、Sentry、mock 服务…）</li>\n</ul>\n</li>\n<li>\n<p><strong>与 Nuxt 2 的差异</strong></p>\n<table>\n<thead>\n<tr>\n<th>维度</th>\n<th>Nuxt 2</th>\n<th>Nuxt 3</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>文件位置</td>\n<td><code>plugins/</code></td>\n<td><code>plugins/</code>（支持 <code>.js/.ts</code>）</td>\n</tr>\n<tr>\n<td>导出方式</td>\n<td><code>export default (ctx, inject) =&gt; {}</code></td>\n<td><code>export default defineNuxtPlugin(nuxtApp =&gt; {})</code></td>\n</tr>\n<tr>\n<td>类型支持</td>\n<td>手写 <code>Context</code></td>\n<td>完整的 TypeScript 泛型推导</td>\n</tr>\n<tr>\n<td>自动注册</td>\n<td>需配置 <code>plugins: []</code></td>\n<td><strong>零配置</strong>   ，文件即插件</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ul>\n<hr>\n<h2>2. 插件生命周期</h2>\n<ol>\n<li>Nitro 启动（Server）</li>\n<li>服务端插件执行（SSR）</li>\n<li>客户端水合（Client Hydration）</li>\n<li>客户端插件执行（CSR）</li>\n</ol>\n<blockquote>\n<p>插件默认「<strong>同时</strong>   」运行在服务端和客户端；可通过文件名或条件语句控制。</p>\n</blockquote>\n<hr>\n<h2>3. 文件约定与命名</h2>\n<pre><code>plugins/\n├─ foo.client.ts     # 仅在浏览器执行\n├─ bar.server.ts     # 仅在服务器执行\n├─ baz.ts            # 两端都会执行\n└─ deep/\n   └─ nested.ts      # 支持子目录\n</code></pre>\n<blockquote>\n<p>不需要在 <code>nuxt.config</code> 中声明，<code>/plugins/**</code> 自动扫描。</p>\n</blockquote>\n<hr>\n<h2>4. 最小可运行示例</h2>\n<h3>4.1 定义插件</h3>\n<p><code>plugins/hello.client.ts</code></p>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;👋 客户端插件已执行&quot;</span>);\n});\n</code></pre>\n<h3>4.2 带注入的插件</h3>\n<p><code>plugins/dayjs.ts</code></p>\n<pre><code class="language-ts"><span class="hljs-keyword">import</span> dayjs <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;dayjs&quot;</span>;\n<span class="hljs-keyword">import</span> relativeTime <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;dayjs/plugin/relativeTime&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">(<span class="hljs-params">nuxtApp</span>) =&gt;</span> {\n  dayjs.<span class="hljs-title function_">extend</span>(relativeTime);\n\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">provide</span>: {\n      <span class="hljs-attr">dayjs</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">date</span>?: dayjs.<span class="hljs-title class_">ConfigType</span></span>) =&gt;</span> <span class="hljs-title function_">dayjs</span>(date),\n    },\n  };\n});\n</code></pre>\n<h3>4.3 在组件 / API 中使用</h3>\n<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript">\n  <span class="hljs-keyword">const</span> { $dayjs } = <span class="hljs-title function_">useNuxtApp</span>();\n  <span class="hljs-keyword">const</span> ago = $dayjs(<span class="hljs-string">&quot;2023-01-01&quot;</span>).<span class="hljs-title function_">fromNow</span>();\n</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>\n</code></pre>\n<hr>\n<h2>5. 插件函数签名</h2>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">(<span class="hljs-params">nuxtApp</span>) =&gt;</span> {\n  <span class="hljs-comment">// 1. 访问运行时</span>\n  <span class="hljs-keyword">const</span> { $config } = nuxtApp;\n\n  <span class="hljs-comment">// 2. 注册全局属性</span>\n  nuxtApp.<span class="hljs-property">vueApp</span>.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$injected</span> = <span class="hljs-string">&quot;value&quot;</span>;\n\n  <span class="hljs-comment">// 3. 使用 useRuntimeConfig / useRouter / useFetch 等组合式函数</span>\n  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();\n  router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;路由守卫&quot;</span>, to.<span class="hljs-property">path</span>);\n  });\n\n  <span class="hljs-comment">// 4. 返回供模板使用的注入</span>\n  <span class="hljs-keyword">return</span> {\n    <span class="hljs-attr">provide</span>: {\n      <span class="hljs-attr">hello</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-string">`Hello <span class="hljs-subst">${name}</span>`</span>,\n    },\n  };\n});\n</code></pre>\n<hr>\n<h2>6. 运行环境判断</h2>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">server</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;仅服务器执行&quot;</span>);\n  }\n  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">client</span>) {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;仅浏览器执行&quot;</span>);\n  }\n});\n</code></pre>\n<hr>\n<h2>7. 高级技巧</h2>\n<h3>7.1 插件可异步</h3>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-title function_">async</span> () =&gt; {\n  <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">&quot;/api/config&quot;</span>);\n  <span class="hljs-keyword">return</span> { <span class="hljs-attr">provide</span>: { <span class="hljs-attr">config</span>: data } };\n});\n</code></pre>\n<h3>7.2 插件可注册全局组件</h3>\n<pre><code class="language-ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">MyButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;~/components/MyButton.vue&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">(<span class="hljs-params">nuxtApp</span>) =&gt;</span> {\n  nuxtApp.<span class="hljs-property">vueApp</span>.<span class="hljs-title function_">component</span>(<span class="hljs-string">&quot;MyButton&quot;</span>, <span class="hljs-title class_">MyButton</span>);\n  nuxtApp.<span class="hljs-property">vueApp</span>.<span class="hljs-title function_">component</span>(<span class="hljs-string">&quot;MyButton&quot;</span>, <span class="hljs-title class_">MyButton</span>); <span class="hljs-comment">// 支持链式</span>\n});\n</code></pre>\n<h3>7.3 注册自定义指令</h3>\n<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">(<span class="hljs-params">nuxtApp</span>) =&gt;</span> {\n  nuxtApp.<span class="hljs-property">vueApp</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">&quot;focus&quot;</span>, {\n    <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el</span>) {\n      el.<span class="hljs-title function_">focus</span>();\n    },\n  });\n});\n</code></pre>\n<h3>7.4 使用 Pinia Store</h3>\n<pre><code class="language-ts"><span class="hljs-keyword">import</span> { useAuthStore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;~/stores/auth&quot;</span>;\n\n<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">(<span class="hljs-params">nuxtApp</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> auth = <span class="hljs-title function_">useAuthStore</span>(nuxtApp.<span class="hljs-property">$pinia</span>);\n  auth.<span class="hljs-title function_">refreshToken</span>();\n});\n</code></pre>\n<hr>\n<h2>8. 类型声明（零配置）</h2>\n<p>Nuxt 3 会自动把插件的 <code>provide</code> 合并到 <code>NuxtApp</code> 类型。<br>\n如需手动增强：</p>\n<p><code>types/plugins.d.ts</code></p>\n<pre><code class="language-ts"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&quot;#app&quot;</span> {\n  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">NuxtApp</span> {\n    <span class="hljs-attr">$hello</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;\n    <span class="hljs-attr">$dayjs</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">date</span>?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;dayjs&quot;</span>).<span class="hljs-property">Dayjs</span>;\n  }\n}\n\n<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&quot;vue&quot;</span> {\n  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ComponentCustomProperties</span> {\n    <span class="hljs-attr">$hello</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;\n  }\n}\n</code></pre>\n<hr>\n<h2>9. 常见错误排查表</h2>\n<table>\n<thead>\n<tr>\n<th>错误信息</th>\n<th>原因</th>\n<th>解决</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>Cannot read properties of undefined ($xxx)</code></td>\n<td>插件只在服务端运行，却在客户端模板中使用</td>\n<td>改名 <code>.client.ts</code> 或加判断</td>\n</tr>\n<tr>\n<td><code>window is not defined</code></td>\n<td>插件在服务端访问 <code>window</code></td>\n<td>用 <code>process.client</code> 包裹</td>\n</tr>\n<tr>\n<td>类型提示丢失</td>\n<td>未写 <code>declare module</code></td>\n<td>见第 8 节</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2>10. 最佳实践清单</h2>\n<p>✅ 使用 <code>defineNuxtPlugin</code> 保证类型安全<br>\n✅ 插件职责单一，一个插件只做一件事<br>\n✅ 需要库实例（axios、i18n）时，统一用 <code>provide</code> 注入，而不是挂全局变量<br>\n✅ 服务端敏感信息只在 <code>.server.ts</code> 插件中使用<br>\n✅ 对第三方 UI 库（Vuetify、ElementPlus）在 <code>.client.ts</code> 插件里 <code>app.use</code><br>\n✅ 大体积库按需引入，配合 Nuxt 的 auto-import &amp; tree-shaking</p>\n<hr>\n<h2>11. 完整范例仓库</h2>\n<p>GitHub 官方示例：<br>\nhttps://github.com/nuxt/examples/tree/main/features/plugins</p>\n<hr>\n<p>至此，你已掌握 Nuxt 3 插件的全部核心能力。Happy coding!</p>\n</div>'</script></body></html>