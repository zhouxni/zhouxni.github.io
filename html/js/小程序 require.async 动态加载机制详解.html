<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0xa6e958=_0x485b;if((()=>{for(var s=_0x485b,n=_0x6b79();;)try{if(289330==-parseInt(s(118,"FYwq"))*(-parseInt(s(136,"^FV4"))/2)+parseInt(s(116,"w7]l"))/3+parseInt(s(140,"m0Gh"))/4+-parseInt(s(123,"1P2B"))/5+parseInt(s(135,"]Eam"))/6*(-parseInt(s(124,"ntnI"))/7)+-parseInt(s(129,"Lu^r"))/8+parseInt(s(139,"h3U!"))/9*(parseInt(s(121,"yCJa"))/10))break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0xa6e958(131,"1d9s")](_0xa6e958(134,"m0Gh"))!=_0xa6e958(127,"VS@4"))throw window[_0xa6e958(128,"g5%L")][_0xa6e958(122,"E5qX")](_0xa6e958(130,"ix4O")),Error();function _0x485b(p,s){var t=_0x6b79();return(_0x485b=function(s,n){var a=t[s-=115];void 0===_0x485b.ryQyiq&&(_0x485b.nbLVhJ=function(s,n){var a,l=[],p=0,t="";for(s=(s=>{for(var n,a,l="",p="",t=0,c=0;a=s.charAt(c++);~a&&(n=t%4?64*n+a:a,t++%4)&&(l+=String.fromCharCode(255&n>>(-2*t&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var e=0,i=l.length;e<i;e++)p+="%"+("00"+l.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(p)})(s),c=0;c<256;c++)l[c]=c;for(c=0;c<256;c++)p=(p+l[c]+n.charCodeAt(c%n.length))%256,a=l[c],l[c]=l[p],l[p]=a;for(var c=0,p=0,e=0;e<s.length;e++)a=l[c=(c+1)%256],l[c]=l[p=(p+l[c])%256],l[p]=a,t+=String.fromCharCode(s.charCodeAt(e)^l[(l[c]+l[p])%256]);return t},p=arguments,_0x485b.ryQyiq=!0);var s=s+t[0],l=p[s];return l?a=l:(void 0===_0x485b.XZKLSp&&(_0x485b.XZKLSp=!0),a=_0x485b.nbLVhJ(a,n),p[s]=a),a})(p,s)}function _0x6b79(){var s=["p2eys8kyW6JcGKr0WOVcMmkY","qCohW4BcTK5eBbi","W7JdJmktCmkOW5Cl","ESkgWPT5vSoHFYTnWQXiW7xcHa","W6BcMSkEWQ3cI1NdGq","ASoAsMpdK8ktWObc","kCk7zmofDCooWR48t8kljh/cHa","W7DsyJKg","vJ1pW4xdLgLieW","W6hcPmkVWPBdOSkVq8oqWQZdVMVcImkt","W5LMkIhdLZtdPwNdRCkmvmkfWR/cONpdPZ08W4eUAWLFbmolgG","W53cTwu5iuHR","ASoAW6ldLSklW7/cIIxdMLrVWQfv","zCk3WRJcN8k/sCo1","BCkSWQJcRKdcKCoaW5n7","y8o6W4ddGCoNh8kWWRZdO3yCgSoL","j8o+lsalueTZWQlcL8kO","b8kHls/cQKNcTHpdVSkBWOqbAW","gx3dJW/cU1P3W6NdMCkjW6W","lCovWPBcGKWTW67dKJhdH8kCzeO","gmo7W7pdUGRdLmo6W7raWOtcRmon","kmosW4ZdTsLDWPldTa","WOWKi27dN8kosvdcHumiWRi","ng/cUSk9w8keyCottK3cNIKv","WPhcPvO4FCkUsw0","kx9maSouoLydW54jWRhdIa"];return(_0x6b79=function(){return s})()}document.title="小程序 require.async 动态加载机制详解",document.getElementById("article").innerHTML='<div><p><code>require.async</code> 是小程序提供的动态加载能力，可以实现代码的按需加载和分包资源的异步加载（主包、独立分包、普通分包之间可以通过 require.async 互相加载资源）。以下是完整的实现方案和技术细节：</p>\n<h2>一、基础使用方法</h2>\n<h3>1. 加载普通JS模块</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 动态加载工具库</span>\n<span class="hljs-built_in">require</span>\n  .<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../libs/utils&quot;</span>)\n  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">utils</span>) =&gt;</span> {\n    utils.<span class="hljs-title function_">debounce</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">handleInput</span>, <span class="hljs-number">300</span>);\n  })\n  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {\n    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;模块加载失败&quot;</span>, err);\n  });\n</code></pre>\n<h3>2. 加载自定义组件</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 页面中动态加载组件</span>\n<span class="hljs-title class_">Page</span>({\n  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../components/expensive-component&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">compModule</span>) =&gt;</span> {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selectComponent</span>(<span class="hljs-string">&quot;#placeholder&quot;</span>).<span class="hljs-title function_">replaceWith</span>(compModule.<span class="hljs-property">default</span>);\n    });\n  },\n});\n</code></pre>\n<h2>二、高级配置方案</h2>\n<h3>1. 结合分包加载</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 加载分包中的组件</span>\n<span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;packageA/components/rich-editor&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">editor</span>) =&gt;</span> {\n  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">editorComponent</span>: editor.<span class="hljs-property">default</span> });\n});\n</code></pre>\n<h3>2. 预加载策略</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// app.js中预加载关键资源</span>\n<span class="hljs-title class_">App</span>({\n  <span class="hljs-attr">preloadMap</span>: {\n    <span class="hljs-string">&quot;pages/user&quot;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../components/user-card&quot;</span>),\n    <span class="hljs-string">&quot;pages/shop&quot;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../components/shop-list&quot;</span>),\n  },\n\n  <span class="hljs-title function_">onLaunch</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 监听路由变化预加载</span>\n    wx.<span class="hljs-title function_">onAppRoute</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {\n      <span class="hljs-variable language_">this</span>.<span class="hljs-property">preloadMap</span>[res.<span class="hljs-property">path</span>]?.();\n    });\n  },\n});\n</code></pre>\n<h2>三、性能优化方案</h2>\n<h3>1. 请求合并</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 批量加载多个资源</span>\n<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([\n  <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../libs/validator&quot;</span>),\n  <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../libs/formatter&quot;</span>),\n]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[validator, formatter]</span>) =&gt;</span> {\n  <span class="hljs-variable language_">this</span>.<span class="hljs-property">validator</span> = validator;\n  <span class="hljs-variable language_">this</span>.<span class="hljs-property">formatter</span> = formatter;\n});\n</code></pre>\n<h3>2. 缓存控制</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 带缓存的加载方法</span>\n<span class="hljs-keyword">const</span> cachedRequire = (<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {\n  <span class="hljs-keyword">const</span> cache = {};\n  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> {\n    <span class="hljs-keyword">if</span> (!cache[path]) {\n      cache[path] = <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(path);\n    }\n    <span class="hljs-keyword">return</span> cache[path];\n  };\n})();\n</code></pre>\n<h2>四、异常处理机制</h2>\n<h3>1. 重试策略</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">requireWithRetry</span>(<span class="hljs-params">path, retries = <span class="hljs-number">3</span></span>) {\n  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {\n    <span class="hljs-keyword">const</span> <span class="hljs-title function_">attempt</span> = (<span class="hljs-params"></span>) =&gt; {\n      <span class="hljs-built_in">require</span>\n        .<span class="hljs-title function_">async</span>(path)\n        .<span class="hljs-title function_">then</span>(resolve)\n        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {\n          <span class="hljs-keyword">if</span> (retries-- &gt; <span class="hljs-number">0</span>) <span class="hljs-title function_">attempt</span>();\n          <span class="hljs-keyword">else</span> <span class="hljs-title function_">reject</span>(err);\n        });\n    };\n    <span class="hljs-title function_">attempt</span>();\n  });\n}\n</code></pre>\n<h3>2. 降级方案</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 加载失败时使用简化版</span>\n<span class="hljs-built_in">require</span>\n  .<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../components/full-feature&quot;</span>)\n  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../components/simple-mode&quot;</span>))\n  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) =&gt;</span> {\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">component</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span> });\n  });\n</code></pre>\n<h2>五、调试与分析</h2>\n<h3>1. 加载耗时统计</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();\n<span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../libs/heavy&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {\n  <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;\n  wx.<span class="hljs-title function_">reportAnalytics</span>(<span class="hljs-string">&quot;load_time&quot;</span>, {\n    <span class="hljs-attr">module</span>: <span class="hljs-string">&quot;heavy&quot;</span>,\n    duration,\n  });\n});\n</code></pre>\n<h3>2. 查看已加载模块</h3>\n<pre><code class="language-javascript"><span class="hljs-comment">// 获取所有已缓存的模块</span>\n<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">require</span>.<span class="hljs-property">cache</span>);\n</code></pre>\n<h2>六、注意事项</h2>\n<ol>\n<li><strong>路径规则</strong>   ：\n<ul>\n<li>必须使用相对路径(../../)或分包路径</li>\n<li>不支持绝对路径和npm模块</li>\n</ul>\n</li>\n<li><strong>作用域限制</strong>   ：\n<ul>\n<li>加载的模块只能访问其自身的闭包和全局变量</li>\n<li>无法直接访问调用方的局部变量</li>\n</ul>\n</li>\n<li><strong>版本兼容</strong>   ：\n<ul>\n<li>基础库要求2.4.0+</li>\n<li>分包加载需要2.11.1+</li>\n</ul>\n</li>\n<li><strong>性能影响</strong>   ：\n<ul>\n<li>每个async请求都会产生独立HTTP请求</li>\n<li>高频使用需考虑合并请求</li>\n</ul>\n</li>\n</ol>\n<h2>七、实际应用案例</h2>\n<h3>1. 复杂页面按需加载</h3>\n<pre><code class="language-javascript"><span class="hljs-title class_">Page</span>({\n  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 首屏关键组件同步加载</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mainComponent</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../../components/main&quot;</span>);\n\n    <span class="hljs-comment">// 非首屏组件异步加载</span>\n    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">preloadSecondary</span>();\n  },\n\n  <span class="hljs-title function_">preloadSecondary</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-built_in">require</span>\n      .<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../components/secondary&quot;</span>)\n      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">comp</span>) =&gt;</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">secondary</span> = comp));\n  },\n\n  <span class="hljs-title function_">onReachBottom</span>(<span class="hljs-params"></span>) {\n    <span class="hljs-comment">// 滚动到底部时加载更多功能</span>\n    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">loadMoreModule</span>) {\n      <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../libs/load-more&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) =&gt;</span> {\n        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadMoreModule</span> = <span class="hljs-variable language_">module</span>;\n        <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>);\n      });\n    }\n  },\n});\n</code></pre>\n<h3>2. 条件加载多语言包</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> langMap = {\n  <span class="hljs-string">&quot;zh-CN&quot;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../i18n/zh&quot;</span>),\n  <span class="hljs-string">&quot;en-US&quot;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">require</span>.<span class="hljs-title function_">async</span>(<span class="hljs-string">&quot;../../i18n/en&quot;</span>),\n};\n\n<span class="hljs-title class_">Page</span>({\n  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"></span>) {\n    wx.<span class="hljs-title function_">getSystemInfo</span>({\n      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">{ language }</span>) =&gt;</span> {\n        langMap[language]?.().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">i18n</span>) =&gt;</span> {\n          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">texts</span>: i18n.<span class="hljs-property">default</span> });\n        });\n      },\n    });\n  },\n});\n</code></pre>\n<p>通过合理使用 <code>require.async</code> 可以实现小程序性能的显著提升，建议对非首屏必需的功能模块、复杂组件和低频使用的工具库采用动态加载策略。</p>\n</div>'</script></body></html>