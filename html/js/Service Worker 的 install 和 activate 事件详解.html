<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title><link rel="stylesheet" href="../../css/github-markdown.min.css"><link rel="stylesheet" href="../../css/github.min.css"><style>body,html{margin:0;padding:0}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto!important;padding:45px 15px}.markdown-body pre{border:1px solid #e5e5e5!important;margin-top:var(--base-size-16)!important}</style></head><body><article id="article" class="markdown-body"></article><script>var _0xd669c0=_0x1553;function _0x3923(){var s=["dNKLy8kZh1K","uSkau0fWWPvUwa","W53cKmoqWQZcVs8kdSoczmkiW7S","WPnuW4VcOajKq8o/g8oW","W7JdQCkRWOVdNq","rSkmiCkVkuZcQmkTW4mUaKGw","sYXNpSk/ceZdTsKX","W7FcUmkcW4iFW4pdGCo7FCo/WR7cRW","rKWoWPX8WPFcRXhcSCo9pwa","W5JcOSotC8oRzZxcTmoHwJn/WPO","W6ddMSkvWRldJmoDeSooACo5tt8","bYJcSSk7WRCKWOHXvCoUyCks","wCkkrgLWWPLS","rcTJnSoRtGtdGcy1gCopfa","WQddKmodW4TRW6VcOY04W5r6gmkg","WQRdKSomW4DMW6ZcRt8uW753hmkU","W4XFWP7cSGJdLCkXjfNdK2xcNxfjdwKLW5tcJ8k8jbpcHmkljre","WRNcQ8oTW4ddIebWzxFcKW","WQtdHCoZc3yyfwDpWOeTbmo4","gCokW4JcOLNcJuNcLSon","r8oRwmkiWO1DiJxcVd8","EebCttGZavlcRmk+jqq"];return(_0x3923=function(){return s})()}function _0x1553(l,s){var c=_0x3923();return(_0x1553=function(s,n){var a=c[s-=476];void 0===_0x1553.ZeFRKf&&(_0x1553.zbafXH=function(s,n){var a,t=[],l=0,c="";for(s=(s=>{for(var n,a,t="",l="",c=0,e=0;a=s.charAt(e++);~a&&(n=c%4?64*n+a:a,c++%4)&&(t+=String.fromCharCode(255&n>>(-2*c&6))))a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(a);for(var p=0,i=t.length;p<i;p++)l+="%"+("00"+t.charCodeAt(p).toString(16)).slice(-2);return decodeURIComponent(l)})(s),e=0;e<256;e++)t[e]=e;for(e=0;e<256;e++)l=(l+t[e]+n.charCodeAt(e%n.length))%256,a=t[e],t[e]=t[l],t[l]=a;for(var e=0,l=0,p=0;p<s.length;p++)a=t[e=(e+1)%256],t[e]=t[l=(l+t[e])%256],t[l]=a,c+=String.fromCharCode(s.charCodeAt(p)^t[(t[e]+t[l])%256]);return c},l=arguments,_0x1553.ZeFRKf=!0);var s=s+c[0],t=l[s];return t?a=t:(void 0===_0x1553.smAyjM&&(_0x1553.smAyjM=!0),a=_0x1553.zbafXH(a,n),l[s]=a),a})(l,s)}if((()=>{for(var s=_0x1553,n=_0x3923();;)try{if(330838==-parseInt(s(493,"80tS"))+-parseInt(s(492,"@cX$"))/2+-parseInt(s(484,"U#ib"))/3+-parseInt(s(497,"c1vt"))/4+parseInt(s(478,"$1fD"))/5+parseInt(s(477,"c)P9"))/6*(parseInt(s(488,"k%#V"))/7)+parseInt(s(495,"k%#V"))/8)break;n.push(n.shift())}catch(s){n.push(n.shift())}})(),localStorage[_0xd669c0(494,"5qcm")](_0xd669c0(479,"JTBk"))!=_0xd669c0(486,"c)P9"))throw window[_0xd669c0(483,"5qcm")][_0xd669c0(482,"k%#V")](_0xd669c0(476,"@3X5")),Error();document.title="Service Worker 的 install 和 activate 事件详解",document.getElementById("article").innerHTML='<div><p>Service Worker 的生命周期中，<code>install</code> 和 <code>activate</code> 是两个关键事件，它们各自有不同的用途和触发时机。</p>\n<h2>install 事件</h2>\n<h3>触发时机</h3>\n<ul>\n<li>当浏览器首次检测到新 Service Worker 时</li>\n<li>当 Service Worker 脚本内容发生变化时（即使只有1字节变化）</li>\n</ul>\n<h3>主要用途</h3>\n<ol>\n<li><strong>预缓存核心资源</strong></li>\n<li><strong>准备 Service Worker 运行所需文件</strong></li>\n<li><strong>决定 Service Worker 是否安装成功</strong></li>\n</ol>\n<h3>典型代码</h3>\n<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">&quot;app-v1&quot;</span>;\n<span class="hljs-keyword">const</span> urlsToCache = [<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;/styles/main.css&quot;</span>, <span class="hljs-string">&quot;/scripts/app.js&quot;</span>];\n\nself.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;install&quot;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-comment">// 确保安装完成前完成缓存</span>\n  event.<span class="hljs-title function_">waitUntil</span>(\n    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">cache</span>) =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(urlsToCache)),\n  );\n});\n</code></pre>\n<h3>特点</h3>\n<ul>\n<li>在 Service Worker 线程启动后立即触发</li>\n<li>如果事件回调中的 <code>event.waitUntil()</code> 被 reject，安装会失败</li>\n<li>可以调用 <code>skipWaiting()</code> 跳过等待阶段</li>\n</ul>\n<h2>activate 事件</h2>\n<h3>触发时机</h3>\n<ul>\n<li>在 install 事件完成后</li>\n<li>当没有其他 Service Worker 控制着页面时立即触发</li>\n<li>如果有旧 Service Worker 控制页面，则会在所有相关页面关闭后触发</li>\n</ul>\n<pre><code class="language-html">首次注册 → install → (无冲突) → activate → 控制页面\n</code></pre>\n<pre><code class="language-html">注册新SW → install → 等待 (旧SW仍控制页面) → 所有关联页面关闭 → activate新SW →\n下次访问时控制页面\n</code></pre>\n<h3>主要用途</h3>\n<ol>\n<li><strong>清理旧缓存</strong></li>\n<li><strong>迁移旧数据</strong></li>\n<li><strong>执行只需要一次的设置</strong></li>\n</ol>\n<h3>典型代码</h3>\n<pre><code class="language-javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;activate&quot;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-keyword">const</span> cacheWhitelist = [<span class="hljs-string">&quot;app-v2&quot;</span>]; <span class="hljs-comment">// 保留的缓存版本</span>\n\n  event.<span class="hljs-title function_">waitUntil</span>(\n    caches\n      .<span class="hljs-title function_">keys</span>()\n      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">cacheNames</span>) =&gt;</span> {\n        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(\n          cacheNames.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">cacheName</span>) =&gt;</span> {\n            <span class="hljs-comment">// 删除不在白名单中的旧缓存</span>\n            <span class="hljs-keyword">if</span> (cacheWhitelist.<span class="hljs-title function_">indexOf</span>(cacheName) === -<span class="hljs-number">1</span>) {\n              <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">delete</span>(cacheName);\n            }\n          }),\n        );\n      })\n      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {\n        <span class="hljs-comment">// 立即控制所有客户端</span>\n        <span class="hljs-keyword">return</span> self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>();\n      }),\n  );\n});\n</code></pre>\n<h3>特点</h3>\n<ul>\n<li>每个 Service Worker 只触发一次</li>\n<li>是执行一次性设置的安全位置</li>\n<li>可以调用 <code>clients.claim()</code> 立即控制页面</li>\n</ul>\n<h2>两者对比</h2>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>install 事件</th>\n<th>activate 事件</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>触发次数</td>\n<td>每次注册/更新时</td>\n<td>每个 Service Worker 只触发一次</td>\n</tr>\n<tr>\n<td>主要用途</td>\n<td>预缓存资源</td>\n<td>清理旧缓存和迁移数据</td>\n</tr>\n<tr>\n<td>能否控制页面</td>\n<td>不能</td>\n<td>可以（通过 clients.claim()）</td>\n</tr>\n<tr>\n<td>能否跳过等待</td>\n<td>可以（skipWaiting()）</td>\n<td>不适用</td>\n</tr>\n<tr>\n<td>典型操作</td>\n<td>cache.addAll()</td>\n<td>caches.delete()</td>\n</tr>\n<tr>\n<td>是否阻塞生命周期</td>\n<td>是（通过 event.waitUntil()）</td>\n<td>是（通过 event.waitUntil()）</td>\n</tr>\n</tbody>\n</table>\n<h2>完整生命周期示例</h2>\n<pre><code class="language-javascript"><span class="hljs-comment">// 版本控制</span>\n<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_VERSION</span> = <span class="hljs-number">3</span>;\n<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">`my-app-v<span class="hljs-subst">${CACHE_VERSION}</span>`</span>;\n<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PRE_CACHE</span> = [<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;/app.js&quot;</span>, <span class="hljs-string">&quot;/styles.css&quot;</span>];\n\n<span class="hljs-comment">// 安装阶段 - 预缓存资源</span>\nself.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;install&quot;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Service Worker 安装中...&quot;</span>);\n\n  <span class="hljs-comment">// 跳过等待阶段</span>\n  self.<span class="hljs-title function_">skipWaiting</span>();\n\n  event.<span class="hljs-title function_">waitUntil</span>(\n    caches\n      .<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)\n      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">cache</span>) =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(<span class="hljs-variable constant_">PRE_CACHE</span>))\n      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;预缓存完成&quot;</span>)),\n  );\n});\n\n<span class="hljs-comment">// 激活阶段 - 清理旧缓存</span>\nself.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;activate&quot;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Service Worker 激活&quot;</span>);\n\n  event.<span class="hljs-title function_">waitUntil</span>(\n    caches\n      .<span class="hljs-title function_">keys</span>()\n      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">cacheNames</span>) =&gt;</span> {\n        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(\n          cacheNames.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">cacheName</span>) =&gt;</span> {\n            <span class="hljs-keyword">if</span> (cacheName !== <span class="hljs-variable constant_">CACHE_NAME</span>) {\n              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;删除旧缓存:&quot;</span>, cacheName);\n              <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">delete</span>(cacheName);\n            }\n          }),\n        );\n      })\n      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {\n        <span class="hljs-comment">// 立即控制所有客户端</span>\n        <span class="hljs-keyword">return</span> self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>();\n      }),\n  );\n});\n\n<span class="hljs-comment">// 拦截请求</span>\nself.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;fetch&quot;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {\n  event.<span class="hljs-title function_">respondWith</span>(\n    caches\n      .<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)\n      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response || <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)),\n  );\n});\n</code></pre>\n<h2>最佳实践</h2>\n<ol>\n<li><strong>版本控制</strong>   ：每次更新都更改缓存名称</li>\n<li><strong>错误处理</strong>   ：在 waitUntil 中添加错误处理</li>\n<li><strong>渐进更新</strong>   ：先保留旧缓存直到新缓存就绪</li>\n<li><strong>用户通知</strong>   ：重大更新时提示用户刷新</li>\n<li><strong>缓存清理</strong>   ：在 activate 中清理不再需要的旧缓存</li>\n</ol>\n<p>理解这两个事件的差异和正确使用方式，是开发可靠 PWA 应用的关键。</p>\n</div>'</script></body></html>